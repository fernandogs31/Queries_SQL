SELECT    
-- q1.NUM
       q1.cost_group
     , q1.period_name
     , q1.organization_code
     , q1.organization_type
     , q1.organization_id
     , q1.subinventory_code
     , q1.subinv_description
     , q1.locators
     , q1.asset_type
     , q1.part_number
     , q1.flag_asset_inventory
     , q1.flag_de_custo
     , q1.descrip_eng
     , q1.descrip_ptb
     , q1.item_creation_date
     , q1.days_from_creation
     , q1.product_line
     , q1.desc_prod_line
     , q1.uom
     , q1.transaction_quantity     
     , q1.custo_unit_inv
     , q1.custo_unit_pac
     , ( q1.transaction_quantity * q1.custo_unit_inv )     total_custo_inv
     , ( q1.transaction_quantity * q1.custo_unit_pac )     total_custo_pac
     , (( q1.transaction_quantity * q1.custo_unit_pac ) - ( q1.transaction_quantity * q1.custo_unit_inv ))  dif_inv_x_pac 
     , q1.lot_number
     , q1.lot_creation_date
     , DECODE(q1.lot_number,NULL,NULL,(TRUNC(SYSDATE) - TRUNC(q1.lot_creation_date)))        lot_qty_days_creation
     , q1.lot_expiration_date
     , q1.serial_number
     , q1.serial_creation_date
     , DECODE(q1.serial_number,NULL,NULL,(TRUNC(SYSDATE)- TRUNC(q1.serial_creation_date)))   serial_qty_days_creation  
     , q1.last_transaction_type
     , q1.last_transaction_source
     , q1.last_source_type
     , q1.source_code
     , q1.transaction_date
     , q1.initial_consignment_date 
     , q1.transaction_qty_of_days
     , q1.transaction_reference
     , q1.po_number
     , q1.po_supplier
     , q1.nf_ri
     , q1.order_number
     , q1.customer_name 
     , q1.customer_number
     , q1.customer_cnpj_cpf
     , q1.bill_to_cnpj_cpf
     , q1.bill_to_customer_name
     , q1.ship_to_cnpj_cpf
     , q1.customer_address
     , q1.invoice_number_ar
     , q1.reservation_quantity
     , q1.reservation_order_number
     , q1.reservation_customer_name
     , q1.material_account
     , q1.outside_processing_account
     , q1.material_overhead_account
     , q1.overhead_account
     , q1.resource_account
     , q1.report_date_and_time
     , q1.transaction_id
     , q1.user_name
     , q1.lot_control
     , q1.serial_control
     , q1.lpn_value
     , q1.query
  FROM ( -- Com Controle de Serial e Lote
          SELECT DISTINCT  --'1' NUM
        /* ( SELECT ccg.cost_group 
                             FROM apps.cst_cost_groups            ccg
                                , apps.cst_cost_group_assignments ccga
                            WHERE ccga.cost_group_id     = ccg.cost_group_id
                              AND ccga.organization_id   = mp.organization_id )  cost_group*/
            ( SELECT ccg.cost_group 
                             FROM apps.cst_cost_groups            ccg
                            WHERE MPACD.cost_group_id     = ccg.cost_group_id )  cost_group  
                            
              , ( SELECT ( SELECT cpp1.period_name 
                             FROM apps.cst_pac_item_costs   cst
                                , apps.cst_pac_periods      cpp1
                            WHERE cst.pac_period_id     = (SELECT MAX(PAC_PERIOD_ID)                   FROM APPS.CST_PAC_PERIODS                  WHERE LEGAL_ENTITY = (SELECT LEGAL_ENTITY                                          FROM APPS.ORG_ORGANIZATION_DEFINITIONS OOD                                         WHERE OOD.ORGANIZATION_ID = mp.organization_id                                         ) )
                              AND cst.pac_period_id     = cpp1.pac_period_id
                              AND cst.inventory_item_id = msi.inventory_item_id
                              AND cst.cost_group_id     = ccg.cost_group_id )  
                    FROM apps.cst_cost_groups            ccg
                       , apps.cst_cost_group_assignments ccga
                   WHERE ccga.cost_group_id     = ccg.cost_group_id
                     AND ccga.organization_id   = mp.organization_id ) period_name
              , mp.organization_code
              , mp.attribute7                organization_type
              , mp.organization_id 
              , moq.subinventory_code
              , msifv.description            subinv_description
              , milk.concatenated_segments   locators
              , DECODE( msifv.asset_inventory, 1 , 'Asset', 2, 'Non Asset')   asset_type
              , msi.segment1                 part_number
              , DECODE(msi.inventory_asset_flag, NULL, 'No', 'N', 'No', 'Y', 'Yes')                         flag_asset_inventory
              , DECODE(msi.costing_enabled_flag, NULL, 'No', 'N', 'No', 'Y', 'Yes')                         flag_de_custo
              , msi.description              descrip_eng
              , msi.attribute3               descrip_ptb
              , msi.creation_date            item_creation_date
              , (trunc(SYSDATE) - trunc(msi.creation_date))      days_from_creation
              , gcc.segment8                                     product_line
              , ffvv.description                                 desc_prod_line
              , msi.primary_uom_code   uom
              , DECODE (msi.serial_number_control_code, 1, moq.onhand_qty, 1 ) transaction_quantity
              , NVL(( SELECT cic.item_cost
                        FROM apps.cst_item_costs cic
                       WHERE cic.organization_id   = msi.organization_id
                         AND cic.inventory_item_id = msi.inventory_item_id
                         AND cic.cost_type_id      = 1 ),0)  custo_unit_inv
              /*, nvl(( SELECT ( SELECT ROUND (cst.item_cost,2) 
                                 FROM apps.cst_pac_item_costs   cst
                                WHERE cst.pac_period_id     = (SELECT MAX(PAC_PERIOD_ID)                   FROM APPS.CST_PAC_PERIODS                  WHERE LEGAL_ENTITY = (SELECT LEGAL_ENTITY                                          FROM APPS.ORG_ORGANIZATION_DEFINITIONS OOD                                         WHERE OOD.ORGANIZATION_ID = mp.organization_id                                         ) )
                                  AND cst.inventory_item_id = msi.inventory_item_id
                                  AND cst.cost_group_id     = ccg.cost_group_id )  item_cost
                        FROM apps.cst_cost_groups            ccg
                           , apps.cst_cost_group_assignments ccga
                       WHERE ccga.cost_group_id     = ccg.cost_group_id
                         AND ccga.organization_id   = mp.organization_id ) ,0) custo_unit_pac
                         */
                , nvl((SELECT ROUND (cst.item_cost,2) 
                       FROM apps.cst_pac_item_costs   cst
                      WHERE cst.pac_period_id     = (SELECT MAX(PAC_PERIOD_ID)                   
                                                                FROM APPS.CST_PAC_PERIODS                  
                                                                WHERE LEGAL_ENTITY = (SELECT LEGAL_ENTITY                                         
                                                                                        FROM APPS.ORG_ORGANIZATION_DEFINITIONS OOD                                        
                                                                                        WHERE OOD.ORGANIZATION_ID = mp.organization_id
                                                        ) )
                        AND cst.inventory_item_id = msi.inventory_item_id
                        AND cst.cost_group_id     = MPACD.cost_group_id) ,0)  custo_unit_pac
              , moq.lot_number
              , ( SELECT mln.creation_date         
                    FROM apps.mtl_lot_numbers              mln
                   WHERE mln.lot_number           = moq.lot_number 
                     AND mln.inventory_item_id    = msi.inventory_item_id
                     AND mln.organization_id      = mp.organization_id  )  lot_creation_date
              , NULL   lot_qty_days_creation
              , ( SELECT mln.expiration_date         
                    FROM apps.mtl_lot_numbers              mln
                   WHERE mln.lot_number           = moq.lot_number
                     AND mln.inventory_item_id    = msi.inventory_item_id
                     AND mln.organization_id      = mp.organization_id  )  lot_expiration_date
             , msn.serial_number 
              , msn.creation_date     serial_creation_date
              , mtt.transaction_type_name           last_transaction_type
              , mmt.transaction_source_name         last_transaction_source
              , mtst.transaction_source_type_name   last_source_type
              , mmt.source_code
              , TO_CHAR(mmt.transaction_date, 'DD-MON-RRRR')       transaction_date
        , (SELECT TO_CHAR(mmt1.transaction_date, 'DD-MON-RRRR') 
                        FROM apps.mtl_material_transactions mmt1
                        WHERE mmt1.transaction_type_id=420
                        AND mmt1.source_line_id=mmt.source_line_id) initial_consignment_date
              , (TRUNC ( SYSDATE )- TRUNC(mmt.transaction_date))   transaction_qty_of_days
              , TO_CHAR(mmt.transaction_reference)                 transaction_reference
              , CASE WHEN mmt.source_code = '3PL_REMITTANCE_BRAZIL' THEN
                     (SELECT listagg(pha.segment1,', ' ON OVERFLOW TRUNCATE)  
                      WITHIN GROUP (ORDER BY pha.segment1 asc)
                        FROM apps.po_headers_all        pha
                           , apps.po_lines_all          pla
                       WHERE pla.po_line_id   = mmt.source_line_id
                         AND pla.po_header_id = pha.po_header_id)
                     WHEN mmt.source_code IN ('ORDER ENTRY','IIP') THEN
                        NULL
                     WHEN mmt.source_code = 'RCV' THEN
                        ( SELECT listagg(pha.segment1,', ' ON OVERFLOW TRUNCATE)  
                          WITHIN GROUP (ORDER BY pha.segment1 asc)
                            FROM apps.po_headers_all            pha
                               , apps.po_lines_all              pla
                               , apps.po_line_locations_all     plla
                               , apps.rcv_shipment_headers      rsh
                               , apps.rcv_transactions          rt
                           WHERE rt.transaction_id                = mmt.rcv_transaction_id
                             AND rt.po_line_location_id           = plla.line_location_id
                             AND plla.po_line_id                  = pla.po_line_id
                             AND pha.po_header_id                 = pla.po_header_id
                             AND rt.shipment_header_id            = rsh.shipment_header_id
                             AND rsh.receipt_source_code          = 'VENDOR'  )
                     ELSE
                        NULL
                END      po_number
              , CASE WHEN mmt.source_code = '3PL_REMITTANCE_BRAZIL' THEN
                     (SELECT listagg(aps.vendor_name,', ' ON OVERFLOW TRUNCATE)  
                      WITHIN GROUP (ORDER BY aps.vendor_name asc)
                        FROM apps.po_headers_all            pha
                           , apps.po_lines_all              pla
                           , apps.ap_suppliers              aps
                           , apps.ap_supplier_sites_all     apss
                       WHERE pla.po_line_id     = mmt.source_line_id
                         AND pla.po_header_id   = pha.po_header_id
                         AND pha.vendor_id      = aps.vendor_id
                         AND aps.vendor_id      = apss.vendor_id
                         AND pha.vendor_site_id = apss.vendor_site_id )
                     WHEN mmt.source_code IN ('ORDER ENTRY','IIP') THEN
                        NULL
                     WHEN mmt.source_code = 'RCV' THEN
                        ( SELECT listagg(aps.vendor_name,', ' ON OVERFLOW TRUNCATE)  
                          WITHIN GROUP (ORDER BY aps.vendor_name asc)
                            FROM apps.po_headers_all            pha
                               , apps.po_lines_all              pla
                               , apps.po_line_locations_all     plla
                               , apps.rcv_shipment_headers      rsh
                               , apps.rcv_transactions          rt
                               , apps.ap_suppliers              aps
                              , apps.ap_supplier_sites_all     apss
                           WHERE rt.transaction_id          = mmt.rcv_transaction_id
                             AND rt.po_line_location_id     = plla.line_location_id
                             AND plla.po_line_id            = pla.po_line_id
                             AND pha.po_header_id           = pla.po_header_id
                             AND rt.shipment_header_id      = rsh.shipment_header_id
                             AND rsh.receipt_source_code    = 'VENDOR'
                             AND pha.vendor_id              = aps.vendor_id
                             AND aps.vendor_id              = apss.vendor_id
                             AND pha.vendor_site_id         = apss.vendor_site_id  )
                     ELSE
                        NULL
                END    po_supplier
                --
              , CASE WHEN mmt.source_code = '3PL_REMITTANCE_BRAZIL' THEN
                     ( SELECT listagg(cfi.invoice_num,', ' ON OVERFLOW TRUNCATE)  
                         WITHIN GROUP (ORDER BY cfi.invoice_num asc)
                         FROM apps.cll_f189_invoice_lines cfil
                            , apps.cll_f189_invoices      cfi
                            , apps.po_lines_all           pla
                            , apps.po_line_locations_all  plla
                        WHERE plla.po_line_id       = pla.po_line_id
                          AND pla.po_line_id        = mmt.source_line_id
                          AND plla.line_location_id = cfil.line_location_id
                          AND cfil.invoice_id       = cfi.invoice_id )
                     WHEN mmt.source_code IN ('ORDER ENTRY','IIP') THEN
                        NULL
                     WHEN mmt.source_code = 'RCV' THEN
                        ( SELECT listagg(cfi.invoice_num,', ' ON OVERFLOW TRUNCATE)  
                            WITHIN GROUP (ORDER BY cfi.invoice_num asc)
                            FROM apps.po_headers_all            pha
                               , apps.po_lines_all              pla
                               , apps.po_line_locations_all     plla
                               , apps.cll_f189_invoice_lines    cfil
                               , apps.cll_f189_invoices         cfi
                               , apps.rcv_shipment_headers      rsh
                               , apps.rcv_transactions          rt
                           WHERE rt.transaction_id          = mmt.rcv_transaction_id
                             AND rt.po_line_location_id     = plla.line_location_id
                             AND plla.line_location_id      = cfil.line_location_id
                             AND cfil.invoice_id            = cfi.invoice_id
                             AND plla.po_line_id            = pla.po_line_id
                             AND pha.po_header_id           = pla.po_header_id
                             AND rt.shipment_header_id      = rsh.shipment_header_id
                             AND rsh.receipt_source_code    = 'VENDOR'   )
                     ELSE
                        NULL
                END    NF_RI
              , (SELECT DECODE( mmt.source_code, '3PL_REMITTANCE_BRAZIL',NULL,to_char(ooha.order_number) )
                   FROM apps.oe_order_headers_all  ooha
                      , apps.oe_order_lines_all    oola  
                  WHERE oola.line_id        = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                    AND oola.header_id      = ooha.header_id )   order_number
               -- 
               -- alterado para BIll_to por Sinval inicio
               --
               , CASE WHEN ( SELECT ottl.name
                             FROM apps.oe_transaction_types_tl    ottl
                                , apps.oe_order_headers_all  ooha
                                , apps.oe_order_lines_all    oola  
                            WHERE oola.line_id        = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND oola.header_id      = ooha.header_id
                              AND ooha.order_type_id  = ottl.transaction_type_id  ) = 'GPO_BR_FE_SHIPMENT' THEN
                     (SELECT listagg(hp.party_name,', ' ON OVERFLOW TRUNCATE)  
                      WITHIN GROUP (ORDER BY hp.party_name asc)
                        FROM apps.hz_parties             hp
                           , apps.hz_cust_accounts       hca
                           , apps.oe_order_lines_all     oola
                           , apps.hz_cust_acct_sites_all hcas
                           , apps.hz_cust_site_uses_all  hcsu
                       WHERE oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                         AND oola.end_customer_site_use_id  = hcsu.site_use_id
                         AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                         AND hcas.cust_account_id           = hca.cust_account_id
                         AND hca.party_id                   = hp.party_id )
                  ELSE
                     CASE WHEN (mmt.source_code = '3PL_REMITTANCE_BRAZIL') THEN
                       (SELECT listagg(hp.party_name,', ' ON OVERFLOW TRUNCATE)  
                        WITHIN GROUP (ORDER BY hp.party_name asc)
                          FROM apps.hz_parties             hp,
                               apps.hz_cust_accounts       hca,
                               apps.ra_customer_trx_all    rcta,
                               apps.hz_cust_acct_sites_all hcas,
                               apps.hz_cust_site_uses_all  hcsu
                         WHERE rcta.interface_header_attribute1 = mp.organization_code||'_'||mmt.transaction_reference
                           AND rcta.ship_to_site_use_id         = hcsu.site_use_id
                           AND hcsu.cust_acct_site_id           = hcas.cust_acct_site_id
                           AND hcas.cust_account_id             = hca.cust_account_id
                           AND hca.party_id                     = hp.party_id
                           AND rcta.org_id                      = 4330)
                     ELSE
                        (SELECT listagg(hp.party_name,', ' ON OVERFLOW TRUNCATE)  
                         WITHIN GROUP (ORDER BY hp.party_name asc)
                           FROM apps.hz_parties             hp
                              , apps.hz_cust_accounts       hca
                              , apps.oe_order_lines_all     oola
                              , apps.hz_cust_acct_sites_all hcas
                              , apps.hz_cust_site_uses_all  hcsu
                          WHERE oola.line_id                = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                            AND oola.ship_to_org_id         = hcsu.site_use_id
                            AND hcsu.cust_acct_site_id      = hcas.cust_acct_site_id
                            AND hcas.cust_account_id        = hca.cust_account_id
                            AND hca.party_id                = hp.party_id )
                    END                 
               END    customer_name
             , CASE WHEN ( SELECT ottl.name
                             FROM apps.oe_transaction_types_tl    ottl
                                , apps.oe_order_headers_all  ooha
                                , apps.oe_order_lines_all    oola  
                            WHERE oola.line_id        = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND oola.header_id      = ooha.header_id
                              AND ooha.order_type_id  = ottl.transaction_type_id  ) = 'GPO_BR_FE_SHIPMENT' THEN
                     (SELECT listagg(hca.account_number,', ' ON OVERFLOW TRUNCATE)  
                      WITHIN GROUP (ORDER BY hca.account_number asc)
                        FROM apps.hz_parties             hp
                           , apps.hz_cust_accounts       hca
                           , apps.oe_order_lines_all     oola
                           , apps.hz_cust_acct_sites_all hcas
                           , apps.hz_cust_site_uses_all  hcsu
                       WHERE oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                         AND oola.end_customer_site_use_id  = hcsu.site_use_id
                         AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                         AND hcas.cust_account_id           = hca.cust_account_id
                         AND hca.party_id                   = hp.party_id )
                  ELSE
                     CASE WHEN (mmt.source_code = '3PL_REMITTANCE_BRAZIL') THEN
                        (SELECT listagg(hca.account_number,', ' ON OVERFLOW TRUNCATE)  
                         WITHIN GROUP (ORDER BY hca.account_number asc)
                           FROM apps.hz_parties             hp,
                                apps.hz_cust_accounts       hca,
                                apps.ra_customer_trx_all    rcta,
                                apps.hz_cust_acct_sites_all hcas,
                                apps.hz_cust_site_uses_all  hcsu
                          WHERE rcta.interface_header_attribute1 = mp.organization_code||'_'||mmt.transaction_reference
                            AND rcta.ship_to_site_use_id         = hcsu.site_use_id
                            AND hcsu.cust_acct_site_id           = hcas.cust_acct_site_id
                            AND hcas.cust_account_id             = hca.cust_account_id
                            AND hca.party_id                     = hp.party_id
                            AND rcta.org_id                      = 4330)
                     ELSE
                        (SELECT listagg(hca.account_number,', ' ON OVERFLOW TRUNCATE)  
                         WITHIN GROUP (ORDER BY hca.account_number asc)
                           FROM apps.hz_parties             hp
                              , apps.hz_cust_accounts       hca
                              , apps.oe_order_lines_all     oola
                              , apps.hz_cust_acct_sites_all hcas
                              , apps.hz_cust_site_uses_all  hcsu
                          WHERE oola.line_id                = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                            AND oola.ship_to_org_id         = hcsu.site_use_id
                            AND hcsu.cust_acct_site_id      = hcas.cust_acct_site_id
                            AND hcas.cust_account_id        = hca.cust_account_id
                            AND hca.party_id                = hp.party_id   )
                     END
                  END   customer_number
                --
              , CASE WHEN ( SELECT ottl.name
                             FROM apps.oe_transaction_types_tl    ottl
                                , apps.oe_order_headers_all  ooha
                                , apps.oe_order_lines_all    oola  
                            WHERE oola.line_id        = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND oola.header_id      = ooha.header_id
                              AND ooha.order_type_id  = ottl.transaction_type_id  ) = 'GPO_BR_FE_SHIPMENT' THEN
                     (SELECT listagg(DECODE(hcas.global_attribute2
                                           , '2',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'/'|| hcas.global_attribute4 ||'-'|| hcas.global_attribute5
                                           , '1',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'-'|| hcas.global_attribute5 
                                           , '3',HCSU.LOCATION||' - '||hcas.global_attribute3 ),', ' ON OVERFLOW TRUNCATE)
                     WITHIN GROUP (ORDER BY hcas.global_attribute2 asc ) 
                        FROM apps.hz_parties             hp
                           , apps.hz_cust_accounts       hca
                           , apps.oe_order_lines_all     oola
                           , apps.hz_cust_acct_sites_all hcas
                           , apps.hz_cust_site_uses_all  hcsu
                       WHERE oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                         AND oola.end_customer_site_use_id  = hcsu.site_use_id
                         AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                         AND hcas.cust_account_id           = hca.cust_account_id
                         AND hca.party_id                   = hp.party_id )
                ELSE
                   CASE WHEN (mmt.source_code = '3PL_REMITTANCE_BRAZIL') THEN
                      (SELECT listagg(DECODE(hcas.global_attribute2
                                           , '2',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'/'|| hcas.global_attribute4 ||'-'|| hcas.global_attribute5
                                           , '1',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'-'|| hcas.global_attribute5 
                                           , '3',HCSU.LOCATION||' - '||hcas.global_attribute3 ),', ' ON OVERFLOW TRUNCATE)
                     WITHIN GROUP (ORDER BY hcas.global_attribute2 asc) 
                         FROM apps.ra_customer_trx_all     rcta
                            , apps.hz_cust_acct_sites_all  hcas
                            , apps.hz_cust_site_uses_all   hcsu
                        WHERE rcta.interface_header_attribute1 = mp.organization_code||'_'||mmt.transaction_reference
                          AND rcta.ship_to_site_use_id         = hcsu.site_use_id
                          AND hcsu.cust_acct_site_id           = hcas.cust_acct_site_id
                          AND rcta.org_id                      = 4330)
                   ELSE
                      (SELECT listagg(DECODE(hcas.global_attribute2
                                           , '2',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'/'|| hcas.global_attribute4 ||'-'|| hcas.global_attribute5
                                           , '1',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'-'|| hcas.global_attribute5 
                                           , '3',HCSU.LOCATION||' - '||hcas.global_attribute3 ),', ' ON OVERFLOW TRUNCATE)
                      WITHIN GROUP (ORDER BY hcas.global_attribute2 asc) 
                         FROM apps.hz_parties             hp
                            , apps.hz_cust_accounts       hca
                            , apps.oe_order_lines_all     oola
                            , apps.hz_cust_acct_sites_all hcas
                            , apps.hz_cust_site_uses_all  hcsu
                        WHERE oola.line_id                = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                          AND oola.ship_to_org_id         = hcsu.site_use_id
                          AND hcsu.cust_acct_site_id      = hcas.cust_acct_site_id
                          AND hcas.cust_account_id        = hca.cust_account_id
                          AND hca.party_id                = hp.party_id  )
                   END
                END  customer_cnpj_cpf
               -- 
              , CASE WHEN (mmt.source_code = '3PL_REMITTANCE_BRAZIL') THEN
                      (SELECT listagg(DECODE(hcas.global_attribute2
                                           , '2',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'/'|| hcas.global_attribute4 ||'-'|| hcas.global_attribute5
                                           , '1',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'-'|| hcas.global_attribute5 
                                           , '3',HCSU.LOCATION||' - '||hcas.global_attribute3 ),', ' ON OVERFLOW TRUNCATE)
                       WITHIN GROUP (ORDER BY hcas.global_attribute2 asc )
                         FROM apps.ra_customer_trx_all         rcta
                            , apps.hz_cust_acct_sites_all      hcas
                            , apps.hz_cust_site_uses_all       hcsu
                        WHERE rcta.interface_header_attribute1 = mp.organization_code||'_'||mmt.transaction_reference
                          AND rcta.bill_to_site_use_id         = hcsu.site_use_id
                          AND hcsu.cust_acct_site_id           = hcas.cust_acct_site_id
                          AND rcta.org_id                      = 4330
                          AND ROWNUM = 1)
                   ELSE
                     --
                     CASE WHEN (select DISTINCT RCTL.INTERFACE_LINE_CONTEXT
                             FROM apps.hz_parties                hp
                                , apps.hz_cust_accounts          hca
                                , apps.oe_order_lines_all        oola
                                , apps.oe_order_headers_all      ooha
                                , apps.ra_customer_trx_lines_all rctl
                                , apps.ra_customer_trx_all       rcta
                                , apps.hz_cust_acct_sites_all    hcas
                                , apps.hz_cust_site_uses_all     hcsu
                            WHERE ooha.header_id                 = oola.header_id
                              AND oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND rctl.inventory_item_id         = oola.inventory_item_id
                              AND rctl.line_type                 = 'LINE'
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE1 = to_char(ooha.order_number)
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE6 = to_char(oola.line_id)
                              AND RCTL.INTERFACE_LINE_CONTEXT    = 'ORDER ENTRY'
                              AND rctl.customer_trx_id           = rcta.customer_trx_id
                              AND rcta.bill_to_site_use_id       = hcsu.site_use_id
                              AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                              AND hcas.cust_account_id           = hca.cust_account_id
                              AND hca.party_id                   = hp.party_id 
                              AND ROWNUM = 1) = 'ORDER ENTRY' THEN
                     --
                     (SELECT DISTINCT DECODE(hcas.global_attribute2
                                           , '2',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'/'|| hcas.global_attribute4 ||'-'|| hcas.global_attribute5
                                           , '1',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'-'|| hcas.global_attribute5 
                                           , '3',HCSU.LOCATION||' - '||hcas.global_attribute3)
                             FROM apps.hz_parties                hp
                                , apps.hz_cust_accounts          hca
                                , apps.oe_order_lines_all        oola
                                , apps.oe_order_headers_all      ooha
                                , apps.ra_customer_trx_lines_all rctl
                                , apps.ra_customer_trx_all       rcta
                                , apps.hz_cust_acct_sites_all    hcas
                                , apps.hz_cust_site_uses_all     hcsu
                            WHERE ooha.header_id                 = oola.header_id
                              AND oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND rctl.inventory_item_id         = oola.inventory_item_id
                              AND rctl.line_type                 = 'LINE'
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE1 = to_char(ooha.order_number)
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE6 = to_char(oola.line_id)
                              AND RCTL.INTERFACE_LINE_CONTEXT    = 'ORDER ENTRY'
                              AND rctl.customer_trx_id           = rcta.customer_trx_id
                              AND rcta.bill_to_site_use_id       = hcsu.site_use_id
                              AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                              AND hcas.cust_account_id           = hca.cust_account_id
                              AND hca.party_id                   = hp.party_id
                              AND ROWNUM = 1)
                     --
                     ELSE
                     --            
                     CASE WHEN 
                          ( SELECT DISTINCT RCTL.INTERFACE_LINE_CONTEXT
                             FROM apps.hz_parties                hp
                                , apps.hz_cust_accounts          hca
                                , apps.oe_order_lines_all        oola
                                , apps.oe_order_headers_all      ooha
                               , apps.ra_customer_trx_lines_all rctl
                                , apps.ra_customer_trx_all       rcta
                                , apps.hz_cust_acct_sites_all    hcas
                                , apps.hz_cust_site_uses_all     hcsu
                            WHERE ooha.header_id                 = oola.header_id
                              AND oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND rctl.inventory_item_id         = oola.inventory_item_id
                              AND rctl.line_type                 = 'LINE'
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE1 = ooha.ORIG_SYS_DOCUMENT_REF
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE7 = oola.ORIG_SYS_LINE_REF
                              AND RCTL.INTERFACE_LINE_CONTEXT    = 'GEMS_PB_RR'
                              AND rctl.customer_trx_id           = rcta.customer_trx_id
                              AND rcta.bill_to_site_use_id       = hcsu.site_use_id
                              AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                              AND hcas.cust_account_id           = hca.cust_account_id
                              AND ROWNUM = 1 ) = 'GEMS_PB_RR' THEN
                     --
                     (SELECT DISTINCT DECODE(hcas.global_attribute2
                                           , '2',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'/'|| hcas.global_attribute4 ||'-'|| hcas.global_attribute5
                                           , '1',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'-'|| hcas.global_attribute5 
                                           , '3',HCSU.LOCATION||' - '||hcas.global_attribute3)
                             FROM apps.hz_parties                hp
                                , apps.hz_cust_accounts          hca
                                , apps.oe_order_lines_all        oola
                                , apps.oe_order_headers_all      ooha
                                , apps.ra_customer_trx_lines_all rctl
                                , apps.ra_customer_trx_all       rcta
                                , apps.hz_cust_acct_sites_all    hcas
                                , apps.hz_cust_site_uses_all     hcsu
                            WHERE ooha.header_id                 = oola.header_id
                              AND oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND rctl.inventory_item_id         = oola.inventory_item_id
                              AND rctl.line_type                 = 'LINE'
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE1 = ooha.ORIG_SYS_DOCUMENT_REF
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE7 = oola.ORIG_SYS_LINE_REF
                              AND RCTL.INTERFACE_LINE_CONTEXT    = 'GEMS_PB_RR'
                              AND rctl.customer_trx_id           = rcta.customer_trx_id
                              AND rcta.bill_to_site_use_id       = hcsu.site_use_id
                              AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                              AND hcas.cust_account_id           = hca.cust_account_id 
                              AND ROWNUM = 1 )
                     --
                     ELSE
                     --
                     (SELECT DISTINCT DECODE(hcas.global_attribute2
                                   , '2',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'/'|| hcas.global_attribute4 ||'-'|| hcas.global_attribute5
                                   , '1',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'-'|| hcas.global_attribute5 
                                   , '3',HCSU.LOCATION||' - '||hcas.global_attribute3)
                             --
                      FROM   APPS.HZ_CUST_ACCT_SITES_ALL HCAS,
                             APPS.HZ_CUST_SITE_USES_ALL  HCSU,
                             APPS.OE_ORDER_LINES_ALL     OOLA,
                             APPS.OE_ORDER_HEADERS_ALL   OOHA
                             --
                      WHERE  HCSU.SITE_USE_CODE     = 'BILL_TO'
                      AND    HCSU.CUST_ACCT_SITE_ID = HCAS.CUST_ACCT_SITE_ID
                      AND    HCSU.SITE_USE_ID       = NVL(OOLA.ATTRIBUTE1, OOHA.INVOICE_TO_ORG_ID)
                      AND    OOLA.LINE_ID           = NVL(MMT.TRX_SOURCE_LINE_ID, MMT.SOURCE_LINE_ID)
                      AND    OOHA.HEADER_ID         = OOLA.HEADER_ID
                      AND    ROWNUM = 1)
                     --
                     END
                  END
               END      bill_to_CNPJ_CPF
               --
              , CASE WHEN (mmt.source_code = '3PL_REMITTANCE_BRAZIL') THEN
                        (SELECT listagg(hp.party_name,', ' ON OVERFLOW TRUNCATE)  
                        WITHIN GROUP (ORDER BY hp.party_name asc)
                          FROM apps.hz_parties             hp,
                               apps.hz_cust_accounts       hca,
                               apps.ra_customer_trx_all    rcta,
                               apps.hz_cust_acct_sites_all hcas,
                               apps.hz_cust_site_uses_all  hcsu
                         WHERE rcta.interface_header_attribute1 = mp.organization_code||'_'||mmt.transaction_reference
                           AND rcta.bill_to_site_use_id         = hcsu.site_use_id
                           AND hcsu.cust_acct_site_id           = hcas.cust_acct_site_id
                           AND hcas.cust_account_id             = hca.cust_account_id
                           AND hca.party_id                     = hp.party_id
                           AND rcta.org_id                      = 4330)
                   ELSE
                     --
                     CASE WHEN (select DISTINCT RCTL.INTERFACE_LINE_CONTEXT
                             FROM apps.hz_parties                hp
                                , apps.hz_cust_accounts          hca
                                , apps.oe_order_lines_all        oola
                                , apps.oe_order_headers_all      ooha
                                , apps.ra_customer_trx_lines_all rctl
                                , apps.ra_customer_trx_all       rcta
                                , apps.hz_cust_acct_sites_all    hcas
                                , apps.hz_cust_site_uses_all     hcsu
                            WHERE ooha.header_id                 = oola.header_id
                              AND oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND rctl.inventory_item_id         = oola.inventory_item_id
                              AND rctl.line_type                 = 'LINE'
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE1 = to_char(ooha.order_number)
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE6 = to_char(oola.line_id)
                              AND RCTL.INTERFACE_LINE_CONTEXT    = 'ORDER ENTRY'
                              AND rctl.customer_trx_id           = rcta.customer_trx_id
                              AND rcta.bill_to_site_use_id       = hcsu.site_use_id
                              AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                              AND hcas.cust_account_id           = hca.cust_account_id
                              AND hca.party_id                   = hp.party_id 
                              AND ROWNUM = 1) = 'ORDER ENTRY' THEN
                     --
                     (SELECT listagg(hp.party_name,', ' ON OVERFLOW TRUNCATE)  
                         WITHIN GROUP (ORDER BY hp.party_name asc)
                             FROM apps.hz_parties                hp
                                , apps.hz_cust_accounts          hca
                                , apps.oe_order_lines_all        oola
                                , apps.oe_order_headers_all      ooha
                                , apps.ra_customer_trx_lines_all rctl
                                , apps.ra_customer_trx_all       rcta
                                , apps.hz_cust_acct_sites_all    hcas
                                , apps.hz_cust_site_uses_all     hcsu
                            WHERE ooha.header_id                 = oola.header_id
                              AND oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND rctl.inventory_item_id         = oola.inventory_item_id
                              AND rctl.line_type                 = 'LINE'
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE1 = to_char(ooha.order_number)
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE6 = to_char(oola.line_id)
                              AND RCTL.INTERFACE_LINE_CONTEXT    = 'ORDER ENTRY'
                              AND rctl.customer_trx_id           = rcta.customer_trx_id
                              AND rcta.bill_to_site_use_id       = hcsu.site_use_id
                              AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                              AND hcas.cust_account_id           = hca.cust_account_id
                              AND hca.party_id                   = hp.party_id
                              AND ROWNUM = 1)
                     --
                     ELSE
                     --            
                     CASE WHEN 
                          ( SELECT DISTINCT RCTL.INTERFACE_LINE_CONTEXT
                             FROM apps.hz_parties                hp
                                , apps.hz_cust_accounts          hca
                                , apps.oe_order_lines_all        oola
                                , apps.oe_order_headers_all      ooha
                                , apps.ra_customer_trx_lines_all rctl
                                , apps.ra_customer_trx_all       rcta
                                , apps.hz_cust_acct_sites_all    hcas
                                , apps.hz_cust_site_uses_all     hcsu
                            WHERE ooha.header_id                 = oola.header_id
                              AND oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND rctl.inventory_item_id         = oola.inventory_item_id
                              AND rctl.line_type                 = 'LINE'
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE1 = ooha.ORIG_SYS_DOCUMENT_REF
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE7 = oola.ORIG_SYS_LINE_REF
                              AND RCTL.INTERFACE_LINE_CONTEXT    = 'GEMS_PB_RR'
                              AND rctl.customer_trx_id           = rcta.customer_trx_id
                              AND rcta.bill_to_site_use_id       = hcsu.site_use_id
                              AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                              AND hcas.cust_account_id           = hca.cust_account_id
                              AND ROWNUM = 1 ) = 'GEMS_PB_RR' THEN
                     --
                     (SELECT listagg(hp.party_name,', ' ON OVERFLOW TRUNCATE)  
                         WITHIN GROUP (ORDER BY hp.party_name asc)
                             FROM apps.hz_parties                hp
                                , apps.hz_cust_accounts          hca
                                , apps.oe_order_lines_all        oola
                                , apps.oe_order_headers_all      ooha
                                , apps.ra_customer_trx_lines_all rctl
                                , apps.ra_customer_trx_all       rcta
                                , apps.hz_cust_acct_sites_all    hcas
                                , apps.hz_cust_site_uses_all     hcsu
                            WHERE ooha.header_id                 = oola.header_id
                              AND oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND rctl.inventory_item_id         = oola.inventory_item_id
                              AND rctl.line_type                 = 'LINE'
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE1 = ooha.ORIG_SYS_DOCUMENT_REF
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE7 = oola.ORIG_SYS_LINE_REF
                              AND RCTL.INTERFACE_LINE_CONTEXT    = 'GEMS_PB_RR'
                              AND rctl.customer_trx_id           = rcta.customer_trx_id
                              AND rcta.bill_to_site_use_id       = hcsu.site_use_id
                              AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                              AND hcas.cust_account_id           = hca.cust_account_id 
                              AND ROWNUM = 1 )
                     --
                     ELSE
                     --
                     (SELECT listagg(hp.party_name,', ' ON OVERFLOW TRUNCATE)  
                         WITHIN GROUP (ORDER BY hp.party_name asc)
                      FROM   APPS.HZ_CUST_ACCT_SITES_ALL HCAS,
                             apps.hz_parties             hp,
                             apps.hz_cust_accounts       hca,
                             APPS.HZ_CUST_SITE_USES_ALL  HCSU,
                             APPS.OE_ORDER_LINES_ALL     OOLA,
                             APPS.OE_ORDER_HEADERS_ALL   OOHA
                             --
                      WHERE  HCSU.SITE_USE_CODE     = 'BILL_TO'
                      AND    HCSU.CUST_ACCT_SITE_ID = HCAS.CUST_ACCT_SITE_ID
                      AND    HCSU.SITE_USE_ID       = NVL(OOLA.ATTRIBUTE1, OOHA.INVOICE_TO_ORG_ID)
                      AND    OOLA.LINE_ID           = NVL(MMT.TRX_SOURCE_LINE_ID, MMT.SOURCE_LINE_ID)
                      AND    OOHA.HEADER_ID         = OOLA.HEADER_ID
                      AND    hcas.cust_account_id   = hca.cust_account_id
                      AND    hca.party_id           = hp.party_id 
                      AND    ROWNUM = 1)
                     --          
                     END
                  END
               END      bill_to_Customer_name
               --
               , CASE WHEN (mmt.source_code = '3PL_REMITTANCE_BRAZIL') THEN
                      (SELECT listagg(DECODE(hcas.global_attribute2
                                           , '2',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'/'|| hcas.global_attribute4 ||'-'|| hcas.global_attribute5
                                           , '1',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'-'|| hcas.global_attribute5 
                                           , '3',HCSU.LOCATION||' - '||hcas.global_attribute3 ),', ' ON OVERFLOW TRUNCATE)
                       WITHIN GROUP (ORDER BY hcas.global_attribute2 asc )
                         FROM apps.ra_customer_trx_all         rcta
                            , apps.hz_cust_acct_sites_all      hcas
                            , apps.hz_cust_site_uses_all       hcsu
                        WHERE rcta.interface_header_attribute1 = mp.organization_code||'_'||mmt.transaction_reference
                          AND rcta.ship_to_site_use_id         = hcsu.site_use_id
                          AND hcsu.cust_acct_site_id           = hcas.cust_acct_site_id
                          AND rcta.org_id                      = 4330
                          AND ROWNUM = 1)
                   ELSE
                     --
                     CASE WHEN (select DISTINCT RCTL.INTERFACE_LINE_CONTEXT
                             FROM apps.hz_parties                hp
                                , apps.hz_cust_accounts          hca
                                , apps.oe_order_lines_all        oola
                                , apps.oe_order_headers_all      ooha
                                , apps.ra_customer_trx_lines_all rctl
                                , apps.ra_customer_trx_all       rcta
                                , apps.hz_cust_acct_sites_all    hcas
                                , apps.hz_cust_site_uses_all     hcsu
                            WHERE ooha.header_id                 = oola.header_id
                              AND oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND rctl.inventory_item_id         = oola.inventory_item_id
                              AND rctl.line_type                 = 'LINE'
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE1 = to_char(ooha.order_number)
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE6 = to_char(oola.line_id)
                              AND RCTL.INTERFACE_LINE_CONTEXT    = 'ORDER ENTRY'
                              AND rctl.customer_trx_id           = rcta.customer_trx_id
                              AND rcta.ship_to_site_use_id       = hcsu.site_use_id
                              AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                              AND hcas.cust_account_id           = hca.cust_account_id
                              AND hca.party_id                   = hp.party_id 
                              AND ROWNUM = 1) = 'ORDER ENTRY' THEN
                     --
                     (SELECT DISTINCT DECODE(hcas.global_attribute2
                                           , '2',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'/'|| hcas.global_attribute4 ||'-'|| hcas.global_attribute5
                                           , '1',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'-'|| hcas.global_attribute5 
                                           , '3',HCSU.LOCATION||' - '||hcas.global_attribute3)
                             FROM apps.hz_parties                hp
                                , apps.hz_cust_accounts          hca
                                , apps.oe_order_lines_all        oola
                                , apps.oe_order_headers_all      ooha
                                , apps.ra_customer_trx_lines_all rctl
                                , apps.ra_customer_trx_all       rcta
                                , apps.hz_cust_acct_sites_all    hcas
                                , apps.hz_cust_site_uses_all     hcsu
                            WHERE ooha.header_id                 = oola.header_id
                              AND oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND rctl.inventory_item_id         = oola.inventory_item_id
                              AND rctl.line_type                 = 'LINE'
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE1 = to_char(ooha.order_number)
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE6 = to_char(oola.line_id)
                              AND RCTL.INTERFACE_LINE_CONTEXT    = 'ORDER ENTRY'
                              AND rctl.customer_trx_id           = rcta.customer_trx_id
                              AND rcta.ship_to_site_use_id       = hcsu.site_use_id
                              AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                              AND hcas.cust_account_id           = hca.cust_account_id
                              AND hca.party_id                   = hp.party_id
                              AND ROWNUM = 1)
                     --
                     ELSE
                     --            
                     CASE WHEN 
                          ( SELECT DISTINCT RCTL.INTERFACE_LINE_CONTEXT
                             FROM apps.hz_parties                hp
                                , apps.hz_cust_accounts          hca
                                , apps.oe_order_lines_all        oola
                                , apps.oe_order_headers_all      ooha
                                , apps.ra_customer_trx_lines_all rctl
                                , apps.ra_customer_trx_all       rcta
                                , apps.hz_cust_acct_sites_all    hcas
                                , apps.hz_cust_site_uses_all     hcsu
                            WHERE ooha.header_id                 = oola.header_id
                              AND oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND rctl.inventory_item_id         = oola.inventory_item_id
                              AND rctl.line_type                 = 'LINE'
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE1 = ooha.ORIG_SYS_DOCUMENT_REF
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE7 = oola.ORIG_SYS_LINE_REF
                              AND RCTL.INTERFACE_LINE_CONTEXT    = 'GEMS_PB_RR'
                              AND rctl.customer_trx_id           = rcta.customer_trx_id
                              AND rcta.ship_to_site_use_id       = hcsu.site_use_id
                              AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                              AND hcas.cust_account_id           = hca.cust_account_id
                              AND ROWNUM = 1 ) = 'GEMS_PB_RR' THEN
                     --
                     (SELECT DISTINCT DECODE(hcas.global_attribute2
                                           , '2',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'/'|| hcas.global_attribute4 ||'-'|| hcas.global_attribute5
                                           , '1',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'-'|| hcas.global_attribute5 
                                           , '3',HCSU.LOCATION||' - '||hcas.global_attribute3)
                             FROM apps.hz_parties                hp
                                , apps.hz_cust_accounts          hca
                                , apps.oe_order_lines_all        oola
                                , apps.oe_order_headers_all      ooha
                                , apps.ra_customer_trx_lines_all rctl
                                , apps.ra_customer_trx_all       rcta
                                , apps.hz_cust_acct_sites_all    hcas
                                , apps.hz_cust_site_uses_all     hcsu
                            WHERE ooha.header_id                 = oola.header_id
                              AND oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND rctl.inventory_item_id         = oola.inventory_item_id
                              AND rctl.line_type                 = 'LINE'
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE1 = ooha.ORIG_SYS_DOCUMENT_REF
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE7 = oola.ORIG_SYS_LINE_REF
                              AND RCTL.INTERFACE_LINE_CONTEXT    = 'GEMS_PB_RR'
                              AND rctl.customer_trx_id           = rcta.customer_trx_id
                              AND rcta.ship_to_site_use_id       = hcsu.site_use_id
                              AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                              AND hcas.cust_account_id           = hca.cust_account_id 
                              AND ROWNUM = 1 )
                     --
                     ELSE
                     --
                     (SELECT listagg(DECODE(hcas.global_attribute2
                                           , '2',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'/'|| hcas.global_attribute4 ||'-'|| hcas.global_attribute5
                                           , '1',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'-'|| hcas.global_attribute5 
                                           , '3',HCSU.LOCATION||' - '||hcas.global_attribute3 ),', ' ON OVERFLOW TRUNCATE)
                      WITHIN GROUP (ORDER BY hcas.global_attribute2 asc) 
                         FROM apps.hz_parties             hp
                            , apps.hz_cust_accounts       hca
                            , apps.oe_order_lines_all     oola
                            , apps.hz_cust_acct_sites_all hcas
                            , apps.hz_cust_site_uses_all  hcsu
                        WHERE oola.line_id                = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                          AND oola.ship_to_org_id         = hcsu.site_use_id
                          AND hcsu.cust_acct_site_id      = hcas.cust_acct_site_id
                          AND hcas.cust_account_id        = hca.cust_account_id
                          AND hca.party_id                = hp.party_id  )
                     --
                     END
                  END
               END      ship_to_CNPJ_CPF
               --
              , CASE WHEN ( SELECT ottl.name
                              FROM apps.oe_transaction_types_tl    ottl
                                 , apps.oe_order_headers_all  ooha
                                 , apps.oe_order_lines_all    oola  
                             WHERE oola.line_id        = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                               AND oola.header_id      = ooha.header_id
                               AND ooha.order_type_id  = ottl.transaction_type_id  ) = 'GPO_BR_FE_SHIPMENT' THEN
                      (SELECT listagg(hzl.address1 ||' - '|| hzl.address2 || ' - ' || hzl.city || '-' || hzl.state || ' / ' || hzl.postal_code,', ' ON OVERFLOW TRUNCATE)  
                       WITHIN GROUP (ORDER BY hzl.address1 asc)
                       FROM apps.hz_parties             hp
                        , apps.hz_party_sites         hps
                        , apps.hz_cust_accounts       hca
                        , apps.oe_order_lines_all     oola
                        , apps.hz_cust_acct_sites_all hcas
                        , apps.hz_cust_site_uses_all  hcsu
                        , apps.hz_locations           hzl
                    WHERE oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                      AND oola.end_customer_site_use_id  = hcsu.site_use_id
                      AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                      AND hcas.cust_account_id           = hca.cust_account_id
                      AND hcas.party_site_id             = hps.party_site_id
                      AND hca.party_id                   = hp.party_id
                      AND hps.party_id                   = hp.party_id
                      AND hps.location_id                = hzl.location_id)
                ELSE
                   CASE WHEN (mmt.source_code = '3PL_REMITTANCE_BRAZIL') THEN
                      (SELECT listagg(hzl.address1 ||' - '|| hzl.address2 || ' - ' || hzl.city || '-' || hzl.state || ' / ' || hzl.postal_code,', ' ON OVERFLOW TRUNCATE)  
                       WITHIN GROUP (ORDER BY hzl.address1 asc)
                         FROM apps.ra_customer_trx_all     rcta
                            , apps.hz_cust_acct_sites_all  hcas
                            , apps.hz_cust_site_uses_all   hcsu
                            , apps.hz_parties              hp
                            , apps.hz_party_sites          hps
                            , apps.hz_cust_accounts        hca
                            , apps.hz_locations            hzl
                        WHERE rcta.interface_header_attribute1 = mp.organization_code||'_'||mmt.transaction_reference
                          AND rcta.ship_to_site_use_id         = hcsu.site_use_id
                          AND hcsu.cust_acct_site_id           = hcas.cust_acct_site_id
                          AND hcas.cust_account_id             = hca.cust_account_id
                          AND hcas.party_site_id               = hps.party_site_id
                          AND hca.party_id                     = hp.party_id
                          AND hps.party_id                     = hp.party_id
                          AND hps.location_id                  = hzl.location_id
                          AND rcta.org_id                      = 4330)
                   ELSE
                      (SELECT listagg(hzl.address1 ||' - '|| hzl.address2 || ' - ' || hzl.city || '-' || hzl.state || ' / ' || hzl.postal_code,', ' ON OVERFLOW TRUNCATE)  
                       WITHIN GROUP (ORDER BY hzl.address1 asc)
                          FROM apps.hz_parties             hp
                             , apps.hz_party_sites         hps
                             , apps.hz_cust_accounts       hca
                             , apps.oe_order_lines_all     oola
                             , apps.hz_cust_acct_sites_all hcas
                             , apps.hz_cust_site_uses_all  hcsu
                             , apps.hz_locations           hzl
                        WHERE oola.line_id                = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                           AND oola.ship_to_org_id         = hcsu.site_use_id
                           AND hcsu.cust_acct_site_id      = hcas.cust_acct_site_id
                           AND hcas.cust_account_id        = hca.cust_account_id
                           AND hcas.party_site_id          = hps.party_site_id
                           AND hca.party_id                = hp.party_id
                           AND hps.party_id                = hp.party_id
                           AND hps.location_id             = hzl.location_id   )
                   END
                END customer_address
                -- 
                -- alterado para BIll_to por Sinval fim
                --
                , CASE WHEN (mmt.source_code = '3PL_REMITTANCE_BRAZIL') THEN
                    (SELECT distinct RTRIM(REGEXP_REPLACE((listagg(rcta.trx_number,', ' ON OVERFLOW TRUNCATE)  
                     WITHIN GROUP (ORDER BY rcta.trx_number asc) ), '([^,]*)(,\1)+($|,)', '\1\3'),',')
                       FROM apps.ra_customer_trx_all       rcta
                      WHERE rcta.interface_header_attribute1  = mp.organization_code||'_'||mmt.transaction_reference
                        AND rcta.org_id                       = 4330
                        AND trunc(rcta.trx_date)              BETWEEN (trunc(mmt.transaction_date)-3) AND (trunc(mmt.transaction_date)+3)
                        AND NVL(rcta.status_trx,'XX')         <> 'VD'
                        AND NVL(rcta.reason_code,'XX')        <> 'CANCELLATION')
                ELSE
                    (SELECT distinct RTRIM(REGEXP_REPLACE((listagg(rcta.trx_number,', ' ON OVERFLOW TRUNCATE)  
                     WITHIN GROUP (ORDER BY rcta.trx_number asc) ), '([^,]*)(,\1)+($|,)', '\1\3'),',')
                       FROM apps.ra_customer_trx_lines_all rctla
                          , apps.ra_customer_trx_all       rcta
                          , apps.oe_order_lines_all        oola
                          , apps.oe_order_headers_all      ooha
                      WHERE rcta.customer_trx_id              = rctla.customer_trx_id
                        AND oola.line_id                      = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                        AND oola.header_id                    = ooha.header_id
                        AND rctla.sales_order                 = to_char(ooha.order_number)
                        AND rctla.line_type                   = 'LINE'
                        AND rcta.batch_source_id              <> 6266 -- No RR invoices
                        AND DECODE(rctla.interface_line_context,'GEMS_PB_RR',rcta.interface_header_attribute11,'999')
                            = DECODE(rctla.interface_line_context,'GEMS_PB_RR',rcta.interface_header_attribute11,'999')
                        AND rcta.org_id                       = 4330
                        AND trunc(rcta.trx_date)              BETWEEN (trunc(mmt.transaction_date)-3) AND (trunc(mmt.transaction_date)+3)
                        AND NVL(rcta.status_trx,'XX')         <> 'VD'
                        AND NVL(rcta.reason_code,'XX')        <> 'CANCELLATION')   
                END   invoice_number_ar
              , ( SELECT listagg(mrav.reservation_quantity,', ' ON OVERFLOW TRUNCATE)  
                  WITHIN GROUP (ORDER BY mrav.reservation_quantity asc)
                    FROM apps.mtl_reservations_all_v  mrav 
                       , apps.oe_order_headers_all    ooha1
                   WHERE mrav.demand_source_header_id     = ooha1.header_id
                     AND mrav.demand_source_line_id       = NVL(mmt.trx_source_line_id, mmt.source_line_id) )  reservation_quantity
              , ( SELECT listagg(ooha1.order_number,', ' ON OVERFLOW TRUNCATE)  
                  WITHIN GROUP (ORDER BY ooha1.order_number asc) 
                    FROM apps.mtl_reservations_all_v  mrav 
                       , apps.oe_order_headers_all    ooha1
                   WHERE mrav.demand_source_header_id     = ooha1.header_id
                     AND mrav.demand_source_line_id       = NVL(mmt.trx_source_line_id, mmt.source_line_id) )  reservation_order_number
              , (SELECT distinct hp.party_name
                 --WITHIN GROUP (ORDER BY hp.party_name asc)
                   FROM apps.hz_parties              hp
                      , apps.hz_cust_accounts        hca
                      , apps.oe_order_lines_all      oola1
                      , apps.oe_order_headers_all    ooha1
                      , apps.mtl_reservations_all_v  mrav 
                  WHERE mrav.demand_source_header_id   = ooha1.header_id
                    AND mrav.demand_source_line_id     = oola1.line_id
                    AND oola1.line_id                  = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                    AND oola1.ship_to_org_id           = hca.cust_account_id
                    AND hca.party_id                   = hp.party_id )         reservation_customer_name 
              , gcc1.concatenated_segments   material_account
              , gcc2.concatenated_segments   outside_processing_account
              , gcc3.concatenated_segments   material_overhead_account
              , gcc4.concatenated_segments   overhead_account
              , gcc5.concatenated_segments   resource_account
              , sysdate                                           report_date_and_time 
              , to_char(msn.last_transaction_id)                  transaction_id
              , fu.user_name ||' / '|| fu.description             user_name
              , DECODE( lot_control_code, 1 ,'Sem controle de Lote' , 2,'Com controle de Lote')   lot_control
              , DECODE( serial_number_control_code, 1, 'Sem controle de Serial'
                                                  , 2, 'Pre-definido'
                                                  , 5, 'No Recebimento'
                                                  , 6, 'Baixa na Ordem de Venda' )  serial_control
              , CASE
                 WHEN   nvl(mmt.lpn_id, mmt.content_lpn_id) IS NULL AND moq.subinventory_code <> 'WHGU42GNAT'
                   THEN 
                   (SELECT listagg(lpn.license_plate_number,', ' ON OVERFLOW TRUNCATE)WITHIN GROUP (ORDER BY lpn.license_plate_number asc)
                             FROM apps.MTL_MATERIAL_TRANSACTIONS   mtt,
                                  apps.wms_license_plate_numbers   lpn,
                                  apps.oe_order_lines_all          ool
                            WHERE 1 = 1
                             AND mtt.TRX_SOURCE_LINE_ID = CASE
                                                              WHEN LINE_CATEGORY_CODE = 'ORDER'
                                                                THEN ool.line_id
                                                              WHEN LINE_CATEGORY_CODE = 'RETURN'  
                                                                THEN   
                                                                to_number(NVL(SUBSTR(ool.ORIG_SYS_LINE_REF,
                                                                                     0,
                                                                                     INSTR(ool.ORIG_SYS_LINE_REF, '.') - 1),
                                                                              -1)) -- RMA FE OE Line Id
                                                                ELSE -1
                                                                  END
                              AND mtt.TRANSACTION_TYPE_ID = 52 --sales order pick FE ORDER
                              AND mtt.transaction_quantity < 0
                              AND mtt.inventory_item_id = ool.inventory_item_id
                              AND nvl(mtt.lpn_id, mtt.content_lpn_id) = nvl(lpn.lpn_id, -1)
                              AND ool.line_id = CASE
                                                  WHEN mtt.transaction_type_name = 'RMA Receipt'
                                                    THEN mmt.TRX_SOURCE_LINE_ID
                                                  WHEN mtt.transaction_type_name = 'GPO Nationalization Receipt'
                                                     THEN 
                                                      to_number(NVL(SUBSTR(RTRIM(LTRIM(translate(mmt.TRANSACTION_REFERENCE,translate(mmt.TRANSACTION_REFERENCE||'a','1234567890.',' '),' '))),
                                                         0,
                                                         INSTR(RTRIM(LTRIM(translate(mmt.TRANSACTION_REFERENCE,translate(mmt.TRANSACTION_REFERENCE||'a','1234567890.',' '),' '))), '.') - 1),
                                                  -1))
                                                  ELSE -1
                                                    END)
                      WHEN moq.subinventory_code = 'WHGU42GNAT'
                  THEN (SELECT listagg(wlp.license_plate_number,', ' ON OVERFLOW TRUNCATE)  
                            WITHIN GROUP (ORDER BY wlp.license_plate_number asc)
                        FROM   gems_ont.ge_gpo_nationalization_line gnl, 
                               gems_ont.ge_gpo_nationalization_line gn2,
                               apps.wms_license_plate_numbers       wlp,
                               apps.po_line_locations_all           pll,
                               apps.po_lines_all                    pol,
                               apps.po_headers_all                  poh,
                               apps.rcv_shipment_headers            rsh,
                               apps.rcv_transactions                rt
                        Where  wlp.lpn_id(+) = gn2.lpn_id
                        AND gnl.nationalization_so_line_id = gn2.nationalization_so_line_id
                        AND pll.line_location_id = gnl.DOCUMENT_ID
                        AND pll.po_header_id = poh.po_header_id
                        AND pll.po_line_id = pol.po_line_id
                        AND gn2.record_type = 'IMPORT'
                        AND gnl.record_type = 'NATIONALIZATION'
                        AND rt.transaction_id                = mmt.rcv_transaction_id
                        AND rt.po_line_location_id           = pll.line_location_id
                        AND rt.shipment_header_id            = rsh.shipment_header_id)
                      ELSE 
                          (SELECT lpn.LICENSE_PLATE_NUMBER
                           FROM   apps.wms_license_plate_numbers   lpn
                           WHERE  nvl(mmt.lpn_id, mmt.content_lpn_id) = nvl(lpn.lpn_id, -1))
                        END LPN_Value                                   
              , 'q1' query 
--, mmt.transaction_type_id
--, mmt.trx_source_line_id
--, mmt.source_line_id
           FROM apps.mtl_serial_numbers              msn  
              , apps.mtl_parameters                  mp
              , apps.mtl_system_items_b              msi
              , apps.mtl_item_locations_kfv          milk
              , apps.gl_code_combinations            gcc
              , apps.gl_code_combinations_kfv        gcc1
              , apps.gl_code_combinations_kfv        gcc2
              , apps.gl_code_combinations_kfv        gcc3
              , apps.gl_code_combinations_kfv        gcc4
              , apps.gl_code_combinations_kfv        gcc5
              , apps.mtl_material_transactions       mmt
              , apps.mtl_transaction_types           mtt
              , apps.mtl_txn_source_types            mtst
              , apps.mtl_secondary_inventories_fk_v  msifv
              , apps.fnd_flex_values_vl              ffvv
              , apps.fnd_flex_value_sets             ffvs
              , apps.fnd_user                        fu
              , ( SELECT organization_id
                       , inventory_item_id
                       , subinventory_code
                       , locator_id
                       , lot_number
                       --, update_transaction_id
                       --, transaction_uom_code
                       , SUM (primary_transaction_quantity)  onhand_qty
                    FROM apps.mtl_onhand_quantities_detail
                   WHERE organization_id IN ( SELECT ood.ORGANIZATION_id FROM apps.org_organization_definitions ood WHERE ood.SET_OF_BOOKS_ID = 230 )
                GROUP BY organization_id
                       , inventory_item_id
                       , subinventory_code
                       , locator_id
                 --      , revision
                       , lot_number
                       --, update_transaction_id
                       --, transaction_uom_code
                       ) moq
             ,APPS.MTL_PAC_ACTUAL_COST_DETAILS MPACD          
          WHERE 1                                = 1
          AND decode(mmt.periodic_primary_quantity,null,mmt.transfer_transaction_id,MMT.TRANSACTION_ID) = MPACD.TRANSACTION_ID  
            AND mp.organization_id               = msi.organization_id
--            AND msi.segment1 = '60510302'
            AND msifv.organization_id            = msi.organization_id
            AND msifv.secondary_inventory_name   = moq.subinventory_code
            AND msifv.material_account           = gcc1.code_combination_id
            AND msifv.outside_processing_account = gcc2.code_combination_id
            AND msifv.material_overhead_account  = gcc3.code_combination_id
            AND msifv.overhead_account           = gcc4.code_combination_id
            AND msifv.resource_account           = gcc5.code_combination_id
            AND msi.cost_of_sales_account        = gcc.code_combination_id
            AND ffvs.flex_value_set_name         = 'GE_GL_AFF_ES_PRODUCT_LINE'
            AND ffvs.flex_value_set_id           = ffvv.flex_value_set_id
            AND ffvv.flex_value_meaning          = gcc.segment8
            AND 'TYPE 1'                        IN ('TYPE 1')
            AND msi.organization_id             IN ( SELECT ood.organization_id FROM apps.org_organization_definitions ood WHERE ood.SET_OF_BOOKS_ID = 230 )
            AND moq.inventory_item_id            = msn.inventory_item_id         (+) --mmt.inventory_item_id (+)   
            AND moq.organization_id              = msn.current_organization_id   (+) --mmt.organization_id   (+)   
            AND moq.subinventory_code            = msn.current_subinventory_code (+) --mmt.subinventory_code (+)   
            AND moq.locator_id                   = msn.current_locator_id        (+) --mmt.locator_id        (+)   
            AND msn.current_status           (+) = 3                 
            AND moq.lot_number                   = msn.lot_number (+)
            AND moq.inventory_item_id            = msi.inventory_item_id
            AND moq.locator_id                   = milk.inventory_location_id
            AND moq.organization_id              = mp.organization_id
            AND msn.last_transaction_id          = mmt.transaction_id  (+)
--    AND MMT.TRANSACTION_ID = 2562828197
            AND mtt.transaction_type_id          = mmt.transaction_type_id 
            AND mtst.transaction_source_type_id  = mmt.transaction_source_type_id
            AND fu.user_id                       = mmt.created_by
    AND MMT.TRANSACTION_ID NOT IN(SELECT MMT2.TRANSACTION_ID 
                                  FROM AMARCHIVE.MTL_MATERIAL_TRANSACTIONS  MMT2
                                  WHERE MMT2.TRANSACTION_ID = MMT.TRANSACTION_ID)
 -----------------------------------------------------------------------------
UNION
------------------------------------------------------------------------------
-- Com Controle de Serial e Lote ---- AMARCHIVE.MTL_MATERIAL_TRANSACTIONS
         SELECT DISTINCT  --'2' NUM
        /* ( SELECT ccg.cost_group 
                             FROM apps.cst_cost_groups            ccg
                                , apps.cst_cost_group_assignments ccga
                            WHERE ccga.cost_group_id     = ccg.cost_group_id
                              AND ccga.organization_id   = mp.organization_id )  cost_group*/
            ( SELECT ccg.cost_group 
                             FROM apps.cst_cost_groups            ccg
                            WHERE MPACD.cost_group_id     = ccg.cost_group_id )  cost_group  
              , ( SELECT ( SELECT cpp1.period_name 
                             FROM apps.cst_pac_item_costs   cst
                                , apps.cst_pac_periods      cpp1
                            WHERE cst.pac_period_id     = (SELECT MAX(PAC_PERIOD_ID)                   FROM APPS.CST_PAC_PERIODS                  WHERE LEGAL_ENTITY = (SELECT LEGAL_ENTITY                                          FROM APPS.ORG_ORGANIZATION_DEFINITIONS OOD                                         WHERE OOD.ORGANIZATION_ID = mp.organization_id                                         ) )
                              AND cst.pac_period_id     = cpp1.pac_period_id
                              AND cst.inventory_item_id = msi.inventory_item_id
                              AND cst.cost_group_id     = ccg.cost_group_id )  
                    FROM apps.cst_cost_groups            ccg
                       , apps.cst_cost_group_assignments ccga
                   WHERE ccga.cost_group_id     = ccg.cost_group_id
                     AND ccga.organization_id   = mp.organization_id ) period_name
              , mp.organization_code
              , mp.attribute7                organization_type
              , mp.organization_id 
              , moq.subinventory_code
              , msifv.description            subinv_description
              , milk.concatenated_segments   locators
              , DECODE( msifv.asset_inventory, 1 , 'Asset', 2, 'Non Asset')   asset_type
              , msi.segment1                 part_number
              ,DECODE(msi.inventory_asset_flag, NULL, 'No', 'N', 'No', 'Y', 'Yes')                         flag_asset_inventory
              ,DECODE(msi.costing_enabled_flag, NULL, 'No', 'N', 'No', 'Y', 'Yes')                         flag_de_custo
              , msi.description              descrip_eng
              , msi.attribute3               descrip_ptb
              , msi.creation_date            item_creation_date
              , (trunc(SYSDATE) - trunc(msi.creation_date))      days_from_creation
              , gcc.segment8                                     product_line
              , ffvv.description                                 desc_prod_line
              , msi.primary_uom_code   uom
              , DECODE (msi.serial_number_control_code, 1, moq.onhand_qty, 1 ) transaction_quantity
              , NVL(( SELECT cic.item_cost
                        FROM apps.cst_item_costs cic
                       WHERE cic.organization_id   = msi.organization_id
                         AND cic.inventory_item_id = msi.inventory_item_id
                         AND cic.cost_type_id      = 1 ),0)  custo_unit_inv
              /*, nvl(( SELECT ( SELECT ROUND (cst.item_cost,2) 
                                 FROM apps.cst_pac_item_costs   cst
                                WHERE cst.pac_period_id     = (SELECT MAX(PAC_PERIOD_ID)                   FROM APPS.CST_PAC_PERIODS                  WHERE LEGAL_ENTITY = (SELECT LEGAL_ENTITY                                          FROM APPS.ORG_ORGANIZATION_DEFINITIONS OOD                                         WHERE OOD.ORGANIZATION_ID = mp.organization_id                                         ) )
                                  AND cst.inventory_item_id = msi.inventory_item_id
                                  AND cst.cost_group_id     = ccg.cost_group_id )  item_cost
                        FROM apps.cst_cost_groups            ccg
                           , apps.cst_cost_group_assignments ccga
                       WHERE ccga.cost_group_id     = ccg.cost_group_id
                         AND ccga.organization_id   = mp.organization_id ) ,0) custo_unit_pac*/
                , nvl((SELECT ROUND (cst.item_cost,2) 
                       FROM apps.cst_pac_item_costs   cst
                      WHERE cst.pac_period_id     = (SELECT MAX(PAC_PERIOD_ID)                   
                                                                FROM APPS.CST_PAC_PERIODS                  
                                                                WHERE LEGAL_ENTITY = (SELECT LEGAL_ENTITY                                         
                                                                                        FROM APPS.ORG_ORGANIZATION_DEFINITIONS OOD                                        
                                                                                        WHERE OOD.ORGANIZATION_ID = mp.organization_id
                                                        ) )
                        AND cst.inventory_item_id = msi.inventory_item_id
                        AND cst.cost_group_id     = MPACD.cost_group_id) ,0)  custo_unit_pac
              , moq.lot_number
              , ( SELECT mln.creation_date         
                    FROM apps.mtl_lot_numbers              mln
                   WHERE mln.lot_number           = moq.lot_number 
                     AND mln.inventory_item_id    = msi.inventory_item_id
                     AND mln.organization_id      = mp.organization_id  )  lot_creation_date
              , NULL   lot_qty_days_creation
              , ( SELECT mln.expiration_date         
                    FROM apps.mtl_lot_numbers              mln
                   WHERE mln.lot_number           = moq.lot_number
                     AND mln.inventory_item_id    = msi.inventory_item_id
                     AND mln.organization_id      = mp.organization_id  )  lot_expiration_date
              , msn.serial_number 
              , msn.creation_date     serial_creation_date
              , mtt.transaction_type_name           last_transaction_type
              , mmt.transaction_source_name         last_transaction_source
              , mtst.transaction_source_type_name   last_source_type
              , mmt.source_code
              , TO_CHAR(mmt.transaction_date, 'DD-MON-RRRR')       transaction_date
        , (SELECT TO_CHAR(mmt1.transaction_date, 'DD-MON-RRRR') 
                        FROM apps.mtl_material_transactions mmt1
                        WHERE mmt1.transaction_type_id=420
                        AND mmt1.source_line_id=mmt.source_line_id) initial_consignment_date        
              , (TRUNC ( SYSDATE )- TRUNC(mmt.transaction_date))   transaction_qty_of_days
              , TO_CHAR(mmt.transaction_reference)                 transaction_reference
              , CASE WHEN mmt.source_code = '3PL_REMITTANCE_BRAZIL' THEN
                     (SELECT listagg(pha.segment1,', ' ON OVERFLOW TRUNCATE)  
                      WITHIN GROUP (ORDER BY pha.segment1 asc)
                        FROM apps.po_headers_all        pha
                           , apps.po_lines_all          pla
                       WHERE pla.po_line_id   = mmt.source_line_id
                         AND pla.po_header_id = pha.po_header_id)
                     WHEN mmt.source_code IN ('ORDER ENTRY','IIP') THEN
                        NULL
                     WHEN mmt.source_code = 'RCV' THEN
                        ( SELECT listagg(pha.segment1,', ' ON OVERFLOW TRUNCATE)  
                          WITHIN GROUP (ORDER BY pha.segment1 asc)
                            FROM apps.po_headers_all            pha
                               , apps.po_lines_all              pla
                               , apps.po_line_locations_all     plla
                               , apps.rcv_shipment_headers      rsh
                               , apps.rcv_transactions          rt
                           WHERE rt.transaction_id                = mmt.rcv_transaction_id
                             AND rt.po_line_location_id           = plla.line_location_id
                             AND plla.po_line_id                  = pla.po_line_id
                             AND pha.po_header_id                 = pla.po_header_id
                             AND rt.shipment_header_id            = rsh.shipment_header_id
                             AND rsh.receipt_source_code          = 'VENDOR'  )
                     ELSE
                        NULL
                END      po_number
              , CASE WHEN mmt.source_code = '3PL_REMITTANCE_BRAZIL' THEN
                     (SELECT listagg(aps.vendor_name,', ' ON OVERFLOW TRUNCATE)  
                      WITHIN GROUP (ORDER BY aps.vendor_name asc)
                        FROM apps.po_headers_all            pha
                           , apps.po_lines_all              pla
                           , apps.ap_suppliers              aps
                           , apps.ap_supplier_sites_all     apss
                       WHERE pla.po_line_id     = mmt.source_line_id
                         AND pla.po_header_id   = pha.po_header_id
                         AND pha.vendor_id      = aps.vendor_id
                         AND aps.vendor_id      = apss.vendor_id
                         AND pha.vendor_site_id = apss.vendor_site_id )
                     WHEN mmt.source_code IN ('ORDER ENTRY','IIP') THEN
                        NULL
                     WHEN mmt.source_code = 'RCV' THEN
                        ( SELECT listagg(aps.vendor_name,', ' ON OVERFLOW TRUNCATE)  
                          WITHIN GROUP (ORDER BY aps.vendor_name asc)
                            FROM apps.po_headers_all            pha
                               , apps.po_lines_all              pla
                               , apps.po_line_locations_all     plla
                               , apps.rcv_shipment_headers      rsh
                               , apps.rcv_transactions          rt
                               , apps.ap_suppliers              aps
                               , apps.ap_supplier_sites_all     apss
                           WHERE rt.transaction_id          = mmt.rcv_transaction_id
                             AND rt.po_line_location_id     = plla.line_location_id
                             AND plla.po_line_id            = pla.po_line_id
                             AND pha.po_header_id           = pla.po_header_id
                             AND rt.shipment_header_id      = rsh.shipment_header_id
                             AND rsh.receipt_source_code    = 'VENDOR'
                             AND pha.vendor_id              = aps.vendor_id
                             AND aps.vendor_id              = apss.vendor_id
                             AND pha.vendor_site_id         = apss.vendor_site_id  )
                     ELSE
                        NULL
                END    po_supplier
              , CASE WHEN mmt.source_code = '3PL_REMITTANCE_BRAZIL' THEN
                     ( SELECT listagg(cfi.invoice_num,', ' ON OVERFLOW TRUNCATE)  
                         WITHIN GROUP (ORDER BY cfi.invoice_num asc)
                         FROM apps.cll_f189_invoice_lines cfil
                            , apps.cll_f189_invoices      cfi
                            , apps.po_lines_all           pla
                            , apps.po_line_locations_all  plla
                        WHERE plla.po_line_id       = pla.po_line_id
                          AND pla.po_line_id        = mmt.source_line_id
                          AND plla.line_location_id = cfil.line_location_id
                          AND cfil.invoice_id       = cfi.invoice_id )
                     WHEN mmt.source_code IN ('ORDER ENTRY','IIP') THEN
                        NULL
                     WHEN mmt.source_code = 'RCV' THEN
                        ( SELECT listagg(cfi.invoice_num,', ' ON OVERFLOW TRUNCATE)  
                            WITHIN GROUP (ORDER BY cfi.invoice_num asc)
                            FROM apps.po_headers_all            pha
                               , apps.po_lines_all              pla
                               , apps.po_line_locations_all     plla
                               , apps.cll_f189_invoice_lines    cfil
                               , apps.cll_f189_invoices         cfi
                               , apps.rcv_shipment_headers      rsh
                               , apps.rcv_transactions          rt
                           WHERE rt.transaction_id          = mmt.rcv_transaction_id
                             AND rt.po_line_location_id     = plla.line_location_id
                             AND plla.line_location_id      = cfil.line_location_id
                             AND cfil.invoice_id            = cfi.invoice_id
                             AND plla.po_line_id            = pla.po_line_id
                             AND pha.po_header_id           = pla.po_header_id
                             AND rt.shipment_header_id      = rsh.shipment_header_id
                             AND rsh.receipt_source_code    = 'VENDOR'   )
                     ELSE
                        NULL
                END    NF_RI
              , (SELECT DECODE( mmt.source_code, '3PL_REMITTANCE_BRAZIL',NULL,to_char(ooha.order_number) )
                   FROM apps.oe_order_headers_all  ooha
                      , apps.oe_order_lines_all    oola  
                  WHERE oola.line_id        = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                    AND oola.header_id      = ooha.header_id )   order_number
               -- 
               -- alterado para BIll_to por Sinval inicio
               --
               , CASE WHEN ( SELECT ottl.name
                             FROM apps.oe_transaction_types_tl    ottl
                                , apps.oe_order_headers_all  ooha
                                , apps.oe_order_lines_all    oola  
                            WHERE oola.line_id        = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND oola.header_id      = ooha.header_id
                              AND ooha.order_type_id  = ottl.transaction_type_id  ) = 'GPO_BR_FE_SHIPMENT' THEN
                     (SELECT listagg(hp.party_name,', ' ON OVERFLOW TRUNCATE)  
                      WITHIN GROUP (ORDER BY hp.party_name asc)
                        FROM apps.hz_parties             hp
                           , apps.hz_cust_accounts       hca
                           , apps.oe_order_lines_all     oola
                           , apps.hz_cust_acct_sites_all hcas
                           , apps.hz_cust_site_uses_all  hcsu
                       WHERE oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                         AND oola.end_customer_site_use_id  = hcsu.site_use_id
                         AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                         AND hcas.cust_account_id           = hca.cust_account_id
                         AND hca.party_id                   = hp.party_id )
                  ELSE
                     CASE WHEN (mmt.source_code = '3PL_REMITTANCE_BRAZIL') THEN
                       (SELECT listagg(hp.party_name,', ' ON OVERFLOW TRUNCATE)  
                        WITHIN GROUP (ORDER BY hp.party_name asc)
                          FROM apps.hz_parties             hp,
                               apps.hz_cust_accounts       hca,
                               apps.ra_customer_trx_all    rcta,
                               apps.hz_cust_acct_sites_all hcas,
                               apps.hz_cust_site_uses_all  hcsu
                         WHERE rcta.interface_header_attribute1 = mp.organization_code||'_'||mmt.transaction_reference
                           AND rcta.ship_to_site_use_id         = hcsu.site_use_id
                           AND hcsu.cust_acct_site_id           = hcas.cust_acct_site_id
                           AND hcas.cust_account_id             = hca.cust_account_id
                           AND hca.party_id                     = hp.party_id
                           AND rcta.org_id                      = 4330)
                     ELSE
                        (SELECT listagg(hp.party_name,', ' ON OVERFLOW TRUNCATE)  
                         WITHIN GROUP (ORDER BY hp.party_name asc)
                           FROM apps.hz_parties             hp
                              , apps.hz_cust_accounts       hca
                              , apps.oe_order_lines_all     oola
                              , apps.hz_cust_acct_sites_all hcas
                              , apps.hz_cust_site_uses_all  hcsu
                          WHERE oola.line_id                = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                            AND oola.ship_to_org_id         = hcsu.site_use_id
                           AND hcsu.cust_acct_site_id      = hcas.cust_acct_site_id
                            AND hcas.cust_account_id        = hca.cust_account_id
                            AND hca.party_id                = hp.party_id )
                    END                 
               END    customer_name
             , CASE WHEN ( SELECT ottl.name
                             FROM apps.oe_transaction_types_tl    ottl
                                , apps.oe_order_headers_all  ooha
                                , apps.oe_order_lines_all    oola  
                            WHERE oola.line_id        = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND oola.header_id      = ooha.header_id
                              AND ooha.order_type_id  = ottl.transaction_type_id  ) = 'GPO_BR_FE_SHIPMENT' THEN
                     (SELECT listagg(hca.account_number,', ' ON OVERFLOW TRUNCATE)  
                      WITHIN GROUP (ORDER BY hca.account_number asc)
                        FROM apps.hz_parties             hp
                           , apps.hz_cust_accounts       hca
                           , apps.oe_order_lines_all     oola
                           , apps.hz_cust_acct_sites_all hcas
                           , apps.hz_cust_site_uses_all  hcsu
                       WHERE oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                         AND oola.end_customer_site_use_id  = hcsu.site_use_id
                         AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                         AND hcas.cust_account_id           = hca.cust_account_id
                         AND hca.party_id                   = hp.party_id )
                  ELSE
                     CASE WHEN (mmt.source_code = '3PL_REMITTANCE_BRAZIL') THEN
                        (SELECT listagg(hca.account_number,', ' ON OVERFLOW TRUNCATE)  
                         WITHIN GROUP (ORDER BY hca.account_number asc)
                           FROM apps.hz_parties             hp,
                                apps.hz_cust_accounts       hca,
                                apps.ra_customer_trx_all    rcta,
                                apps.hz_cust_acct_sites_all hcas,
                                apps.hz_cust_site_uses_all  hcsu
                          WHERE rcta.interface_header_attribute1 = mp.organization_code||'_'||mmt.transaction_reference
                            AND rcta.ship_to_site_use_id         = hcsu.site_use_id
                            AND hcsu.cust_acct_site_id           = hcas.cust_acct_site_id
                            AND hcas.cust_account_id             = hca.cust_account_id
                            AND hca.party_id                     = hp.party_id
                            AND rcta.org_id                      = 4330)
                     ELSE
                        (SELECT listagg(hca.account_number,', ' ON OVERFLOW TRUNCATE)  
                         WITHIN GROUP (ORDER BY hca.account_number asc)
                           FROM apps.hz_parties             hp
                              , apps.hz_cust_accounts       hca
                              , apps.oe_order_lines_all     oola
                              , apps.hz_cust_acct_sites_all hcas
                              , apps.hz_cust_site_uses_all  hcsu
                          WHERE oola.line_id                = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                            AND oola.ship_to_org_id         = hcsu.site_use_id
                            AND hcsu.cust_acct_site_id      = hcas.cust_acct_site_id
                            AND hcas.cust_account_id        = hca.cust_account_id
                            AND hca.party_id                = hp.party_id   )
                     END
                  END   customer_number
              --
              , CASE WHEN ( SELECT ottl.name
                             FROM apps.oe_transaction_types_tl    ottl
                                , apps.oe_order_headers_all  ooha
                                , apps.oe_order_lines_all    oola  
                            WHERE oola.line_id        = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND oola.header_id      = ooha.header_id
                              AND ooha.order_type_id  = ottl.transaction_type_id  ) = 'GPO_BR_FE_SHIPMENT' THEN
                     (SELECT listagg(DECODE(hcas.global_attribute2
                                           , '2',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'/'|| hcas.global_attribute4 ||'-'|| hcas.global_attribute5
                                           , '1',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'-'|| hcas.global_attribute5 
                                           , '3',HCSU.LOCATION||' - '||hcas.global_attribute3 ),', ' ON OVERFLOW TRUNCATE)
                     WITHIN GROUP (ORDER BY hcas.global_attribute2 asc ) 
                        FROM apps.hz_parties             hp
                           , apps.hz_cust_accounts       hca
                           , apps.oe_order_lines_all     oola
                           , apps.hz_cust_acct_sites_all hcas
                           , apps.hz_cust_site_uses_all  hcsu
                       WHERE oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                         AND oola.end_customer_site_use_id  = hcsu.site_use_id
                         AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                         AND hcas.cust_account_id           = hca.cust_account_id
                         AND hca.party_id                   = hp.party_id )
                ELSE
                   CASE WHEN (mmt.source_code = '3PL_REMITTANCE_BRAZIL') THEN
                      (SELECT listagg(DECODE(hcas.global_attribute2
                                           , '2',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'/'|| hcas.global_attribute4 ||'-'|| hcas.global_attribute5
                                           , '1',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'-'|| hcas.global_attribute5 
                                           , '3',HCSU.LOCATION||' - '||hcas.global_attribute3 ),', ' ON OVERFLOW TRUNCATE)
                     WITHIN GROUP (ORDER BY hcas.global_attribute2 asc) 
                         FROM apps.ra_customer_trx_all     rcta
                            , apps.hz_cust_acct_sites_all  hcas
                            , apps.hz_cust_site_uses_all   hcsu
                        WHERE rcta.interface_header_attribute1 = mp.organization_code||'_'||mmt.transaction_reference
                          AND rcta.ship_to_site_use_id         = hcsu.site_use_id
                          AND hcsu.cust_acct_site_id           = hcas.cust_acct_site_id
                          AND rcta.org_id                      = 4330)
                   ELSE
                      (SELECT listagg(DECODE(hcas.global_attribute2
                                           , '2',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'/'|| hcas.global_attribute4 ||'-'|| hcas.global_attribute5
                                           , '1',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'-'|| hcas.global_attribute5 
                                           , '3',HCSU.LOCATION||' - '||hcas.global_attribute3 ),', ' ON OVERFLOW TRUNCATE)
                      WITHIN GROUP (ORDER BY hcas.global_attribute2 asc) 
                         FROM apps.hz_parties             hp
                            , apps.hz_cust_accounts       hca
                            , apps.oe_order_lines_all     oola
                            , apps.hz_cust_acct_sites_all hcas
                            , apps.hz_cust_site_uses_all  hcsu
                        WHERE oola.line_id                = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                          AND oola.ship_to_org_id         = hcsu.site_use_id
                          AND hcsu.cust_acct_site_id      = hcas.cust_acct_site_id
                          AND hcas.cust_account_id        = hca.cust_account_id
                          AND hca.party_id                = hp.party_id  )
                   END
                END  customer_cnpj_cpf
               -- 
              , CASE WHEN (mmt.source_code = '3PL_REMITTANCE_BRAZIL') THEN
                      (SELECT listagg(DECODE(hcas.global_attribute2
                                           , '2',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'/'|| hcas.global_attribute4 ||'-'|| hcas.global_attribute5
                                           , '1',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'-'|| hcas.global_attribute5 
                                           , '3',HCSU.LOCATION||' - '||hcas.global_attribute3 ),', ' ON OVERFLOW TRUNCATE)
                       WITHIN GROUP (ORDER BY hcas.global_attribute2 asc )
                         FROM apps.ra_customer_trx_all         rcta
                            , apps.hz_cust_acct_sites_all      hcas
                            , apps.hz_cust_site_uses_all       hcsu
                        WHERE rcta.interface_header_attribute1 = mp.organization_code||'_'||mmt.transaction_reference
                          AND rcta.bill_to_site_use_id         = hcsu.site_use_id
                          AND hcsu.cust_acct_site_id           = hcas.cust_acct_site_id
                          AND rcta.org_id                      = 4330
                          AND ROWNUM = 1)
                   ELSE
                     --
                     CASE WHEN (select DISTINCT RCTL.INTERFACE_LINE_CONTEXT
                             FROM apps.hz_parties                hp
                                , apps.hz_cust_accounts          hca
                                , apps.oe_order_lines_all        oola
                                , apps.oe_order_headers_all      ooha
                                , apps.ra_customer_trx_lines_all rctl
                                , apps.ra_customer_trx_all       rcta
                                , apps.hz_cust_acct_sites_all    hcas
                                , apps.hz_cust_site_uses_all     hcsu
                            WHERE ooha.header_id                 = oola.header_id
                              AND oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND rctl.inventory_item_id         = oola.inventory_item_id
                              AND rctl.line_type                 = 'LINE'
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE1 = to_char(ooha.order_number)
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE6 = to_char(oola.line_id)
                              AND RCTL.INTERFACE_LINE_CONTEXT    = 'ORDER ENTRY'
                              AND rctl.customer_trx_id           = rcta.customer_trx_id
                              AND rcta.bill_to_site_use_id       = hcsu.site_use_id
                              AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                              AND hcas.cust_account_id           = hca.cust_account_id
                              AND hca.party_id                   = hp.party_id 
                              AND ROWNUM = 1) = 'ORDER ENTRY' THEN
                     --
                     (SELECT DISTINCT DECODE(hcas.global_attribute2
                                           , '2',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'/'|| hcas.global_attribute4 ||'-'|| hcas.global_attribute5
                                           , '1',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'-'|| hcas.global_attribute5 
                                           , '3',HCSU.LOCATION||' - '||hcas.global_attribute3)
                             FROM apps.hz_parties                hp
                                , apps.hz_cust_accounts          hca
                                , apps.oe_order_lines_all        oola
                                , apps.oe_order_headers_all      ooha
                                , apps.ra_customer_trx_lines_all rctl
                                , apps.ra_customer_trx_all       rcta
                                , apps.hz_cust_acct_sites_all    hcas
                                , apps.hz_cust_site_uses_all     hcsu
                            WHERE ooha.header_id                 = oola.header_id
                              AND oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND rctl.inventory_item_id         = oola.inventory_item_id
                              AND rctl.line_type                 = 'LINE'
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE1 = to_char(ooha.order_number)
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE6 = to_char(oola.line_id)
                              AND RCTL.INTERFACE_LINE_CONTEXT    = 'ORDER ENTRY'
                              AND rctl.customer_trx_id           = rcta.customer_trx_id
                              AND rcta.bill_to_site_use_id       = hcsu.site_use_id
                              AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                              AND hcas.cust_account_id           = hca.cust_account_id
                              AND hca.party_id                   = hp.party_id
                              AND ROWNUM = 1)
                     --
                     ELSE
                     --            
                     CASE WHEN 
                          ( SELECT DISTINCT RCTL.INTERFACE_LINE_CONTEXT
                             FROM apps.hz_parties                hp
                                , apps.hz_cust_accounts          hca
                                , apps.oe_order_lines_all        oola
                                , apps.oe_order_headers_all      ooha
                                , apps.ra_customer_trx_lines_all rctl
                                , apps.ra_customer_trx_all       rcta
                                , apps.hz_cust_acct_sites_all    hcas
                                , apps.hz_cust_site_uses_all     hcsu
                            WHERE ooha.header_id                 = oola.header_id
                              AND oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND rctl.inventory_item_id         = oola.inventory_item_id
                              AND rctl.line_type                 = 'LINE'
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE1 = ooha.ORIG_SYS_DOCUMENT_REF
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE7 = oola.ORIG_SYS_LINE_REF
                              AND RCTL.INTERFACE_LINE_CONTEXT    = 'GEMS_PB_RR'
                              AND rctl.customer_trx_id           = rcta.customer_trx_id
                              AND rcta.bill_to_site_use_id       = hcsu.site_use_id
                              AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                              AND hcas.cust_account_id           = hca.cust_account_id
                              AND ROWNUM = 1 ) = 'GEMS_PB_RR' THEN
                     --
                     (SELECT DISTINCT DECODE(hcas.global_attribute2
                                           , '2',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'/'|| hcas.global_attribute4 ||'-'|| hcas.global_attribute5
                                           , '1',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'-'|| hcas.global_attribute5 
                                           , '3',HCSU.LOCATION||' - '||hcas.global_attribute3)
                             FROM apps.hz_parties                hp
                                , apps.hz_cust_accounts          hca
                                , apps.oe_order_lines_all        oola
                                , apps.oe_order_headers_all      ooha
                                , apps.ra_customer_trx_lines_all rctl
                                , apps.ra_customer_trx_all       rcta
                                , apps.hz_cust_acct_sites_all    hcas
                                , apps.hz_cust_site_uses_all     hcsu
                            WHERE ooha.header_id                 = oola.header_id
                              AND oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND rctl.inventory_item_id         = oola.inventory_item_id
                              AND rctl.line_type                 = 'LINE'
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE1 = ooha.ORIG_SYS_DOCUMENT_REF
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE7 = oola.ORIG_SYS_LINE_REF
                              AND RCTL.INTERFACE_LINE_CONTEXT    = 'GEMS_PB_RR'
                              AND rctl.customer_trx_id           = rcta.customer_trx_id
                              AND rcta.bill_to_site_use_id       = hcsu.site_use_id
                              AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                              AND hcas.cust_account_id           = hca.cust_account_id 
                              AND ROWNUM = 1 )
                     --
                     ELSE
                     --
                    (SELECT DISTINCT DECODE(hcas.global_attribute2
                                   , '2',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'/'|| hcas.global_attribute4 ||'-'|| hcas.global_attribute5
                                   , '1',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'-'|| hcas.global_attribute5 
                                   , '3',HCSU.LOCATION||' - '||hcas.global_attribute3)
                             --
                      FROM   APPS.HZ_CUST_ACCT_SITES_ALL HCAS,
                             APPS.HZ_CUST_SITE_USES_ALL  HCSU,
                             APPS.OE_ORDER_LINES_ALL     OOLA,
                             APPS.OE_ORDER_HEADERS_ALL   OOHA
                             --
                      WHERE  HCSU.SITE_USE_CODE     = 'BILL_TO'
                      AND    HCSU.CUST_ACCT_SITE_ID = HCAS.CUST_ACCT_SITE_ID
                      AND    HCSU.SITE_USE_ID       = NVL(OOLA.ATTRIBUTE1, OOHA.INVOICE_TO_ORG_ID)
                      AND    OOLA.LINE_ID           = NVL(MMT.TRX_SOURCE_LINE_ID, MMT.SOURCE_LINE_ID)
                      AND    OOHA.HEADER_ID         = OOLA.HEADER_ID
                      AND    ROWNUM = 1)
                     --
                     END
                  END
               END      bill_to_CNPJ_CPF
               --
                             --
              , CASE WHEN (mmt.source_code = '3PL_REMITTANCE_BRAZIL') THEN
                        (SELECT listagg(hp.party_name,', ' ON OVERFLOW TRUNCATE)  
                        WITHIN GROUP (ORDER BY hp.party_name asc)
                          FROM apps.hz_parties             hp,
                               apps.hz_cust_accounts       hca,
                               apps.ra_customer_trx_all    rcta,
                               apps.hz_cust_acct_sites_all hcas,
                               apps.hz_cust_site_uses_all  hcsu
                         WHERE rcta.interface_header_attribute1 = mp.organization_code||'_'||mmt.transaction_reference
                           AND rcta.bill_to_site_use_id         = hcsu.site_use_id
                           AND hcsu.cust_acct_site_id           = hcas.cust_acct_site_id
                           AND hcas.cust_account_id             = hca.cust_account_id
                           AND hca.party_id                     = hp.party_id
                           AND rcta.org_id                      = 4330)
                   ELSE
                     --
                     CASE WHEN (select DISTINCT RCTL.INTERFACE_LINE_CONTEXT
                             FROM apps.hz_parties                hp
                                , apps.hz_cust_accounts          hca
                                , apps.oe_order_lines_all        oola
                                , apps.oe_order_headers_all      ooha
                                , apps.ra_customer_trx_lines_all rctl
                                , apps.ra_customer_trx_all       rcta
                                , apps.hz_cust_acct_sites_all    hcas
                                , apps.hz_cust_site_uses_all     hcsu
                            WHERE ooha.header_id                 = oola.header_id
                              AND oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND rctl.inventory_item_id         = oola.inventory_item_id
                              AND rctl.line_type                 = 'LINE'
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE1 = to_char(ooha.order_number)
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE6 = to_char(oola.line_id)
                              AND RCTL.INTERFACE_LINE_CONTEXT    = 'ORDER ENTRY'
                              AND rctl.customer_trx_id           = rcta.customer_trx_id
                              AND rcta.bill_to_site_use_id       = hcsu.site_use_id
                              AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                              AND hcas.cust_account_id           = hca.cust_account_id
                              AND hca.party_id                   = hp.party_id 
                              AND ROWNUM = 1) = 'ORDER ENTRY' THEN
                     --
                     (SELECT listagg(hp.party_name,', ' ON OVERFLOW TRUNCATE)  
                         WITHIN GROUP (ORDER BY hp.party_name asc)
                             FROM apps.hz_parties                hp
                                , apps.hz_cust_accounts          hca
                                , apps.oe_order_lines_all        oola
                                , apps.oe_order_headers_all      ooha
                                , apps.ra_customer_trx_lines_all rctl
                                , apps.ra_customer_trx_all       rcta
                                , apps.hz_cust_acct_sites_all    hcas
                                , apps.hz_cust_site_uses_all     hcsu
                            WHERE ooha.header_id                 = oola.header_id
                              AND oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND rctl.inventory_item_id         = oola.inventory_item_id
                              AND rctl.line_type                 = 'LINE'
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE1 = to_char(ooha.order_number)
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE6 = to_char(oola.line_id)
                              AND RCTL.INTERFACE_LINE_CONTEXT    = 'ORDER ENTRY'
                              AND rctl.customer_trx_id           = rcta.customer_trx_id
                              AND rcta.bill_to_site_use_id       = hcsu.site_use_id
                              AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                              AND hcas.cust_account_id           = hca.cust_account_id
                              AND hca.party_id                   = hp.party_id
                              AND ROWNUM = 1)
                     --
                     ELSE
                     --            
                     CASE WHEN 
                          ( SELECT DISTINCT RCTL.INTERFACE_LINE_CONTEXT
                             FROM apps.hz_parties                hp
                                , apps.hz_cust_accounts          hca
                                , apps.oe_order_lines_all        oola
                                , apps.oe_order_headers_all      ooha
                                , apps.ra_customer_trx_lines_all rctl
                                , apps.ra_customer_trx_all       rcta
                                , apps.hz_cust_acct_sites_all    hcas
                                , apps.hz_cust_site_uses_all     hcsu
                            WHERE ooha.header_id                 = oola.header_id
                              AND oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND rctl.inventory_item_id         = oola.inventory_item_id
                              AND rctl.line_type                 = 'LINE'
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE1 = ooha.ORIG_SYS_DOCUMENT_REF
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE7 = oola.ORIG_SYS_LINE_REF
                              AND RCTL.INTERFACE_LINE_CONTEXT    = 'GEMS_PB_RR'
                              AND rctl.customer_trx_id           = rcta.customer_trx_id
                              AND rcta.bill_to_site_use_id       = hcsu.site_use_id
                              AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                              AND hcas.cust_account_id           = hca.cust_account_id
                              AND ROWNUM = 1 ) = 'GEMS_PB_RR' THEN
                     --
                     (SELECT listagg(hp.party_name,', ' ON OVERFLOW TRUNCATE)  
                         WITHIN GROUP (ORDER BY hp.party_name asc)
                             FROM apps.hz_parties                hp
                                , apps.hz_cust_accounts          hca
                                , apps.oe_order_lines_all        oola
                                , apps.oe_order_headers_all      ooha
                                , apps.ra_customer_trx_lines_all rctl
                                , apps.ra_customer_trx_all       rcta
                                , apps.hz_cust_acct_sites_all    hcas
                                , apps.hz_cust_site_uses_all     hcsu
                            WHERE ooha.header_id                 = oola.header_id
                              AND oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND rctl.inventory_item_id         = oola.inventory_item_id
                              AND rctl.line_type                 = 'LINE'
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE1 = ooha.ORIG_SYS_DOCUMENT_REF
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE7 = oola.ORIG_SYS_LINE_REF
                              AND RCTL.INTERFACE_LINE_CONTEXT    = 'GEMS_PB_RR'
                              AND rctl.customer_trx_id           = rcta.customer_trx_id
                              AND rcta.bill_to_site_use_id       = hcsu.site_use_id
                              AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                              AND hcas.cust_account_id           = hca.cust_account_id 
                              AND ROWNUM = 1 )
                     --
                     ELSE
                     --
                     (SELECT listagg(hp.party_name,', ' ON OVERFLOW TRUNCATE)  
                         WITHIN GROUP (ORDER BY hp.party_name asc)
                      FROM   APPS.HZ_CUST_ACCT_SITES_ALL HCAS,
                             apps.hz_parties             hp,
                             apps.hz_cust_accounts       hca,
                             APPS.HZ_CUST_SITE_USES_ALL  HCSU,
                             APPS.OE_ORDER_LINES_ALL     OOLA,
                             APPS.OE_ORDER_HEADERS_ALL   OOHA
                             --
                      WHERE  HCSU.SITE_USE_CODE     = 'BILL_TO'
                      AND    HCSU.CUST_ACCT_SITE_ID = HCAS.CUST_ACCT_SITE_ID
                      AND    HCSU.SITE_USE_ID       = NVL(OOLA.ATTRIBUTE1, OOHA.INVOICE_TO_ORG_ID)
                      AND    OOLA.LINE_ID           = NVL(MMT.TRX_SOURCE_LINE_ID, MMT.SOURCE_LINE_ID)
                      AND    OOHA.HEADER_ID         = OOLA.HEADER_ID
                      AND    hcas.cust_account_id   = hca.cust_account_id
                      AND    hca.party_id           = hp.party_id 
                      AND    ROWNUM = 1)
                     --          
                     END
                  END
               END      bill_to_Customer_name
               --
                , CASE WHEN (mmt.source_code = '3PL_REMITTANCE_BRAZIL') THEN
                      (SELECT listagg(DECODE(hcas.global_attribute2
                                           , '2',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'/'|| hcas.global_attribute4 ||'-'|| hcas.global_attribute5
                                           , '1',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'-'|| hcas.global_attribute5 
                                           , '3',HCSU.LOCATION||' - '||hcas.global_attribute3 ),', ' ON OVERFLOW TRUNCATE)
                       WITHIN GROUP (ORDER BY hcas.global_attribute2 asc )
                         FROM apps.ra_customer_trx_all         rcta
                            , apps.hz_cust_acct_sites_all      hcas
                            , apps.hz_cust_site_uses_all       hcsu
                        WHERE rcta.interface_header_attribute1 = mp.organization_code||'_'||mmt.transaction_reference
                          AND rcta.ship_to_site_use_id         = hcsu.site_use_id
                          AND hcsu.cust_acct_site_id           = hcas.cust_acct_site_id
                          AND rcta.org_id                      = 4330
                          AND ROWNUM = 1)
                   ELSE
                     --
                     CASE WHEN (select DISTINCT RCTL.INTERFACE_LINE_CONTEXT
                             FROM apps.hz_parties                hp
                                , apps.hz_cust_accounts          hca
                                , apps.oe_order_lines_all        oola
                                , apps.oe_order_headers_all      ooha
                                , apps.ra_customer_trx_lines_all rctl
                                , apps.ra_customer_trx_all       rcta
                                , apps.hz_cust_acct_sites_all    hcas
                                , apps.hz_cust_site_uses_all     hcsu
                            WHERE ooha.header_id                 = oola.header_id
                              AND oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND rctl.inventory_item_id         = oola.inventory_item_id
                              AND rctl.line_type                 = 'LINE'
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE1 = to_char(ooha.order_number)
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE6 = to_char(oola.line_id)
                              AND RCTL.INTERFACE_LINE_CONTEXT    = 'ORDER ENTRY'
                              AND rctl.customer_trx_id           = rcta.customer_trx_id
                              AND rcta.ship_to_site_use_id       = hcsu.site_use_id
                              AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                              AND hcas.cust_account_id           = hca.cust_account_id
                              AND hca.party_id                   = hp.party_id 
                              AND ROWNUM = 1) = 'ORDER ENTRY' THEN
                     --
                     (SELECT DISTINCT DECODE(hcas.global_attribute2
                                           , '2',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'/'|| hcas.global_attribute4 ||'-'|| hcas.global_attribute5
                                           , '1',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'-'|| hcas.global_attribute5 
                                           , '3',HCSU.LOCATION||' - '||hcas.global_attribute3)
                             FROM apps.hz_parties                hp
                                , apps.hz_cust_accounts          hca
                                , apps.oe_order_lines_all        oola
                                , apps.oe_order_headers_all      ooha
                                , apps.ra_customer_trx_lines_all rctl
                                , apps.ra_customer_trx_all       rcta
                                , apps.hz_cust_acct_sites_all    hcas
                                , apps.hz_cust_site_uses_all     hcsu
                            WHERE ooha.header_id                 = oola.header_id
                              AND oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND rctl.inventory_item_id         = oola.inventory_item_id
                              AND rctl.line_type                 = 'LINE'
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE1 = to_char(ooha.order_number)
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE6 = to_char(oola.line_id)
                              AND RCTL.INTERFACE_LINE_CONTEXT    = 'ORDER ENTRY'
                              AND rctl.customer_trx_id           = rcta.customer_trx_id
                              AND rcta.ship_to_site_use_id       = hcsu.site_use_id
                              AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                              AND hcas.cust_account_id           = hca.cust_account_id
                              AND hca.party_id                   = hp.party_id
                              AND ROWNUM = 1)
                     --
                     ELSE
                     --            
                     CASE WHEN 
                          ( SELECT DISTINCT RCTL.INTERFACE_LINE_CONTEXT
                             FROM apps.hz_parties                hp
                                , apps.hz_cust_accounts          hca
                                , apps.oe_order_lines_all        oola
                                , apps.oe_order_headers_all      ooha
                                , apps.ra_customer_trx_lines_all rctl
                                , apps.ra_customer_trx_all       rcta
                                , apps.hz_cust_acct_sites_all    hcas
                                , apps.hz_cust_site_uses_all     hcsu
                            WHERE ooha.header_id                 = oola.header_id
                              AND oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND rctl.inventory_item_id         = oola.inventory_item_id
                              AND rctl.line_type                 = 'LINE'
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE1 = ooha.ORIG_SYS_DOCUMENT_REF
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE7 = oola.ORIG_SYS_LINE_REF
                              AND RCTL.INTERFACE_LINE_CONTEXT    = 'GEMS_PB_RR'
                              AND rctl.customer_trx_id           = rcta.customer_trx_id
                              AND rcta.ship_to_site_use_id       = hcsu.site_use_id
                              AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                              AND hcas.cust_account_id           = hca.cust_account_id
                              AND ROWNUM = 1 ) = 'GEMS_PB_RR' THEN
                     --
                     (SELECT DISTINCT DECODE(hcas.global_attribute2
                                           , '2',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'/'|| hcas.global_attribute4 ||'-'|| hcas.global_attribute5
                                           , '1',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'-'|| hcas.global_attribute5 
                                           , '3',HCSU.LOCATION||' - '||hcas.global_attribute3)
                             FROM apps.hz_parties                hp
                                , apps.hz_cust_accounts          hca
                                , apps.oe_order_lines_all        oola
                                , apps.oe_order_headers_all      ooha
                                , apps.ra_customer_trx_lines_all rctl
                                , apps.ra_customer_trx_all       rcta
                                , apps.hz_cust_acct_sites_all    hcas
                                , apps.hz_cust_site_uses_all     hcsu
                            WHERE ooha.header_id                 = oola.header_id
                              AND oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND rctl.inventory_item_id         = oola.inventory_item_id
                              AND rctl.line_type                 = 'LINE'
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE1 = ooha.ORIG_SYS_DOCUMENT_REF
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE7 = oola.ORIG_SYS_LINE_REF
                              AND RCTL.INTERFACE_LINE_CONTEXT    = 'GEMS_PB_RR'
                              AND rctl.customer_trx_id           = rcta.customer_trx_id
                              AND rcta.ship_to_site_use_id       = hcsu.site_use_id
                              AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                              AND hcas.cust_account_id           = hca.cust_account_id 
                              AND ROWNUM = 1 )
                     --
                     ELSE
                     --
                     (SELECT listagg(DECODE(hcas.global_attribute2
                                           , '2',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'/'|| hcas.global_attribute4 ||'-'|| hcas.global_attribute5
                                           , '1',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'-'|| hcas.global_attribute5 
                                           , '3',HCSU.LOCATION||' - '||hcas.global_attribute3 ),', ' ON OVERFLOW TRUNCATE)
                      WITHIN GROUP (ORDER BY hcas.global_attribute2 asc) 
                         FROM apps.hz_parties             hp
                            , apps.hz_cust_accounts       hca
                            , apps.oe_order_lines_all     oola
                            , apps.hz_cust_acct_sites_all hcas
                            , apps.hz_cust_site_uses_all  hcsu
                        WHERE oola.line_id                = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                          AND oola.ship_to_org_id         = hcsu.site_use_id
                          AND hcsu.cust_acct_site_id      = hcas.cust_acct_site_id
                          AND hcas.cust_account_id        = hca.cust_account_id
                          AND hca.party_id                = hp.party_id  )
                     --
                     END
                  END
               END      ship_to_CNPJ_CPF
               --
              , CASE WHEN ( SELECT ottl.name
                              FROM apps.oe_transaction_types_tl    ottl
                                 , apps.oe_order_headers_all  ooha
                                 , apps.oe_order_lines_all    oola  
                             WHERE oola.line_id        = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                               AND oola.header_id      = ooha.header_id
                               AND ooha.order_type_id  = ottl.transaction_type_id  ) = 'GPO_BR_FE_SHIPMENT' THEN
                      (SELECT listagg(hzl.address1 ||' - '|| hzl.address2 || ' - ' || hzl.city || '-' || hzl.state || ' / ' || hzl.postal_code,', ' ON OVERFLOW TRUNCATE)  
                       WITHIN GROUP (ORDER BY hzl.address1 asc)
                       FROM apps.hz_parties             hp
                        , apps.hz_party_sites         hps
                        , apps.hz_cust_accounts       hca
                        , apps.oe_order_lines_all     oola
                        , apps.hz_cust_acct_sites_all hcas
                        , apps.hz_cust_site_uses_all  hcsu
                        , apps.hz_locations           hzl
                    WHERE oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                      AND oola.end_customer_site_use_id  = hcsu.site_use_id
                      AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                      AND hcas.cust_account_id           = hca.cust_account_id
                      AND hcas.party_site_id             = hps.party_site_id
                      AND hca.party_id                   = hp.party_id
                      AND hps.party_id                   = hp.party_id
                      AND hps.location_id                = hzl.location_id)
                ELSE
                   CASE WHEN (mmt.source_code = '3PL_REMITTANCE_BRAZIL') THEN
                      (SELECT listagg(hzl.address1 ||' - '|| hzl.address2 || ' - ' || hzl.city || '-' || hzl.state || ' / ' || hzl.postal_code,', ' ON OVERFLOW TRUNCATE)  
                       WITHIN GROUP (ORDER BY hzl.address1 asc)
                         FROM apps.ra_customer_trx_all     rcta
                            , apps.hz_cust_acct_sites_all  hcas
                            , apps.hz_cust_site_uses_all   hcsu
                            , apps.hz_parties              hp
                            , apps.hz_party_sites          hps
                            , apps.hz_cust_accounts        hca
                            , apps.hz_locations            hzl
                        WHERE rcta.interface_header_attribute1 = mp.organization_code||'_'||mmt.transaction_reference
                          AND rcta.ship_to_site_use_id         = hcsu.site_use_id
                          AND hcsu.cust_acct_site_id           = hcas.cust_acct_site_id
                          AND hcas.cust_account_id             = hca.cust_account_id
                          AND hcas.party_site_id               = hps.party_site_id
                          AND hca.party_id                     = hp.party_id
                          AND hps.party_id                     = hp.party_id
                          AND hps.location_id                  = hzl.location_id
                          AND rcta.org_id                      = 4330)
                   ELSE
                      (SELECT listagg(hzl.address1 ||' - '|| hzl.address2 || ' - ' || hzl.city || '-' || hzl.state || ' / ' || hzl.postal_code,', ' ON OVERFLOW TRUNCATE)  
                       WITHIN GROUP (ORDER BY hzl.address1 asc)
                          FROM apps.hz_parties             hp
                             , apps.hz_party_sites         hps
                             , apps.hz_cust_accounts       hca
                             , apps.oe_order_lines_all     oola
                             , apps.hz_cust_acct_sites_all hcas
                             , apps.hz_cust_site_uses_all  hcsu
                             , apps.hz_locations           hzl
                         WHERE oola.line_id                = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                           AND oola.ship_to_org_id         = hcsu.site_use_id
                           AND hcsu.cust_acct_site_id      = hcas.cust_acct_site_id
                           AND hcas.cust_account_id        = hca.cust_account_id
                           AND hcas.party_site_id          = hps.party_site_id
                           AND hca.party_id                = hp.party_id
                           AND hps.party_id                = hp.party_id
                           AND hps.location_id             = hzl.location_id   )
                   END
                END customer_address
                -- 
                -- alterado para BIll_to por Sinval fim
                --
              , CASE WHEN (mmt.source_code = '3PL_REMITTANCE_BRAZIL') THEN
                    (SELECT distinct RTRIM(REGEXP_REPLACE((listagg(rcta.trx_number,', ' ON OVERFLOW TRUNCATE)  
                     WITHIN GROUP (ORDER BY rcta.trx_number asc) ), '([^,]*)(,\1)+($|,)', '\1\3'),',')
                       FROM apps.ra_customer_trx_all       rcta
                      WHERE rcta.interface_header_attribute1  = mp.organization_code||'_'||mmt.transaction_reference
                        AND rcta.org_id                       = 4330
                        AND trunc(rcta.trx_date)              BETWEEN (trunc(mmt.transaction_date)-3) AND (trunc(mmt.transaction_date)+3)
                        AND NVL(rcta.status_trx,'XX')         <> 'VD'
                        AND NVL(rcta.reason_code,'XX')        <> 'CANCELLATION')
                ELSE
                    (SELECT distinct RTRIM(REGEXP_REPLACE((listagg(rcta.trx_number,', ' ON OVERFLOW TRUNCATE)  
                     WITHIN GROUP (ORDER BY rcta.trx_number asc) ), '([^,]*)(,\1)+($|,)', '\1\3'),',')
                       FROM apps.ra_customer_trx_lines_all rctla
                          , apps.ra_customer_trx_all       rcta
                          , apps.oe_order_lines_all        oola
                          , apps.oe_order_headers_all      ooha
                      WHERE rcta.customer_trx_id              = rctla.customer_trx_id
                        AND oola.line_id                      = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                        AND oola.header_id                    = ooha.header_id
                        AND rctla.sales_order                 = to_char(ooha.order_number)
                        AND rctla.line_type                   = 'LINE'
                        AND rcta.batch_source_id              <> 6266 -- No RR invoices
                        AND DECODE(rctla.interface_line_context,'GEMS_PB_RR',rcta.interface_header_attribute11,'999')
                            = DECODE(rctla.interface_line_context,'GEMS_PB_RR',rcta.interface_header_attribute11,'999')
                        AND rcta.org_id                       = 4330
                        AND trunc(rcta.trx_date)              BETWEEN (trunc(mmt.transaction_date)-3) AND (trunc(mmt.transaction_date)+3)
                        AND NVL(rcta.status_trx,'XX')         <> 'VD'
                        AND NVL(rcta.reason_code,'XX')        <> 'CANCELLATION')   
                END   invoice_number_ar
              , ( SELECT listagg(mrav.reservation_quantity,', ' ON OVERFLOW TRUNCATE)  
                  WITHIN GROUP (ORDER BY mrav.reservation_quantity asc)
                    FROM apps.mtl_reservations_all_v  mrav 
                       , apps.oe_order_headers_all    ooha1
                   WHERE mrav.demand_source_header_id     = ooha1.header_id
                     AND mrav.demand_source_line_id       = NVL(mmt.trx_source_line_id, mmt.source_line_id) )  reservation_quantity
              , ( SELECT listagg(ooha1.order_number,', ' ON OVERFLOW TRUNCATE)  
                  WITHIN GROUP (ORDER BY ooha1.order_number asc) 
                    FROM apps.mtl_reservations_all_v  mrav 
                       , apps.oe_order_headers_all    ooha1
                   WHERE mrav.demand_source_header_id     = ooha1.header_id
                     AND mrav.demand_source_line_id       = NVL(mmt.trx_source_line_id, mmt.source_line_id) )  reservation_order_number
              , (SELECT distinct hp.party_name
                 --WITHIN GROUP (ORDER BY hp.party_name asc)
                   FROM apps.hz_parties              hp
                      , apps.hz_cust_accounts        hca
                      , apps.oe_order_lines_all      oola1
                      , apps.oe_order_headers_all    ooha1
                      , apps.mtl_reservations_all_v  mrav 
                  WHERE mrav.demand_source_header_id   = ooha1.header_id
                    AND mrav.demand_source_line_id     = oola1.line_id
                    AND oola1.line_id                  = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                    AND oola1.ship_to_org_id           = hca.cust_account_id
                    AND hca.party_id                   = hp.party_id )         reservation_customer_name 
              , gcc1.concatenated_segments   material_account
              , gcc2.concatenated_segments   outside_processing_account
              , gcc3.concatenated_segments   material_overhead_account
              , gcc4.concatenated_segments   overhead_account
              , gcc5.concatenated_segments   resource_account
              , sysdate                                           report_date_and_time 
              , to_char(msn.last_transaction_id)                  transaction_id
              , fu.user_name ||' / '|| fu.description             user_name
              , DECODE( lot_control_code, 1 ,'Sem controle de Lote' , 2,'Com controle de Lote')   lot_control
              , DECODE( serial_number_control_code, 1, 'Sem controle de Serial'
                                                  , 2, 'Pre-definido'
                                                  , 5, 'No Recebimento'
                                                  , 6, 'Baixa na Ordem de Venda' )  serial_control
              , CASE
                 WHEN    nvl(mmt.lpn_id, mmt.content_lpn_id) IS NULL AND moq.subinventory_code <> 'WHGU42GNAT'
                   THEN 
                     (SELECT listagg(lpn.license_plate_number,', ' ON OVERFLOW TRUNCATE)WITHIN GROUP (ORDER BY lpn.license_plate_number asc)
                             FROM apps.MTL_MATERIAL_TRANSACTIONS   mtt,
                                  apps.wms_license_plate_numbers   lpn,
                                  apps.oe_order_lines_all          ool
                            WHERE 1 = 1
                              AND mtt.TRX_SOURCE_LINE_ID = CASE
                                                              WHEN LINE_CATEGORY_CODE = 'ORDER'
                                                                THEN ool.line_id
                                                              WHEN LINE_CATEGORY_CODE = 'RETURN'  
                                                                THEN   
                                                                to_number(NVL(SUBSTR(ool.ORIG_SYS_LINE_REF,
                                                                                     0,
                                                                                     INSTR(ool.ORIG_SYS_LINE_REF, '.') - 1),
                                                                              -1)) -- RMA FE OE Line Id
                                                                ELSE -1
                                                                  END
                              AND mtt.TRANSACTION_TYPE_ID = 52 --sales order pick FE ORDER
                              AND mtt.transaction_quantity < 0
                              AND mtt.inventory_item_id = ool.inventory_item_id
                              AND nvl(mtt.lpn_id, mtt.content_lpn_id) = nvl(lpn.lpn_id, -1)
                              AND ool.line_id = CASE
                                                  WHEN mtt.transaction_type_name = 'RMA Receipt'
                                                    THEN mmt.TRX_SOURCE_LINE_ID
                                                  WHEN mtt.transaction_type_name = 'GPO Nationalization Receipt'
                                                     THEN 
                                                      to_number(NVL(SUBSTR(RTRIM(LTRIM(translate(mmt.TRANSACTION_REFERENCE,translate(mmt.TRANSACTION_REFERENCE||'a','1234567890.',' '),' '))),
                                                         0,
                                                         INSTR(RTRIM(LTRIM(translate(mmt.TRANSACTION_REFERENCE,translate(mmt.TRANSACTION_REFERENCE||'a','1234567890.',' '),' '))), '.') - 1),
                                                  -1))
                                                  ELSE -1
                                                    END)
                              WHEN moq.subinventory_code = 'WHGU42GNAT'
                  THEN (SELECT listagg(wlp.license_plate_number,', ' ON OVERFLOW TRUNCATE)  
                            WITHIN GROUP (ORDER BY wlp.license_plate_number asc)
                        FROM   gems_ont.ge_gpo_nationalization_line gnl, 
                               gems_ont.ge_gpo_nationalization_line gn2,
                               apps.wms_license_plate_numbers       wlp,
                               apps.po_line_locations_all           pll,
                               apps.po_lines_all                    pol,
                               apps.po_headers_all                  poh,
                               apps.rcv_shipment_headers            rsh,
                               apps.rcv_transactions                rt
                        Where  wlp.lpn_id(+) = gn2.lpn_id
                        AND gnl.nationalization_so_line_id = gn2.nationalization_so_line_id
                        AND pll.line_location_id = gnl.DOCUMENT_ID
                        AND pll.po_header_id = poh.po_header_id
                        AND pll.po_line_id = pol.po_line_id
                        AND gn2.record_type = 'IMPORT'
                        AND gnl.record_type = 'NATIONALIZATION'
                        AND rt.transaction_id                = mmt.rcv_transaction_id
                        AND rt.po_line_location_id           = pll.line_location_id
                        AND rt.shipment_header_id            = rsh.shipment_header_id)
                  ELSE 
                          (SELECT lpn.LICENSE_PLATE_NUMBER
                           FROM   apps.wms_license_plate_numbers   lpn
                           WHERE  nvl(mmt.lpn_id, mmt.content_lpn_id) = nvl(lpn.lpn_id, -1))
                        END LPN_Value                                   
              , 'q2' query
--, mmt.transaction_type_id
--, mmt.trx_source_line_id
--, mmt.source_line_id
           FROM apps.mtl_serial_numbers              msn  
              , apps.mtl_parameters                  mp
              , apps.mtl_system_items_b              msi
              , apps.mtl_item_locations_kfv          milk
              , apps.gl_code_combinations            gcc
              , apps.gl_code_combinations_kfv        gcc1
              , apps.gl_code_combinations_kfv        gcc2
              , apps.gl_code_combinations_kfv        gcc3
              , apps.gl_code_combinations_kfv        gcc4
              , apps.gl_code_combinations_kfv        gcc5
              , AMARCHIVE.MTL_MATERIAL_TRANSACTIONS  mmt
              , apps.mtl_transaction_types           mtt
              , apps.mtl_txn_source_types            mtst
              , apps.mtl_secondary_inventories_fk_v  msifv
              , apps.fnd_flex_values_vl              ffvv
              , apps.fnd_flex_value_sets             ffvs
              , apps.fnd_user                        fu
              , ( SELECT organization_id
                       , inventory_item_id
                       , subinventory_code
                       , locator_id
                       , lot_number
                       --, update_transaction_id
                       --, transaction_uom_code
                       , SUM (primary_transaction_quantity)  onhand_qty
                    FROM apps.mtl_onhand_quantities_detail
                   WHERE organization_id IN ( SELECT ood.ORGANIZATION_id FROM apps.org_organization_definitions ood WHERE ood.SET_OF_BOOKS_ID = 230 )
                GROUP BY organization_id
                       , inventory_item_id
                       , subinventory_code
                       , locator_id
                     --  , revision
                       , lot_number
                       --, update_transaction_id
                       --, transaction_uom_code
                       ) moq
               ,APPS.MTL_PAC_ACTUAL_COST_DETAILS MPACD        
          WHERE 1                                = 1
          AND decode(mmt.periodic_primary_quantity,null,mmt.transfer_transaction_id,MMT.TRANSACTION_ID) = MPACD.TRANSACTION_ID  
            AND mp.organization_id               = msi.organization_id
            AND msifv.organization_id            = msi.organization_id
--            AND msi.segment1 = '60510302'
            AND msifv.secondary_inventory_name   = moq.subinventory_code
            AND msifv.material_account           = gcc1.code_combination_id
            AND msifv.outside_processing_account = gcc2.code_combination_id
            AND msifv.material_overhead_account  = gcc3.code_combination_id
            AND msifv.overhead_account           = gcc4.code_combination_id
            AND msifv.resource_account           = gcc5.code_combination_id
            AND msi.cost_of_sales_account        = gcc.code_combination_id
            AND ffvs.flex_value_set_name         = 'GE_GL_AFF_ES_PRODUCT_LINE'
            AND ffvs.flex_value_set_id           = ffvv.flex_value_set_id
            AND ffvv.flex_value_meaning          = gcc.segment8
            AND 'TYPE 1'                        IN ('TYPE 1')
            AND msi.organization_id             IN ( SELECT ood.organization_id FROM apps.org_organization_definitions ood WHERE ood.SET_OF_BOOKS_ID = 230 )
            AND moq.inventory_item_id            = msn.inventory_item_id         (+) --mmt.inventory_item_id (+)   
            AND moq.organization_id              = msn.current_organization_id   (+) --mmt.organization_id   (+)   
            AND moq.subinventory_code            = msn.current_subinventory_code (+) --mmt.subinventory_code (+)   
            AND moq.locator_id                   = msn.current_locator_id        (+) --mmt.locator_id        (+)   
            AND msn.current_status           (+) = 3                 
            AND moq.lot_number                   = msn.lot_number (+)
            AND moq.inventory_item_id            = msi.inventory_item_id
            AND moq.locator_id                   = milk.inventory_location_id
            AND moq.organization_id              = mp.organization_id
            AND msn.last_transaction_id          = mmt.transaction_id  
--    AND MMT.TRANSACTION_ID = 2562828197
            AND mtt.transaction_type_id          = mmt.transaction_type_id 
            AND mtst.transaction_source_type_id  = mmt.transaction_source_type_id
            AND fu.user_id                       = mmt.created_by
    AND MMT.TRANSACTION_ID NOT IN(SELECT MMT2.TRANSACTION_ID 
                                  FROM APPS.MTL_MATERIAL_TRANSACTIONS MMT2
                                  WHERE MMT2.TRANSACTION_ID = MMT.TRANSACTION_ID)
------------------------------------------------------------------------------
UNION
------------------------------------------------------------------------------  
-- Com Controle de Lote e Serial Nulo
         SELECT DISTINCT  --'3' NUM
        /* ( SELECT ccg.cost_group 
                             FROM apps.cst_cost_groups            ccg
                                , apps.cst_cost_group_assignments ccga
                            WHERE ccga.cost_group_id     = ccg.cost_group_id
                              AND ccga.organization_id   = mp.organization_id )  cost_group*/
            ( SELECT ccg.cost_group 
                             FROM apps.cst_cost_groups            ccg
                            WHERE MPACD.cost_group_id     = ccg.cost_group_id )  cost_group  
              , ( SELECT ( SELECT cpp1.period_name 
                             FROM apps.cst_pac_item_costs   cst
                                , apps.cst_pac_periods      cpp1
                            WHERE cst.pac_period_id     = (SELECT MAX(PAC_PERIOD_ID)                   FROM APPS.CST_PAC_PERIODS                  WHERE LEGAL_ENTITY = (SELECT LEGAL_ENTITY                                          FROM APPS.ORG_ORGANIZATION_DEFINITIONS OOD                                         WHERE OOD.ORGANIZATION_ID = mp.organization_id                                         ) )
                              AND cst.pac_period_id     = cpp1.pac_period_id
                              AND cst.inventory_item_id = msi.inventory_item_id
                              AND cst.cost_group_id     = ccg.cost_group_id )  
                    FROM apps.cst_cost_groups            ccg
                       , apps.cst_cost_group_assignments ccga
                   WHERE ccga.cost_group_id     = ccg.cost_group_id
                     AND ccga.organization_id   = mp.organization_id ) period_name
              , mp.organization_code
              , mp.attribute7                organization_type
              , mp.organization_id 
              , moq.subinventory_code
              , msifv.description            subinv_description
              , milk.concatenated_segments   locators
              , DECODE( msifv.asset_inventory, 1 , 'Asset', 2, 'Non Asset')   asset_type
              , msi.segment1                 part_number
              ,DECODE(msi.inventory_asset_flag, NULL, 'No', 'N', 'No', 'Y', 'Yes')                         flag_asset_inventory
              ,DECODE(msi.costing_enabled_flag, NULL, 'No', 'N', 'No', 'Y', 'Yes')                         flag_de_custo
              , msi.description              descrip_eng
              , msi.attribute3               descrip_ptb
              , msi.creation_date            item_creation_date
              , (trunc(SYSDATE) - trunc(msi.creation_date))      days_from_creation
              , gcc.segment8                                     product_line
              , ffvv.description                                 desc_prod_line
              , msi.primary_uom_code   uom
              , moq.onhand_qty  transaction_quantity --DECODE (msi.serial_number_control_code, 1, moq.onhand_qty, 1 ) transaction_quantity
              , NVL(( SELECT cic.item_cost
                        FROM apps.cst_item_costs cic
                       WHERE cic.organization_id   = msi.organization_id
                         AND cic.inventory_item_id = msi.inventory_item_id
                         AND cic.cost_type_id      = 1 ),0)  custo_unit_inv
              /*, nvl(( SELECT ( SELECT ROUND (cst.item_cost,2) 
                                 FROM apps.cst_pac_item_costs   cst
                                WHERE cst.pac_period_id     = (SELECT MAX(PAC_PERIOD_ID)                   FROM APPS.CST_PAC_PERIODS                  WHERE LEGAL_ENTITY = (SELECT LEGAL_ENTITY                                          FROM APPS.ORG_ORGANIZATION_DEFINITIONS OOD                                         WHERE OOD.ORGANIZATION_ID = mp.organization_id                                         ) )
                                  AND cst.inventory_item_id = msi.inventory_item_id
                                  AND cst.cost_group_id     = ccg.cost_group_id )  item_cost
                        FROM apps.cst_cost_groups            ccg
                           , apps.cst_cost_group_assignments ccga
                       WHERE ccga.cost_group_id     = ccg.cost_group_id
                         AND ccga.organization_id   = mp.organization_id ) ,0) custo_unit_pac*/
                , nvl((SELECT ROUND (cst.item_cost,2) 
                       FROM apps.cst_pac_item_costs   cst
                      WHERE cst.pac_period_id     = (SELECT MAX(PAC_PERIOD_ID)                   
                                                                FROM APPS.CST_PAC_PERIODS                  
                                                                WHERE LEGAL_ENTITY = (SELECT LEGAL_ENTITY                                         
                                                                                        FROM APPS.ORG_ORGANIZATION_DEFINITIONS OOD                                        
                                                                                        WHERE OOD.ORGANIZATION_ID = mp.organization_id
                                                        ) )
                        AND cst.inventory_item_id = msi.inventory_item_id
                        AND cst.cost_group_id     = MPACD.cost_group_id) ,0)  custo_unit_pac
              , moq.lot_number
              , ( SELECT mln.creation_date         
                    FROM apps.mtl_lot_numbers              mln
                   WHERE mln.lot_number           = moq.lot_number 
                     AND mln.inventory_item_id    = msi.inventory_item_id
                     AND mln.organization_id      = mp.organization_id  )  lot_creation_date
              , NULL   lot_qty_days_creation
              , ( SELECT mln.expiration_date         
                    FROM apps.mtl_lot_numbers              mln
                   WHERE mln.lot_number           = moq.lot_number
                     AND mln.inventory_item_id    = msi.inventory_item_id
                     AND mln.organization_id      = mp.organization_id  )  lot_expiration_date
              , NULL    serial_number 
              , NULL    serial_creation_date
              , mtt.transaction_type_name            last_transaction_type
              , mmt.transaction_source_name          last_transaction_source
              , mtst.transaction_source_type_name    last_source_type
              , mmt.source_code
              , TO_CHAR(mmt.transaction_date, 'DD-MON-RRRR')    transaction_date 
        , (SELECT TO_CHAR(mmt1.transaction_date, 'DD-MON-RRRR') 
                        FROM apps.mtl_material_transactions mmt1
                        WHERE mmt1.transaction_type_id=420
                        AND mmt1.source_line_id=mmt.source_line_id) initial_consignment_date
              , (TRUNC(SYSDATE) - TRUNC(mmt.transaction_date))  transaction_qty_of_days
              , TO_CHAR(mmt.transaction_reference)              transaction_reference
              , CASE WHEN mmt.source_code = '3PL_REMITTANCE_BRAZIL' THEN
                     (SELECT listagg(pha.segment1,', ' ON OVERFLOW TRUNCATE)  
                      WITHIN GROUP (ORDER BY pha.segment1 asc)
                        FROM apps.po_headers_all        pha
                           , apps.po_lines_all          pla
                       WHERE pla.po_line_id   = mmt.source_line_id
                         AND pla.po_header_id = pha.po_header_id)
                     WHEN mmt.source_code IN ('ORDER ENTRY','IIP') THEN
                        NULL
                     WHEN mmt.source_code = 'RCV' THEN
                        ( SELECT listagg(pha.segment1,', ' ON OVERFLOW TRUNCATE)  
                          WITHIN GROUP (ORDER BY pha.segment1 asc)
                            FROM apps.po_headers_all            pha
                               , apps.po_lines_all              pla
                               , apps.po_line_locations_all     plla
                               , apps.rcv_shipment_headers      rsh
                               , apps.rcv_transactions          rt
                           WHERE rt.transaction_id                = mmt.rcv_transaction_id
                             AND rt.po_line_location_id           = plla.line_location_id
                             AND plla.po_line_id                  = pla.po_line_id
                             AND pha.po_header_id                 = pla.po_header_id
                             AND rt.shipment_header_id            = rsh.shipment_header_id
                             AND rsh.receipt_source_code          = 'VENDOR'  )
                     ELSE
                        NULL
                END      po_number
              , CASE WHEN mmt.source_code = '3PL_REMITTANCE_BRAZIL' THEN
                     (SELECT listagg(aps.vendor_name,', ' ON OVERFLOW TRUNCATE)  
                      WITHIN GROUP (ORDER BY aps.vendor_name asc)
                        FROM apps.po_headers_all        pha
                           , apps.po_lines_all          pla
                           , apps.ap_suppliers          aps
                           , apps.ap_supplier_sites_all apss
                       WHERE pla.po_line_id     = mmt.source_line_id
                         AND pla.po_header_id   = pha.po_header_id
                         AND pha.vendor_id      = aps.vendor_id
                         AND aps.vendor_id      = apss.vendor_id
                         AND pha.vendor_site_id = apss.vendor_site_id )
                     WHEN mmt.source_code IN ('ORDER ENTRY','IIP') THEN
                        NULL
                     WHEN mmt.source_code = 'RCV' THEN
                        ( SELECT listagg(aps.vendor_name,', ' ON OVERFLOW TRUNCATE)  
                          WITHIN GROUP (ORDER BY aps.vendor_name asc)
                            FROM apps.po_headers_all            pha
                               , apps.po_lines_all              pla
                               , apps.po_line_locations_all     plla
                               , apps.rcv_shipment_headers      rsh
                               , apps.rcv_transactions          rt
                               , apps.ap_suppliers              aps
                               , apps.ap_supplier_sites_all     apss
                           WHERE rt.transaction_id          = mmt.rcv_transaction_id
                             AND rt.po_line_location_id     = plla.line_location_id
                             AND plla.po_line_id            = pla.po_line_id
                             AND pha.po_header_id           = pla.po_header_id
                             AND rt.shipment_header_id      = rsh.shipment_header_id
                             AND rsh.receipt_source_code    = 'VENDOR'
                             AND pha.vendor_id              = aps.vendor_id
                             AND aps.vendor_id              = apss.vendor_id
                             AND pha.vendor_site_id         = apss.vendor_site_id  )
                     ELSE
                        NULL
                END    po_supplier
              , CASE WHEN mmt.source_code = '3PL_REMITTANCE_BRAZIL' THEN
                     ( SELECT listagg(cfi.invoice_num,', ' ON OVERFLOW TRUNCATE)  
                         WITHIN GROUP (ORDER BY cfi.invoice_num asc)
                         FROM apps.cll_f189_invoice_lines cfil
                            , apps.cll_f189_invoices      cfi
                            , apps.po_lines_all           pla
                            , apps.po_line_locations_all  plla
                        WHERE plla.po_line_id       = pla.po_line_id
                          AND pla.po_line_id        = mmt.source_line_id
                          AND plla.line_location_id = cfil.line_location_id
                          AND cfil.invoice_id       = cfi.invoice_id )
                     WHEN mmt.source_code IN ('ORDER ENTRY','IIP') THEN
                        NULL
                     WHEN mmt.source_code = 'RCV' THEN
                        ( SELECT listagg(cfi.invoice_num,', ' ON OVERFLOW TRUNCATE)  
                            WITHIN GROUP (ORDER BY cfi.invoice_num asc)
                            FROM apps.po_headers_all            pha
                               , apps.po_lines_all              pla
                               , apps.po_line_locations_all     plla
                               , apps.cll_f189_invoice_lines    cfil
                               , apps.cll_f189_invoices         cfi
                               , apps.rcv_shipment_headers      rsh
                               , apps.rcv_transactions          rt
                           WHERE rt.transaction_id          = mmt.rcv_transaction_id
                             AND rt.po_line_location_id     = plla.line_location_id
                             AND plla.line_location_id      = cfil.line_location_id
                             AND cfil.invoice_id            = cfi.invoice_id
                             AND plla.po_line_id            = pla.po_line_id
                             AND pha.po_header_id           = pla.po_header_id
                             AND rt.shipment_header_id      = rsh.shipment_header_id
                             AND rsh.receipt_source_code    = 'VENDOR'   )
                     ELSE
                        NULL
                END    NF_RI
              , (SELECT DECODE( mmt.source_code, '3PL_REMITTANCE_BRAZIL',NULL,to_char(ooha.order_number) )
                   FROM apps.oe_order_headers_all  ooha
                      , apps.oe_order_lines_all    oola  
                  WHERE oola.line_id        = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                    AND oola.header_id      = ooha.header_id )   order_number
               -- 
               -- alterado para BIll_to por Sinval inicio
               --
               , CASE WHEN ( SELECT ottl.name
                             FROM apps.oe_transaction_types_tl    ottl
                                , apps.oe_order_headers_all  ooha
                                , apps.oe_order_lines_all    oola  
                            WHERE oola.line_id        = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND oola.header_id      = ooha.header_id
                              AND ooha.order_type_id  = ottl.transaction_type_id  ) = 'GPO_BR_FE_SHIPMENT' THEN
                     (SELECT listagg(hp.party_name,', ' ON OVERFLOW TRUNCATE)  
                      WITHIN GROUP (ORDER BY hp.party_name asc)
                        FROM apps.hz_parties             hp
                           , apps.hz_cust_accounts       hca
                           , apps.oe_order_lines_all     oola
                           , apps.hz_cust_acct_sites_all hcas
                           , apps.hz_cust_site_uses_all  hcsu
                       WHERE oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                         AND oola.end_customer_site_use_id  = hcsu.site_use_id
                         AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                         AND hcas.cust_account_id           = hca.cust_account_id
                         AND hca.party_id                   = hp.party_id )
                  ELSE
                     CASE WHEN (mmt.source_code = '3PL_REMITTANCE_BRAZIL') THEN
                       (SELECT listagg(hp.party_name,', ' ON OVERFLOW TRUNCATE)  
                        WITHIN GROUP (ORDER BY hp.party_name asc)
                          FROM apps.hz_parties             hp,
                               apps.hz_cust_accounts       hca,
                               apps.ra_customer_trx_all    rcta,
                               apps.hz_cust_acct_sites_all hcas,
                               apps.hz_cust_site_uses_all  hcsu
                         WHERE rcta.interface_header_attribute1 = mp.organization_code||'_'||mmt.transaction_reference
                           AND rcta.ship_to_site_use_id         = hcsu.site_use_id
                           AND hcsu.cust_acct_site_id           = hcas.cust_acct_site_id
                           AND hcas.cust_account_id             = hca.cust_account_id
                           AND hca.party_id                     = hp.party_id
                           AND rcta.org_id                      = 4330)
                     ELSE
                        (SELECT listagg(hp.party_name,', ' ON OVERFLOW TRUNCATE)  
                         WITHIN GROUP (ORDER BY hp.party_name asc)
                           FROM apps.hz_parties             hp
                              , apps.hz_cust_accounts       hca
                              , apps.oe_order_lines_all     oola
                              , apps.hz_cust_acct_sites_all hcas
                              , apps.hz_cust_site_uses_all  hcsu
                          WHERE oola.line_id                = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                            AND oola.ship_to_org_id         = hcsu.site_use_id
                            AND hcsu.cust_acct_site_id      = hcas.cust_acct_site_id
                            AND hcas.cust_account_id        = hca.cust_account_id
                            AND hca.party_id                = hp.party_id )
                    END                 
               END    customer_name
             , CASE WHEN ( SELECT ottl.name
                             FROM apps.oe_transaction_types_tl    ottl
                                , apps.oe_order_headers_all  ooha
                                , apps.oe_order_lines_all    oola  
                            WHERE oola.line_id        = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND oola.header_id      = ooha.header_id
                              AND ooha.order_type_id  = ottl.transaction_type_id  ) = 'GPO_BR_FE_SHIPMENT' THEN
                     (SELECT listagg(hca.account_number,', ' ON OVERFLOW TRUNCATE)  
                      WITHIN GROUP (ORDER BY hca.account_number asc)
                        FROM apps.hz_parties             hp
                           , apps.hz_cust_accounts       hca
                           , apps.oe_order_lines_all     oola
                           , apps.hz_cust_acct_sites_all hcas
                           , apps.hz_cust_site_uses_all  hcsu
                       WHERE oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                         AND oola.end_customer_site_use_id  = hcsu.site_use_id
                         AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                         AND hcas.cust_account_id           = hca.cust_account_id
                         AND hca.party_id                   = hp.party_id )
                  ELSE
                     CASE WHEN (mmt.source_code = '3PL_REMITTANCE_BRAZIL') THEN
                        (SELECT listagg(hca.account_number,', ' ON OVERFLOW TRUNCATE)  
                         WITHIN GROUP (ORDER BY hca.account_number asc)
                           FROM apps.hz_parties             hp,
                                apps.hz_cust_accounts       hca,
                                apps.ra_customer_trx_all    rcta,
                                apps.hz_cust_acct_sites_all hcas,
                                apps.hz_cust_site_uses_all  hcsu
                          WHERE rcta.interface_header_attribute1 = mp.organization_code||'_'||mmt.transaction_reference
                            AND rcta.ship_to_site_use_id         = hcsu.site_use_id
                            AND hcsu.cust_acct_site_id           = hcas.cust_acct_site_id
                            AND hcas.cust_account_id             = hca.cust_account_id
                            AND hca.party_id                     = hp.party_id
                            AND rcta.org_id                      = 4330)
                     ELSE
                        (SELECT listagg(hca.account_number,', ' ON OVERFLOW TRUNCATE)  
                         WITHIN GROUP (ORDER BY hca.account_number asc)
                           FROM apps.hz_parties             hp
                              , apps.hz_cust_accounts       hca
                              , apps.oe_order_lines_all     oola
                              , apps.hz_cust_acct_sites_all hcas
                              , apps.hz_cust_site_uses_all  hcsu
                          WHERE oola.line_id                = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                            AND oola.ship_to_org_id         = hcsu.site_use_id
                            AND hcsu.cust_acct_site_id      = hcas.cust_acct_site_id
                            AND hcas.cust_account_id        = hca.cust_account_id
                            AND hca.party_id                = hp.party_id   )
                     END
                  END   customer_number
              --
              , CASE WHEN ( SELECT ottl.name
                             FROM apps.oe_transaction_types_tl    ottl
                                , apps.oe_order_headers_all  ooha
                                , apps.oe_order_lines_all    oola  
                            WHERE oola.line_id        = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND oola.header_id      = ooha.header_id
                              AND ooha.order_type_id  = ottl.transaction_type_id  ) = 'GPO_BR_FE_SHIPMENT' THEN
                     (SELECT listagg(DECODE(hcas.global_attribute2
                                           , '2',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'/'|| hcas.global_attribute4 ||'-'|| hcas.global_attribute5
                                           , '1',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'-'|| hcas.global_attribute5 
                                           , '3',HCSU.LOCATION||' - '||hcas.global_attribute3 ),', ' ON OVERFLOW TRUNCATE)
                     WITHIN GROUP (ORDER BY hcas.global_attribute2 asc ) 
                        FROM apps.hz_parties             hp
                           , apps.hz_cust_accounts       hca
                           , apps.oe_order_lines_all     oola
                           , apps.hz_cust_acct_sites_all hcas
                           , apps.hz_cust_site_uses_all  hcsu
                       WHERE oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                         AND oola.end_customer_site_use_id  = hcsu.site_use_id
                         AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                         AND hcas.cust_account_id           = hca.cust_account_id
                         AND hca.party_id                   = hp.party_id )
                ELSE
                   CASE WHEN (mmt.source_code = '3PL_REMITTANCE_BRAZIL') THEN
                      (SELECT listagg(DECODE(hcas.global_attribute2
                                           , '2',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'/'|| hcas.global_attribute4 ||'-'|| hcas.global_attribute5
                                           , '1',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'-'|| hcas.global_attribute5 
                                           , '3',HCSU.LOCATION||' - '||hcas.global_attribute3 ),', ' ON OVERFLOW TRUNCATE)
                     WITHIN GROUP (ORDER BY hcas.global_attribute2 asc) 
                         FROM apps.ra_customer_trx_all     rcta
                            , apps.hz_cust_acct_sites_all  hcas
                            , apps.hz_cust_site_uses_all   hcsu
                        WHERE rcta.interface_header_attribute1 = mp.organization_code||'_'||mmt.transaction_reference
                          AND rcta.ship_to_site_use_id         = hcsu.site_use_id
                          AND hcsu.cust_acct_site_id           = hcas.cust_acct_site_id
                          AND rcta.org_id                      = 4330)
                   ELSE
                      (SELECT listagg(DECODE(hcas.global_attribute2
                                           , '2',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'/'|| hcas.global_attribute4 ||'-'|| hcas.global_attribute5
                                           , '1',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'-'|| hcas.global_attribute5 
                                           , '3',HCSU.LOCATION||' - '||hcas.global_attribute3 ),', ' ON OVERFLOW TRUNCATE)
                      WITHIN GROUP (ORDER BY hcas.global_attribute2 asc) 
                         FROM apps.hz_parties             hp
                            , apps.hz_cust_accounts       hca
                            , apps.oe_order_lines_all     oola
                            , apps.hz_cust_acct_sites_all hcas
                            , apps.hz_cust_site_uses_all  hcsu
                        WHERE oola.line_id                = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                          AND oola.ship_to_org_id         = hcsu.site_use_id
                          AND hcsu.cust_acct_site_id      = hcas.cust_acct_site_id
                          AND hcas.cust_account_id        = hca.cust_account_id
                          AND hca.party_id                = hp.party_id  )
                   END
                END  customer_cnpj_cpf
               -- 
              , CASE WHEN (mmt.source_code = '3PL_REMITTANCE_BRAZIL') THEN
                      (SELECT listagg(DECODE(hcas.global_attribute2
                                           , '2',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'/'|| hcas.global_attribute4 ||'-'|| hcas.global_attribute5
                                           , '1',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'-'|| hcas.global_attribute5 
                                           , '3',HCSU.LOCATION||' - '||hcas.global_attribute3 ),', ' ON OVERFLOW TRUNCATE)
                       WITHIN GROUP (ORDER BY hcas.global_attribute2 asc )
                         FROM apps.ra_customer_trx_all         rcta
                            , apps.hz_cust_acct_sites_all      hcas
                            , apps.hz_cust_site_uses_all       hcsu
                        WHERE rcta.interface_header_attribute1 = mp.organization_code||'_'||mmt.transaction_reference
                          AND rcta.bill_to_site_use_id         = hcsu.site_use_id
                          AND hcsu.cust_acct_site_id           = hcas.cust_acct_site_id
                          AND rcta.org_id                      = 4330
                          AND ROWNUM = 1)
                   ELSE
                     --
                     CASE WHEN (select DISTINCT RCTL.INTERFACE_LINE_CONTEXT
                             FROM apps.hz_parties                hp
                                , apps.hz_cust_accounts          hca
                                , apps.oe_order_lines_all        oola
                                , apps.oe_order_headers_all      ooha
                                , apps.ra_customer_trx_lines_all rctl
                                , apps.ra_customer_trx_all       rcta
                                , apps.hz_cust_acct_sites_all    hcas
                                , apps.hz_cust_site_uses_all     hcsu
                            WHERE ooha.header_id                 = oola.header_id
                              AND oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND rctl.inventory_item_id         = oola.inventory_item_id
                              AND rctl.line_type                 = 'LINE'
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE1 = to_char(ooha.order_number)
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE6 = to_char(oola.line_id)
                              AND RCTL.INTERFACE_LINE_CONTEXT    = 'ORDER ENTRY'
                              AND rctl.customer_trx_id           = rcta.customer_trx_id
                              AND rcta.bill_to_site_use_id       = hcsu.site_use_id
                              AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                              AND hcas.cust_account_id           = hca.cust_account_id
                              AND hca.party_id                   = hp.party_id 
                              AND ROWNUM = 1) = 'ORDER ENTRY' THEN
                     --
                     (SELECT DISTINCT DECODE(hcas.global_attribute2
                                           , '2',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'/'|| hcas.global_attribute4 ||'-'|| hcas.global_attribute5
                                           , '1',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'-'|| hcas.global_attribute5 
                                           , '3',HCSU.LOCATION||' - '||hcas.global_attribute3)
                             FROM apps.hz_parties                hp
                                , apps.hz_cust_accounts          hca
                                , apps.oe_order_lines_all        oola
                                , apps.oe_order_headers_all      ooha
                                , apps.ra_customer_trx_lines_all rctl
                                , apps.ra_customer_trx_all       rcta
                                , apps.hz_cust_acct_sites_all    hcas
                                , apps.hz_cust_site_uses_all     hcsu
                            WHERE ooha.header_id                 = oola.header_id
                              AND oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND rctl.inventory_item_id         = oola.inventory_item_id
                              AND rctl.line_type                 = 'LINE'
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE1 = to_char(ooha.order_number)
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE6 = to_char(oola.line_id)
                              AND RCTL.INTERFACE_LINE_CONTEXT    = 'ORDER ENTRY'
                              AND rctl.customer_trx_id           = rcta.customer_trx_id
                              AND rcta.bill_to_site_use_id       = hcsu.site_use_id
                              AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                              AND hcas.cust_account_id           = hca.cust_account_id
                              AND hca.party_id                   = hp.party_id
                              AND ROWNUM = 1)
                     --
                     ELSE
                     --            
                     CASE WHEN 
                          ( SELECT DISTINCT RCTL.INTERFACE_LINE_CONTEXT
                             FROM apps.hz_parties                hp
                                , apps.hz_cust_accounts          hca
                                , apps.oe_order_lines_all        oola
                                , apps.oe_order_headers_all      ooha
                                , apps.ra_customer_trx_lines_all rctl
                                , apps.ra_customer_trx_all       rcta
                                , apps.hz_cust_acct_sites_all    hcas
                                , apps.hz_cust_site_uses_all     hcsu
                            WHERE ooha.header_id                 = oola.header_id
                              AND oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND rctl.inventory_item_id         = oola.inventory_item_id
                              AND rctl.line_type                 = 'LINE'
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE1 = ooha.ORIG_SYS_DOCUMENT_REF
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE7 = oola.ORIG_SYS_LINE_REF
                              AND RCTL.INTERFACE_LINE_CONTEXT    = 'GEMS_PB_RR'
                              AND rctl.customer_trx_id           = rcta.customer_trx_id
                              AND rcta.bill_to_site_use_id       = hcsu.site_use_id
                              AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                              AND hcas.cust_account_id           = hca.cust_account_id
                              AND ROWNUM = 1 ) = 'GEMS_PB_RR' THEN
                     --
                     (SELECT DISTINCT DECODE(hcas.global_attribute2
                                           , '2',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'/'|| hcas.global_attribute4 ||'-'|| hcas.global_attribute5
                                           , '1',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'-'|| hcas.global_attribute5 
                                           , '3',HCSU.LOCATION||' - '||hcas.global_attribute3)
                             FROM apps.hz_parties                hp
                                , apps.hz_cust_accounts          hca
                                , apps.oe_order_lines_all        oola
                                , apps.oe_order_headers_all      ooha
                                , apps.ra_customer_trx_lines_all rctl
                                , apps.ra_customer_trx_all       rcta
                                , apps.hz_cust_acct_sites_all    hcas
                                , apps.hz_cust_site_uses_all     hcsu
                            WHERE ooha.header_id                 = oola.header_id
                              AND oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND rctl.inventory_item_id         = oola.inventory_item_id
                              AND rctl.line_type                 = 'LINE'
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE1 = ooha.ORIG_SYS_DOCUMENT_REF
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE7 = oola.ORIG_SYS_LINE_REF
                              AND RCTL.INTERFACE_LINE_CONTEXT    = 'GEMS_PB_RR'
                              AND rctl.customer_trx_id           = rcta.customer_trx_id
                              AND rcta.bill_to_site_use_id       = hcsu.site_use_id
                              AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                              AND hcas.cust_account_id           = hca.cust_account_id 
                              AND ROWNUM = 1 )
                     --
                     ELSE
                     --
                    (SELECT DISTINCT DECODE(hcas.global_attribute2
                                   , '2',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'/'|| hcas.global_attribute4 ||'-'|| hcas.global_attribute5
                                   , '1',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'-'|| hcas.global_attribute5 
                                   , '3',HCSU.LOCATION||' - '||hcas.global_attribute3)
                             --
                      FROM   APPS.HZ_CUST_ACCT_SITES_ALL HCAS,
                             APPS.HZ_CUST_SITE_USES_ALL  HCSU,
                            APPS.OE_ORDER_LINES_ALL     OOLA,
                             APPS.OE_ORDER_HEADERS_ALL   OOHA
                             --
                      WHERE  HCSU.SITE_USE_CODE     = 'BILL_TO'
                      AND    HCSU.CUST_ACCT_SITE_ID = HCAS.CUST_ACCT_SITE_ID
                      AND    HCSU.SITE_USE_ID       = NVL(OOLA.ATTRIBUTE1, OOHA.INVOICE_TO_ORG_ID)
                      AND    OOLA.LINE_ID           = NVL(MMT.TRX_SOURCE_LINE_ID, MMT.SOURCE_LINE_ID)
                      AND    OOHA.HEADER_ID         = OOLA.HEADER_ID
                      AND    ROWNUM = 1)
                     --
                     END
                  END
               END      bill_to_CNPJ_CPF
               --
                             --
              , CASE WHEN (mmt.source_code = '3PL_REMITTANCE_BRAZIL') THEN
                        (SELECT listagg(hp.party_name,', ' ON OVERFLOW TRUNCATE)  
                        WITHIN GROUP (ORDER BY hp.party_name asc)
                          FROM apps.hz_parties             hp,
                               apps.hz_cust_accounts       hca,
                               apps.ra_customer_trx_all    rcta,
                               apps.hz_cust_acct_sites_all hcas,
                               apps.hz_cust_site_uses_all  hcsu
                         WHERE rcta.interface_header_attribute1 = mp.organization_code||'_'||mmt.transaction_reference
                           AND rcta.bill_to_site_use_id         = hcsu.site_use_id
                           AND hcsu.cust_acct_site_id           = hcas.cust_acct_site_id
                           AND hcas.cust_account_id             = hca.cust_account_id
                           AND hca.party_id                     = hp.party_id
                           AND rcta.org_id                      = 4330)
                   ELSE
                     --
                     CASE WHEN (select DISTINCT RCTL.INTERFACE_LINE_CONTEXT
                             FROM apps.hz_parties                hp
                                , apps.hz_cust_accounts          hca
                                , apps.oe_order_lines_all        oola
                                , apps.oe_order_headers_all      ooha
                                , apps.ra_customer_trx_lines_all rctl
                                , apps.ra_customer_trx_all       rcta
                                , apps.hz_cust_acct_sites_all    hcas
                                , apps.hz_cust_site_uses_all     hcsu
                            WHERE ooha.header_id                 = oola.header_id
                              AND oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND rctl.inventory_item_id         = oola.inventory_item_id
                              AND rctl.line_type                 = 'LINE'
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE1 = to_char(ooha.order_number)
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE6 = to_char(oola.line_id)
                              AND RCTL.INTERFACE_LINE_CONTEXT    = 'ORDER ENTRY'
                              AND rctl.customer_trx_id           = rcta.customer_trx_id
                              AND rcta.bill_to_site_use_id       = hcsu.site_use_id
                              AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                              AND hcas.cust_account_id           = hca.cust_account_id
                              AND hca.party_id                   = hp.party_id 
                              AND ROWNUM = 1) = 'ORDER ENTRY' THEN
                     --
                     (SELECT listagg(hp.party_name,', ' ON OVERFLOW TRUNCATE)  
                         WITHIN GROUP (ORDER BY hp.party_name asc)
                             FROM apps.hz_parties                hp
                                , apps.hz_cust_accounts          hca
                                , apps.oe_order_lines_all        oola
                                , apps.oe_order_headers_all      ooha
                                , apps.ra_customer_trx_lines_all rctl
                                , apps.ra_customer_trx_all       rcta
                                , apps.hz_cust_acct_sites_all    hcas
                                , apps.hz_cust_site_uses_all     hcsu
                            WHERE ooha.header_id                 = oola.header_id
                              AND oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND rctl.inventory_item_id         = oola.inventory_item_id
                              AND rctl.line_type                 = 'LINE'
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE1 = to_char(ooha.order_number)
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE6 = to_char(oola.line_id)
                              AND RCTL.INTERFACE_LINE_CONTEXT    = 'ORDER ENTRY'
                              AND rctl.customer_trx_id           = rcta.customer_trx_id
                              AND rcta.bill_to_site_use_id       = hcsu.site_use_id
                              AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                              AND hcas.cust_account_id           = hca.cust_account_id
                              AND hca.party_id                   = hp.party_id
                              AND ROWNUM = 1)
                     --
                     ELSE
                     --            
                     CASE WHEN 
                          ( SELECT DISTINCT RCTL.INTERFACE_LINE_CONTEXT
                             FROM apps.hz_parties                hp
                                , apps.hz_cust_accounts          hca
                                , apps.oe_order_lines_all        oola
                                , apps.oe_order_headers_all      ooha
                                , apps.ra_customer_trx_lines_all rctl
                                , apps.ra_customer_trx_all       rcta
                                , apps.hz_cust_acct_sites_all    hcas
                                , apps.hz_cust_site_uses_all     hcsu
                            WHERE ooha.header_id                 = oola.header_id
                              AND oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND rctl.inventory_item_id         = oola.inventory_item_id
                              AND rctl.line_type                 = 'LINE'
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE1 = ooha.ORIG_SYS_DOCUMENT_REF
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE7 = oola.ORIG_SYS_LINE_REF
                              AND RCTL.INTERFACE_LINE_CONTEXT    = 'GEMS_PB_RR'
                              AND rctl.customer_trx_id           = rcta.customer_trx_id
                              AND rcta.bill_to_site_use_id       = hcsu.site_use_id
                              AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                              AND hcas.cust_account_id           = hca.cust_account_id
                              AND ROWNUM = 1 ) = 'GEMS_PB_RR' THEN
                     --
                     (SELECT listagg(hp.party_name,', ' ON OVERFLOW TRUNCATE)  
                         WITHIN GROUP (ORDER BY hp.party_name asc)
                             FROM apps.hz_parties                hp
                                , apps.hz_cust_accounts          hca
                                , apps.oe_order_lines_all        oola
                                , apps.oe_order_headers_all      ooha
                                , apps.ra_customer_trx_lines_all rctl
                                , apps.ra_customer_trx_all       rcta
                                , apps.hz_cust_acct_sites_all    hcas
                                , apps.hz_cust_site_uses_all     hcsu
                            WHERE ooha.header_id                 = oola.header_id
                              AND oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND rctl.inventory_item_id         = oola.inventory_item_id
                              AND rctl.line_type                 = 'LINE'
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE1 = ooha.ORIG_SYS_DOCUMENT_REF
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE7 = oola.ORIG_SYS_LINE_REF
                              AND RCTL.INTERFACE_LINE_CONTEXT    = 'GEMS_PB_RR'
                              AND rctl.customer_trx_id           = rcta.customer_trx_id
                              AND rcta.bill_to_site_use_id       = hcsu.site_use_id
                              AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                              AND hcas.cust_account_id           = hca.cust_account_id 
                              AND ROWNUM = 1 )
                     --
                     ELSE
                     --
                     (SELECT listagg(hp.party_name,', ' ON OVERFLOW TRUNCATE)  
                         WITHIN GROUP (ORDER BY hp.party_name asc)
                      FROM   APPS.HZ_CUST_ACCT_SITES_ALL HCAS,
                             apps.hz_parties             hp,
                             apps.hz_cust_accounts       hca,
                             APPS.HZ_CUST_SITE_USES_ALL  HCSU,
                             APPS.OE_ORDER_LINES_ALL     OOLA,
                             APPS.OE_ORDER_HEADERS_ALL   OOHA
                             --
                      WHERE  HCSU.SITE_USE_CODE     = 'BILL_TO'
                      AND    HCSU.CUST_ACCT_SITE_ID = HCAS.CUST_ACCT_SITE_ID
                      AND    HCSU.SITE_USE_ID       = NVL(OOLA.ATTRIBUTE1, OOHA.INVOICE_TO_ORG_ID)
                      AND    OOLA.LINE_ID           = NVL(MMT.TRX_SOURCE_LINE_ID, MMT.SOURCE_LINE_ID)
                      AND    OOHA.HEADER_ID         = OOLA.HEADER_ID
                      AND    hcas.cust_account_id   = hca.cust_account_id
                      AND    hca.party_id           = hp.party_id 
                      AND    ROWNUM = 1)
                     --          
                     END
                  END
               END      bill_to_Customer_name
               --
                , CASE WHEN (mmt.source_code = '3PL_REMITTANCE_BRAZIL') THEN
                      (SELECT listagg(DECODE(hcas.global_attribute2
                                           , '2',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'/'|| hcas.global_attribute4 ||'-'|| hcas.global_attribute5
                                           , '1',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'-'|| hcas.global_attribute5 
                                           , '3',HCSU.LOCATION||' - '||hcas.global_attribute3 ),', ' ON OVERFLOW TRUNCATE)
                       WITHIN GROUP (ORDER BY hcas.global_attribute2 asc )
                         FROM apps.ra_customer_trx_all         rcta
                            , apps.hz_cust_acct_sites_all      hcas
                            , apps.hz_cust_site_uses_all       hcsu
                        WHERE rcta.interface_header_attribute1 = mp.organization_code||'_'||mmt.transaction_reference
                          AND rcta.ship_to_site_use_id         = hcsu.site_use_id
                          AND hcsu.cust_acct_site_id           = hcas.cust_acct_site_id
                         AND rcta.org_id                      = 4330
                          AND ROWNUM = 1)
                   ELSE
                     --
                     CASE WHEN (select DISTINCT RCTL.INTERFACE_LINE_CONTEXT
                             FROM apps.hz_parties                hp
                                , apps.hz_cust_accounts          hca
                                , apps.oe_order_lines_all        oola
                                , apps.oe_order_headers_all      ooha
                                , apps.ra_customer_trx_lines_all rctl
                                , apps.ra_customer_trx_all       rcta
                                , apps.hz_cust_acct_sites_all    hcas
                                , apps.hz_cust_site_uses_all     hcsu
                            WHERE ooha.header_id                 = oola.header_id
                              AND oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND rctl.inventory_item_id         = oola.inventory_item_id
                              AND rctl.line_type                 = 'LINE'
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE1 = to_char(ooha.order_number)
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE6 = to_char(oola.line_id)
                              AND RCTL.INTERFACE_LINE_CONTEXT    = 'ORDER ENTRY'
                              AND rctl.customer_trx_id           = rcta.customer_trx_id
                              AND rcta.ship_to_site_use_id       = hcsu.site_use_id
                              AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                              AND hcas.cust_account_id           = hca.cust_account_id
                              AND hca.party_id                   = hp.party_id 
                              AND ROWNUM = 1) = 'ORDER ENTRY' THEN
                     --
                     (SELECT DISTINCT DECODE(hcas.global_attribute2
                                           , '2',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'/'|| hcas.global_attribute4 ||'-'|| hcas.global_attribute5
                                           , '1',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'-'|| hcas.global_attribute5 
                                           , '3',HCSU.LOCATION||' - '||hcas.global_attribute3)
                             FROM apps.hz_parties                hp
                                , apps.hz_cust_accounts          hca
                                , apps.oe_order_lines_all        oola
                                , apps.oe_order_headers_all      ooha
                                , apps.ra_customer_trx_lines_all rctl
                                , apps.ra_customer_trx_all       rcta
                                , apps.hz_cust_acct_sites_all    hcas
                                , apps.hz_cust_site_uses_all     hcsu
                            WHERE ooha.header_id                 = oola.header_id
                              AND oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND rctl.inventory_item_id         = oola.inventory_item_id
                              AND rctl.line_type                 = 'LINE'
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE1 = to_char(ooha.order_number)
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE6 = to_char(oola.line_id)
                              AND RCTL.INTERFACE_LINE_CONTEXT    = 'ORDER ENTRY'
                              AND rctl.customer_trx_id           = rcta.customer_trx_id
                              AND rcta.ship_to_site_use_id       = hcsu.site_use_id
                              AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                              AND hcas.cust_account_id           = hca.cust_account_id
                              AND hca.party_id                   = hp.party_id
                              AND ROWNUM = 1)
                     --
                     ELSE
                     --            
                     CASE WHEN 
                          ( SELECT DISTINCT RCTL.INTERFACE_LINE_CONTEXT
                             FROM apps.hz_parties                hp
                                , apps.hz_cust_accounts          hca
                                , apps.oe_order_lines_all        oola
                                , apps.oe_order_headers_all      ooha
                                , apps.ra_customer_trx_lines_all rctl
                                , apps.ra_customer_trx_all       rcta
                                , apps.hz_cust_acct_sites_all    hcas
                                , apps.hz_cust_site_uses_all     hcsu
                            WHERE ooha.header_id                 = oola.header_id
                              AND oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND rctl.inventory_item_id         = oola.inventory_item_id
                              AND rctl.line_type                 = 'LINE'
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE1 = ooha.ORIG_SYS_DOCUMENT_REF
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE7 = oola.ORIG_SYS_LINE_REF
                              AND RCTL.INTERFACE_LINE_CONTEXT    = 'GEMS_PB_RR'
                              AND rctl.customer_trx_id           = rcta.customer_trx_id
                              AND rcta.ship_to_site_use_id       = hcsu.site_use_id
                              AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                              AND hcas.cust_account_id           = hca.cust_account_id
                              AND ROWNUM = 1 ) = 'GEMS_PB_RR' THEN
                     --
                     (SELECT DISTINCT DECODE(hcas.global_attribute2
                                           , '2',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'/'|| hcas.global_attribute4 ||'-'|| hcas.global_attribute5
                                           , '1',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'-'|| hcas.global_attribute5 
                                           , '3',HCSU.LOCATION||' - '||hcas.global_attribute3)
                             FROM apps.hz_parties                hp
                                , apps.hz_cust_accounts          hca
                                , apps.oe_order_lines_all        oola
                                , apps.oe_order_headers_all      ooha
                                , apps.ra_customer_trx_lines_all rctl
                                , apps.ra_customer_trx_all       rcta
                                , apps.hz_cust_acct_sites_all    hcas
                                , apps.hz_cust_site_uses_all     hcsu
                            WHERE ooha.header_id                 = oola.header_id
                              AND oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND rctl.inventory_item_id         = oola.inventory_item_id
                              AND rctl.line_type                 = 'LINE'
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE1 = ooha.ORIG_SYS_DOCUMENT_REF
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE7 = oola.ORIG_SYS_LINE_REF
                              AND RCTL.INTERFACE_LINE_CONTEXT    = 'GEMS_PB_RR'
                              AND rctl.customer_trx_id           = rcta.customer_trx_id
                              AND rcta.ship_to_site_use_id       = hcsu.site_use_id
                              AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                              AND hcas.cust_account_id           = hca.cust_account_id 
                              AND ROWNUM = 1 )
                     --
                     ELSE
                     --
                     (SELECT listagg(DECODE(hcas.global_attribute2
                                           , '2',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'/'|| hcas.global_attribute4 ||'-'|| hcas.global_attribute5
                                           , '1',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'-'|| hcas.global_attribute5 
                                           , '3',HCSU.LOCATION||' - '||hcas.global_attribute3 ),', ' ON OVERFLOW TRUNCATE)
                      WITHIN GROUP (ORDER BY hcas.global_attribute2 asc) 
                         FROM apps.hz_parties             hp
                            , apps.hz_cust_accounts       hca
                            , apps.oe_order_lines_all     oola
                            , apps.hz_cust_acct_sites_all hcas
                            , apps.hz_cust_site_uses_all  hcsu
                        WHERE oola.line_id                = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                          AND oola.ship_to_org_id         = hcsu.site_use_id
                          AND hcsu.cust_acct_site_id      = hcas.cust_acct_site_id
                          AND hcas.cust_account_id        = hca.cust_account_id
                          AND hca.party_id                = hp.party_id  )
                     --
                     END
                  END
               END      ship_to_CNPJ_CPF
               --
              , CASE WHEN ( SELECT ottl.name
                              FROM apps.oe_transaction_types_tl    ottl
                                 , apps.oe_order_headers_all  ooha
                                 , apps.oe_order_lines_all    oola  
                             WHERE oola.line_id        = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                               AND oola.header_id      = ooha.header_id
                               AND ooha.order_type_id  = ottl.transaction_type_id  ) = 'GPO_BR_FE_SHIPMENT' THEN
                      (SELECT listagg(hzl.address1 ||' - '|| hzl.address2 || ' - ' || hzl.city || '-' || hzl.state || ' / ' || hzl.postal_code,', ' ON OVERFLOW TRUNCATE)  
                       WITHIN GROUP (ORDER BY hzl.address1 asc)
                       FROM apps.hz_parties             hp
                        , apps.hz_party_sites         hps
                        , apps.hz_cust_accounts       hca
                        , apps.oe_order_lines_all     oola
                        , apps.hz_cust_acct_sites_all hcas
                        , apps.hz_cust_site_uses_all  hcsu
                        , apps.hz_locations           hzl
                    WHERE oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                      AND oola.end_customer_site_use_id  = hcsu.site_use_id
                      AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                      AND hcas.cust_account_id           = hca.cust_account_id
                      AND hcas.party_site_id             = hps.party_site_id
                      AND hca.party_id                   = hp.party_id
                      AND hps.party_id                   = hp.party_id
                      AND hps.location_id                = hzl.location_id)
                ELSE
                   CASE WHEN (mmt.source_code = '3PL_REMITTANCE_BRAZIL') THEN
                      (SELECT listagg(hzl.address1 ||' - '|| hzl.address2 || ' - ' || hzl.city || '-' || hzl.state || ' / ' || hzl.postal_code,', ' ON OVERFLOW TRUNCATE)  
                       WITHIN GROUP (ORDER BY hzl.address1 asc)
                         FROM apps.ra_customer_trx_all     rcta
                            , apps.hz_cust_acct_sites_all  hcas
                            , apps.hz_cust_site_uses_all   hcsu
                            , apps.hz_parties              hp
                            , apps.hz_party_sites          hps
                            , apps.hz_cust_accounts        hca
                            , apps.hz_locations            hzl
                        WHERE rcta.interface_header_attribute1 = mp.organization_code||'_'||mmt.transaction_reference
                          AND rcta.ship_to_site_use_id         = hcsu.site_use_id
                          AND hcsu.cust_acct_site_id           = hcas.cust_acct_site_id
                          AND hcas.cust_account_id             = hca.cust_account_id
                          AND hcas.party_site_id               = hps.party_site_id
                          AND hca.party_id                     = hp.party_id
                          AND hps.party_id                     = hp.party_id
                          AND hps.location_id                  = hzl.location_id
                          AND rcta.org_id                      = 4330)
                   ELSE
                      (SELECT listagg(hzl.address1 ||' - '|| hzl.address2 || ' - ' || hzl.city || '-' || hzl.state || ' / ' || hzl.postal_code,', ' ON OVERFLOW TRUNCATE)  
                       WITHIN GROUP (ORDER BY hzl.address1 asc)
                          FROM apps.hz_parties             hp
                             , apps.hz_party_sites         hps
                             , apps.hz_cust_accounts       hca
                             , apps.oe_order_lines_all     oola
                             , apps.hz_cust_acct_sites_all hcas
                             , apps.hz_cust_site_uses_all  hcsu
                             , apps.hz_locations           hzl
                         WHERE oola.line_id                = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                           AND oola.ship_to_org_id         = hcsu.site_use_id
                           AND hcsu.cust_acct_site_id      = hcas.cust_acct_site_id
                           AND hcas.cust_account_id        = hca.cust_account_id
                           AND hcas.party_site_id          = hps.party_site_id
                           AND hca.party_id                = hp.party_id
                           AND hps.party_id                = hp.party_id
                           AND hps.location_id             = hzl.location_id   )
                   END
                END customer_address
                -- 
                -- alterado para BIll_to por Sinval fim
                --
              , CASE WHEN (mmt.source_code = '3PL_REMITTANCE_BRAZIL') THEN
                   (SELECT listagg(rcta.trx_number,', ' ON OVERFLOW TRUNCATE)  
                           WITHIN GROUP (ORDER BY rcta.trx_number asc)
                      FROM apps.ra_customer_trx_all       rcta
                     WHERE rcta.interface_header_attribute1  = mp.organization_code||'_'||mmt.transaction_reference
                       AND rcta.org_id                       = 4330
                       AND NVL(rcta.status_trx,'XX')         <> 'VD'
                       AND NVL(rcta.reason_code,'XX')        <> 'CANCELLATION')
                ELSE
                   (SELECT distinct RTRIM(REGEXP_REPLACE((listagg(rcta.trx_number,', ' ON OVERFLOW TRUNCATE)  
                      WITHIN GROUP (ORDER BY rcta.trx_number asc) ), '([^,]*)(,\1)+($|,)', '\1\3'),',')
                      FROM apps.ra_customer_trx_lines_all rctla
                         , apps.ra_customer_trx_all       rcta
                         , apps.oe_order_lines_all        oola
                         , apps.oe_order_headers_all      ooha
                     WHERE rcta.customer_trx_id              = rctla.customer_trx_id
                       AND oola.line_id                      = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                       AND oola.header_id                    = ooha.header_id
                       AND rctla.sales_order                 = to_char(ooha.order_number)
                       AND rctla.line_type                   = 'LINE'
                       AND rcta.batch_source_id              <> 6266 -- No RR invoices
                       AND DECODE(rctla.interface_line_context,'GEMS_PB_RR',rcta.interface_header_attribute11,'999')
                           = DECODE(rctla.interface_line_context,'GEMS_PB_RR',rcta.interface_header_attribute11,'999')
                       AND rcta.org_id                       = 4330
                       AND trunc(rcta.trx_date)              BETWEEN (trunc(mmt.transaction_date)-3) AND (trunc(mmt.transaction_date)+3)
                       AND NVL(rcta.status_trx,'XX')         <> 'VD'
                       AND NVL(rcta.reason_code,'XX')        <> 'CANCELLATION')   
                END   invoice_number_ar
              , ( SELECT listagg(mrav.reservation_quantity,', ' ON OVERFLOW TRUNCATE)  
                  WITHIN GROUP (ORDER BY mrav.reservation_quantity asc)
                    FROM apps.mtl_reservations_all_v  mrav 
                       , apps.oe_order_headers_all    ooha1
                   WHERE mrav.demand_source_header_id     = ooha1.header_id
                     AND mrav.demand_source_line_id       = NVL(mmt.trx_source_line_id, mmt.source_line_id) )  reservation_quantity
              , ( SELECT listagg(ooha1.order_number,', ' ON OVERFLOW TRUNCATE)  
                  WITHIN GROUP (ORDER BY ooha1.order_number asc) 
                    FROM apps.mtl_reservations_all_v  mrav 
                       , apps.oe_order_headers_all    ooha1
                   WHERE mrav.demand_source_header_id     = ooha1.header_id
                     AND mrav.demand_source_line_id       = NVL(mmt.trx_source_line_id, mmt.source_line_id) )  reservation_order_number
              , (SELECT distinct hp.party_name
                 --WITHIN GROUP (ORDER BY hp.party_name asc)
                   FROM apps.hz_parties              hp
                      , apps.hz_cust_accounts        hca
                      , apps.oe_order_lines_all      oola1
                      , apps.oe_order_headers_all    ooha1
                      , apps.mtl_reservations_all_v  mrav 
                  WHERE mrav.demand_source_header_id   = ooha1.header_id
                    AND mrav.demand_source_line_id     = oola1.line_id
                    AND oola1.line_id                  = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                    AND oola1.ship_to_org_id           = hca.cust_account_id
                    AND hca.party_id                   = hp.party_id )         reservation_customer_name 
              , gcc1.concatenated_segments   material_account
              , gcc2.concatenated_segments   outside_processing_account
              , gcc3.concatenated_segments   material_overhead_account
              , gcc4.concatenated_segments   overhead_account
              , gcc5.concatenated_segments   resource_account
              , sysdate                                           report_date_and_time 
              , to_char(mmt.transaction_id)
              , fu.user_name ||' / '|| fu.description             user_name
              , DECODE( lot_control_code, 1 ,'Sem controle de Lote' , 2,'Com controle de Lote')   lot_control
              , DECODE( serial_number_control_code, 1, 'Sem controle de Serial'
                                                  , 2, 'Pre-definido'
                                                  , 5, 'No Recebimento'
                                                  , 6, 'Baixa na Ordem de Venda' )  serial_control
              , CASE
                 WHEN    nvl(mmt.lpn_id, mmt.content_lpn_id) IS NULL AND moq.subinventory_code <> 'WHGU42GNAT'
                   THEN
                     (SELECT listagg(lpn.license_plate_number,', ' ON OVERFLOW TRUNCATE)WITHIN GROUP (ORDER BY lpn.license_plate_number asc)
                             FROM apps.MTL_MATERIAL_TRANSACTIONS   mtt,
                                  apps.wms_license_plate_numbers   lpn,
                                  apps.oe_order_lines_all          ool
                            WHERE 1 = 1
                              AND mtt.TRX_SOURCE_LINE_ID = CASE
                                                              WHEN LINE_CATEGORY_CODE = 'ORDER'
                                                                THEN ool.line_id
                                                              WHEN LINE_CATEGORY_CODE = 'RETURN'  
                                                                THEN   
                                                                to_number(NVL(SUBSTR(ool.ORIG_SYS_LINE_REF,
                                                                                     0,
                                                                                     INSTR(ool.ORIG_SYS_LINE_REF, '.') - 1),
                                                                              -1)) -- RMA FE OE Line Id
                                                                ELSE -1
                                                                  END
                              AND mtt.TRANSACTION_TYPE_ID = 52 --sales order pick FE ORDER
                              AND mtt.transaction_quantity < 0
                              AND mtt.inventory_item_id = ool.inventory_item_id
                              AND nvl(mtt.lpn_id, mtt.content_lpn_id) = nvl(lpn.lpn_id, -1)
                              AND ool.line_id = CASE
                                                  WHEN mtt.transaction_type_name = 'RMA Receipt'
                                                    THEN mmt.TRX_SOURCE_LINE_ID
                                                  WHEN mtt.transaction_type_name = 'GPO Nationalization Receipt'
                                                     THEN 
                                                      to_number(NVL(SUBSTR(RTRIM(LTRIM(translate(mmt.TRANSACTION_REFERENCE,translate(mmt.TRANSACTION_REFERENCE||'a','1234567890.',' '),' '))),
                                                         0,
                                                         INSTR(RTRIM(LTRIM(translate(mmt.TRANSACTION_REFERENCE,translate(mmt.TRANSACTION_REFERENCE||'a','1234567890.',' '),' '))), '.') - 1),
                                                  -1))
                                                  ELSE -1
                                                    END)
                              WHEN moq.subinventory_code = 'WHGU42GNAT'
                  THEN (SELECT listagg(wlp.license_plate_number,', ' ON OVERFLOW TRUNCATE)  
                            WITHIN GROUP (ORDER BY wlp.license_plate_number asc)
                        FROM   gems_ont.ge_gpo_nationalization_line gnl, 
                               gems_ont.ge_gpo_nationalization_line gn2,
                               apps.wms_license_plate_numbers       wlp,
                               apps.po_line_locations_all           pll,
                               apps.po_lines_all                    pol,
                               apps.po_headers_all                  poh,
                               apps.rcv_shipment_headers            rsh,
                               apps.rcv_transactions                rt
                        Where  wlp.lpn_id(+) = gn2.lpn_id
                        AND gnl.nationalization_so_line_id = gn2.nationalization_so_line_id
                        AND pll.line_location_id = gnl.DOCUMENT_ID
                        AND pll.po_header_id = poh.po_header_id
                        AND pll.po_line_id = pol.po_line_id
                        AND gn2.record_type = 'IMPORT'
                        AND gnl.record_type = 'NATIONALIZATION'
                        AND rt.transaction_id                = mmt.rcv_transaction_id
                        AND rt.po_line_location_id           = pll.line_location_id
                        AND rt.shipment_header_id            = rsh.shipment_header_id)
                  ELSE (SELECT lpn.LICENSE_PLATE_NUMBER
                           FROM   apps.wms_license_plate_numbers   lpn
                           WHERE  nvl(mmt.lpn_id, mmt.content_lpn_id) = nvl(lpn.lpn_id, -1))
                        END LPN_Value                                    
             , 'q3' query
--, mmt.transaction_type_id
--, mmt.trx_source_line_id
--, mmt.source_line_id
           FROM apps.mtl_parameters                  mp
              , apps.mtl_system_items_b              msi
              , apps.mtl_item_locations_kfv          milk
              , apps.gl_code_combinations            gcc
              , apps.gl_code_combinations_kfv        gcc1
              , apps.gl_code_combinations_kfv        gcc2
              , apps.gl_code_combinations_kfv        gcc3
              , apps.gl_code_combinations_kfv        gcc4
              , apps.gl_code_combinations_kfv        gcc5
              , apps.mtl_material_transactions       mmt
              , apps.mtl_transaction_types           mtt
              , apps.mtl_txn_source_types            mtst
              , apps.mtl_secondary_inventories_fk_v  msifv
              , apps.fnd_flex_values_vl              ffvv
              , apps.fnd_flex_value_sets             ffvs
              , apps.fnd_user                        fu
              , ( SELECT organization_id
                       , inventory_item_id
                       , subinventory_code
                       , locator_id
                       , lot_number
                       , create_transaction_id
                       --, transaction_uom_code
                       , SUM (primary_transaction_quantity)  onhand_qty
                    FROM apps.mtl_onhand_quantities_detail
                   WHERE organization_id IN ( SELECT ood.ORGANIZATION_id FROM apps.org_organization_definitions ood WHERE ood.SET_OF_BOOKS_ID = 230 )
                GROUP BY organization_id
                       , inventory_item_id
                       , subinventory_code
                       , locator_id
                     --  , revision
                       , lot_number
                       , create_transaction_id
                       --, transaction_uom_code
                       ) moq
                       ,APPS.MTL_PAC_ACTUAL_COST_DETAILS MPACD 
          WHERE 1                                = 1
          AND decode(mmt.periodic_primary_quantity,null,mmt.transfer_transaction_id,MMT.TRANSACTION_ID) = MPACD.TRANSACTION_ID  
            AND mp.organization_id               = msi.organization_id
            AND msifv.organization_id            = msi.organization_id
--            AND msi.segment1 = '60510302'
            AND msifv.secondary_inventory_name   = moq.subinventory_code
            AND msifv.material_account           = gcc1.code_combination_id
            AND msifv.outside_processing_account = gcc2.code_combination_id
            AND msifv.material_overhead_account  = gcc3.code_combination_id
            AND msifv.overhead_account           = gcc4.code_combination_id
            AND msifv.resource_account           = gcc5.code_combination_id
            AND msi.cost_of_sales_account        = gcc.code_combination_id
            AND ffvs.flex_value_set_name         = 'GE_GL_AFF_ES_PRODUCT_LINE'
            AND ffvs.flex_value_set_id           = ffvv.flex_value_set_id
            AND ffvv.flex_value_meaning          = gcc.segment8
            AND 'TYPE 1'                        IN ('TYPE 1')
            AND msi.organization_id             IN ( SELECT ood.organization_id FROM apps.org_organization_definitions ood WHERE ood.SET_OF_BOOKS_ID = 230 )
            AND moq.inventory_item_id            = mmt.inventory_item_id (+)   
            AND moq.organization_id              = mmt.organization_id   (+)   
            AND moq.subinventory_code            = mmt.subinventory_code (+)   
            AND moq.locator_id                   = mmt.locator_id        (+)   
            AND moq.inventory_item_id            = msi.inventory_item_id
            AND moq.locator_id                   = milk.inventory_location_id
            AND moq.organization_id              = mp.organization_id
            AND moq.create_transaction_id        = mmt.transaction_id  (+)
--    AND MMT.TRANSACTION_ID = 2562828197
            AND mtt.transaction_type_id          = mmt.transaction_type_id 
            AND mtst.transaction_source_type_id  = mmt.transaction_source_type_id
            AND fu.user_id                       = mmt.created_by
            AND msi.serial_number_control_code  NOT IN ('1','6')   --
            AND msi.lot_control_code            <> '2' ------------- Ajustado para n?conflitar com a query 17 e 18- Sinval 17/02
            AND moq.locator_id              NOT IN (SELECT locator_id 
                                                      FROM apps.mtl_onhand_serial_mwb_v 
                                                     WHERE organization_id   = moq.organization_id
                                                       AND subinventory_code = moq.subinventory_code 
                                                       AND inventory_item_id = moq.inventory_item_id)
    AND MMT.TRANSACTION_ID NOT IN(SELECT MMT2.TRANSACTION_ID 
                                  FROM AMARCHIVE.MTL_MATERIAL_TRANSACTIONS  MMT2
                                  WHERE MMT2.TRANSACTION_ID = MMT.TRANSACTION_ID)
------------------------------------------------------------------------------
UNION
------------------------------------------------------------------------------  
-- Com Controle de Lote e Serial Nulo --- AMARCHIVE.MTL_MATERIAL_TRANSACTIONS
         SELECT DISTINCT  --'4' NUM
        /* ( SELECT ccg.cost_group 
                             FROM apps.cst_cost_groups            ccg
                                , apps.cst_cost_group_assignments ccga
                            WHERE ccga.cost_group_id     = ccg.cost_group_id
                              AND ccga.organization_id   = mp.organization_id )  cost_group*/
            ( SELECT ccg.cost_group 
                             FROM apps.cst_cost_groups            ccg
                            WHERE MPACD.cost_group_id     = ccg.cost_group_id )  cost_group  
              , ( SELECT ( SELECT cpp1.period_name 
                             FROM apps.cst_pac_item_costs   cst
                                , apps.cst_pac_periods      cpp1
                            WHERE cst.pac_period_id     = (SELECT MAX(PAC_PERIOD_ID)                   FROM APPS.CST_PAC_PERIODS                  WHERE LEGAL_ENTITY = (SELECT LEGAL_ENTITY                                          FROM APPS.ORG_ORGANIZATION_DEFINITIONS OOD                                         WHERE OOD.ORGANIZATION_ID = mp.organization_id                                         ) )
                              AND cst.pac_period_id     = cpp1.pac_period_id
                              AND cst.inventory_item_id = msi.inventory_item_id
                              AND cst.cost_group_id     = ccg.cost_group_id )  
                    FROM apps.cst_cost_groups            ccg
                       , apps.cst_cost_group_assignments ccga
                   WHERE ccga.cost_group_id     = ccg.cost_group_id
                     AND ccga.organization_id   = mp.organization_id ) period_name
              , mp.organization_code
              , mp.attribute7                organization_type
              , mp.organization_id 
              , moq.subinventory_code
              , msifv.description            subinv_description
              , milk.concatenated_segments   locators
              , DECODE( msifv.asset_inventory, 1 , 'Asset', 2, 'Non Asset')   asset_type
              , msi.segment1                 part_number
              , DECODE(msi.inventory_asset_flag, NULL, 'No', 'N', 'No', 'Y', 'Yes')                         flag_asset_inventory
              , DECODE(msi.costing_enabled_flag, NULL, 'No', 'N', 'No', 'Y', 'Yes')                         flag_de_custo
              , msi.description              descrip_eng
              , msi.attribute3               descrip_ptb
              , msi.creation_date            item_creation_date
              , (trunc(SYSDATE) - trunc(msi.creation_date))      days_from_creation
              , gcc.segment8                                     product_line
              , ffvv.description                                 desc_prod_line
              , msi.primary_uom_code   uom
              , moq.onhand_qty  transaction_quantity --DECODE (msi.serial_number_control_code, 1, moq.onhand_qty, 1 ) transaction_quantity
              , NVL(( SELECT cic.item_cost
                        FROM apps.cst_item_costs cic
                       WHERE cic.organization_id   = msi.organization_id
                         AND cic.inventory_item_id = msi.inventory_item_id
                         AND cic.cost_type_id      = 1 ),0)  custo_unit_inv
              /*, nvl(( SELECT ( SELECT ROUND (cst.item_cost,2) 
                                 FROM apps.cst_pac_item_costs   cst
                                WHERE cst.pac_period_id     = (SELECT MAX(PAC_PERIOD_ID)                   FROM APPS.CST_PAC_PERIODS                  WHERE LEGAL_ENTITY = (SELECT LEGAL_ENTITY                                          FROM APPS.ORG_ORGANIZATION_DEFINITIONS OOD                                         WHERE OOD.ORGANIZATION_ID = mp.organization_id                                         ) )
                                  AND cst.inventory_item_id = msi.inventory_item_id
                                  AND cst.cost_group_id     = ccg.cost_group_id )  item_cost
                        FROM apps.cst_cost_groups            ccg
                           , apps.cst_cost_group_assignments ccga
                       WHERE ccga.cost_group_id     = ccg.cost_group_id
                         AND ccga.organization_id   = mp.organization_id ) ,0) custo_unit_pac*/
                , nvl((SELECT ROUND (cst.item_cost,2) 
                       FROM apps.cst_pac_item_costs   cst
                      WHERE cst.pac_period_id     = (SELECT MAX(PAC_PERIOD_ID)                   
                                                                FROM APPS.CST_PAC_PERIODS                  
                                                                WHERE LEGAL_ENTITY = (SELECT LEGAL_ENTITY                                         
                                                                                        FROM APPS.ORG_ORGANIZATION_DEFINITIONS OOD                                        
                                                                                        WHERE OOD.ORGANIZATION_ID = mp.organization_id
                                                        ) )
                        AND cst.inventory_item_id = msi.inventory_item_id
                        AND cst.cost_group_id     = MPACD.cost_group_id) ,0)  custo_unit_pac
              , moq.lot_number
              , ( SELECT mln.creation_date         
                    FROM apps.mtl_lot_numbers              mln
                   WHERE mln.lot_number           = moq.lot_number 
                     AND mln.inventory_item_id    = msi.inventory_item_id
                     AND mln.organization_id      = mp.organization_id  )  lot_creation_date
              , NULL   lot_qty_days_creation
              , ( SELECT mln.expiration_date         
                    FROM apps.mtl_lot_numbers              mln
                   WHERE mln.lot_number           = moq.lot_number
                     AND mln.inventory_item_id    = msi.inventory_item_id
                     AND mln.organization_id      = mp.organization_id  )  lot_expiration_date
              , NULL    serial_number 
              , NULL    serial_creation_date
              , mtt.transaction_type_name            last_transaction_type
              , mmt.transaction_source_name          last_transaction_source
              , mtst.transaction_source_type_name    last_source_type
              , mmt.source_code
              , TO_CHAR(mmt.transaction_date, 'DD-MON-RRRR')    transaction_date
        , (SELECT TO_CHAR(mmt1.transaction_date, 'DD-MON-RRRR') 
                        FROM apps.mtl_material_transactions mmt1
                        WHERE mmt1.transaction_type_id=420
                        AND mmt1.source_line_id=mmt.source_line_id) initial_consignment_date        
              , (TRUNC(SYSDATE) - TRUNC(mmt.transaction_date))  transaction_qty_of_days
              , TO_CHAR(mmt.transaction_reference)              transaction_reference
              , CASE WHEN mmt.source_code = '3PL_REMITTANCE_BRAZIL' THEN
                     (SELECT listagg(pha.segment1,', ' ON OVERFLOW TRUNCATE)  
                      WITHIN GROUP (ORDER BY pha.segment1 asc)
                        FROM apps.po_headers_all        pha
                           , apps.po_lines_all          pla
                       WHERE pla.po_line_id   = mmt.source_line_id
                         AND pla.po_header_id = pha.po_header_id)
                     WHEN mmt.source_code IN ('ORDER ENTRY','IIP') THEN
                        NULL
                     WHEN mmt.source_code = 'RCV' THEN
                        ( SELECT listagg(pha.segment1,', ' ON OVERFLOW TRUNCATE)  
                          WITHIN GROUP (ORDER BY pha.segment1 asc)
                            FROM apps.po_headers_all            pha
                               , apps.po_lines_all              pla
                               , apps.po_line_locations_all     plla
                               , apps.rcv_shipment_headers      rsh
                               , apps.rcv_transactions          rt
                           WHERE rt.transaction_id                = mmt.rcv_transaction_id
                             AND rt.po_line_location_id           = plla.line_location_id
                             AND plla.po_line_id                  = pla.po_line_id
                             AND pha.po_header_id                 = pla.po_header_id
                             AND rt.shipment_header_id            = rsh.shipment_header_id
                             AND rsh.receipt_source_code          = 'VENDOR'  )
                     ELSE
                        NULL
                END      po_number
              , CASE WHEN mmt.source_code = '3PL_REMITTANCE_BRAZIL' THEN
                     (SELECT listagg(aps.vendor_name,', ' ON OVERFLOW TRUNCATE)  
                      WITHIN GROUP (ORDER BY aps.vendor_name asc)
                        FROM apps.po_headers_all        pha
                           , apps.po_lines_all          pla
                           , apps.ap_suppliers          aps
                           , apps.ap_supplier_sites_all apss
                       WHERE pla.po_line_id     = mmt.source_line_id
                         AND pla.po_header_id   = pha.po_header_id
                         AND pha.vendor_id      = aps.vendor_id
                         AND aps.vendor_id      = apss.vendor_id
                         AND pha.vendor_site_id = apss.vendor_site_id )
                     WHEN mmt.source_code IN ('ORDER ENTRY','IIP') THEN
                        NULL
                     WHEN mmt.source_code = 'RCV' THEN
                        ( SELECT listagg(aps.vendor_name,', ' ON OVERFLOW TRUNCATE)  
                          WITHIN GROUP (ORDER BY aps.vendor_name asc)
                            FROM apps.po_headers_all            pha
                               , apps.po_lines_all              pla
                               , apps.po_line_locations_all     plla
                               , apps.rcv_shipment_headers      rsh
                               , apps.rcv_transactions          rt
                               , apps.ap_suppliers              aps
                               , apps.ap_supplier_sites_all     apss
                           WHERE rt.transaction_id          = mmt.rcv_transaction_id
                             AND rt.po_line_location_id     = plla.line_location_id
                             AND plla.po_line_id            = pla.po_line_id
                             AND pha.po_header_id           = pla.po_header_id
                             AND rt.shipment_header_id      = rsh.shipment_header_id
                             AND rsh.receipt_source_code    = 'VENDOR'
                             AND pha.vendor_id              = aps.vendor_id
                             AND aps.vendor_id              = apss.vendor_id
                             AND pha.vendor_site_id         = apss.vendor_site_id  )
                     ELSE
                        NULL
                END    po_supplier
              , CASE WHEN mmt.source_code = '3PL_REMITTANCE_BRAZIL' THEN
                     ( SELECT listagg(cfi.invoice_num,', ' ON OVERFLOW TRUNCATE)  
                         WITHIN GROUP (ORDER BY cfi.invoice_num asc)
                         FROM apps.cll_f189_invoice_lines cfil
                            , apps.cll_f189_invoices      cfi
                            , apps.po_lines_all           pla
                            , apps.po_line_locations_all  plla
                        WHERE plla.po_line_id       = pla.po_line_id
                          AND pla.po_line_id        = mmt.source_line_id
                          AND plla.line_location_id = cfil.line_location_id
                          AND cfil.invoice_id       = cfi.invoice_id )
                     WHEN mmt.source_code IN ('ORDER ENTRY','IIP') THEN
                        NULL
                     WHEN mmt.source_code = 'RCV' THEN
                        ( SELECT listagg(cfi.invoice_num,', ' ON OVERFLOW TRUNCATE)  
                            WITHIN GROUP (ORDER BY cfi.invoice_num asc)
                            FROM apps.po_headers_all            pha
                               , apps.po_lines_all              pla
                               , apps.po_line_locations_all     plla
                               , apps.cll_f189_invoice_lines    cfil
                               , apps.cll_f189_invoices         cfi
                               , apps.rcv_shipment_headers      rsh
                               , apps.rcv_transactions          rt
                           WHERE rt.transaction_id          = mmt.rcv_transaction_id
                             AND rt.po_line_location_id     = plla.line_location_id
                             AND plla.line_location_id      = cfil.line_location_id
                             AND cfil.invoice_id            = cfi.invoice_id
                             AND plla.po_line_id            = pla.po_line_id
                             AND pha.po_header_id           = pla.po_header_id
                             AND rt.shipment_header_id      = rsh.shipment_header_id
                             AND rsh.receipt_source_code    = 'VENDOR'   )
                     ELSE
                        NULL
                END    NF_RI
              , (SELECT DECODE( mmt.source_code, '3PL_REMITTANCE_BRAZIL',NULL,to_char(ooha.order_number) )
                   FROM apps.oe_order_headers_all  ooha
                      , apps.oe_order_lines_all    oola  
                  WHERE oola.line_id        = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                    AND oola.header_id      = ooha.header_id )   order_number
               -- 
               -- alterado para BIll_to por Sinval inicio
               --
               , CASE WHEN ( SELECT ottl.name
                             FROM apps.oe_transaction_types_tl    ottl
                                , apps.oe_order_headers_all  ooha
                                , apps.oe_order_lines_all    oola  
                            WHERE oola.line_id        = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND oola.header_id      = ooha.header_id
                              AND ooha.order_type_id  = ottl.transaction_type_id  ) = 'GPO_BR_FE_SHIPMENT' THEN
                     (SELECT listagg(hp.party_name,', ' ON OVERFLOW TRUNCATE)  
                      WITHIN GROUP (ORDER BY hp.party_name asc)
                        FROM apps.hz_parties             hp
                           , apps.hz_cust_accounts       hca
                           , apps.oe_order_lines_all     oola
                           , apps.hz_cust_acct_sites_all hcas
                           , apps.hz_cust_site_uses_all  hcsu
                       WHERE oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                         AND oola.end_customer_site_use_id  = hcsu.site_use_id
                         AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                         AND hcas.cust_account_id           = hca.cust_account_id
                         AND hca.party_id                   = hp.party_id )
                  ELSE
                     CASE WHEN (mmt.source_code = '3PL_REMITTANCE_BRAZIL') THEN
                       (SELECT listagg(hp.party_name,', ' ON OVERFLOW TRUNCATE)  
                        WITHIN GROUP (ORDER BY hp.party_name asc)
                          FROM apps.hz_parties             hp,
                               apps.hz_cust_accounts       hca,
                               apps.ra_customer_trx_all    rcta,
                               apps.hz_cust_acct_sites_all hcas,
                               apps.hz_cust_site_uses_all  hcsu
                         WHERE rcta.interface_header_attribute1 = mp.organization_code||'_'||mmt.transaction_reference
                           AND rcta.ship_to_site_use_id         = hcsu.site_use_id
                           AND hcsu.cust_acct_site_id           = hcas.cust_acct_site_id
                           AND hcas.cust_account_id             = hca.cust_account_id
                           AND hca.party_id                     = hp.party_id
                           AND rcta.org_id                      = 4330)
                     ELSE
                        (SELECT listagg(hp.party_name,', ' ON OVERFLOW TRUNCATE)  
                         WITHIN GROUP (ORDER BY hp.party_name asc)
                           FROM apps.hz_parties             hp
                              , apps.hz_cust_accounts       hca
                              , apps.oe_order_lines_all     oola
                              , apps.hz_cust_acct_sites_all hcas
                              , apps.hz_cust_site_uses_all  hcsu
                          WHERE oola.line_id                = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                            AND oola.ship_to_org_id         = hcsu.site_use_id
                            AND hcsu.cust_acct_site_id      = hcas.cust_acct_site_id
                            AND hcas.cust_account_id        = hca.cust_account_id
                            AND hca.party_id                = hp.party_id )
                    END                 
               END    customer_name
             , CASE WHEN ( SELECT ottl.name
                             FROM apps.oe_transaction_types_tl    ottl
                                , apps.oe_order_headers_all  ooha
                                , apps.oe_order_lines_all    oola  
                            WHERE oola.line_id        = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND oola.header_id      = ooha.header_id
                              AND ooha.order_type_id  = ottl.transaction_type_id  ) = 'GPO_BR_FE_SHIPMENT' THEN
                     (SELECT listagg(hca.account_number,', ' ON OVERFLOW TRUNCATE)  
                      WITHIN GROUP (ORDER BY hca.account_number asc)
                        FROM apps.hz_parties             hp
                           , apps.hz_cust_accounts       hca
                           , apps.oe_order_lines_all     oola
                           , apps.hz_cust_acct_sites_all hcas
                           , apps.hz_cust_site_uses_all  hcsu
                       WHERE oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                         AND oola.end_customer_site_use_id  = hcsu.site_use_id
                         AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                         AND hcas.cust_account_id           = hca.cust_account_id
                         AND hca.party_id                   = hp.party_id )
                  ELSE
                     CASE WHEN (mmt.source_code = '3PL_REMITTANCE_BRAZIL') THEN
                        (SELECT listagg(hca.account_number,', ' ON OVERFLOW TRUNCATE)  
                         WITHIN GROUP (ORDER BY hca.account_number asc)
                           FROM apps.hz_parties             hp,
                                apps.hz_cust_accounts       hca,
                                apps.ra_customer_trx_all    rcta,
                                apps.hz_cust_acct_sites_all hcas,
                                apps.hz_cust_site_uses_all  hcsu
                          WHERE rcta.interface_header_attribute1 = mp.organization_code||'_'||mmt.transaction_reference
                            AND rcta.ship_to_site_use_id         = hcsu.site_use_id
                            AND hcsu.cust_acct_site_id           = hcas.cust_acct_site_id
                            AND hcas.cust_account_id             = hca.cust_account_id
                            AND hca.party_id                     = hp.party_id
                            AND rcta.org_id                      = 4330)
                     ELSE
                        (SELECT listagg(hca.account_number,', ' ON OVERFLOW TRUNCATE)  
                         WITHIN GROUP (ORDER BY hca.account_number asc)
                           FROM apps.hz_parties             hp
                              , apps.hz_cust_accounts       hca
                              , apps.oe_order_lines_all     oola
                              , apps.hz_cust_acct_sites_all hcas
                              , apps.hz_cust_site_uses_all  hcsu
                          WHERE oola.line_id                = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                            AND oola.ship_to_org_id         = hcsu.site_use_id
                            AND hcsu.cust_acct_site_id      = hcas.cust_acct_site_id
                            AND hcas.cust_account_id        = hca.cust_account_id
                            AND hca.party_id                = hp.party_id   )
                     END
                  END   customer_number
              --
              , CASE WHEN ( SELECT ottl.name
                             FROM apps.oe_transaction_types_tl    ottl
                                , apps.oe_order_headers_all  ooha
                                , apps.oe_order_lines_all    oola  
                            WHERE oola.line_id        = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND oola.header_id      = ooha.header_id
                              AND ooha.order_type_id  = ottl.transaction_type_id  ) = 'GPO_BR_FE_SHIPMENT' THEN
                     (SELECT listagg(DECODE(hcas.global_attribute2
                                           , '2',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'/'|| hcas.global_attribute4 ||'-'|| hcas.global_attribute5
                                           , '1',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'-'|| hcas.global_attribute5 
                                           , '3',HCSU.LOCATION||' - '||hcas.global_attribute3 ),', ' ON OVERFLOW TRUNCATE)
                     WITHIN GROUP (ORDER BY hcas.global_attribute2 asc ) 
                        FROM apps.hz_parties             hp
                           , apps.hz_cust_accounts       hca
                           , apps.oe_order_lines_all     oola
                           , apps.hz_cust_acct_sites_all hcas
                           , apps.hz_cust_site_uses_all  hcsu
                       WHERE oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                         AND oola.end_customer_site_use_id  = hcsu.site_use_id
                         AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                         AND hcas.cust_account_id           = hca.cust_account_id
                         AND hca.party_id                   = hp.party_id )
                ELSE
                   CASE WHEN (mmt.source_code = '3PL_REMITTANCE_BRAZIL') THEN
                      (SELECT listagg(DECODE(hcas.global_attribute2
                                           , '2',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'/'|| hcas.global_attribute4 ||'-'|| hcas.global_attribute5
                                           , '1',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'-'|| hcas.global_attribute5 
                                           , '3',HCSU.LOCATION||' - '||hcas.global_attribute3 ),', ' ON OVERFLOW TRUNCATE)
                     WITHIN GROUP (ORDER BY hcas.global_attribute2 asc) 
                         FROM apps.ra_customer_trx_all     rcta
                            , apps.hz_cust_acct_sites_all  hcas
                            , apps.hz_cust_site_uses_all   hcsu
                        WHERE rcta.interface_header_attribute1 = mp.organization_code||'_'||mmt.transaction_reference
                          AND rcta.ship_to_site_use_id         = hcsu.site_use_id
                          AND hcsu.cust_acct_site_id           = hcas.cust_acct_site_id
                          AND rcta.org_id                      = 4330)
                   ELSE
                      (SELECT listagg(DECODE(hcas.global_attribute2
                                           , '2',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'/'|| hcas.global_attribute4 ||'-'|| hcas.global_attribute5
                                           , '1',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'-'|| hcas.global_attribute5 
                                           , '3',HCSU.LOCATION||' - '||hcas.global_attribute3 ),', ' ON OVERFLOW TRUNCATE)
                      WITHIN GROUP (ORDER BY hcas.global_attribute2 asc) 
                         FROM apps.hz_parties             hp
                            , apps.hz_cust_accounts       hca
                            , apps.oe_order_lines_all     oola
                            , apps.hz_cust_acct_sites_all hcas
                            , apps.hz_cust_site_uses_all  hcsu
                        WHERE oola.line_id                = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                          AND oola.ship_to_org_id         = hcsu.site_use_id
                          AND hcsu.cust_acct_site_id      = hcas.cust_acct_site_id
                          AND hcas.cust_account_id        = hca.cust_account_id
                          AND hca.party_id                = hp.party_id  )
                   END
                END  customer_cnpj_cpf
               -- 
              , CASE WHEN (mmt.source_code = '3PL_REMITTANCE_BRAZIL') THEN
                      (SELECT listagg(DECODE(hcas.global_attribute2
                                           , '2',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'/'|| hcas.global_attribute4 ||'-'|| hcas.global_attribute5
                                           , '1',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'-'|| hcas.global_attribute5 
                                           , '3',HCSU.LOCATION||' - '||hcas.global_attribute3 ),', ' ON OVERFLOW TRUNCATE)
                       WITHIN GROUP (ORDER BY hcas.global_attribute2 asc )
                         FROM apps.ra_customer_trx_all         rcta
                            , apps.hz_cust_acct_sites_all      hcas
                            , apps.hz_cust_site_uses_all       hcsu
                        WHERE rcta.interface_header_attribute1 = mp.organization_code||'_'||mmt.transaction_reference
                          AND rcta.bill_to_site_use_id         = hcsu.site_use_id
                          AND hcsu.cust_acct_site_id           = hcas.cust_acct_site_id
                          AND rcta.org_id                      = 4330
                          AND ROWNUM = 1)
                   ELSE
                     --
                     CASE WHEN (select DISTINCT RCTL.INTERFACE_LINE_CONTEXT
                             FROM apps.hz_parties                hp
                                , apps.hz_cust_accounts          hca
                                , apps.oe_order_lines_all        oola
                                , apps.oe_order_headers_all      ooha
                                , apps.ra_customer_trx_lines_all rctl
                                , apps.ra_customer_trx_all       rcta
                                , apps.hz_cust_acct_sites_all    hcas
                                , apps.hz_cust_site_uses_all     hcsu
                            WHERE ooha.header_id                 = oola.header_id
                              AND oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND rctl.inventory_item_id         = oola.inventory_item_id
                              AND rctl.line_type                 = 'LINE'
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE1 = to_char(ooha.order_number)
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE6 = to_char(oola.line_id)
                              AND RCTL.INTERFACE_LINE_CONTEXT    = 'ORDER ENTRY'
                              AND rctl.customer_trx_id           = rcta.customer_trx_id
                              AND rcta.bill_to_site_use_id       = hcsu.site_use_id
                              AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                              AND hcas.cust_account_id           = hca.cust_account_id
                              AND hca.party_id                   = hp.party_id 
                              AND ROWNUM = 1) = 'ORDER ENTRY' THEN
                     --
                     (SELECT DISTINCT DECODE(hcas.global_attribute2
                                           , '2',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'/'|| hcas.global_attribute4 ||'-'|| hcas.global_attribute5
                                           , '1',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'-'|| hcas.global_attribute5 
                                           , '3',HCSU.LOCATION||' - '||hcas.global_attribute3)
                             FROM apps.hz_parties                hp
                                , apps.hz_cust_accounts          hca
                                , apps.oe_order_lines_all        oola
                                , apps.oe_order_headers_all      ooha
                                , apps.ra_customer_trx_lines_all rctl
                                , apps.ra_customer_trx_all       rcta
                                , apps.hz_cust_acct_sites_all    hcas
                                , apps.hz_cust_site_uses_all     hcsu
                            WHERE ooha.header_id                 = oola.header_id
                              AND oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND rctl.inventory_item_id         = oola.inventory_item_id
                              AND rctl.line_type                 = 'LINE'
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE1 = to_char(ooha.order_number)
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE6 = to_char(oola.line_id)
                              AND RCTL.INTERFACE_LINE_CONTEXT    = 'ORDER ENTRY'
                              AND rctl.customer_trx_id           = rcta.customer_trx_id
                              AND rcta.bill_to_site_use_id       = hcsu.site_use_id
                              AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                              AND hcas.cust_account_id           = hca.cust_account_id
                              AND hca.party_id                   = hp.party_id
                              AND ROWNUM = 1)
                     --
                     ELSE
                     --            
                     CASE WHEN 
                          ( SELECT DISTINCT RCTL.INTERFACE_LINE_CONTEXT
                             FROM apps.hz_parties                hp
                                , apps.hz_cust_accounts          hca
                                , apps.oe_order_lines_all        oola
                                , apps.oe_order_headers_all      ooha
                                , apps.ra_customer_trx_lines_all rctl
                                , apps.ra_customer_trx_all       rcta
                                , apps.hz_cust_acct_sites_all    hcas
                                , apps.hz_cust_site_uses_all     hcsu
                            WHERE ooha.header_id                 = oola.header_id
                              AND oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND rctl.inventory_item_id         = oola.inventory_item_id
                              AND rctl.line_type                 = 'LINE'
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE1 = ooha.ORIG_SYS_DOCUMENT_REF
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE7 = oola.ORIG_SYS_LINE_REF
                              AND RCTL.INTERFACE_LINE_CONTEXT    = 'GEMS_PB_RR'
                              AND rctl.customer_trx_id           = rcta.customer_trx_id
                              AND rcta.bill_to_site_use_id       = hcsu.site_use_id
                              AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                              AND hcas.cust_account_id           = hca.cust_account_id
                              AND ROWNUM = 1 ) = 'GEMS_PB_RR' THEN
                     --
                     (SELECT DISTINCT DECODE(hcas.global_attribute2
                                           , '2',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'/'|| hcas.global_attribute4 ||'-'|| hcas.global_attribute5
                                           , '1',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'-'|| hcas.global_attribute5 
                                           , '3',HCSU.LOCATION||' - '||hcas.global_attribute3)
                             FROM apps.hz_parties                hp
                                , apps.hz_cust_accounts          hca
                                , apps.oe_order_lines_all        oola
                                , apps.oe_order_headers_all      ooha
                                , apps.ra_customer_trx_lines_all rctl
                                , apps.ra_customer_trx_all       rcta
                                , apps.hz_cust_acct_sites_all    hcas
                                , apps.hz_cust_site_uses_all     hcsu
                            WHERE ooha.header_id                 = oola.header_id
                              AND oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND rctl.inventory_item_id         = oola.inventory_item_id
                              AND rctl.line_type                 = 'LINE'
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE1 = ooha.ORIG_SYS_DOCUMENT_REF
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE7 = oola.ORIG_SYS_LINE_REF
                              AND RCTL.INTERFACE_LINE_CONTEXT    = 'GEMS_PB_RR'
                              AND rctl.customer_trx_id           = rcta.customer_trx_id
                              AND rcta.bill_to_site_use_id       = hcsu.site_use_id
                              AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                              AND hcas.cust_account_id           = hca.cust_account_id 
                              AND ROWNUM = 1 )
                     --
                     ELSE
                     --
                     (SELECT DISTINCT DECODE(hcas.global_attribute2
                                   , '2',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'/'|| hcas.global_attribute4 ||'-'|| hcas.global_attribute5
                                   , '1',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'-'|| hcas.global_attribute5 
                                   , '3',HCSU.LOCATION||' - '||hcas.global_attribute3)
                             --
                      FROM   APPS.HZ_CUST_ACCT_SITES_ALL HCAS,
                             APPS.HZ_CUST_SITE_USES_ALL  HCSU,
                            APPS.OE_ORDER_LINES_ALL     OOLA,
                             APPS.OE_ORDER_HEADERS_ALL   OOHA
                             --
                      WHERE  HCSU.SITE_USE_CODE     = 'BILL_TO'
                      AND    HCSU.CUST_ACCT_SITE_ID = HCAS.CUST_ACCT_SITE_ID
                      AND    HCSU.SITE_USE_ID       = NVL(OOLA.ATTRIBUTE1, OOHA.INVOICE_TO_ORG_ID)
                      AND    OOLA.LINE_ID           = NVL(MMT.TRX_SOURCE_LINE_ID, MMT.SOURCE_LINE_ID)
                      AND    OOHA.HEADER_ID         = OOLA.HEADER_ID
                      AND    ROWNUM = 1)
                     --
                     END
                  END
               END      bill_to_CNPJ_CPF
               --
              , CASE WHEN (mmt.source_code = '3PL_REMITTANCE_BRAZIL') THEN
                        (SELECT listagg(hp.party_name,', ' ON OVERFLOW TRUNCATE)  
                        WITHIN GROUP (ORDER BY hp.party_name asc)
                          FROM apps.hz_parties             hp,
                               apps.hz_cust_accounts       hca,
                               apps.ra_customer_trx_all    rcta,
                               apps.hz_cust_acct_sites_all hcas,
                               apps.hz_cust_site_uses_all  hcsu
                         WHERE rcta.interface_header_attribute1 = mp.organization_code||'_'||mmt.transaction_reference
                           AND rcta.bill_to_site_use_id         = hcsu.site_use_id
                           AND hcsu.cust_acct_site_id           = hcas.cust_acct_site_id
                           AND hcas.cust_account_id             = hca.cust_account_id
                           AND hca.party_id                     = hp.party_id
                           AND rcta.org_id                      = 4330)
                   ELSE
                     --
                     CASE WHEN (select DISTINCT RCTL.INTERFACE_LINE_CONTEXT
                             FROM apps.hz_parties                hp
                                , apps.hz_cust_accounts          hca
                                , apps.oe_order_lines_all        oola
                                , apps.oe_order_headers_all      ooha
                                , apps.ra_customer_trx_lines_all rctl
                                , apps.ra_customer_trx_all       rcta
                                , apps.hz_cust_acct_sites_all    hcas
                                , apps.hz_cust_site_uses_all     hcsu
                            WHERE ooha.header_id                 = oola.header_id
                              AND oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND rctl.inventory_item_id         = oola.inventory_item_id
                              AND rctl.line_type                 = 'LINE'
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE1 = to_char(ooha.order_number)
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE6 = to_char(oola.line_id)
                              AND RCTL.INTERFACE_LINE_CONTEXT    = 'ORDER ENTRY'
                              AND rctl.customer_trx_id           = rcta.customer_trx_id
                              AND rcta.bill_to_site_use_id       = hcsu.site_use_id
                              AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                              AND hcas.cust_account_id           = hca.cust_account_id
                              AND hca.party_id                   = hp.party_id 
                              AND ROWNUM = 1) = 'ORDER ENTRY' THEN
                     --
                     (SELECT listagg(hp.party_name,', ' ON OVERFLOW TRUNCATE)  
                         WITHIN GROUP (ORDER BY hp.party_name asc)
                             FROM apps.hz_parties                hp
                                , apps.hz_cust_accounts          hca
                                , apps.oe_order_lines_all        oola
                                , apps.oe_order_headers_all      ooha
                                , apps.ra_customer_trx_lines_all rctl
                                , apps.ra_customer_trx_all       rcta
                                , apps.hz_cust_acct_sites_all    hcas
                                , apps.hz_cust_site_uses_all     hcsu
                            WHERE ooha.header_id                 = oola.header_id
                              AND oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND rctl.inventory_item_id         = oola.inventory_item_id
                              AND rctl.line_type                 = 'LINE'
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE1 = to_char(ooha.order_number)
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE6 = to_char(oola.line_id)
                              AND RCTL.INTERFACE_LINE_CONTEXT    = 'ORDER ENTRY'
                              AND rctl.customer_trx_id           = rcta.customer_trx_id
                              AND rcta.bill_to_site_use_id       = hcsu.site_use_id
                              AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                              AND hcas.cust_account_id           = hca.cust_account_id
                              AND hca.party_id                   = hp.party_id
                              AND ROWNUM = 1)
                     --
                     ELSE
                     --            
                     CASE WHEN 
                          ( SELECT DISTINCT RCTL.INTERFACE_LINE_CONTEXT
                             FROM apps.hz_parties                hp
                                , apps.hz_cust_accounts          hca
                                , apps.oe_order_lines_all        oola
                                , apps.oe_order_headers_all      ooha
                                , apps.ra_customer_trx_lines_all rctl
                                , apps.ra_customer_trx_all       rcta
                                , apps.hz_cust_acct_sites_all    hcas
                                , apps.hz_cust_site_uses_all     hcsu
                            WHERE ooha.header_id                 = oola.header_id
                              AND oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND rctl.inventory_item_id         = oola.inventory_item_id
                              AND rctl.line_type                 = 'LINE'
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE1 = ooha.ORIG_SYS_DOCUMENT_REF
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE7 = oola.ORIG_SYS_LINE_REF
                              AND RCTL.INTERFACE_LINE_CONTEXT    = 'GEMS_PB_RR'
                              AND rctl.customer_trx_id           = rcta.customer_trx_id
                              AND rcta.bill_to_site_use_id       = hcsu.site_use_id
                              AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                              AND hcas.cust_account_id           = hca.cust_account_id
                              AND ROWNUM = 1 ) = 'GEMS_PB_RR' THEN
                     --
                     (SELECT listagg(hp.party_name,', ' ON OVERFLOW TRUNCATE)  
                         WITHIN GROUP (ORDER BY hp.party_name asc)
                             FROM apps.hz_parties                hp
                                , apps.hz_cust_accounts          hca
                                , apps.oe_order_lines_all        oola
                                , apps.oe_order_headers_all      ooha
                                , apps.ra_customer_trx_lines_all rctl
                                , apps.ra_customer_trx_all       rcta
                                , apps.hz_cust_acct_sites_all    hcas
                                , apps.hz_cust_site_uses_all     hcsu
                            WHERE ooha.header_id                 = oola.header_id
                              AND oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND rctl.inventory_item_id         = oola.inventory_item_id
                              AND rctl.line_type                 = 'LINE'
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE1 = ooha.ORIG_SYS_DOCUMENT_REF
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE7 = oola.ORIG_SYS_LINE_REF
                              AND RCTL.INTERFACE_LINE_CONTEXT    = 'GEMS_PB_RR'
                              AND rctl.customer_trx_id           = rcta.customer_trx_id
                              AND rcta.bill_to_site_use_id       = hcsu.site_use_id
                              AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                              AND hcas.cust_account_id           = hca.cust_account_id 
                              AND ROWNUM = 1 )
                     --
                     ELSE
                     --
                     (SELECT listagg(hp.party_name,', ' ON OVERFLOW TRUNCATE)  
                         WITHIN GROUP (ORDER BY hp.party_name asc)
                      FROM   APPS.HZ_CUST_ACCT_SITES_ALL HCAS,
                             apps.hz_parties             hp,
                             apps.hz_cust_accounts       hca,
                             APPS.HZ_CUST_SITE_USES_ALL  HCSU,
                             APPS.OE_ORDER_LINES_ALL     OOLA,
                             APPS.OE_ORDER_HEADERS_ALL   OOHA
                             --
                      WHERE  HCSU.SITE_USE_CODE     = 'BILL_TO'
                      AND    HCSU.CUST_ACCT_SITE_ID = HCAS.CUST_ACCT_SITE_ID
                      AND    HCSU.SITE_USE_ID       = NVL(OOLA.ATTRIBUTE1, OOHA.INVOICE_TO_ORG_ID)
                      AND    OOLA.LINE_ID           = NVL(MMT.TRX_SOURCE_LINE_ID, MMT.SOURCE_LINE_ID)
                      AND    OOHA.HEADER_ID         = OOLA.HEADER_ID
                      AND    hcas.cust_account_id   = hca.cust_account_id
                      AND    hca.party_id           = hp.party_id 
                      AND    ROWNUM = 1)
                     --          
                     END
                 END
               END      bill_to_Customer_name
               --
                , CASE WHEN (mmt.source_code = '3PL_REMITTANCE_BRAZIL') THEN
                      (SELECT listagg(DECODE(hcas.global_attribute2
                                           , '2',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'/'|| hcas.global_attribute4 ||'-'|| hcas.global_attribute5
                                           , '1',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'-'|| hcas.global_attribute5 
                                           , '3',HCSU.LOCATION||' - '||hcas.global_attribute3 ),', ' ON OVERFLOW TRUNCATE)
                       WITHIN GROUP (ORDER BY hcas.global_attribute2 asc )
                         FROM apps.ra_customer_trx_all         rcta
                            , apps.hz_cust_acct_sites_all      hcas
                            , apps.hz_cust_site_uses_all       hcsu
                        WHERE rcta.interface_header_attribute1 = mp.organization_code||'_'||mmt.transaction_reference
                          AND rcta.ship_to_site_use_id         = hcsu.site_use_id
                          AND hcsu.cust_acct_site_id           = hcas.cust_acct_site_id
                          AND rcta.org_id                      = 4330
                          AND ROWNUM = 1)
                   ELSE
                     --
                     CASE WHEN (select DISTINCT RCTL.INTERFACE_LINE_CONTEXT
                             FROM apps.hz_parties                hp
                                , apps.hz_cust_accounts          hca
                                , apps.oe_order_lines_all        oola
                                , apps.oe_order_headers_all      ooha
                                , apps.ra_customer_trx_lines_all rctl
                                , apps.ra_customer_trx_all       rcta
                                , apps.hz_cust_acct_sites_all    hcas
                                , apps.hz_cust_site_uses_all     hcsu
                            WHERE ooha.header_id                 = oola.header_id
                              AND oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND rctl.inventory_item_id         = oola.inventory_item_id
                              AND rctl.line_type                 = 'LINE'
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE1 = to_char(ooha.order_number)
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE6 = to_char(oola.line_id)
                              AND RCTL.INTERFACE_LINE_CONTEXT    = 'ORDER ENTRY'
                              AND rctl.customer_trx_id           = rcta.customer_trx_id
                              AND rcta.ship_to_site_use_id       = hcsu.site_use_id
                              AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                              AND hcas.cust_account_id           = hca.cust_account_id
                              AND hca.party_id                   = hp.party_id 
                              AND ROWNUM = 1) = 'ORDER ENTRY' THEN
                     --
                     (SELECT DISTINCT DECODE(hcas.global_attribute2
                                           , '2',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'/'|| hcas.global_attribute4 ||'-'|| hcas.global_attribute5
                                           , '1',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'-'|| hcas.global_attribute5 
                                           , '3',HCSU.LOCATION||' - '||hcas.global_attribute3)
                             FROM apps.hz_parties                hp
                                , apps.hz_cust_accounts          hca
                                , apps.oe_order_lines_all        oola
                                , apps.oe_order_headers_all      ooha
                                , apps.ra_customer_trx_lines_all rctl
                                , apps.ra_customer_trx_all       rcta
                                , apps.hz_cust_acct_sites_all    hcas
                                , apps.hz_cust_site_uses_all     hcsu
                            WHERE ooha.header_id                 = oola.header_id
                              AND oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND rctl.inventory_item_id         = oola.inventory_item_id
                              AND rctl.line_type                 = 'LINE'
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE1 = to_char(ooha.order_number)
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE6 = to_char(oola.line_id)
                              AND RCTL.INTERFACE_LINE_CONTEXT    = 'ORDER ENTRY'
                              AND rctl.customer_trx_id           = rcta.customer_trx_id
                              AND rcta.ship_to_site_use_id       = hcsu.site_use_id
                              AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                              AND hcas.cust_account_id           = hca.cust_account_id
                              AND hca.party_id                   = hp.party_id
                              AND ROWNUM = 1)
                     --
                     ELSE
                     --            
                     CASE WHEN 
                          ( SELECT DISTINCT RCTL.INTERFACE_LINE_CONTEXT
                             FROM apps.hz_parties                hp
                                , apps.hz_cust_accounts          hca
                                , apps.oe_order_lines_all        oola
                                , apps.oe_order_headers_all      ooha
                                , apps.ra_customer_trx_lines_all rctl
                                , apps.ra_customer_trx_all       rcta
                                , apps.hz_cust_acct_sites_all    hcas
                                , apps.hz_cust_site_uses_all     hcsu
                            WHERE ooha.header_id                 = oola.header_id
                              AND oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND rctl.inventory_item_id         = oola.inventory_item_id
                              AND rctl.line_type                 = 'LINE'
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE1 = ooha.ORIG_SYS_DOCUMENT_REF
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE7 = oola.ORIG_SYS_LINE_REF
                              AND RCTL.INTERFACE_LINE_CONTEXT    = 'GEMS_PB_RR'
                              AND rctl.customer_trx_id           = rcta.customer_trx_id
                              AND rcta.ship_to_site_use_id       = hcsu.site_use_id
                              AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                              AND hcas.cust_account_id           = hca.cust_account_id
                              AND ROWNUM = 1 ) = 'GEMS_PB_RR' THEN
                     --
                     (SELECT DISTINCT DECODE(hcas.global_attribute2
                                           , '2',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'/'|| hcas.global_attribute4 ||'-'|| hcas.global_attribute5
                                           , '1',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'-'|| hcas.global_attribute5 
                                           , '3',HCSU.LOCATION||' - '||hcas.global_attribute3)
                             FROM apps.hz_parties                hp
                                , apps.hz_cust_accounts          hca
                                , apps.oe_order_lines_all        oola
                                , apps.oe_order_headers_all      ooha
                                , apps.ra_customer_trx_lines_all rctl
                                , apps.ra_customer_trx_all       rcta
                                , apps.hz_cust_acct_sites_all    hcas
                                , apps.hz_cust_site_uses_all     hcsu
                            WHERE ooha.header_id                 = oola.header_id
                              AND oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND rctl.inventory_item_id         = oola.inventory_item_id
                              AND rctl.line_type                 = 'LINE'
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE1 = ooha.ORIG_SYS_DOCUMENT_REF
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE7 = oola.ORIG_SYS_LINE_REF
                              AND RCTL.INTERFACE_LINE_CONTEXT    = 'GEMS_PB_RR'
                              AND rctl.customer_trx_id           = rcta.customer_trx_id
                              AND rcta.ship_to_site_use_id       = hcsu.site_use_id
                              AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                              AND hcas.cust_account_id           = hca.cust_account_id 
                              AND ROWNUM = 1 )
                     --
                     ELSE
                     --
                     (SELECT listagg(DECODE(hcas.global_attribute2
                                           , '2',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'/'|| hcas.global_attribute4 ||'-'|| hcas.global_attribute5
                                           , '1',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'-'|| hcas.global_attribute5 
                                           , '3',HCSU.LOCATION||' - '||hcas.global_attribute3 ),', ' ON OVERFLOW TRUNCATE)
                      WITHIN GROUP (ORDER BY hcas.global_attribute2 asc) 
                         FROM apps.hz_parties             hp
                            , apps.hz_cust_accounts       hca
                            , apps.oe_order_lines_all     oola
                            , apps.hz_cust_acct_sites_all hcas
                            , apps.hz_cust_site_uses_all  hcsu
                        WHERE oola.line_id                = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                          AND oola.ship_to_org_id         = hcsu.site_use_id
                          AND hcsu.cust_acct_site_id      = hcas.cust_acct_site_id
                          AND hcas.cust_account_id        = hca.cust_account_id
                          AND hca.party_id                = hp.party_id  )
                     --
                     END
                  END
               END      ship_to_CNPJ_CPF
               --
              , CASE WHEN ( SELECT ottl.name
                              FROM apps.oe_transaction_types_tl    ottl
                                 , apps.oe_order_headers_all  ooha
                                 , apps.oe_order_lines_all    oola  
                             WHERE oola.line_id        = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                               AND oola.header_id      = ooha.header_id
                               AND ooha.order_type_id  = ottl.transaction_type_id  ) = 'GPO_BR_FE_SHIPMENT' THEN
                      (SELECT listagg(hzl.address1 ||' - '|| hzl.address2 || ' - ' || hzl.city || '-' || hzl.state || ' / ' || hzl.postal_code,', ' ON OVERFLOW TRUNCATE)  
                       WITHIN GROUP (ORDER BY hzl.address1 asc)
                       FROM apps.hz_parties             hp
                        , apps.hz_party_sites         hps
                        , apps.hz_cust_accounts       hca
                        , apps.oe_order_lines_all     oola
                        , apps.hz_cust_acct_sites_all hcas
                        , apps.hz_cust_site_uses_all  hcsu
                        , apps.hz_locations           hzl
                    WHERE oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                      AND oola.end_customer_site_use_id  = hcsu.site_use_id
                      AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                      AND hcas.cust_account_id           = hca.cust_account_id
                      AND hcas.party_site_id             = hps.party_site_id
                      AND hca.party_id                   = hp.party_id
                      AND hps.party_id                   = hp.party_id
                      AND hps.location_id                = hzl.location_id)
                ELSE
                   CASE WHEN (mmt.source_code = '3PL_REMITTANCE_BRAZIL') THEN
                      (SELECT listagg(hzl.address1 ||' - '|| hzl.address2 || ' - ' || hzl.city || '-' || hzl.state || ' / ' || hzl.postal_code,', ' ON OVERFLOW TRUNCATE)  
                       WITHIN GROUP (ORDER BY hzl.address1 asc)
                         FROM apps.ra_customer_trx_all     rcta
                            , apps.hz_cust_acct_sites_all  hcas
                            , apps.hz_cust_site_uses_all   hcsu
                            , apps.hz_parties              hp
                            , apps.hz_party_sites          hps
                            , apps.hz_cust_accounts        hca
                            , apps.hz_locations            hzl
                        WHERE rcta.interface_header_attribute1 = mp.organization_code||'_'||mmt.transaction_reference
                          AND rcta.ship_to_site_use_id         = hcsu.site_use_id
                          AND hcsu.cust_acct_site_id           = hcas.cust_acct_site_id
                          AND hcas.cust_account_id             = hca.cust_account_id
                          AND hcas.party_site_id               = hps.party_site_id
                          AND hca.party_id                     = hp.party_id
                          AND hps.party_id                     = hp.party_id
                          AND hps.location_id                  = hzl.location_id
                          AND rcta.org_id                      = 4330)
                   ELSE
                      (SELECT listagg(hzl.address1 ||' - '|| hzl.address2 || ' - ' || hzl.city || '-' || hzl.state || ' / ' || hzl.postal_code,', ' ON OVERFLOW TRUNCATE)  
                       WITHIN GROUP (ORDER BY hzl.address1 asc)
                          FROM apps.hz_parties             hp
                             , apps.hz_party_sites         hps
                             , apps.hz_cust_accounts       hca
                             , apps.oe_order_lines_all     oola
                             , apps.hz_cust_acct_sites_all hcas
                             , apps.hz_cust_site_uses_all  hcsu
                             , apps.hz_locations           hzl
                         WHERE oola.line_id                = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                           AND oola.ship_to_org_id         = hcsu.site_use_id
                           AND hcsu.cust_acct_site_id      = hcas.cust_acct_site_id
                           AND hcas.cust_account_id        = hca.cust_account_id
                           AND hcas.party_site_id          = hps.party_site_id
                           AND hca.party_id                = hp.party_id
                           AND hps.party_id                = hp.party_id
                           AND hps.location_id             = hzl.location_id   )
                   END
                END customer_address
                -- 
                -- alterado para BIll_to por Sinval fim
                --
              , CASE WHEN (mmt.source_code = '3PL_REMITTANCE_BRAZIL') THEN
                   (SELECT listagg(rcta.trx_number,', ' ON OVERFLOW TRUNCATE)  
                           WITHIN GROUP (ORDER BY rcta.trx_number asc)
                      FROM apps.ra_customer_trx_all       rcta
                     WHERE rcta.interface_header_attribute1  = mp.organization_code||'_'||mmt.transaction_reference
                       AND rcta.org_id                       = 4330
                       AND NVL(rcta.status_trx,'XX')         <> 'VD'
                       AND NVL(rcta.reason_code,'XX')        <> 'CANCELLATION')
                ELSE
                   (SELECT distinct RTRIM(REGEXP_REPLACE((listagg(rcta.trx_number,', ' ON OVERFLOW TRUNCATE)  
                      WITHIN GROUP (ORDER BY rcta.trx_number asc) ), '([^,]*)(,\1)+($|,)', '\1\3'),',')
                      FROM apps.ra_customer_trx_lines_all rctla
                         , apps.ra_customer_trx_all       rcta
                         , apps.oe_order_lines_all        oola
                         , apps.oe_order_headers_all      ooha
                     WHERE rcta.customer_trx_id              = rctla.customer_trx_id
                       AND oola.line_id                      = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                       AND oola.header_id                    = ooha.header_id
                       AND rctla.sales_order                 = to_char(ooha.order_number)
                       AND rctla.line_type                   = 'LINE'
                       AND rcta.batch_source_id              <> 6266 -- No RR invoices
                       AND DECODE(rctla.interface_line_context,'GEMS_PB_RR',rcta.interface_header_attribute11,'999')
                           = DECODE(rctla.interface_line_context,'GEMS_PB_RR',rcta.interface_header_attribute11,'999')
                       AND rcta.org_id                       = 4330
                       AND trunc(rcta.trx_date)              BETWEEN (trunc(mmt.transaction_date)-3) AND (trunc(mmt.transaction_date)+3)
                       AND NVL(rcta.status_trx,'XX')         <> 'VD'
                       AND NVL(rcta.reason_code,'XX')        <> 'CANCELLATION')   
                END   invoice_number_ar
              , ( SELECT listagg(mrav.reservation_quantity,', ' ON OVERFLOW TRUNCATE)  
                  WITHIN GROUP (ORDER BY mrav.reservation_quantity asc)
                    FROM apps.mtl_reservations_all_v  mrav 
                       , apps.oe_order_headers_all    ooha1
                   WHERE mrav.demand_source_header_id     = ooha1.header_id
                     AND mrav.demand_source_line_id       = NVL(mmt.trx_source_line_id, mmt.source_line_id) )  reservation_quantity
              , ( SELECT listagg(ooha1.order_number,', ' ON OVERFLOW TRUNCATE)  
                  WITHIN GROUP (ORDER BY ooha1.order_number asc) 
                    FROM apps.mtl_reservations_all_v  mrav 
                       , apps.oe_order_headers_all    ooha1
                   WHERE mrav.demand_source_header_id     = ooha1.header_id
                     AND mrav.demand_source_line_id       = NVL(mmt.trx_source_line_id, mmt.source_line_id) )  reservation_order_number
              , (SELECT distinct hp.party_name
                 --WITHIN GROUP (ORDER BY hp.party_name asc)
                   FROM apps.hz_parties              hp
                      , apps.hz_cust_accounts        hca
                      , apps.oe_order_lines_all      oola1
                      , apps.oe_order_headers_all    ooha1
                      , apps.mtl_reservations_all_v  mrav 
                  WHERE mrav.demand_source_header_id   = ooha1.header_id
                    AND mrav.demand_source_line_id     = oola1.line_id
                    AND oola1.line_id                  = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                    AND oola1.ship_to_org_id           = hca.cust_account_id
                    AND hca.party_id                   = hp.party_id )         reservation_customer_name 
              , gcc1.concatenated_segments   material_account
              , gcc2.concatenated_segments   outside_processing_account
              , gcc3.concatenated_segments   material_overhead_account
              , gcc4.concatenated_segments   overhead_account
              , gcc5.concatenated_segments   resource_account
              , sysdate                                           report_date_and_time 
              , to_char(mmt.transaction_id)
              , fu.user_name ||' / '|| fu.description             user_name
              , DECODE( lot_control_code, 1 ,'Sem controle de Lote' , 2,'Com controle de Lote')   lot_control
              , DECODE( serial_number_control_code, 1, 'Sem controle de Serial'
                                                  , 2, 'Pre-definido'
                                                  , 5, 'No Recebimento'
                                                  , 6, 'Baixa na Ordem de Venda' )  serial_control
              , CASE
                 WHEN    nvl(mmt.lpn_id, mmt.content_lpn_id) IS NULL AND moq.subinventory_code <> 'WHGU42GNAT'
                   THEN
                   (SELECT listagg(lpn.license_plate_number,', ' ON OVERFLOW TRUNCATE)WITHIN GROUP (ORDER BY lpn.license_plate_number asc)
                             FROM apps.MTL_MATERIAL_TRANSACTIONS   mtt,
                                  apps.wms_license_plate_numbers   lpn,
                                  apps.oe_order_lines_all          ool
                            WHERE 1 = 1
                              AND mtt.TRX_SOURCE_LINE_ID = CASE
                                                              WHEN LINE_CATEGORY_CODE = 'ORDER'
                                                                THEN ool.line_id
                                                              WHEN LINE_CATEGORY_CODE = 'RETURN'  
                                                                THEN   
                                                                to_number(NVL(SUBSTR(ool.ORIG_SYS_LINE_REF,
                                                                                     0,
                                                                                     INSTR(ool.ORIG_SYS_LINE_REF, '.') - 1),
                                                                              -1)) -- RMA FE OE Line Id
                                                                ELSE -1
                                                                  END
                              AND mtt.TRANSACTION_TYPE_ID = 52 --sales order pick FE ORDER
                              AND mtt.transaction_quantity < 0
                              AND mtt.inventory_item_id = ool.inventory_item_id
                              AND nvl(mtt.lpn_id, mtt.content_lpn_id) = nvl(lpn.lpn_id, -1)
                              AND ool.line_id = CASE
                                                  WHEN mtt.transaction_type_name = 'RMA Receipt'
                                                    THEN mmt.TRX_SOURCE_LINE_ID
                                                  WHEN mtt.transaction_type_name = 'GPO Nationalization Receipt'
                                                     THEN 
                                                      to_number(NVL(SUBSTR(RTRIM(LTRIM(translate(mmt.TRANSACTION_REFERENCE,translate(mmt.TRANSACTION_REFERENCE||'a','1234567890.',' '),' '))),
                                                         0,
                                                         INSTR(RTRIM(LTRIM(translate(mmt.TRANSACTION_REFERENCE,translate(mmt.TRANSACTION_REFERENCE||'a','1234567890.',' '),' '))), '.') - 1),
                                                  -1))
                                                  ELSE -1
                                                    END)
                              WHEN moq.subinventory_code = 'WHGU42GNAT'
                  THEN (SELECT listagg(wlp.license_plate_number,', ' ON OVERFLOW TRUNCATE)  
                            WITHIN GROUP (ORDER BY wlp.license_plate_number asc)
                        FROM   gems_ont.ge_gpo_nationalization_line gnl, 
                               gems_ont.ge_gpo_nationalization_line gn2,
                               apps.wms_license_plate_numbers       wlp,
                               apps.po_line_locations_all           pll,
                               apps.po_lines_all                    pol,
                               apps.po_headers_all                  poh,
                               apps.rcv_shipment_headers            rsh,
                               apps.rcv_transactions                rt
                        Where  wlp.lpn_id(+) = gn2.lpn_id
                        AND gnl.nationalization_so_line_id = gn2.nationalization_so_line_id
                        AND pll.line_location_id = gnl.DOCUMENT_ID
                        AND pll.po_header_id = poh.po_header_id
                        AND pll.po_line_id = pol.po_line_id
                        AND gn2.record_type = 'IMPORT'
                        AND gnl.record_type = 'NATIONALIZATION'
                        AND rt.transaction_id                = mmt.rcv_transaction_id
                        AND rt.po_line_location_id           = pll.line_location_id
                        AND rt.shipment_header_id            = rsh.shipment_header_id)
                   ELSE (SELECT lpn.LICENSE_PLATE_NUMBER
                           FROM   apps.wms_license_plate_numbers   lpn
                           WHERE  nvl(mmt.lpn_id, mmt.content_lpn_id) = nvl(lpn.lpn_id, -1))
                        END LPN_Value                                    
             , 'q4' query
--, mmt.transaction_type_id
--, mmt.trx_source_line_id
--, mmt.source_line_id
           FROM apps.mtl_parameters                  mp
              , apps.mtl_system_items_b              msi
              , apps.mtl_item_locations_kfv          milk
              , apps.gl_code_combinations            gcc
              , apps.gl_code_combinations_kfv        gcc1
              , apps.gl_code_combinations_kfv        gcc2
              , apps.gl_code_combinations_kfv        gcc3
              , apps.gl_code_combinations_kfv        gcc4
              , apps.gl_code_combinations_kfv        gcc5
              , AMARCHIVE.MTL_MATERIAL_TRANSACTIONS       mmt
              , apps.mtl_transaction_types           mtt
              , apps.mtl_txn_source_types            mtst
              , apps.mtl_secondary_inventories_fk_v  msifv
              , apps.fnd_flex_values_vl              ffvv
              , apps.fnd_flex_value_sets             ffvs
              , apps.fnd_user                        fu
              , ( SELECT organization_id
                       , inventory_item_id
                       , subinventory_code
                       , locator_id
                       , lot_number
                       , create_transaction_id
                       --, transaction_uom_code
                       , SUM (primary_transaction_quantity)  onhand_qty
                    FROM apps.mtl_onhand_quantities_detail
                   WHERE organization_id IN ( SELECT ood.ORGANIZATION_id FROM apps.org_organization_definitions ood WHERE ood.SET_OF_BOOKS_ID = 230 )
                GROUP BY organization_id
                       , inventory_item_id
                       , subinventory_code
                       , locator_id
                     --  , revision
                       , lot_number
                       , create_transaction_id
                       --, transaction_uom_code
                       ) moq
                       ,APPS.MTL_PAC_ACTUAL_COST_DETAILS MPACD 
          WHERE 1                                = 1
          AND decode(mmt.periodic_primary_quantity,null,mmt.transfer_transaction_id,MMT.TRANSACTION_ID) = MPACD.TRANSACTION_ID  
            AND mp.organization_id               = msi.organization_id
--            AND msi.segment1 = '60510302'
            AND msifv.organization_id            = msi.organization_id
            AND msifv.secondary_inventory_name   = moq.subinventory_code
            AND msifv.material_account           = gcc1.code_combination_id
            AND msifv.outside_processing_account = gcc2.code_combination_id
            AND msifv.material_overhead_account  = gcc3.code_combination_id
            AND msifv.overhead_account           = gcc4.code_combination_id
            AND msifv.resource_account           = gcc5.code_combination_id
            AND msi.cost_of_sales_account        = gcc.code_combination_id
           AND ffvs.flex_value_set_name         = 'GE_GL_AFF_ES_PRODUCT_LINE'
            AND ffvs.flex_value_set_id           = ffvv.flex_value_set_id
            AND ffvv.flex_value_meaning          = gcc.segment8
            AND 'TYPE 1'                        IN ('TYPE 1')
            AND msi.organization_id             IN ( SELECT ood.organization_id FROM apps.org_organization_definitions ood WHERE ood.SET_OF_BOOKS_ID = 230 )
            AND moq.inventory_item_id            = mmt.inventory_item_id    
            AND moq.organization_id              = mmt.organization_id      
            AND moq.subinventory_code            = mmt.subinventory_code    
            AND moq.locator_id                   = mmt.locator_id           
            AND moq.inventory_item_id            = msi.inventory_item_id
            AND moq.locator_id                   = milk.inventory_location_id
            AND moq.organization_id              = mp.organization_id
            AND moq.create_transaction_id        = mmt.transaction_id  
--    AND MMT.TRANSACTION_ID = 2562828197
            AND mtt.transaction_type_id          = mmt.transaction_type_id 
            AND mtst.transaction_source_type_id  = mmt.transaction_source_type_id
            AND fu.user_id                       = mmt.created_by
            AND msi.serial_number_control_code  NOT IN ('1','6')   --
            AND msi.lot_control_code            <> '2' ------------- Ajustado para n?conflitar com a query 17 e 18 - Sinval 17/02
            AND moq.locator_id              NOT IN (SELECT locator_id 
                                                      FROM apps.mtl_onhand_serial_mwb_v 
                                                     WHERE organization_id   = moq.organization_id
                                                       AND subinventory_code = moq.subinventory_code 
                                                       AND inventory_item_id = moq.inventory_item_id)
    AND MMT.TRANSACTION_ID NOT IN(SELECT MMT2.TRANSACTION_ID 
                                  FROM APPS.MTL_MATERIAL_TRANSACTIONS MMT2
                                  WHERE MMT2.TRANSACTION_ID = MMT.TRANSACTION_ID)
----------------------------------------------------------------------------- LOTE COM SERIAL NULO
UNION  
------------------------------------------------------------------------------  
-- Com controle de Lote, sem controle de serial ( 1,6 )
         SELECT DISTINCT  --'5' NUM
        /* ( SELECT ccg.cost_group 
                             FROM apps.cst_cost_groups            ccg
                                , apps.cst_cost_group_assignments ccga
                            WHERE ccga.cost_group_id     = ccg.cost_group_id
                              AND ccga.organization_id   = mp.organization_id )  cost_group*/
            ( SELECT ccg.cost_group 
                             FROM apps.cst_cost_groups            ccg
                            WHERE MPACD.cost_group_id     = ccg.cost_group_id )  cost_group  
              , ( SELECT ( SELECT cpp1.period_name 
                             FROM apps.cst_pac_item_costs   cst
                                , apps.cst_pac_periods      cpp1
                            WHERE cst.pac_period_id     = (SELECT MAX(PAC_PERIOD_ID)                   FROM APPS.CST_PAC_PERIODS                  WHERE LEGAL_ENTITY = (SELECT LEGAL_ENTITY                                          FROM APPS.ORG_ORGANIZATION_DEFINITIONS OOD                                         WHERE OOD.ORGANIZATION_ID = mp.organization_id                                         ) )
                              AND cst.pac_period_id     = cpp1.pac_period_id
                              AND cst.inventory_item_id = msi.inventory_item_id
                              AND cst.cost_group_id     = ccg.cost_group_id )  
                    FROM apps.cst_cost_groups            ccg
                       , apps.cst_cost_group_assignments ccga
                   WHERE ccga.cost_group_id     = ccg.cost_group_id
                     AND ccga.organization_id   = mp.organization_id ) period_name
              , mp.organization_code
              , mp.attribute7                organization_type
              , mp.organization_id 
              , moq.subinventory_code
              , msifv.description            subinv_description
              , milk.concatenated_segments   locators
              , DECODE( msifv.asset_inventory, 1 , 'Asset', 2, 'Non Asset')   asset_type
              , msi.segment1                 part_number
              , DECODE(msi.inventory_asset_flag, NULL, 'No', 'N', 'No', 'Y', 'Yes')                         flag_asset_inventory
              , DECODE(msi.costing_enabled_flag, NULL, 'No', 'N', 'No', 'Y', 'Yes')                         flag_de_custo
              , msi.description              descrip_eng
              , msi.attribute3               descrip_ptb
              , msi.creation_date            item_creation_date
              , (trunc(SYSDATE) - trunc(msi.creation_date))      days_from_creation
              , gcc.segment8                                     product_line
              , ffvv.description                                 desc_prod_line   
              , msi.primary_uom_code    uom
              , moq.onhand_qty                                   transaction_quantity
              , NVL(( SELECT cic.item_cost
                        FROM apps.cst_item_costs cic
                       WHERE cic.organization_id   = msi.organization_id
                         AND cic.inventory_item_id = msi.inventory_item_id
                         AND cic.cost_type_id      = 1 ),0)  custo_unit_inv
              /*, nvl(( SELECT ( SELECT ROUND (cst.item_cost,2) 
                                 FROM apps.cst_pac_item_costs   cst
                                WHERE cst.pac_period_id     = (SELECT MAX(PAC_PERIOD_ID)                   FROM APPS.CST_PAC_PERIODS                  WHERE LEGAL_ENTITY = (SELECT LEGAL_ENTITY                                          FROM APPS.ORG_ORGANIZATION_DEFINITIONS OOD                                         WHERE OOD.ORGANIZATION_ID = mp.organization_id                                         ) )
                                  AND cst.inventory_item_id = msi.inventory_item_id
                                  AND cst.cost_group_id     = ccg.cost_group_id )  item_cost
                        FROM apps.cst_cost_groups            ccg
                           , apps.cst_cost_group_assignments ccga
                       WHERE ccga.cost_group_id     = ccg.cost_group_id
                         AND ccga.organization_id   = mp.organization_id ) ,0) custo_unit_pac*/
                , nvl((SELECT ROUND (cst.item_cost,2) 
                       FROM apps.cst_pac_item_costs   cst
                      WHERE cst.pac_period_id     = (SELECT MAX(PAC_PERIOD_ID)                   
                                                                FROM APPS.CST_PAC_PERIODS                  
                                                                WHERE LEGAL_ENTITY = (SELECT LEGAL_ENTITY                                         
                                                                                        FROM APPS.ORG_ORGANIZATION_DEFINITIONS OOD                                        
                                                                                        WHERE OOD.ORGANIZATION_ID = mp.organization_id
                                                        ) )
                        AND cst.inventory_item_id = msi.inventory_item_id
                        AND cst.cost_group_id     = MPACD.cost_group_id),0)  custo_unit_pac
              , moq.lot_number
              , ( SELECT mln.creation_date        
                    FROM apps.mtl_lot_numbers              mln
                   WHERE mln.lot_number           = moq.lot_number
                     AND mln.inventory_item_id    = msi.inventory_item_id
                     AND mln.organization_id      = mp.organization_id  )  lot_creation_date
              , NULL   lot_qty_days_creation
              , ( SELECT mln.expiration_date         
                    FROM apps.mtl_lot_numbers              mln
                   WHERE mln.lot_number           = moq.lot_number
                     AND mln.inventory_item_id    = msi.inventory_item_id
                     AND mln.organization_id      = mp.organization_id  )  lot_expiration_date
              , NULL  serial_number
              , NULL  serial_creation_date
              , mtt.transaction_type_name           last_transaction_type
              , mmt.transaction_source_name         last_transaction_source
              , mtst.transaction_source_type_name   last_source_type
              , mmt.source_code
              , TO_CHAR(mmt.transaction_date, 'DD-MON-RRRR')      transaction_date
        , (SELECT TO_CHAR(mmt1.transaction_date, 'DD-MON-RRRR') 
                    FROM apps.mtl_material_transactions mmt1
                    WHERE mmt1.transaction_type_id=420
                    AND mmt1.source_line_id=mmt.source_line_id) initial_consignment_date        
              , (TRUNC ( SYSDATE )- TRUNC(mmt.transaction_date))  transaction_qty_of_days
              , TO_CHAR(mmt.transaction_reference)                transaction_reference
              , CASE WHEN mmt.source_code = '3PL_REMITTANCE_BRAZIL' THEN
                     (SELECT listagg(pha.segment1,', ' ON OVERFLOW TRUNCATE)  
                      WITHIN GROUP (ORDER BY pha.segment1 asc)
                        FROM apps.po_headers_all        pha,
                             apps.po_lines_all          pla
                       WHERE pla.po_line_id   = mmt.source_line_id
                         AND pla.po_header_id = pha.po_header_id)
                     WHEN mmt.source_code IN ('ORDER ENTRY','IIP') THEN
                        NULL
                     WHEN mmt.source_code = 'RCV' THEN
                        ( SELECT listagg(pha.segment1,', ' ON OVERFLOW TRUNCATE)  
                          WITHIN GROUP (ORDER BY pha.segment1 asc)
                            FROM apps.po_headers_all            pha
                               , apps.po_lines_all              pla
                               , apps.po_line_locations_all     plla
                               , apps.rcv_shipment_headers      rsh
                               , apps.rcv_transactions          rt
                           WHERE rt.transaction_id                = mmt.rcv_transaction_id
                             AND rt.po_line_location_id           = plla.line_location_id
                             AND plla.po_line_id                  = pla.po_line_id
                             AND pha.po_header_id                 = pla.po_header_id
                             AND rt.shipment_header_id            = rsh.shipment_header_id
                             AND rsh.receipt_source_code          = 'VENDOR'  )
                     ELSE
                        NULL
                END      po_number
              , CASE WHEN mmt.source_code = '3PL_REMITTANCE_BRAZIL' THEN
                     (SELECT listagg(aps.vendor_name,', ' ON OVERFLOW TRUNCATE)  
                      WITHIN GROUP (ORDER BY aps.vendor_name asc)
                        FROM apps.po_headers_all        pha
                           , apps.po_lines_all          pla
                           , apps.ap_suppliers          aps
                           , apps.ap_supplier_sites_all  apss
                       WHERE pla.po_line_id     = mmt.source_line_id
                         AND pla.po_header_id   = pha.po_header_id
                         AND pha.vendor_id      = aps.vendor_id
                         AND aps.vendor_id      = apss.vendor_id
                         AND pha.vendor_site_id = apss.vendor_site_id )
                     WHEN mmt.source_code IN ('ORDER ENTRY','IIP') THEN
                        NULL
                     WHEN mmt.source_code = 'RCV' THEN
                        ( SELECT listagg(aps.vendor_name,', ' ON OVERFLOW TRUNCATE)  
                          WITHIN GROUP (ORDER BY aps.vendor_name asc)
                            FROM apps.po_headers_all            pha
                               , apps.po_lines_all              pla
                               , apps.po_line_locations_all     plla
                               , apps.rcv_shipment_headers      rsh
                               , apps.rcv_transactions          rt
                               , apps.ap_suppliers              aps
                               , apps.ap_supplier_sites_all     apss
                           WHERE rt.transaction_id          = mmt.rcv_transaction_id
                             AND rt.po_line_location_id     = plla.line_location_id
                             AND plla.po_line_id            = pla.po_line_id
                             AND pha.po_header_id           = pla.po_header_id
                             AND rt.shipment_header_id      = rsh.shipment_header_id
                             AND rsh.receipt_source_code    = 'VENDOR'
                             AND pha.vendor_id              = aps.vendor_id
                             AND aps.vendor_id              = apss.vendor_id
                             AND pha.vendor_site_id         = apss.vendor_site_id  )
                     ELSE
                        NULL
                END     po_supplier
              , CASE WHEN mmt.source_code = '3PL_REMITTANCE_BRAZIL' THEN
                     ( SELECT listagg(cfi.invoice_num,', ' ON OVERFLOW TRUNCATE)  
                         WITHIN GROUP (ORDER BY cfi.invoice_num asc)
                         FROM apps.cll_f189_invoice_lines cfil
                            , apps.cll_f189_invoices      cfi
                            , apps.po_lines_all           pla
                            , apps.po_line_locations_all  plla
                        WHERE plla.po_line_id       = pla.po_line_id
                          AND pla.po_line_id        = mmt.source_line_id
                          AND plla.line_location_id = cfil.line_location_id
                          AND cfil.invoice_id       = cfi.invoice_id )
                     WHEN mmt.source_code IN ('ORDER ENTRY','IIP') THEN
                        NULL
                     WHEN mmt.source_code = 'RCV' THEN
                        ( SELECT listagg(cfi.invoice_num,', ' ON OVERFLOW TRUNCATE)  
                            WITHIN GROUP (ORDER BY cfi.invoice_num asc)
                            FROM apps.po_headers_all            pha
                               , apps.po_lines_all              pla
                               , apps.po_line_locations_all     plla
                               , apps.cll_f189_invoice_lines    cfil
                               , apps.cll_f189_invoices         cfi
                               , apps.rcv_shipment_headers      rsh
                               , apps.rcv_transactions          rt
                           WHERE rt.transaction_id          = mmt.rcv_transaction_id
                             AND rt.po_line_location_id     = plla.line_location_id
                             AND plla.line_location_id      = cfil.line_location_id
                             AND cfil.invoice_id            = cfi.invoice_id
                             AND plla.po_line_id            = pla.po_line_id
                             AND pha.po_header_id           = pla.po_header_id
                             AND rt.shipment_header_id      = rsh.shipment_header_id
                             AND rsh.receipt_source_code    = 'VENDOR'   )
                     ELSE
                        NULL
                END    NF_RI
             , (SELECT DECODE( mmt.source_code, '3PL_REMITTANCE_BRAZIL',NULL,to_char(ooha.order_number) )
                  FROM apps.oe_order_headers_all  ooha,
                       apps.oe_order_lines_all    oola  
                 WHERE oola.line_id        = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                   AND oola.header_id      = ooha.header_id )   order_number
               -- 
               -- alterado para BIll_to por Sinval inicio
               --
               , CASE WHEN ( SELECT ottl.name
                             FROM apps.oe_transaction_types_tl    ottl
                                , apps.oe_order_headers_all  ooha
                                , apps.oe_order_lines_all    oola  
                            WHERE oola.line_id        = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND oola.header_id      = ooha.header_id
                              AND ooha.order_type_id  = ottl.transaction_type_id  ) = 'GPO_BR_FE_SHIPMENT' THEN
                     (SELECT listagg(hp.party_name,', ' ON OVERFLOW TRUNCATE)  
                      WITHIN GROUP (ORDER BY hp.party_name asc)
                        FROM apps.hz_parties             hp
                           , apps.hz_cust_accounts       hca
                           , apps.oe_order_lines_all     oola
                           , apps.hz_cust_acct_sites_all hcas
                           , apps.hz_cust_site_uses_all  hcsu
                       WHERE oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                         AND oola.end_customer_site_use_id  = hcsu.site_use_id
                         AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                         AND hcas.cust_account_id           = hca.cust_account_id
                         AND hca.party_id                   = hp.party_id )
                  ELSE
                     CASE WHEN (mmt.source_code = '3PL_REMITTANCE_BRAZIL') THEN
                       (SELECT listagg(hp.party_name,', ' ON OVERFLOW TRUNCATE)  
                        WITHIN GROUP (ORDER BY hp.party_name asc)
                          FROM apps.hz_parties             hp,
                               apps.hz_cust_accounts       hca,
                               apps.ra_customer_trx_all    rcta,
                               apps.hz_cust_acct_sites_all hcas,
                               apps.hz_cust_site_uses_all  hcsu
                         WHERE rcta.interface_header_attribute1 = mp.organization_code||'_'||mmt.transaction_reference
                           AND rcta.ship_to_site_use_id         = hcsu.site_use_id
                           AND hcsu.cust_acct_site_id           = hcas.cust_acct_site_id
                           AND hcas.cust_account_id             = hca.cust_account_id
                           AND hca.party_id                     = hp.party_id
                           AND rcta.org_id                      = 4330)
                     ELSE
                        (SELECT listagg(hp.party_name,', ' ON OVERFLOW TRUNCATE)  
                         WITHIN GROUP (ORDER BY hp.party_name asc)
                           FROM apps.hz_parties             hp
                              , apps.hz_cust_accounts       hca
                              , apps.oe_order_lines_all     oola
                              , apps.hz_cust_acct_sites_all hcas
                              , apps.hz_cust_site_uses_all  hcsu
                          WHERE oola.line_id                = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                            AND oola.ship_to_org_id         = hcsu.site_use_id
                            AND hcsu.cust_acct_site_id      = hcas.cust_acct_site_id
                            AND hcas.cust_account_id        = hca.cust_account_id
                            AND hca.party_id                = hp.party_id )
                    END                 
               END    customer_name
             , CASE WHEN ( SELECT ottl.name
                             FROM apps.oe_transaction_types_tl    ottl
                                , apps.oe_order_headers_all  ooha
                                , apps.oe_order_lines_all    oola  
                            WHERE oola.line_id        = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND oola.header_id      = ooha.header_id
                              AND ooha.order_type_id  = ottl.transaction_type_id  ) = 'GPO_BR_FE_SHIPMENT' THEN
                     (SELECT listagg(hca.account_number,', ' ON OVERFLOW TRUNCATE)  
                      WITHIN GROUP (ORDER BY hca.account_number asc)
                        FROM apps.hz_parties             hp
                           , apps.hz_cust_accounts       hca
                           , apps.oe_order_lines_all     oola
                           , apps.hz_cust_acct_sites_all hcas
                           , apps.hz_cust_site_uses_all  hcsu
                       WHERE oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                         AND oola.end_customer_site_use_id  = hcsu.site_use_id
                         AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                         AND hcas.cust_account_id           = hca.cust_account_id
                         AND hca.party_id                   = hp.party_id )
                  ELSE
                     CASE WHEN (mmt.source_code = '3PL_REMITTANCE_BRAZIL') THEN
                        (SELECT listagg(hca.account_number,', ' ON OVERFLOW TRUNCATE)  
                         WITHIN GROUP (ORDER BY hca.account_number asc)
                           FROM apps.hz_parties             hp,
                                apps.hz_cust_accounts       hca,
                                apps.ra_customer_trx_all    rcta,
                                apps.hz_cust_acct_sites_all hcas,
                                apps.hz_cust_site_uses_all  hcsu
                          WHERE rcta.interface_header_attribute1 = mp.organization_code||'_'||mmt.transaction_reference
                            AND rcta.ship_to_site_use_id         = hcsu.site_use_id
                            AND hcsu.cust_acct_site_id           = hcas.cust_acct_site_id
                            AND hcas.cust_account_id             = hca.cust_account_id
                            AND hca.party_id                     = hp.party_id
                            AND rcta.org_id                      = 4330)
                     ELSE
                        (SELECT listagg(hca.account_number,', ' ON OVERFLOW TRUNCATE)  
                         WITHIN GROUP (ORDER BY hca.account_number asc)
                           FROM apps.hz_parties             hp
                              , apps.hz_cust_accounts       hca
                              , apps.oe_order_lines_all     oola
                              , apps.hz_cust_acct_sites_all hcas
                              , apps.hz_cust_site_uses_all  hcsu
                          WHERE oola.line_id                = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                            AND oola.ship_to_org_id         = hcsu.site_use_id
                            AND hcsu.cust_acct_site_id      = hcas.cust_acct_site_id
                            AND hcas.cust_account_id        = hca.cust_account_id
                            AND hca.party_id                = hp.party_id   )
                     END
                  END   customer_number
              --
              , CASE WHEN ( SELECT ottl.name
                             FROM apps.oe_transaction_types_tl    ottl
                                , apps.oe_order_headers_all  ooha
                                , apps.oe_order_lines_all    oola  
                            WHERE oola.line_id        = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND oola.header_id      = ooha.header_id
                              AND ooha.order_type_id  = ottl.transaction_type_id  ) = 'GPO_BR_FE_SHIPMENT' THEN
                     (SELECT listagg(DECODE(hcas.global_attribute2
                                           , '2',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'/'|| hcas.global_attribute4 ||'-'|| hcas.global_attribute5
                                           , '1',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'-'|| hcas.global_attribute5 
                                           , '3',HCSU.LOCATION||' - '||hcas.global_attribute3 ),', ' ON OVERFLOW TRUNCATE)
                     WITHIN GROUP (ORDER BY hcas.global_attribute2 asc ) 
                        FROM apps.hz_parties             hp
                           , apps.hz_cust_accounts       hca
                           , apps.oe_order_lines_all     oola
                           , apps.hz_cust_acct_sites_all hcas
                           , apps.hz_cust_site_uses_all  hcsu
                       WHERE oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                         AND oola.end_customer_site_use_id  = hcsu.site_use_id
                         AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                         AND hcas.cust_account_id           = hca.cust_account_id
                         AND hca.party_id                   = hp.party_id )
                ELSE
                   CASE WHEN (mmt.source_code = '3PL_REMITTANCE_BRAZIL') THEN
                      (SELECT listagg(DECODE(hcas.global_attribute2
                                           , '2',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'/'|| hcas.global_attribute4 ||'-'|| hcas.global_attribute5
                                           , '1',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'-'|| hcas.global_attribute5 
                                           , '3',HCSU.LOCATION||' - '||hcas.global_attribute3 ),', ' ON OVERFLOW TRUNCATE)
                     WITHIN GROUP (ORDER BY hcas.global_attribute2 asc) 
                         FROM apps.ra_customer_trx_all     rcta
                            , apps.hz_cust_acct_sites_all  hcas
                            , apps.hz_cust_site_uses_all   hcsu
                        WHERE rcta.interface_header_attribute1 = mp.organization_code||'_'||mmt.transaction_reference
                          AND rcta.ship_to_site_use_id         = hcsu.site_use_id
                          AND hcsu.cust_acct_site_id           = hcas.cust_acct_site_id
                          AND rcta.org_id                      = 4330)
                   ELSE
                     (SELECT listagg(DECODE(hcas.global_attribute2
                                           , '2',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'/'|| hcas.global_attribute4 ||'-'|| hcas.global_attribute5
                                           , '1',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'-'|| hcas.global_attribute5 
                                           , '3',HCSU.LOCATION||' - '||hcas.global_attribute3 ),', ' ON OVERFLOW TRUNCATE)
                      WITHIN GROUP (ORDER BY hcas.global_attribute2 asc) 
                         FROM apps.hz_parties             hp
                            , apps.hz_cust_accounts       hca
                            , apps.oe_order_lines_all     oola
                            , apps.hz_cust_acct_sites_all hcas
                            , apps.hz_cust_site_uses_all  hcsu
                        WHERE oola.line_id                = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                          AND oola.ship_to_org_id         = hcsu.site_use_id
                          AND hcsu.cust_acct_site_id      = hcas.cust_acct_site_id
                          AND hcas.cust_account_id        = hca.cust_account_id
                          AND hca.party_id                = hp.party_id  )
                   END
                END  customer_cnpj_cpf
               -- 
              , CASE WHEN (mmt.source_code = '3PL_REMITTANCE_BRAZIL') THEN
                      (SELECT listagg(DECODE(hcas.global_attribute2
                                           , '2',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'/'|| hcas.global_attribute4 ||'-'|| hcas.global_attribute5
                                           , '1',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'-'|| hcas.global_attribute5 
                                           , '3',HCSU.LOCATION||' - '||hcas.global_attribute3 ),', ' ON OVERFLOW TRUNCATE)
                       WITHIN GROUP (ORDER BY hcas.global_attribute2 asc )
                         FROM apps.ra_customer_trx_all         rcta
                            , apps.hz_cust_acct_sites_all      hcas
                            , apps.hz_cust_site_uses_all       hcsu
                        WHERE rcta.interface_header_attribute1 = mp.organization_code||'_'||mmt.transaction_reference
                          AND rcta.bill_to_site_use_id         = hcsu.site_use_id
                          AND hcsu.cust_acct_site_id           = hcas.cust_acct_site_id
                          AND rcta.org_id                      = 4330
                          AND ROWNUM = 1)
                   ELSE
                     --
                     CASE WHEN (select DISTINCT RCTL.INTERFACE_LINE_CONTEXT
                             FROM apps.hz_parties                hp
                                , apps.hz_cust_accounts          hca
                                , apps.oe_order_lines_all        oola
                                , apps.oe_order_headers_all      ooha
                                , apps.ra_customer_trx_lines_all rctl
                                , apps.ra_customer_trx_all       rcta
                                , apps.hz_cust_acct_sites_all    hcas
                                , apps.hz_cust_site_uses_all     hcsu
                            WHERE ooha.header_id                 = oola.header_id
                              AND oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND rctl.inventory_item_id         = oola.inventory_item_id
                              AND rctl.line_type                 = 'LINE'
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE1 = to_char(ooha.order_number)
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE6 = to_char(oola.line_id)
                              AND RCTL.INTERFACE_LINE_CONTEXT    = 'ORDER ENTRY'
                              AND rctl.customer_trx_id           = rcta.customer_trx_id
                              AND rcta.bill_to_site_use_id       = hcsu.site_use_id
                              AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                              AND hcas.cust_account_id           = hca.cust_account_id
                              AND hca.party_id                   = hp.party_id 
                              AND ROWNUM = 1) = 'ORDER ENTRY' THEN
                     --
                     (SELECT DISTINCT DECODE(hcas.global_attribute2
                                           , '2',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'/'|| hcas.global_attribute4 ||'-'|| hcas.global_attribute5
                                           , '1',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'-'|| hcas.global_attribute5 
                                           , '3',HCSU.LOCATION||' - '||hcas.global_attribute3)
                             FROM apps.hz_parties                hp
                                , apps.hz_cust_accounts          hca
                                , apps.oe_order_lines_all        oola
                                , apps.oe_order_headers_all      ooha
                                , apps.ra_customer_trx_lines_all rctl
                                , apps.ra_customer_trx_all       rcta
                                , apps.hz_cust_acct_sites_all    hcas
                                , apps.hz_cust_site_uses_all     hcsu
                            WHERE ooha.header_id                 = oola.header_id
                              AND oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND rctl.inventory_item_id         = oola.inventory_item_id
                              AND rctl.line_type                 = 'LINE'
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE1 = to_char(ooha.order_number)
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE6 = to_char(oola.line_id)
                              AND RCTL.INTERFACE_LINE_CONTEXT    = 'ORDER ENTRY'
                              AND rctl.customer_trx_id           = rcta.customer_trx_id
                              AND rcta.bill_to_site_use_id       = hcsu.site_use_id
                              AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                              AND hcas.cust_account_id           = hca.cust_account_id
                              AND hca.party_id                   = hp.party_id
                              AND ROWNUM = 1)
                     --
                     ELSE
                     --            
                     CASE WHEN 
                          ( SELECT DISTINCT RCTL.INTERFACE_LINE_CONTEXT
                             FROM apps.hz_parties                hp
                                , apps.hz_cust_accounts          hca
                                , apps.oe_order_lines_all        oola
                                , apps.oe_order_headers_all      ooha
                                , apps.ra_customer_trx_lines_all rctl
                                , apps.ra_customer_trx_all       rcta
                                , apps.hz_cust_acct_sites_all    hcas
                                , apps.hz_cust_site_uses_all     hcsu
                            WHERE ooha.header_id                 = oola.header_id
                              AND oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND rctl.inventory_item_id         = oola.inventory_item_id
                              AND rctl.line_type                 = 'LINE'
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE1 = ooha.ORIG_SYS_DOCUMENT_REF
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE7 = oola.ORIG_SYS_LINE_REF
                              AND RCTL.INTERFACE_LINE_CONTEXT    = 'GEMS_PB_RR'
                              AND rctl.customer_trx_id           = rcta.customer_trx_id
                              AND rcta.bill_to_site_use_id       = hcsu.site_use_id
                              AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                              AND hcas.cust_account_id           = hca.cust_account_id
                              AND ROWNUM = 1 ) = 'GEMS_PB_RR' THEN
                     --
                     (SELECT DISTINCT DECODE(hcas.global_attribute2
                                           , '2',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'/'|| hcas.global_attribute4 ||'-'|| hcas.global_attribute5
                                           , '1',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'-'|| hcas.global_attribute5 
                                           , '3',HCSU.LOCATION||' - '||hcas.global_attribute3)
                             FROM apps.hz_parties                hp
                                , apps.hz_cust_accounts          hca
                                , apps.oe_order_lines_all        oola
                                , apps.oe_order_headers_all      ooha
                                , apps.ra_customer_trx_lines_all rctl
                                , apps.ra_customer_trx_all       rcta
                                , apps.hz_cust_acct_sites_all    hcas
                                , apps.hz_cust_site_uses_all     hcsu
                            WHERE ooha.header_id                 = oola.header_id
                              AND oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND rctl.inventory_item_id         = oola.inventory_item_id
                              AND rctl.line_type                 = 'LINE'
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE1 = ooha.ORIG_SYS_DOCUMENT_REF
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE7 = oola.ORIG_SYS_LINE_REF
                              AND RCTL.INTERFACE_LINE_CONTEXT    = 'GEMS_PB_RR'
                              AND rctl.customer_trx_id           = rcta.customer_trx_id
                              AND rcta.bill_to_site_use_id       = hcsu.site_use_id
                              AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                              AND hcas.cust_account_id           = hca.cust_account_id 
                              AND ROWNUM = 1 )
                     --
                     ELSE
                     --
                    (SELECT DISTINCT DECODE(hcas.global_attribute2
                                   , '2',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'/'|| hcas.global_attribute4 ||'-'|| hcas.global_attribute5
                                   , '1',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'-'|| hcas.global_attribute5 
                                   , '3',HCSU.LOCATION||' - '||hcas.global_attribute3)
                             --
                      FROM   APPS.HZ_CUST_ACCT_SITES_ALL HCAS,
                             APPS.HZ_CUST_SITE_USES_ALL  HCSU,
                            APPS.OE_ORDER_LINES_ALL     OOLA,
                             APPS.OE_ORDER_HEADERS_ALL   OOHA
                             --
                      WHERE  HCSU.SITE_USE_CODE     = 'BILL_TO'
                      AND    HCSU.CUST_ACCT_SITE_ID = HCAS.CUST_ACCT_SITE_ID
                      AND    HCSU.SITE_USE_ID       = NVL(OOLA.ATTRIBUTE1, OOHA.INVOICE_TO_ORG_ID)
                      AND    OOLA.LINE_ID           = NVL(MMT.TRX_SOURCE_LINE_ID, MMT.SOURCE_LINE_ID)
                      AND    OOHA.HEADER_ID         = OOLA.HEADER_ID
                      AND    ROWNUM = 1)
                     --
                     END
                  END
               END      bill_to_CNPJ_CPF
               --
              , CASE WHEN (mmt.source_code = '3PL_REMITTANCE_BRAZIL') THEN
                        (SELECT listagg(hp.party_name,', ' ON OVERFLOW TRUNCATE)  
                        WITHIN GROUP (ORDER BY hp.party_name asc)
                          FROM apps.hz_parties             hp,
                               apps.hz_cust_accounts       hca,
                               apps.ra_customer_trx_all    rcta,
                               apps.hz_cust_acct_sites_all hcas,
                               apps.hz_cust_site_uses_all  hcsu
                         WHERE rcta.interface_header_attribute1 = mp.organization_code||'_'||mmt.transaction_reference
                           AND rcta.bill_to_site_use_id         = hcsu.site_use_id
                           AND hcsu.cust_acct_site_id           = hcas.cust_acct_site_id
                           AND hcas.cust_account_id             = hca.cust_account_id
                           AND hca.party_id                     = hp.party_id
                           AND rcta.org_id                      = 4330)
                   ELSE
                     --
                     CASE WHEN (select DISTINCT RCTL.INTERFACE_LINE_CONTEXT
                             FROM apps.hz_parties                hp
                                , apps.hz_cust_accounts          hca
                                , apps.oe_order_lines_all        oola
                                , apps.oe_order_headers_all      ooha
                                , apps.ra_customer_trx_lines_all rctl
                                , apps.ra_customer_trx_all       rcta
                                , apps.hz_cust_acct_sites_all    hcas
                                , apps.hz_cust_site_uses_all     hcsu
                            WHERE ooha.header_id                 = oola.header_id
                              AND oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND rctl.inventory_item_id         = oola.inventory_item_id
                              AND rctl.line_type                 = 'LINE'
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE1 = to_char(ooha.order_number)
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE6 = to_char(oola.line_id)
                              AND RCTL.INTERFACE_LINE_CONTEXT    = 'ORDER ENTRY'
                              AND rctl.customer_trx_id           = rcta.customer_trx_id
                              AND rcta.bill_to_site_use_id       = hcsu.site_use_id
                              AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                              AND hcas.cust_account_id           = hca.cust_account_id
                              AND hca.party_id                   = hp.party_id 
                              AND ROWNUM = 1) = 'ORDER ENTRY' THEN
                     --
                     (SELECT listagg(hp.party_name,', ' ON OVERFLOW TRUNCATE)  
                         WITHIN GROUP (ORDER BY hp.party_name asc)
                             FROM apps.hz_parties                hp
                                , apps.hz_cust_accounts          hca
                                , apps.oe_order_lines_all        oola
                                , apps.oe_order_headers_all      ooha
                                , apps.ra_customer_trx_lines_all rctl
                                , apps.ra_customer_trx_all       rcta
                                , apps.hz_cust_acct_sites_all    hcas
                                , apps.hz_cust_site_uses_all     hcsu
                            WHERE ooha.header_id                 = oola.header_id
                              AND oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND rctl.inventory_item_id         = oola.inventory_item_id
                              AND rctl.line_type                 = 'LINE'
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE1 = to_char(ooha.order_number)
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE6 = to_char(oola.line_id)
                              AND RCTL.INTERFACE_LINE_CONTEXT    = 'ORDER ENTRY'
                              AND rctl.customer_trx_id           = rcta.customer_trx_id
                              AND rcta.bill_to_site_use_id       = hcsu.site_use_id
                              AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                              AND hcas.cust_account_id           = hca.cust_account_id
                              AND hca.party_id                   = hp.party_id
                              AND ROWNUM = 1)
                     --
                     ELSE
                     --            
                     CASE WHEN 
                          ( SELECT DISTINCT RCTL.INTERFACE_LINE_CONTEXT
                             FROM apps.hz_parties                hp
                                , apps.hz_cust_accounts          hca
                                , apps.oe_order_lines_all        oola
                                , apps.oe_order_headers_all      ooha
                                , apps.ra_customer_trx_lines_all rctl
                                , apps.ra_customer_trx_all       rcta
                                , apps.hz_cust_acct_sites_all    hcas
                                , apps.hz_cust_site_uses_all     hcsu
                            WHERE ooha.header_id                 = oola.header_id
                              AND oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND rctl.inventory_item_id         = oola.inventory_item_id
                              AND rctl.line_type                 = 'LINE'
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE1 = ooha.ORIG_SYS_DOCUMENT_REF
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE7 = oola.ORIG_SYS_LINE_REF
                              AND RCTL.INTERFACE_LINE_CONTEXT    = 'GEMS_PB_RR'
                              AND rctl.customer_trx_id           = rcta.customer_trx_id
                              AND rcta.bill_to_site_use_id       = hcsu.site_use_id
                              AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                              AND hcas.cust_account_id           = hca.cust_account_id
                              AND ROWNUM = 1 ) = 'GEMS_PB_RR' THEN
                     --
                     (SELECT listagg(hp.party_name,', ' ON OVERFLOW TRUNCATE)  
                         WITHIN GROUP (ORDER BY hp.party_name asc)
                             FROM apps.hz_parties                hp
                                , apps.hz_cust_accounts          hca
                                , apps.oe_order_lines_all        oola
                                , apps.oe_order_headers_all      ooha
                                , apps.ra_customer_trx_lines_all rctl
                                , apps.ra_customer_trx_all       rcta
                                , apps.hz_cust_acct_sites_all    hcas
                                , apps.hz_cust_site_uses_all     hcsu
                            WHERE ooha.header_id                 = oola.header_id
                              AND oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND rctl.inventory_item_id         = oola.inventory_item_id
                              AND rctl.line_type                 = 'LINE'
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE1 = ooha.ORIG_SYS_DOCUMENT_REF
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE7 = oola.ORIG_SYS_LINE_REF
                              AND RCTL.INTERFACE_LINE_CONTEXT    = 'GEMS_PB_RR'
                              AND rctl.customer_trx_id           = rcta.customer_trx_id
                              AND rcta.bill_to_site_use_id       = hcsu.site_use_id
                              AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                              AND hcas.cust_account_id           = hca.cust_account_id 
                              AND ROWNUM = 1 )
                     --
                     ELSE
                     --
                     (SELECT listagg(hp.party_name,', ' ON OVERFLOW TRUNCATE)  
                         WITHIN GROUP (ORDER BY hp.party_name asc)
                      FROM   APPS.HZ_CUST_ACCT_SITES_ALL HCAS,
                             apps.hz_parties             hp,
                             apps.hz_cust_accounts       hca,
                             APPS.HZ_CUST_SITE_USES_ALL  HCSU,
                             APPS.OE_ORDER_LINES_ALL     OOLA,
                             APPS.OE_ORDER_HEADERS_ALL   OOHA
                             --
                      WHERE  HCSU.SITE_USE_CODE     = 'BILL_TO'
                      AND    HCSU.CUST_ACCT_SITE_ID = HCAS.CUST_ACCT_SITE_ID
                      AND    HCSU.SITE_USE_ID       = NVL(OOLA.ATTRIBUTE1, OOHA.INVOICE_TO_ORG_ID)
                      AND    OOLA.LINE_ID           = NVL(MMT.TRX_SOURCE_LINE_ID, MMT.SOURCE_LINE_ID)
                      AND    OOHA.HEADER_ID         = OOLA.HEADER_ID
                      AND    hcas.cust_account_id   = hca.cust_account_id
                      AND    hca.party_id           = hp.party_id 
                      AND    ROWNUM = 1)
                     --          
                     END
                  END
               END      bill_to_Customer_name
               --
                , CASE WHEN (mmt.source_code = '3PL_REMITTANCE_BRAZIL') THEN
                      (SELECT listagg(DECODE(hcas.global_attribute2
                                           , '2',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'/'|| hcas.global_attribute4 ||'-'|| hcas.global_attribute5
                                           , '1',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'-'|| hcas.global_attribute5 
                                           , '3',HCSU.LOCATION||' - '||hcas.global_attribute3 ),', ' ON OVERFLOW TRUNCATE)
                       WITHIN GROUP (ORDER BY hcas.global_attribute2 asc )
                         FROM apps.ra_customer_trx_all         rcta
                            , apps.hz_cust_acct_sites_all      hcas
                            , apps.hz_cust_site_uses_all       hcsu
                        WHERE rcta.interface_header_attribute1 = mp.organization_code||'_'||mmt.transaction_reference
                          AND rcta.ship_to_site_use_id         = hcsu.site_use_id
                          AND hcsu.cust_acct_site_id           = hcas.cust_acct_site_id
                          AND rcta.org_id                      = 4330
                          AND ROWNUM = 1)
                   ELSE
                     --
                     CASE WHEN (select DISTINCT RCTL.INTERFACE_LINE_CONTEXT
                             FROM apps.hz_parties                hp
                                , apps.hz_cust_accounts          hca
                                , apps.oe_order_lines_all        oola
                                , apps.oe_order_headers_all      ooha
                                , apps.ra_customer_trx_lines_all rctl
                                , apps.ra_customer_trx_all       rcta
                                , apps.hz_cust_acct_sites_all    hcas
                                , apps.hz_cust_site_uses_all     hcsu
                            WHERE ooha.header_id                 = oola.header_id
                              AND oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND rctl.inventory_item_id         = oola.inventory_item_id
                              AND rctl.line_type                 = 'LINE'
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE1 = to_char(ooha.order_number)
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE6 = to_char(oola.line_id)
                              AND RCTL.INTERFACE_LINE_CONTEXT    = 'ORDER ENTRY'
                              AND rctl.customer_trx_id           = rcta.customer_trx_id
                              AND rcta.ship_to_site_use_id       = hcsu.site_use_id
                              AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                              AND hcas.cust_account_id           = hca.cust_account_id
                              AND hca.party_id                   = hp.party_id 
                              AND ROWNUM = 1) = 'ORDER ENTRY' THEN
                     --
                     (SELECT DISTINCT DECODE(hcas.global_attribute2
                                           , '2',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'/'|| hcas.global_attribute4 ||'-'|| hcas.global_attribute5
                                           , '1',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'-'|| hcas.global_attribute5 
                                           , '3',HCSU.LOCATION||' - '||hcas.global_attribute3)
                             FROM apps.hz_parties                hp
                                , apps.hz_cust_accounts          hca
                                , apps.oe_order_lines_all        oola
                                , apps.oe_order_headers_all      ooha
                                , apps.ra_customer_trx_lines_all rctl
                                , apps.ra_customer_trx_all       rcta
                                , apps.hz_cust_acct_sites_all    hcas
                                , apps.hz_cust_site_uses_all     hcsu
                            WHERE ooha.header_id                 = oola.header_id
                              AND oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND rctl.inventory_item_id         = oola.inventory_item_id
                              AND rctl.line_type                 = 'LINE'
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE1 = to_char(ooha.order_number)
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE6 = to_char(oola.line_id)
                              AND RCTL.INTERFACE_LINE_CONTEXT    = 'ORDER ENTRY'
                              AND rctl.customer_trx_id           = rcta.customer_trx_id
                              AND rcta.ship_to_site_use_id       = hcsu.site_use_id
                              AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                              AND hcas.cust_account_id           = hca.cust_account_id
                              AND hca.party_id                   = hp.party_id
                              AND ROWNUM = 1)
                     --
                     ELSE
                     --            
                     CASE WHEN 
                          ( SELECT DISTINCT RCTL.INTERFACE_LINE_CONTEXT
                             FROM apps.hz_parties                hp
                                , apps.hz_cust_accounts          hca
                                , apps.oe_order_lines_all        oola
                                , apps.oe_order_headers_all      ooha
                                , apps.ra_customer_trx_lines_all rctl
                                , apps.ra_customer_trx_all       rcta
                                , apps.hz_cust_acct_sites_all    hcas
                                , apps.hz_cust_site_uses_all     hcsu
                            WHERE ooha.header_id                 = oola.header_id
                              AND oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND rctl.inventory_item_id         = oola.inventory_item_id
                              AND rctl.line_type                 = 'LINE'
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE1 = ooha.ORIG_SYS_DOCUMENT_REF
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE7 = oola.ORIG_SYS_LINE_REF
                              AND RCTL.INTERFACE_LINE_CONTEXT    = 'GEMS_PB_RR'
                              AND rctl.customer_trx_id           = rcta.customer_trx_id
                              AND rcta.ship_to_site_use_id       = hcsu.site_use_id
                              AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                              AND hcas.cust_account_id           = hca.cust_account_id
                              AND ROWNUM = 1 ) = 'GEMS_PB_RR' THEN
                     --
                     (SELECT DISTINCT DECODE(hcas.global_attribute2
                                           , '2',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'/'|| hcas.global_attribute4 ||'-'|| hcas.global_attribute5
                                           , '1',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'-'|| hcas.global_attribute5 
                                           , '3',HCSU.LOCATION||' - '||hcas.global_attribute3)
                             FROM apps.hz_parties                hp
                                , apps.hz_cust_accounts          hca
                                , apps.oe_order_lines_all        oola
                                , apps.oe_order_headers_all      ooha
                                , apps.ra_customer_trx_lines_all rctl
                                , apps.ra_customer_trx_all       rcta
                                , apps.hz_cust_acct_sites_all    hcas
                                , apps.hz_cust_site_uses_all     hcsu
                            WHERE ooha.header_id                 = oola.header_id
                              AND oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND rctl.inventory_item_id         = oola.inventory_item_id
                              AND rctl.line_type                 = 'LINE'
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE1 = ooha.ORIG_SYS_DOCUMENT_REF
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE7 = oola.ORIG_SYS_LINE_REF
                              AND RCTL.INTERFACE_LINE_CONTEXT    = 'GEMS_PB_RR'
                              AND rctl.customer_trx_id           = rcta.customer_trx_id
                              AND rcta.ship_to_site_use_id       = hcsu.site_use_id
                              AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                              AND hcas.cust_account_id           = hca.cust_account_id 
                              AND ROWNUM = 1 )
                     --
                     ELSE
                     --
                     (SELECT listagg(DECODE(hcas.global_attribute2
                                           , '2',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'/'|| hcas.global_attribute4 ||'-'|| hcas.global_attribute5
                                           , '1',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'-'|| hcas.global_attribute5 
                                           , '3',HCSU.LOCATION||' - '||hcas.global_attribute3 ),', ' ON OVERFLOW TRUNCATE)
                      WITHIN GROUP (ORDER BY hcas.global_attribute2 asc) 
                         FROM apps.hz_parties             hp
                            , apps.hz_cust_accounts       hca
                            , apps.oe_order_lines_all     oola
                            , apps.hz_cust_acct_sites_all hcas
                            , apps.hz_cust_site_uses_all  hcsu
                        WHERE oola.line_id                = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                          AND oola.ship_to_org_id         = hcsu.site_use_id
                          AND hcsu.cust_acct_site_id      = hcas.cust_acct_site_id
                          AND hcas.cust_account_id        = hca.cust_account_id
                          AND hca.party_id                = hp.party_id  )
                     --
                     END
                  END
               END      ship_to_CNPJ_CPF
               --
              , CASE WHEN ( SELECT ottl.name
                              FROM apps.oe_transaction_types_tl    ottl
                                 , apps.oe_order_headers_all  ooha
                                 , apps.oe_order_lines_all    oola  
                             WHERE oola.line_id        = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                               AND oola.header_id      = ooha.header_id
                               AND ooha.order_type_id  = ottl.transaction_type_id  ) = 'GPO_BR_FE_SHIPMENT' THEN
                      (SELECT listagg(hzl.address1 ||' - '|| hzl.address2 || ' - ' || hzl.city || '-' || hzl.state || ' / ' || hzl.postal_code,', ' ON OVERFLOW TRUNCATE)  
                       WITHIN GROUP (ORDER BY hzl.address1 asc)
                       FROM apps.hz_parties             hp
                        , apps.hz_party_sites         hps
                        , apps.hz_cust_accounts       hca
                        , apps.oe_order_lines_all     oola
                        , apps.hz_cust_acct_sites_all hcas
                        , apps.hz_cust_site_uses_all  hcsu
                        , apps.hz_locations           hzl
                    WHERE oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                      AND oola.end_customer_site_use_id  = hcsu.site_use_id
                      AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                      AND hcas.cust_account_id           = hca.cust_account_id
                      AND hcas.party_site_id             = hps.party_site_id
                      AND hca.party_id                   = hp.party_id
                      AND hps.party_id                   = hp.party_id
                      AND hps.location_id                = hzl.location_id)
                ELSE
                   CASE WHEN (mmt.source_code = '3PL_REMITTANCE_BRAZIL') THEN
                      (SELECT listagg(hzl.address1 ||' - '|| hzl.address2 || ' - ' || hzl.city || '-' || hzl.state || ' / ' || hzl.postal_code,', ' ON OVERFLOW TRUNCATE)  
                       WITHIN GROUP (ORDER BY hzl.address1 asc)
                         FROM apps.ra_customer_trx_all     rcta
                            , apps.hz_cust_acct_sites_all  hcas
                            , apps.hz_cust_site_uses_all   hcsu
                            , apps.hz_parties              hp
                            , apps.hz_party_sites          hps
                            , apps.hz_cust_accounts        hca
                            , apps.hz_locations            hzl
                        WHERE rcta.interface_header_attribute1 = mp.organization_code||'_'||mmt.transaction_reference
                          AND rcta.ship_to_site_use_id         = hcsu.site_use_id
                          AND hcsu.cust_acct_site_id           = hcas.cust_acct_site_id
                          AND hcas.cust_account_id             = hca.cust_account_id
                          AND hcas.party_site_id               = hps.party_site_id
                          AND hca.party_id                     = hp.party_id
                          AND hps.party_id                     = hp.party_id
                          AND hps.location_id                  = hzl.location_id
                          AND rcta.org_id                      = 4330)
                   ELSE
                      (SELECT listagg(hzl.address1 ||' - '|| hzl.address2 || ' - ' || hzl.city || '-' || hzl.state || ' / ' || hzl.postal_code,', ' ON OVERFLOW TRUNCATE)  
                       WITHIN GROUP (ORDER BY hzl.address1 asc)
                          FROM apps.hz_parties             hp
                             , apps.hz_party_sites         hps
                             , apps.hz_cust_accounts       hca
                             , apps.oe_order_lines_all     oola
                             , apps.hz_cust_acct_sites_all hcas
                             , apps.hz_cust_site_uses_all  hcsu
                             , apps.hz_locations           hzl
                         WHERE oola.line_id                = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                           AND oola.ship_to_org_id         = hcsu.site_use_id
                           AND hcsu.cust_acct_site_id      = hcas.cust_acct_site_id
                           AND hcas.cust_account_id        = hca.cust_account_id
                           AND hcas.party_site_id          = hps.party_site_id
                           AND hca.party_id                = hp.party_id
                           AND hps.party_id                = hp.party_id
                           AND hps.location_id             = hzl.location_id   )
                   END
                END customer_address
                -- 
                -- alterado para BIll_to por Sinval fim
                -- 
              , CASE WHEN (mmt.source_code = '3PL_REMITTANCE_BRAZIL') THEN
                   (SELECT listagg(rcta.trx_number,', ' ON OVERFLOW TRUNCATE)  
                           WITHIN GROUP (ORDER BY rcta.trx_number asc)
                      FROM apps.ra_customer_trx_all       rcta
                     WHERE rcta.interface_header_attribute1  = mp.organization_code||'_'||mmt.transaction_reference
                       AND rcta.org_id                       = 4330
                       AND NVL(rcta.status_trx,'XX')         <> 'VD'
                       AND NVL(rcta.reason_code,'XX')        <> 'CANCELLATION')
                ELSE
                   (SELECT distinct RTRIM(REGEXP_REPLACE((listagg(rcta.trx_number,', ' ON OVERFLOW TRUNCATE)  
                      WITHIN GROUP (ORDER BY rcta.trx_number asc) ), '([^,]*)(,\1)+($|,)', '\1\3'),',')
                      FROM apps.ra_customer_trx_lines_all rctla
                         , apps.ra_customer_trx_all       rcta
                         , apps.oe_order_lines_all        oola
                         , apps.oe_order_headers_all      ooha
                     WHERE rcta.customer_trx_id              = rctla.customer_trx_id
                       AND oola.line_id                      = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                       AND oola.header_id                    = ooha.header_id
                       AND rctla.sales_order                 = to_char(ooha.order_number)
                       AND rctla.line_type                   = 'LINE'
                       AND rcta.batch_source_id              <> 6266 -- No RR invoices
                       AND DECODE(rctla.interface_line_context,'GEMS_PB_RR',rcta.interface_header_attribute11,'999')
                           = DECODE(rctla.interface_line_context,'GEMS_PB_RR',rcta.interface_header_attribute11,'999')
                       AND rcta.org_id                       = 4330
                       --AND trunc(rcta.trx_date)              BETWEEN (trunc(mmt.transaction_date)-3) AND (trunc(mmt.transaction_date)+3)
                       AND NVL(rcta.status_trx,'XX')         <> 'VD'
                       AND NVL(rcta.reason_code,'XX')        <> 'CANCELLATION')
                END   invoice_number_ar
              , ( SELECT listagg(mrav.reservation_quantity,', ' ON OVERFLOW TRUNCATE)  
                  WITHIN GROUP (ORDER BY mrav.reservation_quantity asc) 
                    FROM apps.mtl_reservations_all_v  mrav 
                       , apps.oe_order_headers_all    ooha1
                   WHERE mrav.demand_source_header_id     = ooha1.header_id
                     AND mrav.demand_source_line_id       = NVL(mmt.trx_source_line_id, mmt.source_line_id) )  reservation_quantity
              , ( SELECT listagg(ooha1.order_number,', ' ON OVERFLOW TRUNCATE)  
                  WITHIN GROUP (ORDER BY ooha1.order_number asc) 
                    FROM apps.mtl_reservations_all_v  mrav 
                       , apps.oe_order_headers_all    ooha1
                   WHERE mrav.demand_source_header_id     = ooha1.header_id
                     AND mrav.demand_source_line_id       = NVL(mmt.trx_source_line_id, mmt.source_line_id) )  reservation_order_number
              , (SELECT distinct hp.party_name
                 --WITHIN GROUP (ORDER BY hp.party_name asc)
                   FROM apps.hz_parties              hp
                      , apps.hz_cust_accounts        hca
                      , apps.oe_order_lines_all      oola1
                      , apps.oe_order_headers_all    ooha1
                      , apps.mtl_reservations_all_v  mrav 
                  WHERE mrav.demand_source_header_id   = ooha1.header_id
                    AND mrav.demand_source_line_id     = oola1.line_id
                    AND oola1.line_id                  = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                    AND oola1.ship_to_org_id           = hca.cust_account_id
                    AND hca.party_id                   = hp.party_id )         reservation_customer_name
              , gcc1.concatenated_segments   material_account
              , gcc2.concatenated_segments   outside_processing_account
              , gcc3.concatenated_segments   material_overhead_account
              , gcc4.concatenated_segments   overhead_account
              , gcc5.concatenated_segments   resource_account
              , sysdate                                           report_date_and_time 
              , to_char(mmt.transaction_id)  transaction_id
              , fu.user_name ||' / '|| fu.description                                    user_name
              , DECODE( lot_control_code, 1 ,'Sem controle de Lote' , 2,'Com controle de Lote')   lot_control
              , DECODE( serial_number_control_code, 1, 'Sem controle de Serial'
                                                  , 2, 'Pre-definido'
                                                  , 5, 'No Recebimento'
                                                  , 6, 'Baixa na Ordem de Venda' )  serial_control
              , CASE
                 WHEN    nvl(mmt.lpn_id, mmt.content_lpn_id) IS NULL AND moq.subinventory_code <> 'WHGU42GNAT'
                   THEN 
                   (SELECT listagg(lpn.license_plate_number,', ' ON OVERFLOW TRUNCATE)WITHIN GROUP (ORDER BY lpn.license_plate_number asc)
                             FROM apps.MTL_MATERIAL_TRANSACTIONS   mtt,
                                  apps.wms_license_plate_numbers   lpn,
                                  apps.oe_order_lines_all          ool
                            WHERE 1 = 1
                              AND mtt.TRX_SOURCE_LINE_ID = CASE
                                                              WHEN LINE_CATEGORY_CODE = 'ORDER'
                                                                THEN ool.line_id
                                                              WHEN LINE_CATEGORY_CODE = 'RETURN'  
                                                                THEN   
                                                                to_number(NVL(SUBSTR(ool.ORIG_SYS_LINE_REF,
                                                                                     0,
                                                                                     INSTR(ool.ORIG_SYS_LINE_REF, '.') - 1),
                                                                              -1)) -- RMA FE OE Line Id
                                                                ELSE -1
                                                                  END
                              AND mtt.TRANSACTION_TYPE_ID = 52 --sales order pick FE ORDER
                              AND mtt.transaction_quantity < 0
                              AND mtt.inventory_item_id = ool.inventory_item_id
                              AND nvl(mtt.lpn_id, mtt.content_lpn_id) = nvl(lpn.lpn_id, -1)
                              AND ool.line_id = CASE
                                                  WHEN mtt.transaction_type_name = 'RMA Receipt'
                                                    THEN mmt.TRX_SOURCE_LINE_ID
                                                  WHEN mtt.transaction_type_name = 'GPO Nationalization Receipt'
                                                     THEN 
                                                      to_number(NVL(SUBSTR(RTRIM(LTRIM(translate(mmt.TRANSACTION_REFERENCE,translate(mmt.TRANSACTION_REFERENCE||'a','1234567890.',' '),' '))),
                                                         0,
                                                         INSTR(RTRIM(LTRIM(translate(mmt.TRANSACTION_REFERENCE,translate(mmt.TRANSACTION_REFERENCE||'a','1234567890.',' '),' '))), '.') - 1),
                                                  -1))
                                                  ELSE -1
                                                    END)
                              WHEN moq.subinventory_code = 'WHGU42GNAT'
                  THEN (SELECT listagg(wlp.license_plate_number,', ' ON OVERFLOW TRUNCATE)  
                            WITHIN GROUP (ORDER BY wlp.license_plate_number asc)
                        FROM   gems_ont.ge_gpo_nationalization_line gnl, 
                               gems_ont.ge_gpo_nationalization_line gn2,
                               apps.wms_license_plate_numbers       wlp,
                               apps.po_line_locations_all           pll,
                               apps.po_lines_all                    pol,
                               apps.po_headers_all                  poh,
                               apps.rcv_shipment_headers            rsh,
                               apps.rcv_transactions                rt
                        Where  wlp.lpn_id(+) = gn2.lpn_id
                        AND gnl.nationalization_so_line_id = gn2.nationalization_so_line_id
                        AND pll.line_location_id = gnl.DOCUMENT_ID
                        AND pll.po_header_id = poh.po_header_id
                        AND pll.po_line_id = pol.po_line_id
                        AND gn2.record_type = 'IMPORT'
                        AND gnl.record_type = 'NATIONALIZATION'
                        AND rt.transaction_id                = mmt.rcv_transaction_id
                        AND rt.po_line_location_id           = pll.line_location_id
                        AND rt.shipment_header_id            = rsh.shipment_header_id)
                  ELSE (SELECT lpn.LICENSE_PLATE_NUMBER
                           FROM   apps.wms_license_plate_numbers   lpn
                           WHERE  nvl(mmt.lpn_id, mmt.content_lpn_id) = nvl(lpn.lpn_id, -1))
                        END LPN_Value                                    
              , 'q5' query
--, mmt.transaction_type_id
--, mmt.trx_source_line_id
--, mmt.source_line_id
           FROM apps.mtl_parameters                  mp
             , apps.mtl_system_items_b              msi
              , apps.mtl_secondary_inventories_fk_v  msifv
              , apps.gl_code_combinations            gcc
              , apps.gl_code_combinations_kfv        gcc1
              , apps.gl_code_combinations_kfv        gcc2
              , apps.gl_code_combinations_kfv        gcc3
              , apps.gl_code_combinations_kfv        gcc4
              , apps.gl_code_combinations_kfv        gcc5
              , apps.mtl_item_locations_kfv          milk
              , apps.mtl_material_transactions       mmt
              , apps.mtl_transaction_types           mtt
              , apps.mtl_txn_source_types            mtst
              , apps.fnd_flex_values_vl              ffvv
              , apps.fnd_flex_value_sets             ffvs
              , apps.fnd_user                        fu
              , ( SELECT organization_id
                       , inventory_item_id
                       , subinventory_code
                       , locator_id
                       , lot_number
                       --, transaction_uom_code
                       , create_transaction_id
                       , SUM (primary_transaction_quantity) onhand_qty
                    FROM apps.mtl_onhand_quantities_detail
                   WHERE organization_id IN (SELECT ood.organization_id FROM apps.org_organization_definitions ood WHERE ood.set_of_books_id = 230 )
                   GROUP BY organization_id
                          , inventory_item_id
                          , subinventory_code
                          , locator_id
                         -- , revision
                          , lot_number
                          --, transaction_uom_code
                          , create_transaction_id ) moq
                          ,APPS.MTL_PAC_ACTUAL_COST_DETAILS MPACD 
          WHERE 1                                = 1
          AND decode(mmt.periodic_primary_quantity,null,mmt.transfer_transaction_id,MMT.TRANSACTION_ID) = MPACD.TRANSACTION_ID  
            AND mp.organization_id               = msi.organization_id
--            AND msi.segment1 = '60510302'
            AND msifv.organization_id            = msi.organization_id
            AND msifv.secondary_inventory_name   = moq.subinventory_code
            AND msifv.material_account           = gcc1.code_combination_id
            AND msifv.outside_processing_account = gcc2.code_combination_id
            AND msifv.material_overhead_account  = gcc3.code_combination_id
            AND msifv.overhead_account           = gcc4.code_combination_id
            AND msifv.resource_account           = gcc5.code_combination_id
            AND msi.cost_of_sales_account       = gcc.code_combination_id
            AND ffvs.flex_value_set_name        = 'GE_GL_AFF_ES_PRODUCT_LINE'
            AND ffvs.flex_value_set_id          = ffvv.flex_value_set_id
            AND ffvv.flex_value_meaning         = gcc.segment8
            AND 'TYPE 1'                        IN ('TYPE 1')
            AND msi.organization_id             IN (SELECT ood.organization_id FROM apps.org_organization_definitions ood WHERE ood.set_of_books_id = 230 )
            AND moq.inventory_item_id           = msi.inventory_item_id
            AND moq.organization_id             = msi.organization_id
            AND moq.locator_id                  = milk.inventory_location_id
            AND moq.create_transaction_id       = mmt.transaction_id(+)
--    AND MMT.TRANSACTION_ID = 2562828197
            AND mtt.transaction_type_id         = mmt.transaction_type_id 
            AND mtst.transaction_source_type_id = mmt.transaction_source_type_id
            AND msi.serial_number_control_code IN ('1', '6') 
            AND fu.user_id                      = mmt.created_by 
            AND EXISTS (SELECT 1       
                          FROM apps.mtl_lot_numbers     mln
                         WHERE mln.lot_number           = moq.lot_number
                           AND mln.inventory_item_id    = msi.inventory_item_id
                           AND mln.organization_id      = mp.organization_id  )
    AND MMT.TRANSACTION_ID NOT IN(SELECT MMT2.TRANSACTION_ID 
                                  FROM AMARCHIVE.MTL_MATERIAL_TRANSACTIONS  MMT2
                                  WHERE MMT2.TRANSACTION_ID = MMT.TRANSACTION_ID)
------------------------------------------------------------------------------ LOTE COM SERIAL NULO
UNION  
------------------------------------------------------------------------------  
-- Com controle de Lote, sem controle de serial ( 1,6 )  ---- AMARCHIVE.MTL_MATERIAL_TRANSACTIONS
         SELECT DISTINCT  --'6' NUM
        /* ( SELECT ccg.cost_group 
                             FROM apps.cst_cost_groups            ccg
                                , apps.cst_cost_group_assignments ccga
                            WHERE ccga.cost_group_id     = ccg.cost_group_id
                              AND ccga.organization_id   = mp.organization_id )  cost_group*/
            ( SELECT ccg.cost_group 
                             FROM apps.cst_cost_groups            ccg
                            WHERE MPACD.cost_group_id     = ccg.cost_group_id )  cost_group  
              , ( SELECT ( SELECT cpp1.period_name 
                             FROM apps.cst_pac_item_costs   cst
                                , apps.cst_pac_periods      cpp1
                            WHERE cst.pac_period_id     = (SELECT MAX(PAC_PERIOD_ID)                   FROM APPS.CST_PAC_PERIODS                  WHERE LEGAL_ENTITY = (SELECT LEGAL_ENTITY                                          FROM APPS.ORG_ORGANIZATION_DEFINITIONS OOD                                         WHERE OOD.ORGANIZATION_ID = mp.organization_id                                         ) )
                              AND cst.pac_period_id     = cpp1.pac_period_id
                              AND cst.inventory_item_id = msi.inventory_item_id
                              AND cst.cost_group_id     = ccg.cost_group_id )  
                    FROM apps.cst_cost_groups            ccg
                       , apps.cst_cost_group_assignments ccga
                   WHERE ccga.cost_group_id     = ccg.cost_group_id
                     AND ccga.organization_id   = mp.organization_id ) period_name
              , mp.organization_code
              , mp.attribute7                organization_type
              , mp.organization_id 
              , moq.subinventory_code
              , msifv.description            subinv_description
              , milk.concatenated_segments   locators
              , DECODE( msifv.asset_inventory, 1 , 'Asset', 2, 'Non Asset')   asset_type
              , msi.segment1                 part_number
              , DECODE(msi.inventory_asset_flag, NULL, 'No', 'N', 'No', 'Y', 'Yes')                         flag_asset_inventory
              , DECODE(msi.costing_enabled_flag, NULL, 'No', 'N', 'No', 'Y', 'Yes')                         flag_de_custo
              , msi.description              descrip_eng
              , msi.attribute3               descrip_ptb
             , msi.creation_date            item_creation_date
              , (trunc(SYSDATE) - trunc(msi.creation_date))      days_from_creation
              , gcc.segment8                                     product_line
              , ffvv.description                                 desc_prod_line   
              , msi.primary_uom_code    uom
              , moq.onhand_qty                                   transaction_quantity
              , NVL(( SELECT cic.item_cost
                        FROM apps.cst_item_costs cic
                       WHERE cic.organization_id   = msi.organization_id
                         AND cic.inventory_item_id = msi.inventory_item_id
                         AND cic.cost_type_id      = 1 ),0)  custo_unit_inv
              /*, nvl(( SELECT ( SELECT ROUND (cst.item_cost,2) 
                                 FROM apps.cst_pac_item_costs   cst
                                WHERE cst.pac_period_id     = (SELECT MAX(PAC_PERIOD_ID)                   FROM APPS.CST_PAC_PERIODS                  WHERE LEGAL_ENTITY = (SELECT LEGAL_ENTITY                                          FROM APPS.ORG_ORGANIZATION_DEFINITIONS OOD                                         WHERE OOD.ORGANIZATION_ID = mp.organization_id                                         ) )
                                  AND cst.inventory_item_id = msi.inventory_item_id
                                  AND cst.cost_group_id     = ccg.cost_group_id )  item_cost
                        FROM apps.cst_cost_groups            ccg
                           , apps.cst_cost_group_assignments ccga
                       WHERE ccga.cost_group_id     = ccg.cost_group_id
                         AND ccga.organization_id   = mp.organization_id ) ,0) custo_unit_pac*/
                , nvl((SELECT ROUND (cst.item_cost,2) 
                       FROM apps.cst_pac_item_costs   cst
                      WHERE cst.pac_period_id     = (SELECT MAX(PAC_PERIOD_ID)                   
                                                                FROM APPS.CST_PAC_PERIODS                  
                                                                WHERE LEGAL_ENTITY = (SELECT LEGAL_ENTITY                                         
                                                                                        FROM APPS.ORG_ORGANIZATION_DEFINITIONS OOD                                        
                                                                                        WHERE OOD.ORGANIZATION_ID = mp.organization_id
                                                        ) )
                        AND cst.inventory_item_id = msi.inventory_item_id
                        AND cst.cost_group_id     = MPACD.cost_group_id) ,0)  custo_unit_pac
              , moq.lot_number
              , ( SELECT mln.creation_date        
                    FROM apps.mtl_lot_numbers              mln
                   WHERE mln.lot_number           = moq.lot_number
                     AND mln.inventory_item_id    = msi.inventory_item_id
                     AND mln.organization_id      = mp.organization_id  )  lot_creation_date
              , NULL   lot_qty_days_creation
              , ( SELECT mln.expiration_date         
                    FROM apps.mtl_lot_numbers              mln
                   WHERE mln.lot_number           = moq.lot_number
                     AND mln.inventory_item_id    = msi.inventory_item_id
                     AND mln.organization_id      = mp.organization_id  )  lot_expiration_date
              , NULL  serial_number
              , NULL  serial_creation_date
              , mtt.transaction_type_name           last_transaction_type
              , mmt.transaction_source_name         last_transaction_source
              , mtst.transaction_source_type_name   last_source_type
              , mmt.source_code
              , TO_CHAR(mmt.transaction_date, 'DD-MON-RRRR')      transaction_date
        , (SELECT TO_CHAR(mmt1.transaction_date, 'DD-MON-RRRR') 
                        FROM apps.mtl_material_transactions mmt1
                        WHERE mmt1.transaction_type_id=420
                        AND mmt1.source_line_id=mmt.source_line_id) initial_consignment_date        
              , (TRUNC ( SYSDATE )- TRUNC(mmt.transaction_date))  transaction_qty_of_days
              , TO_CHAR(mmt.transaction_reference)                transaction_reference
              , CASE WHEN mmt.source_code = '3PL_REMITTANCE_BRAZIL' THEN
                     (SELECT listagg(pha.segment1,', ' ON OVERFLOW TRUNCATE)  
                      WITHIN GROUP (ORDER BY pha.segment1 asc)
                        FROM apps.po_headers_all        pha,
                             apps.po_lines_all          pla
                       WHERE pla.po_line_id   = mmt.source_line_id
                         AND pla.po_header_id = pha.po_header_id)
                     WHEN mmt.source_code IN ('ORDER ENTRY','IIP') THEN
                        NULL
                     WHEN mmt.source_code = 'RCV' THEN
                        ( SELECT listagg(pha.segment1,', ' ON OVERFLOW TRUNCATE)  
                          WITHIN GROUP (ORDER BY pha.segment1 asc)
                            FROM apps.po_headers_all            pha
                               , apps.po_lines_all              pla
                               , apps.po_line_locations_all     plla
                              , apps.rcv_shipment_headers      rsh
                               , apps.rcv_transactions          rt
                           WHERE rt.transaction_id                = mmt.rcv_transaction_id
                             AND rt.po_line_location_id           = plla.line_location_id
                             AND plla.po_line_id                  = pla.po_line_id
                             AND pha.po_header_id                 = pla.po_header_id
                             AND rt.shipment_header_id            = rsh.shipment_header_id
                             AND rsh.receipt_source_code          = 'VENDOR'  )
                     ELSE
                        NULL
                END      po_number
              , CASE WHEN mmt.source_code = '3PL_REMITTANCE_BRAZIL' THEN
                     (SELECT listagg(aps.vendor_name,', ' ON OVERFLOW TRUNCATE)  
                      WITHIN GROUP (ORDER BY aps.vendor_name asc)
                        FROM apps.po_headers_all        pha
                           , apps.po_lines_all          pla
                           , apps.ap_suppliers          aps
                           , apps.ap_supplier_sites_all  apss
                       WHERE pla.po_line_id     = mmt.source_line_id
                         AND pla.po_header_id   = pha.po_header_id
                         AND pha.vendor_id      = aps.vendor_id
                         AND aps.vendor_id      = apss.vendor_id
                         AND pha.vendor_site_id = apss.vendor_site_id )
                     WHEN mmt.source_code IN ('ORDER ENTRY','IIP') THEN
                        NULL
                     WHEN mmt.source_code = 'RCV' THEN
                        ( SELECT listagg(aps.vendor_name,', ' ON OVERFLOW TRUNCATE)  
                          WITHIN GROUP (ORDER BY aps.vendor_name asc)
                            FROM apps.po_headers_all            pha
                               , apps.po_lines_all              pla
                               , apps.po_line_locations_all     plla
                               , apps.rcv_shipment_headers      rsh
                               , apps.rcv_transactions          rt
                               , apps.ap_suppliers              aps
                               , apps.ap_supplier_sites_all     apss
                           WHERE rt.transaction_id          = mmt.rcv_transaction_id
                             AND rt.po_line_location_id     = plla.line_location_id
                             AND plla.po_line_id            = pla.po_line_id
                             AND pha.po_header_id           = pla.po_header_id
                             AND rt.shipment_header_id      = rsh.shipment_header_id
                             AND rsh.receipt_source_code    = 'VENDOR'
                             AND pha.vendor_id              = aps.vendor_id
                             AND aps.vendor_id              = apss.vendor_id
                             AND pha.vendor_site_id         = apss.vendor_site_id  )
                     ELSE
                        NULL
                END     po_supplier
              , CASE WHEN mmt.source_code = '3PL_REMITTANCE_BRAZIL' THEN
                     ( SELECT listagg(cfi.invoice_num,', ' ON OVERFLOW TRUNCATE)  
                         WITHIN GROUP (ORDER BY cfi.invoice_num asc)
                         FROM apps.cll_f189_invoice_lines cfil
                            , apps.cll_f189_invoices      cfi
                            , apps.po_lines_all           pla
                            , apps.po_line_locations_all  plla
                        WHERE plla.po_line_id       = pla.po_line_id
                          AND pla.po_line_id        = mmt.source_line_id
                          AND plla.line_location_id = cfil.line_location_id
                          AND cfil.invoice_id       = cfi.invoice_id )
                     WHEN mmt.source_code IN ('ORDER ENTRY','IIP') THEN
                        NULL
                     WHEN mmt.source_code = 'RCV' THEN
                        ( SELECT listagg(cfi.invoice_num,', ' ON OVERFLOW TRUNCATE)  
                            WITHIN GROUP (ORDER BY cfi.invoice_num asc)
                            FROM apps.po_headers_all            pha
                               , apps.po_lines_all              pla
                               , apps.po_line_locations_all     plla
                               , apps.cll_f189_invoice_lines    cfil
                               , apps.cll_f189_invoices         cfi
                               , apps.rcv_shipment_headers      rsh
                               , apps.rcv_transactions          rt
                           WHERE rt.transaction_id          = mmt.rcv_transaction_id
                             AND rt.po_line_location_id     = plla.line_location_id
                             AND plla.line_location_id      = cfil.line_location_id
                             AND cfil.invoice_id            = cfi.invoice_id
                             AND plla.po_line_id            = pla.po_line_id
                             AND pha.po_header_id           = pla.po_header_id
                             AND rt.shipment_header_id      = rsh.shipment_header_id
                             AND rsh.receipt_source_code    = 'VENDOR'   )
                     ELSE
                        NULL
                END    NF_RI
             , (SELECT DECODE( mmt.source_code, '3PL_REMITTANCE_BRAZIL',NULL,to_char(ooha.order_number) )
                  FROM apps.oe_order_headers_all  ooha,
                       apps.oe_order_lines_all    oola  
                 WHERE oola.line_id        = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                   AND oola.header_id      = ooha.header_id )   order_number
               -- 
               -- alterado para BIll_to por Sinval inicio
               --
               , CASE WHEN ( SELECT ottl.name
                             FROM apps.oe_transaction_types_tl    ottl
                                , apps.oe_order_headers_all  ooha
                                , apps.oe_order_lines_all    oola  
                            WHERE oola.line_id        = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND oola.header_id      = ooha.header_id
                              AND ooha.order_type_id  = ottl.transaction_type_id  ) = 'GPO_BR_FE_SHIPMENT' THEN
                     (SELECT listagg(hp.party_name,', ' ON OVERFLOW TRUNCATE)  
                      WITHIN GROUP (ORDER BY hp.party_name asc)
                        FROM apps.hz_parties             hp
                           , apps.hz_cust_accounts       hca
                           , apps.oe_order_lines_all     oola
                           , apps.hz_cust_acct_sites_all hcas
                           , apps.hz_cust_site_uses_all  hcsu
                       WHERE oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                         AND oola.end_customer_site_use_id  = hcsu.site_use_id
                         AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                         AND hcas.cust_account_id           = hca.cust_account_id
                         AND hca.party_id                   = hp.party_id )
                  ELSE
                     CASE WHEN (mmt.source_code = '3PL_REMITTANCE_BRAZIL') THEN
                       (SELECT listagg(hp.party_name,', ' ON OVERFLOW TRUNCATE)  
                        WITHIN GROUP (ORDER BY hp.party_name asc)
                          FROM apps.hz_parties             hp,
                               apps.hz_cust_accounts       hca,
                               apps.ra_customer_trx_all    rcta,
                               apps.hz_cust_acct_sites_all hcas,
                               apps.hz_cust_site_uses_all  hcsu
                         WHERE rcta.interface_header_attribute1 = mp.organization_code||'_'||mmt.transaction_reference
                           AND rcta.ship_to_site_use_id         = hcsu.site_use_id
                           AND hcsu.cust_acct_site_id           = hcas.cust_acct_site_id
                           AND hcas.cust_account_id             = hca.cust_account_id
                           AND hca.party_id                     = hp.party_id
                           AND rcta.org_id                      = 4330)
                     ELSE
                        (SELECT listagg(hp.party_name,', ' ON OVERFLOW TRUNCATE)  
                         WITHIN GROUP (ORDER BY hp.party_name asc)
                           FROM apps.hz_parties             hp
                              , apps.hz_cust_accounts       hca
                              , apps.oe_order_lines_all     oola
                              , apps.hz_cust_acct_sites_all hcas
                              , apps.hz_cust_site_uses_all  hcsu
                          WHERE oola.line_id                = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                            AND oola.ship_to_org_id         = hcsu.site_use_id
                            AND hcsu.cust_acct_site_id      = hcas.cust_acct_site_id
                            AND hcas.cust_account_id        = hca.cust_account_id
                            AND hca.party_id                = hp.party_id )
                    END                 
               END    customer_name
             , CASE WHEN ( SELECT ottl.name
                             FROM apps.oe_transaction_types_tl    ottl
                                , apps.oe_order_headers_all  ooha
                                , apps.oe_order_lines_all    oola  
                            WHERE oola.line_id        = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND oola.header_id      = ooha.header_id
                              AND ooha.order_type_id  = ottl.transaction_type_id  ) = 'GPO_BR_FE_SHIPMENT' THEN
                     (SELECT listagg(hca.account_number,', ' ON OVERFLOW TRUNCATE)  
                      WITHIN GROUP (ORDER BY hca.account_number asc)
                       FROM apps.hz_parties             hp
                           , apps.hz_cust_accounts       hca
                           , apps.oe_order_lines_all     oola
                           , apps.hz_cust_acct_sites_all hcas
                           , apps.hz_cust_site_uses_all  hcsu
                       WHERE oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                         AND oola.end_customer_site_use_id  = hcsu.site_use_id
                         AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                         AND hcas.cust_account_id           = hca.cust_account_id
                         AND hca.party_id                   = hp.party_id )
                  ELSE
                     CASE WHEN (mmt.source_code = '3PL_REMITTANCE_BRAZIL') THEN
                        (SELECT listagg(hca.account_number,', ' ON OVERFLOW TRUNCATE)  
                         WITHIN GROUP (ORDER BY hca.account_number asc)
                           FROM apps.hz_parties             hp,
                                apps.hz_cust_accounts       hca,
                                apps.ra_customer_trx_all    rcta,
                                apps.hz_cust_acct_sites_all hcas,
                                apps.hz_cust_site_uses_all  hcsu
                          WHERE rcta.interface_header_attribute1 = mp.organization_code||'_'||mmt.transaction_reference
                            AND rcta.ship_to_site_use_id         = hcsu.site_use_id
                            AND hcsu.cust_acct_site_id           = hcas.cust_acct_site_id
                            AND hcas.cust_account_id             = hca.cust_account_id
                            AND hca.party_id                     = hp.party_id
                            AND rcta.org_id                      = 4330)
                     ELSE
                        (SELECT listagg(hca.account_number,', ' ON OVERFLOW TRUNCATE)  
                         WITHIN GROUP (ORDER BY hca.account_number asc)
                           FROM apps.hz_parties             hp
                              , apps.hz_cust_accounts       hca
                              , apps.oe_order_lines_all     oola
                              , apps.hz_cust_acct_sites_all hcas
                              , apps.hz_cust_site_uses_all  hcsu
                          WHERE oola.line_id                = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                            AND oola.ship_to_org_id         = hcsu.site_use_id
                            AND hcsu.cust_acct_site_id      = hcas.cust_acct_site_id
                            AND hcas.cust_account_id        = hca.cust_account_id
                            AND hca.party_id                = hp.party_id   )
                     END
                  END   customer_number
              --
             , CASE WHEN ( SELECT ottl.name
                             FROM apps.oe_transaction_types_tl    ottl
                                , apps.oe_order_headers_all  ooha
                                , apps.oe_order_lines_all    oola  
                            WHERE oola.line_id        = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND oola.header_id      = ooha.header_id
                              AND ooha.order_type_id  = ottl.transaction_type_id  ) = 'GPO_BR_FE_SHIPMENT' THEN
                     (SELECT listagg(DECODE(hcas.global_attribute2
                                           , '2',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'/'|| hcas.global_attribute4 ||'-'|| hcas.global_attribute5
                                           , '1',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'-'|| hcas.global_attribute5 
                                           , '3',HCSU.LOCATION||' - '||hcas.global_attribute3 ),', ' ON OVERFLOW TRUNCATE)
                     WITHIN GROUP (ORDER BY hcas.global_attribute2 asc ) 
                        FROM apps.hz_parties             hp
                           , apps.hz_cust_accounts       hca
                           , apps.oe_order_lines_all     oola
                           , apps.hz_cust_acct_sites_all hcas
                           , apps.hz_cust_site_uses_all  hcsu
                       WHERE oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                         AND oola.end_customer_site_use_id  = hcsu.site_use_id
                         AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                         AND hcas.cust_account_id           = hca.cust_account_id
                         AND hca.party_id                   = hp.party_id )
                ELSE
                   CASE WHEN (mmt.source_code = '3PL_REMITTANCE_BRAZIL') THEN
                      (SELECT listagg(DECODE(hcas.global_attribute2
                                           , '2',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'/'|| hcas.global_attribute4 ||'-'|| hcas.global_attribute5
                                           , '1',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'-'|| hcas.global_attribute5 
                                           , '3',HCSU.LOCATION||' - '||hcas.global_attribute3 ),', ' ON OVERFLOW TRUNCATE)
                     WITHIN GROUP (ORDER BY hcas.global_attribute2 asc) 
                         FROM apps.ra_customer_trx_all     rcta
                            , apps.hz_cust_acct_sites_all  hcas
                            , apps.hz_cust_site_uses_all   hcsu
                        WHERE rcta.interface_header_attribute1 = mp.organization_code||'_'||mmt.transaction_reference
                          AND rcta.ship_to_site_use_id         = hcsu.site_use_id
                          AND hcsu.cust_acct_site_id           = hcas.cust_acct_site_id
                          AND rcta.org_id                      = 4330)
                   ELSE
                      (SELECT listagg(DECODE(hcas.global_attribute2
                                           , '2',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'/'|| hcas.global_attribute4 ||'-'|| hcas.global_attribute5
                                           , '1',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'-'|| hcas.global_attribute5 
                                           , '3',HCSU.LOCATION||' - '||hcas.global_attribute3 ),', ' ON OVERFLOW TRUNCATE)
                      WITHIN GROUP (ORDER BY hcas.global_attribute2 asc) 
                         FROM apps.hz_parties             hp
                            , apps.hz_cust_accounts       hca
                            , apps.oe_order_lines_all     oola
                            , apps.hz_cust_acct_sites_all hcas
                            , apps.hz_cust_site_uses_all  hcsu
                        WHERE oola.line_id                = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                          AND oola.ship_to_org_id         = hcsu.site_use_id
                          AND hcsu.cust_acct_site_id      = hcas.cust_acct_site_id
                          AND hcas.cust_account_id        = hca.cust_account_id
                          AND hca.party_id                = hp.party_id  )
                   END
                END  customer_cnpj_cpf
               -- 
              , CASE WHEN (mmt.source_code = '3PL_REMITTANCE_BRAZIL') THEN
                      (SELECT listagg(DECODE(hcas.global_attribute2
                                           , '2',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'/'|| hcas.global_attribute4 ||'-'|| hcas.global_attribute5
                                           , '1',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'-'|| hcas.global_attribute5 
                                           , '3',HCSU.LOCATION||' - '||hcas.global_attribute3 ),', ' ON OVERFLOW TRUNCATE)
                       WITHIN GROUP (ORDER BY hcas.global_attribute2 asc )
                         FROM apps.ra_customer_trx_all         rcta
                            , apps.hz_cust_acct_sites_all      hcas
                            , apps.hz_cust_site_uses_all       hcsu
                        WHERE rcta.interface_header_attribute1 = mp.organization_code||'_'||mmt.transaction_reference
                          AND rcta.bill_to_site_use_id         = hcsu.site_use_id
                          AND hcsu.cust_acct_site_id           = hcas.cust_acct_site_id
                          AND rcta.org_id                      = 4330
                          AND ROWNUM = 1)
                   ELSE
                     --
                     CASE WHEN (select DISTINCT RCTL.INTERFACE_LINE_CONTEXT
                             FROM apps.hz_parties                hp
                                , apps.hz_cust_accounts          hca
                                , apps.oe_order_lines_all        oola
                                , apps.oe_order_headers_all      ooha
                                , apps.ra_customer_trx_lines_all rctl
                                , apps.ra_customer_trx_all       rcta
                                , apps.hz_cust_acct_sites_all    hcas
                                , apps.hz_cust_site_uses_all     hcsu
                            WHERE ooha.header_id                 = oola.header_id
                              AND oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND rctl.inventory_item_id         = oola.inventory_item_id
                              AND rctl.line_type                 = 'LINE'
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE1 = to_char(ooha.order_number)
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE6 = to_char(oola.line_id)
                              AND RCTL.INTERFACE_LINE_CONTEXT    = 'ORDER ENTRY'
                              AND rctl.customer_trx_id           = rcta.customer_trx_id
                              AND rcta.bill_to_site_use_id       = hcsu.site_use_id
                              AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                              AND hcas.cust_account_id           = hca.cust_account_id
                              AND hca.party_id                   = hp.party_id 
                              AND ROWNUM = 1) = 'ORDER ENTRY' THEN
                     --
                     (SELECT DISTINCT DECODE(hcas.global_attribute2
                                           , '2',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'/'|| hcas.global_attribute4 ||'-'|| hcas.global_attribute5
                                           , '1',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'-'|| hcas.global_attribute5 
                                           , '3',HCSU.LOCATION||' - '||hcas.global_attribute3)
                             FROM apps.hz_parties                hp
                                , apps.hz_cust_accounts          hca
                                , apps.oe_order_lines_all        oola
                                , apps.oe_order_headers_all      ooha
                                , apps.ra_customer_trx_lines_all rctl
                                , apps.ra_customer_trx_all       rcta
                                , apps.hz_cust_acct_sites_all    hcas
                                , apps.hz_cust_site_uses_all     hcsu
                            WHERE ooha.header_id                 = oola.header_id
                              AND oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND rctl.inventory_item_id         = oola.inventory_item_id
                              AND rctl.line_type                 = 'LINE'
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE1 = to_char(ooha.order_number)
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE6 = to_char(oola.line_id)
                              AND RCTL.INTERFACE_LINE_CONTEXT    = 'ORDER ENTRY'
                              AND rctl.customer_trx_id           = rcta.customer_trx_id
                              AND rcta.bill_to_site_use_id       = hcsu.site_use_id
                              AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                              AND hcas.cust_account_id           = hca.cust_account_id
                              AND hca.party_id                   = hp.party_id
                              AND ROWNUM = 1)
                     --
                     ELSE
                     --            
                     CASE WHEN 
                          ( SELECT DISTINCT RCTL.INTERFACE_LINE_CONTEXT
                             FROM apps.hz_parties                hp
                                , apps.hz_cust_accounts          hca
                                , apps.oe_order_lines_all        oola
                                , apps.oe_order_headers_all      ooha
                                , apps.ra_customer_trx_lines_all rctl
                                , apps.ra_customer_trx_all       rcta
                                , apps.hz_cust_acct_sites_all    hcas
                                , apps.hz_cust_site_uses_all     hcsu
                            WHERE ooha.header_id                 = oola.header_id
                              AND oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND rctl.inventory_item_id         = oola.inventory_item_id
                              AND rctl.line_type                 = 'LINE'
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE1 = ooha.ORIG_SYS_DOCUMENT_REF
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE7 = oola.ORIG_SYS_LINE_REF
                              AND RCTL.INTERFACE_LINE_CONTEXT    = 'GEMS_PB_RR'
                              AND rctl.customer_trx_id           = rcta.customer_trx_id
                              AND rcta.bill_to_site_use_id       = hcsu.site_use_id
                              AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                              AND hcas.cust_account_id           = hca.cust_account_id
                              AND ROWNUM = 1 ) = 'GEMS_PB_RR' THEN
                     --
                     (SELECT DISTINCT DECODE(hcas.global_attribute2
                                           , '2',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'/'|| hcas.global_attribute4 ||'-'|| hcas.global_attribute5
                                           , '1',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'-'|| hcas.global_attribute5 
                                           , '3',HCSU.LOCATION||' - '||hcas.global_attribute3)
                             FROM apps.hz_parties                hp
                                , apps.hz_cust_accounts          hca
                                , apps.oe_order_lines_all        oola
                                , apps.oe_order_headers_all      ooha
                                , apps.ra_customer_trx_lines_all rctl
                                , apps.ra_customer_trx_all       rcta
                                , apps.hz_cust_acct_sites_all    hcas
                                , apps.hz_cust_site_uses_all     hcsu
                            WHERE ooha.header_id                 = oola.header_id
                              AND oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND rctl.inventory_item_id         = oola.inventory_item_id
                              AND rctl.line_type                 = 'LINE'
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE1 = ooha.ORIG_SYS_DOCUMENT_REF
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE7 = oola.ORIG_SYS_LINE_REF
                              AND RCTL.INTERFACE_LINE_CONTEXT    = 'GEMS_PB_RR'
                              AND rctl.customer_trx_id           = rcta.customer_trx_id
                              AND rcta.bill_to_site_use_id       = hcsu.site_use_id
                              AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                              AND hcas.cust_account_id           = hca.cust_account_id 
                              AND ROWNUM = 1 )
                     --
                     ELSE
                     --
                     (SELECT DISTINCT DECODE(hcas.global_attribute2
                                   , '2',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'/'|| hcas.global_attribute4 ||'-'|| hcas.global_attribute5
                                   , '1',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'-'|| hcas.global_attribute5 
                                   , '3',HCSU.LOCATION||' - '||hcas.global_attribute3)
                             --
                      FROM   APPS.HZ_CUST_ACCT_SITES_ALL HCAS,
                             APPS.HZ_CUST_SITE_USES_ALL  HCSU,
                             APPS.OE_ORDER_LINES_ALL     OOLA,
                             APPS.OE_ORDER_HEADERS_ALL   OOHA
                             --
                      WHERE  HCSU.SITE_USE_CODE     = 'BILL_TO'
                      AND    HCSU.CUST_ACCT_SITE_ID = HCAS.CUST_ACCT_SITE_ID
                      AND    HCSU.SITE_USE_ID       = NVL(OOLA.ATTRIBUTE1, OOHA.INVOICE_TO_ORG_ID)
                      AND    OOLA.LINE_ID           = NVL(MMT.TRX_SOURCE_LINE_ID, MMT.SOURCE_LINE_ID)
                      AND    OOHA.HEADER_ID         = OOLA.HEADER_ID
                      AND    ROWNUM = 1)
                     --
                     END
                  END
               END      bill_to_CNPJ_CPF
               --
                             --
              , CASE WHEN (mmt.source_code = '3PL_REMITTANCE_BRAZIL') THEN
                        (SELECT listagg(hp.party_name,', ' ON OVERFLOW TRUNCATE)  
                        WITHIN GROUP (ORDER BY hp.party_name asc)
                          FROM apps.hz_parties             hp,
                               apps.hz_cust_accounts       hca,
                               apps.ra_customer_trx_all    rcta,
                               apps.hz_cust_acct_sites_all hcas,
                               apps.hz_cust_site_uses_all  hcsu
                         WHERE rcta.interface_header_attribute1 = mp.organization_code||'_'||mmt.transaction_reference
                           AND rcta.bill_to_site_use_id         = hcsu.site_use_id
                           AND hcsu.cust_acct_site_id           = hcas.cust_acct_site_id
                           AND hcas.cust_account_id             = hca.cust_account_id
                           AND hca.party_id                     = hp.party_id
                           AND rcta.org_id                      = 4330)
                   ELSE
                     --
                     CASE WHEN (select DISTINCT RCTL.INTERFACE_LINE_CONTEXT
                             FROM apps.hz_parties                hp
                                , apps.hz_cust_accounts          hca
                                , apps.oe_order_lines_all        oola
                                , apps.oe_order_headers_all      ooha
                                , apps.ra_customer_trx_lines_all rctl
                                , apps.ra_customer_trx_all       rcta
                                , apps.hz_cust_acct_sites_all    hcas
                                , apps.hz_cust_site_uses_all     hcsu
                            WHERE ooha.header_id                 = oola.header_id
                              AND oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND rctl.inventory_item_id         = oola.inventory_item_id
                              AND rctl.line_type                 = 'LINE'
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE1 = to_char(ooha.order_number)
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE6 = to_char(oola.line_id)
                              AND RCTL.INTERFACE_LINE_CONTEXT    = 'ORDER ENTRY'
                              AND rctl.customer_trx_id           = rcta.customer_trx_id
                              AND rcta.bill_to_site_use_id       = hcsu.site_use_id
                              AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                              AND hcas.cust_account_id           = hca.cust_account_id
                              AND hca.party_id                   = hp.party_id 
                              AND ROWNUM = 1) = 'ORDER ENTRY' THEN
                     --
                     (SELECT listagg(hp.party_name,', ' ON OVERFLOW TRUNCATE)  
                         WITHIN GROUP (ORDER BY hp.party_name asc)
                             FROM apps.hz_parties                hp
                                , apps.hz_cust_accounts          hca
                                , apps.oe_order_lines_all        oola
                                , apps.oe_order_headers_all      ooha
                                , apps.ra_customer_trx_lines_all rctl
                                , apps.ra_customer_trx_all       rcta
                                , apps.hz_cust_acct_sites_all    hcas
                                , apps.hz_cust_site_uses_all     hcsu
                            WHERE ooha.header_id                 = oola.header_id
                              AND oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND rctl.inventory_item_id         = oola.inventory_item_id
                              AND rctl.line_type                 = 'LINE'
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE1 = to_char(ooha.order_number)
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE6 = to_char(oola.line_id)
                              AND RCTL.INTERFACE_LINE_CONTEXT    = 'ORDER ENTRY'
                              AND rctl.customer_trx_id           = rcta.customer_trx_id
                              AND rcta.bill_to_site_use_id       = hcsu.site_use_id
                              AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                              AND hcas.cust_account_id           = hca.cust_account_id
                              AND hca.party_id                   = hp.party_id
                              AND ROWNUM = 1)
                     --
                     ELSE
                     --            
                     CASE WHEN 
                          ( SELECT DISTINCT RCTL.INTERFACE_LINE_CONTEXT
                             FROM apps.hz_parties                hp
                                , apps.hz_cust_accounts          hca
                                , apps.oe_order_lines_all        oola
                                , apps.oe_order_headers_all      ooha
                                , apps.ra_customer_trx_lines_all rctl
                                , apps.ra_customer_trx_all       rcta
                                , apps.hz_cust_acct_sites_all    hcas
                                , apps.hz_cust_site_uses_all     hcsu
                            WHERE ooha.header_id                 = oola.header_id
                              AND oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND rctl.inventory_item_id         = oola.inventory_item_id
                              AND rctl.line_type                 = 'LINE'
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE1 = ooha.ORIG_SYS_DOCUMENT_REF
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE7 = oola.ORIG_SYS_LINE_REF
                              AND RCTL.INTERFACE_LINE_CONTEXT    = 'GEMS_PB_RR'
                              AND rctl.customer_trx_id           = rcta.customer_trx_id
                              AND rcta.bill_to_site_use_id       = hcsu.site_use_id
                              AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                              AND hcas.cust_account_id           = hca.cust_account_id
                              AND ROWNUM = 1 ) = 'GEMS_PB_RR' THEN
                     --
                     (SELECT listagg(hp.party_name,', ' ON OVERFLOW TRUNCATE)  
                         WITHIN GROUP (ORDER BY hp.party_name asc)
                             FROM apps.hz_parties                hp
                                , apps.hz_cust_accounts          hca
                                , apps.oe_order_lines_all        oola
                                , apps.oe_order_headers_all      ooha
                                , apps.ra_customer_trx_lines_all rctl
                                , apps.ra_customer_trx_all       rcta
                                , apps.hz_cust_acct_sites_all    hcas
                                , apps.hz_cust_site_uses_all     hcsu
                            WHERE ooha.header_id                 = oola.header_id
                              AND oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND rctl.inventory_item_id         = oola.inventory_item_id
                              AND rctl.line_type                 = 'LINE'
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE1 = ooha.ORIG_SYS_DOCUMENT_REF
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE7 = oola.ORIG_SYS_LINE_REF
                              AND RCTL.INTERFACE_LINE_CONTEXT    = 'GEMS_PB_RR'
                              AND rctl.customer_trx_id           = rcta.customer_trx_id
                              AND rcta.bill_to_site_use_id       = hcsu.site_use_id
                              AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                              AND hcas.cust_account_id           = hca.cust_account_id 
                              AND ROWNUM = 1 )
                     --
                     ELSE
                     --
                     (SELECT listagg(hp.party_name,', ' ON OVERFLOW TRUNCATE)  
                         WITHIN GROUP (ORDER BY hp.party_name asc)
                      FROM   APPS.HZ_CUST_ACCT_SITES_ALL HCAS,
                             apps.hz_parties             hp,
                             apps.hz_cust_accounts       hca,
                             APPS.HZ_CUST_SITE_USES_ALL  HCSU,
                             APPS.OE_ORDER_LINES_ALL     OOLA,
                             APPS.OE_ORDER_HEADERS_ALL   OOHA
                             --
                      WHERE  HCSU.SITE_USE_CODE     = 'BILL_TO'
                      AND    HCSU.CUST_ACCT_SITE_ID = HCAS.CUST_ACCT_SITE_ID
                      AND    HCSU.SITE_USE_ID       = NVL(OOLA.ATTRIBUTE1, OOHA.INVOICE_TO_ORG_ID)
                      AND    OOLA.LINE_ID           = NVL(MMT.TRX_SOURCE_LINE_ID, MMT.SOURCE_LINE_ID)
                      AND    OOHA.HEADER_ID         = OOLA.HEADER_ID
                      AND    hcas.cust_account_id   = hca.cust_account_id
                      AND    hca.party_id           = hp.party_id 
                      AND    ROWNUM = 1)
                     --          
                     END
                  END
               END      bill_to_Customer_name
               --
                , CASE WHEN (mmt.source_code = '3PL_REMITTANCE_BRAZIL') THEN
                      (SELECT listagg(DECODE(hcas.global_attribute2
                                           , '2',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'/'|| hcas.global_attribute4 ||'-'|| hcas.global_attribute5
                                           , '1',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'-'|| hcas.global_attribute5 
                                           , '3',HCSU.LOCATION||' - '||hcas.global_attribute3 ),', ' ON OVERFLOW TRUNCATE)
                       WITHIN GROUP (ORDER BY hcas.global_attribute2 asc )
                         FROM apps.ra_customer_trx_all         rcta
                            , apps.hz_cust_acct_sites_all      hcas
                            , apps.hz_cust_site_uses_all       hcsu
                        WHERE rcta.interface_header_attribute1 = mp.organization_code||'_'||mmt.transaction_reference
                          AND rcta.ship_to_site_use_id         = hcsu.site_use_id
                          AND hcsu.cust_acct_site_id           = hcas.cust_acct_site_id
                          AND rcta.org_id                      = 4330
                          AND ROWNUM = 1)
                   ELSE
                     --
                     CASE WHEN (select DISTINCT RCTL.INTERFACE_LINE_CONTEXT
                             FROM apps.hz_parties                hp
                                , apps.hz_cust_accounts          hca
                                , apps.oe_order_lines_all        oola
                                , apps.oe_order_headers_all      ooha
                                , apps.ra_customer_trx_lines_all rctl
                                , apps.ra_customer_trx_all       rcta
                                , apps.hz_cust_acct_sites_all    hcas
                                , apps.hz_cust_site_uses_all     hcsu
                            WHERE ooha.header_id                 = oola.header_id
                              AND oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND rctl.inventory_item_id         = oola.inventory_item_id
                              AND rctl.line_type                 = 'LINE'
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE1 = to_char(ooha.order_number)
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE6 = to_char(oola.line_id)
                              AND RCTL.INTERFACE_LINE_CONTEXT    = 'ORDER ENTRY'
                              AND rctl.customer_trx_id           = rcta.customer_trx_id
                              AND rcta.ship_to_site_use_id       = hcsu.site_use_id
                              AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                              AND hcas.cust_account_id           = hca.cust_account_id
                              AND hca.party_id                   = hp.party_id 
                              AND ROWNUM = 1) = 'ORDER ENTRY' THEN
                     --
                     (SELECT DISTINCT DECODE(hcas.global_attribute2
                                           , '2',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'/'|| hcas.global_attribute4 ||'-'|| hcas.global_attribute5
                                           , '1',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'-'|| hcas.global_attribute5 
                                           , '3',HCSU.LOCATION||' - '||hcas.global_attribute3)
                             FROM apps.hz_parties                hp
                                , apps.hz_cust_accounts          hca
                                , apps.oe_order_lines_all        oola
                                , apps.oe_order_headers_all      ooha
                                , apps.ra_customer_trx_lines_all rctl
                                , apps.ra_customer_trx_all       rcta
                                , apps.hz_cust_acct_sites_all    hcas
                                , apps.hz_cust_site_uses_all     hcsu
                            WHERE ooha.header_id                 = oola.header_id
                              AND oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND rctl.inventory_item_id         = oola.inventory_item_id
                              AND rctl.line_type                 = 'LINE'
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE1 = to_char(ooha.order_number)
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE6 = to_char(oola.line_id)
                              AND RCTL.INTERFACE_LINE_CONTEXT    = 'ORDER ENTRY'
                              AND rctl.customer_trx_id           = rcta.customer_trx_id
                              AND rcta.ship_to_site_use_id       = hcsu.site_use_id
                              AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                              AND hcas.cust_account_id           = hca.cust_account_id
                              AND hca.party_id                   = hp.party_id
                              AND ROWNUM = 1)
                     --
                     ELSE
                     --            
                     CASE WHEN 
                          ( SELECT DISTINCT RCTL.INTERFACE_LINE_CONTEXT
                             FROM apps.hz_parties                hp
                                , apps.hz_cust_accounts          hca
                                , apps.oe_order_lines_all        oola
                                , apps.oe_order_headers_all      ooha
                               , apps.ra_customer_trx_lines_all rctl
                                , apps.ra_customer_trx_all       rcta
                                , apps.hz_cust_acct_sites_all    hcas
                                , apps.hz_cust_site_uses_all     hcsu
                            WHERE ooha.header_id                 = oola.header_id
                              AND oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND rctl.inventory_item_id         = oola.inventory_item_id
                              AND rctl.line_type                 = 'LINE'
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE1 = ooha.ORIG_SYS_DOCUMENT_REF
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE7 = oola.ORIG_SYS_LINE_REF
                              AND RCTL.INTERFACE_LINE_CONTEXT    = 'GEMS_PB_RR'
                              AND rctl.customer_trx_id           = rcta.customer_trx_id
                              AND rcta.ship_to_site_use_id       = hcsu.site_use_id
                              AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                              AND hcas.cust_account_id           = hca.cust_account_id
                              AND ROWNUM = 1 ) = 'GEMS_PB_RR' THEN
                     --
                     (SELECT DISTINCT DECODE(hcas.global_attribute2
                                           , '2',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'/'|| hcas.global_attribute4 ||'-'|| hcas.global_attribute5
                                           , '1',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'-'|| hcas.global_attribute5 
                                           , '3',HCSU.LOCATION||' - '||hcas.global_attribute3)
                             FROM apps.hz_parties                hp
                                , apps.hz_cust_accounts          hca
                                , apps.oe_order_lines_all        oola
                                , apps.oe_order_headers_all      ooha
                                , apps.ra_customer_trx_lines_all rctl
                                , apps.ra_customer_trx_all       rcta
                                , apps.hz_cust_acct_sites_all    hcas
                                , apps.hz_cust_site_uses_all     hcsu
                            WHERE ooha.header_id                 = oola.header_id
                              AND oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND rctl.inventory_item_id         = oola.inventory_item_id
                              AND rctl.line_type                 = 'LINE'
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE1 = ooha.ORIG_SYS_DOCUMENT_REF
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE7 = oola.ORIG_SYS_LINE_REF
                              AND RCTL.INTERFACE_LINE_CONTEXT    = 'GEMS_PB_RR'
                              AND rctl.customer_trx_id           = rcta.customer_trx_id
                              AND rcta.ship_to_site_use_id       = hcsu.site_use_id
                              AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                              AND hcas.cust_account_id           = hca.cust_account_id 
                              AND ROWNUM = 1 )
                     --
                     ELSE
                     --
                     (SELECT listagg(DECODE(hcas.global_attribute2
                                           , '2',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'/'|| hcas.global_attribute4 ||'-'|| hcas.global_attribute5
                                           , '1',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'-'|| hcas.global_attribute5 
                                           , '3',HCSU.LOCATION||' - '||hcas.global_attribute3 ),', ' ON OVERFLOW TRUNCATE)
                      WITHIN GROUP (ORDER BY hcas.global_attribute2 asc) 
                         FROM apps.hz_parties             hp
                            , apps.hz_cust_accounts       hca
                            , apps.oe_order_lines_all     oola
                            , apps.hz_cust_acct_sites_all hcas
                            , apps.hz_cust_site_uses_all  hcsu
                        WHERE oola.line_id                = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                          AND oola.ship_to_org_id         = hcsu.site_use_id
                          AND hcsu.cust_acct_site_id      = hcas.cust_acct_site_id
                          AND hcas.cust_account_id        = hca.cust_account_id
                          AND hca.party_id                = hp.party_id  )
                     --
                     END
                  END
               END      ship_to_CNPJ_CPF
               --
              , CASE WHEN ( SELECT ottl.name
                              FROM apps.oe_transaction_types_tl    ottl
                                 , apps.oe_order_headers_all  ooha
                                 , apps.oe_order_lines_all    oola  
                             WHERE oola.line_id        = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                               AND oola.header_id      = ooha.header_id
                               AND ooha.order_type_id  = ottl.transaction_type_id  ) = 'GPO_BR_FE_SHIPMENT' THEN
                      (SELECT listagg(hzl.address1 ||' - '|| hzl.address2 || ' - ' || hzl.city || '-' || hzl.state || ' / ' || hzl.postal_code,', ' ON OVERFLOW TRUNCATE)  
                       WITHIN GROUP (ORDER BY hzl.address1 asc)
                       FROM apps.hz_parties             hp
                        , apps.hz_party_sites         hps
                        , apps.hz_cust_accounts       hca
                        , apps.oe_order_lines_all     oola
                        , apps.hz_cust_acct_sites_all hcas
                        , apps.hz_cust_site_uses_all  hcsu
                        , apps.hz_locations           hzl
                    WHERE oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                      AND oola.end_customer_site_use_id  = hcsu.site_use_id
                      AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                      AND hcas.cust_account_id           = hca.cust_account_id
                      AND hcas.party_site_id             = hps.party_site_id
                      AND hca.party_id                   = hp.party_id
                      AND hps.party_id                   = hp.party_id
                      AND hps.location_id                = hzl.location_id)
                ELSE
                   CASE WHEN (mmt.source_code = '3PL_REMITTANCE_BRAZIL') THEN
                      (SELECT listagg(hzl.address1 ||' - '|| hzl.address2 || ' - ' || hzl.city || '-' || hzl.state || ' / ' || hzl.postal_code,', ' ON OVERFLOW TRUNCATE)  
                       WITHIN GROUP (ORDER BY hzl.address1 asc)
                         FROM apps.ra_customer_trx_all     rcta
                            , apps.hz_cust_acct_sites_all  hcas
                            , apps.hz_cust_site_uses_all   hcsu
                            , apps.hz_parties              hp
                            , apps.hz_party_sites          hps
                            , apps.hz_cust_accounts        hca
                            , apps.hz_locations            hzl
                        WHERE rcta.interface_header_attribute1 = mp.organization_code||'_'||mmt.transaction_reference
                          AND rcta.ship_to_site_use_id         = hcsu.site_use_id
                          AND hcsu.cust_acct_site_id           = hcas.cust_acct_site_id
                          AND hcas.cust_account_id             = hca.cust_account_id
                          AND hcas.party_site_id               = hps.party_site_id
                          AND hca.party_id                     = hp.party_id
                          AND hps.party_id                     = hp.party_id
                          AND hps.location_id                  = hzl.location_id
                          AND rcta.org_id                      = 4330)
                   ELSE
                      (SELECT listagg(hzl.address1 ||' - '|| hzl.address2 || ' - ' || hzl.city || '-' || hzl.state || ' / ' || hzl.postal_code,', ' ON OVERFLOW TRUNCATE)  
                       WITHIN GROUP (ORDER BY hzl.address1 asc)
                          FROM apps.hz_parties             hp
                             , apps.hz_party_sites         hps
                             , apps.hz_cust_accounts       hca
                             , apps.oe_order_lines_all     oola
                             , apps.hz_cust_acct_sites_all hcas
                             , apps.hz_cust_site_uses_all  hcsu
                             , apps.hz_locations           hzl
                         WHERE oola.line_id                = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                           AND oola.ship_to_org_id         = hcsu.site_use_id
                           AND hcsu.cust_acct_site_id      = hcas.cust_acct_site_id
                           AND hcas.cust_account_id        = hca.cust_account_id
                           AND hcas.party_site_id          = hps.party_site_id
                           AND hca.party_id                = hp.party_id
                           AND hps.party_id                = hp.party_id
                           AND hps.location_id             = hzl.location_id   )
                   END
                END customer_address
                -- 
                -- alterado para BIll_to por Sinval fim
                -- 
              , CASE WHEN (mmt.source_code = '3PL_REMITTANCE_BRAZIL') THEN
                   (SELECT listagg(rcta.trx_number,', ' ON OVERFLOW TRUNCATE)  
                           WITHIN GROUP (ORDER BY rcta.trx_number asc)
                      FROM apps.ra_customer_trx_all       rcta
                     WHERE rcta.interface_header_attribute1  = mp.organization_code||'_'||mmt.transaction_reference
                       AND rcta.org_id                       = 4330
                       AND NVL(rcta.status_trx,'XX')         <> 'VD'
                       AND NVL(rcta.reason_code,'XX')        <> 'CANCELLATION')
                ELSE
                   (SELECT distinct RTRIM(REGEXP_REPLACE((listagg(rcta.trx_number,', ' ON OVERFLOW TRUNCATE)  
                      WITHIN GROUP (ORDER BY rcta.trx_number asc) ), '([^,]*)(,\1)+($|,)', '\1\3'),',')
                      FROM apps.ra_customer_trx_lines_all rctla
                         , apps.ra_customer_trx_all       rcta
                         , apps.oe_order_lines_all        oola
                         , apps.oe_order_headers_all      ooha
                     WHERE rcta.customer_trx_id              = rctla.customer_trx_id
                       AND oola.line_id                      = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                       AND oola.header_id                    = ooha.header_id
                       AND rctla.sales_order                 = to_char(ooha.order_number)
                       AND rctla.line_type                   = 'LINE'
                       AND rcta.batch_source_id              <> 6266 -- No RR invoices
                       AND DECODE(rctla.interface_line_context,'GEMS_PB_RR',rcta.interface_header_attribute11,'999')
                           = DECODE(rctla.interface_line_context,'GEMS_PB_RR',rcta.interface_header_attribute11,'999')
                       AND rcta.org_id                       = 4330
                       AND trunc(rcta.trx_date)              BETWEEN (trunc(mmt.transaction_date)-3) AND (trunc(mmt.transaction_date)+3)
                       AND NVL(rcta.status_trx,'XX')         <> 'VD'
                       AND NVL(rcta.reason_code,'XX')        <> 'CANCELLATION')
                END   invoice_number_ar
              , ( SELECT listagg(mrav.reservation_quantity,', ' ON OVERFLOW TRUNCATE)  
                  WITHIN GROUP (ORDER BY mrav.reservation_quantity asc) 
                    FROM apps.mtl_reservations_all_v  mrav 
                       , apps.oe_order_headers_all    ooha1
                   WHERE mrav.demand_source_header_id     = ooha1.header_id
                     AND mrav.demand_source_line_id       = NVL(mmt.trx_source_line_id, mmt.source_line_id) )  reservation_quantity
              , ( SELECT listagg(ooha1.order_number,', ' ON OVERFLOW TRUNCATE)  
                  WITHIN GROUP (ORDER BY ooha1.order_number asc) 
                    FROM apps.mtl_reservations_all_v  mrav 
                       , apps.oe_order_headers_all    ooha1
                   WHERE mrav.demand_source_header_id     = ooha1.header_id
                     AND mrav.demand_source_line_id       = NVL(mmt.trx_source_line_id, mmt.source_line_id) )  reservation_order_number
              , (SELECT distinct hp.party_name
                 --WITHIN GROUP (ORDER BY hp.party_name asc)
                   FROM apps.hz_parties              hp
                      , apps.hz_cust_accounts        hca
                      , apps.oe_order_lines_all      oola1
                      , apps.oe_order_headers_all    ooha1
                      , apps.mtl_reservations_all_v  mrav 
                  WHERE mrav.demand_source_header_id   = ooha1.header_id
                    AND mrav.demand_source_line_id     = oola1.line_id
                    AND oola1.line_id                  = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                    AND oola1.ship_to_org_id           = hca.cust_account_id
                    AND hca.party_id                   = hp.party_id )         reservation_customer_name
              , gcc1.concatenated_segments   material_account
              , gcc2.concatenated_segments   outside_processing_account
              , gcc3.concatenated_segments   material_overhead_account
              , gcc4.concatenated_segments   overhead_account
              , gcc5.concatenated_segments   resource_account
              , sysdate                                           report_date_and_time 
              , to_char(mmt.transaction_id)  transaction_id
              , fu.user_name ||' / '|| fu.description                                    user_name
              , DECODE( lot_control_code, 1 ,'Sem controle de Lote' , 2,'Com controle de Lote')   lot_control
              , DECODE( serial_number_control_code, 1, 'Sem controle de Serial'
                                                  , 2, 'Pre-definido'
                                                  , 5, 'No Recebimento'
                                                  , 6, 'Baixa na Ordem de Venda' )  serial_control
              , CASE
                 WHEN    nvl(mmt.lpn_id, mmt.content_lpn_id) IS NULL AND moq.subinventory_code <> 'WHGU42GNAT'
                   THEN 
                    (SELECT listagg(lpn.license_plate_number,', ' ON OVERFLOW TRUNCATE)WITHIN GROUP (ORDER BY lpn.license_plate_number asc)
                             FROM apps.MTL_MATERIAL_TRANSACTIONS   mtt,
                                  apps.wms_license_plate_numbers   lpn,
                                  apps.oe_order_lines_all          ool
                            WHERE 1 = 1
                              AND mtt.TRX_SOURCE_LINE_ID = CASE
                                                              WHEN LINE_CATEGORY_CODE = 'ORDER'
                                                                THEN ool.line_id
                                                              WHEN LINE_CATEGORY_CODE = 'RETURN'  
                                                                THEN   
                                                                to_number(NVL(SUBSTR(ool.ORIG_SYS_LINE_REF,
                                                                                     0,
                                                                                     INSTR(ool.ORIG_SYS_LINE_REF, '.') - 1),
                                                                              -1)) -- RMA FE OE Line Id
                                                                ELSE -1
                                                                  END
                              AND mtt.TRANSACTION_TYPE_ID = 52 --sales order pick FE ORDER
                              AND mtt.transaction_quantity < 0
                              AND mtt.inventory_item_id = ool.inventory_item_id
                              AND nvl(mtt.lpn_id, mtt.content_lpn_id) = nvl(lpn.lpn_id, -1)
                              AND ool.line_id = CASE
                                                  WHEN mtt.transaction_type_name = 'RMA Receipt'
                                                    THEN mmt.TRX_SOURCE_LINE_ID
                                                  WHEN mtt.transaction_type_name = 'GPO Nationalization Receipt'
                                                     THEN 
                                                      to_number(NVL(SUBSTR(RTRIM(LTRIM(translate(mmt.TRANSACTION_REFERENCE,translate(mmt.TRANSACTION_REFERENCE||'a','1234567890.',' '),' '))),
                                                         0,
                                                         INSTR(RTRIM(LTRIM(translate(mmt.TRANSACTION_REFERENCE,translate(mmt.TRANSACTION_REFERENCE||'a','1234567890.',' '),' '))), '.') - 1),
                                                  -1))
                                                  ELSE -1
                                                    END)
                              WHEN moq.subinventory_code = 'WHGU42GNAT'
                  THEN (SELECT listagg(wlp.license_plate_number,', ' ON OVERFLOW TRUNCATE)  
                            WITHIN GROUP (ORDER BY wlp.license_plate_number asc)
                        FROM   gems_ont.ge_gpo_nationalization_line gnl, 
                               gems_ont.ge_gpo_nationalization_line gn2,
                               apps.wms_license_plate_numbers       wlp,
                               apps.po_line_locations_all           pll,
                               apps.po_lines_all                    pol,
                               apps.po_headers_all                  poh,
                               apps.rcv_shipment_headers            rsh,
                               apps.rcv_transactions                rt
                        Where  wlp.lpn_id(+) = gn2.lpn_id
                        AND gnl.nationalization_so_line_id = gn2.nationalization_so_line_id
                        AND pll.line_location_id = gnl.DOCUMENT_ID
                        AND pll.po_header_id = poh.po_header_id
                        AND pll.po_line_id = pol.po_line_id
                        AND gn2.record_type = 'IMPORT'
                        AND gnl.record_type = 'NATIONALIZATION'
                        AND rt.transaction_id                = mmt.rcv_transaction_id
                        AND rt.po_line_location_id           = pll.line_location_id
                        AND rt.shipment_header_id            = rsh.shipment_header_id)
                ELSE (SELECT lpn.LICENSE_PLATE_NUMBER
                           FROM   apps.wms_license_plate_numbers   lpn
                           WHERE  nvl(mmt.lpn_id, mmt.content_lpn_id) = nvl(lpn.lpn_id, -1))
                        END LPN_Value                                    
             , 'q6' query
--, mmt.transaction_type_id
--, mmt.trx_source_line_id
--, mmt.source_line_id
           FROM apps.mtl_parameters                  mp
              , apps.mtl_system_items_b              msi
              , apps.mtl_secondary_inventories_fk_v  msifv
              , apps.gl_code_combinations            gcc
              , apps.gl_code_combinations_kfv        gcc1
              , apps.gl_code_combinations_kfv        gcc2
              , apps.gl_code_combinations_kfv        gcc3
              , apps.gl_code_combinations_kfv        gcc4
              , apps.gl_code_combinations_kfv        gcc5
              , apps.mtl_item_locations_kfv          milk
              , AMARCHIVE.MTL_MATERIAL_TRANSACTIONS       mmt
              , apps.mtl_transaction_types           mtt
              , apps.mtl_txn_source_types            mtst
              , apps.fnd_flex_values_vl              ffvv
              , apps.fnd_flex_value_sets             ffvs
              , apps.fnd_user                        fu
              , ( SELECT organization_id
                       , inventory_item_id
                       , subinventory_code
                       , locator_id
                       , lot_number
                       --, transaction_uom_code
                       , create_transaction_id
                       , SUM (primary_transaction_quantity) onhand_qty
                    FROM apps.mtl_onhand_quantities_detail
                   WHERE organization_id IN (SELECT ood.organization_id FROM apps.org_organization_definitions ood WHERE ood.set_of_books_id = 230 )
                   GROUP BY organization_id
                          , inventory_item_id
                          , subinventory_code
                          , locator_id
                        --  , revision
                          , lot_number
                          --, transaction_uom_code
                          , create_transaction_id ) moq
                          ,APPS.MTL_PAC_ACTUAL_COST_DETAILS MPACD 
          WHERE 1                                = 1
          AND decode(mmt.periodic_primary_quantity,null,mmt.transfer_transaction_id,MMT.TRANSACTION_ID) = MPACD.TRANSACTION_ID  
            AND mp.organization_id               = msi.organization_id
--            AND msi.segment1 = '60510302'
            AND msifv.organization_id            = msi.organization_id
            AND msifv.secondary_inventory_name   = moq.subinventory_code
            AND msifv.material_account           = gcc1.code_combination_id
            AND msifv.outside_processing_account = gcc2.code_combination_id
            AND msifv.material_overhead_account  = gcc3.code_combination_id
            AND msifv.overhead_account           = gcc4.code_combination_id
            AND msifv.resource_account           = gcc5.code_combination_id
            AND msi.cost_of_sales_account       = gcc.code_combination_id
            AND ffvs.flex_value_set_name        = 'GE_GL_AFF_ES_PRODUCT_LINE'
            AND ffvs.flex_value_set_id          = ffvv.flex_value_set_id
            AND ffvv.flex_value_meaning         = gcc.segment8
            AND 'TYPE 1'                        IN ('TYPE 1')
            AND msi.organization_id             IN (SELECT ood.organization_id FROM apps.org_organization_definitions ood WHERE ood.set_of_books_id = 230 )
            AND moq.inventory_item_id           = msi.inventory_item_id
            AND moq.organization_id             = msi.organization_id
            AND moq.locator_id                  = milk.inventory_location_id
            AND moq.create_transaction_id       = mmt.transaction_id
--    AND MMT.TRANSACTION_ID = 2562828197
            AND mtt.transaction_type_id         = mmt.transaction_type_id 
            AND mtst.transaction_source_type_id = mmt.transaction_source_type_id
            AND msi.serial_number_control_code IN ('1', '6') 
            AND fu.user_id                      = mmt.created_by 
            AND EXISTS (SELECT 1       
                          FROM apps.mtl_lot_numbers     mln
                         WHERE mln.lot_number           = moq.lot_number
                           AND mln.inventory_item_id    = msi.inventory_item_id
                           AND mln.organization_id      = mp.organization_id  )
    AND MMT.TRANSACTION_ID NOT IN(SELECT MMT2.TRANSACTION_ID 
                                  FROM APPS.MTL_MATERIAL_TRANSACTIONS MMT2
                                  WHERE MMT2.TRANSACTION_ID = MMT.TRANSACTION_ID)
------------------------------------------------------------------------------
UNION  
------------------------------------------------------------------------------ 
-- Sem Controle de Serial e sem Controle de Lote e Sem Locator
         SELECT DISTINCT  --'7' NUM
        /* ( SELECT ccg.cost_group 
                             FROM apps.cst_cost_groups            ccg
                                , apps.cst_cost_group_assignments ccga
                            WHERE ccga.cost_group_id     = ccg.cost_group_id
                              AND ccga.organization_id   = mp.organization_id )  cost_group*/
            ( SELECT ccg.cost_group 
                             FROM apps.cst_cost_groups            ccg
                            WHERE MPACD.cost_group_id     = ccg.cost_group_id )  cost_group  
              , ( SELECT ( SELECT cpp1.period_name 
                             FROM apps.cst_pac_item_costs   cst
                                , apps.cst_pac_periods      cpp1
                            WHERE cst.pac_period_id     = (SELECT MAX(PAC_PERIOD_ID)                   FROM APPS.CST_PAC_PERIODS                  WHERE LEGAL_ENTITY = (SELECT LEGAL_ENTITY                                          FROM APPS.ORG_ORGANIZATION_DEFINITIONS OOD                                         WHERE OOD.ORGANIZATION_ID = mp.organization_id                                         ) )
                              AND cst.pac_period_id     = cpp1.pac_period_id
                              AND cst.inventory_item_id = msi.inventory_item_id
                              AND cst.cost_group_id     = ccg.cost_group_id )  
                    FROM apps.cst_cost_groups            ccg
                       , apps.cst_cost_group_assignments ccga
                   WHERE ccga.cost_group_id     = ccg.cost_group_id
                     AND ccga.organization_id   = mp.organization_id ) period_name
              , mp.organization_code
              , mp.attribute7                organization_type
              , mp.organization_id 
              , moq.subinventory_code
              , msifv.description            subinv_description
              , NULL   locators
              , DECODE( msifv.asset_inventory, 1 , 'Asset', 2, 'Non Asset')   asset_type
              , msi.segment1                 part_number
              , DECODE(msi.inventory_asset_flag, NULL, 'No', 'N', 'No', 'Y', 'Yes')                         flag_asset_inventory
              , DECODE(msi.costing_enabled_flag, NULL, 'No', 'N', 'No', 'Y', 'Yes')                         flag_de_custo
              , msi.description              descrip_eng
              , msi.attribute3               descrip_ptb
              , msi.creation_date            item_creation_date
              , (trunc(SYSDATE) - trunc(msi.creation_date))      days_from_creation
              , gcc.segment8                                     product_line
              , ffvv.description                                 desc_prod_line   
              , msi.primary_uom_code    uom
              , moq.onhand_qty                                   transaction_quantity
              , NVL(( SELECT cic.item_cost
                        FROM apps.cst_item_costs cic
                       WHERE cic.organization_id   = msi.organization_id
                         AND cic.inventory_item_id = msi.inventory_item_id
                         AND cic.cost_type_id      = 1 ),0)  custo_unit_inv
              /*, nvl(( SELECT ( SELECT ROUND (cst.item_cost,2) 
                                 FROM apps.cst_pac_item_costs   cst
                                WHERE cst.pac_period_id     = (SELECT MAX(PAC_PERIOD_ID)                   FROM APPS.CST_PAC_PERIODS                  WHERE LEGAL_ENTITY = (SELECT LEGAL_ENTITY                                          FROM APPS.ORG_ORGANIZATION_DEFINITIONS OOD                                         WHERE OOD.ORGANIZATION_ID = mp.organization_id                                         ) )
                                  AND cst.inventory_item_id = msi.inventory_item_id
                                  AND cst.cost_group_id     = ccg.cost_group_id )  item_cost
                        FROM apps.cst_cost_groups            ccg
                           , apps.cst_cost_group_assignments ccga
                       WHERE ccga.cost_group_id     = ccg.cost_group_id
                         AND ccga.organization_id   = mp.organization_id ) ,0) custo_unit_pac*/
                , nvl((SELECT ROUND (cst.item_cost,2) 
                       FROM apps.cst_pac_item_costs   cst
                      WHERE cst.pac_period_id     = (SELECT MAX(PAC_PERIOD_ID)                   
                                                                FROM APPS.CST_PAC_PERIODS                  
                                                                WHERE LEGAL_ENTITY = (SELECT LEGAL_ENTITY                                         
                                                                                        FROM APPS.ORG_ORGANIZATION_DEFINITIONS OOD                                        
                                                                                        WHERE OOD.ORGANIZATION_ID = mp.organization_id
                                                        ) )
                        AND cst.inventory_item_id = msi.inventory_item_id
                        AND cst.cost_group_id     = MPACD.cost_group_id) ,0)  custo_unit_pac
              , moq.lot_number
              , ( SELECT mln.creation_date        
                    FROM apps.mtl_lot_numbers              mln
                   WHERE mln.lot_number           = moq.lot_number
                     AND mln.inventory_item_id    = msi.inventory_item_id
                     AND mln.organization_id      = mp.organization_id  )  lot_creation_date
              , NULL   lot_qty_days_creation
              , ( SELECT mln.expiration_date         
                    FROM apps.mtl_lot_numbers              mln
                   WHERE mln.lot_number           = moq.lot_number
                     AND mln.inventory_item_id    = msi.inventory_item_id
                     AND mln.organization_id      = mp.organization_id  )  lot_expiration_date
              , NULL  serial_number
              , NULL  serial_creation_date
              , mtt.transaction_type_name           last_transaction_type
              , mmt.transaction_source_name         last_transaction_source
              , mtst.transaction_source_type_name   last_source_type
              , mmt.source_code
              , TO_CHAR(mmt.transaction_date, 'DD-MON-RRRR')      transaction_date
        , (SELECT TO_CHAR(mmt1.transaction_date, 'DD-MON-RRRR') 
                        FROM apps.mtl_material_transactions mmt1
                        WHERE mmt1.transaction_type_id=420
                        AND mmt1.source_line_id=mmt.source_line_id) initial_consignment_date  
              , (TRUNC ( SYSDATE )- TRUNC(mmt.transaction_date))  transaction_qty_of_days
              , TO_CHAR(mmt.transaction_reference)                transaction_reference
              , CASE WHEN mmt.source_code = '3PL_REMITTANCE_BRAZIL' THEN
                     (SELECT listagg(pha.segment1,', ' ON OVERFLOW TRUNCATE)  
                      WITHIN GROUP (ORDER BY pha.segment1 asc)
                        FROM apps.po_headers_all        pha,
                             apps.po_lines_all          pla
                       WHERE pla.po_line_id   = mmt.source_line_id
                         AND pla.po_header_id = pha.po_header_id)
                     WHEN mmt.source_code IN ('ORDER ENTRY','IIP') THEN
                        NULL
                     WHEN mmt.source_code = 'RCV' THEN
                        ( SELECT listagg(pha.segment1,', ' ON OVERFLOW TRUNCATE)  
                          WITHIN GROUP (ORDER BY pha.segment1 asc)
                            FROM apps.po_headers_all            pha
                               , apps.po_lines_all              pla
                               , apps.po_line_locations_all     plla
                               , apps.rcv_shipment_headers      rsh
                               , apps.rcv_transactions          rt
                           WHERE rt.transaction_id                = mmt.rcv_transaction_id
                             AND rt.po_line_location_id           = plla.line_location_id
                             AND plla.po_line_id                  = pla.po_line_id
                             AND pha.po_header_id                 = pla.po_header_id
                             AND rt.shipment_header_id            = rsh.shipment_header_id
                             AND rsh.receipt_source_code          = 'VENDOR'  )
                     ELSE
                        NULL
                END      po_number
              , CASE WHEN mmt.source_code = '3PL_REMITTANCE_BRAZIL' THEN
                     (SELECT listagg(aps.vendor_name,', ' ON OVERFLOW TRUNCATE)  
                      WITHIN GROUP (ORDER BY aps.vendor_name asc)
                        FROM apps.po_headers_all        pha
                           , apps.po_lines_all          pla
                           , apps.ap_suppliers          aps
                           , apps.ap_supplier_sites_all  apss
                       WHERE pla.po_line_id     = mmt.source_line_id
                         AND pla.po_header_id   = pha.po_header_id
                         AND pha.vendor_id      = aps.vendor_id
                         AND aps.vendor_id      = apss.vendor_id
                         AND pha.vendor_site_id = apss.vendor_site_id )
                     WHEN mmt.source_code IN ('ORDER ENTRY','IIP') THEN
                        NULL
                     WHEN mmt.source_code = 'RCV' THEN
                        ( SELECT listagg(aps.vendor_name,', ' ON OVERFLOW TRUNCATE)  
                          WITHIN GROUP (ORDER BY aps.vendor_name asc)
                            FROM apps.po_headers_all            pha
                               , apps.po_lines_all              pla
                               , apps.po_line_locations_all     plla
                               , apps.rcv_shipment_headers      rsh
                               , apps.rcv_transactions          rt
                               , apps.ap_suppliers              aps
                               , apps.ap_supplier_sites_all     apss
                           WHERE rt.transaction_id          = mmt.rcv_transaction_id
                             AND rt.po_line_location_id     = plla.line_location_id
                             AND plla.po_line_id            = pla.po_line_id
                             AND pha.po_header_id           = pla.po_header_id
                             AND rt.shipment_header_id      = rsh.shipment_header_id
                             AND rsh.receipt_source_code    = 'VENDOR'
                             AND pha.vendor_id              = aps.vendor_id
                             AND aps.vendor_id              = apss.vendor_id
                             AND pha.vendor_site_id         = apss.vendor_site_id  )
                     ELSE
                        NULL
                END     po_supplier
              , CASE WHEN mmt.source_code = '3PL_REMITTANCE_BRAZIL' THEN
                     ( SELECT listagg(cfi.invoice_num,', ' ON OVERFLOW TRUNCATE)  
                         WITHIN GROUP (ORDER BY cfi.invoice_num asc)
                         FROM apps.cll_f189_invoice_lines cfil
                            , apps.cll_f189_invoices      cfi
                            , apps.po_lines_all           pla
                            , apps.po_line_locations_all  plla
                        WHERE plla.po_line_id       = pla.po_line_id
                          AND pla.po_line_id        = mmt.source_line_id
                          AND plla.line_location_id = cfil.line_location_id
                          AND cfil.invoice_id       = cfi.invoice_id )
                     WHEN mmt.source_code IN ('ORDER ENTRY','IIP') THEN
                        NULL
                     WHEN mmt.source_code = 'RCV' THEN
                        ( SELECT listagg(cfi.invoice_num,', ' ON OVERFLOW TRUNCATE)  
                            WITHIN GROUP (ORDER BY cfi.invoice_num asc)
                            FROM apps.po_headers_all            pha
                               , apps.po_lines_all              pla
                               , apps.po_line_locations_all     plla
                               , apps.cll_f189_invoice_lines    cfil
                               , apps.cll_f189_invoices         cfi
                               , apps.rcv_shipment_headers      rsh
                               , apps.rcv_transactions          rt
                           WHERE rt.transaction_id          = mmt.rcv_transaction_id
                             AND rt.po_line_location_id     = plla.line_location_id
                             AND plla.line_location_id      = cfil.line_location_id
                             AND cfil.invoice_id            = cfi.invoice_id
                             AND plla.po_line_id            = pla.po_line_id
                             AND pha.po_header_id           = pla.po_header_id
                             AND rt.shipment_header_id      = rsh.shipment_header_id
                             AND rsh.receipt_source_code    = 'VENDOR'   )
                     ELSE
                        NULL
                END    NF_RI
             , (SELECT DECODE( mmt.source_code, '3PL_REMITTANCE_BRAZIL',NULL,to_char(ooha.order_number) )
                  FROM apps.oe_order_headers_all  ooha,
                       apps.oe_order_lines_all    oola  
                 WHERE oola.line_id        = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                   AND oola.header_id      = ooha.header_id )   order_number
               -- 
               -- alterado para BIll_to por Sinval inicio
               --
               , CASE WHEN ( SELECT ottl.name
                             FROM apps.oe_transaction_types_tl    ottl
                                , apps.oe_order_headers_all  ooha
                                , apps.oe_order_lines_all    oola  
                            WHERE oola.line_id        = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND oola.header_id      = ooha.header_id
                              AND ooha.order_type_id  = ottl.transaction_type_id  ) = 'GPO_BR_FE_SHIPMENT' THEN
                     (SELECT listagg(hp.party_name,', ' ON OVERFLOW TRUNCATE)  
                      WITHIN GROUP (ORDER BY hp.party_name asc)
                        FROM apps.hz_parties             hp
                           , apps.hz_cust_accounts       hca
                           , apps.oe_order_lines_all     oola
                           , apps.hz_cust_acct_sites_all hcas
                           , apps.hz_cust_site_uses_all  hcsu
                       WHERE oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                         AND oola.end_customer_site_use_id  = hcsu.site_use_id
                         AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                         AND hcas.cust_account_id           = hca.cust_account_id
                         AND hca.party_id                   = hp.party_id )
                  ELSE
                     CASE WHEN (mmt.source_code = '3PL_REMITTANCE_BRAZIL') THEN
                       (SELECT listagg(hp.party_name,', ' ON OVERFLOW TRUNCATE)  
                        WITHIN GROUP (ORDER BY hp.party_name asc)
                          FROM apps.hz_parties             hp,
                               apps.hz_cust_accounts       hca,
                               apps.ra_customer_trx_all    rcta,
                               apps.hz_cust_acct_sites_all hcas,
                               apps.hz_cust_site_uses_all  hcsu
                         WHERE rcta.interface_header_attribute1 = mp.organization_code||'_'||mmt.transaction_reference
                           AND rcta.ship_to_site_use_id         = hcsu.site_use_id
                           AND hcsu.cust_acct_site_id           = hcas.cust_acct_site_id
                           AND hcas.cust_account_id             = hca.cust_account_id
                           AND hca.party_id                     = hp.party_id
                           AND rcta.org_id                      = 4330)
                     ELSE
                        (SELECT listagg(hp.party_name,', ' ON OVERFLOW TRUNCATE)  
                         WITHIN GROUP (ORDER BY hp.party_name asc)
                           FROM apps.hz_parties             hp
                              , apps.hz_cust_accounts       hca
                              , apps.oe_order_lines_all     oola
                              , apps.hz_cust_acct_sites_all hcas
                              , apps.hz_cust_site_uses_all  hcsu
                          WHERE oola.line_id                = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                            AND oola.ship_to_org_id         = hcsu.site_use_id
                            AND hcsu.cust_acct_site_id      = hcas.cust_acct_site_id
                            AND hcas.cust_account_id        = hca.cust_account_id
                            AND hca.party_id                = hp.party_id )
                    END                 
               END    customer_name
             , CASE WHEN ( SELECT ottl.name
                             FROM apps.oe_transaction_types_tl    ottl
                                , apps.oe_order_headers_all  ooha
                                , apps.oe_order_lines_all    oola  
                            WHERE oola.line_id        = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND oola.header_id      = ooha.header_id
                              AND ooha.order_type_id  = ottl.transaction_type_id  ) = 'GPO_BR_FE_SHIPMENT' THEN
                     (SELECT listagg(hca.account_number,', ' ON OVERFLOW TRUNCATE)  
                      WITHIN GROUP (ORDER BY hca.account_number asc)
                        FROM apps.hz_parties             hp
                           , apps.hz_cust_accounts       hca
                           , apps.oe_order_lines_all     oola
                           , apps.hz_cust_acct_sites_all hcas
                           , apps.hz_cust_site_uses_all  hcsu
                       WHERE oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                         AND oola.end_customer_site_use_id  = hcsu.site_use_id
                         AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                         AND hcas.cust_account_id           = hca.cust_account_id
                         AND hca.party_id                   = hp.party_id )
                  ELSE
                     CASE WHEN (mmt.source_code = '3PL_REMITTANCE_BRAZIL') THEN
                        (SELECT listagg(hca.account_number,', ' ON OVERFLOW TRUNCATE)  
                         WITHIN GROUP (ORDER BY hca.account_number asc)
                           FROM apps.hz_parties             hp,
                                apps.hz_cust_accounts       hca,
                                apps.ra_customer_trx_all    rcta,
                                apps.hz_cust_acct_sites_all hcas,
                                apps.hz_cust_site_uses_all  hcsu
                          WHERE rcta.interface_header_attribute1 = mp.organization_code||'_'||mmt.transaction_reference
                            AND rcta.ship_to_site_use_id         = hcsu.site_use_id
                            AND hcsu.cust_acct_site_id           = hcas.cust_acct_site_id
                            AND hcas.cust_account_id             = hca.cust_account_id
                            AND hca.party_id                     = hp.party_id
                            AND rcta.org_id                      = 4330)
                     ELSE
                        (SELECT listagg(hca.account_number,', ' ON OVERFLOW TRUNCATE)  
                         WITHIN GROUP (ORDER BY hca.account_number asc)
                           FROM apps.hz_parties             hp
                              , apps.hz_cust_accounts       hca
                              , apps.oe_order_lines_all     oola
                              , apps.hz_cust_acct_sites_all hcas
                              , apps.hz_cust_site_uses_all  hcsu
                          WHERE oola.line_id                = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                            AND oola.ship_to_org_id         = hcsu.site_use_id
                            AND hcsu.cust_acct_site_id      = hcas.cust_acct_site_id
                            AND hcas.cust_account_id        = hca.cust_account_id
                            AND hca.party_id                = hp.party_id   )
                     END
                  END   customer_number
              --
              , CASE WHEN ( SELECT ottl.name
                             FROM apps.oe_transaction_types_tl    ottl
                                , apps.oe_order_headers_all  ooha
                               , apps.oe_order_lines_all    oola  
                            WHERE oola.line_id        = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND oola.header_id      = ooha.header_id
                              AND ooha.order_type_id  = ottl.transaction_type_id  ) = 'GPO_BR_FE_SHIPMENT' THEN
                     (SELECT listagg(DECODE(hcas.global_attribute2
                                           , '2',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'/'|| hcas.global_attribute4 ||'-'|| hcas.global_attribute5
                                           , '1',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'-'|| hcas.global_attribute5 
                                           , '3',HCSU.LOCATION||' - '||hcas.global_attribute3 ),', ' ON OVERFLOW TRUNCATE)
                     WITHIN GROUP (ORDER BY hcas.global_attribute2 asc ) 
                        FROM apps.hz_parties             hp
                           , apps.hz_cust_accounts       hca
                           , apps.oe_order_lines_all     oola
                           , apps.hz_cust_acct_sites_all hcas
                           , apps.hz_cust_site_uses_all  hcsu
                       WHERE oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                         AND oola.end_customer_site_use_id  = hcsu.site_use_id
                         AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                         AND hcas.cust_account_id           = hca.cust_account_id
                         AND hca.party_id                   = hp.party_id )
                ELSE
                   CASE WHEN (mmt.source_code = '3PL_REMITTANCE_BRAZIL') THEN
                      (SELECT listagg(DECODE(hcas.global_attribute2
                                           , '2',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'/'|| hcas.global_attribute4 ||'-'|| hcas.global_attribute5
                                           , '1',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'-'|| hcas.global_attribute5 
                                           , '3',HCSU.LOCATION||' - '||hcas.global_attribute3 ),', ' ON OVERFLOW TRUNCATE)
                     WITHIN GROUP (ORDER BY hcas.global_attribute2 asc) 
                         FROM apps.ra_customer_trx_all     rcta
                            , apps.hz_cust_acct_sites_all  hcas
                            , apps.hz_cust_site_uses_all   hcsu
                        WHERE rcta.interface_header_attribute1 = mp.organization_code||'_'||mmt.transaction_reference
                          AND rcta.ship_to_site_use_id         = hcsu.site_use_id
                          AND hcsu.cust_acct_site_id           = hcas.cust_acct_site_id
                          AND rcta.org_id                      = 4330)
                   ELSE
                      (SELECT listagg(DECODE(hcas.global_attribute2
                                           , '2',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'/'|| hcas.global_attribute4 ||'-'|| hcas.global_attribute5
                                           , '1',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'-'|| hcas.global_attribute5 
                                           , '3',HCSU.LOCATION||' - '||hcas.global_attribute3 ),', ' ON OVERFLOW TRUNCATE)
                      WITHIN GROUP (ORDER BY hcas.global_attribute2 asc) 
                         FROM apps.hz_parties             hp
                            , apps.hz_cust_accounts       hca
                            , apps.oe_order_lines_all     oola
                            , apps.hz_cust_acct_sites_all hcas
                            , apps.hz_cust_site_uses_all  hcsu
                        WHERE oola.line_id                = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                          AND oola.ship_to_org_id         = hcsu.site_use_id
                          AND hcsu.cust_acct_site_id      = hcas.cust_acct_site_id
                          AND hcas.cust_account_id        = hca.cust_account_id
                          AND hca.party_id                = hp.party_id  )
                   END
                END  customer_cnpj_cpf
               -- 
              , CASE WHEN (mmt.source_code = '3PL_REMITTANCE_BRAZIL') THEN
                      (SELECT listagg(DECODE(hcas.global_attribute2
                                           , '2',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'/'|| hcas.global_attribute4 ||'-'|| hcas.global_attribute5
                                           , '1',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'-'|| hcas.global_attribute5 
                                           , '3',HCSU.LOCATION||' - '||hcas.global_attribute3 ),', ' ON OVERFLOW TRUNCATE)
                       WITHIN GROUP (ORDER BY hcas.global_attribute2 asc )
                         FROM apps.ra_customer_trx_all         rcta
                            , apps.hz_cust_acct_sites_all      hcas
                            , apps.hz_cust_site_uses_all       hcsu
                        WHERE rcta.interface_header_attribute1 = mp.organization_code||'_'||mmt.transaction_reference
                          AND rcta.bill_to_site_use_id         = hcsu.site_use_id
                          AND hcsu.cust_acct_site_id           = hcas.cust_acct_site_id
                          AND rcta.org_id                      = 4330
                          AND ROWNUM = 1)
                   ELSE
                     --
                     CASE WHEN (select DISTINCT RCTL.INTERFACE_LINE_CONTEXT
                             FROM apps.hz_parties                hp
                                , apps.hz_cust_accounts          hca
                                , apps.oe_order_lines_all        oola
                                , apps.oe_order_headers_all      ooha
                                , apps.ra_customer_trx_lines_all rctl
                                , apps.ra_customer_trx_all       rcta
                                , apps.hz_cust_acct_sites_all    hcas
                                , apps.hz_cust_site_uses_all     hcsu
                            WHERE ooha.header_id                 = oola.header_id
                              AND oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND rctl.inventory_item_id         = oola.inventory_item_id
                              AND rctl.line_type                 = 'LINE'
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE1 = to_char(ooha.order_number)
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE6 = to_char(oola.line_id)
                              AND RCTL.INTERFACE_LINE_CONTEXT    = 'ORDER ENTRY'
                              AND rctl.customer_trx_id           = rcta.customer_trx_id
                              AND rcta.bill_to_site_use_id       = hcsu.site_use_id
                              AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                              AND hcas.cust_account_id           = hca.cust_account_id
                              AND hca.party_id                   = hp.party_id 
                              AND ROWNUM = 1) = 'ORDER ENTRY' THEN
                     --
                     (SELECT DISTINCT DECODE(hcas.global_attribute2
                                           , '2',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'/'|| hcas.global_attribute4 ||'-'|| hcas.global_attribute5
                                           , '1',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'-'|| hcas.global_attribute5 
                                           , '3',HCSU.LOCATION||' - '||hcas.global_attribute3)
                             FROM apps.hz_parties                hp
                                , apps.hz_cust_accounts          hca
                                , apps.oe_order_lines_all        oola
                                , apps.oe_order_headers_all      ooha
                                , apps.ra_customer_trx_lines_all rctl
                                , apps.ra_customer_trx_all       rcta
                                , apps.hz_cust_acct_sites_all    hcas
                                , apps.hz_cust_site_uses_all     hcsu
                            WHERE ooha.header_id                 = oola.header_id
                              AND oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND rctl.inventory_item_id         = oola.inventory_item_id
                              AND rctl.line_type                 = 'LINE'
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE1 = to_char(ooha.order_number)
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE6 = to_char(oola.line_id)
                              AND RCTL.INTERFACE_LINE_CONTEXT    = 'ORDER ENTRY'
                              AND rctl.customer_trx_id           = rcta.customer_trx_id
                              AND rcta.bill_to_site_use_id       = hcsu.site_use_id
                              AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                              AND hcas.cust_account_id           = hca.cust_account_id
                              AND hca.party_id                   = hp.party_id
                              AND ROWNUM = 1)
                     --
                     ELSE
                     --            
                     CASE WHEN 
                          ( SELECT DISTINCT RCTL.INTERFACE_LINE_CONTEXT
                             FROM apps.hz_parties                hp
                                , apps.hz_cust_accounts          hca
                                , apps.oe_order_lines_all        oola
                                , apps.oe_order_headers_all      ooha
                                , apps.ra_customer_trx_lines_all rctl
                                , apps.ra_customer_trx_all       rcta
                                , apps.hz_cust_acct_sites_all    hcas
                                , apps.hz_cust_site_uses_all     hcsu
                            WHERE ooha.header_id                 = oola.header_id
                              AND oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND rctl.inventory_item_id         = oola.inventory_item_id
                              AND rctl.line_type                 = 'LINE'
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE1 = ooha.ORIG_SYS_DOCUMENT_REF
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE7 = oola.ORIG_SYS_LINE_REF
                              AND RCTL.INTERFACE_LINE_CONTEXT    = 'GEMS_PB_RR'
                              AND rctl.customer_trx_id           = rcta.customer_trx_id
                              AND rcta.bill_to_site_use_id       = hcsu.site_use_id
                              AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                              AND hcas.cust_account_id           = hca.cust_account_id
                              AND ROWNUM = 1 ) = 'GEMS_PB_RR' THEN
                     --
                     (SELECT DISTINCT DECODE(hcas.global_attribute2
                                           , '2',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'/'|| hcas.global_attribute4 ||'-'|| hcas.global_attribute5
                                           , '1',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'-'|| hcas.global_attribute5 
                                           , '3',HCSU.LOCATION||' - '||hcas.global_attribute3)
                             FROM apps.hz_parties                hp
                                , apps.hz_cust_accounts          hca
                                , apps.oe_order_lines_all        oola
                                , apps.oe_order_headers_all      ooha
                                , apps.ra_customer_trx_lines_all rctl
                                , apps.ra_customer_trx_all       rcta
                                , apps.hz_cust_acct_sites_all    hcas
                                , apps.hz_cust_site_uses_all     hcsu
                            WHERE ooha.header_id                 = oola.header_id
                              AND oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND rctl.inventory_item_id         = oola.inventory_item_id
                              AND rctl.line_type                 = 'LINE'
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE1 = ooha.ORIG_SYS_DOCUMENT_REF
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE7 = oola.ORIG_SYS_LINE_REF
                              AND RCTL.INTERFACE_LINE_CONTEXT    = 'GEMS_PB_RR'
                              AND rctl.customer_trx_id           = rcta.customer_trx_id
                              AND rcta.bill_to_site_use_id       = hcsu.site_use_id
                              AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                              AND hcas.cust_account_id           = hca.cust_account_id 
                              AND ROWNUM = 1 )
                     --
                     ELSE
                     --
                     (SELECT DISTINCT DECODE(hcas.global_attribute2
                                   , '2',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'/'|| hcas.global_attribute4 ||'-'|| hcas.global_attribute5
                                   , '1',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'-'|| hcas.global_attribute5 
                                   , '3',HCSU.LOCATION||' - '||hcas.global_attribute3)
                             --
                      FROM   APPS.HZ_CUST_ACCT_SITES_ALL HCAS,
                             APPS.HZ_CUST_SITE_USES_ALL  HCSU,
                             APPS.OE_ORDER_LINES_ALL     OOLA,
                             APPS.OE_ORDER_HEADERS_ALL   OOHA
                             --
                      WHERE  HCSU.SITE_USE_CODE     = 'BILL_TO'
                      AND    HCSU.CUST_ACCT_SITE_ID = HCAS.CUST_ACCT_SITE_ID
                      AND    HCSU.SITE_USE_ID       = NVL(OOLA.ATTRIBUTE1, OOHA.INVOICE_TO_ORG_ID)
                      AND    OOLA.LINE_ID           = NVL(MMT.TRX_SOURCE_LINE_ID, MMT.SOURCE_LINE_ID)
                      AND    OOHA.HEADER_ID         = OOLA.HEADER_ID
                      AND    ROWNUM = 1)
                     --
                     END
                  END
               END      bill_to_CNPJ_CPF
               --
                             --
              , CASE WHEN (mmt.source_code = '3PL_REMITTANCE_BRAZIL') THEN
                        (SELECT listagg(hp.party_name,', ' ON OVERFLOW TRUNCATE)  
                        WITHIN GROUP (ORDER BY hp.party_name asc)
                          FROM apps.hz_parties             hp,
                               apps.hz_cust_accounts       hca,
                               apps.ra_customer_trx_all    rcta,
                               apps.hz_cust_acct_sites_all hcas,
                               apps.hz_cust_site_uses_all  hcsu
                         WHERE rcta.interface_header_attribute1 = mp.organization_code||'_'||mmt.transaction_reference
                           AND rcta.bill_to_site_use_id         = hcsu.site_use_id
                           AND hcsu.cust_acct_site_id           = hcas.cust_acct_site_id
                           AND hcas.cust_account_id             = hca.cust_account_id
                           AND hca.party_id                     = hp.party_id
                           AND rcta.org_id                      = 4330)
                   ELSE
                     --
                     CASE WHEN (select DISTINCT RCTL.INTERFACE_LINE_CONTEXT
                             FROM apps.hz_parties                hp
                                , apps.hz_cust_accounts          hca
                                , apps.oe_order_lines_all        oola
                                , apps.oe_order_headers_all      ooha
                                , apps.ra_customer_trx_lines_all rctl
                                , apps.ra_customer_trx_all       rcta
                                , apps.hz_cust_acct_sites_all    hcas
                                , apps.hz_cust_site_uses_all     hcsu
                            WHERE ooha.header_id                 = oola.header_id
                              AND oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND rctl.inventory_item_id         = oola.inventory_item_id
                              AND rctl.line_type                 = 'LINE'
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE1 = to_char(ooha.order_number)
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE6 = to_char(oola.line_id)
                              AND RCTL.INTERFACE_LINE_CONTEXT    = 'ORDER ENTRY'
                              AND rctl.customer_trx_id           = rcta.customer_trx_id
                              AND rcta.bill_to_site_use_id       = hcsu.site_use_id
                              AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                              AND hcas.cust_account_id           = hca.cust_account_id
                              AND hca.party_id                   = hp.party_id 
                              AND ROWNUM = 1) = 'ORDER ENTRY' THEN
                     --
                     (SELECT listagg(hp.party_name,', ' ON OVERFLOW TRUNCATE)  
                         WITHIN GROUP (ORDER BY hp.party_name asc)
                             FROM apps.hz_parties                hp
                                , apps.hz_cust_accounts          hca
                                , apps.oe_order_lines_all        oola
                                , apps.oe_order_headers_all      ooha
                                , apps.ra_customer_trx_lines_all rctl
                                , apps.ra_customer_trx_all       rcta
                                , apps.hz_cust_acct_sites_all    hcas
                                , apps.hz_cust_site_uses_all     hcsu
                            WHERE ooha.header_id                 = oola.header_id
                              AND oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND rctl.inventory_item_id         = oola.inventory_item_id
                              AND rctl.line_type                 = 'LINE'
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE1 = to_char(ooha.order_number)
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE6 = to_char(oola.line_id)
                              AND RCTL.INTERFACE_LINE_CONTEXT    = 'ORDER ENTRY'
                              AND rctl.customer_trx_id           = rcta.customer_trx_id
                              AND rcta.bill_to_site_use_id       = hcsu.site_use_id
                              AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                              AND hcas.cust_account_id           = hca.cust_account_id
                              AND hca.party_id                   = hp.party_id
                              AND ROWNUM = 1)
                     --
                     ELSE
                     --            
                     CASE WHEN 
                          ( SELECT DISTINCT RCTL.INTERFACE_LINE_CONTEXT
                             FROM apps.hz_parties                hp
                                , apps.hz_cust_accounts          hca
                                , apps.oe_order_lines_all        oola
                                , apps.oe_order_headers_all      ooha
                                , apps.ra_customer_trx_lines_all rctl
                                , apps.ra_customer_trx_all       rcta
                                , apps.hz_cust_acct_sites_all    hcas
                                , apps.hz_cust_site_uses_all     hcsu
                            WHERE ooha.header_id                 = oola.header_id
                              AND oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND rctl.inventory_item_id         = oola.inventory_item_id
                              AND rctl.line_type                 = 'LINE'
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE1 = ooha.ORIG_SYS_DOCUMENT_REF
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE7 = oola.ORIG_SYS_LINE_REF
                              AND RCTL.INTERFACE_LINE_CONTEXT    = 'GEMS_PB_RR'
                              AND rctl.customer_trx_id           = rcta.customer_trx_id
                              AND rcta.bill_to_site_use_id       = hcsu.site_use_id
                              AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                              AND hcas.cust_account_id           = hca.cust_account_id
                              AND ROWNUM = 1 ) = 'GEMS_PB_RR' THEN
                     --
                     (SELECT listagg(hp.party_name,', ' ON OVERFLOW TRUNCATE)  
                         WITHIN GROUP (ORDER BY hp.party_name asc)
                             FROM apps.hz_parties                hp
                                , apps.hz_cust_accounts          hca
                                , apps.oe_order_lines_all        oola
                                , apps.oe_order_headers_all      ooha
                                , apps.ra_customer_trx_lines_all rctl
                                , apps.ra_customer_trx_all       rcta
                                , apps.hz_cust_acct_sites_all    hcas
                                , apps.hz_cust_site_uses_all     hcsu
                            WHERE ooha.header_id                 = oola.header_id
                              AND oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND rctl.inventory_item_id         = oola.inventory_item_id
                              AND rctl.line_type                 = 'LINE'
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE1 = ooha.ORIG_SYS_DOCUMENT_REF
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE7 = oola.ORIG_SYS_LINE_REF
                              AND RCTL.INTERFACE_LINE_CONTEXT    = 'GEMS_PB_RR'
                              AND rctl.customer_trx_id           = rcta.customer_trx_id
                              AND rcta.bill_to_site_use_id       = hcsu.site_use_id
                              AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                              AND hcas.cust_account_id           = hca.cust_account_id 
                              AND ROWNUM = 1 )
                     --
                     ELSE
                     --
                     (SELECT listagg(hp.party_name,', ' ON OVERFLOW TRUNCATE)  
                         WITHIN GROUP (ORDER BY hp.party_name asc)
                      FROM   APPS.HZ_CUST_ACCT_SITES_ALL HCAS,
                             apps.hz_parties             hp,
                             apps.hz_cust_accounts       hca,
                             APPS.HZ_CUST_SITE_USES_ALL  HCSU,
                             APPS.OE_ORDER_LINES_ALL     OOLA,
                             APPS.OE_ORDER_HEADERS_ALL   OOHA
                             --
                      WHERE  HCSU.SITE_USE_CODE     = 'BILL_TO'
                      AND    HCSU.CUST_ACCT_SITE_ID = HCAS.CUST_ACCT_SITE_ID
                      AND    HCSU.SITE_USE_ID       = NVL(OOLA.ATTRIBUTE1, OOHA.INVOICE_TO_ORG_ID)
                      AND    OOLA.LINE_ID           = NVL(MMT.TRX_SOURCE_LINE_ID, MMT.SOURCE_LINE_ID)
                      AND    OOHA.HEADER_ID         = OOLA.HEADER_ID
                      AND    hcas.cust_account_id   = hca.cust_account_id
                      AND    hca.party_id           = hp.party_id 
                      AND    ROWNUM = 1)
                     --          
                     END
                  END
               END      bill_to_Customer_name
               --
                , CASE WHEN (mmt.source_code = '3PL_REMITTANCE_BRAZIL') THEN
                      (SELECT listagg(DECODE(hcas.global_attribute2
                                           , '2',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'/'|| hcas.global_attribute4 ||'-'|| hcas.global_attribute5
                                           , '1',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'-'|| hcas.global_attribute5 
                                           , '3',HCSU.LOCATION||' - '||hcas.global_attribute3 ),', ' ON OVERFLOW TRUNCATE)
                       WITHIN GROUP (ORDER BY hcas.global_attribute2 asc )
                         FROM apps.ra_customer_trx_all         rcta
                            , apps.hz_cust_acct_sites_all      hcas
                            , apps.hz_cust_site_uses_all       hcsu
                        WHERE rcta.interface_header_attribute1 = mp.organization_code||'_'||mmt.transaction_reference
                          AND rcta.ship_to_site_use_id         = hcsu.site_use_id
                          AND hcsu.cust_acct_site_id           = hcas.cust_acct_site_id
                          AND rcta.org_id                      = 4330
                          AND ROWNUM = 1)
                   ELSE
                     --
                     CASE WHEN (select DISTINCT RCTL.INTERFACE_LINE_CONTEXT
                             FROM apps.hz_parties                hp
                                , apps.hz_cust_accounts          hca
                                , apps.oe_order_lines_all        oola
                                , apps.oe_order_headers_all      ooha
                                , apps.ra_customer_trx_lines_all rctl
                                , apps.ra_customer_trx_all       rcta
                                , apps.hz_cust_acct_sites_all    hcas
                                , apps.hz_cust_site_uses_all     hcsu
                            WHERE ooha.header_id                 = oola.header_id
                              AND oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND rctl.inventory_item_id         = oola.inventory_item_id
                              AND rctl.line_type                 = 'LINE'
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE1 = to_char(ooha.order_number)
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE6 = to_char(oola.line_id)
                              AND RCTL.INTERFACE_LINE_CONTEXT    = 'ORDER ENTRY'
                              AND rctl.customer_trx_id           = rcta.customer_trx_id
                              AND rcta.ship_to_site_use_id       = hcsu.site_use_id
                              AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                              AND hcas.cust_account_id           = hca.cust_account_id
                              AND hca.party_id                   = hp.party_id 
                              AND ROWNUM = 1) = 'ORDER ENTRY' THEN
                     --
                     (SELECT DISTINCT DECODE(hcas.global_attribute2
                                           , '2',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'/'|| hcas.global_attribute4 ||'-'|| hcas.global_attribute5
                                           , '1',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'-'|| hcas.global_attribute5 
                                           , '3',HCSU.LOCATION||' - '||hcas.global_attribute3)
                             FROM apps.hz_parties                hp
                                , apps.hz_cust_accounts          hca
                                , apps.oe_order_lines_all        oola
                                , apps.oe_order_headers_all      ooha
                                , apps.ra_customer_trx_lines_all rctl
                                , apps.ra_customer_trx_all       rcta
                                , apps.hz_cust_acct_sites_all    hcas
                                , apps.hz_cust_site_uses_all     hcsu
                            WHERE ooha.header_id                 = oola.header_id
                              AND oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND rctl.inventory_item_id         = oola.inventory_item_id
                              AND rctl.line_type                 = 'LINE'
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE1 = to_char(ooha.order_number)
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE6 = to_char(oola.line_id)
                              AND RCTL.INTERFACE_LINE_CONTEXT    = 'ORDER ENTRY'
                              AND rctl.customer_trx_id           = rcta.customer_trx_id
                              AND rcta.ship_to_site_use_id       = hcsu.site_use_id
                              AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                              AND hcas.cust_account_id           = hca.cust_account_id
                              AND hca.party_id                   = hp.party_id
                              AND ROWNUM = 1)
                     --
                     ELSE
                     --            
                     CASE WHEN 
                          ( SELECT DISTINCT RCTL.INTERFACE_LINE_CONTEXT
                             FROM apps.hz_parties                hp
                                , apps.hz_cust_accounts          hca
                                , apps.oe_order_lines_all        oola
                                , apps.oe_order_headers_all      ooha
                                , apps.ra_customer_trx_lines_all rctl
                                , apps.ra_customer_trx_all       rcta
                                , apps.hz_cust_acct_sites_all    hcas
                                , apps.hz_cust_site_uses_all     hcsu
                            WHERE ooha.header_id                 = oola.header_id
                              AND oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND rctl.inventory_item_id         = oola.inventory_item_id
                              AND rctl.line_type                 = 'LINE'
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE1 = ooha.ORIG_SYS_DOCUMENT_REF
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE7 = oola.ORIG_SYS_LINE_REF
                              AND RCTL.INTERFACE_LINE_CONTEXT    = 'GEMS_PB_RR'
                              AND rctl.customer_trx_id           = rcta.customer_trx_id
                              AND rcta.ship_to_site_use_id       = hcsu.site_use_id
                              AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                              AND hcas.cust_account_id           = hca.cust_account_id
                              AND ROWNUM = 1 ) = 'GEMS_PB_RR' THEN
                     --
                     (SELECT DISTINCT DECODE(hcas.global_attribute2
                                           , '2',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'/'|| hcas.global_attribute4 ||'-'|| hcas.global_attribute5
                                           , '1',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'-'|| hcas.global_attribute5 
                                           , '3',HCSU.LOCATION||' - '||hcas.global_attribute3)
                             FROM apps.hz_parties                hp
                                , apps.hz_cust_accounts          hca
                                , apps.oe_order_lines_all        oola
                                , apps.oe_order_headers_all      ooha
                                , apps.ra_customer_trx_lines_all rctl
                                , apps.ra_customer_trx_all       rcta
                                , apps.hz_cust_acct_sites_all    hcas
                                , apps.hz_cust_site_uses_all     hcsu
                            WHERE ooha.header_id                 = oola.header_id
                              AND oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND rctl.inventory_item_id         = oola.inventory_item_id
                              AND rctl.line_type                 = 'LINE'
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE1 = ooha.ORIG_SYS_DOCUMENT_REF
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE7 = oola.ORIG_SYS_LINE_REF
                              AND RCTL.INTERFACE_LINE_CONTEXT    = 'GEMS_PB_RR'
                              AND rctl.customer_trx_id           = rcta.customer_trx_id
                              AND rcta.ship_to_site_use_id       = hcsu.site_use_id
                              AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                              AND hcas.cust_account_id           = hca.cust_account_id 
                              AND ROWNUM = 1 )
                     --
                     ELSE
                     --
                     (SELECT listagg(DECODE(hcas.global_attribute2
                                           , '2',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'/'|| hcas.global_attribute4 ||'-'|| hcas.global_attribute5
                                           , '1',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'-'|| hcas.global_attribute5 
                                           , '3',HCSU.LOCATION||' - '||hcas.global_attribute3 ),', ' ON OVERFLOW TRUNCATE)
                      WITHIN GROUP (ORDER BY hcas.global_attribute2 asc) 
                         FROM apps.hz_parties             hp
                            , apps.hz_cust_accounts       hca
                            , apps.oe_order_lines_all     oola
                            , apps.hz_cust_acct_sites_all hcas
                            , apps.hz_cust_site_uses_all  hcsu
                        WHERE oola.line_id                = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                          AND oola.ship_to_org_id         = hcsu.site_use_id
                          AND hcsu.cust_acct_site_id      = hcas.cust_acct_site_id
                          AND hcas.cust_account_id        = hca.cust_account_id
                          AND hca.party_id                = hp.party_id  )
                     --
                     END
                  END
               END      ship_to_CNPJ_CPF
               --
              , CASE WHEN ( SELECT ottl.name
                              FROM apps.oe_transaction_types_tl    ottl
                                 , apps.oe_order_headers_all  ooha
                                 , apps.oe_order_lines_all    oola  
                             WHERE oola.line_id        = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                               AND oola.header_id      = ooha.header_id
                               AND ooha.order_type_id  = ottl.transaction_type_id  ) = 'GPO_BR_FE_SHIPMENT' THEN
                      (SELECT listagg(hzl.address1 ||' - '|| hzl.address2 || ' - ' || hzl.city || '-' || hzl.state || ' / ' || hzl.postal_code,', ' ON OVERFLOW TRUNCATE)  
                       WITHIN GROUP (ORDER BY hzl.address1 asc)
                       FROM apps.hz_parties             hp
                        , apps.hz_party_sites         hps
                        , apps.hz_cust_accounts       hca
                        , apps.oe_order_lines_all     oola
                        , apps.hz_cust_acct_sites_all hcas
                        , apps.hz_cust_site_uses_all  hcsu
                        , apps.hz_locations           hzl
                    WHERE oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                      AND oola.end_customer_site_use_id  = hcsu.site_use_id
                      AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                      AND hcas.cust_account_id           = hca.cust_account_id
                      AND hcas.party_site_id             = hps.party_site_id
                      AND hca.party_id                   = hp.party_id
                      AND hps.party_id                   = hp.party_id
                      AND hps.location_id                = hzl.location_id)
                ELSE
                   CASE WHEN (mmt.source_code = '3PL_REMITTANCE_BRAZIL') THEN
                      (SELECT listagg(hzl.address1 ||' - '|| hzl.address2 || ' - ' || hzl.city || '-' || hzl.state || ' / ' || hzl.postal_code,', ' ON OVERFLOW TRUNCATE)  
                       WITHIN GROUP (ORDER BY hzl.address1 asc)
                         FROM apps.ra_customer_trx_all     rcta
                            , apps.hz_cust_acct_sites_all  hcas
                            , apps.hz_cust_site_uses_all   hcsu
                            , apps.hz_parties              hp
                            , apps.hz_party_sites          hps
                            , apps.hz_cust_accounts        hca
                            , apps.hz_locations            hzl
                        WHERE rcta.interface_header_attribute1 = mp.organization_code||'_'||mmt.transaction_reference
                          AND rcta.ship_to_site_use_id         = hcsu.site_use_id
                          AND hcsu.cust_acct_site_id           = hcas.cust_acct_site_id
                          AND hcas.cust_account_id             = hca.cust_account_id
                          AND hcas.party_site_id               = hps.party_site_id
                          AND hca.party_id                     = hp.party_id
                          AND hps.party_id                     = hp.party_id
                          AND hps.location_id                  = hzl.location_id
                          AND rcta.org_id                      = 4330)
                   ELSE
                      (SELECT listagg(hzl.address1 ||' - '|| hzl.address2 || ' - ' || hzl.city || '-' || hzl.state || ' / ' || hzl.postal_code,', ' ON OVERFLOW TRUNCATE)  
                       WITHIN GROUP (ORDER BY hzl.address1 asc)
                          FROM apps.hz_parties             hp
                             , apps.hz_party_sites         hps
                             , apps.hz_cust_accounts       hca
                             , apps.oe_order_lines_all     oola
                             , apps.hz_cust_acct_sites_all hcas
                             , apps.hz_cust_site_uses_all  hcsu
                             , apps.hz_locations           hzl
                         WHERE oola.line_id                = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                           AND oola.ship_to_org_id         = hcsu.site_use_id
                           AND hcsu.cust_acct_site_id      = hcas.cust_acct_site_id
                           AND hcas.cust_account_id        = hca.cust_account_id
                           AND hcas.party_site_id          = hps.party_site_id
                           AND hca.party_id                = hp.party_id
                           AND hps.party_id                = hp.party_id
                           AND hps.location_id             = hzl.location_id   )
                   END
                END customer_address
                -- 
                -- alterado para BIll_to por Sinval fim
                -- 
              , CASE WHEN (mmt.source_code = '3PL_REMITTANCE_BRAZIL') THEN
                   (SELECT listagg(rcta.trx_number,', ' ON OVERFLOW TRUNCATE)  
                           WITHIN GROUP (ORDER BY rcta.trx_number asc)
                      FROM apps.ra_customer_trx_all       rcta
                     WHERE rcta.interface_header_attribute1  = mp.organization_code||'_'||mmt.transaction_reference
                       AND rcta.org_id                       = 4330
                       AND NVL(rcta.status_trx,'XX')         <> 'VD'
                       AND NVL(rcta.reason_code,'XX')        <> 'CANCELLATION')
                ELSE
                   (SELECT distinct RTRIM(REGEXP_REPLACE((listagg(rcta.trx_number,', ' ON OVERFLOW TRUNCATE)  
                      WITHIN GROUP (ORDER BY rcta.trx_number asc) ), '([^,]*)(,\1)+($|,)', '\1\3'),',')
                      FROM apps.ra_customer_trx_lines_all rctla
                         , apps.ra_customer_trx_all       rcta
                         , apps.oe_order_lines_all        oola
                         , apps.oe_order_headers_all      ooha
                     WHERE rcta.customer_trx_id              = rctla.customer_trx_id
                       AND oola.line_id                      = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                       AND oola.header_id                    = ooha.header_id
                       AND rctla.sales_order                 = to_char(ooha.order_number)
                       AND rctla.line_type                   = 'LINE'
                       AND rcta.batch_source_id              <> 6266 -- No RR invoices
                       AND DECODE(rctla.interface_line_context,'GEMS_PB_RR',rcta.interface_header_attribute11,'999')
                           = DECODE(rctla.interface_line_context,'GEMS_PB_RR',rcta.interface_header_attribute11,'999')
                       AND rcta.org_id                       = 4330
                       AND trunc(rcta.trx_date)              BETWEEN (trunc(mmt.transaction_date)-3) AND (trunc(mmt.transaction_date)+3)
                       AND NVL(rcta.status_trx,'XX')         <> 'VD'
                       AND NVL(rcta.reason_code,'XX')        <> 'CANCELLATION')
                END   invoice_number_ar
              , ( SELECT listagg(mrav.reservation_quantity,', ' ON OVERFLOW TRUNCATE)  
                  WITHIN GROUP (ORDER BY mrav.reservation_quantity asc) 
                    FROM apps.mtl_reservations_all_v  mrav 
                       , apps.oe_order_headers_all    ooha1
                   WHERE mrav.demand_source_header_id     = ooha1.header_id
                     AND mrav.demand_source_line_id       = NVL(mmt.trx_source_line_id, mmt.source_line_id) )  reservation_quantity
              , ( SELECT listagg(ooha1.order_number,', ' ON OVERFLOW TRUNCATE)  
                  WITHIN GROUP (ORDER BY ooha1.order_number asc) 
                    FROM apps.mtl_reservations_all_v  mrav 
                       , apps.oe_order_headers_all    ooha1
                   WHERE mrav.demand_source_header_id     = ooha1.header_id
                     AND mrav.demand_source_line_id       = NVL(mmt.trx_source_line_id, mmt.source_line_id) )  reservation_order_number
              , (SELECT distinct hp.party_name
                 --WITHIN GROUP (ORDER BY hp.party_name asc)
                   FROM apps.hz_parties              hp
                      , apps.hz_cust_accounts        hca
                      , apps.oe_order_lines_all      oola1
                      , apps.oe_order_headers_all    ooha1
                      , apps.mtl_reservations_all_v  mrav 
                  WHERE mrav.demand_source_header_id   = ooha1.header_id
                    AND mrav.demand_source_line_id     = oola1.line_id
                    AND oola1.line_id                  = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                    AND oola1.ship_to_org_id           = hca.cust_account_id
                    AND hca.party_id                   = hp.party_id )         reservation_customer_name
              , gcc1.concatenated_segments   material_account
              , gcc2.concatenated_segments   outside_processing_account
              , gcc3.concatenated_segments   material_overhead_account
              , gcc4.concatenated_segments   overhead_account
              , gcc5.concatenated_segments   resource_account
              , sysdate                                           report_date_and_time 
              , to_char(mmt.transaction_id)  transaction_id
              , fu.user_name ||' / '|| fu.description                                    user_name
              , DECODE( lot_control_code, 1 ,'Sem controle de Lote' , 2,'Com controle de Lote')   lot_control
              , DECODE( serial_number_control_code, 1, 'Sem controle de Serial'
                                                  , 2, 'Pre-definido'
                                                  , 5, 'No Recebimento'
                                                  , 6, 'Baixa na Ordem de Venda' )  serial_control
              , CASE
                 WHEN    nvl(mmt.lpn_id, mmt.content_lpn_id) IS NULL AND moq.subinventory_code <> 'WHGU42GNAT'
                   THEN
                    (SELECT listagg(lpn.license_plate_number,', ' ON OVERFLOW TRUNCATE)WITHIN GROUP (ORDER BY lpn.license_plate_number asc)
                             FROM apps.MTL_MATERIAL_TRANSACTIONS   mtt,
                                  apps.wms_license_plate_numbers   lpn,
                                  apps.oe_order_lines_all          ool
                            WHERE 1 = 1
                              AND mtt.TRX_SOURCE_LINE_ID = CASE
                                                              WHEN LINE_CATEGORY_CODE = 'ORDER'
                                                                THEN ool.line_id
                                                              WHEN LINE_CATEGORY_CODE = 'RETURN'  
                                                                THEN   
                                                                to_number(NVL(SUBSTR(ool.ORIG_SYS_LINE_REF,
                                                                                     0,
                                                                                     INSTR(ool.ORIG_SYS_LINE_REF, '.') - 1),
                                                                              -1)) -- RMA FE OE Line Id
                                                                ELSE -1
                                                                  END
                              AND mtt.TRANSACTION_TYPE_ID = 52 --sales order pick FE ORDER
                              AND mtt.transaction_quantity < 0
                              AND mtt.inventory_item_id = ool.inventory_item_id
                              AND nvl(mtt.lpn_id, mtt.content_lpn_id) = nvl(lpn.lpn_id, -1)
                              AND ool.line_id = CASE
                                                  WHEN mtt.transaction_type_name = 'RMA Receipt'
                                                    THEN mmt.TRX_SOURCE_LINE_ID
                                                  WHEN mtt.transaction_type_name = 'GPO Nationalization Receipt'
                                                     THEN 
                                                      to_number(NVL(SUBSTR(RTRIM(LTRIM(translate(mmt.TRANSACTION_REFERENCE,translate(mmt.TRANSACTION_REFERENCE||'a','1234567890.',' '),' '))),
                                                         0,
                                                         INSTR(RTRIM(LTRIM(translate(mmt.TRANSACTION_REFERENCE,translate(mmt.TRANSACTION_REFERENCE||'a','1234567890.',' '),' '))), '.') - 1),
                                                  -1))
                                                  ELSE -1
                                                    END)
                              WHEN moq.subinventory_code = 'WHGU42GNAT'
                  THEN (SELECT listagg(wlp.license_plate_number,', ' ON OVERFLOW TRUNCATE)  
                            WITHIN GROUP (ORDER BY wlp.license_plate_number asc)
                        FROM   gems_ont.ge_gpo_nationalization_line gnl, 
                               gems_ont.ge_gpo_nationalization_line gn2,
                               apps.wms_license_plate_numbers       wlp,
                               apps.po_line_locations_all           pll,
                               apps.po_lines_all                    pol,
                               apps.po_headers_all                  poh,
                               apps.rcv_shipment_headers            rsh,
                               apps.rcv_transactions                rt
                        Where  wlp.lpn_id(+) = gn2.lpn_id
                        AND gnl.nationalization_so_line_id = gn2.nationalization_so_line_id
                        AND pll.line_location_id = gnl.DOCUMENT_ID
                        AND pll.po_header_id = poh.po_header_id
                        AND pll.po_line_id = pol.po_line_id
                        AND gn2.record_type = 'IMPORT'
                        AND gnl.record_type = 'NATIONALIZATION'
                        AND rt.transaction_id                = mmt.rcv_transaction_id
                        AND rt.po_line_location_id           = pll.line_location_id
                        AND rt.shipment_header_id            = rsh.shipment_header_id)
                ELSE (SELECT lpn.LICENSE_PLATE_NUMBER
                           FROM   apps.wms_license_plate_numbers   lpn
                           WHERE  nvl(mmt.lpn_id, mmt.content_lpn_id) = nvl(lpn.lpn_id, -1))
                        END LPN_Value                                    
             , 'q7' query
--, mmt.transaction_type_id
--, mmt.trx_source_line_id
--, mmt.source_line_id
           FROM apps.mtl_parameters                  mp
              , apps.mtl_system_items_b              msi
              , apps.mtl_secondary_inventories_fk_v  msifv
              , apps.gl_code_combinations            gcc
              , apps.gl_code_combinations_kfv        gcc1
              , apps.gl_code_combinations_kfv        gcc2
              , apps.gl_code_combinations_kfv        gcc3
              , apps.gl_code_combinations_kfv        gcc4
              , apps.gl_code_combinations_kfv        gcc5
              --, apps.mtl_item_locations_kfv          milk
              , apps.mtl_material_transactions       mmt
              , apps.mtl_transaction_types           mtt
              , apps.mtl_txn_source_types            mtst
              , apps.fnd_flex_values_vl              ffvv
              , apps.fnd_flex_value_sets             ffvs
              , apps.fnd_user                        fu
              , ( SELECT organization_id
                       , inventory_item_id
                       , subinventory_code
                       , locator_id
                       , lot_number
                       --, transaction_uom_code
                       , create_transaction_id
                       , SUM (primary_transaction_quantity) onhand_qty
                    FROM apps.mtl_onhand_quantities_detail
                   WHERE organization_id IN (SELECT ood.organization_id FROM apps.org_organization_definitions ood WHERE ood.set_of_books_id = 230 )
                   GROUP BY organization_id
                          , inventory_item_id
                          , subinventory_code
                          , locator_id
                       --   , revision
                          , lot_number
                          --, transaction_uom_code
                          , create_transaction_id ) moq
                          ,APPS.MTL_PAC_ACTUAL_COST_DETAILS MPACD 
          WHERE 1                                = 1
          AND decode(mmt.periodic_primary_quantity,null,mmt.transfer_transaction_id,MMT.TRANSACTION_ID) = MPACD.TRANSACTION_ID  
            AND mp.organization_id               = msi.organization_id
--            AND msi.segment1 = '60510302'
            AND msifv.organization_id            = msi.organization_id
            AND msifv.secondary_inventory_name   = moq.subinventory_code
            AND msifv.material_account           = gcc1.code_combination_id
            AND msifv.outside_processing_account = gcc2.code_combination_id
            AND msifv.material_overhead_account  = gcc3.code_combination_id
            AND msifv.overhead_account           = gcc4.code_combination_id
            AND msifv.resource_account           = gcc5.code_combination_id
            AND msi.cost_of_sales_account       = gcc.code_combination_id
            AND ffvs.flex_value_set_name        = 'GE_GL_AFF_ES_PRODUCT_LINE'
            AND ffvs.flex_value_set_id          = ffvv.flex_value_set_id
            AND ffvv.flex_value_meaning         = gcc.segment8
            AND 'TYPE 1'                        IN ('TYPE 1')
            AND msi.organization_id             IN (SELECT ood.organization_id FROM apps.org_organization_definitions ood WHERE ood.set_of_books_id = 230 )
            AND moq.inventory_item_id           = msi.inventory_item_id
            AND moq.organization_id             = msi.organization_id
            --AND moq.locator_id                  = milk.inventory_location_id
            AND moq.create_transaction_id       = mmt.transaction_id
--    AND MMT.TRANSACTION_ID = 2562828197
            AND mtt.transaction_type_id         = mmt.transaction_type_id 
            AND mtst.transaction_source_type_id = mmt.transaction_source_type_id
            AND msi.serial_number_control_code  = '1' 
            AND msi.lot_control_code            = '1'
            AND moq.locator_id                  IS NULL
            AND fu.user_id                      = mmt.created_by 
    AND MMT.TRANSACTION_ID NOT IN(SELECT MMT2.TRANSACTION_ID 
                                  FROM AMARCHIVE.MTL_MATERIAL_TRANSACTIONS  MMT2
                                  WHERE MMT2.TRANSACTION_ID = MMT.TRANSACTION_ID)
------------------------------------------------------------------------------
UNION  
------------------------------------------------------------------------------ 
-- Sem Controle de Serial e sem Controle de Lote e Sem Locator  ---- AMARCHIVE.MTL_MATERIAL_TRANSACTIONS
         SELECT DISTINCT -- '8' NUM
        /* ( SELECT ccg.cost_group 
                             FROM apps.cst_cost_groups            ccg
                                , apps.cst_cost_group_assignments ccga
                            WHERE ccga.cost_group_id     = ccg.cost_group_id
                              AND ccga.organization_id   = mp.organization_id )  cost_group*/
            ( SELECT ccg.cost_group 
                             FROM apps.cst_cost_groups            ccg
                            WHERE MPACD.cost_group_id     = ccg.cost_group_id )  cost_group  
              , ( SELECT ( SELECT cpp1.period_name 
                             FROM apps.cst_pac_item_costs   cst
                                , apps.cst_pac_periods      cpp1
                            WHERE cst.pac_period_id     = (SELECT MAX(PAC_PERIOD_ID)                   FROM APPS.CST_PAC_PERIODS                  WHERE LEGAL_ENTITY = (SELECT LEGAL_ENTITY                                          FROM APPS.ORG_ORGANIZATION_DEFINITIONS OOD                                         WHERE OOD.ORGANIZATION_ID = mp.organization_id                                         ) )
                              AND cst.pac_period_id     = cpp1.pac_period_id
                              AND cst.inventory_item_id = msi.inventory_item_id
                              AND cst.cost_group_id     = ccg.cost_group_id )  
                    FROM apps.cst_cost_groups            ccg
                       , apps.cst_cost_group_assignments ccga
                   WHERE ccga.cost_group_id     = ccg.cost_group_id
                     AND ccga.organization_id   = mp.organization_id ) period_name
              , mp.organization_code
              , mp.attribute7                organization_type
              , mp.organization_id 
              , moq.subinventory_code
              , msifv.description            subinv_description
              , NULL   locators
              , DECODE( msifv.asset_inventory, 1 , 'Asset', 2, 'Non Asset')   asset_type
              , msi.segment1                 part_number
              , DECODE(msi.inventory_asset_flag, NULL, 'No', 'N', 'No', 'Y', 'Yes')                         flag_asset_inventory
              , DECODE(msi.costing_enabled_flag, NULL, 'No', 'N', 'No', 'Y', 'Yes')                         flag_de_custo
              , msi.description              descrip_eng
              , msi.attribute3               descrip_ptb
              , msi.creation_date            item_creation_date
              , (trunc(SYSDATE) - trunc(msi.creation_date))      days_from_creation
              , gcc.segment8                                     product_line
              , ffvv.description                                 desc_prod_line   
              , msi.primary_uom_code    uom
              , moq.onhand_qty                                   transaction_quantity
              , NVL(( SELECT cic.item_cost
                        FROM apps.cst_item_costs cic
                       WHERE cic.organization_id   = msi.organization_id
                         AND cic.inventory_item_id = msi.inventory_item_id
                         AND cic.cost_type_id      = 1 ),0)  custo_unit_inv
              /*, nvl(( SELECT ( SELECT ROUND (cst.item_cost,2) 
                                 FROM apps.cst_pac_item_costs   cst
                                WHERE cst.pac_period_id     = (SELECT MAX(PAC_PERIOD_ID)                   FROM APPS.CST_PAC_PERIODS                  WHERE LEGAL_ENTITY = (SELECT LEGAL_ENTITY                                          FROM APPS.ORG_ORGANIZATION_DEFINITIONS OOD                                         WHERE OOD.ORGANIZATION_ID = mp.organization_id                                         ) )
                                  AND cst.inventory_item_id = msi.inventory_item_id
                                  AND cst.cost_group_id     = ccg.cost_group_id )  item_cost
                        FROM apps.cst_cost_groups            ccg
                           , apps.cst_cost_group_assignments ccga
                       WHERE ccga.cost_group_id     = ccg.cost_group_id
                         AND ccga.organization_id   = mp.organization_id ) ,0) custo_unit_pac*/
                , nvl((SELECT ROUND (cst.item_cost,2) 
                       FROM apps.cst_pac_item_costs   cst
                      WHERE cst.pac_period_id     = (SELECT MAX(PAC_PERIOD_ID)                   
                                                                FROM APPS.CST_PAC_PERIODS                  
                                                                WHERE LEGAL_ENTITY = (SELECT LEGAL_ENTITY                                         
                                                                                        FROM APPS.ORG_ORGANIZATION_DEFINITIONS OOD                                        
                                                                                        WHERE OOD.ORGANIZATION_ID = mp.organization_id
                                                        ) )
                        AND cst.inventory_item_id = msi.inventory_item_id
                        AND cst.cost_group_id     = MPACD.cost_group_id) ,0)  custo_unit_pac
              , moq.lot_number
              , ( SELECT mln.creation_date        
                    FROM apps.mtl_lot_numbers              mln
                   WHERE mln.lot_number           = moq.lot_number
                     AND mln.inventory_item_id    = msi.inventory_item_id
                     AND mln.organization_id      = mp.organization_id  )  lot_creation_date
              , NULL   lot_qty_days_creation
              , ( SELECT mln.expiration_date         
                    FROM apps.mtl_lot_numbers              mln
                   WHERE mln.lot_number           = moq.lot_number
                     AND mln.inventory_item_id    = msi.inventory_item_id
                     AND mln.organization_id      = mp.organization_id  )  lot_expiration_date
              , NULL  serial_number
              , NULL  serial_creation_date
              , mtt.transaction_type_name           last_transaction_type
              , mmt.transaction_source_name         last_transaction_source
              , mtst.transaction_source_type_name   last_source_type
              , mmt.source_code
              , TO_CHAR(mmt.transaction_date, 'DD-MON-RRRR')      transaction_date
        , (SELECT TO_CHAR(mmt1.transaction_date, 'DD-MON-RRRR') 
                        FROM apps.mtl_material_transactions mmt1
                        WHERE mmt1.transaction_type_id=420
                        AND mmt1.source_line_id=mmt.source_line_id) initial_consignment_date  
              , (TRUNC ( SYSDATE )- TRUNC(mmt.transaction_date))  transaction_qty_of_days
              , TO_CHAR(mmt.transaction_reference)                transaction_reference
              , CASE WHEN mmt.source_code = '3PL_REMITTANCE_BRAZIL' THEN
                     (SELECT listagg(pha.segment1,', ' ON OVERFLOW TRUNCATE)  
                      WITHIN GROUP (ORDER BY pha.segment1 asc)
                        FROM apps.po_headers_all        pha,
                             apps.po_lines_all          pla
                       WHERE pla.po_line_id   = mmt.source_line_id
                         AND pla.po_header_id = pha.po_header_id)
                     WHEN mmt.source_code IN ('ORDER ENTRY','IIP') THEN
                        NULL
                     WHEN mmt.source_code = 'RCV' THEN
                        ( SELECT listagg(pha.segment1,', ' ON OVERFLOW TRUNCATE)  
                          WITHIN GROUP (ORDER BY pha.segment1 asc)
                            FROM apps.po_headers_all            pha
                               , apps.po_lines_all              pla
                               , apps.po_line_locations_all     plla
                               , apps.rcv_shipment_headers      rsh
                               , apps.rcv_transactions          rt
                           WHERE rt.transaction_id                = mmt.rcv_transaction_id
                             AND rt.po_line_location_id           = plla.line_location_id
                             AND plla.po_line_id                  = pla.po_line_id
                             AND pha.po_header_id                 = pla.po_header_id
                             AND rt.shipment_header_id            = rsh.shipment_header_id
                             AND rsh.receipt_source_code          = 'VENDOR'  )
                     ELSE
                        NULL
                END      po_number
              , CASE WHEN mmt.source_code = '3PL_REMITTANCE_BRAZIL' THEN
                     (SELECT listagg(aps.vendor_name,', ' ON OVERFLOW TRUNCATE)  
                      WITHIN GROUP (ORDER BY aps.vendor_name asc)
                        FROM apps.po_headers_all        pha
                           , apps.po_lines_all          pla
                          , apps.ap_suppliers          aps
                           , apps.ap_supplier_sites_all  apss
                       WHERE pla.po_line_id     = mmt.source_line_id
                         AND pla.po_header_id   = pha.po_header_id
                         AND pha.vendor_id      = aps.vendor_id
                         AND aps.vendor_id      = apss.vendor_id
                         AND pha.vendor_site_id = apss.vendor_site_id )
                     WHEN mmt.source_code IN ('ORDER ENTRY','IIP') THEN
                        NULL
                     WHEN mmt.source_code = 'RCV' THEN
                        ( SELECT listagg(aps.vendor_name,', ' ON OVERFLOW TRUNCATE)  
                          WITHIN GROUP (ORDER BY aps.vendor_name asc)
                            FROM apps.po_headers_all            pha
                               , apps.po_lines_all              pla
                               , apps.po_line_locations_all     plla
                               , apps.rcv_shipment_headers      rsh
                               , apps.rcv_transactions          rt
                               , apps.ap_suppliers              aps
                               , apps.ap_supplier_sites_all     apss
                           WHERE rt.transaction_id          = mmt.rcv_transaction_id
                             AND rt.po_line_location_id     = plla.line_location_id
                             AND plla.po_line_id            = pla.po_line_id
                             AND pha.po_header_id           = pla.po_header_id
                             AND rt.shipment_header_id      = rsh.shipment_header_id
                             AND rsh.receipt_source_code    = 'VENDOR'
                             AND pha.vendor_id              = aps.vendor_id
                             AND aps.vendor_id              = apss.vendor_id
                             AND pha.vendor_site_id         = apss.vendor_site_id  )
                     ELSE
                        NULL
                END     po_supplier
              , CASE WHEN mmt.source_code = '3PL_REMITTANCE_BRAZIL' THEN
                     ( SELECT listagg(cfi.invoice_num,', ' ON OVERFLOW TRUNCATE)  
                         WITHIN GROUP (ORDER BY cfi.invoice_num asc)
                         FROM apps.cll_f189_invoice_lines cfil
                            , apps.cll_f189_invoices      cfi
                            , apps.po_lines_all           pla
                            , apps.po_line_locations_all  plla
                        WHERE plla.po_line_id       = pla.po_line_id
                          AND pla.po_line_id        = mmt.source_line_id
                          AND plla.line_location_id = cfil.line_location_id
                          AND cfil.invoice_id       = cfi.invoice_id )
                     WHEN mmt.source_code IN ('ORDER ENTRY','IIP') THEN
                        NULL
                     WHEN mmt.source_code = 'RCV' THEN
                        ( SELECT listagg(cfi.invoice_num,', ' ON OVERFLOW TRUNCATE)  
                            WITHIN GROUP (ORDER BY cfi.invoice_num asc)
                            FROM apps.po_headers_all            pha
                               , apps.po_lines_all              pla
                               , apps.po_line_locations_all     plla
                               , apps.cll_f189_invoice_lines    cfil
                               , apps.cll_f189_invoices         cfi
                               , apps.rcv_shipment_headers      rsh
                               , apps.rcv_transactions          rt
                           WHERE rt.transaction_id          = mmt.rcv_transaction_id
                             AND rt.po_line_location_id     = plla.line_location_id
                             AND plla.line_location_id      = cfil.line_location_id
                             AND cfil.invoice_id            = cfi.invoice_id
                             AND plla.po_line_id            = pla.po_line_id
                             AND pha.po_header_id           = pla.po_header_id
                             AND rt.shipment_header_id      = rsh.shipment_header_id
                             AND rsh.receipt_source_code    = 'VENDOR'   )
                     ELSE
                        NULL
                END    NF_RI
             , (SELECT DECODE( mmt.source_code, '3PL_REMITTANCE_BRAZIL',NULL,to_char(ooha.order_number) )
                  FROM apps.oe_order_headers_all  ooha,
                       apps.oe_order_lines_all    oola  
                 WHERE oola.line_id        = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                   AND oola.header_id      = ooha.header_id )   order_number
               -- 
               -- alterado para BIll_to por Sinval inicio
               --
               , CASE WHEN ( SELECT ottl.name
                             FROM apps.oe_transaction_types_tl    ottl
                                , apps.oe_order_headers_all  ooha
                                , apps.oe_order_lines_all    oola  
                            WHERE oola.line_id        = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND oola.header_id      = ooha.header_id
                              AND ooha.order_type_id  = ottl.transaction_type_id  ) = 'GPO_BR_FE_SHIPMENT' THEN
                     (SELECT listagg(hp.party_name,', ' ON OVERFLOW TRUNCATE)  
                      WITHIN GROUP (ORDER BY hp.party_name asc)
                        FROM apps.hz_parties             hp
                           , apps.hz_cust_accounts       hca
                           , apps.oe_order_lines_all     oola
                           , apps.hz_cust_acct_sites_all hcas
                           , apps.hz_cust_site_uses_all  hcsu
                       WHERE oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                         AND oola.end_customer_site_use_id  = hcsu.site_use_id
                         AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                         AND hcas.cust_account_id           = hca.cust_account_id
                         AND hca.party_id                   = hp.party_id )
                  ELSE
                     CASE WHEN (mmt.source_code = '3PL_REMITTANCE_BRAZIL') THEN
                       (SELECT listagg(hp.party_name,', ' ON OVERFLOW TRUNCATE)  
                        WITHIN GROUP (ORDER BY hp.party_name asc)
                          FROM apps.hz_parties             hp,
                               apps.hz_cust_accounts       hca,
                               apps.ra_customer_trx_all    rcta,
                               apps.hz_cust_acct_sites_all hcas,
                               apps.hz_cust_site_uses_all  hcsu
                         WHERE rcta.interface_header_attribute1 = mp.organization_code||'_'||mmt.transaction_reference
                           AND rcta.ship_to_site_use_id         = hcsu.site_use_id
                           AND hcsu.cust_acct_site_id           = hcas.cust_acct_site_id
                           AND hcas.cust_account_id             = hca.cust_account_id
                           AND hca.party_id                     = hp.party_id
                           AND rcta.org_id                      = 4330)
                     ELSE
                        (SELECT listagg(hp.party_name,', ' ON OVERFLOW TRUNCATE)  
                         WITHIN GROUP (ORDER BY hp.party_name asc)
                           FROM apps.hz_parties             hp
                              , apps.hz_cust_accounts       hca
                              , apps.oe_order_lines_all     oola
                              , apps.hz_cust_acct_sites_all hcas
                              , apps.hz_cust_site_uses_all  hcsu
                          WHERE oola.line_id                = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                            AND oola.ship_to_org_id         = hcsu.site_use_id
                            AND hcsu.cust_acct_site_id      = hcas.cust_acct_site_id
                            AND hcas.cust_account_id        = hca.cust_account_id
                            AND hca.party_id                = hp.party_id )
                    END                 
               END    customer_name
             , CASE WHEN ( SELECT ottl.name
                             FROM apps.oe_transaction_types_tl    ottl
                                , apps.oe_order_headers_all  ooha
                                , apps.oe_order_lines_all    oola  
                            WHERE oola.line_id        = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND oola.header_id      = ooha.header_id
                              AND ooha.order_type_id  = ottl.transaction_type_id  ) = 'GPO_BR_FE_SHIPMENT' THEN
                     (SELECT listagg(hca.account_number,', ' ON OVERFLOW TRUNCATE)  
                      WITHIN GROUP (ORDER BY hca.account_number asc)
                        FROM apps.hz_parties             hp
                           , apps.hz_cust_accounts       hca
                           , apps.oe_order_lines_all     oola
                           , apps.hz_cust_acct_sites_all hcas
                           , apps.hz_cust_site_uses_all  hcsu
                       WHERE oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                         AND oola.end_customer_site_use_id  = hcsu.site_use_id
                         AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                         AND hcas.cust_account_id           = hca.cust_account_id
                         AND hca.party_id                   = hp.party_id )
                  ELSE
                     CASE WHEN (mmt.source_code = '3PL_REMITTANCE_BRAZIL') THEN
                        (SELECT listagg(hca.account_number,', ' ON OVERFLOW TRUNCATE)  
                         WITHIN GROUP (ORDER BY hca.account_number asc)
                           FROM apps.hz_parties             hp,
                                apps.hz_cust_accounts       hca,
                                apps.ra_customer_trx_all    rcta,
                                apps.hz_cust_acct_sites_all hcas,
                                apps.hz_cust_site_uses_all  hcsu
                          WHERE rcta.interface_header_attribute1 = mp.organization_code||'_'||mmt.transaction_reference
                            AND rcta.ship_to_site_use_id         = hcsu.site_use_id
                            AND hcsu.cust_acct_site_id           = hcas.cust_acct_site_id
                            AND hcas.cust_account_id             = hca.cust_account_id
                            AND hca.party_id                     = hp.party_id
                            AND rcta.org_id                      = 4330)
                     ELSE
                        (SELECT listagg(hca.account_number,', ' ON OVERFLOW TRUNCATE)  
                         WITHIN GROUP (ORDER BY hca.account_number asc)
                           FROM apps.hz_parties             hp
                              , apps.hz_cust_accounts       hca
                              , apps.oe_order_lines_all     oola
                              , apps.hz_cust_acct_sites_all hcas
                              , apps.hz_cust_site_uses_all  hcsu
                          WHERE oola.line_id                = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                            AND oola.ship_to_org_id         = hcsu.site_use_id
                            AND hcsu.cust_acct_site_id      = hcas.cust_acct_site_id
                            AND hcas.cust_account_id        = hca.cust_account_id
                            AND hca.party_id                = hp.party_id   )
                     END
                  END   customer_number
              --
             , CASE WHEN ( SELECT ottl.name
                             FROM apps.oe_transaction_types_tl    ottl
                                , apps.oe_order_headers_all  ooha
                                , apps.oe_order_lines_all    oola  
                            WHERE oola.line_id        = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND oola.header_id      = ooha.header_id
                              AND ooha.order_type_id  = ottl.transaction_type_id  ) = 'GPO_BR_FE_SHIPMENT' THEN
                     (SELECT listagg(DECODE(hcas.global_attribute2
                                           , '2',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'/'|| hcas.global_attribute4 ||'-'|| hcas.global_attribute5
                                           , '1',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'-'|| hcas.global_attribute5 
                                           , '3',HCSU.LOCATION||' - '||hcas.global_attribute3 ),', ' ON OVERFLOW TRUNCATE)
                     WITHIN GROUP (ORDER BY hcas.global_attribute2 asc ) 
                        FROM apps.hz_parties             hp
                           , apps.hz_cust_accounts       hca
                           , apps.oe_order_lines_all     oola
                           , apps.hz_cust_acct_sites_all hcas
                           , apps.hz_cust_site_uses_all  hcsu
                       WHERE oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                         AND oola.end_customer_site_use_id  = hcsu.site_use_id
                         AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                         AND hcas.cust_account_id           = hca.cust_account_id
                         AND hca.party_id                   = hp.party_id )
                ELSE
                   CASE WHEN (mmt.source_code = '3PL_REMITTANCE_BRAZIL') THEN
                      (SELECT listagg(DECODE(hcas.global_attribute2
                                           , '2',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'/'|| hcas.global_attribute4 ||'-'|| hcas.global_attribute5
                                           , '1',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'-'|| hcas.global_attribute5 
                                           , '3',HCSU.LOCATION||' - '||hcas.global_attribute3 ),', ' ON OVERFLOW TRUNCATE)
                     WITHIN GROUP (ORDER BY hcas.global_attribute2 asc) 
                         FROM apps.ra_customer_trx_all     rcta
                            , apps.hz_cust_acct_sites_all  hcas
                            , apps.hz_cust_site_uses_all   hcsu
                        WHERE rcta.interface_header_attribute1 = mp.organization_code||'_'||mmt.transaction_reference
                          AND rcta.ship_to_site_use_id         = hcsu.site_use_id
                          AND hcsu.cust_acct_site_id           = hcas.cust_acct_site_id
                          AND rcta.org_id                      = 4330)
                   ELSE
                      (SELECT listagg(DECODE(hcas.global_attribute2
                                           , '2',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'/'|| hcas.global_attribute4 ||'-'|| hcas.global_attribute5
                                           , '1',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'-'|| hcas.global_attribute5 
                                           , '3',HCSU.LOCATION||' - '||hcas.global_attribute3 ),', ' ON OVERFLOW TRUNCATE)
                      WITHIN GROUP (ORDER BY hcas.global_attribute2 asc) 
                         FROM apps.hz_parties             hp
                            , apps.hz_cust_accounts       hca
                            , apps.oe_order_lines_all     oola
                            , apps.hz_cust_acct_sites_all hcas
                            , apps.hz_cust_site_uses_all  hcsu
                        WHERE oola.line_id                = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                          AND oola.ship_to_org_id         = hcsu.site_use_id
                          AND hcsu.cust_acct_site_id      = hcas.cust_acct_site_id
                          AND hcas.cust_account_id        = hca.cust_account_id
                          AND hca.party_id                = hp.party_id  )
                   END
                END  customer_cnpj_cpf
               -- 
              , CASE WHEN (mmt.source_code = '3PL_REMITTANCE_BRAZIL') THEN
                      (SELECT listagg(DECODE(hcas.global_attribute2
                                           , '2',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'/'|| hcas.global_attribute4 ||'-'|| hcas.global_attribute5
                                           , '1',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'-'|| hcas.global_attribute5 
                                           , '3',HCSU.LOCATION||' - '||hcas.global_attribute3 ),', ' ON OVERFLOW TRUNCATE)
                       WITHIN GROUP (ORDER BY hcas.global_attribute2 asc )
                         FROM apps.ra_customer_trx_all         rcta
                            , apps.hz_cust_acct_sites_all      hcas
                            , apps.hz_cust_site_uses_all       hcsu
                        WHERE rcta.interface_header_attribute1 = mp.organization_code||'_'||mmt.transaction_reference
                          AND rcta.bill_to_site_use_id         = hcsu.site_use_id
                          AND hcsu.cust_acct_site_id           = hcas.cust_acct_site_id
                          AND rcta.org_id                      = 4330
                          AND ROWNUM = 1)
                   ELSE
                     --
                     CASE WHEN (select DISTINCT RCTL.INTERFACE_LINE_CONTEXT
                             FROM apps.hz_parties                hp
                                , apps.hz_cust_accounts          hca
                                , apps.oe_order_lines_all        oola
                                , apps.oe_order_headers_all      ooha
                                , apps.ra_customer_trx_lines_all rctl
                                , apps.ra_customer_trx_all       rcta
                                , apps.hz_cust_acct_sites_all    hcas
                                , apps.hz_cust_site_uses_all     hcsu
                            WHERE ooha.header_id                 = oola.header_id
                              AND oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND rctl.inventory_item_id         = oola.inventory_item_id
                              AND rctl.line_type                 = 'LINE'
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE1 = to_char(ooha.order_number)
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE6 = to_char(oola.line_id)
                              AND RCTL.INTERFACE_LINE_CONTEXT    = 'ORDER ENTRY'
                              AND rctl.customer_trx_id           = rcta.customer_trx_id
                              AND rcta.bill_to_site_use_id       = hcsu.site_use_id
                              AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                              AND hcas.cust_account_id           = hca.cust_account_id
                              AND hca.party_id                   = hp.party_id 
                              AND ROWNUM = 1) = 'ORDER ENTRY' THEN
                     --
                     (SELECT DISTINCT DECODE(hcas.global_attribute2
                                           , '2',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'/'|| hcas.global_attribute4 ||'-'|| hcas.global_attribute5
                                           , '1',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'-'|| hcas.global_attribute5 
                                           , '3',HCSU.LOCATION||' - '||hcas.global_attribute3)
                             FROM apps.hz_parties                hp
                                , apps.hz_cust_accounts          hca
                                , apps.oe_order_lines_all        oola
                                , apps.oe_order_headers_all      ooha
                                , apps.ra_customer_trx_lines_all rctl
                                , apps.ra_customer_trx_all       rcta
                                , apps.hz_cust_acct_sites_all    hcas
                                , apps.hz_cust_site_uses_all     hcsu
                            WHERE ooha.header_id                 = oola.header_id
                              AND oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND rctl.inventory_item_id         = oola.inventory_item_id
                              AND rctl.line_type                 = 'LINE'
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE1 = to_char(ooha.order_number)
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE6 = to_char(oola.line_id)
                              AND RCTL.INTERFACE_LINE_CONTEXT    = 'ORDER ENTRY'
                              AND rctl.customer_trx_id           = rcta.customer_trx_id
                              AND rcta.bill_to_site_use_id       = hcsu.site_use_id
                              AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                              AND hcas.cust_account_id           = hca.cust_account_id
                              AND hca.party_id                   = hp.party_id
                              AND ROWNUM = 1)
                     --
                     ELSE
                     --            
                     CASE WHEN 
                          ( SELECT DISTINCT RCTL.INTERFACE_LINE_CONTEXT
                             FROM apps.hz_parties                hp
                                , apps.hz_cust_accounts          hca
                                , apps.oe_order_lines_all        oola
                                , apps.oe_order_headers_all      ooha
                               , apps.ra_customer_trx_lines_all rctl
                                , apps.ra_customer_trx_all       rcta
                                , apps.hz_cust_acct_sites_all    hcas
                                , apps.hz_cust_site_uses_all     hcsu
                            WHERE ooha.header_id                 = oola.header_id
                              AND oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND rctl.inventory_item_id         = oola.inventory_item_id
                              AND rctl.line_type                 = 'LINE'
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE1 = ooha.ORIG_SYS_DOCUMENT_REF
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE7 = oola.ORIG_SYS_LINE_REF
                              AND RCTL.INTERFACE_LINE_CONTEXT    = 'GEMS_PB_RR'
                              AND rctl.customer_trx_id           = rcta.customer_trx_id
                              AND rcta.bill_to_site_use_id       = hcsu.site_use_id
                              AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                              AND hcas.cust_account_id           = hca.cust_account_id
                              AND ROWNUM = 1 ) = 'GEMS_PB_RR' THEN
                     --
                     (SELECT DISTINCT DECODE(hcas.global_attribute2
                                           , '2',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'/'|| hcas.global_attribute4 ||'-'|| hcas.global_attribute5
                                           , '1',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'-'|| hcas.global_attribute5 
                                           , '3',HCSU.LOCATION||' - '||hcas.global_attribute3)
                             FROM apps.hz_parties                hp
                                , apps.hz_cust_accounts          hca
                                , apps.oe_order_lines_all        oola
                                , apps.oe_order_headers_all      ooha
                                , apps.ra_customer_trx_lines_all rctl
                                , apps.ra_customer_trx_all       rcta
                                , apps.hz_cust_acct_sites_all    hcas
                                , apps.hz_cust_site_uses_all     hcsu
                            WHERE ooha.header_id                 = oola.header_id
                              AND oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND rctl.inventory_item_id         = oola.inventory_item_id
                              AND rctl.line_type                 = 'LINE'
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE1 = ooha.ORIG_SYS_DOCUMENT_REF
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE7 = oola.ORIG_SYS_LINE_REF
                              AND RCTL.INTERFACE_LINE_CONTEXT    = 'GEMS_PB_RR'
                              AND rctl.customer_trx_id           = rcta.customer_trx_id
                              AND rcta.bill_to_site_use_id       = hcsu.site_use_id
                              AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                              AND hcas.cust_account_id           = hca.cust_account_id 
                              AND ROWNUM = 1 )
                     --
                     ELSE
                     --
                     (SELECT DISTINCT DECODE(hcas.global_attribute2
                                   , '2',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'/'|| hcas.global_attribute4 ||'-'|| hcas.global_attribute5
                                   , '1',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'-'|| hcas.global_attribute5 
                                   , '3',HCSU.LOCATION||' - '||hcas.global_attribute3)
                             --
                      FROM   APPS.HZ_CUST_ACCT_SITES_ALL HCAS,
                             APPS.HZ_CUST_SITE_USES_ALL  HCSU,
                             APPS.OE_ORDER_LINES_ALL     OOLA,
                             APPS.OE_ORDER_HEADERS_ALL   OOHA
                             --
                      WHERE  HCSU.SITE_USE_CODE     = 'BILL_TO'
                      AND    HCSU.CUST_ACCT_SITE_ID = HCAS.CUST_ACCT_SITE_ID
                      AND    HCSU.SITE_USE_ID       = NVL(OOLA.ATTRIBUTE1, OOHA.INVOICE_TO_ORG_ID)
                      AND    OOLA.LINE_ID           = NVL(MMT.TRX_SOURCE_LINE_ID, MMT.SOURCE_LINE_ID)
                      AND    OOHA.HEADER_ID         = OOLA.HEADER_ID
                      AND    ROWNUM = 1)
                     --
                     END
                  END
               END      bill_to_CNPJ_CPF
               --
                             --
              , CASE WHEN (mmt.source_code = '3PL_REMITTANCE_BRAZIL') THEN
                        (SELECT listagg(hp.party_name,', ' ON OVERFLOW TRUNCATE)  
                        WITHIN GROUP (ORDER BY hp.party_name asc)
                          FROM apps.hz_parties             hp,
                               apps.hz_cust_accounts       hca,
                               apps.ra_customer_trx_all    rcta,
                               apps.hz_cust_acct_sites_all hcas,
                               apps.hz_cust_site_uses_all  hcsu
                         WHERE rcta.interface_header_attribute1 = mp.organization_code||'_'||mmt.transaction_reference
                           AND rcta.bill_to_site_use_id         = hcsu.site_use_id
                           AND hcsu.cust_acct_site_id           = hcas.cust_acct_site_id
                           AND hcas.cust_account_id             = hca.cust_account_id
                           AND hca.party_id                     = hp.party_id
                           AND rcta.org_id                      = 4330)
                   ELSE
                     --
                     CASE WHEN (select DISTINCT RCTL.INTERFACE_LINE_CONTEXT
                             FROM apps.hz_parties                hp
                                , apps.hz_cust_accounts          hca
                                , apps.oe_order_lines_all        oola
                                , apps.oe_order_headers_all      ooha
                                , apps.ra_customer_trx_lines_all rctl
                                , apps.ra_customer_trx_all       rcta
                                , apps.hz_cust_acct_sites_all    hcas
                                , apps.hz_cust_site_uses_all     hcsu
                            WHERE ooha.header_id                 = oola.header_id
                              AND oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND rctl.inventory_item_id         = oola.inventory_item_id
                              AND rctl.line_type                 = 'LINE'
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE1 = to_char(ooha.order_number)
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE6 = to_char(oola.line_id)
                              AND RCTL.INTERFACE_LINE_CONTEXT    = 'ORDER ENTRY'
                              AND rctl.customer_trx_id           = rcta.customer_trx_id
                              AND rcta.bill_to_site_use_id       = hcsu.site_use_id
                              AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                              AND hcas.cust_account_id           = hca.cust_account_id
                              AND hca.party_id                   = hp.party_id 
                              AND ROWNUM = 1) = 'ORDER ENTRY' THEN
                     --
                     (SELECT listagg(hp.party_name,', ' ON OVERFLOW TRUNCATE)  
                         WITHIN GROUP (ORDER BY hp.party_name asc)
                             FROM apps.hz_parties                hp
                                , apps.hz_cust_accounts          hca
                                , apps.oe_order_lines_all        oola
                                , apps.oe_order_headers_all      ooha
                                , apps.ra_customer_trx_lines_all rctl
                                , apps.ra_customer_trx_all       rcta
                                , apps.hz_cust_acct_sites_all    hcas
                                , apps.hz_cust_site_uses_all     hcsu
                            WHERE ooha.header_id                 = oola.header_id
                              AND oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND rctl.inventory_item_id         = oola.inventory_item_id
                              AND rctl.line_type                 = 'LINE'
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE1 = to_char(ooha.order_number)
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE6 = to_char(oola.line_id)
                              AND RCTL.INTERFACE_LINE_CONTEXT    = 'ORDER ENTRY'
                              AND rctl.customer_trx_id           = rcta.customer_trx_id
                              AND rcta.bill_to_site_use_id       = hcsu.site_use_id
                              AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                              AND hcas.cust_account_id           = hca.cust_account_id
                              AND hca.party_id                   = hp.party_id
                              AND ROWNUM = 1)
                     --
                     ELSE
                     --            
                     CASE WHEN 
                          ( SELECT DISTINCT RCTL.INTERFACE_LINE_CONTEXT
                             FROM apps.hz_parties                hp
                                , apps.hz_cust_accounts          hca
                                , apps.oe_order_lines_all        oola
                                , apps.oe_order_headers_all      ooha
                                , apps.ra_customer_trx_lines_all rctl
                                , apps.ra_customer_trx_all       rcta
                                , apps.hz_cust_acct_sites_all    hcas
                                , apps.hz_cust_site_uses_all     hcsu
                            WHERE ooha.header_id                 = oola.header_id
                              AND oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND rctl.inventory_item_id         = oola.inventory_item_id
                              AND rctl.line_type                 = 'LINE'
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE1 = ooha.ORIG_SYS_DOCUMENT_REF
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE7 = oola.ORIG_SYS_LINE_REF
                              AND RCTL.INTERFACE_LINE_CONTEXT    = 'GEMS_PB_RR'
                              AND rctl.customer_trx_id           = rcta.customer_trx_id
                              AND rcta.bill_to_site_use_id       = hcsu.site_use_id
                              AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                              AND hcas.cust_account_id           = hca.cust_account_id
                              AND ROWNUM = 1 ) = 'GEMS_PB_RR' THEN
                     --
                     (SELECT listagg(hp.party_name,', ' ON OVERFLOW TRUNCATE)  
                         WITHIN GROUP (ORDER BY hp.party_name asc)
                             FROM apps.hz_parties                hp
                                , apps.hz_cust_accounts          hca
                                , apps.oe_order_lines_all        oola
                                , apps.oe_order_headers_all      ooha
                                , apps.ra_customer_trx_lines_all rctl
                                , apps.ra_customer_trx_all       rcta
                                , apps.hz_cust_acct_sites_all    hcas
                                , apps.hz_cust_site_uses_all     hcsu
                            WHERE ooha.header_id                 = oola.header_id
                              AND oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND rctl.inventory_item_id         = oola.inventory_item_id
                              AND rctl.line_type                 = 'LINE'
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE1 = ooha.ORIG_SYS_DOCUMENT_REF
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE7 = oola.ORIG_SYS_LINE_REF
                              AND RCTL.INTERFACE_LINE_CONTEXT    = 'GEMS_PB_RR'
                              AND rctl.customer_trx_id           = rcta.customer_trx_id
                              AND rcta.bill_to_site_use_id       = hcsu.site_use_id
                              AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                              AND hcas.cust_account_id           = hca.cust_account_id 
                              AND ROWNUM = 1 )
                     --
                     ELSE
                     --
                     (SELECT listagg(hp.party_name,', ' ON OVERFLOW TRUNCATE)  
                         WITHIN GROUP (ORDER BY hp.party_name asc)
                      FROM   APPS.HZ_CUST_ACCT_SITES_ALL HCAS,
                             apps.hz_parties             hp,
                             apps.hz_cust_accounts       hca,
                             APPS.HZ_CUST_SITE_USES_ALL  HCSU,
                             APPS.OE_ORDER_LINES_ALL     OOLA,
                             APPS.OE_ORDER_HEADERS_ALL   OOHA
                             --
                      WHERE  HCSU.SITE_USE_CODE     = 'BILL_TO'
                      AND    HCSU.CUST_ACCT_SITE_ID = HCAS.CUST_ACCT_SITE_ID
                      AND    HCSU.SITE_USE_ID       = NVL(OOLA.ATTRIBUTE1, OOHA.INVOICE_TO_ORG_ID)
                      AND    OOLA.LINE_ID           = NVL(MMT.TRX_SOURCE_LINE_ID, MMT.SOURCE_LINE_ID)
                      AND    OOHA.HEADER_ID         = OOLA.HEADER_ID
                      AND    hcas.cust_account_id   = hca.cust_account_id
                      AND    hca.party_id           = hp.party_id 
                      AND    ROWNUM = 1)
                     --          
                     END
                  END
               END      bill_to_Customer_name
               --
                , CASE WHEN (mmt.source_code = '3PL_REMITTANCE_BRAZIL') THEN
                      (SELECT listagg(DECODE(hcas.global_attribute2
                                           , '2',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'/'|| hcas.global_attribute4 ||'-'|| hcas.global_attribute5
                                           , '1',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'-'|| hcas.global_attribute5 
                                           , '3',HCSU.LOCATION||' - '||hcas.global_attribute3 ),', ' ON OVERFLOW TRUNCATE)
                       WITHIN GROUP (ORDER BY hcas.global_attribute2 asc )
                         FROM apps.ra_customer_trx_all         rcta
                            , apps.hz_cust_acct_sites_all      hcas
                            , apps.hz_cust_site_uses_all       hcsu
                        WHERE rcta.interface_header_attribute1 = mp.organization_code||'_'||mmt.transaction_reference
                          AND rcta.ship_to_site_use_id         = hcsu.site_use_id
                          AND hcsu.cust_acct_site_id           = hcas.cust_acct_site_id
                          AND rcta.org_id                      = 4330
                          AND ROWNUM = 1)
                   ELSE
                     --
                     CASE WHEN (select DISTINCT RCTL.INTERFACE_LINE_CONTEXT
                             FROM apps.hz_parties                hp
                                , apps.hz_cust_accounts          hca
                                , apps.oe_order_lines_all        oola
                                , apps.oe_order_headers_all      ooha
                                , apps.ra_customer_trx_lines_all rctl
                                , apps.ra_customer_trx_all       rcta
                                , apps.hz_cust_acct_sites_all    hcas
                                , apps.hz_cust_site_uses_all     hcsu
                            WHERE ooha.header_id                 = oola.header_id
                              AND oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND rctl.inventory_item_id         = oola.inventory_item_id
                              AND rctl.line_type                 = 'LINE'
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE1 = to_char(ooha.order_number)
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE6 = to_char(oola.line_id)
                              AND RCTL.INTERFACE_LINE_CONTEXT    = 'ORDER ENTRY'
                              AND rctl.customer_trx_id           = rcta.customer_trx_id
                              AND rcta.ship_to_site_use_id       = hcsu.site_use_id
                              AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                              AND hcas.cust_account_id           = hca.cust_account_id
                              AND hca.party_id                   = hp.party_id 
                              AND ROWNUM = 1) = 'ORDER ENTRY' THEN
                     --
                     (SELECT DISTINCT DECODE(hcas.global_attribute2
                                           , '2',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'/'|| hcas.global_attribute4 ||'-'|| hcas.global_attribute5
                                           , '1',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'-'|| hcas.global_attribute5 
                                           , '3',HCSU.LOCATION||' - '||hcas.global_attribute3)
                             FROM apps.hz_parties                hp
                                , apps.hz_cust_accounts          hca
                                , apps.oe_order_lines_all        oola
                                , apps.oe_order_headers_all      ooha
                                , apps.ra_customer_trx_lines_all rctl
                                , apps.ra_customer_trx_all       rcta
                                , apps.hz_cust_acct_sites_all    hcas
                                , apps.hz_cust_site_uses_all     hcsu
                            WHERE ooha.header_id                 = oola.header_id
                              AND oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND rctl.inventory_item_id         = oola.inventory_item_id
                              AND rctl.line_type                 = 'LINE'
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE1 = to_char(ooha.order_number)
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE6 = to_char(oola.line_id)
                              AND RCTL.INTERFACE_LINE_CONTEXT    = 'ORDER ENTRY'
                              AND rctl.customer_trx_id           = rcta.customer_trx_id
                              AND rcta.ship_to_site_use_id       = hcsu.site_use_id
                              AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                              AND hcas.cust_account_id           = hca.cust_account_id
                              AND hca.party_id                   = hp.party_id
                              AND ROWNUM = 1)
                     --
                     ELSE
                     --            
                     CASE WHEN 
                          ( SELECT DISTINCT RCTL.INTERFACE_LINE_CONTEXT
                             FROM apps.hz_parties                hp
                                , apps.hz_cust_accounts          hca
                                , apps.oe_order_lines_all        oola
                                , apps.oe_order_headers_all      ooha
                                , apps.ra_customer_trx_lines_all rctl
                                , apps.ra_customer_trx_all       rcta
                                , apps.hz_cust_acct_sites_all    hcas
                                , apps.hz_cust_site_uses_all     hcsu
                            WHERE ooha.header_id                 = oola.header_id
                              AND oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND rctl.inventory_item_id         = oola.inventory_item_id
                              AND rctl.line_type                 = 'LINE'
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE1 = ooha.ORIG_SYS_DOCUMENT_REF
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE7 = oola.ORIG_SYS_LINE_REF
                              AND RCTL.INTERFACE_LINE_CONTEXT    = 'GEMS_PB_RR'
                              AND rctl.customer_trx_id           = rcta.customer_trx_id
                              AND rcta.ship_to_site_use_id       = hcsu.site_use_id
                              AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                              AND hcas.cust_account_id           = hca.cust_account_id
                              AND ROWNUM = 1 ) = 'GEMS_PB_RR' THEN
                     --
                     (SELECT DISTINCT DECODE(hcas.global_attribute2
                                           , '2',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'/'|| hcas.global_attribute4 ||'-'|| hcas.global_attribute5
                                           , '1',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'-'|| hcas.global_attribute5 
                                           , '3',HCSU.LOCATION||' - '||hcas.global_attribute3)
                             FROM apps.hz_parties                hp
                                , apps.hz_cust_accounts          hca
                                , apps.oe_order_lines_all        oola
                                , apps.oe_order_headers_all      ooha
                                , apps.ra_customer_trx_lines_all rctl
                                , apps.ra_customer_trx_all       rcta
                                , apps.hz_cust_acct_sites_all    hcas
                                , apps.hz_cust_site_uses_all     hcsu
                            WHERE ooha.header_id                 = oola.header_id
                              AND oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND rctl.inventory_item_id         = oola.inventory_item_id
                              AND rctl.line_type                 = 'LINE'
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE1 = ooha.ORIG_SYS_DOCUMENT_REF
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE7 = oola.ORIG_SYS_LINE_REF
                              AND RCTL.INTERFACE_LINE_CONTEXT    = 'GEMS_PB_RR'
                              AND rctl.customer_trx_id           = rcta.customer_trx_id
                              AND rcta.ship_to_site_use_id       = hcsu.site_use_id
                              AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                              AND hcas.cust_account_id           = hca.cust_account_id 
                              AND ROWNUM = 1 )
                     --
                     ELSE
                     --
                     (SELECT listagg(DECODE(hcas.global_attribute2
                                           , '2',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'/'|| hcas.global_attribute4 ||'-'|| hcas.global_attribute5
                                           , '1',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'-'|| hcas.global_attribute5 
                                           , '3',HCSU.LOCATION||' - '||hcas.global_attribute3 ),', ' ON OVERFLOW TRUNCATE)
                      WITHIN GROUP (ORDER BY hcas.global_attribute2 asc) 
                         FROM apps.hz_parties             hp
                            , apps.hz_cust_accounts       hca
                            , apps.oe_order_lines_all     oola
                            , apps.hz_cust_acct_sites_all hcas
                            , apps.hz_cust_site_uses_all  hcsu
                        WHERE oola.line_id                = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                          AND oola.ship_to_org_id         = hcsu.site_use_id
                          AND hcsu.cust_acct_site_id      = hcas.cust_acct_site_id
                          AND hcas.cust_account_id        = hca.cust_account_id
                          AND hca.party_id                = hp.party_id  )
                     --
                     END
                  END
               END      ship_to_CNPJ_CPF
               --
              , CASE WHEN ( SELECT ottl.name
                              FROM apps.oe_transaction_types_tl    ottl
                                 , apps.oe_order_headers_all  ooha
                                 , apps.oe_order_lines_all    oola  
                             WHERE oola.line_id        = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                               AND oola.header_id      = ooha.header_id
                               AND ooha.order_type_id  = ottl.transaction_type_id  ) = 'GPO_BR_FE_SHIPMENT' THEN
                      (SELECT listagg(hzl.address1 ||' - '|| hzl.address2 || ' - ' || hzl.city || '-' || hzl.state || ' / ' || hzl.postal_code,', ' ON OVERFLOW TRUNCATE)  
                       WITHIN GROUP (ORDER BY hzl.address1 asc)
                       FROM apps.hz_parties             hp
                        , apps.hz_party_sites         hps
                        , apps.hz_cust_accounts       hca
                        , apps.oe_order_lines_all     oola
                        , apps.hz_cust_acct_sites_all hcas
                        , apps.hz_cust_site_uses_all  hcsu
                        , apps.hz_locations           hzl
                    WHERE oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                      AND oola.end_customer_site_use_id  = hcsu.site_use_id
                      AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                      AND hcas.cust_account_id           = hca.cust_account_id
                      AND hcas.party_site_id             = hps.party_site_id
                      AND hca.party_id                   = hp.party_id
                      AND hps.party_id                   = hp.party_id
                      AND hps.location_id                = hzl.location_id)
                ELSE
                   CASE WHEN (mmt.source_code = '3PL_REMITTANCE_BRAZIL') THEN
                      (SELECT listagg(hzl.address1 ||' - '|| hzl.address2 || ' - ' || hzl.city || '-' || hzl.state || ' / ' || hzl.postal_code,', ' ON OVERFLOW TRUNCATE)  
                       WITHIN GROUP (ORDER BY hzl.address1 asc)
                         FROM apps.ra_customer_trx_all     rcta
                            , apps.hz_cust_acct_sites_all  hcas
                            , apps.hz_cust_site_uses_all   hcsu
                            , apps.hz_parties              hp
                            , apps.hz_party_sites          hps
                            , apps.hz_cust_accounts        hca
                            , apps.hz_locations            hzl
                        WHERE rcta.interface_header_attribute1 = mp.organization_code||'_'||mmt.transaction_reference
                          AND rcta.ship_to_site_use_id         = hcsu.site_use_id
                          AND hcsu.cust_acct_site_id           = hcas.cust_acct_site_id
                          AND hcas.cust_account_id             = hca.cust_account_id
                          AND hcas.party_site_id               = hps.party_site_id
                          AND hca.party_id                     = hp.party_id
                          AND hps.party_id                     = hp.party_id
                          AND hps.location_id                  = hzl.location_id
                          AND rcta.org_id                      = 4330)
                   ELSE
                      (SELECT listagg(hzl.address1 ||' - '|| hzl.address2 || ' - ' || hzl.city || '-' || hzl.state || ' / ' || hzl.postal_code,', ' ON OVERFLOW TRUNCATE)  
                       WITHIN GROUP (ORDER BY hzl.address1 asc)
                          FROM apps.hz_parties             hp
                             , apps.hz_party_sites         hps
                             , apps.hz_cust_accounts       hca
                             , apps.oe_order_lines_all     oola
                             , apps.hz_cust_acct_sites_all hcas
                             , apps.hz_cust_site_uses_all  hcsu
                             , apps.hz_locations           hzl
                         WHERE oola.line_id                = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                           AND oola.ship_to_org_id         = hcsu.site_use_id
                           AND hcsu.cust_acct_site_id      = hcas.cust_acct_site_id
                           AND hcas.cust_account_id        = hca.cust_account_id
                           AND hcas.party_site_id          = hps.party_site_id
                           AND hca.party_id                = hp.party_id
                           AND hps.party_id                = hp.party_id
                           AND hps.location_id             = hzl.location_id   )
                   END
                END customer_address
                -- 
                -- alterado para BIll_to por Sinval fim
                -- 
              , CASE WHEN (mmt.source_code = '3PL_REMITTANCE_BRAZIL') THEN
                   (SELECT listagg(rcta.trx_number,', ' ON OVERFLOW TRUNCATE)  
                           WITHIN GROUP (ORDER BY rcta.trx_number asc)
                      FROM apps.ra_customer_trx_all       rcta
                     WHERE rcta.interface_header_attribute1  = mp.organization_code||'_'||mmt.transaction_reference
                       AND rcta.org_id                       = 4330
                       AND NVL(rcta.status_trx,'XX')         <> 'VD'
                       AND NVL(rcta.reason_code,'XX')        <> 'CANCELLATION')
                ELSE
                   (SELECT distinct RTRIM(REGEXP_REPLACE((listagg(rcta.trx_number,', ' ON OVERFLOW TRUNCATE)  
                      WITHIN GROUP (ORDER BY rcta.trx_number asc) ), '([^,]*)(,\1)+($|,)', '\1\3'),',')
                      FROM apps.ra_customer_trx_lines_all rctla
                         , apps.ra_customer_trx_all       rcta
                         , apps.oe_order_lines_all        oola
                         , apps.oe_order_headers_all      ooha
                     WHERE rcta.customer_trx_id              = rctla.customer_trx_id
                       AND oola.line_id                      = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                       AND oola.header_id                    = ooha.header_id
                       AND rctla.sales_order                 = to_char(ooha.order_number)
                       AND rctla.line_type                   = 'LINE'
                       AND rcta.batch_source_id              <> 6266 -- No RR invoices
                       AND DECODE(rctla.interface_line_context,'GEMS_PB_RR',rcta.interface_header_attribute11,'999')
                           = DECODE(rctla.interface_line_context,'GEMS_PB_RR',rcta.interface_header_attribute11,'999')
                       AND rcta.org_id                       = 4330
                       AND trunc(rcta.trx_date)              BETWEEN (trunc(mmt.transaction_date)-3) AND (trunc(mmt.transaction_date)+3)
                       AND NVL(rcta.status_trx,'XX')         <> 'VD'
                       AND NVL(rcta.reason_code,'XX')        <> 'CANCELLATION')
                END   invoice_number_ar
              , ( SELECT listagg(mrav.reservation_quantity,', ' ON OVERFLOW TRUNCATE)  
                  WITHIN GROUP (ORDER BY mrav.reservation_quantity asc) 
                    FROM apps.mtl_reservations_all_v  mrav 
                       , apps.oe_order_headers_all    ooha1
                   WHERE mrav.demand_source_header_id     = ooha1.header_id
                     AND mrav.demand_source_line_id       = NVL(mmt.trx_source_line_id, mmt.source_line_id) )  reservation_quantity
              , ( SELECT listagg(ooha1.order_number,', ' ON OVERFLOW TRUNCATE)  
                  WITHIN GROUP (ORDER BY ooha1.order_number asc) 
                    FROM apps.mtl_reservations_all_v  mrav 
                       , apps.oe_order_headers_all    ooha1
                   WHERE mrav.demand_source_header_id     = ooha1.header_id
                     AND mrav.demand_source_line_id       = NVL(mmt.trx_source_line_id, mmt.source_line_id) )  reservation_order_number
              , (SELECT distinct hp.party_name
                 --WITHIN GROUP (ORDER BY hp.party_name asc)
                   FROM apps.hz_parties              hp
                      , apps.hz_cust_accounts        hca
                      , apps.oe_order_lines_all      oola1
                      , apps.oe_order_headers_all    ooha1
                      , apps.mtl_reservations_all_v  mrav 
                  WHERE mrav.demand_source_header_id   = ooha1.header_id
                    AND mrav.demand_source_line_id     = oola1.line_id
                    AND oola1.line_id                  = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                    AND oola1.ship_to_org_id           = hca.cust_account_id
                    AND hca.party_id                   = hp.party_id )         reservation_customer_name
              , gcc1.concatenated_segments   material_account
              , gcc2.concatenated_segments   outside_processing_account
              , gcc3.concatenated_segments   material_overhead_account
              , gcc4.concatenated_segments   overhead_account
              , gcc5.concatenated_segments   resource_account
              , sysdate                                           report_date_and_time 
              , to_char(mmt.transaction_id)  transaction_id
              , fu.user_name ||' / '|| fu.description                                    user_name
              , DECODE( lot_control_code, 1 ,'Sem controle de Lote' , 2,'Com controle de Lote')   lot_control
              , DECODE( serial_number_control_code, 1, 'Sem controle de Serial'
                                                  , 2, 'Pre-definido'
                                                  , 5, 'No Recebimento'
                                                  , 6, 'Baixa na Ordem de Venda' )  serial_control
              , CASE
                 WHEN    nvl(mmt.lpn_id, mmt.content_lpn_id) IS NULL AND moq.subinventory_code <> 'WHGU42GNAT'
                   THEN 
                    (SELECT listagg(lpn.license_plate_number,', ' ON OVERFLOW TRUNCATE)WITHIN GROUP (ORDER BY lpn.license_plate_number asc)
                             FROM apps.MTL_MATERIAL_TRANSACTIONS   mtt,
                                  apps.wms_license_plate_numbers   lpn,
                                  apps.oe_order_lines_all          ool
                            WHERE 1 = 1
                              AND mtt.TRX_SOURCE_LINE_ID = CASE
                                                              WHEN LINE_CATEGORY_CODE = 'ORDER'
                                                                THEN ool.line_id
                                                              WHEN LINE_CATEGORY_CODE = 'RETURN'  
                                                                THEN   
                                                                to_number(NVL(SUBSTR(ool.ORIG_SYS_LINE_REF,
                                                                                     0,
                                                                                     INSTR(ool.ORIG_SYS_LINE_REF, '.') - 1),
                                                                              -1)) -- RMA FE OE Line Id
                                                                ELSE -1
                                                                  END
                              AND mtt.TRANSACTION_TYPE_ID = 52 --sales order pick FE ORDER
                              AND mtt.transaction_quantity < 0
                              AND mtt.inventory_item_id = ool.inventory_item_id
                              AND nvl(mtt.lpn_id, mtt.content_lpn_id) = nvl(lpn.lpn_id, -1)
                              AND ool.line_id = CASE
                                                  WHEN mtt.transaction_type_name = 'RMA Receipt'
                                                    THEN mmt.TRX_SOURCE_LINE_ID
                                                  WHEN mtt.transaction_type_name = 'GPO Nationalization Receipt'
                                                     THEN 
                                                      to_number(NVL(SUBSTR(RTRIM(LTRIM(translate(mmt.TRANSACTION_REFERENCE,translate(mmt.TRANSACTION_REFERENCE||'a','1234567890.',' '),' '))),
                                                         0,
                                                         INSTR(RTRIM(LTRIM(translate(mmt.TRANSACTION_REFERENCE,translate(mmt.TRANSACTION_REFERENCE||'a','1234567890.',' '),' '))), '.') - 1),
                                                  -1))
                                                  ELSE -1
                                                    END)
                              WHEN moq.subinventory_code = 'WHGU42GNAT'
                  THEN (SELECT listagg(wlp.license_plate_number,', ' ON OVERFLOW TRUNCATE)  
                            WITHIN GROUP (ORDER BY wlp.license_plate_number asc)
                        FROM   gems_ont.ge_gpo_nationalization_line gnl, 
                               gems_ont.ge_gpo_nationalization_line gn2,
                               apps.wms_license_plate_numbers       wlp,
                               apps.po_line_locations_all           pll,
                               apps.po_lines_all                    pol,
                               apps.po_headers_all                  poh,
                               apps.rcv_shipment_headers            rsh,
                               apps.rcv_transactions                rt
                        Where  wlp.lpn_id(+) = gn2.lpn_id
                        AND gnl.nationalization_so_line_id = gn2.nationalization_so_line_id
                        AND pll.line_location_id = gnl.DOCUMENT_ID
                        AND pll.po_header_id = poh.po_header_id
                        AND pll.po_line_id = pol.po_line_id
                        AND gn2.record_type = 'IMPORT'
                        AND gnl.record_type = 'NATIONALIZATION'
                        AND rt.transaction_id                = mmt.rcv_transaction_id
                        AND rt.po_line_location_id           = pll.line_location_id
                        AND rt.shipment_header_id            = rsh.shipment_header_id)
                 ELSE (SELECT lpn.LICENSE_PLATE_NUMBER
                           FROM   apps.wms_license_plate_numbers   lpn
                           WHERE  nvl(mmt.lpn_id, mmt.content_lpn_id) = nvl(lpn.lpn_id, -1))
                        END LPN_Value                                   
              , 'q8' query
--, mmt.transaction_type_id
--, mmt.trx_source_line_id
--, mmt.source_line_id
           FROM apps.mtl_parameters                  mp
              , apps.mtl_system_items_b              msi
              , apps.mtl_secondary_inventories_fk_v  msifv
              , apps.gl_code_combinations            gcc
              , apps.gl_code_combinations_kfv        gcc1
              , apps.gl_code_combinations_kfv        gcc2
              , apps.gl_code_combinations_kfv        gcc3
              , apps.gl_code_combinations_kfv        gcc4
              , apps.gl_code_combinations_kfv        gcc5
              --, apps.mtl_item_locations_kfv          milk
              , AMARCHIVE.MTL_MATERIAL_TRANSACTIONS       mmt
              , apps.mtl_transaction_types           mtt
              , apps.mtl_txn_source_types            mtst
              , apps.fnd_flex_values_vl              ffvv
              , apps.fnd_flex_value_sets             ffvs
              , apps.fnd_user                        fu
              , ( SELECT organization_id
                       , inventory_item_id
                       , subinventory_code
                       , locator_id
                       , lot_number
                       --, transaction_uom_code
                       , create_transaction_id
                       , SUM (primary_transaction_quantity) onhand_qty
                    FROM apps.mtl_onhand_quantities_detail
                   WHERE organization_id IN (SELECT ood.organization_id FROM apps.org_organization_definitions ood WHERE ood.set_of_books_id = 230 )
                   GROUP BY organization_id
                          , inventory_item_id
                          , subinventory_code
                          , locator_id
                        --  , revision
                          , lot_number
                          --, transaction_uom_code
                          , create_transaction_id ) moq
                          ,APPS.MTL_PAC_ACTUAL_COST_DETAILS MPACD 
          WHERE 1                                = 1
          AND decode(mmt.periodic_primary_quantity,null,mmt.transfer_transaction_id,MMT.TRANSACTION_ID) = MPACD.TRANSACTION_ID  
            AND mp.organization_id               = msi.organization_id
--            AND msi.segment1 = '60510302'
            AND msifv.organization_id            = msi.organization_id
            AND msifv.secondary_inventory_name   = moq.subinventory_code
            AND msifv.material_account           = gcc1.code_combination_id
            AND msifv.outside_processing_account = gcc2.code_combination_id
            AND msifv.material_overhead_account  = gcc3.code_combination_id
            AND msifv.overhead_account           = gcc4.code_combination_id
            AND msifv.resource_account           = gcc5.code_combination_id
            AND msi.cost_of_sales_account       = gcc.code_combination_id
            AND ffvs.flex_value_set_name        = 'GE_GL_AFF_ES_PRODUCT_LINE'
            AND ffvs.flex_value_set_id          = ffvv.flex_value_set_id
            AND ffvv.flex_value_meaning         = gcc.segment8
            AND 'TYPE 1'                        IN ('TYPE 1')
            AND msi.organization_id             IN (SELECT ood.organization_id FROM apps.org_organization_definitions ood WHERE ood.set_of_books_id = 230 )
            AND moq.inventory_item_id           = msi.inventory_item_id
            AND moq.organization_id             = msi.organization_id
            --AND moq.locator_id                  = milk.inventory_location_id
            AND moq.create_transaction_id       = mmt.transaction_id
--    AND MMT.TRANSACTION_ID = 2562828197
            AND mtt.transaction_type_id         = mmt.transaction_type_id 
            AND mtst.transaction_source_type_id = mmt.transaction_source_type_id
            AND msi.serial_number_control_code  = '1' 
            AND msi.lot_control_code            = '1'
            AND moq.locator_id                  IS NULL
            AND fu.user_id                      = mmt.created_by 
    AND MMT.TRANSACTION_ID NOT IN(SELECT MMT2.TRANSACTION_ID 
                                  FROM APPS.MTL_MATERIAL_TRANSACTIONS MMT2
                                  WHERE MMT2.TRANSACTION_ID = MMT.TRANSACTION_ID)
------------------------------------------------------------------------------
UNION  
------------------------------------------------------------------------------  
-- Sem Controle de Serial e Com Controle de Lote e sem Locator
         SELECT DISTINCT  --'9' NUM
        /* ( SELECT ccg.cost_group 
                             FROM apps.cst_cost_groups            ccg
                                , apps.cst_cost_group_assignments ccga
                            WHERE ccga.cost_group_id     = ccg.cost_group_id
                              AND ccga.organization_id   = mp.organization_id )  cost_group*/
            ( SELECT ccg.cost_group 
                             FROM apps.cst_cost_groups            ccg
                            WHERE MPACD.cost_group_id     = ccg.cost_group_id )  cost_group  
              , ( SELECT ( SELECT cpp1.period_name 
                             FROM apps.cst_pac_item_costs   cst
                                , apps.cst_pac_periods      cpp1
                            WHERE cst.pac_period_id     = (SELECT MAX(PAC_PERIOD_ID)                   FROM APPS.CST_PAC_PERIODS                  WHERE LEGAL_ENTITY = (SELECT LEGAL_ENTITY                                          FROM APPS.ORG_ORGANIZATION_DEFINITIONS OOD                                         WHERE OOD.ORGANIZATION_ID = mp.organization_id                                         ) )
                              AND cst.pac_period_id     = cpp1.pac_period_id
                              AND cst.inventory_item_id = msi.inventory_item_id
                              AND cst.cost_group_id     = ccg.cost_group_id )  
                    FROM apps.cst_cost_groups            ccg
                       , apps.cst_cost_group_assignments ccga
                   WHERE ccga.cost_group_id     = ccg.cost_group_id
                     AND ccga.organization_id   = mp.organization_id ) period_name
              , mp.organization_code
              , mp.attribute7                organization_type
              , mp.organization_id 
              , moq.subinventory_code
              , msifv.description            subinv_description
              , NULL   locators
              , DECODE( msifv.asset_inventory, 1 , 'Asset', 2, 'Non Asset')   asset_type
              , msi.segment1                 part_number
              , DECODE(msi.inventory_asset_flag, NULL, 'No', 'N', 'No', 'Y', 'Yes')                         flag_asset_inventory
              , DECODE(msi.costing_enabled_flag, NULL, 'No', 'N', 'No', 'Y', 'Yes')                         flag_de_custo
              , msi.description              descrip_eng
              , msi.attribute3               descrip_ptb
              , msi.creation_date            item_creation_date
              , (trunc(SYSDATE) - trunc(msi.creation_date))      days_from_creation
              , gcc.segment8                                     product_line
              , ffvv.description                                 desc_prod_line   
              , msi.primary_uom_code    uom
              , moq.onhand_qty                                   transaction_quantity
              , NVL(( SELECT cic.item_cost
                        FROM apps.cst_item_costs cic
                       WHERE cic.organization_id   = msi.organization_id
                         AND cic.inventory_item_id = msi.inventory_item_id
                         AND cic.cost_type_id      = 1 ),0)  custo_unit_inv
              /*, nvl(( SELECT ( SELECT ROUND (cst.item_cost,2) 
                                 FROM apps.cst_pac_item_costs   cst
                                WHERE cst.pac_period_id     = (SELECT MAX(PAC_PERIOD_ID)                   FROM APPS.CST_PAC_PERIODS                  WHERE LEGAL_ENTITY = (SELECT LEGAL_ENTITY                                          FROM APPS.ORG_ORGANIZATION_DEFINITIONS OOD                                         WHERE OOD.ORGANIZATION_ID = mp.organization_id                                         ) )
                                  AND cst.inventory_item_id = msi.inventory_item_id
                                  AND cst.cost_group_id     = ccg.cost_group_id )  item_cost
                        FROM apps.cst_cost_groups            ccg
                           , apps.cst_cost_group_assignments ccga
                       WHERE ccga.cost_group_id     = ccg.cost_group_id
                         AND ccga.organization_id   = mp.organization_id ) ,0) custo_unit_pac*/
                , nvl((SELECT ROUND (cst.item_cost,2) 
                       FROM apps.cst_pac_item_costs   cst
                      WHERE cst.pac_period_id     = (SELECT MAX(PAC_PERIOD_ID)                   
                                                                FROM APPS.CST_PAC_PERIODS                  
                                                                WHERE LEGAL_ENTITY = (SELECT LEGAL_ENTITY                                         
                                                                                        FROM APPS.ORG_ORGANIZATION_DEFINITIONS OOD                                        
                                                                                        WHERE OOD.ORGANIZATION_ID = mp.organization_id
                                                        ) )
                        AND cst.inventory_item_id = msi.inventory_item_id
                        AND cst.cost_group_id     = MPACD.cost_group_id) ,0)  custo_unit_pac
              , moq.lot_number
              , ( SELECT mln.creation_date        
                    FROM apps.mtl_lot_numbers              mln
                   WHERE mln.lot_number           = moq.lot_number
                     AND mln.inventory_item_id    = msi.inventory_item_id
                     AND mln.organization_id      = mp.organization_id  )  lot_creation_date
              , NULL   lot_qty_days_creation
              , ( SELECT mln.expiration_date         
                    FROM apps.mtl_lot_numbers              mln
                   WHERE mln.lot_number           = moq.lot_number
                     AND mln.inventory_item_id    = msi.inventory_item_id
                     AND mln.organization_id      = mp.organization_id  )  lot_expiration_date
              , NULL  serial_number
              , NULL  serial_creation_date
              , mtt.transaction_type_name           last_transaction_type
              , mmt.transaction_source_name         last_transaction_source
              , mtst.transaction_source_type_name   last_source_type
              , mmt.source_code
              , TO_CHAR(mmt.transaction_date, 'DD-MON-RRRR')      transaction_date
        , (SELECT TO_CHAR(mmt1.transaction_date, 'DD-MON-RRRR') 
          FROM apps.mtl_material_transactions mmt1
          WHERE mmt1.transaction_type_id=420
          AND mmt1.source_line_id=mmt.source_line_id) initial_consignment_date          
              , (TRUNC ( SYSDATE )- TRUNC(mmt.transaction_date))  transaction_qty_of_days
              , TO_CHAR(mmt.transaction_reference)                transaction_reference
              , CASE WHEN mmt.source_code = '3PL_REMITTANCE_BRAZIL' THEN
                     (SELECT listagg(pha.segment1,', ' ON OVERFLOW TRUNCATE)  
                      WITHIN GROUP (ORDER BY pha.segment1 asc)
                        FROM apps.po_headers_all        pha,
                             apps.po_lines_all          pla
                       WHERE pla.po_line_id   = mmt.source_line_id
                         AND pla.po_header_id = pha.po_header_id)
                     WHEN mmt.source_code IN ('ORDER ENTRY','IIP') THEN
                        NULL
                     WHEN mmt.source_code = 'RCV' THEN
                        ( SELECT listagg(pha.segment1,', ' ON OVERFLOW TRUNCATE)  
                          WITHIN GROUP (ORDER BY pha.segment1 asc)
                            FROM apps.po_headers_all            pha
                               , apps.po_lines_all              pla
                               , apps.po_line_locations_all     plla
                               , apps.rcv_shipment_headers      rsh
                               , apps.rcv_transactions          rt
                           WHERE rt.transaction_id                = mmt.rcv_transaction_id
                             AND rt.po_line_location_id           = plla.line_location_id
                             AND plla.po_line_id                  = pla.po_line_id
                             AND pha.po_header_id                 = pla.po_header_id
                             AND rt.shipment_header_id            = rsh.shipment_header_id
                             AND rsh.receipt_source_code          = 'VENDOR'  )
                     ELSE
                        NULL
                END      po_number
              , CASE WHEN mmt.source_code = '3PL_REMITTANCE_BRAZIL' THEN
                     (SELECT listagg(aps.vendor_name,', ' ON OVERFLOW TRUNCATE)  
                      WITHIN GROUP (ORDER BY aps.vendor_name asc)
                        FROM apps.po_headers_all        pha
                           , apps.po_lines_all          pla
                           , apps.ap_suppliers          aps
                           , apps.ap_supplier_sites_all  apss
                       WHERE pla.po_line_id     = mmt.source_line_id
                         AND pla.po_header_id   = pha.po_header_id
                         AND pha.vendor_id      = aps.vendor_id
                         AND aps.vendor_id      = apss.vendor_id
                         AND pha.vendor_site_id = apss.vendor_site_id )
                     WHEN mmt.source_code IN ('ORDER ENTRY','IIP') THEN
                        NULL
                     WHEN mmt.source_code = 'RCV' THEN
                        ( SELECT listagg(aps.vendor_name,', ' ON OVERFLOW TRUNCATE)  
                          WITHIN GROUP (ORDER BY aps.vendor_name asc)
                            FROM apps.po_headers_all            pha
                               , apps.po_lines_all              pla
                               , apps.po_line_locations_all     plla
                               , apps.rcv_shipment_headers      rsh
                               , apps.rcv_transactions          rt
                               , apps.ap_suppliers              aps
                               , apps.ap_supplier_sites_all     apss
                           WHERE rt.transaction_id          = mmt.rcv_transaction_id
                             AND rt.po_line_location_id     = plla.line_location_id
                             AND plla.po_line_id            = pla.po_line_id
                             AND pha.po_header_id           = pla.po_header_id
                             AND rt.shipment_header_id      = rsh.shipment_header_id
                             AND rsh.receipt_source_code    = 'VENDOR'
                             AND pha.vendor_id              = aps.vendor_id
                             AND aps.vendor_id              = apss.vendor_id
                             AND pha.vendor_site_id         = apss.vendor_site_id  )
                     ELSE
                        NULL
                END     po_supplier
              , CASE WHEN mmt.source_code = '3PL_REMITTANCE_BRAZIL' THEN
                     ( SELECT listagg(cfi.invoice_num,', ' ON OVERFLOW TRUNCATE)  
                         WITHIN GROUP (ORDER BY cfi.invoice_num asc)
                         FROM apps.cll_f189_invoice_lines cfil
                            , apps.cll_f189_invoices      cfi
                            , apps.po_lines_all           pla
                            , apps.po_line_locations_all  plla
                        WHERE plla.po_line_id       = pla.po_line_id
                          AND pla.po_line_id        = mmt.source_line_id
                          AND plla.line_location_id = cfil.line_location_id
                          AND cfil.invoice_id       = cfi.invoice_id )
                     WHEN mmt.source_code IN ('ORDER ENTRY','IIP') THEN
                        NULL
                     WHEN mmt.source_code = 'RCV' THEN
                        ( SELECT listagg(cfi.invoice_num,', ' ON OVERFLOW TRUNCATE)  
                            WITHIN GROUP (ORDER BY cfi.invoice_num asc)
                            FROM apps.po_headers_all            pha
                               , apps.po_lines_all              pla
                               , apps.po_line_locations_all     plla
                               , apps.cll_f189_invoice_lines    cfil
                               , apps.cll_f189_invoices         cfi
                               , apps.rcv_shipment_headers      rsh
                               , apps.rcv_transactions          rt
                           WHERE rt.transaction_id          = mmt.rcv_transaction_id
                             AND rt.po_line_location_id     = plla.line_location_id
                             AND plla.line_location_id      = cfil.line_location_id
                             AND cfil.invoice_id            = cfi.invoice_id
                             AND plla.po_line_id            = pla.po_line_id
                             AND pha.po_header_id           = pla.po_header_id
                             AND rt.shipment_header_id      = rsh.shipment_header_id
                             AND rsh.receipt_source_code    = 'VENDOR'   )
                     ELSE
                        NULL
                END    NF_RI
             , (SELECT DECODE( mmt.source_code, '3PL_REMITTANCE_BRAZIL',NULL,to_char(ooha.order_number) )
                  FROM apps.oe_order_headers_all  ooha,
                       apps.oe_order_lines_all    oola  
                 WHERE oola.line_id        = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                   AND oola.header_id      = ooha.header_id )   order_number
               -- 
               -- alterado para BIll_to por Sinval inicio
               --
               , CASE WHEN ( SELECT ottl.name
                             FROM apps.oe_transaction_types_tl    ottl
                                , apps.oe_order_headers_all  ooha
                                , apps.oe_order_lines_all    oola  
                            WHERE oola.line_id        = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND oola.header_id      = ooha.header_id
                              AND ooha.order_type_id  = ottl.transaction_type_id  ) = 'GPO_BR_FE_SHIPMENT' THEN
                     (SELECT listagg(hp.party_name,', ' ON OVERFLOW TRUNCATE)  
                      WITHIN GROUP (ORDER BY hp.party_name asc)
                        FROM apps.hz_parties             hp
                           , apps.hz_cust_accounts       hca
                           , apps.oe_order_lines_all     oola
                           , apps.hz_cust_acct_sites_all hcas
                           , apps.hz_cust_site_uses_all  hcsu
                       WHERE oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                         AND oola.end_customer_site_use_id  = hcsu.site_use_id
                         AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                         AND hcas.cust_account_id           = hca.cust_account_id
                         AND hca.party_id                   = hp.party_id )
                  ELSE
                     CASE WHEN (mmt.source_code = '3PL_REMITTANCE_BRAZIL') THEN
                       (SELECT listagg(hp.party_name,', ' ON OVERFLOW TRUNCATE)  
                        WITHIN GROUP (ORDER BY hp.party_name asc)
                          FROM apps.hz_parties             hp,
                               apps.hz_cust_accounts       hca,
                               apps.ra_customer_trx_all    rcta,
                               apps.hz_cust_acct_sites_all hcas,
                               apps.hz_cust_site_uses_all  hcsu
                         WHERE rcta.interface_header_attribute1 = mp.organization_code||'_'||mmt.transaction_reference
                           AND rcta.ship_to_site_use_id         = hcsu.site_use_id
                           AND hcsu.cust_acct_site_id           = hcas.cust_acct_site_id
                           AND hcas.cust_account_id             = hca.cust_account_id
                           AND hca.party_id                     = hp.party_id
                           AND rcta.org_id                      = 4330)
                     ELSE
                        (SELECT listagg(hp.party_name,', ' ON OVERFLOW TRUNCATE)  
                         WITHIN GROUP (ORDER BY hp.party_name asc)
                           FROM apps.hz_parties             hp
                              , apps.hz_cust_accounts       hca
                              , apps.oe_order_lines_all     oola
                              , apps.hz_cust_acct_sites_all hcas
                              , apps.hz_cust_site_uses_all  hcsu
                          WHERE oola.line_id                = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                            AND oola.ship_to_org_id         = hcsu.site_use_id
                            AND hcsu.cust_acct_site_id      = hcas.cust_acct_site_id
                            AND hcas.cust_account_id        = hca.cust_account_id
                            AND hca.party_id                = hp.party_id )
                    END                 
               END    customer_name
             , CASE WHEN ( SELECT ottl.name
                             FROM apps.oe_transaction_types_tl    ottl
                                , apps.oe_order_headers_all  ooha
                                , apps.oe_order_lines_all    oola  
                            WHERE oola.line_id        = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND oola.header_id      = ooha.header_id
                              AND ooha.order_type_id  = ottl.transaction_type_id  ) = 'GPO_BR_FE_SHIPMENT' THEN
                     (SELECT listagg(hca.account_number,', ' ON OVERFLOW TRUNCATE)  
                      WITHIN GROUP (ORDER BY hca.account_number asc)
                        FROM apps.hz_parties             hp
                           , apps.hz_cust_accounts       hca
                           , apps.oe_order_lines_all     oola
                           , apps.hz_cust_acct_sites_all hcas
                           , apps.hz_cust_site_uses_all  hcsu
                       WHERE oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                         AND oola.end_customer_site_use_id  = hcsu.site_use_id
                         AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                         AND hcas.cust_account_id           = hca.cust_account_id
                         AND hca.party_id                   = hp.party_id )
                  ELSE
                     CASE WHEN (mmt.source_code = '3PL_REMITTANCE_BRAZIL') THEN
                        (SELECT listagg(hca.account_number,', ' ON OVERFLOW TRUNCATE)  
                         WITHIN GROUP (ORDER BY hca.account_number asc)
                           FROM apps.hz_parties             hp,
                                apps.hz_cust_accounts       hca,
                                apps.ra_customer_trx_all    rcta,
                                apps.hz_cust_acct_sites_all hcas,
                                apps.hz_cust_site_uses_all  hcsu
                          WHERE rcta.interface_header_attribute1 = mp.organization_code||'_'||mmt.transaction_reference
                            AND rcta.ship_to_site_use_id         = hcsu.site_use_id
                            AND hcsu.cust_acct_site_id           = hcas.cust_acct_site_id
                            AND hcas.cust_account_id             = hca.cust_account_id
                            AND hca.party_id                     = hp.party_id
                            AND rcta.org_id                      = 4330)
                     ELSE
                        (SELECT listagg(hca.account_number,', ' ON OVERFLOW TRUNCATE)  
                         WITHIN GROUP (ORDER BY hca.account_number asc)
                           FROM apps.hz_parties             hp
                              , apps.hz_cust_accounts       hca
                              , apps.oe_order_lines_all     oola
                              , apps.hz_cust_acct_sites_all hcas
                              , apps.hz_cust_site_uses_all  hcsu
                          WHERE oola.line_id                = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                            AND oola.ship_to_org_id         = hcsu.site_use_id
                            AND hcsu.cust_acct_site_id      = hcas.cust_acct_site_id
                            AND hcas.cust_account_id        = hca.cust_account_id
                            AND hca.party_id                = hp.party_id   )
                     END
                  END   customer_number
              --
              , CASE WHEN ( SELECT ottl.name
                             FROM apps.oe_transaction_types_tl    ottl
                                , apps.oe_order_headers_all  ooha
                                , apps.oe_order_lines_all    oola  
                            WHERE oola.line_id        = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND oola.header_id      = ooha.header_id
                              AND ooha.order_type_id  = ottl.transaction_type_id  ) = 'GPO_BR_FE_SHIPMENT' THEN
                     (SELECT listagg(DECODE(hcas.global_attribute2
                                           , '2',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'/'|| hcas.global_attribute4 ||'-'|| hcas.global_attribute5
                                           , '1',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'-'|| hcas.global_attribute5 
                                           , '3',HCSU.LOCATION||' - '||hcas.global_attribute3 ),', ' ON OVERFLOW TRUNCATE)
                     WITHIN GROUP (ORDER BY hcas.global_attribute2 asc ) 
                        FROM apps.hz_parties             hp
                           , apps.hz_cust_accounts       hca
                           , apps.oe_order_lines_all     oola
                           , apps.hz_cust_acct_sites_all hcas
                           , apps.hz_cust_site_uses_all  hcsu
                       WHERE oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                         AND oola.end_customer_site_use_id  = hcsu.site_use_id
                         AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                         AND hcas.cust_account_id           = hca.cust_account_id
                         AND hca.party_id                   = hp.party_id )
                ELSE
                   CASE WHEN (mmt.source_code = '3PL_REMITTANCE_BRAZIL') THEN
                      (SELECT listagg(DECODE(hcas.global_attribute2
                                           , '2',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'/'|| hcas.global_attribute4 ||'-'|| hcas.global_attribute5
                                           , '1',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'-'|| hcas.global_attribute5 
                                           , '3',HCSU.LOCATION||' - '||hcas.global_attribute3 ),', ' ON OVERFLOW TRUNCATE)
                     WITHIN GROUP (ORDER BY hcas.global_attribute2 asc) 
                         FROM apps.ra_customer_trx_all     rcta
                            , apps.hz_cust_acct_sites_all  hcas
                            , apps.hz_cust_site_uses_all   hcsu
                        WHERE rcta.interface_header_attribute1 = mp.organization_code||'_'||mmt.transaction_reference
                          AND rcta.ship_to_site_use_id         = hcsu.site_use_id
                          AND hcsu.cust_acct_site_id           = hcas.cust_acct_site_id
                          AND rcta.org_id                      = 4330)
                   ELSE
                     (SELECT listagg(DECODE(hcas.global_attribute2
                                           , '2',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'/'|| hcas.global_attribute4 ||'-'|| hcas.global_attribute5
                                           , '1',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'-'|| hcas.global_attribute5 
                                           , '3',HCSU.LOCATION||' - '||hcas.global_attribute3 ),', ' ON OVERFLOW TRUNCATE)
                      WITHIN GROUP (ORDER BY hcas.global_attribute2 asc) 
                         FROM apps.hz_parties             hp
                            , apps.hz_cust_accounts       hca
                            , apps.oe_order_lines_all     oola
                            , apps.hz_cust_acct_sites_all hcas
                            , apps.hz_cust_site_uses_all  hcsu
                        WHERE oola.line_id                = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                          AND oola.ship_to_org_id         = hcsu.site_use_id
                          AND hcsu.cust_acct_site_id      = hcas.cust_acct_site_id
                          AND hcas.cust_account_id        = hca.cust_account_id
                          AND hca.party_id                = hp.party_id  )
                   END
                END  customer_cnpj_cpf
               -- 
              , CASE WHEN (mmt.source_code = '3PL_REMITTANCE_BRAZIL') THEN
                      (SELECT listagg(DECODE(hcas.global_attribute2
                                           , '2',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'/'|| hcas.global_attribute4 ||'-'|| hcas.global_attribute5
                                           , '1',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'-'|| hcas.global_attribute5 
                                           , '3',HCSU.LOCATION||' - '||hcas.global_attribute3 ),', ' ON OVERFLOW TRUNCATE)
                       WITHIN GROUP (ORDER BY hcas.global_attribute2 asc )
                         FROM apps.ra_customer_trx_all         rcta
                            , apps.hz_cust_acct_sites_all      hcas
                            , apps.hz_cust_site_uses_all       hcsu
                        WHERE rcta.interface_header_attribute1 = mp.organization_code||'_'||mmt.transaction_reference
                          AND rcta.bill_to_site_use_id         = hcsu.site_use_id
                          AND hcsu.cust_acct_site_id           = hcas.cust_acct_site_id
                          AND rcta.org_id                      = 4330
                          AND ROWNUM = 1)
                   ELSE
                     --
                     CASE WHEN (select DISTINCT RCTL.INTERFACE_LINE_CONTEXT
                             FROM apps.hz_parties                hp
                                , apps.hz_cust_accounts          hca
                                , apps.oe_order_lines_all        oola
                                , apps.oe_order_headers_all      ooha
                                , apps.ra_customer_trx_lines_all rctl
                                , apps.ra_customer_trx_all       rcta
                                , apps.hz_cust_acct_sites_all    hcas
                                , apps.hz_cust_site_uses_all     hcsu
                            WHERE ooha.header_id                 = oola.header_id
                              AND oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND rctl.inventory_item_id         = oola.inventory_item_id
                              AND rctl.line_type                 = 'LINE'
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE1 = to_char(ooha.order_number)
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE6 = to_char(oola.line_id)
                              AND RCTL.INTERFACE_LINE_CONTEXT    = 'ORDER ENTRY'
                              AND rctl.customer_trx_id           = rcta.customer_trx_id
                              AND rcta.bill_to_site_use_id       = hcsu.site_use_id
                              AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                              AND hcas.cust_account_id           = hca.cust_account_id
                              AND hca.party_id                   = hp.party_id 
                              AND ROWNUM = 1) = 'ORDER ENTRY' THEN
                     --
                     (SELECT DISTINCT DECODE(hcas.global_attribute2
                                           , '2',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'/'|| hcas.global_attribute4 ||'-'|| hcas.global_attribute5
                                           , '1',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'-'|| hcas.global_attribute5 
                                           , '3',HCSU.LOCATION||' - '||hcas.global_attribute3)
                             FROM apps.hz_parties                hp
                                , apps.hz_cust_accounts          hca
                                , apps.oe_order_lines_all        oola
                                , apps.oe_order_headers_all      ooha
                                , apps.ra_customer_trx_lines_all rctl
                                , apps.ra_customer_trx_all       rcta
                                , apps.hz_cust_acct_sites_all    hcas
                                , apps.hz_cust_site_uses_all     hcsu
                            WHERE ooha.header_id                 = oola.header_id
                              AND oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND rctl.inventory_item_id         = oola.inventory_item_id
                              AND rctl.line_type                 = 'LINE'
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE1 = to_char(ooha.order_number)
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE6 = to_char(oola.line_id)
                              AND RCTL.INTERFACE_LINE_CONTEXT    = 'ORDER ENTRY'
                              AND rctl.customer_trx_id           = rcta.customer_trx_id
                              AND rcta.bill_to_site_use_id       = hcsu.site_use_id
                              AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                              AND hcas.cust_account_id           = hca.cust_account_id
                              AND hca.party_id                   = hp.party_id
                              AND ROWNUM = 1)
                     --
                     ELSE
                     --            
                     CASE WHEN 
                          ( SELECT DISTINCT RCTL.INTERFACE_LINE_CONTEXT
                             FROM apps.hz_parties                hp
                                , apps.hz_cust_accounts          hca
                                , apps.oe_order_lines_all        oola
                                , apps.oe_order_headers_all      ooha
                                , apps.ra_customer_trx_lines_all rctl
                                , apps.ra_customer_trx_all       rcta
                                , apps.hz_cust_acct_sites_all    hcas
                                , apps.hz_cust_site_uses_all     hcsu
                            WHERE ooha.header_id                 = oola.header_id
                              AND oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND rctl.inventory_item_id         = oola.inventory_item_id
                              AND rctl.line_type                 = 'LINE'
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE1 = ooha.ORIG_SYS_DOCUMENT_REF
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE7 = oola.ORIG_SYS_LINE_REF
                              AND RCTL.INTERFACE_LINE_CONTEXT    = 'GEMS_PB_RR'
                              AND rctl.customer_trx_id           = rcta.customer_trx_id
                              AND rcta.bill_to_site_use_id       = hcsu.site_use_id
                              AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                              AND hcas.cust_account_id           = hca.cust_account_id
                              AND ROWNUM = 1 ) = 'GEMS_PB_RR' THEN
                     --
                     (SELECT DISTINCT DECODE(hcas.global_attribute2
                                           , '2',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'/'|| hcas.global_attribute4 ||'-'|| hcas.global_attribute5
                                           , '1',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'-'|| hcas.global_attribute5 
                                           , '3',HCSU.LOCATION||' - '||hcas.global_attribute3)
                             FROM apps.hz_parties                hp
                                , apps.hz_cust_accounts          hca
                                , apps.oe_order_lines_all        oola
                                , apps.oe_order_headers_all      ooha
                                , apps.ra_customer_trx_lines_all rctl
                                , apps.ra_customer_trx_all       rcta
                                , apps.hz_cust_acct_sites_all    hcas
                                , apps.hz_cust_site_uses_all     hcsu
                            WHERE ooha.header_id                 = oola.header_id
                              AND oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND rctl.inventory_item_id         = oola.inventory_item_id
                              AND rctl.line_type                 = 'LINE'
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE1 = ooha.ORIG_SYS_DOCUMENT_REF
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE7 = oola.ORIG_SYS_LINE_REF
                              AND RCTL.INTERFACE_LINE_CONTEXT    = 'GEMS_PB_RR'
                              AND rctl.customer_trx_id           = rcta.customer_trx_id
                              AND rcta.bill_to_site_use_id       = hcsu.site_use_id
                              AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                              AND hcas.cust_account_id           = hca.cust_account_id 
                              AND ROWNUM = 1 )
                     --
                     ELSE
                     --
                     (SELECT DISTINCT DECODE(hcas.global_attribute2
                                   , '2',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'/'|| hcas.global_attribute4 ||'-'|| hcas.global_attribute5
                                   , '1',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'-'|| hcas.global_attribute5 
                                   , '3',HCSU.LOCATION||' - '||hcas.global_attribute3)
                             --
                      FROM   APPS.HZ_CUST_ACCT_SITES_ALL HCAS,
                             APPS.HZ_CUST_SITE_USES_ALL  HCSU,
                             APPS.OE_ORDER_LINES_ALL     OOLA,
                             APPS.OE_ORDER_HEADERS_ALL   OOHA
                             --
                      WHERE  HCSU.SITE_USE_CODE     = 'BILL_TO'
                      AND    HCSU.CUST_ACCT_SITE_ID = HCAS.CUST_ACCT_SITE_ID
                      AND    HCSU.SITE_USE_ID       = NVL(OOLA.ATTRIBUTE1, OOHA.INVOICE_TO_ORG_ID)
                      AND    OOLA.LINE_ID           = NVL(MMT.TRX_SOURCE_LINE_ID, MMT.SOURCE_LINE_ID)
                      AND    OOHA.HEADER_ID         = OOLA.HEADER_ID
                      AND    ROWNUM = 1)
                     --
                     END
                  END
               END      bill_to_CNPJ_CPF
               --
                             --
              , CASE WHEN (mmt.source_code = '3PL_REMITTANCE_BRAZIL') THEN
                        (SELECT listagg(hp.party_name,', ' ON OVERFLOW TRUNCATE)  
                        WITHIN GROUP (ORDER BY hp.party_name asc)
                          FROM apps.hz_parties             hp,
                               apps.hz_cust_accounts       hca,
                               apps.ra_customer_trx_all    rcta,
                               apps.hz_cust_acct_sites_all hcas,
                               apps.hz_cust_site_uses_all  hcsu
                         WHERE rcta.interface_header_attribute1 = mp.organization_code||'_'||mmt.transaction_reference
                           AND rcta.bill_to_site_use_id         = hcsu.site_use_id
                           AND hcsu.cust_acct_site_id           = hcas.cust_acct_site_id
                           AND hcas.cust_account_id             = hca.cust_account_id
                           AND hca.party_id                     = hp.party_id
                           AND rcta.org_id                      = 4330)
                   ELSE
                     --
                     CASE WHEN (select DISTINCT RCTL.INTERFACE_LINE_CONTEXT
                             FROM apps.hz_parties                hp
                                , apps.hz_cust_accounts          hca
                                , apps.oe_order_lines_all        oola
                                , apps.oe_order_headers_all      ooha
                                , apps.ra_customer_trx_lines_all rctl
                                , apps.ra_customer_trx_all       rcta
                                , apps.hz_cust_acct_sites_all    hcas
                                , apps.hz_cust_site_uses_all     hcsu
                            WHERE ooha.header_id                 = oola.header_id
                              AND oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND rctl.inventory_item_id         = oola.inventory_item_id
                              AND rctl.line_type                 = 'LINE'
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE1 = to_char(ooha.order_number)
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE6 = to_char(oola.line_id)
                              AND RCTL.INTERFACE_LINE_CONTEXT    = 'ORDER ENTRY'
                              AND rctl.customer_trx_id           = rcta.customer_trx_id
                              AND rcta.bill_to_site_use_id       = hcsu.site_use_id
                              AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                              AND hcas.cust_account_id           = hca.cust_account_id
                              AND hca.party_id                   = hp.party_id 
                              AND ROWNUM = 1) = 'ORDER ENTRY' THEN
                     --
                     (SELECT listagg(hp.party_name,', ' ON OVERFLOW TRUNCATE)  
                         WITHIN GROUP (ORDER BY hp.party_name asc)
                             FROM apps.hz_parties                hp
                                , apps.hz_cust_accounts          hca
                                , apps.oe_order_lines_all        oola
                                , apps.oe_order_headers_all      ooha
                                , apps.ra_customer_trx_lines_all rctl
                                , apps.ra_customer_trx_all       rcta
                                , apps.hz_cust_acct_sites_all    hcas
                                , apps.hz_cust_site_uses_all     hcsu
                            WHERE ooha.header_id                 = oola.header_id
                              AND oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND rctl.inventory_item_id         = oola.inventory_item_id
                              AND rctl.line_type                 = 'LINE'
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE1 = to_char(ooha.order_number)
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE6 = to_char(oola.line_id)
                              AND RCTL.INTERFACE_LINE_CONTEXT    = 'ORDER ENTRY'
                              AND rctl.customer_trx_id           = rcta.customer_trx_id
                              AND rcta.bill_to_site_use_id       = hcsu.site_use_id
                              AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                              AND hcas.cust_account_id           = hca.cust_account_id
                              AND hca.party_id                   = hp.party_id
                              AND ROWNUM = 1)
                     --
                     ELSE
                     --            
                     CASE WHEN 
                          ( SELECT DISTINCT RCTL.INTERFACE_LINE_CONTEXT
                             FROM apps.hz_parties                hp
                                , apps.hz_cust_accounts          hca
                                , apps.oe_order_lines_all        oola
                                , apps.oe_order_headers_all      ooha
                                , apps.ra_customer_trx_lines_all rctl
                                , apps.ra_customer_trx_all       rcta
                                , apps.hz_cust_acct_sites_all    hcas
                                , apps.hz_cust_site_uses_all     hcsu
                            WHERE ooha.header_id                 = oola.header_id
                              AND oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND rctl.inventory_item_id         = oola.inventory_item_id
                              AND rctl.line_type                 = 'LINE'
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE1 = ooha.ORIG_SYS_DOCUMENT_REF
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE7 = oola.ORIG_SYS_LINE_REF
                              AND RCTL.INTERFACE_LINE_CONTEXT    = 'GEMS_PB_RR'
                              AND rctl.customer_trx_id           = rcta.customer_trx_id
                              AND rcta.bill_to_site_use_id       = hcsu.site_use_id
                              AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                              AND hcas.cust_account_id           = hca.cust_account_id
                              AND ROWNUM = 1 ) = 'GEMS_PB_RR' THEN
                     --
                     (SELECT listagg(hp.party_name,', ' ON OVERFLOW TRUNCATE)  
                         WITHIN GROUP (ORDER BY hp.party_name asc)
                             FROM apps.hz_parties                hp
                                , apps.hz_cust_accounts          hca
                                , apps.oe_order_lines_all        oola
                                , apps.oe_order_headers_all      ooha
                                , apps.ra_customer_trx_lines_all rctl
                                , apps.ra_customer_trx_all       rcta
                                , apps.hz_cust_acct_sites_all    hcas
                                , apps.hz_cust_site_uses_all     hcsu
                            WHERE ooha.header_id                 = oola.header_id
                              AND oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND rctl.inventory_item_id         = oola.inventory_item_id
                              AND rctl.line_type                 = 'LINE'
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE1 = ooha.ORIG_SYS_DOCUMENT_REF
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE7 = oola.ORIG_SYS_LINE_REF
                              AND RCTL.INTERFACE_LINE_CONTEXT    = 'GEMS_PB_RR'
                              AND rctl.customer_trx_id           = rcta.customer_trx_id
                              AND rcta.bill_to_site_use_id       = hcsu.site_use_id
                              AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                              AND hcas.cust_account_id           = hca.cust_account_id 
                              AND ROWNUM = 1 )
                     --
                     ELSE
                     --
                     (SELECT listagg(hp.party_name,', ' ON OVERFLOW TRUNCATE)  
                         WITHIN GROUP (ORDER BY hp.party_name asc)
                      FROM   APPS.HZ_CUST_ACCT_SITES_ALL HCAS,
                             apps.hz_parties             hp,
                             apps.hz_cust_accounts       hca,
                             APPS.HZ_CUST_SITE_USES_ALL  HCSU,
                             APPS.OE_ORDER_LINES_ALL     OOLA,
                             APPS.OE_ORDER_HEADERS_ALL   OOHA
                            --
                      WHERE  HCSU.SITE_USE_CODE     = 'BILL_TO'
                      AND    HCSU.CUST_ACCT_SITE_ID = HCAS.CUST_ACCT_SITE_ID
                      AND    HCSU.SITE_USE_ID       = NVL(OOLA.ATTRIBUTE1, OOHA.INVOICE_TO_ORG_ID)
                      AND    OOLA.LINE_ID           = NVL(MMT.TRX_SOURCE_LINE_ID, MMT.SOURCE_LINE_ID)
                      AND    OOHA.HEADER_ID         = OOLA.HEADER_ID
                      AND    hcas.cust_account_id   = hca.cust_account_id
                      AND    hca.party_id           = hp.party_id 
                      AND    ROWNUM = 1)
                     --          
                     END
                  END
               END      bill_to_Customer_name
               --
                , CASE WHEN (mmt.source_code = '3PL_REMITTANCE_BRAZIL') THEN
                      (SELECT listagg(DECODE(hcas.global_attribute2
                                           , '2',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'/'|| hcas.global_attribute4 ||'-'|| hcas.global_attribute5
                                           , '1',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'-'|| hcas.global_attribute5 
                                           , '3',HCSU.LOCATION||' - '||hcas.global_attribute3 ),', ' ON OVERFLOW TRUNCATE)
                       WITHIN GROUP (ORDER BY hcas.global_attribute2 asc )
                         FROM apps.ra_customer_trx_all         rcta
                            , apps.hz_cust_acct_sites_all      hcas
                            , apps.hz_cust_site_uses_all       hcsu
                        WHERE rcta.interface_header_attribute1 = mp.organization_code||'_'||mmt.transaction_reference
                          AND rcta.ship_to_site_use_id         = hcsu.site_use_id
                          AND hcsu.cust_acct_site_id           = hcas.cust_acct_site_id
                          AND rcta.org_id                      = 4330
                          AND ROWNUM = 1)
                   ELSE
                     --
                     CASE WHEN (select DISTINCT RCTL.INTERFACE_LINE_CONTEXT
                             FROM apps.hz_parties                hp
                                , apps.hz_cust_accounts          hca
                                , apps.oe_order_lines_all        oola
                                , apps.oe_order_headers_all      ooha
                                , apps.ra_customer_trx_lines_all rctl
                                , apps.ra_customer_trx_all       rcta
                                , apps.hz_cust_acct_sites_all    hcas
                                , apps.hz_cust_site_uses_all     hcsu
                            WHERE ooha.header_id                 = oola.header_id
                              AND oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND rctl.inventory_item_id         = oola.inventory_item_id
                              AND rctl.line_type                 = 'LINE'
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE1 = to_char(ooha.order_number)
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE6 = to_char(oola.line_id)
                              AND RCTL.INTERFACE_LINE_CONTEXT    = 'ORDER ENTRY'
                              AND rctl.customer_trx_id           = rcta.customer_trx_id
                              AND rcta.ship_to_site_use_id       = hcsu.site_use_id
                              AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                              AND hcas.cust_account_id           = hca.cust_account_id
                              AND hca.party_id                   = hp.party_id 
                              AND ROWNUM = 1) = 'ORDER ENTRY' THEN
                     --
                     (SELECT DISTINCT DECODE(hcas.global_attribute2
                                           , '2',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'/'|| hcas.global_attribute4 ||'-'|| hcas.global_attribute5
                                           , '1',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'-'|| hcas.global_attribute5 
                                           , '3',HCSU.LOCATION||' - '||hcas.global_attribute3)
                             FROM apps.hz_parties                hp
                                , apps.hz_cust_accounts          hca
                                , apps.oe_order_lines_all        oola
                                , apps.oe_order_headers_all      ooha
                                , apps.ra_customer_trx_lines_all rctl
                                , apps.ra_customer_trx_all       rcta
                                , apps.hz_cust_acct_sites_all    hcas
                                , apps.hz_cust_site_uses_all     hcsu
                            WHERE ooha.header_id                 = oola.header_id
                              AND oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND rctl.inventory_item_id         = oola.inventory_item_id
                              AND rctl.line_type                 = 'LINE'
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE1 = to_char(ooha.order_number)
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE6 = to_char(oola.line_id)
                              AND RCTL.INTERFACE_LINE_CONTEXT    = 'ORDER ENTRY'
                              AND rctl.customer_trx_id           = rcta.customer_trx_id
                              AND rcta.ship_to_site_use_id       = hcsu.site_use_id
                              AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                              AND hcas.cust_account_id           = hca.cust_account_id
                              AND hca.party_id                   = hp.party_id
                              AND ROWNUM = 1)
                     --
                     ELSE
                     --            
                     CASE WHEN 
                          ( SELECT DISTINCT RCTL.INTERFACE_LINE_CONTEXT
                             FROM apps.hz_parties                hp
                                , apps.hz_cust_accounts          hca
                                , apps.oe_order_lines_all        oola
                                , apps.oe_order_headers_all      ooha
                                , apps.ra_customer_trx_lines_all rctl
                                , apps.ra_customer_trx_all       rcta
                                , apps.hz_cust_acct_sites_all    hcas
                                , apps.hz_cust_site_uses_all     hcsu
                            WHERE ooha.header_id                 = oola.header_id
                              AND oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND rctl.inventory_item_id         = oola.inventory_item_id
                              AND rctl.line_type                 = 'LINE'
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE1 = ooha.ORIG_SYS_DOCUMENT_REF
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE7 = oola.ORIG_SYS_LINE_REF
                              AND RCTL.INTERFACE_LINE_CONTEXT    = 'GEMS_PB_RR'
                              AND rctl.customer_trx_id           = rcta.customer_trx_id
                              AND rcta.ship_to_site_use_id       = hcsu.site_use_id
                              AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                              AND hcas.cust_account_id           = hca.cust_account_id
                              AND ROWNUM = 1 ) = 'GEMS_PB_RR' THEN
                     --
                     (SELECT DISTINCT DECODE(hcas.global_attribute2
                                           , '2',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'/'|| hcas.global_attribute4 ||'-'|| hcas.global_attribute5
                                           , '1',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'-'|| hcas.global_attribute5 
                                           , '3',HCSU.LOCATION||' - '||hcas.global_attribute3)
                             FROM apps.hz_parties                hp
                                , apps.hz_cust_accounts          hca
                                , apps.oe_order_lines_all        oola
                                , apps.oe_order_headers_all      ooha
                                , apps.ra_customer_trx_lines_all rctl
                                , apps.ra_customer_trx_all       rcta
                                , apps.hz_cust_acct_sites_all    hcas
                                , apps.hz_cust_site_uses_all     hcsu
                            WHERE ooha.header_id                 = oola.header_id
                              AND oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND rctl.inventory_item_id         = oola.inventory_item_id
                              AND rctl.line_type                 = 'LINE'
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE1 = ooha.ORIG_SYS_DOCUMENT_REF
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE7 = oola.ORIG_SYS_LINE_REF
                              AND RCTL.INTERFACE_LINE_CONTEXT    = 'GEMS_PB_RR'
                              AND rctl.customer_trx_id           = rcta.customer_trx_id
                              AND rcta.ship_to_site_use_id       = hcsu.site_use_id
                              AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                              AND hcas.cust_account_id           = hca.cust_account_id 
                              AND ROWNUM = 1 )
                     --
                     ELSE
                     --
                     (SELECT listagg(DECODE(hcas.global_attribute2
                                           , '2',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'/'|| hcas.global_attribute4 ||'-'|| hcas.global_attribute5
                                           , '1',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'-'|| hcas.global_attribute5 
                                           , '3',HCSU.LOCATION||' - '||hcas.global_attribute3 ),', ' ON OVERFLOW TRUNCATE)
                     WITHIN GROUP (ORDER BY hcas.global_attribute2 asc) 
                         FROM apps.hz_parties             hp
                            , apps.hz_cust_accounts       hca
                            , apps.oe_order_lines_all     oola
                            , apps.hz_cust_acct_sites_all hcas
                            , apps.hz_cust_site_uses_all  hcsu
                        WHERE oola.line_id                = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                          AND oola.ship_to_org_id         = hcsu.site_use_id
                          AND hcsu.cust_acct_site_id      = hcas.cust_acct_site_id
                          AND hcas.cust_account_id        = hca.cust_account_id
                          AND hca.party_id                = hp.party_id  )
                     --
                     END
                  END
               END      ship_to_CNPJ_CPF
               --
              , CASE WHEN ( SELECT ottl.name
                              FROM apps.oe_transaction_types_tl    ottl
                                 , apps.oe_order_headers_all  ooha
                                 , apps.oe_order_lines_all    oola  
                             WHERE oola.line_id        = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                               AND oola.header_id      = ooha.header_id
                               AND ooha.order_type_id  = ottl.transaction_type_id  ) = 'GPO_BR_FE_SHIPMENT' THEN
                      (SELECT listagg(hzl.address1 ||' - '|| hzl.address2 || ' - ' || hzl.city || '-' || hzl.state || ' / ' || hzl.postal_code,', ' ON OVERFLOW TRUNCATE)  
                       WITHIN GROUP (ORDER BY hzl.address1 asc)
                       FROM apps.hz_parties             hp
                        , apps.hz_party_sites         hps
                        , apps.hz_cust_accounts       hca
                        , apps.oe_order_lines_all     oola
                        , apps.hz_cust_acct_sites_all hcas
                        , apps.hz_cust_site_uses_all  hcsu
                        , apps.hz_locations           hzl
                    WHERE oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                      AND oola.end_customer_site_use_id  = hcsu.site_use_id
                      AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                      AND hcas.cust_account_id           = hca.cust_account_id
                      AND hcas.party_site_id             = hps.party_site_id
                      AND hca.party_id                   = hp.party_id
                      AND hps.party_id                   = hp.party_id
                      AND hps.location_id                = hzl.location_id)
                ELSE
                   CASE WHEN (mmt.source_code = '3PL_REMITTANCE_BRAZIL') THEN
                      (SELECT listagg(hzl.address1 ||' - '|| hzl.address2 || ' - ' || hzl.city || '-' || hzl.state || ' / ' || hzl.postal_code,', ' ON OVERFLOW TRUNCATE)  
                       WITHIN GROUP (ORDER BY hzl.address1 asc)
                         FROM apps.ra_customer_trx_all     rcta
                            , apps.hz_cust_acct_sites_all  hcas
                            , apps.hz_cust_site_uses_all   hcsu
                            , apps.hz_parties              hp
                            , apps.hz_party_sites          hps
                            , apps.hz_cust_accounts        hca
                            , apps.hz_locations            hzl
                        WHERE rcta.interface_header_attribute1 = mp.organization_code||'_'||mmt.transaction_reference
                          AND rcta.ship_to_site_use_id         = hcsu.site_use_id
                          AND hcsu.cust_acct_site_id           = hcas.cust_acct_site_id
                          AND hcas.cust_account_id             = hca.cust_account_id
                          AND hcas.party_site_id               = hps.party_site_id
                          AND hca.party_id                     = hp.party_id
                          AND hps.party_id                     = hp.party_id
                          AND hps.location_id                  = hzl.location_id
                          AND rcta.org_id                      = 4330)
                   ELSE
                      (SELECT listagg(hzl.address1 ||' - '|| hzl.address2 || ' - ' || hzl.city || '-' || hzl.state || ' / ' || hzl.postal_code,', ' ON OVERFLOW TRUNCATE)  
                       WITHIN GROUP (ORDER BY hzl.address1 asc)
                          FROM apps.hz_parties             hp
                             , apps.hz_party_sites         hps
                             , apps.hz_cust_accounts       hca
                             , apps.oe_order_lines_all     oola
                             , apps.hz_cust_acct_sites_all hcas
                             , apps.hz_cust_site_uses_all  hcsu
                             , apps.hz_locations           hzl
                         WHERE oola.line_id                = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                           AND oola.ship_to_org_id         = hcsu.site_use_id
                           AND hcsu.cust_acct_site_id      = hcas.cust_acct_site_id
                           AND hcas.cust_account_id        = hca.cust_account_id
                           AND hcas.party_site_id          = hps.party_site_id
                           AND hca.party_id                = hp.party_id
                           AND hps.party_id                = hp.party_id
                           AND hps.location_id             = hzl.location_id   )
                   END
                END customer_address
                -- 
                -- alterado para BIll_to por Sinval fim
                -- 
              , CASE WHEN (mmt.source_code = '3PL_REMITTANCE_BRAZIL') THEN
                   (SELECT listagg(rcta.trx_number,', ' ON OVERFLOW TRUNCATE)  
                           WITHIN GROUP (ORDER BY rcta.trx_number asc)
                      FROM apps.ra_customer_trx_all       rcta
                     WHERE rcta.interface_header_attribute1  = mp.organization_code||'_'||mmt.transaction_reference
                       AND rcta.org_id                       = 4330
                       AND NVL(rcta.status_trx,'XX')         <> 'VD'
                       AND NVL(rcta.reason_code,'XX')        <> 'CANCELLATION')
                ELSE
                   (SELECT distinct RTRIM(REGEXP_REPLACE((listagg(rcta.trx_number,', ' ON OVERFLOW TRUNCATE)  
                      WITHIN GROUP (ORDER BY rcta.trx_number asc) ), '([^,]*)(,\1)+($|,)', '\1\3'),',')
                      FROM apps.ra_customer_trx_lines_all rctla
                         , apps.ra_customer_trx_all       rcta
                         , apps.oe_order_lines_all        oola
                         , apps.oe_order_headers_all      ooha
                     WHERE rcta.customer_trx_id              = rctla.customer_trx_id
                       AND oola.line_id                      = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                       AND oola.header_id                    = ooha.header_id
                       AND rctla.sales_order                 = to_char(ooha.order_number)
                       AND rctla.line_type                   = 'LINE'
                       AND rcta.batch_source_id              <> 6266 -- No RR invoices
                       AND DECODE(rctla.interface_line_context,'GEMS_PB_RR',rcta.interface_header_attribute11,'999')
                           = DECODE(rctla.interface_line_context,'GEMS_PB_RR',rcta.interface_header_attribute11,'999')
                       AND rcta.org_id                       = 4330
                       AND trunc(rcta.trx_date)              BETWEEN (trunc(mmt.transaction_date)-3) AND (trunc(mmt.transaction_date)+3)
                       AND NVL(rcta.status_trx,'XX')         <> 'VD'
                       AND NVL(rcta.reason_code,'XX')        <> 'CANCELLATION')
                END   invoice_number_ar
              , ( SELECT listagg(mrav.reservation_quantity,', ' ON OVERFLOW TRUNCATE)  
                  WITHIN GROUP (ORDER BY mrav.reservation_quantity asc) 
                    FROM apps.mtl_reservations_all_v  mrav 
                       , apps.oe_order_headers_all    ooha1
                   WHERE mrav.demand_source_header_id     = ooha1.header_id
                     AND mrav.demand_source_line_id       = NVL(mmt.trx_source_line_id, mmt.source_line_id) )  reservation_quantity
              , ( SELECT listagg(ooha1.order_number,', ' ON OVERFLOW TRUNCATE)  
                  WITHIN GROUP (ORDER BY ooha1.order_number asc) 
                    FROM apps.mtl_reservations_all_v  mrav 
                       , apps.oe_order_headers_all    ooha1
                   WHERE mrav.demand_source_header_id     = ooha1.header_id
                     AND mrav.demand_source_line_id       = NVL(mmt.trx_source_line_id, mmt.source_line_id) )  reservation_order_number
              , (SELECT distinct hp.party_name
                 --WITHIN GROUP (ORDER BY hp.party_name asc)
                   FROM apps.hz_parties              hp
                      , apps.hz_cust_accounts        hca
                      , apps.oe_order_lines_all      oola1
                      , apps.oe_order_headers_all    ooha1
                      , apps.mtl_reservations_all_v  mrav 
                  WHERE mrav.demand_source_header_id   = ooha1.header_id
                    AND mrav.demand_source_line_id     = oola1.line_id
                    AND oola1.line_id                  = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                    AND oola1.ship_to_org_id           = hca.cust_account_id
                    AND hca.party_id                   = hp.party_id )         reservation_customer_name
              , gcc1.concatenated_segments   material_account
              , gcc2.concatenated_segments   outside_processing_account
              , gcc3.concatenated_segments   material_overhead_account
              , gcc4.concatenated_segments   overhead_account
              , gcc5.concatenated_segments   resource_account
              , sysdate                                           report_date_and_time 
              , to_char(mmt.transaction_id)  transaction_id
              , fu.user_name ||' / '|| fu.description                                    user_name
              , DECODE( lot_control_code, 1 ,'Sem controle de Lote' , 2,'Com controle de Lote')   lot_control
              , DECODE( serial_number_control_code, 1, 'Sem controle de Serial'
                                                  , 2, 'Pre-definido'
                                                  , 5, 'No Recebimento'
                                                  , 6, 'Baixa na Ordem de Venda' )  serial_control
              , CASE
                 WHEN    nvl(mmt.lpn_id, mmt.content_lpn_id) IS NULL AND moq.subinventory_code <> 'WHGU42GNAT'
                   THEN 
                   (SELECT listagg(lpn.license_plate_number,', ' ON OVERFLOW TRUNCATE)WITHIN GROUP (ORDER BY lpn.license_plate_number asc)
                             FROM apps.MTL_MATERIAL_TRANSACTIONS   mtt,
                                  apps.wms_license_plate_numbers   lpn,
                                  apps.oe_order_lines_all          ool
                            WHERE 1 = 1
                              AND mtt.TRX_SOURCE_LINE_ID = CASE
                                                              WHEN LINE_CATEGORY_CODE = 'ORDER'
                                                                THEN ool.line_id
                                                              WHEN LINE_CATEGORY_CODE = 'RETURN'  
                                                                THEN   
                                                                to_number(NVL(SUBSTR(ool.ORIG_SYS_LINE_REF,
                                                                                     0,
                                                                                     INSTR(ool.ORIG_SYS_LINE_REF, '.') - 1),
                                                                              -1)) -- RMA FE OE Line Id
                                                                ELSE -1
                                                                  END
                              AND mtt.TRANSACTION_TYPE_ID = 52 --sales order pick FE ORDER
                              AND mtt.transaction_quantity < 0
                              AND mtt.inventory_item_id = ool.inventory_item_id
                              AND nvl(mtt.lpn_id, mtt.content_lpn_id) = nvl(lpn.lpn_id, -1)
                              AND ool.line_id = CASE
                                                  WHEN mtt.transaction_type_name = 'RMA Receipt'
                                                    THEN mmt.TRX_SOURCE_LINE_ID
                                                  WHEN mtt.transaction_type_name = 'GPO Nationalization Receipt'
                                                     THEN 
                                                      to_number(NVL(SUBSTR(RTRIM(LTRIM(translate(mmt.TRANSACTION_REFERENCE,translate(mmt.TRANSACTION_REFERENCE||'a','1234567890.',' '),' '))),
                                                         0,
                                                         INSTR(RTRIM(LTRIM(translate(mmt.TRANSACTION_REFERENCE,translate(mmt.TRANSACTION_REFERENCE||'a','1234567890.',' '),' '))), '.') - 1),
                                                  -1))
                                                  ELSE -1
                                                    END)
                              WHEN moq.subinventory_code = 'WHGU42GNAT'
                  THEN (SELECT listagg(wlp.license_plate_number,', ' ON OVERFLOW TRUNCATE)  
                            WITHIN GROUP (ORDER BY wlp.license_plate_number asc)
                        FROM   gems_ont.ge_gpo_nationalization_line gnl, 
                               gems_ont.ge_gpo_nationalization_line gn2,
                               apps.wms_license_plate_numbers       wlp,
                               apps.po_line_locations_all           pll,
                               apps.po_lines_all                    pol,
                               apps.po_headers_all                  poh,
                               apps.rcv_shipment_headers            rsh,
                               apps.rcv_transactions                rt
                        Where  wlp.lpn_id(+) = gn2.lpn_id
                        AND gnl.nationalization_so_line_id = gn2.nationalization_so_line_id
                        AND pll.line_location_id = gnl.DOCUMENT_ID
                        AND pll.po_header_id = poh.po_header_id
                        AND pll.po_line_id = pol.po_line_id
                        AND gn2.record_type = 'IMPORT'
                        AND gnl.record_type = 'NATIONALIZATION'
                        AND rt.transaction_id                = mmt.rcv_transaction_id
                        AND rt.po_line_location_id           = pll.line_location_id
                        AND rt.shipment_header_id            = rsh.shipment_header_id)
                ELSE (SELECT lpn.LICENSE_PLATE_NUMBER
                           FROM   apps.wms_license_plate_numbers   lpn
                           WHERE  nvl(mmt.lpn_id, mmt.content_lpn_id) = nvl(lpn.lpn_id, -1))
                        END LPN_Value                                    
            , 'q9' query
--, mmt.transaction_type_id
--, mmt.trx_source_line_id
--, mmt.source_line_id
           FROM apps.mtl_parameters                  mp
              , apps.mtl_system_items_b              msi
              , apps.mtl_secondary_inventories_fk_v  msifv
              , apps.gl_code_combinations            gcc
              , apps.gl_code_combinations_kfv        gcc1
              , apps.gl_code_combinations_kfv        gcc2
              , apps.gl_code_combinations_kfv        gcc3
              , apps.gl_code_combinations_kfv        gcc4
              , apps.gl_code_combinations_kfv        gcc5
              --, apps.mtl_item_locations_kfv          milk
              , apps.mtl_material_transactions       mmt
              , apps.mtl_transaction_types           mtt
              , apps.mtl_txn_source_types            mtst
              , apps.fnd_flex_values_vl              ffvv
              , apps.fnd_flex_value_sets             ffvs
              , apps.fnd_user                        fu
              , ( SELECT organization_id
                       , inventory_item_id
                       , subinventory_code
                       , locator_id
                       , lot_number
                       --, transaction_uom_code
                       , create_transaction_id
                       , SUM (primary_transaction_quantity) onhand_qty
                    FROM apps.mtl_onhand_quantities_detail
                   WHERE organization_id IN (SELECT ood.organization_id FROM apps.org_organization_definitions ood WHERE ood.set_of_books_id = 230 )
                   GROUP BY organization_id
                          , inventory_item_id
                          , subinventory_code
                          , locator_id
                        --  , revision
                          , lot_number
                          --, transaction_uom_code
                          , create_transaction_id ) moq
                          ,APPS.MTL_PAC_ACTUAL_COST_DETAILS MPACD 
          WHERE 1                                = 1
          AND decode(mmt.periodic_primary_quantity,null,mmt.transfer_transaction_id,MMT.TRANSACTION_ID) = MPACD.TRANSACTION_ID  
            AND mp.organization_id               = msi.organization_id
--            AND msi.segment1 = '60510302'
            AND msifv.organization_id            = msi.organization_id
            AND msifv.secondary_inventory_name   = moq.subinventory_code
            AND msifv.material_account           = gcc1.code_combination_id
            AND msifv.outside_processing_account = gcc2.code_combination_id
            AND msifv.material_overhead_account  = gcc3.code_combination_id
            AND msifv.overhead_account           = gcc4.code_combination_id
            AND msifv.resource_account           = gcc5.code_combination_id
            AND msi.cost_of_sales_account       = gcc.code_combination_id
            AND ffvs.flex_value_set_name        = 'GE_GL_AFF_ES_PRODUCT_LINE'
            AND ffvs.flex_value_set_id          = ffvv.flex_value_set_id
            AND ffvv.flex_value_meaning         = gcc.segment8
            AND 'TYPE 1'                        IN ('TYPE 1')
            AND msi.organization_id             IN (SELECT ood.organization_id FROM apps.org_organization_definitions ood WHERE ood.set_of_books_id = 230 )
            AND moq.inventory_item_id           = msi.inventory_item_id
            AND moq.organization_id             = msi.organization_id
            --AND moq.locator_id                  = milk.inventory_location_id
            AND moq.create_transaction_id       = mmt.transaction_id(+)
--    AND MMT.TRANSACTION_ID = 2562828197
            AND mtt.transaction_type_id         = mmt.transaction_type_id 
            AND mtst.transaction_source_type_id = mmt.transaction_source_type_id
            AND msi.serial_number_control_code  = '1' 
            AND msi.lot_control_code            = '2'  --Com controle de Lote
            AND moq.locator_id                  IS NULL
            AND fu.user_id                      = mmt.created_by 
    AND MMT.TRANSACTION_ID NOT IN(SELECT MMT2.TRANSACTION_ID 
                                  FROM AMARCHIVE.MTL_MATERIAL_TRANSACTIONS  MMT2
                                  WHERE MMT2.TRANSACTION_ID = MMT.TRANSACTION_ID)
------------------------------------------------------------------------------
UNION  
------------------------------------------------------------------------------  
-- Sem Controle de Serial e Com Controle de Lote e sem Locator ---- AMARCHIVE.MTL_MATERIAL_TRANSACTIONS
         SELECT DISTINCT  --'10' NUM
        /* ( SELECT ccg.cost_group 
                             FROM apps.cst_cost_groups            ccg
                                , apps.cst_cost_group_assignments ccga
                            WHERE ccga.cost_group_id     = ccg.cost_group_id
                              AND ccga.organization_id   = mp.organization_id )  cost_group*/
            ( SELECT ccg.cost_group 
                             FROM apps.cst_cost_groups            ccg
                            WHERE MPACD.cost_group_id     = ccg.cost_group_id )  cost_group  
              , ( SELECT ( SELECT cpp1.period_name 
                             FROM apps.cst_pac_item_costs   cst
                                , apps.cst_pac_periods      cpp1
                            WHERE cst.pac_period_id     = (SELECT MAX(PAC_PERIOD_ID)                   FROM APPS.CST_PAC_PERIODS                  WHERE LEGAL_ENTITY = (SELECT LEGAL_ENTITY                                          FROM APPS.ORG_ORGANIZATION_DEFINITIONS OOD                                         WHERE OOD.ORGANIZATION_ID = mp.organization_id                                         ) )
                              AND cst.pac_period_id     = cpp1.pac_period_id
                              AND cst.inventory_item_id = msi.inventory_item_id
                              AND cst.cost_group_id     = ccg.cost_group_id )  
                    FROM apps.cst_cost_groups            ccg
                       , apps.cst_cost_group_assignments ccga
                   WHERE ccga.cost_group_id     = ccg.cost_group_id
                     AND ccga.organization_id   = mp.organization_id ) period_name
              , mp.organization_code
              , mp.attribute7                organization_type
              , mp.organization_id 
              , moq.subinventory_code
              , msifv.description            subinv_description
              , NULL   locators
              , DECODE( msifv.asset_inventory, 1 , 'Asset', 2, 'Non Asset')   asset_type
              , msi.segment1                 part_number
              , DECODE(msi.inventory_asset_flag, NULL, 'No', 'N', 'No', 'Y', 'Yes')                         flag_asset_inventory
              , DECODE(msi.costing_enabled_flag, NULL, 'No', 'N', 'No', 'Y', 'Yes')                         flag_de_custo
              , msi.description              descrip_eng
              , msi.attribute3               descrip_ptb
              , msi.creation_date            item_creation_date
              , (trunc(SYSDATE) - trunc(msi.creation_date))      days_from_creation
              , gcc.segment8                                     product_line
              , ffvv.description                                 desc_prod_line   
              , msi.primary_uom_code    uom
              , moq.onhand_qty                                   transaction_quantity
              , NVL(( SELECT cic.item_cost
                        FROM apps.cst_item_costs cic
                       WHERE cic.organization_id   = msi.organization_id
                         AND cic.inventory_item_id = msi.inventory_item_id
                         AND cic.cost_type_id      = 1 ),0)  custo_unit_inv
              /*, nvl(( SELECT ( SELECT ROUND (cst.item_cost,2) 
                                 FROM apps.cst_pac_item_costs   cst
                                WHERE cst.pac_period_id     = (SELECT MAX(PAC_PERIOD_ID)                   FROM APPS.CST_PAC_PERIODS                  WHERE LEGAL_ENTITY = (SELECT LEGAL_ENTITY                                          FROM APPS.ORG_ORGANIZATION_DEFINITIONS OOD                                         WHERE OOD.ORGANIZATION_ID = mp.organization_id                                         ) )
                                  AND cst.inventory_item_id = msi.inventory_item_id
                                  AND cst.cost_group_id     = ccg.cost_group_id )  item_cost
                        FROM apps.cst_cost_groups            ccg
                           , apps.cst_cost_group_assignments ccga
                       WHERE ccga.cost_group_id     = ccg.cost_group_id
                         AND ccga.organization_id   = mp.organization_id ) ,0) custo_unit_pac*/
                , nvl((SELECT ROUND (cst.item_cost,2) 
                       FROM apps.cst_pac_item_costs   cst
                      WHERE cst.pac_period_id     = (SELECT MAX(PAC_PERIOD_ID)                   
                                                                FROM APPS.CST_PAC_PERIODS                  
                                                                WHERE LEGAL_ENTITY = (SELECT LEGAL_ENTITY                                         
                                                                                        FROM APPS.ORG_ORGANIZATION_DEFINITIONS OOD                                        
                                                                                        WHERE OOD.ORGANIZATION_ID = mp.organization_id
                                                        ) )
                        AND cst.inventory_item_id = msi.inventory_item_id
                        AND cst.cost_group_id     = MPACD.cost_group_id) ,0)  custo_unit_pac

              , moq.lot_number
              , ( SELECT mln.creation_date        
                    FROM apps.mtl_lot_numbers              mln
                   WHERE mln.lot_number           = moq.lot_number
                     AND mln.inventory_item_id    = msi.inventory_item_id
                     AND mln.organization_id      = mp.organization_id  )  lot_creation_date
              , NULL   lot_qty_days_creation
              , ( SELECT mln.expiration_date         
                    FROM apps.mtl_lot_numbers              mln
                   WHERE mln.lot_number           = moq.lot_number
                     AND mln.inventory_item_id    = msi.inventory_item_id
                     AND mln.organization_id      = mp.organization_id  )  lot_expiration_date
              , NULL  serial_number
              , NULL  serial_creation_date
              , mtt.transaction_type_name           last_transaction_type
              , mmt.transaction_source_name         last_transaction_source
              , mtst.transaction_source_type_name   last_source_type
              , mmt.source_code
              , TO_CHAR(mmt.transaction_date, 'DD-MON-RRRR')      transaction_date
        , (SELECT TO_CHAR(mmt1.transaction_date, 'DD-MON-RRRR') 
          FROM apps.mtl_material_transactions mmt1
          WHERE mmt1.transaction_type_id=420
          AND mmt1.source_line_id=mmt.source_line_id) initial_consignment_date  
              , (TRUNC ( SYSDATE )- TRUNC(mmt.transaction_date))  transaction_qty_of_days
              , TO_CHAR(mmt.transaction_reference)                transaction_reference
              , CASE WHEN mmt.source_code = '3PL_REMITTANCE_BRAZIL' THEN
                     (SELECT listagg(pha.segment1,', ' ON OVERFLOW TRUNCATE)  
                      WITHIN GROUP (ORDER BY pha.segment1 asc)
                        FROM apps.po_headers_all        pha,
                             apps.po_lines_all          pla
                       WHERE pla.po_line_id   = mmt.source_line_id
                        AND pla.po_header_id = pha.po_header_id)
                     WHEN mmt.source_code IN ('ORDER ENTRY','IIP') THEN
                        NULL
                     WHEN mmt.source_code = 'RCV' THEN
                        ( SELECT listagg(pha.segment1,', ' ON OVERFLOW TRUNCATE)  
                          WITHIN GROUP (ORDER BY pha.segment1 asc)
                            FROM apps.po_headers_all            pha
                               , apps.po_lines_all              pla
                               , apps.po_line_locations_all     plla
                               , apps.rcv_shipment_headers      rsh
                               , apps.rcv_transactions          rt
                           WHERE rt.transaction_id                = mmt.rcv_transaction_id
                             AND rt.po_line_location_id           = plla.line_location_id
                             AND plla.po_line_id                  = pla.po_line_id
                             AND pha.po_header_id                 = pla.po_header_id
                             AND rt.shipment_header_id            = rsh.shipment_header_id
                             AND rsh.receipt_source_code          = 'VENDOR'  )
                     ELSE
                        NULL
                END      po_number
              , CASE WHEN mmt.source_code = '3PL_REMITTANCE_BRAZIL' THEN
                     (SELECT listagg(aps.vendor_name,', ' ON OVERFLOW TRUNCATE)  
                      WITHIN GROUP (ORDER BY aps.vendor_name asc)
                        FROM apps.po_headers_all        pha
                           , apps.po_lines_all          pla
                           , apps.ap_suppliers          aps
                           , apps.ap_supplier_sites_all  apss
                       WHERE pla.po_line_id     = mmt.source_line_id
                         AND pla.po_header_id   = pha.po_header_id
                         AND pha.vendor_id      = aps.vendor_id
                         AND aps.vendor_id      = apss.vendor_id
                         AND pha.vendor_site_id = apss.vendor_site_id )
                     WHEN mmt.source_code IN ('ORDER ENTRY','IIP') THEN
                        NULL
                     WHEN mmt.source_code = 'RCV' THEN
                        ( SELECT listagg(aps.vendor_name,', ' ON OVERFLOW TRUNCATE)  
                          WITHIN GROUP (ORDER BY aps.vendor_name asc)
                            FROM apps.po_headers_all            pha
                               , apps.po_lines_all              pla
                               , apps.po_line_locations_all     plla
                               , apps.rcv_shipment_headers      rsh
                               , apps.rcv_transactions          rt
                               , apps.ap_suppliers              aps
                               , apps.ap_supplier_sites_all     apss
                           WHERE rt.transaction_id          = mmt.rcv_transaction_id
                             AND rt.po_line_location_id     = plla.line_location_id
                             AND plla.po_line_id            = pla.po_line_id
                             AND pha.po_header_id           = pla.po_header_id
                             AND rt.shipment_header_id      = rsh.shipment_header_id
                             AND rsh.receipt_source_code    = 'VENDOR'
                             AND pha.vendor_id              = aps.vendor_id
                             AND aps.vendor_id              = apss.vendor_id
                             AND pha.vendor_site_id         = apss.vendor_site_id  )
                     ELSE
                        NULL
                END     po_supplier
              , CASE WHEN mmt.source_code = '3PL_REMITTANCE_BRAZIL' THEN
                     ( SELECT listagg(cfi.invoice_num,', ' ON OVERFLOW TRUNCATE)  
                         WITHIN GROUP (ORDER BY cfi.invoice_num asc)
                         FROM apps.cll_f189_invoice_lines cfil
                            , apps.cll_f189_invoices      cfi
                            , apps.po_lines_all           pla
                            , apps.po_line_locations_all  plla
                        WHERE plla.po_line_id       = pla.po_line_id
                          AND pla.po_line_id        = mmt.source_line_id
                          AND plla.line_location_id = cfil.line_location_id
                          AND cfil.invoice_id       = cfi.invoice_id )
                     WHEN mmt.source_code IN ('ORDER ENTRY','IIP') THEN
                        NULL
                     WHEN mmt.source_code = 'RCV' THEN
                        ( SELECT listagg(cfi.invoice_num,', ' ON OVERFLOW TRUNCATE)  
                            WITHIN GROUP (ORDER BY cfi.invoice_num asc)
                            FROM apps.po_headers_all            pha
                               , apps.po_lines_all              pla
                               , apps.po_line_locations_all     plla
                               , apps.cll_f189_invoice_lines    cfil
                               , apps.cll_f189_invoices         cfi
                               , apps.rcv_shipment_headers      rsh
                               , apps.rcv_transactions          rt
                           WHERE rt.transaction_id          = mmt.rcv_transaction_id
                             AND rt.po_line_location_id     = plla.line_location_id
                             AND plla.line_location_id      = cfil.line_location_id
                             AND cfil.invoice_id            = cfi.invoice_id
                             AND plla.po_line_id            = pla.po_line_id
                             AND pha.po_header_id           = pla.po_header_id
                             AND rt.shipment_header_id      = rsh.shipment_header_id
                             AND rsh.receipt_source_code    = 'VENDOR'   )
                     ELSE
                        NULL
                END    NF_RI
             , (SELECT DECODE( mmt.source_code, '3PL_REMITTANCE_BRAZIL',NULL,to_char(ooha.order_number) )
                  FROM apps.oe_order_headers_all  ooha,
                       apps.oe_order_lines_all    oola  
                 WHERE oola.line_id        = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                   AND oola.header_id      = ooha.header_id )   order_number
               -- 
               -- alterado para BIll_to por Sinval inicio
               --
               , CASE WHEN ( SELECT ottl.name
                             FROM apps.oe_transaction_types_tl    ottl
                                , apps.oe_order_headers_all  ooha
                                , apps.oe_order_lines_all    oola  
                            WHERE oola.line_id        = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND oola.header_id      = ooha.header_id
                              AND ooha.order_type_id  = ottl.transaction_type_id  ) = 'GPO_BR_FE_SHIPMENT' THEN
                     (SELECT listagg(hp.party_name,', ' ON OVERFLOW TRUNCATE)  
                      WITHIN GROUP (ORDER BY hp.party_name asc)
                        FROM apps.hz_parties             hp
                           , apps.hz_cust_accounts       hca
                           , apps.oe_order_lines_all     oola
                           , apps.hz_cust_acct_sites_all hcas
                           , apps.hz_cust_site_uses_all  hcsu
                       WHERE oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                         AND oola.end_customer_site_use_id  = hcsu.site_use_id
                         AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                         AND hcas.cust_account_id           = hca.cust_account_id
                         AND hca.party_id                   = hp.party_id )
                  ELSE
                     CASE WHEN (mmt.source_code = '3PL_REMITTANCE_BRAZIL') THEN
                       (SELECT listagg(hp.party_name,', ' ON OVERFLOW TRUNCATE)  
                        WITHIN GROUP (ORDER BY hp.party_name asc)
                          FROM apps.hz_parties             hp,
                               apps.hz_cust_accounts       hca,
                               apps.ra_customer_trx_all    rcta,
                               apps.hz_cust_acct_sites_all hcas,
                               apps.hz_cust_site_uses_all  hcsu
                         WHERE rcta.interface_header_attribute1 = mp.organization_code||'_'||mmt.transaction_reference
                           AND rcta.ship_to_site_use_id         = hcsu.site_use_id
                           AND hcsu.cust_acct_site_id           = hcas.cust_acct_site_id
                           AND hcas.cust_account_id             = hca.cust_account_id
                           AND hca.party_id                     = hp.party_id
                           AND rcta.org_id                      = 4330)
                     ELSE
                        (SELECT listagg(hp.party_name,', ' ON OVERFLOW TRUNCATE)  
                         WITHIN GROUP (ORDER BY hp.party_name asc)
                           FROM apps.hz_parties             hp
                              , apps.hz_cust_accounts       hca
                              , apps.oe_order_lines_all     oola
                              , apps.hz_cust_acct_sites_all hcas
                              , apps.hz_cust_site_uses_all  hcsu
                          WHERE oola.line_id                = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                            AND oola.ship_to_org_id         = hcsu.site_use_id
                            AND hcsu.cust_acct_site_id      = hcas.cust_acct_site_id
                            AND hcas.cust_account_id        = hca.cust_account_id
                            AND hca.party_id                = hp.party_id )
                    END                 
               END    customer_name
             , CASE WHEN ( SELECT ottl.name
                             FROM apps.oe_transaction_types_tl    ottl
                                , apps.oe_order_headers_all  ooha
                                , apps.oe_order_lines_all    oola  
                            WHERE oola.line_id        = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND oola.header_id      = ooha.header_id
                              AND ooha.order_type_id  = ottl.transaction_type_id  ) = 'GPO_BR_FE_SHIPMENT' THEN
                     (SELECT listagg(hca.account_number,', ' ON OVERFLOW TRUNCATE)  
                      WITHIN GROUP (ORDER BY hca.account_number asc)
                        FROM apps.hz_parties             hp
                           , apps.hz_cust_accounts       hca
                           , apps.oe_order_lines_all     oola
                           , apps.hz_cust_acct_sites_all hcas
                           , apps.hz_cust_site_uses_all  hcsu
                       WHERE oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                         AND oola.end_customer_site_use_id  = hcsu.site_use_id
                         AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                         AND hcas.cust_account_id           = hca.cust_account_id
                         AND hca.party_id                   = hp.party_id )
                  ELSE
                     CASE WHEN (mmt.source_code = '3PL_REMITTANCE_BRAZIL') THEN
                        (SELECT listagg(hca.account_number,', ' ON OVERFLOW TRUNCATE)  
                         WITHIN GROUP (ORDER BY hca.account_number asc)
                           FROM apps.hz_parties             hp,
                                apps.hz_cust_accounts       hca,
                                apps.ra_customer_trx_all    rcta,
                                apps.hz_cust_acct_sites_all hcas,
                                apps.hz_cust_site_uses_all  hcsu
                          WHERE rcta.interface_header_attribute1 = mp.organization_code||'_'||mmt.transaction_reference
                            AND rcta.ship_to_site_use_id         = hcsu.site_use_id
                            AND hcsu.cust_acct_site_id           = hcas.cust_acct_site_id
                            AND hcas.cust_account_id             = hca.cust_account_id
                            AND hca.party_id                     = hp.party_id
                            AND rcta.org_id                      = 4330)
                     ELSE
                        (SELECT listagg(hca.account_number,', ' ON OVERFLOW TRUNCATE)  
                         WITHIN GROUP (ORDER BY hca.account_number asc)
                           FROM apps.hz_parties             hp
                              , apps.hz_cust_accounts       hca
                              , apps.oe_order_lines_all     oola
                              , apps.hz_cust_acct_sites_all hcas
                              , apps.hz_cust_site_uses_all  hcsu
                          WHERE oola.line_id                = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                            AND oola.ship_to_org_id         = hcsu.site_use_id
                            AND hcsu.cust_acct_site_id      = hcas.cust_acct_site_id
                            AND hcas.cust_account_id        = hca.cust_account_id
                            AND hca.party_id                = hp.party_id   )
                     END
                  END   customer_number
              --
              , CASE WHEN ( SELECT ottl.name
                             FROM apps.oe_transaction_types_tl    ottl
                                , apps.oe_order_headers_all  ooha
                                , apps.oe_order_lines_all    oola  
                            WHERE oola.line_id        = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND oola.header_id      = ooha.header_id
                              AND ooha.order_type_id  = ottl.transaction_type_id  ) = 'GPO_BR_FE_SHIPMENT' THEN
                     (SELECT listagg(DECODE(hcas.global_attribute2
                                           , '2',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'/'|| hcas.global_attribute4 ||'-'|| hcas.global_attribute5
                                           , '1',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'-'|| hcas.global_attribute5 
                                           , '3',HCSU.LOCATION||' - '||hcas.global_attribute3 ),', ' ON OVERFLOW TRUNCATE)
                     WITHIN GROUP (ORDER BY hcas.global_attribute2 asc ) 
                        FROM apps.hz_parties             hp
                           , apps.hz_cust_accounts       hca
                           , apps.oe_order_lines_all     oola
                           , apps.hz_cust_acct_sites_all hcas
                           , apps.hz_cust_site_uses_all  hcsu
                       WHERE oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                         AND oola.end_customer_site_use_id  = hcsu.site_use_id
                         AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                         AND hcas.cust_account_id           = hca.cust_account_id
                         AND hca.party_id                   = hp.party_id )
                ELSE
                   CASE WHEN (mmt.source_code = '3PL_REMITTANCE_BRAZIL') THEN
                      (SELECT listagg(DECODE(hcas.global_attribute2
                                           , '2',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'/'|| hcas.global_attribute4 ||'-'|| hcas.global_attribute5
                                           , '1',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'-'|| hcas.global_attribute5 
                                           , '3',HCSU.LOCATION||' - '||hcas.global_attribute3 ),', ' ON OVERFLOW TRUNCATE)
                     WITHIN GROUP (ORDER BY hcas.global_attribute2 asc) 
                         FROM apps.ra_customer_trx_all     rcta
                            , apps.hz_cust_acct_sites_all  hcas
                            , apps.hz_cust_site_uses_all   hcsu
                        WHERE rcta.interface_header_attribute1 = mp.organization_code||'_'||mmt.transaction_reference
                          AND rcta.ship_to_site_use_id         = hcsu.site_use_id
                          AND hcsu.cust_acct_site_id           = hcas.cust_acct_site_id
                          AND rcta.org_id                      = 4330)
                   ELSE
                      (SELECT listagg(DECODE(hcas.global_attribute2
                                           , '2',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'/'|| hcas.global_attribute4 ||'-'|| hcas.global_attribute5
                                           , '1',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'-'|| hcas.global_attribute5 
                                           , '3',HCSU.LOCATION||' - '||hcas.global_attribute3 ),', ' ON OVERFLOW TRUNCATE)
                      WITHIN GROUP (ORDER BY hcas.global_attribute2 asc) 
                         FROM apps.hz_parties             hp
                            , apps.hz_cust_accounts       hca
                            , apps.oe_order_lines_all     oola
                            , apps.hz_cust_acct_sites_all hcas
                            , apps.hz_cust_site_uses_all  hcsu
                        WHERE oola.line_id                = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                          AND oola.ship_to_org_id         = hcsu.site_use_id
                          AND hcsu.cust_acct_site_id      = hcas.cust_acct_site_id
                          AND hcas.cust_account_id        = hca.cust_account_id
                          AND hca.party_id                = hp.party_id  )
                   END
                END  customer_cnpj_cpf
               -- 
              , CASE WHEN (mmt.source_code = '3PL_REMITTANCE_BRAZIL') THEN
                      (SELECT listagg(DECODE(hcas.global_attribute2
                                           , '2',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'/'|| hcas.global_attribute4 ||'-'|| hcas.global_attribute5
                                           , '1',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'-'|| hcas.global_attribute5 
                                           , '3',HCSU.LOCATION||' - '||hcas.global_attribute3 ),', ' ON OVERFLOW TRUNCATE)
                       WITHIN GROUP (ORDER BY hcas.global_attribute2 asc )
                         FROM apps.ra_customer_trx_all         rcta
                            , apps.hz_cust_acct_sites_all      hcas
                            , apps.hz_cust_site_uses_all       hcsu
                        WHERE rcta.interface_header_attribute1 = mp.organization_code||'_'||mmt.transaction_reference
                          AND rcta.bill_to_site_use_id         = hcsu.site_use_id
                          AND hcsu.cust_acct_site_id           = hcas.cust_acct_site_id
                          AND rcta.org_id                      = 4330
                          AND ROWNUM = 1)
                   ELSE
                     --
                     CASE WHEN (select DISTINCT RCTL.INTERFACE_LINE_CONTEXT
                             FROM apps.hz_parties                hp
                                , apps.hz_cust_accounts          hca
                                , apps.oe_order_lines_all        oola
                                , apps.oe_order_headers_all      ooha
                                , apps.ra_customer_trx_lines_all rctl
                                , apps.ra_customer_trx_all       rcta
                                , apps.hz_cust_acct_sites_all    hcas
                                , apps.hz_cust_site_uses_all     hcsu
                            WHERE ooha.header_id                 = oola.header_id
                              AND oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND rctl.inventory_item_id         = oola.inventory_item_id
                              AND rctl.line_type                 = 'LINE'
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE1 = to_char(ooha.order_number)
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE6 = to_char(oola.line_id)
                              AND RCTL.INTERFACE_LINE_CONTEXT    = 'ORDER ENTRY'
                              AND rctl.customer_trx_id           = rcta.customer_trx_id
                              AND rcta.bill_to_site_use_id       = hcsu.site_use_id
                              AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                              AND hcas.cust_account_id           = hca.cust_account_id
                              AND hca.party_id                   = hp.party_id 
                              AND ROWNUM = 1) = 'ORDER ENTRY' THEN
                     --
                     (SELECT DISTINCT DECODE(hcas.global_attribute2
                                           , '2',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'/'|| hcas.global_attribute4 ||'-'|| hcas.global_attribute5
                                           , '1',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'-'|| hcas.global_attribute5 
                                           , '3',HCSU.LOCATION||' - '||hcas.global_attribute3)
                             FROM apps.hz_parties                hp
                                , apps.hz_cust_accounts          hca
                                , apps.oe_order_lines_all        oola
                                , apps.oe_order_headers_all      ooha
                                , apps.ra_customer_trx_lines_all rctl
                                , apps.ra_customer_trx_all       rcta
                                , apps.hz_cust_acct_sites_all    hcas
                                , apps.hz_cust_site_uses_all     hcsu
                            WHERE ooha.header_id                 = oola.header_id
                              AND oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND rctl.inventory_item_id         = oola.inventory_item_id
                              AND rctl.line_type                 = 'LINE'
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE1 = to_char(ooha.order_number)
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE6 = to_char(oola.line_id)
                              AND RCTL.INTERFACE_LINE_CONTEXT    = 'ORDER ENTRY'
                              AND rctl.customer_trx_id           = rcta.customer_trx_id
                              AND rcta.bill_to_site_use_id       = hcsu.site_use_id
                              AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                              AND hcas.cust_account_id           = hca.cust_account_id
                              AND hca.party_id                   = hp.party_id
                              AND ROWNUM = 1)
                     --
                     ELSE
                     --            
                     CASE WHEN 
                          ( SELECT DISTINCT RCTL.INTERFACE_LINE_CONTEXT
                             FROM apps.hz_parties                hp
                                , apps.hz_cust_accounts          hca
                                , apps.oe_order_lines_all        oola
                                , apps.oe_order_headers_all      ooha
                                , apps.ra_customer_trx_lines_all rctl
                                , apps.ra_customer_trx_all       rcta
                                , apps.hz_cust_acct_sites_all    hcas
                                , apps.hz_cust_site_uses_all     hcsu
                            WHERE ooha.header_id                 = oola.header_id
                              AND oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND rctl.inventory_item_id         = oola.inventory_item_id
                              AND rctl.line_type                 = 'LINE'
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE1 = ooha.ORIG_SYS_DOCUMENT_REF
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE7 = oola.ORIG_SYS_LINE_REF
                              AND RCTL.INTERFACE_LINE_CONTEXT    = 'GEMS_PB_RR'
                              AND rctl.customer_trx_id           = rcta.customer_trx_id
                              AND rcta.bill_to_site_use_id       = hcsu.site_use_id
                              AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                              AND hcas.cust_account_id           = hca.cust_account_id
                              AND ROWNUM = 1 ) = 'GEMS_PB_RR' THEN
                     --
                     (SELECT DISTINCT DECODE(hcas.global_attribute2
                                           , '2',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'/'|| hcas.global_attribute4 ||'-'|| hcas.global_attribute5
                                           , '1',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'-'|| hcas.global_attribute5 
                                           , '3',HCSU.LOCATION||' - '||hcas.global_attribute3)
                             FROM apps.hz_parties                hp
                                , apps.hz_cust_accounts          hca
                                , apps.oe_order_lines_all        oola
                                , apps.oe_order_headers_all      ooha
                                , apps.ra_customer_trx_lines_all rctl
                                , apps.ra_customer_trx_all       rcta
                                , apps.hz_cust_acct_sites_all    hcas
                                , apps.hz_cust_site_uses_all     hcsu
                            WHERE ooha.header_id                 = oola.header_id
                              AND oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND rctl.inventory_item_id         = oola.inventory_item_id
                              AND rctl.line_type                 = 'LINE'
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE1 = ooha.ORIG_SYS_DOCUMENT_REF
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE7 = oola.ORIG_SYS_LINE_REF
                              AND RCTL.INTERFACE_LINE_CONTEXT    = 'GEMS_PB_RR'
                              AND rctl.customer_trx_id           = rcta.customer_trx_id
                              AND rcta.bill_to_site_use_id       = hcsu.site_use_id
                              AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                              AND hcas.cust_account_id           = hca.cust_account_id 
                              AND ROWNUM = 1 )
                     --
                     ELSE
                     --
                     (SELECT DISTINCT DECODE(hcas.global_attribute2
                                   , '2',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'/'|| hcas.global_attribute4 ||'-'|| hcas.global_attribute5
                                   , '1',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'-'|| hcas.global_attribute5 
                                   , '3',HCSU.LOCATION||' - '||hcas.global_attribute3)
                             --
                      FROM   APPS.HZ_CUST_ACCT_SITES_ALL HCAS,
                             APPS.HZ_CUST_SITE_USES_ALL  HCSU,
                             APPS.OE_ORDER_LINES_ALL     OOLA,
                             APPS.OE_ORDER_HEADERS_ALL   OOHA
                             --
                      WHERE  HCSU.SITE_USE_CODE     = 'BILL_TO'
                      AND    HCSU.CUST_ACCT_SITE_ID = HCAS.CUST_ACCT_SITE_ID
                      AND    HCSU.SITE_USE_ID       = NVL(OOLA.ATTRIBUTE1, OOHA.INVOICE_TO_ORG_ID)
                      AND    OOLA.LINE_ID           = NVL(MMT.TRX_SOURCE_LINE_ID, MMT.SOURCE_LINE_ID)
                      AND    OOHA.HEADER_ID         = OOLA.HEADER_ID
                      AND    ROWNUM = 1)
                     --
                     END
                  END
               END      bill_to_CNPJ_CPF
               --
                             --
              , CASE WHEN (mmt.source_code = '3PL_REMITTANCE_BRAZIL') THEN
                        (SELECT listagg(hp.party_name,', ' ON OVERFLOW TRUNCATE)  
                        WITHIN GROUP (ORDER BY hp.party_name asc)
                          FROM apps.hz_parties             hp,
                               apps.hz_cust_accounts       hca,
                               apps.ra_customer_trx_all    rcta,
                               apps.hz_cust_acct_sites_all hcas,
                               apps.hz_cust_site_uses_all  hcsu
                         WHERE rcta.interface_header_attribute1 = mp.organization_code||'_'||mmt.transaction_reference
                           AND rcta.bill_to_site_use_id         = hcsu.site_use_id
                           AND hcsu.cust_acct_site_id           = hcas.cust_acct_site_id
                           AND hcas.cust_account_id             = hca.cust_account_id
                           AND hca.party_id                     = hp.party_id
                           AND rcta.org_id                      = 4330)
                   ELSE
                     --
                     CASE WHEN (select DISTINCT RCTL.INTERFACE_LINE_CONTEXT
                             FROM apps.hz_parties                hp
                                , apps.hz_cust_accounts          hca
                                , apps.oe_order_lines_all        oola
                                , apps.oe_order_headers_all      ooha
                                , apps.ra_customer_trx_lines_all rctl
                                , apps.ra_customer_trx_all       rcta
                                , apps.hz_cust_acct_sites_all    hcas
                                , apps.hz_cust_site_uses_all     hcsu
                            WHERE ooha.header_id                 = oola.header_id
                              AND oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND rctl.inventory_item_id         = oola.inventory_item_id
                              AND rctl.line_type                 = 'LINE'
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE1 = to_char(ooha.order_number)
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE6 = to_char(oola.line_id)
                              AND RCTL.INTERFACE_LINE_CONTEXT    = 'ORDER ENTRY'
                              AND rctl.customer_trx_id           = rcta.customer_trx_id
                              AND rcta.bill_to_site_use_id       = hcsu.site_use_id
                              AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                              AND hcas.cust_account_id           = hca.cust_account_id
                              AND hca.party_id                   = hp.party_id 
                              AND ROWNUM = 1) = 'ORDER ENTRY' THEN
                     --
                     (SELECT listagg(hp.party_name,', ' ON OVERFLOW TRUNCATE)  
                         WITHIN GROUP (ORDER BY hp.party_name asc)
                             FROM apps.hz_parties                hp
                                , apps.hz_cust_accounts          hca
                                , apps.oe_order_lines_all        oola
                                , apps.oe_order_headers_all      ooha
                                , apps.ra_customer_trx_lines_all rctl
                                , apps.ra_customer_trx_all       rcta
                                , apps.hz_cust_acct_sites_all    hcas
                                , apps.hz_cust_site_uses_all     hcsu
                            WHERE ooha.header_id                 = oola.header_id
                              AND oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND rctl.inventory_item_id         = oola.inventory_item_id
                              AND rctl.line_type                 = 'LINE'
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE1 = to_char(ooha.order_number)
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE6 = to_char(oola.line_id)
                              AND RCTL.INTERFACE_LINE_CONTEXT    = 'ORDER ENTRY'
                              AND rctl.customer_trx_id           = rcta.customer_trx_id
                              AND rcta.bill_to_site_use_id       = hcsu.site_use_id
                              AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                              AND hcas.cust_account_id           = hca.cust_account_id
                              AND hca.party_id                   = hp.party_id
                              AND ROWNUM = 1)
                     --
                     ELSE
                     --            
                     CASE WHEN 
                          ( SELECT DISTINCT RCTL.INTERFACE_LINE_CONTEXT
                             FROM apps.hz_parties                hp
                                , apps.hz_cust_accounts          hca
                                , apps.oe_order_lines_all        oola
                                , apps.oe_order_headers_all      ooha
                                , apps.ra_customer_trx_lines_all rctl
                                , apps.ra_customer_trx_all       rcta
                                , apps.hz_cust_acct_sites_all    hcas
                                , apps.hz_cust_site_uses_all     hcsu
                            WHERE ooha.header_id                 = oola.header_id
                              AND oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND rctl.inventory_item_id         = oola.inventory_item_id
                              AND rctl.line_type                 = 'LINE'
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE1 = ooha.ORIG_SYS_DOCUMENT_REF
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE7 = oola.ORIG_SYS_LINE_REF
                              AND RCTL.INTERFACE_LINE_CONTEXT    = 'GEMS_PB_RR'
                              AND rctl.customer_trx_id           = rcta.customer_trx_id
                              AND rcta.bill_to_site_use_id       = hcsu.site_use_id
                              AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                              AND hcas.cust_account_id           = hca.cust_account_id
                              AND ROWNUM = 1 ) = 'GEMS_PB_RR' THEN
                     --
                     (SELECT listagg(hp.party_name,', ' ON OVERFLOW TRUNCATE)  
                         WITHIN GROUP (ORDER BY hp.party_name asc)
                             FROM apps.hz_parties                hp
                                , apps.hz_cust_accounts          hca
                                , apps.oe_order_lines_all        oola
                                , apps.oe_order_headers_all      ooha
                                , apps.ra_customer_trx_lines_all rctl
                                , apps.ra_customer_trx_all       rcta
                                , apps.hz_cust_acct_sites_all    hcas
                                , apps.hz_cust_site_uses_all     hcsu
                            WHERE ooha.header_id                 = oola.header_id
                              AND oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND rctl.inventory_item_id         = oola.inventory_item_id
                              AND rctl.line_type                 = 'LINE'
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE1 = ooha.ORIG_SYS_DOCUMENT_REF
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE7 = oola.ORIG_SYS_LINE_REF
                              AND RCTL.INTERFACE_LINE_CONTEXT    = 'GEMS_PB_RR'
                              AND rctl.customer_trx_id           = rcta.customer_trx_id
                              AND rcta.bill_to_site_use_id       = hcsu.site_use_id
                              AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                              AND hcas.cust_account_id           = hca.cust_account_id 
                              AND ROWNUM = 1 )
                     --
                     ELSE
                     --
                     (SELECT listagg(hp.party_name,', ' ON OVERFLOW TRUNCATE)  
                         WITHIN GROUP (ORDER BY hp.party_name asc)
                      FROM   APPS.HZ_CUST_ACCT_SITES_ALL HCAS,
                             apps.hz_parties             hp,
                             apps.hz_cust_accounts       hca,
                             APPS.HZ_CUST_SITE_USES_ALL  HCSU,
                             APPS.OE_ORDER_LINES_ALL     OOLA,
                             APPS.OE_ORDER_HEADERS_ALL   OOHA
                             --
                      WHERE  HCSU.SITE_USE_CODE     = 'BILL_TO'
                      AND    HCSU.CUST_ACCT_SITE_ID = HCAS.CUST_ACCT_SITE_ID
                      AND    HCSU.SITE_USE_ID       = NVL(OOLA.ATTRIBUTE1, OOHA.INVOICE_TO_ORG_ID)
                      AND    OOLA.LINE_ID           = NVL(MMT.TRX_SOURCE_LINE_ID, MMT.SOURCE_LINE_ID)
                      AND    OOHA.HEADER_ID         = OOLA.HEADER_ID
                      AND    hcas.cust_account_id   = hca.cust_account_id
                      AND    hca.party_id           = hp.party_id 
                      AND    ROWNUM = 1)
                     --          
                     END
                  END
               END      bill_to_Customer_name
               --
                , CASE WHEN (mmt.source_code = '3PL_REMITTANCE_BRAZIL') THEN
                      (SELECT listagg(DECODE(hcas.global_attribute2
                                           , '2',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'/'|| hcas.global_attribute4 ||'-'|| hcas.global_attribute5
                                           , '1',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'-'|| hcas.global_attribute5 
                                           , '3',HCSU.LOCATION||' - '||hcas.global_attribute3 ),', ' ON OVERFLOW TRUNCATE)
                       WITHIN GROUP (ORDER BY hcas.global_attribute2 asc )
                         FROM apps.ra_customer_trx_all         rcta
                            , apps.hz_cust_acct_sites_all      hcas
                            , apps.hz_cust_site_uses_all       hcsu
                        WHERE rcta.interface_header_attribute1 = mp.organization_code||'_'||mmt.transaction_reference
                          AND rcta.ship_to_site_use_id         = hcsu.site_use_id
                          AND hcsu.cust_acct_site_id           = hcas.cust_acct_site_id
                          AND rcta.org_id                      = 4330
                          AND ROWNUM = 1)
                   ELSE
                     --
                     CASE WHEN (select DISTINCT RCTL.INTERFACE_LINE_CONTEXT
                             FROM apps.hz_parties                hp
                                , apps.hz_cust_accounts          hca
                                , apps.oe_order_lines_all        oola
                                , apps.oe_order_headers_all      ooha
                                , apps.ra_customer_trx_lines_all rctl
                                , apps.ra_customer_trx_all       rcta
                                , apps.hz_cust_acct_sites_all    hcas
                                , apps.hz_cust_site_uses_all     hcsu
                            WHERE ooha.header_id                 = oola.header_id
                              AND oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND rctl.inventory_item_id         = oola.inventory_item_id
                              AND rctl.line_type                 = 'LINE'
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE1 = to_char(ooha.order_number)
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE6 = to_char(oola.line_id)
                              AND RCTL.INTERFACE_LINE_CONTEXT    = 'ORDER ENTRY'
                              AND rctl.customer_trx_id           = rcta.customer_trx_id
                              AND rcta.ship_to_site_use_id       = hcsu.site_use_id
                              AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                              AND hcas.cust_account_id           = hca.cust_account_id
                              AND hca.party_id                   = hp.party_id 
                              AND ROWNUM = 1) = 'ORDER ENTRY' THEN
                     --
                     (SELECT DISTINCT DECODE(hcas.global_attribute2
                                           , '2',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'/'|| hcas.global_attribute4 ||'-'|| hcas.global_attribute5
                                           , '1',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'-'|| hcas.global_attribute5 
                                           , '3',HCSU.LOCATION||' - '||hcas.global_attribute3)
                             FROM apps.hz_parties                hp
                                , apps.hz_cust_accounts          hca
                                , apps.oe_order_lines_all        oola
                                , apps.oe_order_headers_all      ooha
                                , apps.ra_customer_trx_lines_all rctl
                                , apps.ra_customer_trx_all       rcta
                                , apps.hz_cust_acct_sites_all    hcas
                                , apps.hz_cust_site_uses_all     hcsu
                            WHERE ooha.header_id                 = oola.header_id
                              AND oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND rctl.inventory_item_id         = oola.inventory_item_id
                              AND rctl.line_type                 = 'LINE'
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE1 = to_char(ooha.order_number)
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE6 = to_char(oola.line_id)
                              AND RCTL.INTERFACE_LINE_CONTEXT    = 'ORDER ENTRY'
                              AND rctl.customer_trx_id           = rcta.customer_trx_id
                              AND rcta.ship_to_site_use_id       = hcsu.site_use_id
                              AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                              AND hcas.cust_account_id           = hca.cust_account_id
                              AND hca.party_id                   = hp.party_id
                              AND ROWNUM = 1)
                     --
                     ELSE
                     --            
                     CASE WHEN 
                          ( SELECT DISTINCT RCTL.INTERFACE_LINE_CONTEXT
                             FROM apps.hz_parties                hp
                                , apps.hz_cust_accounts          hca
                                , apps.oe_order_lines_all        oola
                                , apps.oe_order_headers_all      ooha
                                , apps.ra_customer_trx_lines_all rctl
                                , apps.ra_customer_trx_all       rcta
                                , apps.hz_cust_acct_sites_all    hcas
                                , apps.hz_cust_site_uses_all     hcsu
                            WHERE ooha.header_id                 = oola.header_id
                              AND oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND rctl.inventory_item_id         = oola.inventory_item_id
                              AND rctl.line_type                 = 'LINE'
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE1 = ooha.ORIG_SYS_DOCUMENT_REF
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE7 = oola.ORIG_SYS_LINE_REF
                              AND RCTL.INTERFACE_LINE_CONTEXT    = 'GEMS_PB_RR'
                              AND rctl.customer_trx_id           = rcta.customer_trx_id
                              AND rcta.ship_to_site_use_id       = hcsu.site_use_id
                              AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                              AND hcas.cust_account_id           = hca.cust_account_id
                              AND ROWNUM = 1 ) = 'GEMS_PB_RR' THEN
                     --
                     (SELECT DISTINCT DECODE(hcas.global_attribute2
                                           , '2',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'/'|| hcas.global_attribute4 ||'-'|| hcas.global_attribute5
                                           , '1',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'-'|| hcas.global_attribute5 
                                           , '3',HCSU.LOCATION||' - '||hcas.global_attribute3)
                             FROM apps.hz_parties                hp
                                , apps.hz_cust_accounts          hca
                                , apps.oe_order_lines_all        oola
                                , apps.oe_order_headers_all      ooha
                                , apps.ra_customer_trx_lines_all rctl
                                , apps.ra_customer_trx_all       rcta
                                , apps.hz_cust_acct_sites_all    hcas
                               , apps.hz_cust_site_uses_all     hcsu
                            WHERE ooha.header_id                 = oola.header_id
                              AND oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND rctl.inventory_item_id         = oola.inventory_item_id
                              AND rctl.line_type                 = 'LINE'
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE1 = ooha.ORIG_SYS_DOCUMENT_REF
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE7 = oola.ORIG_SYS_LINE_REF
                              AND RCTL.INTERFACE_LINE_CONTEXT    = 'GEMS_PB_RR'
                              AND rctl.customer_trx_id           = rcta.customer_trx_id
                              AND rcta.ship_to_site_use_id       = hcsu.site_use_id
                              AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                              AND hcas.cust_account_id           = hca.cust_account_id 
                              AND ROWNUM = 1 )
                     --
                     ELSE
                     --
                     (SELECT listagg(DECODE(hcas.global_attribute2
                                           , '2',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'/'|| hcas.global_attribute4 ||'-'|| hcas.global_attribute5
                                           , '1',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'-'|| hcas.global_attribute5 
                                           , '3',HCSU.LOCATION||' - '||hcas.global_attribute3 ),', ' ON OVERFLOW TRUNCATE)
                      WITHIN GROUP (ORDER BY hcas.global_attribute2 asc) 
                         FROM apps.hz_parties             hp
                            , apps.hz_cust_accounts       hca
                            , apps.oe_order_lines_all     oola
                            , apps.hz_cust_acct_sites_all hcas
                            , apps.hz_cust_site_uses_all  hcsu
                        WHERE oola.line_id                = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                          AND oola.ship_to_org_id         = hcsu.site_use_id
                          AND hcsu.cust_acct_site_id      = hcas.cust_acct_site_id
                          AND hcas.cust_account_id        = hca.cust_account_id
                          AND hca.party_id                = hp.party_id  )
                     --
                     END
                  END
               END      ship_to_CNPJ_CPF
               --
              , CASE WHEN ( SELECT ottl.name
                              FROM apps.oe_transaction_types_tl    ottl
                                 , apps.oe_order_headers_all  ooha
                                 , apps.oe_order_lines_all    oola  
                             WHERE oola.line_id        = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                               AND oola.header_id      = ooha.header_id
                               AND ooha.order_type_id  = ottl.transaction_type_id  ) = 'GPO_BR_FE_SHIPMENT' THEN
                      (SELECT listagg(hzl.address1 ||' - '|| hzl.address2 || ' - ' || hzl.city || '-' || hzl.state || ' / ' || hzl.postal_code,', ' ON OVERFLOW TRUNCATE)  
                       WITHIN GROUP (ORDER BY hzl.address1 asc)
                       FROM apps.hz_parties             hp
                        , apps.hz_party_sites         hps
                        , apps.hz_cust_accounts       hca
                        , apps.oe_order_lines_all     oola
                        , apps.hz_cust_acct_sites_all hcas
                        , apps.hz_cust_site_uses_all  hcsu
                        , apps.hz_locations           hzl
                    WHERE oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                      AND oola.end_customer_site_use_id  = hcsu.site_use_id
                      AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                      AND hcas.cust_account_id           = hca.cust_account_id
                      AND hcas.party_site_id             = hps.party_site_id
                      AND hca.party_id                   = hp.party_id
                      AND hps.party_id                   = hp.party_id
                      AND hps.location_id                = hzl.location_id)
                ELSE
                   CASE WHEN (mmt.source_code = '3PL_REMITTANCE_BRAZIL') THEN
                      (SELECT listagg(hzl.address1 ||' - '|| hzl.address2 || ' - ' || hzl.city || '-' || hzl.state || ' / ' || hzl.postal_code,', ' ON OVERFLOW TRUNCATE)  
                       WITHIN GROUP (ORDER BY hzl.address1 asc)
                         FROM apps.ra_customer_trx_all     rcta
                            , apps.hz_cust_acct_sites_all  hcas
                            , apps.hz_cust_site_uses_all   hcsu
                            , apps.hz_parties              hp
                            , apps.hz_party_sites          hps
                            , apps.hz_cust_accounts        hca
                            , apps.hz_locations            hzl
                        WHERE rcta.interface_header_attribute1 = mp.organization_code||'_'||mmt.transaction_reference
                          AND rcta.ship_to_site_use_id         = hcsu.site_use_id
                          AND hcsu.cust_acct_site_id           = hcas.cust_acct_site_id
                          AND hcas.cust_account_id             = hca.cust_account_id
                          AND hcas.party_site_id               = hps.party_site_id
                          AND hca.party_id                     = hp.party_id
                          AND hps.party_id                     = hp.party_id
                          AND hps.location_id                  = hzl.location_id
                          AND rcta.org_id                      = 4330)
                   ELSE
                      (SELECT listagg(hzl.address1 ||' - '|| hzl.address2 || ' - ' || hzl.city || '-' || hzl.state || ' / ' || hzl.postal_code,', ' ON OVERFLOW TRUNCATE)  
                       WITHIN GROUP (ORDER BY hzl.address1 asc)
                          FROM apps.hz_parties             hp
                             , apps.hz_party_sites         hps
                             , apps.hz_cust_accounts       hca
                             , apps.oe_order_lines_all     oola
                             , apps.hz_cust_acct_sites_all hcas
                             , apps.hz_cust_site_uses_all  hcsu
                             , apps.hz_locations           hzl
                         WHERE oola.line_id                = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                           AND oola.ship_to_org_id         = hcsu.site_use_id
                           AND hcsu.cust_acct_site_id      = hcas.cust_acct_site_id
                           AND hcas.cust_account_id        = hca.cust_account_id
                           AND hcas.party_site_id          = hps.party_site_id
                           AND hca.party_id                = hp.party_id
                           AND hps.party_id                = hp.party_id
                           AND hps.location_id             = hzl.location_id   )
                   END
                END customer_address
                -- 
                -- alterado para BIll_to por Sinval fim
                -- 
              , CASE WHEN (mmt.source_code = '3PL_REMITTANCE_BRAZIL') THEN
                   (SELECT listagg(rcta.trx_number,', ' ON OVERFLOW TRUNCATE)  
                           WITHIN GROUP (ORDER BY rcta.trx_number asc)
                      FROM apps.ra_customer_trx_all       rcta
                     WHERE rcta.interface_header_attribute1  = mp.organization_code||'_'||mmt.transaction_reference
                       AND rcta.org_id                       = 4330
                       AND NVL(rcta.status_trx,'XX')         <> 'VD'
                       AND NVL(rcta.reason_code,'XX')        <> 'CANCELLATION')
                ELSE
                   (SELECT distinct RTRIM(REGEXP_REPLACE((listagg(rcta.trx_number,', ' ON OVERFLOW TRUNCATE)  
                      WITHIN GROUP (ORDER BY rcta.trx_number asc) ), '([^,]*)(,\1)+($|,)', '\1\3'),',')
                      FROM apps.ra_customer_trx_lines_all rctla
                         , apps.ra_customer_trx_all       rcta
                         , apps.oe_order_lines_all        oola
                         , apps.oe_order_headers_all      ooha
                     WHERE rcta.customer_trx_id              = rctla.customer_trx_id
                       AND oola.line_id                      = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                       AND oola.header_id                    = ooha.header_id
                       AND rctla.sales_order                 = to_char(ooha.order_number)
                       AND rctla.line_type                   = 'LINE'
                       AND rcta.batch_source_id              <> 6266 -- No RR invoices
                       AND DECODE(rctla.interface_line_context,'GEMS_PB_RR',rcta.interface_header_attribute11,'999')
                           = DECODE(rctla.interface_line_context,'GEMS_PB_RR',rcta.interface_header_attribute11,'999')
                       AND rcta.org_id                       = 4330
                       AND trunc(rcta.trx_date)              BETWEEN (trunc(mmt.transaction_date)-3) AND (trunc(mmt.transaction_date)+3)
                       AND NVL(rcta.status_trx,'XX')         <> 'VD'
                       AND NVL(rcta.reason_code,'XX')        <> 'CANCELLATION')
                END   invoice_number_ar
              , ( SELECT listagg(mrav.reservation_quantity,', ' ON OVERFLOW TRUNCATE)  
                  WITHIN GROUP (ORDER BY mrav.reservation_quantity asc) 
                    FROM apps.mtl_reservations_all_v  mrav 
                       , apps.oe_order_headers_all    ooha1
                   WHERE mrav.demand_source_header_id     = ooha1.header_id
                     AND mrav.demand_source_line_id       = NVL(mmt.trx_source_line_id, mmt.source_line_id) )  reservation_quantity
              , ( SELECT listagg(ooha1.order_number,', ' ON OVERFLOW TRUNCATE)  
                  WITHIN GROUP (ORDER BY ooha1.order_number asc) 
                    FROM apps.mtl_reservations_all_v  mrav 
                       , apps.oe_order_headers_all    ooha1
                   WHERE mrav.demand_source_header_id     = ooha1.header_id
                     AND mrav.demand_source_line_id       = NVL(mmt.trx_source_line_id, mmt.source_line_id) )  reservation_order_number
              , (SELECT distinct hp.party_name
                 --WITHIN GROUP (ORDER BY hp.party_name asc)
                   FROM apps.hz_parties              hp
                      , apps.hz_cust_accounts        hca
                      , apps.oe_order_lines_all      oola1
                      , apps.oe_order_headers_all    ooha1
                      , apps.mtl_reservations_all_v  mrav 
                  WHERE mrav.demand_source_header_id   = ooha1.header_id
                    AND mrav.demand_source_line_id     = oola1.line_id
                    AND oola1.line_id                  = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                    AND oola1.ship_to_org_id           = hca.cust_account_id
                    AND hca.party_id                   = hp.party_id )         reservation_customer_name
              , gcc1.concatenated_segments   material_account
              , gcc2.concatenated_segments   outside_processing_account
              , gcc3.concatenated_segments   material_overhead_account
              , gcc4.concatenated_segments   overhead_account
              , gcc5.concatenated_segments   resource_account
              , sysdate                                           report_date_and_time 
              , to_char(mmt.transaction_id)  transaction_id
              , fu.user_name ||' / '|| fu.description                                    user_name
              , DECODE( lot_control_code, 1 ,'Sem controle de Lote' , 2,'Com controle de Lote')   lot_control
              , DECODE( serial_number_control_code, 1, 'Sem controle de Serial'
                                                  , 2, 'Pre-definido'
                                                  , 5, 'No Recebimento'
                                                  , 6, 'Baixa na Ordem de Venda' )  serial_control
              , CASE
                 WHEN    nvl(mmt.lpn_id, mmt.content_lpn_id) IS NULL AND moq.subinventory_code <> 'WHGU42GNAT'
                   THEN 
                    (SELECT listagg(lpn.license_plate_number,', ' ON OVERFLOW TRUNCATE)WITHIN GROUP (ORDER BY lpn.license_plate_number asc)
                             FROM apps.MTL_MATERIAL_TRANSACTIONS   mtt,
                                  apps.wms_license_plate_numbers   lpn,
                                  apps.oe_order_lines_all          ool
                            WHERE 1 = 1
                              AND mtt.TRX_SOURCE_LINE_ID = CASE
                                                              WHEN LINE_CATEGORY_CODE = 'ORDER'
                                                                THEN ool.line_id
                                                              WHEN LINE_CATEGORY_CODE = 'RETURN'  
                                                                THEN   
                                                                to_number(NVL(SUBSTR(ool.ORIG_SYS_LINE_REF,
                                                                                     0,
                                                                                     INSTR(ool.ORIG_SYS_LINE_REF, '.') - 1),
                                                                              -1)) -- RMA FE OE Line Id
                                                                ELSE -1
                                                                  END
                              AND mtt.TRANSACTION_TYPE_ID = 52 --sales order pick FE ORDER
                              AND mtt.transaction_quantity < 0
                              AND mtt.inventory_item_id = ool.inventory_item_id
                              AND nvl(mtt.lpn_id, mtt.content_lpn_id) = nvl(lpn.lpn_id, -1)
                              AND ool.line_id = CASE
                                                  WHEN mtt.transaction_type_name = 'RMA Receipt'
                                                    THEN mmt.TRX_SOURCE_LINE_ID
                                                  WHEN mtt.transaction_type_name = 'GPO Nationalization Receipt'
                                                     THEN 
                                                      to_number(NVL(SUBSTR(RTRIM(LTRIM(translate(mmt.TRANSACTION_REFERENCE,translate(mmt.TRANSACTION_REFERENCE||'a','1234567890.',' '),' '))),
                                                         0,
                                                         INSTR(RTRIM(LTRIM(translate(mmt.TRANSACTION_REFERENCE,translate(mmt.TRANSACTION_REFERENCE||'a','1234567890.',' '),' '))), '.') - 1),
                                                  -1))
                                                  ELSE -1
                                                    END)
                              WHEN moq.subinventory_code = 'WHGU42GNAT'
                  THEN (SELECT listagg(wlp.license_plate_number,', ' ON OVERFLOW TRUNCATE)  
                            WITHIN GROUP (ORDER BY wlp.license_plate_number asc)
                        FROM   gems_ont.ge_gpo_nationalization_line gnl, 
                               gems_ont.ge_gpo_nationalization_line gn2,
                               apps.wms_license_plate_numbers       wlp,
                               apps.po_line_locations_all           pll,
                               apps.po_lines_all                    pol,
                               apps.po_headers_all                  poh,
                               apps.rcv_shipment_headers            rsh,
                               apps.rcv_transactions                rt
                        Where  wlp.lpn_id(+) = gn2.lpn_id
                        AND gnl.nationalization_so_line_id = gn2.nationalization_so_line_id
                        AND pll.line_location_id = gnl.DOCUMENT_ID
                        AND pll.po_header_id = poh.po_header_id
                        AND pll.po_line_id = pol.po_line_id
                        AND gn2.record_type = 'IMPORT'
                        AND gnl.record_type = 'NATIONALIZATION'
                        AND rt.transaction_id                = mmt.rcv_transaction_id
                        AND rt.po_line_location_id           = pll.line_location_id
                        AND rt.shipment_header_id            = rsh.shipment_header_id)
                ELSE (SELECT lpn.LICENSE_PLATE_NUMBER
                           FROM   apps.wms_license_plate_numbers   lpn
                           WHERE  nvl(mmt.lpn_id, mmt.content_lpn_id) = nvl(lpn.lpn_id, -1))
                        END LPN_Value                                    
             , 'q10' query
--, mmt.transaction_type_id
--, mmt.trx_source_line_id
--, mmt.source_line_id
           FROM apps.mtl_parameters                  mp
              , apps.mtl_system_items_b              msi
             , apps.mtl_secondary_inventories_fk_v  msifv
              , apps.gl_code_combinations            gcc
              , apps.gl_code_combinations_kfv        gcc1
              , apps.gl_code_combinations_kfv        gcc2
              , apps.gl_code_combinations_kfv        gcc3
              , apps.gl_code_combinations_kfv        gcc4
              , apps.gl_code_combinations_kfv        gcc5
              --, apps.mtl_item_locations_kfv          milk
              , AMARCHIVE.MTL_MATERIAL_TRANSACTIONS       mmt
              , apps.mtl_transaction_types           mtt
              , apps.mtl_txn_source_types            mtst
              , apps.fnd_flex_values_vl              ffvv
              , apps.fnd_flex_value_sets             ffvs
              , apps.fnd_user                        fu
              , ( SELECT organization_id
                       , inventory_item_id
                       , subinventory_code
                       , locator_id
                       , lot_number
                       --, transaction_uom_code
                       , create_transaction_id
                       , SUM (primary_transaction_quantity) onhand_qty
                    FROM apps.mtl_onhand_quantities_detail
                   WHERE organization_id IN (SELECT ood.organization_id FROM apps.org_organization_definitions ood WHERE ood.set_of_books_id = 230 )
                   GROUP BY organization_id
                          , inventory_item_id
                          , subinventory_code
                          , locator_id
                       --   , revision
                          , lot_number
                          --, transaction_uom_code
                          , create_transaction_id ) moq
                          ,APPS.MTL_PAC_ACTUAL_COST_DETAILS MPACD 
          WHERE 1                                = 1
          AND decode(mmt.periodic_primary_quantity,null,mmt.transfer_transaction_id,MMT.TRANSACTION_ID) = MPACD.TRANSACTION_ID  
            AND mp.organization_id               = msi.organization_id
--            AND msi.segment1 = '60510302'
            AND msifv.organization_id            = msi.organization_id
            AND msifv.secondary_inventory_name   = moq.subinventory_code
            AND msifv.material_account           = gcc1.code_combination_id
            AND msifv.outside_processing_account = gcc2.code_combination_id
            AND msifv.material_overhead_account  = gcc3.code_combination_id
            AND msifv.overhead_account           = gcc4.code_combination_id
            AND msifv.resource_account           = gcc5.code_combination_id
            AND msi.cost_of_sales_account       = gcc.code_combination_id
            AND ffvs.flex_value_set_name        = 'GE_GL_AFF_ES_PRODUCT_LINE'
            AND ffvs.flex_value_set_id          = ffvv.flex_value_set_id
            AND ffvv.flex_value_meaning         = gcc.segment8
            AND 'TYPE 1'                        IN ('TYPE 1')
            AND msi.organization_id             IN (SELECT ood.organization_id FROM apps.org_organization_definitions ood WHERE ood.set_of_books_id = 230 )
            AND moq.inventory_item_id           = msi.inventory_item_id
            AND moq.organization_id             = msi.organization_id
            --AND moq.locator_id                  = milk.inventory_location_id
            AND moq.create_transaction_id       = mmt.transaction_id
--    AND MMT.TRANSACTION_ID = 2562828197
            AND mtt.transaction_type_id         = mmt.transaction_type_id 
            AND mtst.transaction_source_type_id = mmt.transaction_source_type_id
            AND msi.serial_number_control_code  = '1' 
            AND msi.lot_control_code            = '2'  --Com controle de Lote
            AND moq.locator_id                  IS NULL
            AND fu.user_id                      = mmt.created_by 
    AND MMT.TRANSACTION_ID NOT IN(SELECT MMT2.TRANSACTION_ID 
                                  FROM APPS.MTL_MATERIAL_TRANSACTIONS MMT2
                                  WHERE MMT2.TRANSACTION_ID = MMT.TRANSACTION_ID)
------------------------------------------------------------------------------
UNION  
------------------------------------------------------------------------------  
-- Com Controle de Serial e Sem Controle de Lote e com Locator
         SELECT DISTINCT  --'11' NUM
        /* ( SELECT ccg.cost_group 
                             FROM apps.cst_cost_groups            ccg
                                , apps.cst_cost_group_assignments ccga
                            WHERE ccga.cost_group_id     = ccg.cost_group_id
                              AND ccga.organization_id   = mp.organization_id )  cost_group*/
            ( SELECT ccg.cost_group 
                             FROM apps.cst_cost_groups            ccg
                            WHERE MPACD.cost_group_id     = ccg.cost_group_id )  cost_group  
              , ( SELECT ( SELECT cpp1.period_name 
                             FROM apps.cst_pac_item_costs   cst
                                , apps.cst_pac_periods      cpp1
                            WHERE cst.pac_period_id     = (SELECT MAX(PAC_PERIOD_ID)                   FROM APPS.CST_PAC_PERIODS                  WHERE LEGAL_ENTITY = (SELECT LEGAL_ENTITY                                          FROM APPS.ORG_ORGANIZATION_DEFINITIONS OOD                                         WHERE OOD.ORGANIZATION_ID = mp.organization_id                                         ) )
                              AND cst.pac_period_id     = cpp1.pac_period_id
                              AND cst.inventory_item_id = msi.inventory_item_id
                              AND cst.cost_group_id     = ccg.cost_group_id )  
                    FROM apps.cst_cost_groups            ccg
                       , apps.cst_cost_group_assignments ccga
                   WHERE ccga.cost_group_id     = ccg.cost_group_id
                     AND ccga.organization_id   = mp.organization_id ) period_name
              , mp.organization_code
              , mp.attribute7                organization_type
              , mp.organization_id 
              , moq.subinventory_code
              , msifv.description            subinv_description
              , milk.concatenated_segments   locators
              , DECODE( msifv.asset_inventory, 1 , 'Asset', 2, 'Non Asset')   asset_type
              , msi.segment1                 part_number
              , DECODE(msi.inventory_asset_flag, NULL, 'No', 'N', 'No', 'Y', 'Yes')                         flag_asset_inventory
              , DECODE(msi.costing_enabled_flag, NULL, 'No', 'N', 'No', 'Y', 'Yes')                         flag_de_custo
              , msi.description              descrip_eng
              , msi.attribute3               descrip_ptb
              , msi.creation_date            item_creation_date
              , (trunc(SYSDATE) - trunc(msi.creation_date))      days_from_creation
              , gcc.segment8                                     product_line
              , ffvv.description                                 desc_prod_line   
              , msi.primary_uom_code    uom
              , DECODE (msi.serial_number_control_code, 1, moq.onhand_qty, 1)    transaction_quantity
              , NVL(( SELECT cic.item_cost
                        FROM apps.cst_item_costs cic
                       WHERE cic.organization_id   = msi.organization_id
                         AND cic.inventory_item_id = msi.inventory_item_id
                         AND cic.cost_type_id      = 1 ),0)  custo_unit_inv
               /*, nvl(( SELECT ( SELECT ROUND (cst.item_cost,2) 
                                 FROM apps.cst_pac_item_costs   cst
                                WHERE cst.pac_period_id     = (SELECT MAX(PAC_PERIOD_ID)                   FROM APPS.CST_PAC_PERIODS                  WHERE LEGAL_ENTITY = (SELECT LEGAL_ENTITY                                          FROM APPS.ORG_ORGANIZATION_DEFINITIONS OOD                                         WHERE OOD.ORGANIZATION_ID = mp.organization_id                                         ) )
                                  AND cst.inventory_item_id = msi.inventory_item_id
                                  AND cst.cost_group_id     = ccg.cost_group_id )  item_cost
                        FROM apps.cst_cost_groups            ccg
                           , apps.cst_cost_group_assignments ccga
                       WHERE ccga.cost_group_id     = ccg.cost_group_id
                         AND ccga.organization_id   = mp.organization_id ) ,0) custo_unit_pac*/
                , nvl((SELECT ROUND (cst.item_cost,2) 
                       FROM apps.cst_pac_item_costs   cst
                      WHERE cst.pac_period_id     = (SELECT MAX(PAC_PERIOD_ID)                   
                                                                FROM APPS.CST_PAC_PERIODS                  
                                                                WHERE LEGAL_ENTITY = (SELECT LEGAL_ENTITY                                         
                                                                                        FROM APPS.ORG_ORGANIZATION_DEFINITIONS OOD                                        
                                                                                        WHERE OOD.ORGANIZATION_ID = mp.organization_id
                                                        ) )
                        AND cst.inventory_item_id = msi.inventory_item_id
                        AND cst.cost_group_id     = MPACD.cost_group_id),0)  custo_unit_pac
              , NULL  lot_number
              , NULL  lot_creation_date
              , NULL  lot_qty_days_creation
              , NULL  lot_expiration_date
              , msn.serial_number
              , msn.creation_date   serial_creation_date
              , mtt.transaction_type_name           last_transaction_type
              , mmt.transaction_source_name         last_transaction_source
              , mtst.transaction_source_type_name   last_source_type
              , mmt.source_code
              , TO_CHAR(mmt.transaction_date, 'DD-MON-RRRR')      transaction_date
        , (SELECT TO_CHAR(mmt1.transaction_date, 'DD-MON-RRRR') 
          FROM apps.mtl_material_transactions mmt1
          WHERE mmt1.transaction_type_id=420
          AND mmt1.source_line_id=mmt.source_line_id) initial_consignment_date    
              , (TRUNC ( SYSDATE )- TRUNC(mmt.transaction_date))  transaction_qty_of_days
              , TO_CHAR(mmt.transaction_reference)                transaction_reference
              , CASE WHEN mmt.source_code = '3PL_REMITTANCE_BRAZIL' THEN
                     (SELECT listagg(pha.segment1,', ' ON OVERFLOW TRUNCATE)  
                      WITHIN GROUP (ORDER BY pha.segment1 asc)
                        FROM apps.po_headers_all        pha,
                             apps.po_lines_all          pla
                       WHERE pla.po_line_id   = mmt.source_line_id
                         AND pla.po_header_id = pha.po_header_id)
                     WHEN mmt.source_code IN ('ORDER ENTRY','IIP') THEN
                        NULL
                     WHEN mmt.source_code = 'RCV' THEN
                        ( SELECT listagg(pha.segment1,', ' ON OVERFLOW TRUNCATE)  
                          WITHIN GROUP (ORDER BY pha.segment1 asc)
                            FROM apps.po_headers_all            pha
                               , apps.po_lines_all              pla
                               , apps.po_line_locations_all     plla
                               , apps.rcv_shipment_headers      rsh
                               , apps.rcv_transactions          rt
                           WHERE rt.transaction_id                = mmt.rcv_transaction_id
                             AND rt.po_line_location_id           = plla.line_location_id
                             AND plla.po_line_id                  = pla.po_line_id
                             AND pha.po_header_id                 = pla.po_header_id
                             AND rt.shipment_header_id            = rsh.shipment_header_id
                             AND rsh.receipt_source_code          = 'VENDOR'  )
                     ELSE
                        NULL
                END      po_number
              , CASE WHEN mmt.source_code = '3PL_REMITTANCE_BRAZIL' THEN
                     (SELECT listagg(aps.vendor_name,', ' ON OVERFLOW TRUNCATE)  
                      WITHIN GROUP (ORDER BY aps.vendor_name asc)
                        FROM apps.po_headers_all        pha
                           , apps.po_lines_all          pla
                           , apps.ap_suppliers          aps
                           , apps.ap_supplier_sites_all  apss
                       WHERE pla.po_line_id     = mmt.source_line_id
                         AND pla.po_header_id   = pha.po_header_id
                         AND pha.vendor_id      = aps.vendor_id
                         AND aps.vendor_id      = apss.vendor_id
                         AND pha.vendor_site_id = apss.vendor_site_id )
                     WHEN mmt.source_code IN ('ORDER ENTRY','IIP') THEN
                        NULL
                     WHEN mmt.source_code = 'RCV' THEN
                        ( SELECT listagg(aps.vendor_name,', ' ON OVERFLOW TRUNCATE)  
                          WITHIN GROUP (ORDER BY aps.vendor_name asc)
                            FROM apps.po_headers_all            pha
                               , apps.po_lines_all              pla
                               , apps.po_line_locations_all     plla
                               , apps.rcv_shipment_headers      rsh
                               , apps.rcv_transactions          rt
                               , apps.ap_suppliers              aps
                               , apps.ap_supplier_sites_all     apss
                           WHERE rt.transaction_id          = mmt.rcv_transaction_id
                             AND rt.po_line_location_id     = plla.line_location_id
                             AND plla.po_line_id            = pla.po_line_id
                             AND pha.po_header_id           = pla.po_header_id
                             AND rt.shipment_header_id      = rsh.shipment_header_id
                             AND rsh.receipt_source_code    = 'VENDOR'
                             AND pha.vendor_id              = aps.vendor_id
                             AND aps.vendor_id              = apss.vendor_id
                             AND pha.vendor_site_id         = apss.vendor_site_id  )
                     ELSE
                        NULL
                END     po_supplier
              , CASE WHEN mmt.source_code = '3PL_REMITTANCE_BRAZIL' THEN
                     ( SELECT listagg(cfi.invoice_num,', ' ON OVERFLOW TRUNCATE)  
                         WITHIN GROUP (ORDER BY cfi.invoice_num asc)
                         FROM apps.cll_f189_invoice_lines cfil
                            , apps.cll_f189_invoices      cfi
                            , apps.po_lines_all           pla
                            , apps.po_line_locations_all  plla
                        WHERE plla.po_line_id       = pla.po_line_id
                          AND pla.po_line_id        = mmt.source_line_id
                          AND plla.line_location_id = cfil.line_location_id
                          AND cfil.invoice_id       = cfi.invoice_id )
                     WHEN mmt.source_code IN ('ORDER ENTRY','IIP') THEN
                        NULL
                     WHEN mmt.source_code = 'RCV' THEN
                        ( SELECT listagg(cfi.invoice_num,', ' ON OVERFLOW TRUNCATE)  
                            WITHIN GROUP (ORDER BY cfi.invoice_num asc)
                            FROM apps.po_headers_all            pha
                               , apps.po_lines_all              pla
                               , apps.po_line_locations_all     plla
                               , apps.cll_f189_invoice_lines    cfil
                               , apps.cll_f189_invoices         cfi
                               , apps.rcv_shipment_headers      rsh
                               , apps.rcv_transactions          rt
                           WHERE rt.transaction_id          = mmt.rcv_transaction_id
                             AND rt.po_line_location_id     = plla.line_location_id
                             AND plla.line_location_id      = cfil.line_location_id
                             AND cfil.invoice_id            = cfi.invoice_id
                             AND plla.po_line_id            = pla.po_line_id
                             AND pha.po_header_id           = pla.po_header_id
                             AND rt.shipment_header_id      = rsh.shipment_header_id
                             AND rsh.receipt_source_code    = 'VENDOR'   )
                     ELSE
                        NULL
                END    NF_RI
             , (SELECT DECODE( mmt.source_code, '3PL_REMITTANCE_BRAZIL',NULL,to_char(ooha.order_number) )
                  FROM apps.oe_order_headers_all  ooha,
                       apps.oe_order_lines_all    oola  
                 WHERE oola.line_id        = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                   AND oola.header_id      = ooha.header_id )   order_number
               -- 
               -- alterado para BIll_to por Sinval inicio
               --
               , CASE WHEN ( SELECT ottl.name
                             FROM apps.oe_transaction_types_tl    ottl
                                , apps.oe_order_headers_all  ooha
                                , apps.oe_order_lines_all    oola  
                            WHERE oola.line_id        = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND oola.header_id      = ooha.header_id
                              AND ooha.order_type_id  = ottl.transaction_type_id  ) = 'GPO_BR_FE_SHIPMENT' THEN
                     (SELECT listagg(hp.party_name,', ' ON OVERFLOW TRUNCATE)  
                      WITHIN GROUP (ORDER BY hp.party_name asc)
                        FROM apps.hz_parties             hp
                           , apps.hz_cust_accounts       hca
                           , apps.oe_order_lines_all     oola
                           , apps.hz_cust_acct_sites_all hcas
                           , apps.hz_cust_site_uses_all  hcsu
                       WHERE oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                         AND oola.end_customer_site_use_id  = hcsu.site_use_id
                         AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                         AND hcas.cust_account_id           = hca.cust_account_id
                         AND hca.party_id                   = hp.party_id )
                  ELSE
                     CASE WHEN (mmt.source_code = '3PL_REMITTANCE_BRAZIL') THEN
                       (SELECT listagg(hp.party_name,', ' ON OVERFLOW TRUNCATE)  
                        WITHIN GROUP (ORDER BY hp.party_name asc)
                          FROM apps.hz_parties             hp,
                               apps.hz_cust_accounts       hca,
                               apps.ra_customer_trx_all    rcta,
                               apps.hz_cust_acct_sites_all hcas,
                               apps.hz_cust_site_uses_all  hcsu
                         WHERE rcta.interface_header_attribute1 = mp.organization_code||'_'||mmt.transaction_reference
                           AND rcta.ship_to_site_use_id         = hcsu.site_use_id
                           AND hcsu.cust_acct_site_id           = hcas.cust_acct_site_id
                           AND hcas.cust_account_id             = hca.cust_account_id
                           AND hca.party_id                     = hp.party_id
                           AND rcta.org_id                      = 4330)
                     ELSE
                        (SELECT listagg(hp.party_name,', ' ON OVERFLOW TRUNCATE)  
                         WITHIN GROUP (ORDER BY hp.party_name asc)
                           FROM apps.hz_parties             hp
                              , apps.hz_cust_accounts       hca
                              , apps.oe_order_lines_all     oola
                              , apps.hz_cust_acct_sites_all hcas
                              , apps.hz_cust_site_uses_all  hcsu
                          WHERE oola.line_id                = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                            AND oola.ship_to_org_id         = hcsu.site_use_id
                            AND hcsu.cust_acct_site_id      = hcas.cust_acct_site_id
                            AND hcas.cust_account_id        = hca.cust_account_id
                            AND hca.party_id                = hp.party_id )
                    END                 
               END    customer_name
             , CASE WHEN ( SELECT ottl.name
                             FROM apps.oe_transaction_types_tl    ottl
                                , apps.oe_order_headers_all  ooha
                                , apps.oe_order_lines_all    oola  
                            WHERE oola.line_id        = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND oola.header_id      = ooha.header_id
                              AND ooha.order_type_id  = ottl.transaction_type_id  ) = 'GPO_BR_FE_SHIPMENT' THEN
                     (SELECT listagg(hca.account_number,', ' ON OVERFLOW TRUNCATE)  
                      WITHIN GROUP (ORDER BY hca.account_number asc)
                        FROM apps.hz_parties             hp
                           , apps.hz_cust_accounts       hca
                           , apps.oe_order_lines_all     oola
                           , apps.hz_cust_acct_sites_all hcas
                           , apps.hz_cust_site_uses_all  hcsu
                       WHERE oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                         AND oola.end_customer_site_use_id  = hcsu.site_use_id
                         AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                         AND hcas.cust_account_id           = hca.cust_account_id
                         AND hca.party_id                   = hp.party_id )
                  ELSE
                     CASE WHEN (mmt.source_code = '3PL_REMITTANCE_BRAZIL') THEN
                        (SELECT listagg(hca.account_number,', ' ON OVERFLOW TRUNCATE)  
                         WITHIN GROUP (ORDER BY hca.account_number asc)
                           FROM apps.hz_parties             hp,
                                apps.hz_cust_accounts       hca,
                                apps.ra_customer_trx_all    rcta,
                                apps.hz_cust_acct_sites_all hcas,
                                apps.hz_cust_site_uses_all  hcsu
                          WHERE rcta.interface_header_attribute1 = mp.organization_code||'_'||mmt.transaction_reference
                            AND rcta.ship_to_site_use_id         = hcsu.site_use_id
                            AND hcsu.cust_acct_site_id           = hcas.cust_acct_site_id
                            AND hcas.cust_account_id             = hca.cust_account_id
                            AND hca.party_id                     = hp.party_id
                            AND rcta.org_id                      = 4330)
                     ELSE
                        (SELECT listagg(hca.account_number,', ' ON OVERFLOW TRUNCATE)  
                         WITHIN GROUP (ORDER BY hca.account_number asc)
                           FROM apps.hz_parties             hp
                              , apps.hz_cust_accounts       hca
                              , apps.oe_order_lines_all     oola
                              , apps.hz_cust_acct_sites_all hcas
                              , apps.hz_cust_site_uses_all  hcsu
                          WHERE oola.line_id                = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                            AND oola.ship_to_org_id         = hcsu.site_use_id
                            AND hcsu.cust_acct_site_id      = hcas.cust_acct_site_id
                            AND hcas.cust_account_id        = hca.cust_account_id
                            AND hca.party_id                = hp.party_id   )
                     END
                  END   customer_number
              --
              , CASE WHEN ( SELECT ottl.name
                             FROM apps.oe_transaction_types_tl    ottl
                                , apps.oe_order_headers_all  ooha
                                , apps.oe_order_lines_all    oola  
                            WHERE oola.line_id        = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND oola.header_id      = ooha.header_id
                              AND ooha.order_type_id  = ottl.transaction_type_id  ) = 'GPO_BR_FE_SHIPMENT' THEN
                     (SELECT listagg(DECODE(hcas.global_attribute2
                                           , '2',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'/'|| hcas.global_attribute4 ||'-'|| hcas.global_attribute5
                                           , '1',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'-'|| hcas.global_attribute5 
                                           , '3',HCSU.LOCATION||' - '||hcas.global_attribute3 ),', ' ON OVERFLOW TRUNCATE)
                     WITHIN GROUP (ORDER BY hcas.global_attribute2 asc ) 
                        FROM apps.hz_parties             hp
                           , apps.hz_cust_accounts       hca
                           , apps.oe_order_lines_all     oola
                           , apps.hz_cust_acct_sites_all hcas
                           , apps.hz_cust_site_uses_all  hcsu
                       WHERE oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                         AND oola.end_customer_site_use_id  = hcsu.site_use_id
                         AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                         AND hcas.cust_account_id           = hca.cust_account_id
                         AND hca.party_id                   = hp.party_id )
                ELSE
                   CASE WHEN (mmt.source_code = '3PL_REMITTANCE_BRAZIL') THEN
                      (SELECT listagg(DECODE(hcas.global_attribute2
                                           , '2',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'/'|| hcas.global_attribute4 ||'-'|| hcas.global_attribute5
                                           , '1',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'-'|| hcas.global_attribute5 
                                           , '3',HCSU.LOCATION||' - '||hcas.global_attribute3 ),', ' ON OVERFLOW TRUNCATE)
                     WITHIN GROUP (ORDER BY hcas.global_attribute2 asc) 
                         FROM apps.ra_customer_trx_all     rcta
                            , apps.hz_cust_acct_sites_all  hcas
                            , apps.hz_cust_site_uses_all   hcsu
                        WHERE rcta.interface_header_attribute1 = mp.organization_code||'_'||mmt.transaction_reference
                          AND rcta.ship_to_site_use_id         = hcsu.site_use_id
                          AND hcsu.cust_acct_site_id           = hcas.cust_acct_site_id
                          AND rcta.org_id                      = 4330)
                   ELSE
                      (SELECT listagg(DECODE(hcas.global_attribute2
                                           , '2',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'/'|| hcas.global_attribute4 ||'-'|| hcas.global_attribute5
                                           , '1',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'-'|| hcas.global_attribute5 
                                           , '3',HCSU.LOCATION||' - '||hcas.global_attribute3 ),', ' ON OVERFLOW TRUNCATE)
                      WITHIN GROUP (ORDER BY hcas.global_attribute2 asc) 
                         FROM apps.hz_parties             hp
                            , apps.hz_cust_accounts       hca
                            , apps.oe_order_lines_all     oola
                            , apps.hz_cust_acct_sites_all hcas
                            , apps.hz_cust_site_uses_all  hcsu
                        WHERE oola.line_id                = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                          AND oola.ship_to_org_id         = hcsu.site_use_id
                          AND hcsu.cust_acct_site_id      = hcas.cust_acct_site_id
                          AND hcas.cust_account_id        = hca.cust_account_id
                          AND hca.party_id                = hp.party_id  )
                   END
                END  customer_cnpj_cpf
               -- 
              , CASE WHEN (mmt.source_code = '3PL_REMITTANCE_BRAZIL') THEN
                      (SELECT listagg(DECODE(hcas.global_attribute2
                                           , '2',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'/'|| hcas.global_attribute4 ||'-'|| hcas.global_attribute5
                                           , '1',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'-'|| hcas.global_attribute5 
                                           , '3',HCSU.LOCATION||' - '||hcas.global_attribute3 ),', ' ON OVERFLOW TRUNCATE)
                       WITHIN GROUP (ORDER BY hcas.global_attribute2 asc )
                         FROM apps.ra_customer_trx_all         rcta
                            , apps.hz_cust_acct_sites_all      hcas
                            , apps.hz_cust_site_uses_all       hcsu
                        WHERE rcta.interface_header_attribute1 = mp.organization_code||'_'||mmt.transaction_reference
                          AND rcta.bill_to_site_use_id         = hcsu.site_use_id
                          AND hcsu.cust_acct_site_id           = hcas.cust_acct_site_id
                          AND rcta.org_id                      = 4330
                          AND ROWNUM = 1)
                   ELSE
                     --
                     CASE WHEN (select DISTINCT RCTL.INTERFACE_LINE_CONTEXT
                             FROM apps.hz_parties                hp
                                , apps.hz_cust_accounts          hca
                                , apps.oe_order_lines_all        oola
                                , apps.oe_order_headers_all      ooha
                                , apps.ra_customer_trx_lines_all rctl
                                , apps.ra_customer_trx_all       rcta
                                , apps.hz_cust_acct_sites_all    hcas
                                , apps.hz_cust_site_uses_all     hcsu
                            WHERE ooha.header_id                 = oola.header_id
                              AND oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND rctl.inventory_item_id         = oola.inventory_item_id
                              AND rctl.line_type                 = 'LINE'
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE1 = to_char(ooha.order_number)
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE6 = to_char(oola.line_id)
                              AND RCTL.INTERFACE_LINE_CONTEXT    = 'ORDER ENTRY'
                              AND rctl.customer_trx_id           = rcta.customer_trx_id
                              AND rcta.bill_to_site_use_id       = hcsu.site_use_id
                              AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                              AND hcas.cust_account_id           = hca.cust_account_id
                              AND hca.party_id                   = hp.party_id 
                              AND ROWNUM = 1) = 'ORDER ENTRY' THEN
                     --
                     (SELECT DISTINCT DECODE(hcas.global_attribute2
                                           , '2',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'/'|| hcas.global_attribute4 ||'-'|| hcas.global_attribute5
                                           , '1',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'-'|| hcas.global_attribute5 
                                           , '3',HCSU.LOCATION||' - '||hcas.global_attribute3)
                             FROM apps.hz_parties                hp
                                , apps.hz_cust_accounts          hca
                                , apps.oe_order_lines_all        oola
                                , apps.oe_order_headers_all      ooha
                                , apps.ra_customer_trx_lines_all rctl
                                , apps.ra_customer_trx_all       rcta
                                , apps.hz_cust_acct_sites_all    hcas
                                , apps.hz_cust_site_uses_all     hcsu
                            WHERE ooha.header_id                 = oola.header_id
                              AND oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND rctl.inventory_item_id         = oola.inventory_item_id
                              AND rctl.line_type                 = 'LINE'
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE1 = to_char(ooha.order_number)
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE6 = to_char(oola.line_id)
                              AND RCTL.INTERFACE_LINE_CONTEXT    = 'ORDER ENTRY'
                              AND rctl.customer_trx_id           = rcta.customer_trx_id
                              AND rcta.bill_to_site_use_id       = hcsu.site_use_id
                              AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                              AND hcas.cust_account_id           = hca.cust_account_id
                              AND hca.party_id                   = hp.party_id
                              AND ROWNUM = 1)
                     --
                     ELSE
                     --            
                     CASE WHEN 
                          ( SELECT DISTINCT RCTL.INTERFACE_LINE_CONTEXT
                             FROM apps.hz_parties                hp
                                , apps.hz_cust_accounts          hca
                                , apps.oe_order_lines_all        oola
                                , apps.oe_order_headers_all      ooha
                                , apps.ra_customer_trx_lines_all rctl
                                , apps.ra_customer_trx_all       rcta
                                , apps.hz_cust_acct_sites_all    hcas
                                , apps.hz_cust_site_uses_all     hcsu
                            WHERE ooha.header_id                 = oola.header_id
                              AND oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND rctl.inventory_item_id         = oola.inventory_item_id
                              AND rctl.line_type                 = 'LINE'
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE1 = ooha.ORIG_SYS_DOCUMENT_REF
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE7 = oola.ORIG_SYS_LINE_REF
                              AND RCTL.INTERFACE_LINE_CONTEXT    = 'GEMS_PB_RR'
                              AND rctl.customer_trx_id           = rcta.customer_trx_id
                              AND rcta.bill_to_site_use_id       = hcsu.site_use_id
                              AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                              AND hcas.cust_account_id           = hca.cust_account_id
                              AND ROWNUM = 1 ) = 'GEMS_PB_RR' THEN
                     --
                     (SELECT DISTINCT DECODE(hcas.global_attribute2
                                           , '2',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'/'|| hcas.global_attribute4 ||'-'|| hcas.global_attribute5
                                           , '1',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'-'|| hcas.global_attribute5 
                                           , '3',HCSU.LOCATION||' - '||hcas.global_attribute3)
                             FROM apps.hz_parties                hp
                                , apps.hz_cust_accounts          hca
                                , apps.oe_order_lines_all        oola
                                , apps.oe_order_headers_all      ooha
                                , apps.ra_customer_trx_lines_all rctl
                                , apps.ra_customer_trx_all       rcta
                                , apps.hz_cust_acct_sites_all    hcas
                                , apps.hz_cust_site_uses_all     hcsu
                            WHERE ooha.header_id                 = oola.header_id
                              AND oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND rctl.inventory_item_id         = oola.inventory_item_id
                              AND rctl.line_type                 = 'LINE'
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE1 = ooha.ORIG_SYS_DOCUMENT_REF
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE7 = oola.ORIG_SYS_LINE_REF
                              AND RCTL.INTERFACE_LINE_CONTEXT    = 'GEMS_PB_RR'
                              AND rctl.customer_trx_id           = rcta.customer_trx_id
                              AND rcta.bill_to_site_use_id       = hcsu.site_use_id
                              AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                              AND hcas.cust_account_id           = hca.cust_account_id 
                              AND ROWNUM = 1 )
                     --
                     ELSE
                     --
                     (SELECT DISTINCT DECODE(hcas.global_attribute2
                                   , '2',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'/'|| hcas.global_attribute4 ||'-'|| hcas.global_attribute5
                                   , '1',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'-'|| hcas.global_attribute5 
                                   , '3',HCSU.LOCATION||' - '||hcas.global_attribute3)
                             --
                      FROM   APPS.HZ_CUST_ACCT_SITES_ALL HCAS,
                             APPS.HZ_CUST_SITE_USES_ALL  HCSU,
                            APPS.OE_ORDER_LINES_ALL     OOLA,
                             APPS.OE_ORDER_HEADERS_ALL   OOHA
                             --
                      WHERE  HCSU.SITE_USE_CODE     = 'BILL_TO'
                      AND    HCSU.CUST_ACCT_SITE_ID = HCAS.CUST_ACCT_SITE_ID
                      AND    HCSU.SITE_USE_ID       = NVL(OOLA.ATTRIBUTE1, OOHA.INVOICE_TO_ORG_ID)
                      AND    OOLA.LINE_ID           = NVL(MMT.TRX_SOURCE_LINE_ID, MMT.SOURCE_LINE_ID)
                      AND    OOHA.HEADER_ID         = OOLA.HEADER_ID
                      AND    ROWNUM = 1)
                     --
                     END
                  END
               END      bill_to_CNPJ_CPF
               --
                             --
              , CASE WHEN (mmt.source_code = '3PL_REMITTANCE_BRAZIL') THEN
                        (SELECT listagg(hp.party_name,', ' ON OVERFLOW TRUNCATE)  
                        WITHIN GROUP (ORDER BY hp.party_name asc)
                          FROM apps.hz_parties             hp,
                               apps.hz_cust_accounts       hca,
                               apps.ra_customer_trx_all    rcta,
                               apps.hz_cust_acct_sites_all hcas,
                               apps.hz_cust_site_uses_all  hcsu
                         WHERE rcta.interface_header_attribute1 = mp.organization_code||'_'||mmt.transaction_reference
                           AND rcta.bill_to_site_use_id         = hcsu.site_use_id
                           AND hcsu.cust_acct_site_id           = hcas.cust_acct_site_id
                           AND hcas.cust_account_id             = hca.cust_account_id
                           AND hca.party_id                     = hp.party_id
                           AND rcta.org_id                      = 4330)
                   ELSE
                     --
                     CASE WHEN (select DISTINCT RCTL.INTERFACE_LINE_CONTEXT
                             FROM apps.hz_parties                hp
                                , apps.hz_cust_accounts          hca
                                , apps.oe_order_lines_all        oola
                                , apps.oe_order_headers_all      ooha
                                , apps.ra_customer_trx_lines_all rctl
                                , apps.ra_customer_trx_all       rcta
                                , apps.hz_cust_acct_sites_all    hcas
                                , apps.hz_cust_site_uses_all     hcsu
                            WHERE ooha.header_id                 = oola.header_id
                              AND oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND rctl.inventory_item_id         = oola.inventory_item_id
                              AND rctl.line_type                 = 'LINE'
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE1 = to_char(ooha.order_number)
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE6 = to_char(oola.line_id)
                              AND RCTL.INTERFACE_LINE_CONTEXT    = 'ORDER ENTRY'
                              AND rctl.customer_trx_id           = rcta.customer_trx_id
                              AND rcta.bill_to_site_use_id       = hcsu.site_use_id
                              AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                              AND hcas.cust_account_id           = hca.cust_account_id
                              AND hca.party_id                   = hp.party_id 
                              AND ROWNUM = 1) = 'ORDER ENTRY' THEN
                     --
                     (SELECT listagg(hp.party_name,', ' ON OVERFLOW TRUNCATE)  
                         WITHIN GROUP (ORDER BY hp.party_name asc)
                             FROM apps.hz_parties                hp
                                , apps.hz_cust_accounts          hca
                                , apps.oe_order_lines_all        oola
                                , apps.oe_order_headers_all      ooha
                                , apps.ra_customer_trx_lines_all rctl
                                , apps.ra_customer_trx_all       rcta
                                , apps.hz_cust_acct_sites_all    hcas
                                , apps.hz_cust_site_uses_all     hcsu
                            WHERE ooha.header_id                 = oola.header_id
                              AND oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND rctl.inventory_item_id         = oola.inventory_item_id
                              AND rctl.line_type                 = 'LINE'
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE1 = to_char(ooha.order_number)
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE6 = to_char(oola.line_id)
                              AND RCTL.INTERFACE_LINE_CONTEXT    = 'ORDER ENTRY'
                              AND rctl.customer_trx_id           = rcta.customer_trx_id
                              AND rcta.bill_to_site_use_id       = hcsu.site_use_id
                              AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                              AND hcas.cust_account_id           = hca.cust_account_id
                              AND hca.party_id                   = hp.party_id
                              AND ROWNUM = 1)
                     --
                     ELSE
                     --            
                     CASE WHEN 
                          ( SELECT DISTINCT RCTL.INTERFACE_LINE_CONTEXT
                             FROM apps.hz_parties                hp
                                , apps.hz_cust_accounts          hca
                                , apps.oe_order_lines_all        oola
                                , apps.oe_order_headers_all      ooha
                                , apps.ra_customer_trx_lines_all rctl
                                , apps.ra_customer_trx_all       rcta
                                , apps.hz_cust_acct_sites_all    hcas
                                , apps.hz_cust_site_uses_all     hcsu
                            WHERE ooha.header_id                 = oola.header_id
                              AND oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND rctl.inventory_item_id         = oola.inventory_item_id
                              AND rctl.line_type                 = 'LINE'
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE1 = ooha.ORIG_SYS_DOCUMENT_REF
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE7 = oola.ORIG_SYS_LINE_REF
                              AND RCTL.INTERFACE_LINE_CONTEXT    = 'GEMS_PB_RR'
                              AND rctl.customer_trx_id           = rcta.customer_trx_id
                              AND rcta.bill_to_site_use_id       = hcsu.site_use_id
                              AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                              AND hcas.cust_account_id           = hca.cust_account_id
                              AND ROWNUM = 1 ) = 'GEMS_PB_RR' THEN
                     --
                     (SELECT listagg(hp.party_name,', ' ON OVERFLOW TRUNCATE)  
                         WITHIN GROUP (ORDER BY hp.party_name asc)
                             FROM apps.hz_parties                hp
                                , apps.hz_cust_accounts          hca
                                , apps.oe_order_lines_all        oola
                                , apps.oe_order_headers_all      ooha
                                , apps.ra_customer_trx_lines_all rctl
                                , apps.ra_customer_trx_all       rcta
                                , apps.hz_cust_acct_sites_all    hcas
                                , apps.hz_cust_site_uses_all     hcsu
                            WHERE ooha.header_id                 = oola.header_id
                              AND oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND rctl.inventory_item_id         = oola.inventory_item_id
                              AND rctl.line_type                 = 'LINE'
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE1 = ooha.ORIG_SYS_DOCUMENT_REF
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE7 = oola.ORIG_SYS_LINE_REF
                              AND RCTL.INTERFACE_LINE_CONTEXT    = 'GEMS_PB_RR'
                              AND rctl.customer_trx_id           = rcta.customer_trx_id
                              AND rcta.bill_to_site_use_id       = hcsu.site_use_id
                              AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                              AND hcas.cust_account_id           = hca.cust_account_id 
                              AND ROWNUM = 1 )
                     --
                     ELSE
                     --
                     (SELECT listagg(hp.party_name,', ' ON OVERFLOW TRUNCATE)  
                         WITHIN GROUP (ORDER BY hp.party_name asc)
                      FROM   APPS.HZ_CUST_ACCT_SITES_ALL HCAS,
                             apps.hz_parties             hp,
                             apps.hz_cust_accounts       hca,
                             APPS.HZ_CUST_SITE_USES_ALL  HCSU,
                             APPS.OE_ORDER_LINES_ALL     OOLA,
                             APPS.OE_ORDER_HEADERS_ALL   OOHA
                             --
                      WHERE  HCSU.SITE_USE_CODE     = 'BILL_TO'
                      AND    HCSU.CUST_ACCT_SITE_ID = HCAS.CUST_ACCT_SITE_ID
                      AND    HCSU.SITE_USE_ID       = NVL(OOLA.ATTRIBUTE1, OOHA.INVOICE_TO_ORG_ID)
                      AND    OOLA.LINE_ID           = NVL(MMT.TRX_SOURCE_LINE_ID, MMT.SOURCE_LINE_ID)
                      AND    OOHA.HEADER_ID         = OOLA.HEADER_ID
                      AND    hcas.cust_account_id   = hca.cust_account_id
                      AND    hca.party_id           = hp.party_id 
                      AND    ROWNUM = 1)
                     --          
                     END
                  END
               END      bill_to_Customer_name
               --
                , CASE WHEN (mmt.source_code = '3PL_REMITTANCE_BRAZIL') THEN
                      (SELECT listagg(DECODE(hcas.global_attribute2
                                           , '2',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'/'|| hcas.global_attribute4 ||'-'|| hcas.global_attribute5
                                           , '1',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'-'|| hcas.global_attribute5 
                                           , '3',HCSU.LOCATION||' - '||hcas.global_attribute3 ),', ' ON OVERFLOW TRUNCATE)
                       WITHIN GROUP (ORDER BY hcas.global_attribute2 asc )
                         FROM apps.ra_customer_trx_all         rcta
                            , apps.hz_cust_acct_sites_all      hcas
                            , apps.hz_cust_site_uses_all       hcsu
                        WHERE rcta.interface_header_attribute1 = mp.organization_code||'_'||mmt.transaction_reference
                          AND rcta.ship_to_site_use_id         = hcsu.site_use_id
                          AND hcsu.cust_acct_site_id           = hcas.cust_acct_site_id
                         AND rcta.org_id                      = 4330
                          AND ROWNUM = 1)
                   ELSE
                     --
                     CASE WHEN (select DISTINCT RCTL.INTERFACE_LINE_CONTEXT
                             FROM apps.hz_parties                hp
                                , apps.hz_cust_accounts          hca
                                , apps.oe_order_lines_all        oola
                                , apps.oe_order_headers_all      ooha
                                , apps.ra_customer_trx_lines_all rctl
                                , apps.ra_customer_trx_all       rcta
                                , apps.hz_cust_acct_sites_all    hcas
                                , apps.hz_cust_site_uses_all     hcsu
                            WHERE ooha.header_id                 = oola.header_id
                              AND oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND rctl.inventory_item_id         = oola.inventory_item_id
                              AND rctl.line_type                 = 'LINE'
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE1 = to_char(ooha.order_number)
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE6 = to_char(oola.line_id)
                              AND RCTL.INTERFACE_LINE_CONTEXT    = 'ORDER ENTRY'
                              AND rctl.customer_trx_id           = rcta.customer_trx_id
                              AND rcta.ship_to_site_use_id       = hcsu.site_use_id
                              AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                              AND hcas.cust_account_id           = hca.cust_account_id
                              AND hca.party_id                   = hp.party_id 
                              AND ROWNUM = 1) = 'ORDER ENTRY' THEN
                     --
                     (SELECT DISTINCT DECODE(hcas.global_attribute2
                                           , '2',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'/'|| hcas.global_attribute4 ||'-'|| hcas.global_attribute5
                                           , '1',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'-'|| hcas.global_attribute5 
                                           , '3',HCSU.LOCATION||' - '||hcas.global_attribute3)
                             FROM apps.hz_parties                hp
                                , apps.hz_cust_accounts          hca
                                , apps.oe_order_lines_all        oola
                                , apps.oe_order_headers_all      ooha
                                , apps.ra_customer_trx_lines_all rctl
                                , apps.ra_customer_trx_all       rcta
                                , apps.hz_cust_acct_sites_all    hcas
                                , apps.hz_cust_site_uses_all     hcsu
                            WHERE ooha.header_id                 = oola.header_id
                              AND oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND rctl.inventory_item_id         = oola.inventory_item_id
                              AND rctl.line_type                 = 'LINE'
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE1 = to_char(ooha.order_number)
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE6 = to_char(oola.line_id)
                              AND RCTL.INTERFACE_LINE_CONTEXT    = 'ORDER ENTRY'
                              AND rctl.customer_trx_id           = rcta.customer_trx_id
                              AND rcta.ship_to_site_use_id       = hcsu.site_use_id
                              AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                              AND hcas.cust_account_id           = hca.cust_account_id
                              AND hca.party_id                   = hp.party_id
                              AND ROWNUM = 1)
                     --
                     ELSE
                     --            
                     CASE WHEN 
                          ( SELECT DISTINCT RCTL.INTERFACE_LINE_CONTEXT
                             FROM apps.hz_parties                hp
                                , apps.hz_cust_accounts          hca
                                , apps.oe_order_lines_all        oola
                                , apps.oe_order_headers_all      ooha
                                , apps.ra_customer_trx_lines_all rctl
                                , apps.ra_customer_trx_all       rcta
                                , apps.hz_cust_acct_sites_all    hcas
                                , apps.hz_cust_site_uses_all     hcsu
                            WHERE ooha.header_id                 = oola.header_id
                              AND oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND rctl.inventory_item_id         = oola.inventory_item_id
                              AND rctl.line_type                 = 'LINE'
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE1 = ooha.ORIG_SYS_DOCUMENT_REF
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE7 = oola.ORIG_SYS_LINE_REF
                              AND RCTL.INTERFACE_LINE_CONTEXT    = 'GEMS_PB_RR'
                              AND rctl.customer_trx_id           = rcta.customer_trx_id
                              AND rcta.ship_to_site_use_id       = hcsu.site_use_id
                              AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                              AND hcas.cust_account_id           = hca.cust_account_id
                              AND ROWNUM = 1 ) = 'GEMS_PB_RR' THEN
                     --
                     (SELECT DISTINCT DECODE(hcas.global_attribute2
                                           , '2',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'/'|| hcas.global_attribute4 ||'-'|| hcas.global_attribute5
                                           , '1',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'-'|| hcas.global_attribute5 
                                           , '3',HCSU.LOCATION||' - '||hcas.global_attribute3)
                             FROM apps.hz_parties                hp
                                , apps.hz_cust_accounts          hca
                                , apps.oe_order_lines_all        oola
                                , apps.oe_order_headers_all      ooha
                                , apps.ra_customer_trx_lines_all rctl
                                , apps.ra_customer_trx_all       rcta
                                , apps.hz_cust_acct_sites_all    hcas
                                , apps.hz_cust_site_uses_all     hcsu
                            WHERE ooha.header_id                 = oola.header_id
                              AND oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND rctl.inventory_item_id         = oola.inventory_item_id
                              AND rctl.line_type                 = 'LINE'
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE1 = ooha.ORIG_SYS_DOCUMENT_REF
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE7 = oola.ORIG_SYS_LINE_REF
                              AND RCTL.INTERFACE_LINE_CONTEXT    = 'GEMS_PB_RR'
                              AND rctl.customer_trx_id           = rcta.customer_trx_id
                              AND rcta.ship_to_site_use_id       = hcsu.site_use_id
                              AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                              AND hcas.cust_account_id           = hca.cust_account_id 
                              AND ROWNUM = 1 )
                     --
                     ELSE
                     --
                     (SELECT listagg(DECODE(hcas.global_attribute2
                                           , '2',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'/'|| hcas.global_attribute4 ||'-'|| hcas.global_attribute5
                                           , '1',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'-'|| hcas.global_attribute5 
                                           , '3',HCSU.LOCATION||' - '||hcas.global_attribute3 ),', ' ON OVERFLOW TRUNCATE)
                      WITHIN GROUP (ORDER BY hcas.global_attribute2 asc) 
                         FROM apps.hz_parties             hp
                            , apps.hz_cust_accounts       hca
                            , apps.oe_order_lines_all     oola
                            , apps.hz_cust_acct_sites_all hcas
                            , apps.hz_cust_site_uses_all  hcsu
                        WHERE oola.line_id                = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                          AND oola.ship_to_org_id         = hcsu.site_use_id
                          AND hcsu.cust_acct_site_id      = hcas.cust_acct_site_id
                          AND hcas.cust_account_id        = hca.cust_account_id
                          AND hca.party_id                = hp.party_id  )
                     --
                     END
                  END
               END      ship_to_CNPJ_CPF
               --
              , CASE WHEN ( SELECT ottl.name
                              FROM apps.oe_transaction_types_tl    ottl
                                 , apps.oe_order_headers_all  ooha
                                 , apps.oe_order_lines_all    oola  
                             WHERE oola.line_id        = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                               AND oola.header_id      = ooha.header_id
                               AND ooha.order_type_id  = ottl.transaction_type_id  ) = 'GPO_BR_FE_SHIPMENT' THEN
                      (SELECT listagg(hzl.address1 ||' - '|| hzl.address2 || ' - ' || hzl.city || '-' || hzl.state || ' / ' || hzl.postal_code,', ' ON OVERFLOW TRUNCATE)  
                       WITHIN GROUP (ORDER BY hzl.address1 asc)
                       FROM apps.hz_parties             hp
                        , apps.hz_party_sites         hps
                        , apps.hz_cust_accounts       hca
                        , apps.oe_order_lines_all     oola
                        , apps.hz_cust_acct_sites_all hcas
                        , apps.hz_cust_site_uses_all  hcsu
                        , apps.hz_locations           hzl
                    WHERE oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                      AND oola.end_customer_site_use_id  = hcsu.site_use_id
                      AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                      AND hcas.cust_account_id           = hca.cust_account_id
                      AND hcas.party_site_id             = hps.party_site_id
                      AND hca.party_id                   = hp.party_id
                      AND hps.party_id                   = hp.party_id
                      AND hps.location_id                = hzl.location_id)
                ELSE
                   CASE WHEN (mmt.source_code = '3PL_REMITTANCE_BRAZIL') THEN
                      (SELECT listagg(hzl.address1 ||' - '|| hzl.address2 || ' - ' || hzl.city || '-' || hzl.state || ' / ' || hzl.postal_code,', ' ON OVERFLOW TRUNCATE)  
                       WITHIN GROUP (ORDER BY hzl.address1 asc)
                         FROM apps.ra_customer_trx_all     rcta
                            , apps.hz_cust_acct_sites_all  hcas
                            , apps.hz_cust_site_uses_all   hcsu
                            , apps.hz_parties              hp
                            , apps.hz_party_sites          hps
                            , apps.hz_cust_accounts        hca
                            , apps.hz_locations            hzl
                        WHERE rcta.interface_header_attribute1 = mp.organization_code||'_'||mmt.transaction_reference
                          AND rcta.ship_to_site_use_id         = hcsu.site_use_id
                          AND hcsu.cust_acct_site_id           = hcas.cust_acct_site_id
                          AND hcas.cust_account_id             = hca.cust_account_id
                          AND hcas.party_site_id               = hps.party_site_id
                          AND hca.party_id                     = hp.party_id
                          AND hps.party_id                     = hp.party_id
                          AND hps.location_id                  = hzl.location_id
                          AND rcta.org_id                      = 4330)
                   ELSE
                      (SELECT listagg(hzl.address1 ||' - '|| hzl.address2 || ' - ' || hzl.city || '-' || hzl.state || ' / ' || hzl.postal_code,', ' ON OVERFLOW TRUNCATE)  
                       WITHIN GROUP (ORDER BY hzl.address1 asc)
                          FROM apps.hz_parties             hp
                             , apps.hz_party_sites         hps
                             , apps.hz_cust_accounts       hca
                             , apps.oe_order_lines_all     oola
                             , apps.hz_cust_acct_sites_all hcas
                             , apps.hz_cust_site_uses_all  hcsu
                             , apps.hz_locations           hzl
                         WHERE oola.line_id                = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                           AND oola.ship_to_org_id         = hcsu.site_use_id
                           AND hcsu.cust_acct_site_id      = hcas.cust_acct_site_id
                           AND hcas.cust_account_id        = hca.cust_account_id
                           AND hcas.party_site_id          = hps.party_site_id
                           AND hca.party_id                = hp.party_id
                           AND hps.party_id                = hp.party_id
                           AND hps.location_id             = hzl.location_id   )
                   END
                END customer_address
                -- 
                -- alterado para BIll_to por Sinval fim
                -- 
              , CASE WHEN (mmt.source_code = '3PL_REMITTANCE_BRAZIL') THEN
                   (SELECT listagg(rcta.trx_number,', ' ON OVERFLOW TRUNCATE)  
                           WITHIN GROUP (ORDER BY rcta.trx_number asc)
                      FROM apps.ra_customer_trx_all       rcta
                     WHERE rcta.interface_header_attribute1  = mp.organization_code||'_'||mmt.transaction_reference
                       AND rcta.org_id                       = 4330
                       AND NVL(rcta.status_trx,'XX')         <> 'VD'
                       AND NVL(rcta.reason_code,'XX')        <> 'CANCELLATION')
                ELSE
                   (SELECT distinct RTRIM(REGEXP_REPLACE((listagg(rcta.trx_number,', ' ON OVERFLOW TRUNCATE)  
                      WITHIN GROUP (ORDER BY rcta.trx_number asc) ), '([^,]*)(,\1)+($|,)', '\1\3'),',')
                      FROM apps.ra_customer_trx_lines_all rctla
                         , apps.ra_customer_trx_all       rcta
                         , apps.oe_order_lines_all        oola
                         , apps.oe_order_headers_all      ooha
                     WHERE rcta.customer_trx_id              = rctla.customer_trx_id
                       AND oola.line_id                      = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                       AND oola.header_id                    = ooha.header_id
                       AND rctla.sales_order                 = to_char(ooha.order_number)
                       AND rctla.line_type                   = 'LINE'
                       AND rcta.batch_source_id              <> 6266 -- No RR invoices
                       AND DECODE(rctla.interface_line_context,'GEMS_PB_RR',rcta.interface_header_attribute11,'999')
                           = DECODE(rctla.interface_line_context,'GEMS_PB_RR',rcta.interface_header_attribute11,'999')
                       AND rcta.org_id                       = 4330
                       AND trunc(rcta.trx_date)              BETWEEN (trunc(mmt.transaction_date)-3) AND (trunc(mmt.transaction_date)+3)
                       AND NVL(rcta.status_trx,'XX')         <> 'VD'
                       AND NVL(rcta.reason_code,'XX')        <> 'CANCELLATION')
                END   invoice_number_ar
              , ( SELECT listagg(mrav.reservation_quantity,', ' ON OVERFLOW TRUNCATE)  
                  WITHIN GROUP (ORDER BY mrav.reservation_quantity asc) 
                    FROM apps.mtl_reservations_all_v  mrav 
                       , apps.oe_order_headers_all    ooha1
                   WHERE mrav.demand_source_header_id     = ooha1.header_id
                     AND mrav.demand_source_line_id       = NVL(mmt.trx_source_line_id, mmt.source_line_id) )  reservation_quantity
              , ( SELECT listagg(ooha1.order_number,', ' ON OVERFLOW TRUNCATE)  
                  WITHIN GROUP (ORDER BY ooha1.order_number asc) 
                    FROM apps.mtl_reservations_all_v  mrav 
                       , apps.oe_order_headers_all    ooha1
                   WHERE mrav.demand_source_header_id     = ooha1.header_id
                     AND mrav.demand_source_line_id       = NVL(mmt.trx_source_line_id, mmt.source_line_id) )  reservation_order_number
              , (SELECT distinct hp.party_name
                 --WITHIN GROUP (ORDER BY hp.party_name asc)
                   FROM apps.hz_parties              hp
                      , apps.hz_cust_accounts        hca
                      , apps.oe_order_lines_all      oola1
                      , apps.oe_order_headers_all    ooha1
                      , apps.mtl_reservations_all_v  mrav 
                  WHERE mrav.demand_source_header_id   = ooha1.header_id
                    AND mrav.demand_source_line_id     = oola1.line_id
                    AND oola1.line_id                  = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                    AND oola1.ship_to_org_id           = hca.cust_account_id
                    AND hca.party_id                   = hp.party_id )         reservation_customer_name
              , gcc1.concatenated_segments   material_account
              , gcc2.concatenated_segments   outside_processing_account
              , gcc3.concatenated_segments   material_overhead_account
              , gcc4.concatenated_segments   overhead_account
              , gcc5.concatenated_segments   resource_account
              , sysdate                                           report_date_and_time 
              , to_char(mmt.transaction_id)  transaction_id
              , fu.user_name ||' / '|| fu.description                                    user_name
              , DECODE( lot_control_code, 1 ,'Sem controle de Lote' , 2,'Com controle de Lote')   lot_control
              , DECODE( serial_number_control_code, 1, 'Sem controle de Serial'
                                                  , 2, 'Pre-definido'
                                                  , 5, 'No Recebimento'
                                                  , 6, 'Baixa na Ordem de Venda' )  serial_control
              , CASE
                 WHEN    nvl(mmt.lpn_id, mmt.content_lpn_id) IS NULL AND moq.subinventory_code <> 'WHGU42GNAT'
                   THEN 
                    (SELECT listagg(lpn.license_plate_number,', ' ON OVERFLOW TRUNCATE)WITHIN GROUP (ORDER BY lpn.license_plate_number asc)
                             FROM apps.MTL_MATERIAL_TRANSACTIONS   mtt,
                                  apps.wms_license_plate_numbers   lpn,
                                  apps.oe_order_lines_all          ool
                            WHERE 1 = 1
                              AND mtt.TRX_SOURCE_LINE_ID = CASE
                                                              WHEN LINE_CATEGORY_CODE = 'ORDER'
                                                                THEN ool.line_id
                                                              WHEN LINE_CATEGORY_CODE = 'RETURN'  
                                                                THEN   
                                                                to_number(NVL(SUBSTR(ool.ORIG_SYS_LINE_REF,
                                                                                     0,
                                                                                     INSTR(ool.ORIG_SYS_LINE_REF, '.') - 1),
                                                                              -1)) -- RMA FE OE Line Id
                                                                ELSE -1
                                                                  END
                              AND mtt.TRANSACTION_TYPE_ID = 52 --sales order pick FE ORDER
                              AND mtt.transaction_quantity < 0
                              AND mtt.inventory_item_id = ool.inventory_item_id
                              AND nvl(mtt.lpn_id, mtt.content_lpn_id) = nvl(lpn.lpn_id, -1)
                              AND ool.line_id = CASE
                                                  WHEN mtt.transaction_type_name = 'RMA Receipt'
                                                    THEN mmt.TRX_SOURCE_LINE_ID
                                                  WHEN mtt.transaction_type_name = 'GPO Nationalization Receipt'
                                                     THEN 
                                                      to_number(NVL(SUBSTR(RTRIM(LTRIM(translate(mmt.TRANSACTION_REFERENCE,translate(mmt.TRANSACTION_REFERENCE||'a','1234567890.',' '),' '))),
                                                         0,
                                                         INSTR(RTRIM(LTRIM(translate(mmt.TRANSACTION_REFERENCE,translate(mmt.TRANSACTION_REFERENCE||'a','1234567890.',' '),' '))), '.') - 1),
                                                  -1))
                                                  ELSE -1
                                                    END)
                              WHEN moq.subinventory_code = 'WHGU42GNAT'
                  THEN (SELECT listagg(wlp.license_plate_number,', ' ON OVERFLOW TRUNCATE)  
                            WITHIN GROUP (ORDER BY wlp.license_plate_number asc)
                        FROM   gems_ont.ge_gpo_nationalization_line gnl, 
                               gems_ont.ge_gpo_nationalization_line gn2,
                               apps.wms_license_plate_numbers       wlp,
                               apps.po_line_locations_all           pll,
                               apps.po_lines_all                    pol,
                               apps.po_headers_all                  poh,
                               apps.rcv_shipment_headers            rsh,
                               apps.rcv_transactions                rt
                        Where  wlp.lpn_id(+) = gn2.lpn_id
                        AND gnl.nationalization_so_line_id = gn2.nationalization_so_line_id
                        AND pll.line_location_id = gnl.DOCUMENT_ID
                        AND pll.po_header_id = poh.po_header_id
                        AND pll.po_line_id = pol.po_line_id
                        AND gn2.record_type = 'IMPORT'
                        AND gnl.record_type = 'NATIONALIZATION'
                        AND rt.transaction_id                = mmt.rcv_transaction_id
                        AND rt.po_line_location_id           = pll.line_location_id
                        AND rt.shipment_header_id            = rsh.shipment_header_id)
                ELSE (SELECT lpn.LICENSE_PLATE_NUMBER
                           FROM   apps.wms_license_plate_numbers   lpn
                           WHERE  nvl(mmt.lpn_id, mmt.content_lpn_id) = nvl(lpn.lpn_id, -1))
                        END LPN_Value                                    
             , 'q11' query
--, mmt.transaction_type_id
--, mmt.trx_source_line_id
--, mmt.source_line_id
           FROM apps.mtl_serial_numbers              msn
              , apps.mtl_parameters                  mp
              , apps.mtl_system_items_b              msi
              , apps.mtl_secondary_inventories_fk_v  msifv
              , apps.gl_code_combinations            gcc
              , apps.gl_code_combinations_kfv        gcc1
              , apps.gl_code_combinations_kfv        gcc2
              , apps.gl_code_combinations_kfv        gcc3
              , apps.gl_code_combinations_kfv        gcc4
              , apps.gl_code_combinations_kfv        gcc5
              , apps.mtl_item_locations_kfv          milk
              , apps.mtl_material_transactions       mmt
              , apps.mtl_transaction_types           mtt
              , apps.mtl_txn_source_types            mtst
              , apps.fnd_flex_values_vl              ffvv
              , apps.fnd_flex_value_sets             ffvs
              , apps.fnd_user                        fu
              , ( SELECT organization_id
                       , inventory_item_id
                       , subinventory_code
                       , locator_id
                       --, lot_number
                       --, transaction_uom_code
                       --, update_transaction_id
                       , SUM (primary_transaction_quantity) onhand_qty
                    FROM apps.mtl_onhand_quantities_detail
                   WHERE organization_id IN (SELECT ood.organization_id FROM apps.org_organization_definitions ood WHERE ood.set_of_books_id = 230 )
                   GROUP BY organization_id
                          , inventory_item_id
                          , subinventory_code
                          , locator_id
                       --   , revision
                          --, lot_number
                          --, transaction_uom_code
                          --, update_transaction_id 
                          ) moq
                          ,APPS.MTL_PAC_ACTUAL_COST_DETAILS MPACD 
          WHERE 1                                = 1
          AND decode(mmt.periodic_primary_quantity,null,mmt.transfer_transaction_id,MMT.TRANSACTION_ID) = MPACD.TRANSACTION_ID  
            AND mp.organization_id               = msi.organization_id
--            AND msi.segment1 = '60510302'
            AND msifv.organization_id            = msi.organization_id
            AND msifv.secondary_inventory_name   = moq.subinventory_code
            AND msifv.material_account           = gcc1.code_combination_id
            AND msifv.outside_processing_account = gcc2.code_combination_id
            AND msifv.material_overhead_account  = gcc3.code_combination_id
            AND msifv.overhead_account           = gcc4.code_combination_id
            AND msifv.resource_account           = gcc5.code_combination_id
            AND msi.cost_of_sales_account       = gcc.code_combination_id
            AND ffvs.flex_value_set_name        = 'GE_GL_AFF_ES_PRODUCT_LINE'
            AND ffvs.flex_value_set_id          = ffvv.flex_value_set_id
            AND ffvv.flex_value_meaning         = gcc.segment8
            AND 'TYPE 1'                        IN ('TYPE 1')
            AND msi.organization_id             IN (SELECT ood.organization_id FROM apps.org_organization_definitions ood WHERE ood.set_of_books_id = 230 )
            AND moq.inventory_item_id            = msn.inventory_item_id         (+) 
            AND moq.organization_id              = msn.current_organization_id   (+) 
            AND moq.subinventory_code            = msn.current_subinventory_code (+) 
            AND moq.locator_id                   = msn.current_locator_id        (+) 
            AND msn.current_status           (+) = 3   
            AND moq.inventory_item_id           = msi.inventory_item_id
            AND moq.organization_id             = msi.organization_id
            AND moq.locator_id                  = milk.inventory_location_id
            AND msn.last_transaction_id         = mmt.transaction_id(+)
--    AND MMT.TRANSACTION_ID = 2562828197
            AND mtt.transaction_type_id         = mmt.transaction_type_id 
            AND mtst.transaction_source_type_id = mmt.transaction_source_type_id
            AND msi.serial_number_control_code  <> '1' 
            AND msi.lot_control_code            = '1'  --Sem controle de Lote
            AND fu.user_id                      = mmt.created_by 
    AND MMT.TRANSACTION_ID NOT IN(SELECT MMT2.TRANSACTION_ID 
                                  FROM AMARCHIVE.MTL_MATERIAL_TRANSACTIONS  MMT2
                                  WHERE MMT2.TRANSACTION_ID = MMT.TRANSACTION_ID)
------------------------------------------------------------------------------
UNION  
------------------------------------------------------------------------------  
-- Com Controle de Serial e Sem Controle de Lote e com Locator  ---- AMARCHIVE.MTL_MATERIAL_TRANSACTIONS
         SELECT DISTINCT  --'12' NUM
        /* ( SELECT ccg.cost_group 
                             FROM apps.cst_cost_groups            ccg
                                , apps.cst_cost_group_assignments ccga
                            WHERE ccga.cost_group_id     = ccg.cost_group_id
                              AND ccga.organization_id   = mp.organization_id )  cost_group*/
            ( SELECT ccg.cost_group 
                             FROM apps.cst_cost_groups            ccg
                            WHERE MPACD.cost_group_id     = ccg.cost_group_id )  cost_group  
              , ( SELECT ( SELECT cpp1.period_name 
                             FROM apps.cst_pac_item_costs   cst
                                , apps.cst_pac_periods      cpp1
                            WHERE cst.pac_period_id     = (SELECT MAX(PAC_PERIOD_ID)                   FROM APPS.CST_PAC_PERIODS                  WHERE LEGAL_ENTITY = (SELECT LEGAL_ENTITY                                          FROM APPS.ORG_ORGANIZATION_DEFINITIONS OOD                                         WHERE OOD.ORGANIZATION_ID = mp.organization_id                                         ) )
                              AND cst.pac_period_id     = cpp1.pac_period_id
                              AND cst.inventory_item_id = msi.inventory_item_id
                              AND cst.cost_group_id     = ccg.cost_group_id )  
                    FROM apps.cst_cost_groups            ccg
                       , apps.cst_cost_group_assignments ccga
                   WHERE ccga.cost_group_id     = ccg.cost_group_id
                     AND ccga.organization_id   = mp.organization_id ) period_name
              , mp.organization_code
              , mp.attribute7                organization_type
              , mp.organization_id 
              , moq.subinventory_code
              , msifv.description            subinv_description
              , milk.concatenated_segments   locators
             , DECODE( msifv.asset_inventory, 1 , 'Asset', 2, 'Non Asset')   asset_type
              , msi.segment1                 part_number
              , DECODE(msi.inventory_asset_flag, NULL, 'No', 'N', 'No', 'Y', 'Yes')                         flag_asset_inventory
              , DECODE(msi.costing_enabled_flag, NULL, 'No', 'N', 'No', 'Y', 'Yes')                         flag_de_custo
              , msi.description              descrip_eng
              , msi.attribute3               descrip_ptb
              , msi.creation_date            item_creation_date
              , (trunc(SYSDATE) - trunc(msi.creation_date))      days_from_creation
              , gcc.segment8                                     product_line
              , ffvv.description                                 desc_prod_line   
              , msi.primary_uom_code    uom
              , DECODE (msi.serial_number_control_code, 1, moq.onhand_qty, 1)    transaction_quantity
              , NVL(( SELECT cic.item_cost
                        FROM apps.cst_item_costs cic
                       WHERE cic.organization_id   = msi.organization_id
                         AND cic.inventory_item_id = msi.inventory_item_id
                         AND cic.cost_type_id      = 1 ),0)  custo_unit_inv
              /*, nvl(( SELECT ( SELECT ROUND (cst.item_cost,2) 
                                 FROM apps.cst_pac_item_costs   cst
                                WHERE cst.pac_period_id     = (SELECT MAX(PAC_PERIOD_ID)                   FROM APPS.CST_PAC_PERIODS                  WHERE LEGAL_ENTITY = (SELECT LEGAL_ENTITY                                          FROM APPS.ORG_ORGANIZATION_DEFINITIONS OOD                                         WHERE OOD.ORGANIZATION_ID = mp.organization_id                                         ) )
                                  AND cst.inventory_item_id = msi.inventory_item_id
                                  AND cst.cost_group_id     = ccg.cost_group_id )  item_cost
                        FROM apps.cst_cost_groups            ccg
                           , apps.cst_cost_group_assignments ccga
                       WHERE ccga.cost_group_id     = ccg.cost_group_id
                         AND ccga.organization_id   = mp.organization_id ) ,0) custo_unit_pac*/
                , nvl((SELECT ROUND (cst.item_cost,2) 
                       FROM apps.cst_pac_item_costs   cst
                      WHERE cst.pac_period_id     = (SELECT MAX(PAC_PERIOD_ID)                   
                                                                FROM APPS.CST_PAC_PERIODS                  
                                                                WHERE LEGAL_ENTITY = (SELECT LEGAL_ENTITY                                         
                                                                                        FROM APPS.ORG_ORGANIZATION_DEFINITIONS OOD                                        
                                                                                        WHERE OOD.ORGANIZATION_ID = mp.organization_id
                                                        ) )
                        AND cst.inventory_item_id = msi.inventory_item_id
                        AND cst.cost_group_id     = MPACD.cost_group_id ),0)  custo_unit_pac
              , NULL  lot_number
              , NULL  lot_creation_date
              , NULL  lot_qty_days_creation
              , NULL  lot_expiration_date
              , msn.serial_number
              , msn.creation_date   serial_creation_date
              , mtt.transaction_type_name           last_transaction_type
              , mmt.transaction_source_name         last_transaction_source
              , mtst.transaction_source_type_name   last_source_type
              , mmt.source_code
              , TO_CHAR(mmt.transaction_date, 'DD-MON-RRRR')      transaction_date
              , (SELECT TO_CHAR(mmt1.transaction_date, 'DD-MON-RRRR') 
          FROM apps.mtl_material_transactions mmt1
          WHERE mmt1.transaction_type_id=420
          AND mmt1.source_line_id=mmt.source_line_id) initial_consignment_date          
              , (TRUNC ( SYSDATE )- TRUNC(mmt.transaction_date))  transaction_qty_of_days
              , TO_CHAR(mmt.transaction_reference)                transaction_reference
              , CASE WHEN mmt.source_code = '3PL_REMITTANCE_BRAZIL' THEN
                     (SELECT listagg(pha.segment1,', ' ON OVERFLOW TRUNCATE)  
                      WITHIN GROUP (ORDER BY pha.segment1 asc)
                        FROM apps.po_headers_all        pha,
                             apps.po_lines_all          pla
                       WHERE pla.po_line_id   = mmt.source_line_id
                         AND pla.po_header_id = pha.po_header_id)
                     WHEN mmt.source_code IN ('ORDER ENTRY','IIP') THEN
                        NULL
                     WHEN mmt.source_code = 'RCV' THEN
                        ( SELECT listagg(pha.segment1,', ' ON OVERFLOW TRUNCATE)  
                          WITHIN GROUP (ORDER BY pha.segment1 asc)
                            FROM apps.po_headers_all            pha
                               , apps.po_lines_all              pla
                               , apps.po_line_locations_all     plla
                               , apps.rcv_shipment_headers      rsh
                               , apps.rcv_transactions          rt
                           WHERE rt.transaction_id                = mmt.rcv_transaction_id
                             AND rt.po_line_location_id           = plla.line_location_id
                             AND plla.po_line_id                  = pla.po_line_id
                             AND pha.po_header_id                 = pla.po_header_id
                             AND rt.shipment_header_id            = rsh.shipment_header_id
                             AND rsh.receipt_source_code          = 'VENDOR'  )
                     ELSE
                        NULL
                END      po_number
              , CASE WHEN mmt.source_code = '3PL_REMITTANCE_BRAZIL' THEN
                     (SELECT listagg(aps.vendor_name,', ' ON OVERFLOW TRUNCATE)  
                      WITHIN GROUP (ORDER BY aps.vendor_name asc)
                        FROM apps.po_headers_all        pha
                           , apps.po_lines_all          pla
                           , apps.ap_suppliers          aps
                           , apps.ap_supplier_sites_all  apss
                       WHERE pla.po_line_id     = mmt.source_line_id
                         AND pla.po_header_id   = pha.po_header_id
                         AND pha.vendor_id      = aps.vendor_id
                         AND aps.vendor_id      = apss.vendor_id
                         AND pha.vendor_site_id = apss.vendor_site_id )
                     WHEN mmt.source_code IN ('ORDER ENTRY','IIP') THEN
                        NULL
                     WHEN mmt.source_code = 'RCV' THEN
                        ( SELECT listagg(aps.vendor_name,', ' ON OVERFLOW TRUNCATE)  
                          WITHIN GROUP (ORDER BY aps.vendor_name asc)
                            FROM apps.po_headers_all            pha
                               , apps.po_lines_all              pla
                               , apps.po_line_locations_all     plla
                               , apps.rcv_shipment_headers      rsh
                               , apps.rcv_transactions          rt
                               , apps.ap_suppliers              aps
                               , apps.ap_supplier_sites_all     apss
                           WHERE rt.transaction_id          = mmt.rcv_transaction_id
                             AND rt.po_line_location_id     = plla.line_location_id
                             AND plla.po_line_id            = pla.po_line_id
                             AND pha.po_header_id           = pla.po_header_id
                             AND rt.shipment_header_id      = rsh.shipment_header_id
                             AND rsh.receipt_source_code    = 'VENDOR'
                             AND pha.vendor_id              = aps.vendor_id
                             AND aps.vendor_id              = apss.vendor_id
                             AND pha.vendor_site_id         = apss.vendor_site_id  )
                     ELSE
                        NULL
                END     po_supplier
              , CASE WHEN mmt.source_code = '3PL_REMITTANCE_BRAZIL' THEN
                     ( SELECT listagg(cfi.invoice_num,', ' ON OVERFLOW TRUNCATE)  
                         WITHIN GROUP (ORDER BY cfi.invoice_num asc)
                         FROM apps.cll_f189_invoice_lines cfil
                            , apps.cll_f189_invoices      cfi
                            , apps.po_lines_all           pla
                            , apps.po_line_locations_all  plla
                        WHERE plla.po_line_id       = pla.po_line_id
                          AND pla.po_line_id        = mmt.source_line_id
                          AND plla.line_location_id = cfil.line_location_id
                          AND cfil.invoice_id       = cfi.invoice_id )
                     WHEN mmt.source_code IN ('ORDER ENTRY','IIP') THEN
                        NULL
                     WHEN mmt.source_code = 'RCV' THEN
                        ( SELECT listagg(cfi.invoice_num,', ' ON OVERFLOW TRUNCATE)  
                            WITHIN GROUP (ORDER BY cfi.invoice_num asc)
                            FROM apps.po_headers_all            pha
                               , apps.po_lines_all              pla
                               , apps.po_line_locations_all     plla
                               , apps.cll_f189_invoice_lines    cfil
                               , apps.cll_f189_invoices         cfi
                               , apps.rcv_shipment_headers      rsh
                               , apps.rcv_transactions          rt
                           WHERE rt.transaction_id          = mmt.rcv_transaction_id
                             AND rt.po_line_location_id     = plla.line_location_id
                             AND plla.line_location_id      = cfil.line_location_id
                             AND cfil.invoice_id            = cfi.invoice_id
                             AND plla.po_line_id            = pla.po_line_id
                             AND pha.po_header_id           = pla.po_header_id
                             AND rt.shipment_header_id      = rsh.shipment_header_id
                             AND rsh.receipt_source_code    = 'VENDOR'   )
                     ELSE
                        NULL
                END    NF_RI
             , (SELECT DECODE( mmt.source_code, '3PL_REMITTANCE_BRAZIL',NULL,to_char(ooha.order_number) )
                  FROM apps.oe_order_headers_all  ooha,
                       apps.oe_order_lines_all    oola  
                 WHERE oola.line_id        = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                   AND oola.header_id      = ooha.header_id )   order_number
               -- 
               -- alterado para BIll_to por Sinval inicio
               --
               , CASE WHEN ( SELECT ottl.name
                             FROM apps.oe_transaction_types_tl    ottl
                                , apps.oe_order_headers_all  ooha
                                , apps.oe_order_lines_all    oola  
                            WHERE oola.line_id        = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND oola.header_id      = ooha.header_id
                              AND ooha.order_type_id  = ottl.transaction_type_id  ) = 'GPO_BR_FE_SHIPMENT' THEN
                     (SELECT listagg(hp.party_name,', ' ON OVERFLOW TRUNCATE)  
                      WITHIN GROUP (ORDER BY hp.party_name asc)
                        FROM apps.hz_parties             hp
                           , apps.hz_cust_accounts       hca
                           , apps.oe_order_lines_all     oola
                           , apps.hz_cust_acct_sites_all hcas
                           , apps.hz_cust_site_uses_all  hcsu
                       WHERE oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                         AND oola.end_customer_site_use_id  = hcsu.site_use_id
                         AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                         AND hcas.cust_account_id           = hca.cust_account_id
                         AND hca.party_id                   = hp.party_id )
                  ELSE
                     CASE WHEN (mmt.source_code = '3PL_REMITTANCE_BRAZIL') THEN
                       (SELECT listagg(hp.party_name,', ' ON OVERFLOW TRUNCATE)  
                        WITHIN GROUP (ORDER BY hp.party_name asc)
                          FROM apps.hz_parties             hp,
                               apps.hz_cust_accounts       hca,
                               apps.ra_customer_trx_all    rcta,
                               apps.hz_cust_acct_sites_all hcas,
                               apps.hz_cust_site_uses_all  hcsu
                         WHERE rcta.interface_header_attribute1 = mp.organization_code||'_'||mmt.transaction_reference
                           AND rcta.ship_to_site_use_id         = hcsu.site_use_id
                           AND hcsu.cust_acct_site_id           = hcas.cust_acct_site_id
                           AND hcas.cust_account_id             = hca.cust_account_id
                           AND hca.party_id                     = hp.party_id
                           AND rcta.org_id                      = 4330)
                     ELSE
                        (SELECT listagg(hp.party_name,', ' ON OVERFLOW TRUNCATE)  
                         WITHIN GROUP (ORDER BY hp.party_name asc)
                           FROM apps.hz_parties             hp
                              , apps.hz_cust_accounts       hca
                              , apps.oe_order_lines_all     oola
                              , apps.hz_cust_acct_sites_all hcas
                              , apps.hz_cust_site_uses_all  hcsu
                          WHERE oola.line_id                = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                            AND oola.ship_to_org_id         = hcsu.site_use_id
                            AND hcsu.cust_acct_site_id      = hcas.cust_acct_site_id
                            AND hcas.cust_account_id        = hca.cust_account_id
                            AND hca.party_id                = hp.party_id )
                    END                 
               END    customer_name
             , CASE WHEN ( SELECT ottl.name
                             FROM apps.oe_transaction_types_tl    ottl
                                , apps.oe_order_headers_all  ooha
                                , apps.oe_order_lines_all    oola  
                            WHERE oola.line_id        = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND oola.header_id      = ooha.header_id
                              AND ooha.order_type_id  = ottl.transaction_type_id  ) = 'GPO_BR_FE_SHIPMENT' THEN
                     (SELECT listagg(hca.account_number,', ' ON OVERFLOW TRUNCATE)  
                      WITHIN GROUP (ORDER BY hca.account_number asc)
                        FROM apps.hz_parties             hp
                           , apps.hz_cust_accounts       hca
                          , apps.oe_order_lines_all     oola
                           , apps.hz_cust_acct_sites_all hcas
                           , apps.hz_cust_site_uses_all  hcsu
                       WHERE oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                         AND oola.end_customer_site_use_id  = hcsu.site_use_id
                         AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                         AND hcas.cust_account_id           = hca.cust_account_id
                         AND hca.party_id                   = hp.party_id )
                  ELSE
                     CASE WHEN (mmt.source_code = '3PL_REMITTANCE_BRAZIL') THEN
                        (SELECT listagg(hca.account_number,', ' ON OVERFLOW TRUNCATE)  
                         WITHIN GROUP (ORDER BY hca.account_number asc)
                           FROM apps.hz_parties             hp,
                                apps.hz_cust_accounts       hca,
                                apps.ra_customer_trx_all    rcta,
                                apps.hz_cust_acct_sites_all hcas,
                                apps.hz_cust_site_uses_all  hcsu
                          WHERE rcta.interface_header_attribute1 = mp.organization_code||'_'||mmt.transaction_reference
                            AND rcta.ship_to_site_use_id         = hcsu.site_use_id
                            AND hcsu.cust_acct_site_id           = hcas.cust_acct_site_id
                            AND hcas.cust_account_id             = hca.cust_account_id
                            AND hca.party_id                     = hp.party_id
                            AND rcta.org_id                      = 4330)
                     ELSE
                        (SELECT listagg(hca.account_number,', ' ON OVERFLOW TRUNCATE)  
                         WITHIN GROUP (ORDER BY hca.account_number asc)
                           FROM apps.hz_parties             hp
                              , apps.hz_cust_accounts       hca
                              , apps.oe_order_lines_all     oola
                              , apps.hz_cust_acct_sites_all hcas
                              , apps.hz_cust_site_uses_all  hcsu
                          WHERE oola.line_id                = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                            AND oola.ship_to_org_id         = hcsu.site_use_id
                            AND hcsu.cust_acct_site_id      = hcas.cust_acct_site_id
                            AND hcas.cust_account_id        = hca.cust_account_id
                            AND hca.party_id                = hp.party_id   )
                     END
                  END   customer_number
              --
              , CASE WHEN ( SELECT ottl.name
                             FROM apps.oe_transaction_types_tl    ottl
                                , apps.oe_order_headers_all  ooha
                               , apps.oe_order_lines_all    oola  
                            WHERE oola.line_id        = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND oola.header_id      = ooha.header_id
                              AND ooha.order_type_id  = ottl.transaction_type_id  ) = 'GPO_BR_FE_SHIPMENT' THEN
                     (SELECT listagg(DECODE(hcas.global_attribute2
                                           , '2',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'/'|| hcas.global_attribute4 ||'-'|| hcas.global_attribute5
                                           , '1',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'-'|| hcas.global_attribute5 
                                           , '3',HCSU.LOCATION||' - '||hcas.global_attribute3 ),', ' ON OVERFLOW TRUNCATE)
                     WITHIN GROUP (ORDER BY hcas.global_attribute2 asc ) 
                        FROM apps.hz_parties             hp
                           , apps.hz_cust_accounts       hca
                           , apps.oe_order_lines_all     oola
                           , apps.hz_cust_acct_sites_all hcas
                           , apps.hz_cust_site_uses_all  hcsu
                       WHERE oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                         AND oola.end_customer_site_use_id  = hcsu.site_use_id
                         AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                         AND hcas.cust_account_id           = hca.cust_account_id
                         AND hca.party_id                   = hp.party_id )
                ELSE
                   CASE WHEN (mmt.source_code = '3PL_REMITTANCE_BRAZIL') THEN
                      (SELECT listagg(DECODE(hcas.global_attribute2
                                           , '2',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'/'|| hcas.global_attribute4 ||'-'|| hcas.global_attribute5
                                           , '1',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'-'|| hcas.global_attribute5 
                                           , '3',HCSU.LOCATION||' - '||hcas.global_attribute3 ),', ' ON OVERFLOW TRUNCATE)
                     WITHIN GROUP (ORDER BY hcas.global_attribute2 asc) 
                         FROM apps.ra_customer_trx_all     rcta
                            , apps.hz_cust_acct_sites_all  hcas
                            , apps.hz_cust_site_uses_all   hcsu
                        WHERE rcta.interface_header_attribute1 = mp.organization_code||'_'||mmt.transaction_reference
                          AND rcta.ship_to_site_use_id         = hcsu.site_use_id
                          AND hcsu.cust_acct_site_id           = hcas.cust_acct_site_id
                          AND rcta.org_id                      = 4330)
                   ELSE
                      (SELECT listagg(DECODE(hcas.global_attribute2
                                           , '2',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'/'|| hcas.global_attribute4 ||'-'|| hcas.global_attribute5
                                           , '1',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'-'|| hcas.global_attribute5 
                                           , '3',HCSU.LOCATION||' - '||hcas.global_attribute3 ),', ' ON OVERFLOW TRUNCATE)
                      WITHIN GROUP (ORDER BY hcas.global_attribute2 asc) 
                         FROM apps.hz_parties             hp
                            , apps.hz_cust_accounts       hca
                            , apps.oe_order_lines_all     oola
                            , apps.hz_cust_acct_sites_all hcas
                            , apps.hz_cust_site_uses_all  hcsu
                        WHERE oola.line_id                = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                          AND oola.ship_to_org_id         = hcsu.site_use_id
                          AND hcsu.cust_acct_site_id      = hcas.cust_acct_site_id
                          AND hcas.cust_account_id        = hca.cust_account_id
                          AND hca.party_id                = hp.party_id  )
                   END
                END  customer_cnpj_cpf
               -- 
              , CASE WHEN (mmt.source_code = '3PL_REMITTANCE_BRAZIL') THEN
                      (SELECT listagg(DECODE(hcas.global_attribute2
                                           , '2',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'/'|| hcas.global_attribute4 ||'-'|| hcas.global_attribute5
                                           , '1',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'-'|| hcas.global_attribute5 
                                           , '3',HCSU.LOCATION||' - '||hcas.global_attribute3 ),', ' ON OVERFLOW TRUNCATE)
                       WITHIN GROUP (ORDER BY hcas.global_attribute2 asc )
                         FROM apps.ra_customer_trx_all         rcta
                            , apps.hz_cust_acct_sites_all      hcas
                            , apps.hz_cust_site_uses_all       hcsu
                        WHERE rcta.interface_header_attribute1 = mp.organization_code||'_'||mmt.transaction_reference
                          AND rcta.bill_to_site_use_id         = hcsu.site_use_id
                          AND hcsu.cust_acct_site_id           = hcas.cust_acct_site_id
                          AND rcta.org_id                      = 4330
                          AND ROWNUM = 1)
                   ELSE
                     --
                     CASE WHEN (select DISTINCT RCTL.INTERFACE_LINE_CONTEXT
                             FROM apps.hz_parties                hp
                                , apps.hz_cust_accounts          hca
                                , apps.oe_order_lines_all        oola
                                , apps.oe_order_headers_all      ooha
                                , apps.ra_customer_trx_lines_all rctl
                                , apps.ra_customer_trx_all       rcta
                                , apps.hz_cust_acct_sites_all    hcas
                                , apps.hz_cust_site_uses_all     hcsu
                            WHERE ooha.header_id                 = oola.header_id
                              AND oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND rctl.inventory_item_id         = oola.inventory_item_id
                              AND rctl.line_type                 = 'LINE'
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE1 = to_char(ooha.order_number)
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE6 = to_char(oola.line_id)
                              AND RCTL.INTERFACE_LINE_CONTEXT    = 'ORDER ENTRY'
                              AND rctl.customer_trx_id           = rcta.customer_trx_id
                              AND rcta.bill_to_site_use_id       = hcsu.site_use_id
                              AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                              AND hcas.cust_account_id           = hca.cust_account_id
                              AND hca.party_id                   = hp.party_id 
                              AND ROWNUM = 1) = 'ORDER ENTRY' THEN
                     --
                     (SELECT DISTINCT DECODE(hcas.global_attribute2
                                           , '2',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'/'|| hcas.global_attribute4 ||'-'|| hcas.global_attribute5
                                           , '1',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'-'|| hcas.global_attribute5 
                                           , '3',HCSU.LOCATION||' - '||hcas.global_attribute3)
                             FROM apps.hz_parties                hp
                                , apps.hz_cust_accounts          hca
                                , apps.oe_order_lines_all        oola
                                , apps.oe_order_headers_all      ooha
                                , apps.ra_customer_trx_lines_all rctl
                                , apps.ra_customer_trx_all       rcta
                                , apps.hz_cust_acct_sites_all    hcas
                                , apps.hz_cust_site_uses_all     hcsu
                            WHERE ooha.header_id                 = oola.header_id
                              AND oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND rctl.inventory_item_id         = oola.inventory_item_id
                              AND rctl.line_type                 = 'LINE'
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE1 = to_char(ooha.order_number)
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE6 = to_char(oola.line_id)
                              AND RCTL.INTERFACE_LINE_CONTEXT    = 'ORDER ENTRY'
                              AND rctl.customer_trx_id           = rcta.customer_trx_id
                              AND rcta.bill_to_site_use_id       = hcsu.site_use_id
                              AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                              AND hcas.cust_account_id           = hca.cust_account_id
                              AND hca.party_id                   = hp.party_id
                              AND ROWNUM = 1)
                     --
                     ELSE
                     --            
                     CASE WHEN 
                          ( SELECT DISTINCT RCTL.INTERFACE_LINE_CONTEXT
                             FROM apps.hz_parties                hp
                                , apps.hz_cust_accounts          hca
                                , apps.oe_order_lines_all        oola
                                , apps.oe_order_headers_all      ooha
                                , apps.ra_customer_trx_lines_all rctl
                                , apps.ra_customer_trx_all       rcta
                                , apps.hz_cust_acct_sites_all    hcas
                                , apps.hz_cust_site_uses_all     hcsu
                            WHERE ooha.header_id                 = oola.header_id
                              AND oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND rctl.inventory_item_id         = oola.inventory_item_id
                              AND rctl.line_type                 = 'LINE'
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE1 = ooha.ORIG_SYS_DOCUMENT_REF
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE7 = oola.ORIG_SYS_LINE_REF
                              AND RCTL.INTERFACE_LINE_CONTEXT    = 'GEMS_PB_RR'
                              AND rctl.customer_trx_id           = rcta.customer_trx_id
                              AND rcta.bill_to_site_use_id       = hcsu.site_use_id
                              AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                              AND hcas.cust_account_id           = hca.cust_account_id
                              AND ROWNUM = 1 ) = 'GEMS_PB_RR' THEN
                     --
                     (SELECT DISTINCT DECODE(hcas.global_attribute2
                                           , '2',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'/'|| hcas.global_attribute4 ||'-'|| hcas.global_attribute5
                                           , '1',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'-'|| hcas.global_attribute5 
                                           , '3',HCSU.LOCATION||' - '||hcas.global_attribute3)
                             FROM apps.hz_parties                hp
                                , apps.hz_cust_accounts          hca
                                , apps.oe_order_lines_all        oola
                                , apps.oe_order_headers_all      ooha
                                , apps.ra_customer_trx_lines_all rctl
                                , apps.ra_customer_trx_all       rcta
                                , apps.hz_cust_acct_sites_all    hcas
                                , apps.hz_cust_site_uses_all     hcsu
                            WHERE ooha.header_id                 = oola.header_id
                              AND oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND rctl.inventory_item_id         = oola.inventory_item_id
                              AND rctl.line_type                 = 'LINE'
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE1 = ooha.ORIG_SYS_DOCUMENT_REF
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE7 = oola.ORIG_SYS_LINE_REF
                              AND RCTL.INTERFACE_LINE_CONTEXT    = 'GEMS_PB_RR'
                              AND rctl.customer_trx_id           = rcta.customer_trx_id
                              AND rcta.bill_to_site_use_id       = hcsu.site_use_id
                              AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                              AND hcas.cust_account_id           = hca.cust_account_id 
                              AND ROWNUM = 1 )
                     --
                     ELSE
                     --
                     (SELECT DISTINCT DECODE(hcas.global_attribute2
                                   , '2',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'/'|| hcas.global_attribute4 ||'-'|| hcas.global_attribute5
                                   , '1',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'-'|| hcas.global_attribute5 
                                   , '3',HCSU.LOCATION||' - '||hcas.global_attribute3)
                             --
                      FROM   APPS.HZ_CUST_ACCT_SITES_ALL HCAS,
                             APPS.HZ_CUST_SITE_USES_ALL  HCSU,
                             APPS.OE_ORDER_LINES_ALL     OOLA,
                             APPS.OE_ORDER_HEADERS_ALL   OOHA
                             --
                      WHERE  HCSU.SITE_USE_CODE     = 'BILL_TO'
                      AND    HCSU.CUST_ACCT_SITE_ID = HCAS.CUST_ACCT_SITE_ID
                      AND    HCSU.SITE_USE_ID       = NVL(OOLA.ATTRIBUTE1, OOHA.INVOICE_TO_ORG_ID)
                      AND    OOLA.LINE_ID           = NVL(MMT.TRX_SOURCE_LINE_ID, MMT.SOURCE_LINE_ID)
                      AND    OOHA.HEADER_ID         = OOLA.HEADER_ID
                      AND    ROWNUM = 1)
                     --
                     END
                  END
               END      bill_to_CNPJ_CPF
               --
                             --
              , CASE WHEN (mmt.source_code = '3PL_REMITTANCE_BRAZIL') THEN
                        (SELECT listagg(hp.party_name,', ' ON OVERFLOW TRUNCATE)  
                        WITHIN GROUP (ORDER BY hp.party_name asc)
                          FROM apps.hz_parties             hp,
                               apps.hz_cust_accounts       hca,
                               apps.ra_customer_trx_all    rcta,
                               apps.hz_cust_acct_sites_all hcas,
                               apps.hz_cust_site_uses_all  hcsu
                         WHERE rcta.interface_header_attribute1 = mp.organization_code||'_'||mmt.transaction_reference
                           AND rcta.bill_to_site_use_id         = hcsu.site_use_id
                           AND hcsu.cust_acct_site_id           = hcas.cust_acct_site_id
                           AND hcas.cust_account_id             = hca.cust_account_id
                           AND hca.party_id                     = hp.party_id
                           AND rcta.org_id                      = 4330)
                   ELSE
                     --
                     CASE WHEN (select DISTINCT RCTL.INTERFACE_LINE_CONTEXT
                             FROM apps.hz_parties                hp
                                , apps.hz_cust_accounts          hca
                                , apps.oe_order_lines_all        oola
                                , apps.oe_order_headers_all      ooha
                                , apps.ra_customer_trx_lines_all rctl
                                , apps.ra_customer_trx_all       rcta
                                , apps.hz_cust_acct_sites_all    hcas
                                , apps.hz_cust_site_uses_all     hcsu
                            WHERE ooha.header_id                 = oola.header_id
                              AND oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND rctl.inventory_item_id         = oola.inventory_item_id
                              AND rctl.line_type                 = 'LINE'
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE1 = to_char(ooha.order_number)
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE6 = to_char(oola.line_id)
                              AND RCTL.INTERFACE_LINE_CONTEXT    = 'ORDER ENTRY'
                              AND rctl.customer_trx_id           = rcta.customer_trx_id
                              AND rcta.bill_to_site_use_id       = hcsu.site_use_id
                              AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                              AND hcas.cust_account_id           = hca.cust_account_id
                              AND hca.party_id                   = hp.party_id 
                              AND ROWNUM = 1) = 'ORDER ENTRY' THEN
                     --
                     (SELECT listagg(hp.party_name,', ' ON OVERFLOW TRUNCATE)  
                         WITHIN GROUP (ORDER BY hp.party_name asc)
                             FROM apps.hz_parties                hp
                                , apps.hz_cust_accounts          hca
                                , apps.oe_order_lines_all        oola
                                , apps.oe_order_headers_all      ooha
                                , apps.ra_customer_trx_lines_all rctl
                                , apps.ra_customer_trx_all       rcta
                                , apps.hz_cust_acct_sites_all    hcas
                                , apps.hz_cust_site_uses_all     hcsu
                            WHERE ooha.header_id                 = oola.header_id
                              AND oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND rctl.inventory_item_id         = oola.inventory_item_id
                              AND rctl.line_type                 = 'LINE'
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE1 = to_char(ooha.order_number)
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE6 = to_char(oola.line_id)
                              AND RCTL.INTERFACE_LINE_CONTEXT    = 'ORDER ENTRY'
                              AND rctl.customer_trx_id           = rcta.customer_trx_id
                              AND rcta.bill_to_site_use_id       = hcsu.site_use_id
                              AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                              AND hcas.cust_account_id           = hca.cust_account_id
                              AND hca.party_id                   = hp.party_id
                              AND ROWNUM = 1)
                     --
                     ELSE
                     --            
                     CASE WHEN 
                          ( SELECT DISTINCT RCTL.INTERFACE_LINE_CONTEXT
                             FROM apps.hz_parties                hp
                                , apps.hz_cust_accounts          hca
                                , apps.oe_order_lines_all        oola
                                , apps.oe_order_headers_all      ooha
                                , apps.ra_customer_trx_lines_all rctl
                                , apps.ra_customer_trx_all       rcta
                                , apps.hz_cust_acct_sites_all    hcas
                                , apps.hz_cust_site_uses_all     hcsu
                            WHERE ooha.header_id                 = oola.header_id
                              AND oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND rctl.inventory_item_id         = oola.inventory_item_id
                              AND rctl.line_type                 = 'LINE'
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE1 = ooha.ORIG_SYS_DOCUMENT_REF
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE7 = oola.ORIG_SYS_LINE_REF
                              AND RCTL.INTERFACE_LINE_CONTEXT    = 'GEMS_PB_RR'
                              AND rctl.customer_trx_id           = rcta.customer_trx_id
                              AND rcta.bill_to_site_use_id       = hcsu.site_use_id
                              AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                              AND hcas.cust_account_id           = hca.cust_account_id
                              AND ROWNUM = 1 ) = 'GEMS_PB_RR' THEN
                     --
                     (SELECT listagg(hp.party_name,', ' ON OVERFLOW TRUNCATE)  
                         WITHIN GROUP (ORDER BY hp.party_name asc)
                             FROM apps.hz_parties                hp
                                , apps.hz_cust_accounts          hca
                                , apps.oe_order_lines_all        oola
                                , apps.oe_order_headers_all      ooha
                                , apps.ra_customer_trx_lines_all rctl
                                , apps.ra_customer_trx_all       rcta
                                , apps.hz_cust_acct_sites_all    hcas
                                , apps.hz_cust_site_uses_all     hcsu
                            WHERE ooha.header_id                 = oola.header_id
                              AND oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND rctl.inventory_item_id         = oola.inventory_item_id
                              AND rctl.line_type                 = 'LINE'
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE1 = ooha.ORIG_SYS_DOCUMENT_REF
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE7 = oola.ORIG_SYS_LINE_REF
                              AND RCTL.INTERFACE_LINE_CONTEXT    = 'GEMS_PB_RR'
                              AND rctl.customer_trx_id           = rcta.customer_trx_id
                              AND rcta.bill_to_site_use_id       = hcsu.site_use_id
                              AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                              AND hcas.cust_account_id           = hca.cust_account_id 
                              AND ROWNUM = 1 )
                     --
                     ELSE
                     --
                     (SELECT listagg(hp.party_name,', ' ON OVERFLOW TRUNCATE)  
                         WITHIN GROUP (ORDER BY hp.party_name asc)
                      FROM   APPS.HZ_CUST_ACCT_SITES_ALL HCAS,
                             apps.hz_parties             hp,
                             apps.hz_cust_accounts       hca,
                             APPS.HZ_CUST_SITE_USES_ALL  HCSU,
                             APPS.OE_ORDER_LINES_ALL     OOLA,
                             APPS.OE_ORDER_HEADERS_ALL   OOHA
                             --
                      WHERE  HCSU.SITE_USE_CODE     = 'BILL_TO'
                      AND    HCSU.CUST_ACCT_SITE_ID = HCAS.CUST_ACCT_SITE_ID
                      AND    HCSU.SITE_USE_ID       = NVL(OOLA.ATTRIBUTE1, OOHA.INVOICE_TO_ORG_ID)
                      AND    OOLA.LINE_ID           = NVL(MMT.TRX_SOURCE_LINE_ID, MMT.SOURCE_LINE_ID)
                      AND    OOHA.HEADER_ID         = OOLA.HEADER_ID
                      AND    hcas.cust_account_id   = hca.cust_account_id
                      AND    hca.party_id           = hp.party_id 
                      AND    ROWNUM = 1)
                     --          
                     END
                  END
               END      bill_to_Customer_name
               --
                , CASE WHEN (mmt.source_code = '3PL_REMITTANCE_BRAZIL') THEN
                      (SELECT listagg(DECODE(hcas.global_attribute2
                                           , '2',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'/'|| hcas.global_attribute4 ||'-'|| hcas.global_attribute5
                                           , '1',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'-'|| hcas.global_attribute5 
                                           , '3',HCSU.LOCATION||' - '||hcas.global_attribute3 ),', ' ON OVERFLOW TRUNCATE)
                       WITHIN GROUP (ORDER BY hcas.global_attribute2 asc )
                         FROM apps.ra_customer_trx_all         rcta
                            , apps.hz_cust_acct_sites_all      hcas
                            , apps.hz_cust_site_uses_all       hcsu
                        WHERE rcta.interface_header_attribute1 = mp.organization_code||'_'||mmt.transaction_reference
                          AND rcta.ship_to_site_use_id         = hcsu.site_use_id
                          AND hcsu.cust_acct_site_id           = hcas.cust_acct_site_id
                          AND rcta.org_id                      = 4330
                          AND ROWNUM = 1)
                   ELSE
                     --
                     CASE WHEN (select DISTINCT RCTL.INTERFACE_LINE_CONTEXT
                             FROM apps.hz_parties                hp
                                , apps.hz_cust_accounts          hca
                                , apps.oe_order_lines_all        oola
                                , apps.oe_order_headers_all      ooha
                                , apps.ra_customer_trx_lines_all rctl
                                , apps.ra_customer_trx_all       rcta
                                , apps.hz_cust_acct_sites_all    hcas
                                , apps.hz_cust_site_uses_all     hcsu
                            WHERE ooha.header_id                 = oola.header_id
                              AND oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND rctl.inventory_item_id         = oola.inventory_item_id
                              AND rctl.line_type                 = 'LINE'
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE1 = to_char(ooha.order_number)
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE6 = to_char(oola.line_id)
                              AND RCTL.INTERFACE_LINE_CONTEXT    = 'ORDER ENTRY'
                              AND rctl.customer_trx_id           = rcta.customer_trx_id
                              AND rcta.ship_to_site_use_id       = hcsu.site_use_id
                              AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                              AND hcas.cust_account_id           = hca.cust_account_id
                              AND hca.party_id                   = hp.party_id 
                              AND ROWNUM = 1) = 'ORDER ENTRY' THEN
                     --
                     (SELECT DISTINCT DECODE(hcas.global_attribute2
                                           , '2',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'/'|| hcas.global_attribute4 ||'-'|| hcas.global_attribute5
                                           , '1',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'-'|| hcas.global_attribute5 
                                           , '3',HCSU.LOCATION||' - '||hcas.global_attribute3)
                             FROM apps.hz_parties                hp
                                , apps.hz_cust_accounts          hca
                                , apps.oe_order_lines_all        oola
                                , apps.oe_order_headers_all      ooha
                                , apps.ra_customer_trx_lines_all rctl
                                , apps.ra_customer_trx_all       rcta
                                , apps.hz_cust_acct_sites_all    hcas
                                , apps.hz_cust_site_uses_all     hcsu
                            WHERE ooha.header_id                 = oola.header_id
                              AND oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND rctl.inventory_item_id         = oola.inventory_item_id
                              AND rctl.line_type                 = 'LINE'
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE1 = to_char(ooha.order_number)
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE6 = to_char(oola.line_id)
                              AND RCTL.INTERFACE_LINE_CONTEXT    = 'ORDER ENTRY'
                              AND rctl.customer_trx_id           = rcta.customer_trx_id
                              AND rcta.ship_to_site_use_id       = hcsu.site_use_id
                              AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                              AND hcas.cust_account_id           = hca.cust_account_id
                              AND hca.party_id                   = hp.party_id
                              AND ROWNUM = 1)
                     --
                     ELSE
                     --            
                     CASE WHEN 
                          ( SELECT DISTINCT RCTL.INTERFACE_LINE_CONTEXT
                             FROM apps.hz_parties                hp
                                , apps.hz_cust_accounts          hca
                                , apps.oe_order_lines_all        oola
                                , apps.oe_order_headers_all      ooha
                                , apps.ra_customer_trx_lines_all rctl
                                , apps.ra_customer_trx_all       rcta
                                , apps.hz_cust_acct_sites_all    hcas
                                , apps.hz_cust_site_uses_all     hcsu
                            WHERE ooha.header_id                 = oola.header_id
                              AND oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND rctl.inventory_item_id         = oola.inventory_item_id
                              AND rctl.line_type                 = 'LINE'
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE1 = ooha.ORIG_SYS_DOCUMENT_REF
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE7 = oola.ORIG_SYS_LINE_REF
                              AND RCTL.INTERFACE_LINE_CONTEXT    = 'GEMS_PB_RR'
                              AND rctl.customer_trx_id           = rcta.customer_trx_id
                              AND rcta.ship_to_site_use_id       = hcsu.site_use_id
                              AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                              AND hcas.cust_account_id           = hca.cust_account_id
                              AND ROWNUM = 1 ) = 'GEMS_PB_RR' THEN
                     --
                     (SELECT DISTINCT DECODE(hcas.global_attribute2
                                           , '2',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'/'|| hcas.global_attribute4 ||'-'|| hcas.global_attribute5
                                           , '1',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'-'|| hcas.global_attribute5 
                                           , '3',HCSU.LOCATION||' - '||hcas.global_attribute3)
                             FROM apps.hz_parties                hp
                                , apps.hz_cust_accounts          hca
                                , apps.oe_order_lines_all        oola
                                , apps.oe_order_headers_all      ooha
                                , apps.ra_customer_trx_lines_all rctl
                                , apps.ra_customer_trx_all       rcta
                                , apps.hz_cust_acct_sites_all    hcas
                                , apps.hz_cust_site_uses_all     hcsu
                            WHERE ooha.header_id                 = oola.header_id
                              AND oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND rctl.inventory_item_id         = oola.inventory_item_id
                              AND rctl.line_type                 = 'LINE'
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE1 = ooha.ORIG_SYS_DOCUMENT_REF
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE7 = oola.ORIG_SYS_LINE_REF
                              AND RCTL.INTERFACE_LINE_CONTEXT    = 'GEMS_PB_RR'
                              AND rctl.customer_trx_id           = rcta.customer_trx_id
                              AND rcta.ship_to_site_use_id       = hcsu.site_use_id
                              AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                              AND hcas.cust_account_id           = hca.cust_account_id 
                              AND ROWNUM = 1 )
                     --
                     ELSE
                     --
                     (SELECT listagg(DECODE(hcas.global_attribute2
                                           , '2',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'/'|| hcas.global_attribute4 ||'-'|| hcas.global_attribute5
                                           , '1',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'-'|| hcas.global_attribute5 
                                           , '3',HCSU.LOCATION||' - '||hcas.global_attribute3 ),', ' ON OVERFLOW TRUNCATE)
                      WITHIN GROUP (ORDER BY hcas.global_attribute2 asc) 
                         FROM apps.hz_parties             hp
                            , apps.hz_cust_accounts       hca
                            , apps.oe_order_lines_all     oola
                            , apps.hz_cust_acct_sites_all hcas
                            , apps.hz_cust_site_uses_all  hcsu
                        WHERE oola.line_id                = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                          AND oola.ship_to_org_id         = hcsu.site_use_id
                          AND hcsu.cust_acct_site_id      = hcas.cust_acct_site_id
                          AND hcas.cust_account_id        = hca.cust_account_id
                          AND hca.party_id                = hp.party_id  )
                     --
                     END
                  END
               END      ship_to_CNPJ_CPF
               --
              , CASE WHEN ( SELECT ottl.name
                              FROM apps.oe_transaction_types_tl    ottl
                                 , apps.oe_order_headers_all  ooha
                                 , apps.oe_order_lines_all    oola  
                             WHERE oola.line_id        = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                               AND oola.header_id      = ooha.header_id
                               AND ooha.order_type_id  = ottl.transaction_type_id  ) = 'GPO_BR_FE_SHIPMENT' THEN
                      (SELECT listagg(hzl.address1 ||' - '|| hzl.address2 || ' - ' || hzl.city || '-' || hzl.state || ' / ' || hzl.postal_code,', ' ON OVERFLOW TRUNCATE)  
                       WITHIN GROUP (ORDER BY hzl.address1 asc)
                       FROM apps.hz_parties             hp
                        , apps.hz_party_sites         hps
                        , apps.hz_cust_accounts       hca
                        , apps.oe_order_lines_all     oola
                        , apps.hz_cust_acct_sites_all hcas
                        , apps.hz_cust_site_uses_all  hcsu
                        , apps.hz_locations           hzl
                    WHERE oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                      AND oola.end_customer_site_use_id  = hcsu.site_use_id
                      AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                      AND hcas.cust_account_id           = hca.cust_account_id
                      AND hcas.party_site_id             = hps.party_site_id
                      AND hca.party_id                   = hp.party_id
                      AND hps.party_id                   = hp.party_id
                      AND hps.location_id                = hzl.location_id)
                ELSE
                   CASE WHEN (mmt.source_code = '3PL_REMITTANCE_BRAZIL') THEN
                      (SELECT listagg(hzl.address1 ||' - '|| hzl.address2 || ' - ' || hzl.city || '-' || hzl.state || ' / ' || hzl.postal_code,', ' ON OVERFLOW TRUNCATE)  
                       WITHIN GROUP (ORDER BY hzl.address1 asc)
                         FROM apps.ra_customer_trx_all     rcta
                            , apps.hz_cust_acct_sites_all  hcas
                            , apps.hz_cust_site_uses_all   hcsu
                            , apps.hz_parties              hp
                            , apps.hz_party_sites          hps
                            , apps.hz_cust_accounts        hca
                            , apps.hz_locations            hzl
                        WHERE rcta.interface_header_attribute1 = mp.organization_code||'_'||mmt.transaction_reference
                          AND rcta.ship_to_site_use_id         = hcsu.site_use_id
                          AND hcsu.cust_acct_site_id           = hcas.cust_acct_site_id
                          AND hcas.cust_account_id             = hca.cust_account_id
                         AND hcas.party_site_id               = hps.party_site_id
                          AND hca.party_id                     = hp.party_id
                          AND hps.party_id                     = hp.party_id
                          AND hps.location_id                  = hzl.location_id
                          AND rcta.org_id                      = 4330)
                   ELSE
                      (SELECT listagg(hzl.address1 ||' - '|| hzl.address2 || ' - ' || hzl.city || '-' || hzl.state || ' / ' || hzl.postal_code,', ' ON OVERFLOW TRUNCATE)  
                       WITHIN GROUP (ORDER BY hzl.address1 asc)
                          FROM apps.hz_parties             hp
                             , apps.hz_party_sites         hps
                             , apps.hz_cust_accounts       hca
                             , apps.oe_order_lines_all     oola
                             , apps.hz_cust_acct_sites_all hcas
                             , apps.hz_cust_site_uses_all  hcsu
                             , apps.hz_locations           hzl
                         WHERE oola.line_id                = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                           AND oola.ship_to_org_id         = hcsu.site_use_id
                           AND hcsu.cust_acct_site_id      = hcas.cust_acct_site_id
                           AND hcas.cust_account_id        = hca.cust_account_id
                           AND hcas.party_site_id          = hps.party_site_id
                           AND hca.party_id                = hp.party_id
                           AND hps.party_id                = hp.party_id
                           AND hps.location_id             = hzl.location_id   )
                   END
                END customer_address
                -- 
                -- alterado para BIll_to por Sinval fim
                -- 
              , CASE WHEN (mmt.source_code = '3PL_REMITTANCE_BRAZIL') THEN
                   (SELECT listagg(rcta.trx_number,', ' ON OVERFLOW TRUNCATE)  
                           WITHIN GROUP (ORDER BY rcta.trx_number asc)
                      FROM apps.ra_customer_trx_all       rcta
                     WHERE rcta.interface_header_attribute1  = mp.organization_code||'_'||mmt.transaction_reference
                       AND rcta.org_id                       = 4330
                       AND NVL(rcta.status_trx,'XX')         <> 'VD'
                       AND NVL(rcta.reason_code,'XX')        <> 'CANCELLATION')
                ELSE
                   (SELECT distinct RTRIM(REGEXP_REPLACE((listagg(rcta.trx_number,', ' ON OVERFLOW TRUNCATE)  
                      WITHIN GROUP (ORDER BY rcta.trx_number asc) ), '([^,]*)(,\1)+($|,)', '\1\3'),',')
                      FROM apps.ra_customer_trx_lines_all rctla
                         , apps.ra_customer_trx_all       rcta
                         , apps.oe_order_lines_all        oola
                         , apps.oe_order_headers_all      ooha
                     WHERE rcta.customer_trx_id              = rctla.customer_trx_id
                       AND oola.line_id                      = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                       AND oola.header_id                    = ooha.header_id
                       AND rctla.sales_order                 = to_char(ooha.order_number)
                       AND rctla.line_type                   = 'LINE'
                       AND rcta.batch_source_id              <> 6266 -- No RR invoices
                       AND DECODE(rctla.interface_line_context,'GEMS_PB_RR',rcta.interface_header_attribute11,'999')
                           = DECODE(rctla.interface_line_context,'GEMS_PB_RR',rcta.interface_header_attribute11,'999')
                       AND rcta.org_id                       = 4330
                       AND trunc(rcta.trx_date)              BETWEEN (trunc(mmt.transaction_date)-3) AND (trunc(mmt.transaction_date)+3)
                       AND NVL(rcta.status_trx,'XX')         <> 'VD'
                       AND NVL(rcta.reason_code,'XX')        <> 'CANCELLATION')
                END   invoice_number_ar
              , ( SELECT listagg(mrav.reservation_quantity,', ' ON OVERFLOW TRUNCATE)  
                  WITHIN GROUP (ORDER BY mrav.reservation_quantity asc) 
                    FROM apps.mtl_reservations_all_v  mrav 
                       , apps.oe_order_headers_all    ooha1
                   WHERE mrav.demand_source_header_id     = ooha1.header_id
                     AND mrav.demand_source_line_id       = NVL(mmt.trx_source_line_id, mmt.source_line_id) )  reservation_quantity
              , ( SELECT listagg(ooha1.order_number,', ' ON OVERFLOW TRUNCATE)  
                  WITHIN GROUP (ORDER BY ooha1.order_number asc) 
                    FROM apps.mtl_reservations_all_v  mrav 
                       , apps.oe_order_headers_all    ooha1
                   WHERE mrav.demand_source_header_id     = ooha1.header_id
                     AND mrav.demand_source_line_id       = NVL(mmt.trx_source_line_id, mmt.source_line_id) )  reservation_order_number
              , (SELECT distinct hp.party_name
                 --WITHIN GROUP (ORDER BY hp.party_name asc)
                   FROM apps.hz_parties              hp
                      , apps.hz_cust_accounts        hca
                      , apps.oe_order_lines_all      oola1
                      , apps.oe_order_headers_all    ooha1
                      , apps.mtl_reservations_all_v  mrav 
                  WHERE mrav.demand_source_header_id   = ooha1.header_id
                    AND mrav.demand_source_line_id     = oola1.line_id
                    AND oola1.line_id                  = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                    AND oola1.ship_to_org_id           = hca.cust_account_id
                    AND hca.party_id                   = hp.party_id )         reservation_customer_name
              , gcc1.concatenated_segments   material_account
              , gcc2.concatenated_segments   outside_processing_account
              , gcc3.concatenated_segments   material_overhead_account
              , gcc4.concatenated_segments   overhead_account
              , gcc5.concatenated_segments   resource_account
              , sysdate                                           report_date_and_time 
              , to_char(mmt.transaction_id)  transaction_id
              , fu.user_name ||' / '|| fu.description                                    user_name
              , DECODE( lot_control_code, 1 ,'Sem controle de Lote' , 2,'Com controle de Lote')   lot_control
              , DECODE( serial_number_control_code, 1, 'Sem controle de Serial'
                                                  , 2, 'Pre-definido'
                                                  , 5, 'No Recebimento'
                                                  , 6, 'Baixa na Ordem de Venda' )  serial_control
              , CASE
                 WHEN    nvl(mmt.lpn_id, mmt.content_lpn_id) IS NULL AND moq.subinventory_code <> 'WHGU42GNAT'
                   THEN 
                      (SELECT listagg(lpn.license_plate_number,', ' ON OVERFLOW TRUNCATE)WITHIN GROUP (ORDER BY lpn.license_plate_number asc)
                             FROM apps.MTL_MATERIAL_TRANSACTIONS   mtt,
                                  apps.wms_license_plate_numbers   lpn,
                                  apps.oe_order_lines_all          ool
                            WHERE 1 = 1
                              AND mtt.TRX_SOURCE_LINE_ID = CASE
                                                              WHEN LINE_CATEGORY_CODE = 'ORDER'
                                                                THEN ool.line_id
                                                              WHEN LINE_CATEGORY_CODE = 'RETURN'  
                                                                THEN   
                                                                to_number(NVL(SUBSTR(ool.ORIG_SYS_LINE_REF,
                                                                                     0,
                                                                                     INSTR(ool.ORIG_SYS_LINE_REF, '.') - 1),
                                                                              -1)) -- RMA FE OE Line Id
                                                                ELSE -1
                                                                  END
                              AND mtt.TRANSACTION_TYPE_ID = 52 --sales order pick FE ORDER
                              AND mtt.transaction_quantity < 0
                              AND mtt.inventory_item_id = ool.inventory_item_id
                              AND nvl(mtt.lpn_id, mtt.content_lpn_id) = nvl(lpn.lpn_id, -1)
                              AND ool.line_id = CASE
                                                  WHEN mtt.transaction_type_name = 'RMA Receipt'
                                                    THEN mmt.TRX_SOURCE_LINE_ID
                                                  WHEN mtt.transaction_type_name = 'GPO Nationalization Receipt'
                                                     THEN 
                                                      to_number(NVL(SUBSTR(RTRIM(LTRIM(translate(mmt.TRANSACTION_REFERENCE,translate(mmt.TRANSACTION_REFERENCE||'a','1234567890.',' '),' '))),
                                                         0,
                                                         INSTR(RTRIM(LTRIM(translate(mmt.TRANSACTION_REFERENCE,translate(mmt.TRANSACTION_REFERENCE||'a','1234567890.',' '),' '))), '.') - 1),
                                                   -1))
                                                  ELSE -1
                                                    END)
                              WHEN moq.subinventory_code = 'WHGU42GNAT'
                  THEN (SELECT listagg(wlp.license_plate_number,', ' ON OVERFLOW TRUNCATE)  
                            WITHIN GROUP (ORDER BY wlp.license_plate_number asc)
                        FROM   gems_ont.ge_gpo_nationalization_line gnl, 
                               gems_ont.ge_gpo_nationalization_line gn2,
                               apps.wms_license_plate_numbers       wlp,
                               apps.po_line_locations_all           pll,
                               apps.po_lines_all                    pol,
                               apps.po_headers_all                  poh,
                               apps.rcv_shipment_headers            rsh,
                               apps.rcv_transactions                rt
                        Where  wlp.lpn_id(+) = gn2.lpn_id
                        AND gnl.nationalization_so_line_id = gn2.nationalization_so_line_id
                        AND pll.line_location_id = gnl.DOCUMENT_ID
                        AND pll.po_header_id = poh.po_header_id
                        AND pll.po_line_id = pol.po_line_id
                        AND gn2.record_type = 'IMPORT'
                        AND gnl.record_type = 'NATIONALIZATION'
                        AND rt.transaction_id                = mmt.rcv_transaction_id
                        AND rt.po_line_location_id           = pll.line_location_id
                        AND rt.shipment_header_id            = rsh.shipment_header_id)
                ELSE (SELECT lpn.LICENSE_PLATE_NUMBER
                           FROM   apps.wms_license_plate_numbers   lpn
                           WHERE  nvl(mmt.lpn_id, mmt.content_lpn_id) = nvl(lpn.lpn_id, -1))
                        END LPN_Value                                    
              , 'q12' query
--, mmt.transaction_type_id
--, mmt.trx_source_line_id
--, mmt.source_line_id
           FROM apps.mtl_serial_numbers              msn
              , apps.mtl_parameters                  mp
              , apps.mtl_system_items_b              msi
              , apps.mtl_secondary_inventories_fk_v  msifv
              , apps.gl_code_combinations            gcc
              , apps.gl_code_combinations_kfv        gcc1
              , apps.gl_code_combinations_kfv        gcc2
              , apps.gl_code_combinations_kfv        gcc3
              , apps.gl_code_combinations_kfv        gcc4
              , apps.gl_code_combinations_kfv        gcc5
              , apps.mtl_item_locations_kfv          milk
              , AMARCHIVE.MTL_MATERIAL_TRANSACTIONS       mmt
              , apps.mtl_transaction_types           mtt
              , apps.mtl_txn_source_types            mtst
              , apps.fnd_flex_values_vl              ffvv
              , apps.fnd_flex_value_sets             ffvs
              , apps.fnd_user                        fu
              , ( SELECT organization_id
                       , inventory_item_id
                       , subinventory_code
                       , locator_id
                       --, lot_number
                       --, transaction_uom_code
                       --, update_transaction_id
                       , SUM (primary_transaction_quantity) onhand_qty
                    FROM apps.mtl_onhand_quantities_detail
                   WHERE organization_id IN (SELECT ood.organization_id FROM apps.org_organization_definitions ood WHERE ood.set_of_books_id = 230 )
                   GROUP BY organization_id
                          , inventory_item_id
                          , subinventory_code
                          , locator_id
                        --  , revision
                          --, lot_number
                          --, transaction_uom_code
                          --, update_transaction_id 
                          ) moq
                          ,APPS.MTL_PAC_ACTUAL_COST_DETAILS MPACD 
          WHERE 1                                = 1
          AND decode(mmt.periodic_primary_quantity,null,mmt.transfer_transaction_id,MMT.TRANSACTION_ID) = MPACD.TRANSACTION_ID  
            AND mp.organization_id               = msi.organization_id
--            AND msi.segment1 = '60510302'
            AND msifv.organization_id            = msi.organization_id
            AND msifv.secondary_inventory_name   = moq.subinventory_code
            AND msifv.material_account           = gcc1.code_combination_id
            AND msifv.outside_processing_account = gcc2.code_combination_id
            AND msifv.material_overhead_account  = gcc3.code_combination_id
            AND msifv.overhead_account           = gcc4.code_combination_id
            AND msifv.resource_account           = gcc5.code_combination_id
            AND msi.cost_of_sales_account       = gcc.code_combination_id
            AND ffvs.flex_value_set_name        = 'GE_GL_AFF_ES_PRODUCT_LINE'
            AND ffvs.flex_value_set_id          = ffvv.flex_value_set_id
            AND ffvv.flex_value_meaning         = gcc.segment8
            AND 'TYPE 1'                        IN ('TYPE 1')
            AND msi.organization_id             IN (SELECT ood.organization_id FROM apps.org_organization_definitions ood WHERE ood.set_of_books_id = 230 )
            AND moq.inventory_item_id            = msn.inventory_item_id         (+) 
            AND moq.organization_id              = msn.current_organization_id   (+) 
            AND moq.subinventory_code            = msn.current_subinventory_code (+) 
            AND moq.locator_id                   = msn.current_locator_id        (+) 
            AND msn.current_status           (+) = 3   
            AND moq.inventory_item_id           = msi.inventory_item_id
            AND moq.organization_id             = msi.organization_id
            AND moq.locator_id                  = milk.inventory_location_id
            AND msn.last_transaction_id         = mmt.transaction_id
--    AND MMT.TRANSACTION_ID = 2562828197
            AND mtt.transaction_type_id         = mmt.transaction_type_id 
            AND mtst.transaction_source_type_id = mmt.transaction_source_type_id
            AND msi.serial_number_control_code  <> '1' 
            AND msi.lot_control_code            = '1'  --Sem controle de Lote
            AND fu.user_id                      = mmt.created_by 
    AND MMT.TRANSACTION_ID NOT IN(SELECT MMT2.TRANSACTION_ID 
                                  FROM APPS.MTL_MATERIAL_TRANSACTIONS MMT2
                                  WHERE MMT2.TRANSACTION_ID = MMT.TRANSACTION_ID)
------------------------------------------------------------------------------
UNION  
------------------------------------------------------------------------------ 
-- Sem Controle de Serial e sem Controle de Lote e COM Locator
         SELECT DISTINCT  --'13' NUM
        /* ( SELECT ccg.cost_group 
                             FROM apps.cst_cost_groups            ccg
                                , apps.cst_cost_group_assignments ccga
                            WHERE ccga.cost_group_id     = ccg.cost_group_id
                              AND ccga.organization_id   = mp.organization_id )  cost_group*/
            ( SELECT ccg.cost_group 
                             FROM apps.cst_cost_groups            ccg
                            WHERE MPACD.cost_group_id     = ccg.cost_group_id )  cost_group  
              , ( SELECT ( SELECT cpp1.period_name 
                             FROM apps.cst_pac_item_costs   cst
                                , apps.cst_pac_periods      cpp1
                            WHERE cst.pac_period_id     = (SELECT MAX(PAC_PERIOD_ID)                   FROM APPS.CST_PAC_PERIODS                  WHERE LEGAL_ENTITY = (SELECT LEGAL_ENTITY                                          FROM APPS.ORG_ORGANIZATION_DEFINITIONS OOD                                         WHERE OOD.ORGANIZATION_ID = mp.organization_id                                         ) )
                              AND cst.pac_period_id     = cpp1.pac_period_id
                              AND cst.inventory_item_id = msi.inventory_item_id
                              AND cst.cost_group_id     = ccg.cost_group_id )  
                    FROM apps.cst_cost_groups            ccg
                       , apps.cst_cost_group_assignments ccga
                   WHERE ccga.cost_group_id     = ccg.cost_group_id
                     AND ccga.organization_id   = mp.organization_id ) period_name
              , mp.organization_code
              , mp.attribute7                organization_type
              , mp.organization_id 
              , moq.subinventory_code
              , msifv.description            subinv_description
              , milk.concatenated_segments   locators
              , DECODE( msifv.asset_inventory, 1 , 'Asset', 2, 'Non Asset')   asset_type
              , msi.segment1                 part_number
              , DECODE(msi.inventory_asset_flag, NULL, 'No', 'N', 'No', 'Y', 'Yes')                         flag_asset_inventory
              , DECODE(msi.costing_enabled_flag, NULL, 'No', 'N', 'No', 'Y', 'Yes')                         flag_de_custo
              , msi.description              descrip_eng
              , msi.attribute3               descrip_ptb
              , msi.creation_date            item_creation_date
              , (trunc(SYSDATE) - trunc(msi.creation_date))      days_from_creation
              , gcc.segment8                                     product_line
              , ffvv.description                                 desc_prod_line   
              , msi.primary_uom_code    uom
              , moq.onhand_qty                                   transaction_quantity
              , NVL(( SELECT cic.item_cost
                        FROM apps.cst_item_costs cic
                       WHERE cic.organization_id   = msi.organization_id
                         AND cic.inventory_item_id = msi.inventory_item_id
                         AND cic.cost_type_id      = 1 ),0)  custo_unit_inv
              /*, nvl(( SELECT ( SELECT ROUND (cst.item_cost,2) 
                                 FROM apps.cst_pac_item_costs   cst
                                WHERE cst.pac_period_id     = (SELECT MAX(PAC_PERIOD_ID)                   FROM APPS.CST_PAC_PERIODS                  WHERE LEGAL_ENTITY = (SELECT LEGAL_ENTITY                                          FROM APPS.ORG_ORGANIZATION_DEFINITIONS OOD                                         WHERE OOD.ORGANIZATION_ID = mp.organization_id                                         ) )
                                  AND cst.inventory_item_id = msi.inventory_item_id
                                  AND cst.cost_group_id     = ccg.cost_group_id )  item_cost
                        FROM apps.cst_cost_groups            ccg
                           , apps.cst_cost_group_assignments ccga
                       WHERE ccga.cost_group_id     = ccg.cost_group_id
                         AND ccga.organization_id   = mp.organization_id ) ,0) custo_unit_pac*/
                , nvl((SELECT ROUND (cst.item_cost,2) 
                       FROM apps.cst_pac_item_costs   cst
                      WHERE cst.pac_period_id     = (SELECT MAX(PAC_PERIOD_ID)                   
                                                                FROM APPS.CST_PAC_PERIODS                  
                                                                WHERE LEGAL_ENTITY = (SELECT LEGAL_ENTITY                                         
                                                                                        FROM APPS.ORG_ORGANIZATION_DEFINITIONS OOD                                        
                                                                                        WHERE OOD.ORGANIZATION_ID = mp.organization_id
                                                        ) )
                        AND cst.inventory_item_id = msi.inventory_item_id
                        AND cst.cost_group_id     = MPACD.cost_group_id) ,0)  custo_unit_pac
              , moq.lot_number
              , NULL   lot_creation_date
              , NULL   lot_qty_days_creation
              , NULL   lot_expiration_date
              , NULL   serial_number
              , NULL   serial_creation_date
              , mtt.transaction_type_name           last_transaction_type
              , mmt.transaction_source_name         last_transaction_source
              , mtst.transaction_source_type_name   last_source_type
              , mmt.source_code
              , TO_CHAR(mmt.transaction_date, 'DD-MON-RRRR')      transaction_date
        , (SELECT TO_CHAR(mmt1.transaction_date, 'DD-MON-RRRR') 
          FROM apps.mtl_material_transactions mmt1
          WHERE mmt1.transaction_type_id=420
          AND mmt1.source_line_id=mmt.source_line_id) initial_consignment_date
              , (TRUNC ( SYSDATE )- TRUNC(mmt.transaction_date))  transaction_qty_of_days
              , TO_CHAR(mmt.transaction_reference)                transaction_reference
              , CASE WHEN mmt.source_code = '3PL_REMITTANCE_BRAZIL' THEN
                     (SELECT listagg(pha.segment1,', ' ON OVERFLOW TRUNCATE)  
                      WITHIN GROUP (ORDER BY pha.segment1 asc)
                        FROM apps.po_headers_all        pha,
                             apps.po_lines_all          pla
                       WHERE pla.po_line_id   = mmt.source_line_id
                         AND pla.po_header_id = pha.po_header_id)
                     WHEN mmt.source_code IN ('ORDER ENTRY','IIP') THEN
                        NULL
                     WHEN mmt.source_code = 'RCV' THEN
                        ( SELECT listagg(pha.segment1,', ' ON OVERFLOW TRUNCATE)  
                          WITHIN GROUP (ORDER BY pha.segment1 asc)
                            FROM apps.po_headers_all            pha
                               , apps.po_lines_all              pla
                               , apps.po_line_locations_all     plla
                               , apps.rcv_shipment_headers      rsh
                               , apps.rcv_transactions          rt
                           WHERE rt.transaction_id                = mmt.rcv_transaction_id
                             AND rt.po_line_location_id           = plla.line_location_id
                             AND plla.po_line_id                  = pla.po_line_id
                             AND pha.po_header_id                 = pla.po_header_id
                             AND rt.shipment_header_id            = rsh.shipment_header_id
                             AND rsh.receipt_source_code          = 'VENDOR'  )
                     ELSE
                        NULL
                END      po_number
              , CASE WHEN mmt.source_code = '3PL_REMITTANCE_BRAZIL' THEN
                     (SELECT listagg(aps.vendor_name,', ' ON OVERFLOW TRUNCATE)  
                      WITHIN GROUP (ORDER BY aps.vendor_name asc)
                        FROM apps.po_headers_all        pha
                           , apps.po_lines_all          pla
                           , apps.ap_suppliers          aps
                           , apps.ap_supplier_sites_all  apss
                       WHERE pla.po_line_id     = mmt.source_line_id
                         AND pla.po_header_id   = pha.po_header_id
                         AND pha.vendor_id      = aps.vendor_id
                         AND aps.vendor_id      = apss.vendor_id
                         AND pha.vendor_site_id = apss.vendor_site_id )
                     WHEN mmt.source_code IN ('ORDER ENTRY','IIP') THEN
                        NULL
                     WHEN mmt.source_code = 'RCV' THEN
                        ( SELECT listagg(aps.vendor_name,', ' ON OVERFLOW TRUNCATE)  
                          WITHIN GROUP (ORDER BY aps.vendor_name asc)
                            FROM apps.po_headers_all            pha
                               , apps.po_lines_all              pla
                               , apps.po_line_locations_all     plla
                               , apps.rcv_shipment_headers      rsh
                               , apps.rcv_transactions          rt
                               , apps.ap_suppliers              aps
                               , apps.ap_supplier_sites_all     apss
                           WHERE rt.transaction_id          = mmt.rcv_transaction_id
                             AND rt.po_line_location_id     = plla.line_location_id
                             AND plla.po_line_id            = pla.po_line_id
                             AND pha.po_header_id           = pla.po_header_id
                             AND rt.shipment_header_id      = rsh.shipment_header_id
                             AND rsh.receipt_source_code    = 'VENDOR'
                             AND pha.vendor_id              = aps.vendor_id
                             AND aps.vendor_id              = apss.vendor_id
                             AND pha.vendor_site_id         = apss.vendor_site_id  )
                     ELSE
                        NULL
                END     po_supplier
              , CASE WHEN mmt.source_code = '3PL_REMITTANCE_BRAZIL' THEN
                     ( SELECT listagg(cfi.invoice_num,', ' ON OVERFLOW TRUNCATE)  
                         WITHIN GROUP (ORDER BY cfi.invoice_num asc)
                         FROM apps.cll_f189_invoice_lines cfil
                            , apps.cll_f189_invoices      cfi
                            , apps.po_lines_all           pla
                            , apps.po_line_locations_all  plla
                        WHERE plla.po_line_id       = pla.po_line_id
                          AND pla.po_line_id        = mmt.source_line_id
                          AND plla.line_location_id = cfil.line_location_id
                          AND cfil.invoice_id       = cfi.invoice_id )
                     WHEN mmt.source_code IN ('ORDER ENTRY','IIP') THEN
                        NULL
                     WHEN mmt.source_code = 'RCV' THEN
                        ( SELECT listagg(cfi.invoice_num,', ' ON OVERFLOW TRUNCATE)  
                            WITHIN GROUP (ORDER BY cfi.invoice_num asc)
                            FROM apps.po_headers_all            pha
                               , apps.po_lines_all              pla
                               , apps.po_line_locations_all     plla
                               , apps.cll_f189_invoice_lines    cfil
                               , apps.cll_f189_invoices         cfi
                               , apps.rcv_shipment_headers      rsh
                               , apps.rcv_transactions          rt
                           WHERE rt.transaction_id          = mmt.rcv_transaction_id
                             AND rt.po_line_location_id     = plla.line_location_id
                             AND plla.line_location_id      = cfil.line_location_id
                             AND cfil.invoice_id            = cfi.invoice_id
                             AND plla.po_line_id            = pla.po_line_id
                             AND pha.po_header_id           = pla.po_header_id
                             AND rt.shipment_header_id      = rsh.shipment_header_id
                             AND rsh.receipt_source_code    = 'VENDOR'   )
                     ELSE
                        NULL
                END    NF_RI
             , (SELECT DECODE( mmt.source_code, '3PL_REMITTANCE_BRAZIL',NULL,to_char(ooha.order_number) )
                  FROM apps.oe_order_headers_all  ooha,
                       apps.oe_order_lines_all    oola  
                 WHERE oola.line_id        = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                   AND oola.header_id      = ooha.header_id )   order_number
               -- 
               -- alterado para BIll_to por Sinval inicio
               --
               , CASE WHEN ( SELECT ottl.name
                             FROM apps.oe_transaction_types_tl    ottl
                                , apps.oe_order_headers_all  ooha
                                , apps.oe_order_lines_all    oola  
                            WHERE oola.line_id        = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND oola.header_id      = ooha.header_id
                              AND ooha.order_type_id  = ottl.transaction_type_id  ) = 'GPO_BR_FE_SHIPMENT' THEN
                     (SELECT listagg(hp.party_name,', ' ON OVERFLOW TRUNCATE)  
                      WITHIN GROUP (ORDER BY hp.party_name asc)
                        FROM apps.hz_parties             hp
                           , apps.hz_cust_accounts       hca
                           , apps.oe_order_lines_all     oola
                           , apps.hz_cust_acct_sites_all hcas
                           , apps.hz_cust_site_uses_all  hcsu
                       WHERE oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                         AND oola.end_customer_site_use_id  = hcsu.site_use_id
                         AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                         AND hcas.cust_account_id           = hca.cust_account_id
                         AND hca.party_id                   = hp.party_id )
                  ELSE
                     CASE WHEN (mmt.source_code = '3PL_REMITTANCE_BRAZIL') THEN
                       (SELECT listagg(hp.party_name,', ' ON OVERFLOW TRUNCATE)  
                        WITHIN GROUP (ORDER BY hp.party_name asc)
                          FROM apps.hz_parties             hp,
                               apps.hz_cust_accounts       hca,
                               apps.ra_customer_trx_all    rcta,
                               apps.hz_cust_acct_sites_all hcas,
                               apps.hz_cust_site_uses_all  hcsu
                         WHERE rcta.interface_header_attribute1 = mp.organization_code||'_'||mmt.transaction_reference
                           AND rcta.ship_to_site_use_id         = hcsu.site_use_id
                           AND hcsu.cust_acct_site_id           = hcas.cust_acct_site_id
                           AND hcas.cust_account_id             = hca.cust_account_id
                           AND hca.party_id                     = hp.party_id
                           AND rcta.org_id                      = 4330)
                     ELSE
                        (SELECT listagg(hp.party_name,', ' ON OVERFLOW TRUNCATE)  
                         WITHIN GROUP (ORDER BY hp.party_name asc)
                           FROM apps.hz_parties             hp
                              , apps.hz_cust_accounts       hca
                              , apps.oe_order_lines_all     oola
                              , apps.hz_cust_acct_sites_all hcas
                              , apps.hz_cust_site_uses_all  hcsu
                          WHERE oola.line_id                = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                            AND oola.ship_to_org_id         = hcsu.site_use_id
                            AND hcsu.cust_acct_site_id      = hcas.cust_acct_site_id
                            AND hcas.cust_account_id        = hca.cust_account_id
                            AND hca.party_id                = hp.party_id )
                    END                 
               END    customer_name
             , CASE WHEN ( SELECT ottl.name
                             FROM apps.oe_transaction_types_tl    ottl
                                , apps.oe_order_headers_all  ooha
                                , apps.oe_order_lines_all    oola  
                            WHERE oola.line_id        = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND oola.header_id      = ooha.header_id
                              AND ooha.order_type_id  = ottl.transaction_type_id  ) = 'GPO_BR_FE_SHIPMENT' THEN
                     (SELECT listagg(hca.account_number,', ' ON OVERFLOW TRUNCATE)  
                      WITHIN GROUP (ORDER BY hca.account_number asc)
                        FROM apps.hz_parties             hp
                           , apps.hz_cust_accounts       hca
                           , apps.oe_order_lines_all     oola
                           , apps.hz_cust_acct_sites_all hcas
                           , apps.hz_cust_site_uses_all  hcsu
                       WHERE oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                         AND oola.end_customer_site_use_id  = hcsu.site_use_id
                         AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                         AND hcas.cust_account_id           = hca.cust_account_id
                         AND hca.party_id                   = hp.party_id )
                  ELSE
                     CASE WHEN (mmt.source_code = '3PL_REMITTANCE_BRAZIL') THEN
                        (SELECT listagg(hca.account_number,', ' ON OVERFLOW TRUNCATE)  
                         WITHIN GROUP (ORDER BY hca.account_number asc)
                           FROM apps.hz_parties             hp,
                                apps.hz_cust_accounts       hca,
                                apps.ra_customer_trx_all    rcta,
                                apps.hz_cust_acct_sites_all hcas,
                                apps.hz_cust_site_uses_all  hcsu
                          WHERE rcta.interface_header_attribute1 = mp.organization_code||'_'||mmt.transaction_reference
                            AND rcta.ship_to_site_use_id         = hcsu.site_use_id
                            AND hcsu.cust_acct_site_id           = hcas.cust_acct_site_id
                            AND hcas.cust_account_id             = hca.cust_account_id
                            AND hca.party_id                     = hp.party_id
                            AND rcta.org_id                      = 4330)
                     ELSE
                        (SELECT listagg(hca.account_number,', ' ON OVERFLOW TRUNCATE)  
                         WITHIN GROUP (ORDER BY hca.account_number asc)
                           FROM apps.hz_parties             hp
                              , apps.hz_cust_accounts       hca
                              , apps.oe_order_lines_all     oola
                              , apps.hz_cust_acct_sites_all hcas
                              , apps.hz_cust_site_uses_all  hcsu
                          WHERE oola.line_id                = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                            AND oola.ship_to_org_id         = hcsu.site_use_id
                            AND hcsu.cust_acct_site_id      = hcas.cust_acct_site_id
                            AND hcas.cust_account_id        = hca.cust_account_id
                            AND hca.party_id                = hp.party_id   )
                     END
                  END   customer_number
              --
              , CASE WHEN ( SELECT ottl.name
                             FROM apps.oe_transaction_types_tl    ottl
                                , apps.oe_order_headers_all  ooha
                                , apps.oe_order_lines_all    oola  
                            WHERE oola.line_id        = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND oola.header_id      = ooha.header_id
                              AND ooha.order_type_id  = ottl.transaction_type_id  ) = 'GPO_BR_FE_SHIPMENT' THEN
                     (SELECT listagg(DECODE(hcas.global_attribute2
                                           , '2',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'/'|| hcas.global_attribute4 ||'-'|| hcas.global_attribute5
                                           , '1',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'-'|| hcas.global_attribute5 
                                           , '3',HCSU.LOCATION||' - '||hcas.global_attribute3 ),', ' ON OVERFLOW TRUNCATE)
                     WITHIN GROUP (ORDER BY hcas.global_attribute2 asc ) 
                        FROM apps.hz_parties             hp
                           , apps.hz_cust_accounts       hca
                           , apps.oe_order_lines_all     oola
                           , apps.hz_cust_acct_sites_all hcas
                           , apps.hz_cust_site_uses_all  hcsu
                       WHERE oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                         AND oola.end_customer_site_use_id  = hcsu.site_use_id
                         AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                         AND hcas.cust_account_id           = hca.cust_account_id
                         AND hca.party_id                   = hp.party_id )
                ELSE
                   CASE WHEN (mmt.source_code = '3PL_REMITTANCE_BRAZIL') THEN
                      (SELECT listagg(DECODE(hcas.global_attribute2
                                           , '2',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'/'|| hcas.global_attribute4 ||'-'|| hcas.global_attribute5
                                           , '1',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'-'|| hcas.global_attribute5 
                                           , '3',HCSU.LOCATION||' - '||hcas.global_attribute3 ),', ' ON OVERFLOW TRUNCATE)
                     WITHIN GROUP (ORDER BY hcas.global_attribute2 asc) 
                         FROM apps.ra_customer_trx_all     rcta
                            , apps.hz_cust_acct_sites_all  hcas
                            , apps.hz_cust_site_uses_all   hcsu
                        WHERE rcta.interface_header_attribute1 = mp.organization_code||'_'||mmt.transaction_reference
                          AND rcta.ship_to_site_use_id         = hcsu.site_use_id
                          AND hcsu.cust_acct_site_id           = hcas.cust_acct_site_id
                          AND rcta.org_id                      = 4330)
                   ELSE
                      (SELECT listagg(DECODE(hcas.global_attribute2
                                           , '2',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'/'|| hcas.global_attribute4 ||'-'|| hcas.global_attribute5
                                           , '1',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'-'|| hcas.global_attribute5 
                                           , '3',HCSU.LOCATION||' - '||hcas.global_attribute3 ),', ' ON OVERFLOW TRUNCATE)
                      WITHIN GROUP (ORDER BY hcas.global_attribute2 asc) 
                         FROM apps.hz_parties             hp
                            , apps.hz_cust_accounts       hca
                            , apps.oe_order_lines_all     oola
                            , apps.hz_cust_acct_sites_all hcas
                            , apps.hz_cust_site_uses_all  hcsu
                        WHERE oola.line_id                = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                          AND oola.ship_to_org_id         = hcsu.site_use_id
                          AND hcsu.cust_acct_site_id      = hcas.cust_acct_site_id
                          AND hcas.cust_account_id        = hca.cust_account_id
                          AND hca.party_id                = hp.party_id  )
                   END
                END  customer_cnpj_cpf
               -- 
              , CASE WHEN (mmt.source_code = '3PL_REMITTANCE_BRAZIL') THEN
                      (SELECT listagg(DECODE(hcas.global_attribute2
                                           , '2',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'/'|| hcas.global_attribute4 ||'-'|| hcas.global_attribute5
                                           , '1',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'-'|| hcas.global_attribute5 
                                           , '3',HCSU.LOCATION||' - '||hcas.global_attribute3 ),', ' ON OVERFLOW TRUNCATE)
                       WITHIN GROUP (ORDER BY hcas.global_attribute2 asc )
                         FROM apps.ra_customer_trx_all         rcta
                            , apps.hz_cust_acct_sites_all      hcas
                            , apps.hz_cust_site_uses_all       hcsu
                        WHERE rcta.interface_header_attribute1 = mp.organization_code||'_'||mmt.transaction_reference
                          AND rcta.bill_to_site_use_id         = hcsu.site_use_id
                          AND hcsu.cust_acct_site_id           = hcas.cust_acct_site_id
                          AND rcta.org_id                      = 4330
                          AND ROWNUM = 1)
                   ELSE
                     --
                     CASE WHEN (select DISTINCT RCTL.INTERFACE_LINE_CONTEXT
                             FROM apps.hz_parties                hp
                                , apps.hz_cust_accounts          hca
                                , apps.oe_order_lines_all        oola
                                , apps.oe_order_headers_all      ooha
                                , apps.ra_customer_trx_lines_all rctl
                                , apps.ra_customer_trx_all       rcta
                                , apps.hz_cust_acct_sites_all    hcas
                                , apps.hz_cust_site_uses_all     hcsu
                            WHERE ooha.header_id                 = oola.header_id
                              AND oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND rctl.inventory_item_id         = oola.inventory_item_id
                              AND rctl.line_type                 = 'LINE'
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE1 = to_char(ooha.order_number)
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE6 = to_char(oola.line_id)
                              AND RCTL.INTERFACE_LINE_CONTEXT    = 'ORDER ENTRY'
                              AND rctl.customer_trx_id           = rcta.customer_trx_id
                              AND rcta.bill_to_site_use_id       = hcsu.site_use_id
                              AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                              AND hcas.cust_account_id           = hca.cust_account_id
                              AND hca.party_id                   = hp.party_id 
                              AND ROWNUM = 1) = 'ORDER ENTRY' THEN
                     --
                     (SELECT DISTINCT DECODE(hcas.global_attribute2
                                           , '2',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'/'|| hcas.global_attribute4 ||'-'|| hcas.global_attribute5
                                           , '1',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'-'|| hcas.global_attribute5 
                                           , '3',HCSU.LOCATION||' - '||hcas.global_attribute3)
                             FROM apps.hz_parties                hp
                                , apps.hz_cust_accounts          hca
                                , apps.oe_order_lines_all        oola
                                , apps.oe_order_headers_all      ooha
                                , apps.ra_customer_trx_lines_all rctl
                                , apps.ra_customer_trx_all       rcta
                                , apps.hz_cust_acct_sites_all    hcas
                                , apps.hz_cust_site_uses_all     hcsu
                            WHERE ooha.header_id                 = oola.header_id
                              AND oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND rctl.inventory_item_id         = oola.inventory_item_id
                              AND rctl.line_type                 = 'LINE'
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE1 = to_char(ooha.order_number)
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE6 = to_char(oola.line_id)
                              AND RCTL.INTERFACE_LINE_CONTEXT    = 'ORDER ENTRY'
                              AND rctl.customer_trx_id           = rcta.customer_trx_id
                              AND rcta.bill_to_site_use_id       = hcsu.site_use_id
                              AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                              AND hcas.cust_account_id           = hca.cust_account_id
                              AND hca.party_id                   = hp.party_id
                              AND ROWNUM = 1)
                     --
                     ELSE
                     --            
                     CASE WHEN 
                          ( SELECT DISTINCT RCTL.INTERFACE_LINE_CONTEXT
                             FROM apps.hz_parties                hp
                                , apps.hz_cust_accounts          hca
                                , apps.oe_order_lines_all        oola
                                , apps.oe_order_headers_all      ooha
                                , apps.ra_customer_trx_lines_all rctl
                                , apps.ra_customer_trx_all       rcta
                                , apps.hz_cust_acct_sites_all    hcas
                                , apps.hz_cust_site_uses_all     hcsu
                            WHERE ooha.header_id                 = oola.header_id
                              AND oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND rctl.inventory_item_id         = oola.inventory_item_id
                              AND rctl.line_type                 = 'LINE'
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE1 = ooha.ORIG_SYS_DOCUMENT_REF
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE7 = oola.ORIG_SYS_LINE_REF
                              AND RCTL.INTERFACE_LINE_CONTEXT    = 'GEMS_PB_RR'
                              AND rctl.customer_trx_id           = rcta.customer_trx_id
                              AND rcta.bill_to_site_use_id       = hcsu.site_use_id
                              AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                              AND hcas.cust_account_id           = hca.cust_account_id
                              AND ROWNUM = 1 ) = 'GEMS_PB_RR' THEN
                     --
                     (SELECT DISTINCT DECODE(hcas.global_attribute2
                                           , '2',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'/'|| hcas.global_attribute4 ||'-'|| hcas.global_attribute5
                                           , '1',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'-'|| hcas.global_attribute5 
                                           , '3',HCSU.LOCATION||' - '||hcas.global_attribute3)
                             FROM apps.hz_parties                hp
                                , apps.hz_cust_accounts          hca
                                , apps.oe_order_lines_all        oola
                                , apps.oe_order_headers_all      ooha
                                , apps.ra_customer_trx_lines_all rctl
                                , apps.ra_customer_trx_all       rcta
                                , apps.hz_cust_acct_sites_all    hcas
                                , apps.hz_cust_site_uses_all     hcsu
                            WHERE ooha.header_id                 = oola.header_id
                              AND oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND rctl.inventory_item_id         = oola.inventory_item_id
                              AND rctl.line_type                 = 'LINE'
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE1 = ooha.ORIG_SYS_DOCUMENT_REF
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE7 = oola.ORIG_SYS_LINE_REF
                              AND RCTL.INTERFACE_LINE_CONTEXT    = 'GEMS_PB_RR'
                              AND rctl.customer_trx_id           = rcta.customer_trx_id
                              AND rcta.bill_to_site_use_id       = hcsu.site_use_id
                              AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                              AND hcas.cust_account_id           = hca.cust_account_id 
                              AND ROWNUM = 1 )
                     --
                     ELSE
                     --
                     (SELECT DISTINCT DECODE(hcas.global_attribute2
                                   , '2',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'/'|| hcas.global_attribute4 ||'-'|| hcas.global_attribute5
                                   , '1',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'-'|| hcas.global_attribute5 
                                   , '3',HCSU.LOCATION||' - '||hcas.global_attribute3)
                             --
                      FROM   APPS.HZ_CUST_ACCT_SITES_ALL HCAS,
                             APPS.HZ_CUST_SITE_USES_ALL  HCSU,
                             APPS.OE_ORDER_LINES_ALL     OOLA,
                             APPS.OE_ORDER_HEADERS_ALL   OOHA
                             --
                      WHERE  HCSU.SITE_USE_CODE     = 'BILL_TO'
                      AND    HCSU.CUST_ACCT_SITE_ID = HCAS.CUST_ACCT_SITE_ID
                      AND    HCSU.SITE_USE_ID       = NVL(OOLA.ATTRIBUTE1, OOHA.INVOICE_TO_ORG_ID)
                      AND    OOLA.LINE_ID           = NVL(MMT.TRX_SOURCE_LINE_ID, MMT.SOURCE_LINE_ID)
                      AND    OOHA.HEADER_ID         = OOLA.HEADER_ID
                      AND    ROWNUM = 1)
                     --
                     END
                  END
               END      bill_to_CNPJ_CPF
               --
                             --
              , CASE WHEN (mmt.source_code = '3PL_REMITTANCE_BRAZIL') THEN
                        (SELECT listagg(hp.party_name,', ' ON OVERFLOW TRUNCATE)  
                        WITHIN GROUP (ORDER BY hp.party_name asc)
                          FROM apps.hz_parties             hp,
                               apps.hz_cust_accounts       hca,
                               apps.ra_customer_trx_all    rcta,
                               apps.hz_cust_acct_sites_all hcas,
                               apps.hz_cust_site_uses_all  hcsu
                         WHERE rcta.interface_header_attribute1 = mp.organization_code||'_'||mmt.transaction_reference
                           AND rcta.bill_to_site_use_id         = hcsu.site_use_id
                           AND hcsu.cust_acct_site_id           = hcas.cust_acct_site_id
                           AND hcas.cust_account_id             = hca.cust_account_id
                           AND hca.party_id                     = hp.party_id
                           AND rcta.org_id                      = 4330)
                   ELSE
                     --
                     CASE WHEN (select DISTINCT RCTL.INTERFACE_LINE_CONTEXT
                             FROM apps.hz_parties                hp
                                , apps.hz_cust_accounts          hca
                                , apps.oe_order_lines_all        oola
                                , apps.oe_order_headers_all      ooha
                                , apps.ra_customer_trx_lines_all rctl
                                , apps.ra_customer_trx_all       rcta
                                , apps.hz_cust_acct_sites_all    hcas
                                , apps.hz_cust_site_uses_all     hcsu
                            WHERE ooha.header_id                 = oola.header_id
                              AND oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND rctl.inventory_item_id         = oola.inventory_item_id
                              AND rctl.line_type                 = 'LINE'
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE1 = to_char(ooha.order_number)
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE6 = to_char(oola.line_id)
                              AND RCTL.INTERFACE_LINE_CONTEXT    = 'ORDER ENTRY'
                              AND rctl.customer_trx_id           = rcta.customer_trx_id
                              AND rcta.bill_to_site_use_id       = hcsu.site_use_id
                              AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                              AND hcas.cust_account_id           = hca.cust_account_id
                              AND hca.party_id                   = hp.party_id 
                              AND ROWNUM = 1) = 'ORDER ENTRY' THEN
                     --
                     (SELECT listagg(hp.party_name,', ' ON OVERFLOW TRUNCATE)  
                         WITHIN GROUP (ORDER BY hp.party_name asc)
                             FROM apps.hz_parties                hp
                                , apps.hz_cust_accounts          hca
                                , apps.oe_order_lines_all        oola
                                , apps.oe_order_headers_all      ooha
                                , apps.ra_customer_trx_lines_all rctl
                                , apps.ra_customer_trx_all       rcta
                                , apps.hz_cust_acct_sites_all    hcas
                                , apps.hz_cust_site_uses_all     hcsu
                            WHERE ooha.header_id                 = oola.header_id
                              AND oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND rctl.inventory_item_id         = oola.inventory_item_id
                              AND rctl.line_type                 = 'LINE'
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE1 = to_char(ooha.order_number)
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE6 = to_char(oola.line_id)
                              AND RCTL.INTERFACE_LINE_CONTEXT    = 'ORDER ENTRY'
                              AND rctl.customer_trx_id           = rcta.customer_trx_id
                              AND rcta.bill_to_site_use_id       = hcsu.site_use_id
                              AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                              AND hcas.cust_account_id           = hca.cust_account_id
                              AND hca.party_id                   = hp.party_id
                              AND ROWNUM = 1)
                     --
                     ELSE
                     --            
                     CASE WHEN 
                          ( SELECT DISTINCT RCTL.INTERFACE_LINE_CONTEXT
                             FROM apps.hz_parties                hp
                                , apps.hz_cust_accounts          hca
                                , apps.oe_order_lines_all        oola
                                , apps.oe_order_headers_all      ooha
                                , apps.ra_customer_trx_lines_all rctl
                                , apps.ra_customer_trx_all       rcta
                                , apps.hz_cust_acct_sites_all    hcas
                                , apps.hz_cust_site_uses_all     hcsu
                            WHERE ooha.header_id                 = oola.header_id
                              AND oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND rctl.inventory_item_id         = oola.inventory_item_id
                              AND rctl.line_type                 = 'LINE'
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE1 = ooha.ORIG_SYS_DOCUMENT_REF
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE7 = oola.ORIG_SYS_LINE_REF
                              AND RCTL.INTERFACE_LINE_CONTEXT    = 'GEMS_PB_RR'
                              AND rctl.customer_trx_id           = rcta.customer_trx_id
                              AND rcta.bill_to_site_use_id       = hcsu.site_use_id
                              AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                              AND hcas.cust_account_id           = hca.cust_account_id
                              AND ROWNUM = 1 ) = 'GEMS_PB_RR' THEN
                     --
                     (SELECT listagg(hp.party_name,', ' ON OVERFLOW TRUNCATE)  
                         WITHIN GROUP (ORDER BY hp.party_name asc)
                             FROM apps.hz_parties                hp
                                , apps.hz_cust_accounts          hca
                                , apps.oe_order_lines_all        oola
                                , apps.oe_order_headers_all      ooha
                                , apps.ra_customer_trx_lines_all rctl
                                , apps.ra_customer_trx_all       rcta
                                , apps.hz_cust_acct_sites_all    hcas
                                , apps.hz_cust_site_uses_all     hcsu
                            WHERE ooha.header_id                 = oola.header_id
                              AND oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND rctl.inventory_item_id         = oola.inventory_item_id
                              AND rctl.line_type                 = 'LINE'
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE1 = ooha.ORIG_SYS_DOCUMENT_REF
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE7 = oola.ORIG_SYS_LINE_REF
                              AND RCTL.INTERFACE_LINE_CONTEXT    = 'GEMS_PB_RR'
                              AND rctl.customer_trx_id           = rcta.customer_trx_id
                              AND rcta.bill_to_site_use_id       = hcsu.site_use_id
                              AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                              AND hcas.cust_account_id           = hca.cust_account_id 
                              AND ROWNUM = 1 )
                     --
                     ELSE
                     --
                     (SELECT listagg(hp.party_name,', ' ON OVERFLOW TRUNCATE)  
                         WITHIN GROUP (ORDER BY hp.party_name asc)
                      FROM   APPS.HZ_CUST_ACCT_SITES_ALL HCAS,
                             apps.hz_parties             hp,
                             apps.hz_cust_accounts       hca,
                             APPS.HZ_CUST_SITE_USES_ALL  HCSU,
                             APPS.OE_ORDER_LINES_ALL     OOLA,
                             APPS.OE_ORDER_HEADERS_ALL   OOHA
                             --
                      WHERE  HCSU.SITE_USE_CODE     = 'BILL_TO'
                      AND    HCSU.CUST_ACCT_SITE_ID = HCAS.CUST_ACCT_SITE_ID
                      AND    HCSU.SITE_USE_ID       = NVL(OOLA.ATTRIBUTE1, OOHA.INVOICE_TO_ORG_ID)
                      AND    OOLA.LINE_ID           = NVL(MMT.TRX_SOURCE_LINE_ID, MMT.SOURCE_LINE_ID)
                      AND    OOHA.HEADER_ID         = OOLA.HEADER_ID
                      AND    hcas.cust_account_id   = hca.cust_account_id
                      AND    hca.party_id           = hp.party_id 
                      AND    ROWNUM = 1)
                     --          
                     END
                  END
               END      bill_to_Customer_name
               --
                , CASE WHEN (mmt.source_code = '3PL_REMITTANCE_BRAZIL') THEN
                      (SELECT listagg(DECODE(hcas.global_attribute2
                                           , '2',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'/'|| hcas.global_attribute4 ||'-'|| hcas.global_attribute5
                                           , '1',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'-'|| hcas.global_attribute5 
                                           , '3',HCSU.LOCATION||' - '||hcas.global_attribute3 ),', ' ON OVERFLOW TRUNCATE)
                       WITHIN GROUP (ORDER BY hcas.global_attribute2 asc )
                         FROM apps.ra_customer_trx_all         rcta
                            , apps.hz_cust_acct_sites_all      hcas
                            , apps.hz_cust_site_uses_all       hcsu
                        WHERE rcta.interface_header_attribute1 = mp.organization_code||'_'||mmt.transaction_reference
                          AND rcta.ship_to_site_use_id         = hcsu.site_use_id
                          AND hcsu.cust_acct_site_id           = hcas.cust_acct_site_id
                          AND rcta.org_id                      = 4330
                          AND ROWNUM = 1)
                   ELSE
                     --
                     CASE WHEN (select DISTINCT RCTL.INTERFACE_LINE_CONTEXT
                             FROM apps.hz_parties                hp
                                , apps.hz_cust_accounts          hca
                                , apps.oe_order_lines_all        oola
                                , apps.oe_order_headers_all      ooha
                                , apps.ra_customer_trx_lines_all rctl
                                , apps.ra_customer_trx_all       rcta
                                , apps.hz_cust_acct_sites_all    hcas
                                , apps.hz_cust_site_uses_all     hcsu
                            WHERE ooha.header_id                 = oola.header_id
                              AND oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND rctl.inventory_item_id         = oola.inventory_item_id
                              AND rctl.line_type                 = 'LINE'
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE1 = to_char(ooha.order_number)
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE6 = to_char(oola.line_id)
                              AND RCTL.INTERFACE_LINE_CONTEXT    = 'ORDER ENTRY'
                              AND rctl.customer_trx_id           = rcta.customer_trx_id
                              AND rcta.ship_to_site_use_id       = hcsu.site_use_id
                              AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                              AND hcas.cust_account_id           = hca.cust_account_id
                              AND hca.party_id                   = hp.party_id 
                              AND ROWNUM = 1) = 'ORDER ENTRY' THEN
                     --
                     (SELECT DISTINCT DECODE(hcas.global_attribute2
                                           , '2',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'/'|| hcas.global_attribute4 ||'-'|| hcas.global_attribute5
                                           , '1',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'-'|| hcas.global_attribute5 
                                           , '3',HCSU.LOCATION||' - '||hcas.global_attribute3)
                             FROM apps.hz_parties                hp
                                , apps.hz_cust_accounts          hca
                                , apps.oe_order_lines_all        oola
                                , apps.oe_order_headers_all      ooha
                                , apps.ra_customer_trx_lines_all rctl
                                , apps.ra_customer_trx_all       rcta
                                , apps.hz_cust_acct_sites_all    hcas
                                , apps.hz_cust_site_uses_all     hcsu
                            WHERE ooha.header_id                 = oola.header_id
                              AND oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND rctl.inventory_item_id         = oola.inventory_item_id
                              AND rctl.line_type                 = 'LINE'
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE1 = to_char(ooha.order_number)
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE6 = to_char(oola.line_id)
                              AND RCTL.INTERFACE_LINE_CONTEXT    = 'ORDER ENTRY'
                              AND rctl.customer_trx_id           = rcta.customer_trx_id
                              AND rcta.ship_to_site_use_id       = hcsu.site_use_id
                              AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                              AND hcas.cust_account_id           = hca.cust_account_id
                              AND hca.party_id                   = hp.party_id
                              AND ROWNUM = 1)
                     --
                     ELSE
                     --            
                     CASE WHEN 
                          ( SELECT DISTINCT RCTL.INTERFACE_LINE_CONTEXT
                             FROM apps.hz_parties                hp
                                , apps.hz_cust_accounts          hca
                                , apps.oe_order_lines_all        oola
                                , apps.oe_order_headers_all      ooha
                                , apps.ra_customer_trx_lines_all rctl
                                , apps.ra_customer_trx_all       rcta
                                , apps.hz_cust_acct_sites_all    hcas
                                , apps.hz_cust_site_uses_all     hcsu
                            WHERE ooha.header_id                 = oola.header_id
                              AND oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND rctl.inventory_item_id         = oola.inventory_item_id
                              AND rctl.line_type                 = 'LINE'
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE1 = ooha.ORIG_SYS_DOCUMENT_REF
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE7 = oola.ORIG_SYS_LINE_REF
                              AND RCTL.INTERFACE_LINE_CONTEXT    = 'GEMS_PB_RR'
                              AND rctl.customer_trx_id           = rcta.customer_trx_id
                              AND rcta.ship_to_site_use_id       = hcsu.site_use_id
                              AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                              AND hcas.cust_account_id           = hca.cust_account_id
                              AND ROWNUM = 1 ) = 'GEMS_PB_RR' THEN
                     --
                     (SELECT DISTINCT DECODE(hcas.global_attribute2
                                           , '2',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'/'|| hcas.global_attribute4 ||'-'|| hcas.global_attribute5
                                           , '1',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'-'|| hcas.global_attribute5 
                                           , '3',HCSU.LOCATION||' - '||hcas.global_attribute3)
                             FROM apps.hz_parties                hp
                                , apps.hz_cust_accounts          hca
                                , apps.oe_order_lines_all        oola
                                , apps.oe_order_headers_all      ooha
                                , apps.ra_customer_trx_lines_all rctl
                                , apps.ra_customer_trx_all       rcta
                                , apps.hz_cust_acct_sites_all    hcas
                                , apps.hz_cust_site_uses_all     hcsu
                            WHERE ooha.header_id                 = oola.header_id
                              AND oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND rctl.inventory_item_id         = oola.inventory_item_id
                              AND rctl.line_type                 = 'LINE'
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE1 = ooha.ORIG_SYS_DOCUMENT_REF
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE7 = oola.ORIG_SYS_LINE_REF
                              AND RCTL.INTERFACE_LINE_CONTEXT    = 'GEMS_PB_RR'
                              AND rctl.customer_trx_id           = rcta.customer_trx_id
                              AND rcta.ship_to_site_use_id       = hcsu.site_use_id
                              AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                              AND hcas.cust_account_id           = hca.cust_account_id 
                              AND ROWNUM = 1 )
                     --
                     ELSE
                     --
                     (SELECT listagg(DECODE(hcas.global_attribute2
                                           , '2',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'/'|| hcas.global_attribute4 ||'-'|| hcas.global_attribute5
                                           , '1',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'-'|| hcas.global_attribute5 
                                           , '3',HCSU.LOCATION||' - '||hcas.global_attribute3 ),', ' ON OVERFLOW TRUNCATE)
                      WITHIN GROUP (ORDER BY hcas.global_attribute2 asc) 
                         FROM apps.hz_parties             hp
                            , apps.hz_cust_accounts       hca
                            , apps.oe_order_lines_all     oola
                            , apps.hz_cust_acct_sites_all hcas
                            , apps.hz_cust_site_uses_all  hcsu
                        WHERE oola.line_id                = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                          AND oola.ship_to_org_id         = hcsu.site_use_id
                          AND hcsu.cust_acct_site_id      = hcas.cust_acct_site_id
                          AND hcas.cust_account_id        = hca.cust_account_id
                          AND hca.party_id                = hp.party_id  )
                     --
                     END
                  END
               END      ship_to_CNPJ_CPF
               --
              , CASE WHEN ( SELECT ottl.name
                              FROM apps.oe_transaction_types_tl    ottl
                                 , apps.oe_order_headers_all  ooha
                                 , apps.oe_order_lines_all    oola  
                             WHERE oola.line_id        = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                               AND oola.header_id      = ooha.header_id
                               AND ooha.order_type_id  = ottl.transaction_type_id  ) = 'GPO_BR_FE_SHIPMENT' THEN
                      (SELECT listagg(hzl.address1 ||' - '|| hzl.address2 || ' - ' || hzl.city || '-' || hzl.state || ' / ' || hzl.postal_code,', ' ON OVERFLOW TRUNCATE)  
                       WITHIN GROUP (ORDER BY hzl.address1 asc)
                       FROM apps.hz_parties             hp
                        , apps.hz_party_sites         hps
                        , apps.hz_cust_accounts       hca
                        , apps.oe_order_lines_all     oola
                        , apps.hz_cust_acct_sites_all hcas
                        , apps.hz_cust_site_uses_all  hcsu
                        , apps.hz_locations           hzl
                    WHERE oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                      AND oola.end_customer_site_use_id  = hcsu.site_use_id
                      AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                      AND hcas.cust_account_id           = hca.cust_account_id
                      AND hcas.party_site_id             = hps.party_site_id
                      AND hca.party_id                   = hp.party_id
                      AND hps.party_id                   = hp.party_id
                      AND hps.location_id                = hzl.location_id)
                ELSE
                   CASE WHEN (mmt.source_code = '3PL_REMITTANCE_BRAZIL') THEN
                      (SELECT listagg(hzl.address1 ||' - '|| hzl.address2 || ' - ' || hzl.city || '-' || hzl.state || ' / ' || hzl.postal_code,', ' ON OVERFLOW TRUNCATE)  
                       WITHIN GROUP (ORDER BY hzl.address1 asc)
                         FROM apps.ra_customer_trx_all     rcta
                            , apps.hz_cust_acct_sites_all  hcas
                            , apps.hz_cust_site_uses_all   hcsu
                            , apps.hz_parties              hp
                            , apps.hz_party_sites          hps
                            , apps.hz_cust_accounts        hca
                            , apps.hz_locations            hzl
                        WHERE rcta.interface_header_attribute1 = mp.organization_code||'_'||mmt.transaction_reference
                          AND rcta.ship_to_site_use_id         = hcsu.site_use_id
                          AND hcsu.cust_acct_site_id           = hcas.cust_acct_site_id
                          AND hcas.cust_account_id             = hca.cust_account_id
                          AND hcas.party_site_id               = hps.party_site_id
                          AND hca.party_id                     = hp.party_id
                          AND hps.party_id                     = hp.party_id
                          AND hps.location_id                  = hzl.location_id
                          AND rcta.org_id                      = 4330)
                   ELSE
                      (SELECT listagg(hzl.address1 ||' - '|| hzl.address2 || ' - ' || hzl.city || '-' || hzl.state || ' / ' || hzl.postal_code,', ' ON OVERFLOW TRUNCATE)  
                       WITHIN GROUP (ORDER BY hzl.address1 asc)
                          FROM apps.hz_parties             hp
                             , apps.hz_party_sites         hps
                             , apps.hz_cust_accounts       hca
                             , apps.oe_order_lines_all     oola
                             , apps.hz_cust_acct_sites_all hcas
                             , apps.hz_cust_site_uses_all  hcsu
                             , apps.hz_locations           hzl
                         WHERE oola.line_id                = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                           AND oola.ship_to_org_id         = hcsu.site_use_id
                           AND hcsu.cust_acct_site_id      = hcas.cust_acct_site_id
                           AND hcas.cust_account_id        = hca.cust_account_id
                           AND hcas.party_site_id          = hps.party_site_id
                           AND hca.party_id                = hp.party_id
                           AND hps.party_id                = hp.party_id
                           AND hps.location_id             = hzl.location_id   )
                   END
                END customer_address
                -- 
                -- alterado para BIll_to por Sinval fim
                -- 
              , CASE WHEN (mmt.source_code = '3PL_REMITTANCE_BRAZIL') THEN
                   (SELECT listagg(rcta.trx_number,', ' ON OVERFLOW TRUNCATE)  
                           WITHIN GROUP (ORDER BY rcta.trx_number asc)
                      FROM apps.ra_customer_trx_all       rcta
                     WHERE rcta.interface_header_attribute1  = mp.organization_code||'_'||mmt.transaction_reference
                       AND rcta.org_id                       = 4330
                       AND NVL(rcta.status_trx,'XX')         <> 'VD'
                       AND NVL(rcta.reason_code,'XX')        <> 'CANCELLATION')
                ELSE
                   (SELECT distinct RTRIM(REGEXP_REPLACE((listagg(rcta.trx_number,', ' ON OVERFLOW TRUNCATE)  
                      WITHIN GROUP (ORDER BY rcta.trx_number asc) ), '([^,]*)(,\1)+($|,)', '\1\3'),',')
                      FROM apps.ra_customer_trx_lines_all rctla
                         , apps.ra_customer_trx_all       rcta
                         , apps.oe_order_lines_all        oola
                         , apps.oe_order_headers_all      ooha
                     WHERE rcta.customer_trx_id              = rctla.customer_trx_id
                       AND oola.line_id                      = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                       AND oola.header_id                    = ooha.header_id
                       AND rctla.sales_order                 = to_char(ooha.order_number)
                       AND rctla.line_type                   = 'LINE'
                       AND rcta.batch_source_id              <> 6266 -- No RR invoices
                       AND DECODE(rctla.interface_line_context,'GEMS_PB_RR',rcta.interface_header_attribute11,'999')
                           = DECODE(rctla.interface_line_context,'GEMS_PB_RR',rcta.interface_header_attribute11,'999')
                       AND rcta.org_id                       = 4330
                       AND trunc(rcta.trx_date)              BETWEEN (trunc(mmt.transaction_date)-3) AND (trunc(mmt.transaction_date)+3)
                       AND NVL(rcta.status_trx,'XX')         <> 'VD'
                       AND NVL(rcta.reason_code,'XX')        <> 'CANCELLATION')
                END   invoice_number_ar
              , ( SELECT listagg(mrav.reservation_quantity,', ' ON OVERFLOW TRUNCATE)  
                  WITHIN GROUP (ORDER BY mrav.reservation_quantity asc) 
                    FROM apps.mtl_reservations_all_v  mrav 
                       , apps.oe_order_headers_all    ooha1
                   WHERE mrav.demand_source_header_id     = ooha1.header_id
                     AND mrav.demand_source_line_id       = NVL(mmt.trx_source_line_id, mmt.source_line_id) )  reservation_quantity
              , ( SELECT listagg(ooha1.order_number,', ' ON OVERFLOW TRUNCATE)  
                  WITHIN GROUP (ORDER BY ooha1.order_number asc) 
                    FROM apps.mtl_reservations_all_v  mrav 
                       , apps.oe_order_headers_all    ooha1
                   WHERE mrav.demand_source_header_id     = ooha1.header_id
                     AND mrav.demand_source_line_id       = NVL(mmt.trx_source_line_id, mmt.source_line_id) )  reservation_order_number
              , (SELECT distinct hp.party_name
                 --WITHIN GROUP (ORDER BY hp.party_name asc)
                   FROM apps.hz_parties              hp
                      , apps.hz_cust_accounts        hca
                      , apps.oe_order_lines_all      oola1
                      , apps.oe_order_headers_all    ooha1
                      , apps.mtl_reservations_all_v  mrav 
                  WHERE mrav.demand_source_header_id   = ooha1.header_id
                    AND mrav.demand_source_line_id     = oola1.line_id
                    AND oola1.line_id                  = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                    AND oola1.ship_to_org_id           = hca.cust_account_id
                    AND hca.party_id                   = hp.party_id )         reservation_customer_name
              , gcc1.concatenated_segments   material_account
              , gcc2.concatenated_segments   outside_processing_account
              , gcc3.concatenated_segments   material_overhead_account
              , gcc4.concatenated_segments   overhead_account
              , gcc5.concatenated_segments   resource_account
              , sysdate                                           report_date_and_time 
              , to_char(mmt.transaction_id)  transaction_id
              , DECODE( fu.user_name,NULL,NULL,fu.user_name ||' / '|| fu.description )            user_name
              , DECODE( lot_control_code, 1 ,'Sem controle de Lote' , 2,'Com controle de Lote')   lot_control
              , DECODE( serial_number_control_code, 1, 'Sem controle de Serial'
                                                  , 2, 'Pre-definido'
                                                  , 5, 'No Recebimento'
                                                  , 6, 'Baixa na Ordem de Venda' )  serial_control
              , CASE
                 WHEN   nvl(mmt.lpn_id, mmt.content_lpn_id) IS NULL AND moq.subinventory_code <> 'WHGU42GNAT'
                   THEN 
                     (SELECT listagg(lpn.license_plate_number,', ' ON OVERFLOW TRUNCATE)WITHIN GROUP (ORDER BY lpn.license_plate_number asc)
                             FROM apps.MTL_MATERIAL_TRANSACTIONS   mtt,
                                  apps.wms_license_plate_numbers   lpn,
                                  apps.oe_order_lines_all          ool
                            WHERE 1 = 1
                              AND mtt.TRX_SOURCE_LINE_ID = CASE
                                                              WHEN LINE_CATEGORY_CODE = 'ORDER'
                                                                THEN ool.line_id
                                                              WHEN LINE_CATEGORY_CODE = 'RETURN'  
                                                                THEN   
                                                                to_number(NVL(SUBSTR(ool.ORIG_SYS_LINE_REF,
                                                                                     0,
                                                                                     INSTR(ool.ORIG_SYS_LINE_REF, '.') - 1),
                                                                              -1)) -- RMA FE OE Line Id
                                                                ELSE -1
                                                                  END
                              AND mtt.TRANSACTION_TYPE_ID = 52 --sales order pick FE ORDER
                              AND mtt.transaction_quantity < 0
                              AND mtt.inventory_item_id = ool.inventory_item_id
                              AND nvl(mtt.lpn_id, mtt.content_lpn_id) = nvl(lpn.lpn_id, -1)
                              AND ool.line_id = CASE
                                                  WHEN mtt.transaction_type_name = 'RMA Receipt'
                                                    THEN mmt.TRX_SOURCE_LINE_ID
                                                  WHEN mtt.transaction_type_name = 'GPO Nationalization Receipt'
                                                     THEN 
                                                      to_number(NVL(SUBSTR(RTRIM(LTRIM(translate(mmt.TRANSACTION_REFERENCE||'a',translate(mmt.TRANSACTION_REFERENCE||'a','1234567890.',' '),' '))),
                                                         0,
                                                         INSTR(RTRIM(LTRIM(translate(mmt.TRANSACTION_REFERENCE||'a',translate(mmt.TRANSACTION_REFERENCE||'a','1234567890.',' '),' '))), '.') - 1),
                                                  -1))
                                                  ELSE -1
                                                    END)
                WHEN moq.subinventory_code = 'WHGU42GNAT'
                  THEN (SELECT  listagg(wlp.license_plate_number,', ' ON OVERFLOW TRUNCATE)  
                            WITHIN GROUP (ORDER BY wlp.license_plate_number asc)
                        FROM   gems_ont.ge_gpo_nationalization_line gnl, 
                               gems_ont.ge_gpo_nationalization_line gn2,
                               apps.wms_license_plate_numbers       wlp,
                               apps.po_line_locations_all           pll,
                               apps.po_lines_all                    pol,
                               apps.po_headers_all                  poh,
                               apps.rcv_shipment_headers            rsh,
                               apps.rcv_transactions                rt
                        Where  wlp.lpn_id(+) = gn2.lpn_id
                        AND gnl.nationalization_so_line_id = gn2.nationalization_so_line_id
                        AND pll.line_location_id = gnl.DOCUMENT_ID
                        AND pll.po_header_id = poh.po_header_id
                        AND pll.po_line_id = pol.po_line_id
                        AND gn2.record_type = 'IMPORT'
                        AND gnl.record_type = 'NATIONALIZATION'
                        AND rt.transaction_id                = mmt.rcv_transaction_id
                        AND rt.po_line_location_id           = pll.line_location_id
                        AND rt.shipment_header_id            = rsh.shipment_header_id)
                ELSE 
                  (SELECT lpn.LICENSE_PLATE_NUMBER
                   FROM   apps.wms_license_plate_numbers   lpn
                   WHERE  nvl(mmt.lpn_id, mmt.content_lpn_id) = nvl(lpn.lpn_id, -1))
                        END LPN_Value                                    
             , 'q13' query
--, mmt.transaction_type_id
--, mmt.trx_source_line_id
--, mmt.source_line_id
           FROM apps.mtl_parameters                  mp
              , apps.mtl_system_items_b              msi
              , apps.mtl_secondary_inventories_fk_v  msifv
              , apps.gl_code_combinations            gcc
              , apps.gl_code_combinations_kfv        gcc1
              , apps.gl_code_combinations_kfv        gcc2
              , apps.gl_code_combinations_kfv        gcc3
              , apps.gl_code_combinations_kfv        gcc4
              , apps.gl_code_combinations_kfv        gcc5
              , apps.mtl_item_locations_kfv          milk
              , apps.mtl_material_transactions       mmt
              , apps.mtl_transaction_types           mtt
              , apps.mtl_txn_source_types            mtst
              , apps.fnd_flex_values_vl              ffvv
              , apps.fnd_flex_value_sets             ffvs
              , apps.fnd_user                        fu
              , ( SELECT organization_id
                       , inventory_item_id
                       , subinventory_code
                       , locator_id
                       , lot_number
                       --, transaction_uom_code
                       , create_transaction_id
                       , SUM (primary_transaction_quantity) onhand_qty
                    FROM apps.mtl_onhand_quantities_detail
                   WHERE organization_id IN (SELECT ood.organization_id FROM apps.org_organization_definitions ood WHERE ood.set_of_books_id = 230 )
                   GROUP BY organization_id
                          , inventory_item_id
                          , subinventory_code
                          , locator_id
                       --   , revision
                          , lot_number
                          --, transaction_uom_code
                          , create_transaction_id ) moq
                          ,APPS.MTL_PAC_ACTUAL_COST_DETAILS MPACD 
          WHERE 1                                = 1
          AND decode(mmt.periodic_primary_quantity,null,mmt.transfer_transaction_id,MMT.TRANSACTION_ID) = MPACD.TRANSACTION_ID  
            AND mp.organization_id               = msi.organization_id
--            AND msi.segment1 = '60510302'
            AND msifv.organization_id            = msi.organization_id
            AND msifv.secondary_inventory_name   = moq.subinventory_code
            AND msifv.material_account           = gcc1.code_combination_id
            AND msifv.outside_processing_account = gcc2.code_combination_id
            AND msifv.material_overhead_account  = gcc3.code_combination_id
            AND msifv.overhead_account           = gcc4.code_combination_id
            AND msifv.resource_account           = gcc5.code_combination_id
            AND msi.cost_of_sales_account       = gcc.code_combination_id
            AND ffvs.flex_value_set_name        = 'GE_GL_AFF_ES_PRODUCT_LINE'
            AND ffvs.flex_value_set_id          = ffvv.flex_value_set_id
            AND ffvv.flex_value_meaning         = gcc.segment8
            AND 'TYPE 1'                        IN ('TYPE 1')
            AND msi.organization_id             IN (SELECT ood.organization_id FROM apps.org_organization_definitions ood WHERE ood.set_of_books_id = 230 )
            AND moq.inventory_item_id           = msi.inventory_item_id
            AND moq.organization_id             = msi.organization_id
            AND moq.locator_id                  = milk.inventory_location_id
            AND moq.create_transaction_id       = mmt.transaction_id
--    AND MMT.TRANSACTION_ID = 2562828197
            AND mtt.transaction_type_id         (+) = mmt.transaction_type_id 
            AND mtst.transaction_source_type_id (+) = mmt.transaction_source_type_id
            AND msi.serial_number_control_code      = '1' 
            AND msi.lot_control_code                = '1'
            AND fu.user_id                      (+) = mmt.created_by 
    AND MMT.TRANSACTION_ID NOT IN(SELECT MMT2.TRANSACTION_ID 
                                  FROM AMARCHIVE.MTL_MATERIAL_TRANSACTIONS  MMT2
                                  WHERE MMT2.TRANSACTION_ID = MMT.TRANSACTION_ID)
------------------------------------------------------------------------------
UNION  
------------------------------------------------------------------------------ 
-- Sem Controle de Serial e sem Controle de Lote e COM Locator ---- AMARCHIVE.MTL_MATERIAL_TRANSACTIONS
         SELECT DISTINCT  --'14' NUM
        /* ( SELECT ccg.cost_group 
                             FROM apps.cst_cost_groups            ccg
                                , apps.cst_cost_group_assignments ccga
                            WHERE ccga.cost_group_id     = ccg.cost_group_id
                              AND ccga.organization_id   = mp.organization_id )  cost_group*/
            ( SELECT ccg.cost_group 
                             FROM apps.cst_cost_groups            ccg
                            WHERE MPACD.cost_group_id     = ccg.cost_group_id )  cost_group  
              , ( SELECT ( SELECT cpp1.period_name 
                             FROM apps.cst_pac_item_costs   cst
                                , apps.cst_pac_periods      cpp1
                            WHERE cst.pac_period_id     = (SELECT MAX(PAC_PERIOD_ID)                   FROM APPS.CST_PAC_PERIODS                  WHERE LEGAL_ENTITY = (SELECT LEGAL_ENTITY                                          FROM APPS.ORG_ORGANIZATION_DEFINITIONS OOD                                         WHERE OOD.ORGANIZATION_ID = mp.organization_id                                         ) )
                              AND cst.pac_period_id     = cpp1.pac_period_id
                              AND cst.inventory_item_id = msi.inventory_item_id
                              AND cst.cost_group_id     = ccg.cost_group_id )  
                    FROM apps.cst_cost_groups            ccg
                       , apps.cst_cost_group_assignments ccga
                   WHERE ccga.cost_group_id     = ccg.cost_group_id
                     AND ccga.organization_id   = mp.organization_id ) period_name
              , mp.organization_code
              , mp.attribute7                organization_type
              , mp.organization_id 
              , moq.subinventory_code
              , msifv.description            subinv_description
              , milk.concatenated_segments   locators
              , DECODE( msifv.asset_inventory, 1 , 'Asset', 2, 'Non Asset')   asset_type
              , msi.segment1                 part_number
              , DECODE(msi.inventory_asset_flag, NULL, 'No', 'N', 'No', 'Y', 'Yes')                         flag_asset_inventory
              , DECODE(msi.costing_enabled_flag, NULL, 'No', 'N', 'No', 'Y', 'Yes')                         flag_de_custo
              , msi.description              descrip_eng
              , msi.attribute3               descrip_ptb
              , msi.creation_date            item_creation_date
              , (trunc(SYSDATE) - trunc(msi.creation_date))      days_from_creation
              , gcc.segment8                                     product_line
              , ffvv.description                                 desc_prod_line   
              , msi.primary_uom_code    uom
              , moq.onhand_qty                                   transaction_quantity
              , NVL(( SELECT cic.item_cost
                        FROM apps.cst_item_costs cic
                       WHERE cic.organization_id   = msi.organization_id
                         AND cic.inventory_item_id = msi.inventory_item_id
                         AND cic.cost_type_id      = 1 ),0)  custo_unit_inv
              /*, nvl(( SELECT ( SELECT ROUND (cst.item_cost,2) 
                                 FROM apps.cst_pac_item_costs   cst
                                WHERE cst.pac_period_id     = (SELECT MAX(PAC_PERIOD_ID)                   FROM APPS.CST_PAC_PERIODS                  WHERE LEGAL_ENTITY = (SELECT LEGAL_ENTITY                                          FROM APPS.ORG_ORGANIZATION_DEFINITIONS OOD                                         WHERE OOD.ORGANIZATION_ID = mp.organization_id                                         ) )
                                  AND cst.inventory_item_id = msi.inventory_item_id
                                  AND cst.cost_group_id     = ccg.cost_group_id )  item_cost
                        FROM apps.cst_cost_groups            ccg
                           , apps.cst_cost_group_assignments ccga
                       WHERE ccga.cost_group_id     = ccg.cost_group_id
                         AND ccga.organization_id   = mp.organization_id ) ,0) custo_unit_pac*/
                , nvl((SELECT ROUND (cst.item_cost,2) 
                       FROM apps.cst_pac_item_costs   cst
                      WHERE cst.pac_period_id     = (SELECT MAX(PAC_PERIOD_ID)                   
                                                                FROM APPS.CST_PAC_PERIODS                  
                                                                WHERE LEGAL_ENTITY = (SELECT LEGAL_ENTITY                                         
                                                                                        FROM APPS.ORG_ORGANIZATION_DEFINITIONS OOD                                        
                                                                                        WHERE OOD.ORGANIZATION_ID = mp.organization_id
                                                        ) )
                        AND cst.inventory_item_id = msi.inventory_item_id
                        AND cst.cost_group_id     = MPACD.cost_group_id) ,0)  custo_unit_pac
              , moq.lot_number
              , NULL   lot_creation_date
              , NULL   lot_qty_days_creation
              , NULL   lot_expiration_date
              , NULL   serial_number
              , NULL   serial_creation_date
              , mtt.transaction_type_name           last_transaction_type
              , mmt.transaction_source_name         last_transaction_source
              , mtst.transaction_source_type_name   last_source_type
              , mmt.source_code
              , TO_CHAR(mmt.transaction_date, 'DD-MON-RRRR')      transaction_date
        , (SELECT TO_CHAR(mmt1.transaction_date, 'DD-MON-RRRR') 
          FROM apps.mtl_material_transactions mmt1
          WHERE mmt1.transaction_type_id=420
          AND mmt1.source_line_id=mmt.source_line_id) initial_consignment_date  
              , (TRUNC ( SYSDATE )- TRUNC(mmt.transaction_date))  transaction_qty_of_days
              , TO_CHAR(mmt.transaction_reference)                transaction_reference
              , CASE WHEN mmt.source_code = '3PL_REMITTANCE_BRAZIL' THEN
                     (SELECT listagg(pha.segment1,', ' ON OVERFLOW TRUNCATE)  
                      WITHIN GROUP (ORDER BY pha.segment1 asc)
                        FROM apps.po_headers_all        pha,
                             apps.po_lines_all          pla
                       WHERE pla.po_line_id   = mmt.source_line_id
                         AND pla.po_header_id = pha.po_header_id)
                     WHEN mmt.source_code IN ('ORDER ENTRY','IIP') THEN
                        NULL
                     WHEN mmt.source_code = 'RCV' THEN
                        ( SELECT listagg(pha.segment1,', ' ON OVERFLOW TRUNCATE)  
                          WITHIN GROUP (ORDER BY pha.segment1 asc)
                            FROM apps.po_headers_all            pha
                               , apps.po_lines_all              pla
                               , apps.po_line_locations_all     plla
                               , apps.rcv_shipment_headers      rsh
                               , apps.rcv_transactions          rt
                           WHERE rt.transaction_id                = mmt.rcv_transaction_id
                             AND rt.po_line_location_id           = plla.line_location_id
                             AND plla.po_line_id                  = pla.po_line_id
                             AND pha.po_header_id                 = pla.po_header_id
                             AND rt.shipment_header_id            = rsh.shipment_header_id
                             AND rsh.receipt_source_code          = 'VENDOR'  )
                     ELSE
                        NULL
                END      po_number
              , CASE WHEN mmt.source_code = '3PL_REMITTANCE_BRAZIL' THEN
                     (SELECT listagg(aps.vendor_name,', ' ON OVERFLOW TRUNCATE)  
                      WITHIN GROUP (ORDER BY aps.vendor_name asc)
                        FROM apps.po_headers_all        pha
                           , apps.po_lines_all          pla
                           , apps.ap_suppliers          aps
                           , apps.ap_supplier_sites_all  apss
                       WHERE pla.po_line_id     = mmt.source_line_id
                         AND pla.po_header_id   = pha.po_header_id
                         AND pha.vendor_id      = aps.vendor_id
                         AND aps.vendor_id      = apss.vendor_id
                         AND pha.vendor_site_id = apss.vendor_site_id )
                     WHEN mmt.source_code IN ('ORDER ENTRY','IIP') THEN
                        NULL
                     WHEN mmt.source_code = 'RCV' THEN
                        ( SELECT listagg(aps.vendor_name,', ' ON OVERFLOW TRUNCATE)  
                          WITHIN GROUP (ORDER BY aps.vendor_name asc)
                            FROM apps.po_headers_all            pha
                               , apps.po_lines_all              pla
                               , apps.po_line_locations_all     plla
                               , apps.rcv_shipment_headers      rsh
                               , apps.rcv_transactions          rt
                               , apps.ap_suppliers              aps
                               , apps.ap_supplier_sites_all     apss
                           WHERE rt.transaction_id          = mmt.rcv_transaction_id
                             AND rt.po_line_location_id     = plla.line_location_id
                             AND plla.po_line_id            = pla.po_line_id
                             AND pha.po_header_id           = pla.po_header_id
                             AND rt.shipment_header_id      = rsh.shipment_header_id
                             AND rsh.receipt_source_code    = 'VENDOR'
                             AND pha.vendor_id              = aps.vendor_id
                             AND aps.vendor_id              = apss.vendor_id
                             AND pha.vendor_site_id         = apss.vendor_site_id  )
                     ELSE
                        NULL
                END     po_supplier
              , CASE WHEN mmt.source_code = '3PL_REMITTANCE_BRAZIL' THEN
                     ( SELECT listagg(cfi.invoice_num,', ' ON OVERFLOW TRUNCATE)  
                         WITHIN GROUP (ORDER BY cfi.invoice_num asc)
                         FROM apps.cll_f189_invoice_lines cfil
                            , apps.cll_f189_invoices      cfi
                            , apps.po_lines_all           pla
                            , apps.po_line_locations_all  plla
                        WHERE plla.po_line_id       = pla.po_line_id
                          AND pla.po_line_id        = mmt.source_line_id
                          AND plla.line_location_id = cfil.line_location_id
                          AND cfil.invoice_id       = cfi.invoice_id )
                     WHEN mmt.source_code IN ('ORDER ENTRY','IIP') THEN
                        NULL
                     WHEN mmt.source_code = 'RCV' THEN
                        ( SELECT listagg(cfi.invoice_num,', ' ON OVERFLOW TRUNCATE)  
                            WITHIN GROUP (ORDER BY cfi.invoice_num asc)
                            FROM apps.po_headers_all            pha
                               , apps.po_lines_all              pla
                               , apps.po_line_locations_all     plla
                               , apps.cll_f189_invoice_lines    cfil
                               , apps.cll_f189_invoices         cfi
                               , apps.rcv_shipment_headers      rsh
                               , apps.rcv_transactions          rt
                           WHERE rt.transaction_id          = mmt.rcv_transaction_id
                             AND rt.po_line_location_id     = plla.line_location_id
                             AND plla.line_location_id      = cfil.line_location_id
                             AND cfil.invoice_id            = cfi.invoice_id
                            AND plla.po_line_id            = pla.po_line_id
                             AND pha.po_header_id           = pla.po_header_id
                             AND rt.shipment_header_id      = rsh.shipment_header_id
                             AND rsh.receipt_source_code    = 'VENDOR'   )
                     ELSE
                        NULL
                END    NF_RI
             , (SELECT DECODE( mmt.source_code, '3PL_REMITTANCE_BRAZIL',NULL,to_char(ooha.order_number) )
                  FROM apps.oe_order_headers_all  ooha,
                       apps.oe_order_lines_all    oola  
                 WHERE oola.line_id        = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                   AND oola.header_id      = ooha.header_id )   order_number
               -- 
               -- alterado para BIll_to por Sinval inicio
               --
               , CASE WHEN ( SELECT ottl.name
                             FROM apps.oe_transaction_types_tl    ottl
                                , apps.oe_order_headers_all  ooha
                                , apps.oe_order_lines_all    oola  
                            WHERE oola.line_id        = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND oola.header_id      = ooha.header_id
                              AND ooha.order_type_id  = ottl.transaction_type_id  ) = 'GPO_BR_FE_SHIPMENT' THEN
                     (SELECT listagg(hp.party_name,', ' ON OVERFLOW TRUNCATE)  
                      WITHIN GROUP (ORDER BY hp.party_name asc)
                        FROM apps.hz_parties             hp
                           , apps.hz_cust_accounts       hca
                           , apps.oe_order_lines_all     oola
                           , apps.hz_cust_acct_sites_all hcas
                           , apps.hz_cust_site_uses_all  hcsu
                       WHERE oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                         AND oola.end_customer_site_use_id  = hcsu.site_use_id
                         AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                         AND hcas.cust_account_id           = hca.cust_account_id
                         AND hca.party_id                   = hp.party_id )
                  ELSE
                     CASE WHEN (mmt.source_code = '3PL_REMITTANCE_BRAZIL') THEN
                       (SELECT listagg(hp.party_name,', ' ON OVERFLOW TRUNCATE)  
                        WITHIN GROUP (ORDER BY hp.party_name asc)
                          FROM apps.hz_parties             hp,
                               apps.hz_cust_accounts       hca,
                               apps.ra_customer_trx_all    rcta,
                               apps.hz_cust_acct_sites_all hcas,
                               apps.hz_cust_site_uses_all  hcsu
                         WHERE rcta.interface_header_attribute1 = mp.organization_code||'_'||mmt.transaction_reference
                           AND rcta.ship_to_site_use_id         = hcsu.site_use_id
                           AND hcsu.cust_acct_site_id           = hcas.cust_acct_site_id
                           AND hcas.cust_account_id             = hca.cust_account_id
                           AND hca.party_id                     = hp.party_id
                           AND rcta.org_id                      = 4330)
                     ELSE
                        (SELECT listagg(hp.party_name,', ' ON OVERFLOW TRUNCATE)  
                         WITHIN GROUP (ORDER BY hp.party_name asc)
                           FROM apps.hz_parties             hp
                              , apps.hz_cust_accounts       hca
                              , apps.oe_order_lines_all     oola
                              , apps.hz_cust_acct_sites_all hcas
                              , apps.hz_cust_site_uses_all  hcsu
                          WHERE oola.line_id                = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                            AND oola.ship_to_org_id         = hcsu.site_use_id
                            AND hcsu.cust_acct_site_id      = hcas.cust_acct_site_id
                            AND hcas.cust_account_id        = hca.cust_account_id
                            AND hca.party_id                = hp.party_id )
                    END                 
               END    customer_name
             , CASE WHEN ( SELECT ottl.name
                             FROM apps.oe_transaction_types_tl    ottl
                                , apps.oe_order_headers_all  ooha
                                , apps.oe_order_lines_all    oola  
                            WHERE oola.line_id        = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND oola.header_id      = ooha.header_id
                              AND ooha.order_type_id  = ottl.transaction_type_id  ) = 'GPO_BR_FE_SHIPMENT' THEN
                     (SELECT listagg(hca.account_number,', ' ON OVERFLOW TRUNCATE)  
                      WITHIN GROUP (ORDER BY hca.account_number asc)
                        FROM apps.hz_parties             hp
                           , apps.hz_cust_accounts       hca
                           , apps.oe_order_lines_all     oola
                           , apps.hz_cust_acct_sites_all hcas
                           , apps.hz_cust_site_uses_all  hcsu
                       WHERE oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                         AND oola.end_customer_site_use_id  = hcsu.site_use_id
                         AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                         AND hcas.cust_account_id           = hca.cust_account_id
                         AND hca.party_id                   = hp.party_id )
                  ELSE
                     CASE WHEN (mmt.source_code = '3PL_REMITTANCE_BRAZIL') THEN
                        (SELECT listagg(hca.account_number,', ' ON OVERFLOW TRUNCATE)  
                         WITHIN GROUP (ORDER BY hca.account_number asc)
                           FROM apps.hz_parties             hp,
                                apps.hz_cust_accounts       hca,
                                apps.ra_customer_trx_all    rcta,
                                apps.hz_cust_acct_sites_all hcas,
                                apps.hz_cust_site_uses_all  hcsu
                          WHERE rcta.interface_header_attribute1 = mp.organization_code||'_'||mmt.transaction_reference
                            AND rcta.ship_to_site_use_id         = hcsu.site_use_id
                            AND hcsu.cust_acct_site_id           = hcas.cust_acct_site_id
                            AND hcas.cust_account_id             = hca.cust_account_id
                            AND hca.party_id                     = hp.party_id
                            AND rcta.org_id                      = 4330)
                     ELSE
                        (SELECT listagg(hca.account_number,', ' ON OVERFLOW TRUNCATE)  
                         WITHIN GROUP (ORDER BY hca.account_number asc)
                           FROM apps.hz_parties             hp
                              , apps.hz_cust_accounts       hca
                              , apps.oe_order_lines_all     oola
                              , apps.hz_cust_acct_sites_all hcas
                              , apps.hz_cust_site_uses_all  hcsu
                          WHERE oola.line_id                = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                            AND oola.ship_to_org_id         = hcsu.site_use_id
                            AND hcsu.cust_acct_site_id      = hcas.cust_acct_site_id
                            AND hcas.cust_account_id        = hca.cust_account_id
                            AND hca.party_id                = hp.party_id   )
                     END
                  END   customer_number
              --
              , CASE WHEN ( SELECT ottl.name
                             FROM apps.oe_transaction_types_tl    ottl
                                , apps.oe_order_headers_all  ooha
                                , apps.oe_order_lines_all    oola  
                            WHERE oola.line_id        = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                             AND oola.header_id      = ooha.header_id
                              AND ooha.order_type_id  = ottl.transaction_type_id  ) = 'GPO_BR_FE_SHIPMENT' THEN
                     (SELECT listagg(DECODE(hcas.global_attribute2
                                           , '2',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'/'|| hcas.global_attribute4 ||'-'|| hcas.global_attribute5
                                           , '1',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'-'|| hcas.global_attribute5 
                                           , '3',HCSU.LOCATION||' - '||hcas.global_attribute3 ),', ' ON OVERFLOW TRUNCATE)
                     WITHIN GROUP (ORDER BY hcas.global_attribute2 asc ) 
                        FROM apps.hz_parties             hp
                           , apps.hz_cust_accounts       hca
                           , apps.oe_order_lines_all     oola
                           , apps.hz_cust_acct_sites_all hcas
                           , apps.hz_cust_site_uses_all  hcsu
                       WHERE oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                         AND oola.end_customer_site_use_id  = hcsu.site_use_id
                         AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                         AND hcas.cust_account_id           = hca.cust_account_id
                         AND hca.party_id                   = hp.party_id )
                ELSE
                   CASE WHEN (mmt.source_code = '3PL_REMITTANCE_BRAZIL') THEN
                      (SELECT listagg(DECODE(hcas.global_attribute2
                                           , '2',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'/'|| hcas.global_attribute4 ||'-'|| hcas.global_attribute5
                                           , '1',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'-'|| hcas.global_attribute5 
                                           , '3',HCSU.LOCATION||' - '||hcas.global_attribute3 ),', ' ON OVERFLOW TRUNCATE)
                     WITHIN GROUP (ORDER BY hcas.global_attribute2 asc) 
                         FROM apps.ra_customer_trx_all     rcta
                            , apps.hz_cust_acct_sites_all  hcas
                            , apps.hz_cust_site_uses_all   hcsu
                        WHERE rcta.interface_header_attribute1 = mp.organization_code||'_'||mmt.transaction_reference
                          AND rcta.ship_to_site_use_id         = hcsu.site_use_id
                          AND hcsu.cust_acct_site_id           = hcas.cust_acct_site_id
                          AND rcta.org_id                      = 4330)
                   ELSE
                      (SELECT listagg(DECODE(hcas.global_attribute2
                                           , '2',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'/'|| hcas.global_attribute4 ||'-'|| hcas.global_attribute5
                                           , '1',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'-'|| hcas.global_attribute5 
                                           , '3',HCSU.LOCATION||' - '||hcas.global_attribute3 ),', ' ON OVERFLOW TRUNCATE)
                      WITHIN GROUP (ORDER BY hcas.global_attribute2 asc) 
                         FROM apps.hz_parties             hp
                            , apps.hz_cust_accounts       hca
                            , apps.oe_order_lines_all     oola
                            , apps.hz_cust_acct_sites_all hcas
                            , apps.hz_cust_site_uses_all  hcsu
                        WHERE oola.line_id                = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                          AND oola.ship_to_org_id         = hcsu.site_use_id
                          AND hcsu.cust_acct_site_id      = hcas.cust_acct_site_id
                          AND hcas.cust_account_id        = hca.cust_account_id
                          AND hca.party_id                = hp.party_id  )
                   END
                END  customer_cnpj_cpf
               -- 
              , CASE WHEN (mmt.source_code = '3PL_REMITTANCE_BRAZIL') THEN
                      (SELECT listagg(DECODE(hcas.global_attribute2
                                           , '2',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'/'|| hcas.global_attribute4 ||'-'|| hcas.global_attribute5
                                           , '1',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'-'|| hcas.global_attribute5 
                                           , '3',HCSU.LOCATION||' - '||hcas.global_attribute3 ),', ' ON OVERFLOW TRUNCATE)
                       WITHIN GROUP (ORDER BY hcas.global_attribute2 asc )
                         FROM apps.ra_customer_trx_all         rcta
                            , apps.hz_cust_acct_sites_all      hcas
                            , apps.hz_cust_site_uses_all       hcsu
                        WHERE rcta.interface_header_attribute1 = mp.organization_code||'_'||mmt.transaction_reference
                          AND rcta.bill_to_site_use_id         = hcsu.site_use_id
                          AND hcsu.cust_acct_site_id           = hcas.cust_acct_site_id
                          AND rcta.org_id                      = 4330
                          AND ROWNUM = 1)
                   ELSE
                     --
                     CASE WHEN (select DISTINCT RCTL.INTERFACE_LINE_CONTEXT
                             FROM apps.hz_parties                hp
                                , apps.hz_cust_accounts          hca
                                , apps.oe_order_lines_all        oola
                                , apps.oe_order_headers_all      ooha
                                , apps.ra_customer_trx_lines_all rctl
                                , apps.ra_customer_trx_all       rcta
                                , apps.hz_cust_acct_sites_all    hcas
                                , apps.hz_cust_site_uses_all     hcsu
                            WHERE ooha.header_id                 = oola.header_id
                              AND oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND rctl.inventory_item_id         = oola.inventory_item_id
                              AND rctl.line_type                 = 'LINE'
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE1 = to_char(ooha.order_number)
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE6 = to_char(oola.line_id)
                              AND RCTL.INTERFACE_LINE_CONTEXT    = 'ORDER ENTRY'
                              AND rctl.customer_trx_id           = rcta.customer_trx_id
                              AND rcta.bill_to_site_use_id       = hcsu.site_use_id
                              AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                              AND hcas.cust_account_id           = hca.cust_account_id
                              AND hca.party_id                   = hp.party_id 
                              AND ROWNUM = 1) = 'ORDER ENTRY' THEN
                     --
                     (SELECT DISTINCT DECODE(hcas.global_attribute2
                                           , '2',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'/'|| hcas.global_attribute4 ||'-'|| hcas.global_attribute5
                                           , '1',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'-'|| hcas.global_attribute5 
                                           , '3',HCSU.LOCATION||' - '||hcas.global_attribute3)
                             FROM apps.hz_parties                hp
                                , apps.hz_cust_accounts          hca
                                , apps.oe_order_lines_all        oola
                                , apps.oe_order_headers_all      ooha
                                , apps.ra_customer_trx_lines_all rctl
                                , apps.ra_customer_trx_all       rcta
                                , apps.hz_cust_acct_sites_all    hcas
                                , apps.hz_cust_site_uses_all     hcsu
                            WHERE ooha.header_id                 = oola.header_id
                              AND oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND rctl.inventory_item_id         = oola.inventory_item_id
                              AND rctl.line_type                 = 'LINE'
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE1 = to_char(ooha.order_number)
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE6 = to_char(oola.line_id)
                              AND RCTL.INTERFACE_LINE_CONTEXT    = 'ORDER ENTRY'
                              AND rctl.customer_trx_id           = rcta.customer_trx_id
                              AND rcta.bill_to_site_use_id       = hcsu.site_use_id
                              AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                              AND hcas.cust_account_id           = hca.cust_account_id
                              AND hca.party_id                   = hp.party_id
                              AND ROWNUM = 1)
                     --
                     ELSE
                     --            
                     CASE WHEN 
                          ( SELECT DISTINCT RCTL.INTERFACE_LINE_CONTEXT
                             FROM apps.hz_parties                hp
                                , apps.hz_cust_accounts          hca
                                , apps.oe_order_lines_all        oola
                                , apps.oe_order_headers_all      ooha
                                , apps.ra_customer_trx_lines_all rctl
                                , apps.ra_customer_trx_all       rcta
                                , apps.hz_cust_acct_sites_all    hcas
                                , apps.hz_cust_site_uses_all     hcsu
                            WHERE ooha.header_id                 = oola.header_id
                              AND oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND rctl.inventory_item_id         = oola.inventory_item_id
                              AND rctl.line_type                 = 'LINE'
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE1 = ooha.ORIG_SYS_DOCUMENT_REF
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE7 = oola.ORIG_SYS_LINE_REF
                              AND RCTL.INTERFACE_LINE_CONTEXT    = 'GEMS_PB_RR'
                              AND rctl.customer_trx_id           = rcta.customer_trx_id
                              AND rcta.bill_to_site_use_id       = hcsu.site_use_id
                              AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                              AND hcas.cust_account_id           = hca.cust_account_id
                              AND ROWNUM = 1 ) = 'GEMS_PB_RR' THEN
                     --
                     (SELECT DISTINCT DECODE(hcas.global_attribute2
                                           , '2',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'/'|| hcas.global_attribute4 ||'-'|| hcas.global_attribute5
                                           , '1',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'-'|| hcas.global_attribute5 
                                           , '3',HCSU.LOCATION||' - '||hcas.global_attribute3)
                             FROM apps.hz_parties                hp
                                , apps.hz_cust_accounts          hca
                                , apps.oe_order_lines_all        oola
                                , apps.oe_order_headers_all      ooha
                                , apps.ra_customer_trx_lines_all rctl
                                , apps.ra_customer_trx_all       rcta
                                , apps.hz_cust_acct_sites_all    hcas
                                , apps.hz_cust_site_uses_all     hcsu
                            WHERE ooha.header_id                 = oola.header_id
                              AND oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND rctl.inventory_item_id         = oola.inventory_item_id
                              AND rctl.line_type                 = 'LINE'
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE1 = ooha.ORIG_SYS_DOCUMENT_REF
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE7 = oola.ORIG_SYS_LINE_REF
                              AND RCTL.INTERFACE_LINE_CONTEXT    = 'GEMS_PB_RR'
                              AND rctl.customer_trx_id           = rcta.customer_trx_id
                              AND rcta.bill_to_site_use_id       = hcsu.site_use_id
                              AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                              AND hcas.cust_account_id           = hca.cust_account_id 
                              AND ROWNUM = 1 )
                     --
                     ELSE
                     --
                     (SELECT DISTINCT DECODE(hcas.global_attribute2
                                   , '2',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'/'|| hcas.global_attribute4 ||'-'|| hcas.global_attribute5
                                   , '1',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'-'|| hcas.global_attribute5 
                                   , '3',HCSU.LOCATION||' - '||hcas.global_attribute3)
                             --
                      FROM   APPS.HZ_CUST_ACCT_SITES_ALL HCAS,
                             APPS.HZ_CUST_SITE_USES_ALL  HCSU,
                             APPS.OE_ORDER_LINES_ALL     OOLA,
                             APPS.OE_ORDER_HEADERS_ALL   OOHA
                             --
                      WHERE  HCSU.SITE_USE_CODE     = 'BILL_TO'
                      AND    HCSU.CUST_ACCT_SITE_ID = HCAS.CUST_ACCT_SITE_ID
                      AND    HCSU.SITE_USE_ID       = NVL(OOLA.ATTRIBUTE1, OOHA.INVOICE_TO_ORG_ID)
                      AND    OOLA.LINE_ID           = NVL(MMT.TRX_SOURCE_LINE_ID, MMT.SOURCE_LINE_ID)
                      AND    OOHA.HEADER_ID         = OOLA.HEADER_ID
                      AND    ROWNUM = 1)
                     --
                     END
                  END
               END      bill_to_CNPJ_CPF
               --
                             --
              , CASE WHEN (mmt.source_code = '3PL_REMITTANCE_BRAZIL') THEN
                        (SELECT listagg(hp.party_name,', ' ON OVERFLOW TRUNCATE)  
                        WITHIN GROUP (ORDER BY hp.party_name asc)
                          FROM apps.hz_parties             hp,
                               apps.hz_cust_accounts       hca,
                               apps.ra_customer_trx_all    rcta,
                               apps.hz_cust_acct_sites_all hcas,
                               apps.hz_cust_site_uses_all  hcsu
                         WHERE rcta.interface_header_attribute1 = mp.organization_code||'_'||mmt.transaction_reference
                           AND rcta.bill_to_site_use_id         = hcsu.site_use_id
                           AND hcsu.cust_acct_site_id           = hcas.cust_acct_site_id
                           AND hcas.cust_account_id             = hca.cust_account_id
                           AND hca.party_id                     = hp.party_id
                           AND rcta.org_id                      = 4330)
                   ELSE
                     --
                     CASE WHEN (select DISTINCT RCTL.INTERFACE_LINE_CONTEXT
                             FROM apps.hz_parties                hp
                                , apps.hz_cust_accounts          hca
                                , apps.oe_order_lines_all        oola
                                , apps.oe_order_headers_all      ooha
                                , apps.ra_customer_trx_lines_all rctl
                                , apps.ra_customer_trx_all       rcta
                                , apps.hz_cust_acct_sites_all    hcas
                                , apps.hz_cust_site_uses_all     hcsu
                            WHERE ooha.header_id                 = oola.header_id
                              AND oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND rctl.inventory_item_id         = oola.inventory_item_id
                              AND rctl.line_type                 = 'LINE'
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE1 = to_char(ooha.order_number)
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE6 = to_char(oola.line_id)
                              AND RCTL.INTERFACE_LINE_CONTEXT    = 'ORDER ENTRY'
                              AND rctl.customer_trx_id           = rcta.customer_trx_id
                              AND rcta.bill_to_site_use_id       = hcsu.site_use_id
                              AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                              AND hcas.cust_account_id           = hca.cust_account_id
                              AND hca.party_id                   = hp.party_id 
                              AND ROWNUM = 1) = 'ORDER ENTRY' THEN
                     --
                     (SELECT listagg(hp.party_name,', ' ON OVERFLOW TRUNCATE)  
                         WITHIN GROUP (ORDER BY hp.party_name asc)
                             FROM apps.hz_parties                hp
                                , apps.hz_cust_accounts          hca
                                , apps.oe_order_lines_all        oola
                                , apps.oe_order_headers_all      ooha
                                , apps.ra_customer_trx_lines_all rctl
                                , apps.ra_customer_trx_all       rcta
                                , apps.hz_cust_acct_sites_all    hcas
                                , apps.hz_cust_site_uses_all     hcsu
                            WHERE ooha.header_id                 = oola.header_id
                              AND oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND rctl.inventory_item_id         = oola.inventory_item_id
                              AND rctl.line_type                 = 'LINE'
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE1 = to_char(ooha.order_number)
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE6 = to_char(oola.line_id)
                              AND RCTL.INTERFACE_LINE_CONTEXT    = 'ORDER ENTRY'
                              AND rctl.customer_trx_id           = rcta.customer_trx_id
                              AND rcta.bill_to_site_use_id       = hcsu.site_use_id
                              AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                              AND hcas.cust_account_id           = hca.cust_account_id
                              AND hca.party_id                   = hp.party_id
                              AND ROWNUM = 1)
                     --
                     ELSE
                     --            
                     CASE WHEN 
                          ( SELECT DISTINCT RCTL.INTERFACE_LINE_CONTEXT
                             FROM apps.hz_parties                hp
                                , apps.hz_cust_accounts          hca
                                , apps.oe_order_lines_all        oola
                                , apps.oe_order_headers_all      ooha
                                , apps.ra_customer_trx_lines_all rctl
                                , apps.ra_customer_trx_all       rcta
                                , apps.hz_cust_acct_sites_all    hcas
                                , apps.hz_cust_site_uses_all     hcsu
                            WHERE ooha.header_id                 = oola.header_id
                              AND oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND rctl.inventory_item_id         = oola.inventory_item_id
                              AND rctl.line_type                 = 'LINE'
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE1 = ooha.ORIG_SYS_DOCUMENT_REF
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE7 = oola.ORIG_SYS_LINE_REF
                              AND RCTL.INTERFACE_LINE_CONTEXT    = 'GEMS_PB_RR'
                              AND rctl.customer_trx_id           = rcta.customer_trx_id
                              AND rcta.bill_to_site_use_id       = hcsu.site_use_id
                              AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                              AND hcas.cust_account_id           = hca.cust_account_id
                              AND ROWNUM = 1 ) = 'GEMS_PB_RR' THEN
                     --
                     (SELECT listagg(hp.party_name,', ' ON OVERFLOW TRUNCATE)  
                         WITHIN GROUP (ORDER BY hp.party_name asc)
                             FROM apps.hz_parties                hp
                                , apps.hz_cust_accounts          hca
                                , apps.oe_order_lines_all        oola
                                , apps.oe_order_headers_all      ooha
                                , apps.ra_customer_trx_lines_all rctl
                                , apps.ra_customer_trx_all       rcta
                                , apps.hz_cust_acct_sites_all    hcas
                                , apps.hz_cust_site_uses_all     hcsu
                            WHERE ooha.header_id                 = oola.header_id
                              AND oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND rctl.inventory_item_id         = oola.inventory_item_id
                              AND rctl.line_type                 = 'LINE'
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE1 = ooha.ORIG_SYS_DOCUMENT_REF
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE7 = oola.ORIG_SYS_LINE_REF
                              AND RCTL.INTERFACE_LINE_CONTEXT    = 'GEMS_PB_RR'
                              AND rctl.customer_trx_id           = rcta.customer_trx_id
                              AND rcta.bill_to_site_use_id       = hcsu.site_use_id
                              AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                              AND hcas.cust_account_id           = hca.cust_account_id 
                              AND ROWNUM = 1 )
                     --
                     ELSE
                     --
                     (SELECT listagg(hp.party_name,', ' ON OVERFLOW TRUNCATE)  
                         WITHIN GROUP (ORDER BY hp.party_name asc)
                      FROM   APPS.HZ_CUST_ACCT_SITES_ALL HCAS,
                             apps.hz_parties             hp,
                             apps.hz_cust_accounts       hca,
                             APPS.HZ_CUST_SITE_USES_ALL  HCSU,
                             APPS.OE_ORDER_LINES_ALL     OOLA,
                             APPS.OE_ORDER_HEADERS_ALL   OOHA
                             --
                      WHERE  HCSU.SITE_USE_CODE     = 'BILL_TO'
                      AND    HCSU.CUST_ACCT_SITE_ID = HCAS.CUST_ACCT_SITE_ID
                      AND    HCSU.SITE_USE_ID       = NVL(OOLA.ATTRIBUTE1, OOHA.INVOICE_TO_ORG_ID)
                      AND    OOLA.LINE_ID           = NVL(MMT.TRX_SOURCE_LINE_ID, MMT.SOURCE_LINE_ID)
                      AND    OOHA.HEADER_ID         = OOLA.HEADER_ID
                      AND    hcas.cust_account_id   = hca.cust_account_id
                      AND    hca.party_id           = hp.party_id 
                      AND    ROWNUM = 1)
                     --          
                     END
                  END
               END      bill_to_Customer_name
               --
                , CASE WHEN (mmt.source_code = '3PL_REMITTANCE_BRAZIL') THEN
                      (SELECT listagg(DECODE(hcas.global_attribute2
                                           , '2',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'/'|| hcas.global_attribute4 ||'-'|| hcas.global_attribute5
                                           , '1',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'-'|| hcas.global_attribute5 
                                           , '3',HCSU.LOCATION||' - '||hcas.global_attribute3 ),', ' ON OVERFLOW TRUNCATE)
                       WITHIN GROUP (ORDER BY hcas.global_attribute2 asc )
                         FROM apps.ra_customer_trx_all         rcta
                            , apps.hz_cust_acct_sites_all      hcas
                            , apps.hz_cust_site_uses_all       hcsu
                        WHERE rcta.interface_header_attribute1 = mp.organization_code||'_'||mmt.transaction_reference
                          AND rcta.ship_to_site_use_id         = hcsu.site_use_id
                          AND hcsu.cust_acct_site_id           = hcas.cust_acct_site_id
                          AND rcta.org_id                      = 4330
                          AND ROWNUM = 1)
                   ELSE
                     --
                     CASE WHEN (select DISTINCT RCTL.INTERFACE_LINE_CONTEXT
                             FROM apps.hz_parties                hp
                                , apps.hz_cust_accounts          hca
                                , apps.oe_order_lines_all        oola
                                , apps.oe_order_headers_all      ooha
                                , apps.ra_customer_trx_lines_all rctl
                                , apps.ra_customer_trx_all       rcta
                                , apps.hz_cust_acct_sites_all    hcas
                                , apps.hz_cust_site_uses_all     hcsu
                            WHERE ooha.header_id                 = oola.header_id
                              AND oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND rctl.inventory_item_id         = oola.inventory_item_id
                              AND rctl.line_type                 = 'LINE'
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE1 = to_char(ooha.order_number)
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE6 = to_char(oola.line_id)
                              AND RCTL.INTERFACE_LINE_CONTEXT    = 'ORDER ENTRY'
                              AND rctl.customer_trx_id           = rcta.customer_trx_id
                              AND rcta.ship_to_site_use_id       = hcsu.site_use_id
                              AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                              AND hcas.cust_account_id           = hca.cust_account_id
                              AND hca.party_id                   = hp.party_id 
                              AND ROWNUM = 1) = 'ORDER ENTRY' THEN
                     --
                     (SELECT DISTINCT DECODE(hcas.global_attribute2
                                           , '2',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'/'|| hcas.global_attribute4 ||'-'|| hcas.global_attribute5
                                           , '1',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'-'|| hcas.global_attribute5 
                                           , '3',HCSU.LOCATION||' - '||hcas.global_attribute3)
                             FROM apps.hz_parties                hp
                                , apps.hz_cust_accounts          hca
                                , apps.oe_order_lines_all        oola
                                , apps.oe_order_headers_all      ooha
                                , apps.ra_customer_trx_lines_all rctl
                                , apps.ra_customer_trx_all       rcta
                                , apps.hz_cust_acct_sites_all    hcas
                                , apps.hz_cust_site_uses_all     hcsu
                            WHERE ooha.header_id                 = oola.header_id
                              AND oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND rctl.inventory_item_id         = oola.inventory_item_id
                              AND rctl.line_type                 = 'LINE'
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE1 = to_char(ooha.order_number)
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE6 = to_char(oola.line_id)
                              AND RCTL.INTERFACE_LINE_CONTEXT    = 'ORDER ENTRY'
                              AND rctl.customer_trx_id           = rcta.customer_trx_id
                              AND rcta.ship_to_site_use_id       = hcsu.site_use_id
                              AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                              AND hcas.cust_account_id           = hca.cust_account_id
                              AND hca.party_id                   = hp.party_id
                              AND ROWNUM = 1)
                     --
                     ELSE
                     --            
                     CASE WHEN 
                          ( SELECT DISTINCT RCTL.INTERFACE_LINE_CONTEXT
                             FROM apps.hz_parties                hp
                                , apps.hz_cust_accounts          hca
                                , apps.oe_order_lines_all        oola
                                , apps.oe_order_headers_all      ooha
                                , apps.ra_customer_trx_lines_all rctl
                                , apps.ra_customer_trx_all       rcta
                                , apps.hz_cust_acct_sites_all    hcas
                                , apps.hz_cust_site_uses_all     hcsu
                            WHERE ooha.header_id                 = oola.header_id
                              AND oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND rctl.inventory_item_id         = oola.inventory_item_id
                              AND rctl.line_type                 = 'LINE'
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE1 = ooha.ORIG_SYS_DOCUMENT_REF
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE7 = oola.ORIG_SYS_LINE_REF
                              AND RCTL.INTERFACE_LINE_CONTEXT    = 'GEMS_PB_RR'
                              AND rctl.customer_trx_id           = rcta.customer_trx_id
                              AND rcta.ship_to_site_use_id       = hcsu.site_use_id
                              AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                              AND hcas.cust_account_id           = hca.cust_account_id
                              AND ROWNUM = 1 ) = 'GEMS_PB_RR' THEN
                     --
                     (SELECT DISTINCT DECODE(hcas.global_attribute2
                                           , '2',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'/'|| hcas.global_attribute4 ||'-'|| hcas.global_attribute5
                                           , '1',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'-'|| hcas.global_attribute5 
                                           , '3',HCSU.LOCATION||' - '||hcas.global_attribute3)
                             FROM apps.hz_parties                hp
                                , apps.hz_cust_accounts          hca
                                , apps.oe_order_lines_all        oola
                                , apps.oe_order_headers_all      ooha
                                , apps.ra_customer_trx_lines_all rctl
                                , apps.ra_customer_trx_all       rcta
                                , apps.hz_cust_acct_sites_all    hcas
                                , apps.hz_cust_site_uses_all     hcsu
                            WHERE ooha.header_id                 = oola.header_id
                              AND oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND rctl.inventory_item_id         = oola.inventory_item_id
                              AND rctl.line_type                 = 'LINE'
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE1 = ooha.ORIG_SYS_DOCUMENT_REF
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE7 = oola.ORIG_SYS_LINE_REF
                              AND RCTL.INTERFACE_LINE_CONTEXT    = 'GEMS_PB_RR'
                              AND rctl.customer_trx_id           = rcta.customer_trx_id
                              AND rcta.ship_to_site_use_id       = hcsu.site_use_id
                              AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                              AND hcas.cust_account_id           = hca.cust_account_id 
                              AND ROWNUM = 1 )
                     --
                     ELSE
                     --
                     (SELECT listagg(DECODE(hcas.global_attribute2
                                           , '2',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'/'|| hcas.global_attribute4 ||'-'|| hcas.global_attribute5
                                           , '1',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'-'|| hcas.global_attribute5 
                                           , '3',HCSU.LOCATION||' - '||hcas.global_attribute3 ),', ' ON OVERFLOW TRUNCATE)
                      WITHIN GROUP (ORDER BY hcas.global_attribute2 asc) 
                         FROM apps.hz_parties             hp
                            , apps.hz_cust_accounts       hca
                            , apps.oe_order_lines_all     oola
                            , apps.hz_cust_acct_sites_all hcas
                            , apps.hz_cust_site_uses_all  hcsu
                        WHERE oola.line_id                = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                          AND oola.ship_to_org_id         = hcsu.site_use_id
                          AND hcsu.cust_acct_site_id      = hcas.cust_acct_site_id
                          AND hcas.cust_account_id        = hca.cust_account_id
                          AND hca.party_id                = hp.party_id  )
                     --
                     END
                  END
               END      ship_to_CNPJ_CPF
               --
              , CASE WHEN ( SELECT ottl.name
                              FROM apps.oe_transaction_types_tl    ottl
                                 , apps.oe_order_headers_all  ooha
                                 , apps.oe_order_lines_all    oola  
                             WHERE oola.line_id        = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                               AND oola.header_id      = ooha.header_id
                               AND ooha.order_type_id  = ottl.transaction_type_id  ) = 'GPO_BR_FE_SHIPMENT' THEN
                      (SELECT listagg(hzl.address1 ||' - '|| hzl.address2 || ' - ' || hzl.city || '-' || hzl.state || ' / ' || hzl.postal_code,', ' ON OVERFLOW TRUNCATE)  
                       WITHIN GROUP (ORDER BY hzl.address1 asc)
                       FROM apps.hz_parties             hp
                        , apps.hz_party_sites         hps
                        , apps.hz_cust_accounts       hca
                        , apps.oe_order_lines_all     oola
                        , apps.hz_cust_acct_sites_all hcas
                        , apps.hz_cust_site_uses_all  hcsu
                        , apps.hz_locations           hzl
                    WHERE oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                      AND oola.end_customer_site_use_id  = hcsu.site_use_id
                      AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                      AND hcas.cust_account_id           = hca.cust_account_id
                      AND hcas.party_site_id             = hps.party_site_id
                      AND hca.party_id                   = hp.party_id
                      AND hps.party_id                   = hp.party_id
                      AND hps.location_id                = hzl.location_id)
                ELSE
                   CASE WHEN (mmt.source_code = '3PL_REMITTANCE_BRAZIL') THEN
                      (SELECT listagg(hzl.address1 ||' - '|| hzl.address2 || ' - ' || hzl.city || '-' || hzl.state || ' / ' || hzl.postal_code,', ' ON OVERFLOW TRUNCATE)  
                       WITHIN GROUP (ORDER BY hzl.address1 asc)
                         FROM apps.ra_customer_trx_all     rcta
                            , apps.hz_cust_acct_sites_all  hcas
                            , apps.hz_cust_site_uses_all   hcsu
                            , apps.hz_parties              hp
                            , apps.hz_party_sites          hps
                            , apps.hz_cust_accounts        hca
                            , apps.hz_locations            hzl
                        WHERE rcta.interface_header_attribute1 = mp.organization_code||'_'||mmt.transaction_reference
                          AND rcta.ship_to_site_use_id         = hcsu.site_use_id
                          AND hcsu.cust_acct_site_id           = hcas.cust_acct_site_id
                          AND hcas.cust_account_id             = hca.cust_account_id
                          AND hcas.party_site_id               = hps.party_site_id
                          AND hca.party_id                     = hp.party_id
                          AND hps.party_id                     = hp.party_id
                          AND hps.location_id                  = hzl.location_id
                          AND rcta.org_id                      = 4330)
                   ELSE
                      (SELECT listagg(hzl.address1 ||' - '|| hzl.address2 || ' - ' || hzl.city || '-' || hzl.state || ' / ' || hzl.postal_code,', ' ON OVERFLOW TRUNCATE)  
                       WITHIN GROUP (ORDER BY hzl.address1 asc)
                          FROM apps.hz_parties             hp
                             , apps.hz_party_sites         hps
                             , apps.hz_cust_accounts       hca
                             , apps.oe_order_lines_all     oola
                             , apps.hz_cust_acct_sites_all hcas
                             , apps.hz_cust_site_uses_all  hcsu
                             , apps.hz_locations           hzl
                         WHERE oola.line_id                = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                           AND oola.ship_to_org_id         = hcsu.site_use_id
                           AND hcsu.cust_acct_site_id      = hcas.cust_acct_site_id
                           AND hcas.cust_account_id        = hca.cust_account_id
                           AND hcas.party_site_id          = hps.party_site_id
                           AND hca.party_id                = hp.party_id
                           AND hps.party_id                = hp.party_id
                           AND hps.location_id             = hzl.location_id   )
                   END
                END customer_address
                -- 
                -- alterado para BIll_to por Sinval fim
                -- 
              , CASE WHEN (mmt.source_code = '3PL_REMITTANCE_BRAZIL') THEN
                   (SELECT listagg(rcta.trx_number,', ' ON OVERFLOW TRUNCATE)  
                           WITHIN GROUP (ORDER BY rcta.trx_number asc)
                      FROM apps.ra_customer_trx_all       rcta
                     WHERE rcta.interface_header_attribute1  = mp.organization_code||'_'||mmt.transaction_reference
                       AND rcta.org_id                       = 4330
                       AND NVL(rcta.status_trx,'XX')         <> 'VD'
                       AND NVL(rcta.reason_code,'XX')        <> 'CANCELLATION')
                ELSE
                   (SELECT distinct RTRIM(REGEXP_REPLACE((listagg(rcta.trx_number,', ' ON OVERFLOW TRUNCATE)  
                      WITHIN GROUP (ORDER BY rcta.trx_number asc) ), '([^,]*)(,\1)+($|,)', '\1\3'),',')
                      FROM apps.ra_customer_trx_lines_all rctla
                         , apps.ra_customer_trx_all       rcta
                         , apps.oe_order_lines_all        oola
                         , apps.oe_order_headers_all      ooha
                     WHERE rcta.customer_trx_id              = rctla.customer_trx_id
                       AND oola.line_id                      = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                       AND oola.header_id                    = ooha.header_id
                       AND rctla.sales_order                 = to_char(ooha.order_number)
                       AND rctla.line_type                   = 'LINE'
                       AND rcta.batch_source_id              <> 6266 -- No RR invoices
                       AND DECODE(rctla.interface_line_context,'GEMS_PB_RR',rcta.interface_header_attribute11,'999')
                           = DECODE(rctla.interface_line_context,'GEMS_PB_RR',rcta.interface_header_attribute11,'999')
                       AND rcta.org_id                       = 4330
                       AND trunc(rcta.trx_date)              BETWEEN (trunc(mmt.transaction_date)-3) AND (trunc(mmt.transaction_date)+3)
                       AND NVL(rcta.status_trx,'XX')         <> 'VD'
                       AND NVL(rcta.reason_code,'XX')        <> 'CANCELLATION')
                END   invoice_number_ar
              , ( SELECT listagg(mrav.reservation_quantity,', ' ON OVERFLOW TRUNCATE)  
                  WITHIN GROUP (ORDER BY mrav.reservation_quantity asc) 
                    FROM apps.mtl_reservations_all_v  mrav 
                       , apps.oe_order_headers_all    ooha1
                   WHERE mrav.demand_source_header_id     = ooha1.header_id
                     AND mrav.demand_source_line_id       = NVL(mmt.trx_source_line_id, mmt.source_line_id) )  reservation_quantity
              , ( SELECT listagg(ooha1.order_number,', ' ON OVERFLOW TRUNCATE)  
                  WITHIN GROUP (ORDER BY ooha1.order_number asc) 
                    FROM apps.mtl_reservations_all_v  mrav 
                       , apps.oe_order_headers_all    ooha1
                   WHERE mrav.demand_source_header_id     = ooha1.header_id
                     AND mrav.demand_source_line_id       = NVL(mmt.trx_source_line_id, mmt.source_line_id) )  reservation_order_number
              , (SELECT distinct hp.party_name
                 --WITHIN GROUP (ORDER BY hp.party_name asc)
                   FROM apps.hz_parties              hp
                      , apps.hz_cust_accounts        hca
                      , apps.oe_order_lines_all      oola1
                      , apps.oe_order_headers_all    ooha1
                      , apps.mtl_reservations_all_v  mrav 
                  WHERE mrav.demand_source_header_id   = ooha1.header_id
                    AND mrav.demand_source_line_id     = oola1.line_id
                    AND oola1.line_id                  = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                    AND oola1.ship_to_org_id           = hca.cust_account_id
                    AND hca.party_id                   = hp.party_id )         reservation_customer_name
              , gcc1.concatenated_segments   material_account
              , gcc2.concatenated_segments   outside_processing_account
              , gcc3.concatenated_segments   material_overhead_account
              , gcc4.concatenated_segments   overhead_account
              , gcc5.concatenated_segments   resource_account
              , sysdate                                           report_date_and_time 
              , to_char(mmt.transaction_id)  transaction_id
              , DECODE( fu.user_name,NULL,NULL,fu.user_name ||' / '|| fu.description )            user_name
              , DECODE( lot_control_code, 1 ,'Sem controle de Lote' , 2,'Com controle de Lote')   lot_control
              , DECODE( serial_number_control_code, 1, 'Sem controle de Serial'
                                                  , 2, 'Pre-definido'
                                                  , 5, 'No Recebimento'
                                                  , 6, 'Baixa na Ordem de Venda' )  serial_control
              , CASE
                 WHEN    nvl(mmt.lpn_id, mmt.content_lpn_id) IS NULL AND moq.subinventory_code <> 'WHGU42GNAT'
                   THEN 
                    (SELECT listagg(lpn.license_plate_number,', ' ON OVERFLOW TRUNCATE)WITHIN GROUP (ORDER BY lpn.license_plate_number asc)
                             FROM apps.MTL_MATERIAL_TRANSACTIONS   mtt,
                                  apps.wms_license_plate_numbers   lpn,
                                  apps.oe_order_lines_all          ool
                            WHERE 1 = 1
                              AND mtt.TRX_SOURCE_LINE_ID = CASE
                                                              WHEN LINE_CATEGORY_CODE = 'ORDER'
                                                                THEN ool.line_id
                                                              WHEN LINE_CATEGORY_CODE = 'RETURN'  
                                                                THEN   
                                                                to_number(NVL(SUBSTR(ool.ORIG_SYS_LINE_REF,
                                                                                     0,
                                                                                     INSTR(ool.ORIG_SYS_LINE_REF, '.') - 1),
                                                                              -1)) -- RMA FE OE Line Id
                                                                ELSE -1
                                                                  END
                              AND mtt.TRANSACTION_TYPE_ID = 52 --sales order pick FE ORDER
                              AND mtt.transaction_quantity < 0
                              AND mtt.inventory_item_id = ool.inventory_item_id
                              AND nvl(mtt.lpn_id, mtt.content_lpn_id) = nvl(lpn.lpn_id, -1)
                              AND ool.line_id = CASE
                                                  WHEN mtt.transaction_type_name = 'RMA Receipt'
                                                    THEN mmt.TRX_SOURCE_LINE_ID
                                                  WHEN mtt.transaction_type_name = 'GPO Nationalization Receipt'
                                                     THEN 
                                                      to_number(NVL(SUBSTR(RTRIM(LTRIM(translate(mmt.TRANSACTION_REFERENCE,translate(mmt.TRANSACTION_REFERENCE||'a','1234567890.',' '),' '))),
                                                         0,
                                                         INSTR(RTRIM(LTRIM(translate(mmt.TRANSACTION_REFERENCE,translate(mmt.TRANSACTION_REFERENCE||'a','1234567890.',' '),' '))), '.') - 1),
                                                  -1))
                                                  ELSE -1
                                                    END)
                              WHEN moq.subinventory_code = 'WHGU42GNAT'
                  THEN (SELECT listagg(wlp.license_plate_number,', ' ON OVERFLOW TRUNCATE)  
                            WITHIN GROUP (ORDER BY wlp.license_plate_number asc)
                        FROM   gems_ont.ge_gpo_nationalization_line gnl, 
                               gems_ont.ge_gpo_nationalization_line gn2,
                               apps.wms_license_plate_numbers       wlp,
                               apps.po_line_locations_all           pll,
                               apps.po_lines_all                    pol,
                               apps.po_headers_all                  poh,
                               apps.rcv_shipment_headers            rsh,
                               apps.rcv_transactions                rt
                        Where  wlp.lpn_id(+) = gn2.lpn_id
                        AND gnl.nationalization_so_line_id = gn2.nationalization_so_line_id
                        AND pll.line_location_id = gnl.DOCUMENT_ID
                        AND pll.po_header_id = poh.po_header_id
                        AND pll.po_line_id = pol.po_line_id
                        AND gn2.record_type = 'IMPORT'
                        AND gnl.record_type = 'NATIONALIZATION'
                        AND rt.transaction_id                = mmt.rcv_transaction_id
                        AND rt.po_line_location_id           = pll.line_location_id
                        AND rt.shipment_header_id            = rsh.shipment_header_id)
                ELSE (SELECT lpn.LICENSE_PLATE_NUMBER
                           FROM   apps.wms_license_plate_numbers   lpn
                           WHERE  nvl(mmt.lpn_id, mmt.content_lpn_id) = nvl(lpn.lpn_id, -1))
                        END LPN_Value                                    
              , 'q14' query
--, mmt.transaction_type_id
--, mmt.trx_source_line_id
--, mmt.source_line_id
           FROM apps.mtl_parameters                  mp
              , apps.mtl_system_items_b              msi
              , apps.mtl_secondary_inventories_fk_v  msifv
              , apps.gl_code_combinations            gcc
              , apps.gl_code_combinations_kfv        gcc1
              , apps.gl_code_combinations_kfv        gcc2
              , apps.gl_code_combinations_kfv        gcc3
              , apps.gl_code_combinations_kfv        gcc4
              , apps.gl_code_combinations_kfv        gcc5
              , apps.mtl_item_locations_kfv          milk
              , AMARCHIVE.MTL_MATERIAL_TRANSACTIONS       mmt
              , apps.mtl_transaction_types           mtt
              , apps.mtl_txn_source_types            mtst
              , apps.fnd_flex_values_vl              ffvv
              , apps.fnd_flex_value_sets             ffvs
              , apps.fnd_user                        fu
              , ( SELECT organization_id
                       , inventory_item_id
                       , subinventory_code
                       , locator_id
                       , lot_number
                      --, transaction_uom_code
                       , create_transaction_id
                       , SUM (primary_transaction_quantity) onhand_qty
                    FROM apps.mtl_onhand_quantities_detail
                   WHERE organization_id IN (SELECT ood.organization_id FROM apps.org_organization_definitions ood WHERE ood.set_of_books_id = 230 )
                   GROUP BY organization_id
                          , inventory_item_id
                          , subinventory_code
                          , locator_id
                        --  , revision
                          , lot_number
                          --, transaction_uom_code
                          , create_transaction_id ) moq
                          ,APPS.MTL_PAC_ACTUAL_COST_DETAILS MPACD 
          WHERE 1                                = 1
          AND decode(mmt.periodic_primary_quantity,null,mmt.transfer_transaction_id,MMT.TRANSACTION_ID) = MPACD.TRANSACTION_ID  
            AND mp.organization_id               = msi.organization_id
--            AND msi.segment1 = '60510302'
            AND msifv.organization_id            = msi.organization_id
            AND msifv.secondary_inventory_name   = moq.subinventory_code
            AND msifv.material_account           = gcc1.code_combination_id
            AND msifv.outside_processing_account = gcc2.code_combination_id
            AND msifv.material_overhead_account  = gcc3.code_combination_id
            AND msifv.overhead_account           = gcc4.code_combination_id
            AND msifv.resource_account           = gcc5.code_combination_id
            AND msi.cost_of_sales_account       = gcc.code_combination_id
            AND ffvs.flex_value_set_name        = 'GE_GL_AFF_ES_PRODUCT_LINE'
            AND ffvs.flex_value_set_id          = ffvv.flex_value_set_id
            AND ffvv.flex_value_meaning         = gcc.segment8
            AND 'TYPE 1'                        IN ('TYPE 1')
            AND msi.organization_id             IN (SELECT ood.organization_id FROM apps.org_organization_definitions ood WHERE ood.set_of_books_id = 230 )
            AND moq.inventory_item_id           = msi.inventory_item_id
            AND moq.organization_id             = msi.organization_id
            AND moq.locator_id                  = milk.inventory_location_id
            AND moq.create_transaction_id       = mmt.transaction_id
--    AND MMT.TRANSACTION_ID = 2562828197
            AND mtt.transaction_type_id         (+) = mmt.transaction_type_id 
            AND mtst.transaction_source_type_id (+) = mmt.transaction_source_type_id
            AND msi.serial_number_control_code      = '1' 
            AND msi.lot_control_code                = '1'
            AND fu.user_id                      (+) = mmt.created_by 
    AND MMT.TRANSACTION_ID NOT IN(SELECT MMT2.TRANSACTION_ID 
                                  FROM APPS.MTL_MATERIAL_TRANSACTIONS MMT2
                                  WHERE MMT2.TRANSACTION_ID = MMT.TRANSACTION_ID)
------------------------------------------------------------------------------
UNION  
------------------------------------------------------------------------------  
-- Com Controle de Serial e Sem Controle de Lote e sem Locator
         SELECT DISTINCT  --'15' NUM
        /* ( SELECT ccg.cost_group 
                             FROM apps.cst_cost_groups            ccg
                                , apps.cst_cost_group_assignments ccga
                            WHERE ccga.cost_group_id     = ccg.cost_group_id
                              AND ccga.organization_id   = mp.organization_id )  cost_group*/
            ( SELECT ccg.cost_group 
                             FROM apps.cst_cost_groups            ccg
                            WHERE MPACD.cost_group_id     = ccg.cost_group_id )  cost_group  
              , ( SELECT ( SELECT cpp1.period_name 
                             FROM apps.cst_pac_item_costs   cst
                                , apps.cst_pac_periods      cpp1
                            WHERE cst.pac_period_id     = (SELECT MAX(PAC_PERIOD_ID)                   FROM APPS.CST_PAC_PERIODS                  WHERE LEGAL_ENTITY = (SELECT LEGAL_ENTITY                                          FROM APPS.ORG_ORGANIZATION_DEFINITIONS OOD                                         WHERE OOD.ORGANIZATION_ID = mp.organization_id                                         ) )
                              AND cst.pac_period_id     = cpp1.pac_period_id
                              AND cst.inventory_item_id = msi.inventory_item_id
                              AND cst.cost_group_id     = ccg.cost_group_id )  
                    FROM apps.cst_cost_groups            ccg
                       , apps.cst_cost_group_assignments ccga
                   WHERE ccga.cost_group_id     = ccg.cost_group_id
                     AND ccga.organization_id   = mp.organization_id ) period_name
              , mp.organization_code
              , mp.attribute7                organization_type
              , mp.organization_id 
              , moq.subinventory_code
              , msifv.description            subinv_description
              , NULL locators  --, milk.concatenated_segments   locators
              , DECODE( msifv.asset_inventory, 1 , 'Asset', 2, 'Non Asset')   asset_type
              , msi.segment1                 part_number
              , DECODE(msi.inventory_asset_flag, NULL, 'No', 'N', 'No', 'Y', 'Yes')                         flag_asset_inventory
              , DECODE(msi.costing_enabled_flag, NULL, 'No', 'N', 'No', 'Y', 'Yes')                         flag_de_custo
              , msi.description              descrip_eng
              , msi.attribute3               descrip_ptb
              , msi.creation_date            item_creation_date
              , (trunc(SYSDATE) - trunc(msi.creation_date))      days_from_creation
              , gcc.segment8                                     product_line
              , ffvv.description                                 desc_prod_line   
              , msi.primary_uom_code    uom
              , DECODE (msi.serial_number_control_code, 1, moq.onhand_qty, 1)    transaction_quantity
              , NVL(( SELECT cic.item_cost
                        FROM apps.cst_item_costs cic
                       WHERE cic.organization_id   = msi.organization_id
                         AND cic.inventory_item_id = msi.inventory_item_id
                         AND cic.cost_type_id      = 1 ),0)  custo_unit_inv
              /*, nvl(( SELECT ( SELECT ROUND (cst.item_cost,2) 
                                 FROM apps.cst_pac_item_costs   cst
                                WHERE cst.pac_period_id     = (SELECT MAX(PAC_PERIOD_ID)                   FROM APPS.CST_PAC_PERIODS                  WHERE LEGAL_ENTITY = (SELECT LEGAL_ENTITY                                          FROM APPS.ORG_ORGANIZATION_DEFINITIONS OOD                                         WHERE OOD.ORGANIZATION_ID = mp.organization_id                                         ) )
                                  AND cst.inventory_item_id = msi.inventory_item_id
                                  AND cst.cost_group_id     = ccg.cost_group_id )  item_cost
                        FROM apps.cst_cost_groups            ccg
                           , apps.cst_cost_group_assignments ccga
                       WHERE ccga.cost_group_id     = ccg.cost_group_id
                         AND ccga.organization_id   = mp.organization_id ) ,0) custo_unit_pac*/
                , nvl((SELECT ROUND (cst.item_cost,2) 
                       FROM apps.cst_pac_item_costs   cst
                      WHERE cst.pac_period_id     = (SELECT MAX(PAC_PERIOD_ID)                   
                                                                FROM APPS.CST_PAC_PERIODS                  
                                                                WHERE LEGAL_ENTITY = (SELECT LEGAL_ENTITY                                         
                                                                                        FROM APPS.ORG_ORGANIZATION_DEFINITIONS OOD                                        
                                                                                        WHERE OOD.ORGANIZATION_ID = mp.organization_id
                                                        ) )
                        AND cst.inventory_item_id = msi.inventory_item_id
                        AND cst.cost_group_id     = MPACD.cost_group_id) ,0)  custo_unit_pac
              , NULL  lot_number
              , NULL  lot_creation_date
              , NULL  lot_qty_days_creation
              , NULL  lot_expiration_date
              , msn.serial_number
              , msn.creation_date   serial_creation_date
              , mtt.transaction_type_name           last_transaction_type
              , mmt.transaction_source_name         last_transaction_source
              , mtst.transaction_source_type_name   last_source_type
              , mmt.source_code
              , TO_CHAR(mmt.transaction_date, 'DD-MON-RRRR')      transaction_date
        , (SELECT TO_CHAR(mmt1.transaction_date, 'DD-MON-RRRR') 
                        FROM apps.mtl_material_transactions mmt1
                        WHERE mmt1.transaction_type_id=420
                        AND mmt1.source_line_id=mmt.source_line_id) initial_consignment_date
              , (TRUNC ( SYSDATE )- TRUNC(mmt.transaction_date))  transaction_qty_of_days
              , TO_CHAR(mmt.transaction_reference)                transaction_reference
              , CASE WHEN mmt.source_code = '3PL_REMITTANCE_BRAZIL' THEN
                     (SELECT listagg(pha.segment1,', ' ON OVERFLOW TRUNCATE)  
                      WITHIN GROUP (ORDER BY pha.segment1 asc)
                        FROM apps.po_headers_all        pha,
                             apps.po_lines_all          pla
                       WHERE pla.po_line_id   = mmt.source_line_id
                         AND pla.po_header_id = pha.po_header_id)
                     WHEN mmt.source_code IN ('ORDER ENTRY','IIP') THEN
                        NULL
                     WHEN mmt.source_code = 'RCV' THEN
                        ( SELECT listagg(pha.segment1,', ' ON OVERFLOW TRUNCATE)  
                          WITHIN GROUP (ORDER BY pha.segment1 asc)
                            FROM apps.po_headers_all            pha
                               , apps.po_lines_all              pla
                               , apps.po_line_locations_all     plla
                               , apps.rcv_shipment_headers      rsh
                               , apps.rcv_transactions          rt
                           WHERE rt.transaction_id                = mmt.rcv_transaction_id
                             AND rt.po_line_location_id           = plla.line_location_id
                             AND plla.po_line_id                  = pla.po_line_id
                             AND pha.po_header_id                 = pla.po_header_id
                             AND rt.shipment_header_id            = rsh.shipment_header_id
                             AND rsh.receipt_source_code          = 'VENDOR'  )
                     ELSE
                        NULL
                END      po_number
              , CASE WHEN mmt.source_code = '3PL_REMITTANCE_BRAZIL' THEN
                     (SELECT listagg(aps.vendor_name,', ' ON OVERFLOW TRUNCATE)  
                      WITHIN GROUP (ORDER BY aps.vendor_name asc)
                        FROM apps.po_headers_all        pha
                           , apps.po_lines_all          pla
                           , apps.ap_suppliers          aps
                           , apps.ap_supplier_sites_all  apss
                       WHERE pla.po_line_id     = mmt.source_line_id
                         AND pla.po_header_id   = pha.po_header_id
                         AND pha.vendor_id      = aps.vendor_id
                         AND aps.vendor_id      = apss.vendor_id
                         AND pha.vendor_site_id = apss.vendor_site_id )
                     WHEN mmt.source_code IN ('ORDER ENTRY','IIP') THEN
                        NULL
                     WHEN mmt.source_code = 'RCV' THEN
                        ( SELECT listagg(aps.vendor_name,', ' ON OVERFLOW TRUNCATE)  
                          WITHIN GROUP (ORDER BY aps.vendor_name asc)
                            FROM apps.po_headers_all            pha
                               , apps.po_lines_all              pla
                               , apps.po_line_locations_all     plla
                               , apps.rcv_shipment_headers      rsh
                               , apps.rcv_transactions          rt
                               , apps.ap_suppliers              aps
                               , apps.ap_supplier_sites_all     apss
                           WHERE rt.transaction_id          = mmt.rcv_transaction_id
                             AND rt.po_line_location_id     = plla.line_location_id
                             AND plla.po_line_id            = pla.po_line_id
                             AND pha.po_header_id           = pla.po_header_id
                             AND rt.shipment_header_id      = rsh.shipment_header_id
                             AND rsh.receipt_source_code    = 'VENDOR'
                             AND pha.vendor_id              = aps.vendor_id
                             AND aps.vendor_id              = apss.vendor_id
                             AND pha.vendor_site_id         = apss.vendor_site_id  )
                     ELSE
                        NULL
                END     po_supplier
              , CASE WHEN mmt.source_code = '3PL_REMITTANCE_BRAZIL' THEN
                     ( SELECT listagg(cfi.invoice_num,', ' ON OVERFLOW TRUNCATE)  
                         WITHIN GROUP (ORDER BY cfi.invoice_num asc)
                         FROM apps.cll_f189_invoice_lines cfil
                            , apps.cll_f189_invoices      cfi
                            , apps.po_lines_all           pla
                            , apps.po_line_locations_all  plla
                        WHERE plla.po_line_id       = pla.po_line_id
                          AND pla.po_line_id        = mmt.source_line_id
                          AND plla.line_location_id = cfil.line_location_id
                          AND cfil.invoice_id       = cfi.invoice_id )
                     WHEN mmt.source_code IN ('ORDER ENTRY','IIP') THEN
                        NULL
                     WHEN mmt.source_code = 'RCV' THEN
                        ( SELECT listagg(cfi.invoice_num,', ' ON OVERFLOW TRUNCATE)  
                            WITHIN GROUP (ORDER BY cfi.invoice_num asc)
                            FROM apps.po_headers_all            pha
                               , apps.po_lines_all              pla
                               , apps.po_line_locations_all     plla
                               , apps.cll_f189_invoice_lines    cfil
                               , apps.cll_f189_invoices         cfi
                               , apps.rcv_shipment_headers      rsh
                               , apps.rcv_transactions          rt
                           WHERE rt.transaction_id          = mmt.rcv_transaction_id
                             AND rt.po_line_location_id     = plla.line_location_id
                             AND plla.line_location_id      = cfil.line_location_id
                             AND cfil.invoice_id            = cfi.invoice_id
                             AND plla.po_line_id            = pla.po_line_id
                             AND pha.po_header_id           = pla.po_header_id
                             AND rt.shipment_header_id      = rsh.shipment_header_id
                             AND rsh.receipt_source_code    = 'VENDOR'   )
                     ELSE
                        NULL
                END    NF_RI
             , (SELECT DECODE( mmt.source_code, '3PL_REMITTANCE_BRAZIL',NULL,to_char(ooha.order_number) )
                  FROM apps.oe_order_headers_all  ooha,
                       apps.oe_order_lines_all    oola  
                 WHERE oola.line_id        = NVL(mmt.trx_source_line_id, mmt.source_line_id) 
                   AND oola.header_id      = ooha.header_id )   order_number
               -- 
               -- alterado para BIll_to por Sinval inicio
               --
               , CASE WHEN ( SELECT ottl.name
                             FROM apps.oe_transaction_types_tl    ottl
                                , apps.oe_order_headers_all  ooha
                                , apps.oe_order_lines_all    oola  
                            WHERE oola.line_id        = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND oola.header_id      = ooha.header_id
                              AND ooha.order_type_id  = ottl.transaction_type_id  ) = 'GPO_BR_FE_SHIPMENT' THEN
                     (SELECT listagg(hp.party_name,', ' ON OVERFLOW TRUNCATE)  
                      WITHIN GROUP (ORDER BY hp.party_name asc)
                        FROM apps.hz_parties             hp
                           , apps.hz_cust_accounts       hca
                           , apps.oe_order_lines_all     oola
                           , apps.hz_cust_acct_sites_all hcas
                           , apps.hz_cust_site_uses_all  hcsu
                       WHERE oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                         AND oola.end_customer_site_use_id  = hcsu.site_use_id
                         AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                         AND hcas.cust_account_id           = hca.cust_account_id
                         AND hca.party_id                   = hp.party_id )
                  ELSE
                     CASE WHEN (mmt.source_code = '3PL_REMITTANCE_BRAZIL') THEN
                       (SELECT listagg(hp.party_name,', ' ON OVERFLOW TRUNCATE)  
                        WITHIN GROUP (ORDER BY hp.party_name asc)
                          FROM apps.hz_parties             hp,
                               apps.hz_cust_accounts       hca,
                               apps.ra_customer_trx_all    rcta,
                               apps.hz_cust_acct_sites_all hcas,
                               apps.hz_cust_site_uses_all  hcsu
                         WHERE rcta.interface_header_attribute1 = mp.organization_code||'_'||mmt.transaction_reference
                           AND rcta.ship_to_site_use_id         = hcsu.site_use_id
                           AND hcsu.cust_acct_site_id           = hcas.cust_acct_site_id
                           AND hcas.cust_account_id             = hca.cust_account_id
                           AND hca.party_id                     = hp.party_id
                           AND rcta.org_id                      = 4330)
                     ELSE
                        (SELECT listagg(hp.party_name,', ' ON OVERFLOW TRUNCATE)  
                         WITHIN GROUP (ORDER BY hp.party_name asc)
                           FROM apps.hz_parties             hp
                              , apps.hz_cust_accounts       hca
                              , apps.oe_order_lines_all     oola
                              , apps.hz_cust_acct_sites_all hcas
                              , apps.hz_cust_site_uses_all  hcsu
                          WHERE oola.line_id                = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                            AND oola.ship_to_org_id         = hcsu.site_use_id
                            AND hcsu.cust_acct_site_id      = hcas.cust_acct_site_id
                            AND hcas.cust_account_id        = hca.cust_account_id
                            AND hca.party_id                = hp.party_id )
                    END                 
               END    customer_name
             , CASE WHEN ( SELECT ottl.name
                             FROM apps.oe_transaction_types_tl    ottl
                                , apps.oe_order_headers_all  ooha
                                , apps.oe_order_lines_all    oola  
                            WHERE oola.line_id        = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND oola.header_id      = ooha.header_id
                              AND ooha.order_type_id  = ottl.transaction_type_id  ) = 'GPO_BR_FE_SHIPMENT' THEN
                     (SELECT listagg(hca.account_number,', ' ON OVERFLOW TRUNCATE)  
                      WITHIN GROUP (ORDER BY hca.account_number asc)
                        FROM apps.hz_parties             hp
                           , apps.hz_cust_accounts       hca
                           , apps.oe_order_lines_all     oola
                           , apps.hz_cust_acct_sites_all hcas
                           , apps.hz_cust_site_uses_all  hcsu
                       WHERE oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                         AND oola.end_customer_site_use_id  = hcsu.site_use_id
                         AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                         AND hcas.cust_account_id           = hca.cust_account_id
                         AND hca.party_id                   = hp.party_id )
                  ELSE
                     CASE WHEN (mmt.source_code = '3PL_REMITTANCE_BRAZIL') THEN
                        (SELECT listagg(hca.account_number,', ' ON OVERFLOW TRUNCATE)  
                         WITHIN GROUP (ORDER BY hca.account_number asc)
                           FROM apps.hz_parties             hp,
                                apps.hz_cust_accounts       hca,
                                apps.ra_customer_trx_all    rcta,
                                apps.hz_cust_acct_sites_all hcas,
                                apps.hz_cust_site_uses_all  hcsu
                          WHERE rcta.interface_header_attribute1 = mp.organization_code||'_'||mmt.transaction_reference
                            AND rcta.ship_to_site_use_id         = hcsu.site_use_id
                            AND hcsu.cust_acct_site_id           = hcas.cust_acct_site_id
                            AND hcas.cust_account_id             = hca.cust_account_id
                            AND hca.party_id                     = hp.party_id
                            AND rcta.org_id                      = 4330)
                     ELSE
                        (SELECT listagg(hca.account_number,', ' ON OVERFLOW TRUNCATE)  
                         WITHIN GROUP (ORDER BY hca.account_number asc)
                           FROM apps.hz_parties             hp
                              , apps.hz_cust_accounts       hca
                              , apps.oe_order_lines_all     oola
                              , apps.hz_cust_acct_sites_all hcas
                              , apps.hz_cust_site_uses_all  hcsu
                          WHERE oola.line_id                = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                            AND oola.ship_to_org_id         = hcsu.site_use_id
                            AND hcsu.cust_acct_site_id      = hcas.cust_acct_site_id
                            AND hcas.cust_account_id        = hca.cust_account_id
                            AND hca.party_id                = hp.party_id   )
                     END
                  END   customer_number
              --
              , CASE WHEN ( SELECT ottl.name
                             FROM apps.oe_transaction_types_tl    ottl
                                , apps.oe_order_headers_all  ooha
                                , apps.oe_order_lines_all    oola  
                            WHERE oola.line_id        = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND oola.header_id      = ooha.header_id
                              AND ooha.order_type_id  = ottl.transaction_type_id  ) = 'GPO_BR_FE_SHIPMENT' THEN
                     (SELECT listagg(DECODE(hcas.global_attribute2
                                           , '2',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'/'|| hcas.global_attribute4 ||'-'|| hcas.global_attribute5
                                           , '1',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'-'|| hcas.global_attribute5 
                                           , '3',HCSU.LOCATION||' - '||hcas.global_attribute3 ),', ' ON OVERFLOW TRUNCATE)
                     WITHIN GROUP (ORDER BY hcas.global_attribute2 asc ) 
                        FROM apps.hz_parties             hp
                           , apps.hz_cust_accounts       hca
                           , apps.oe_order_lines_all     oola
                           , apps.hz_cust_acct_sites_all hcas
                           , apps.hz_cust_site_uses_all  hcsu
                       WHERE oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                         AND oola.end_customer_site_use_id  = hcsu.site_use_id
                         AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                         AND hcas.cust_account_id           = hca.cust_account_id
                         AND hca.party_id                   = hp.party_id )
                ELSE
                   CASE WHEN (mmt.source_code = '3PL_REMITTANCE_BRAZIL') THEN
                      (SELECT listagg(DECODE(hcas.global_attribute2
                                           , '2',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'/'|| hcas.global_attribute4 ||'-'|| hcas.global_attribute5
                                           , '1',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'-'|| hcas.global_attribute5 
                                           , '3',HCSU.LOCATION||' - '||hcas.global_attribute3 ),', ' ON OVERFLOW TRUNCATE)
                     WITHIN GROUP (ORDER BY hcas.global_attribute2 asc) 
                         FROM apps.ra_customer_trx_all     rcta
                            , apps.hz_cust_acct_sites_all  hcas
                            , apps.hz_cust_site_uses_all   hcsu
                        WHERE rcta.interface_header_attribute1 = mp.organization_code||'_'||mmt.transaction_reference
                          AND rcta.ship_to_site_use_id         = hcsu.site_use_id
                          AND hcsu.cust_acct_site_id           = hcas.cust_acct_site_id
                          AND rcta.org_id                      = 4330)
                   ELSE
                      (SELECT listagg(DECODE(hcas.global_attribute2
                                           , '2',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'/'|| hcas.global_attribute4 ||'-'|| hcas.global_attribute5
                                           , '1',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'-'|| hcas.global_attribute5 
                                           , '3',HCSU.LOCATION||' - '||hcas.global_attribute3 ),', ' ON OVERFLOW TRUNCATE)
                      WITHIN GROUP (ORDER BY hcas.global_attribute2 asc) 
                         FROM apps.hz_parties             hp
                            , apps.hz_cust_accounts       hca
                            , apps.oe_order_lines_all     oola
                            , apps.hz_cust_acct_sites_all hcas
                            , apps.hz_cust_site_uses_all  hcsu
                        WHERE oola.line_id                = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                          AND oola.ship_to_org_id         = hcsu.site_use_id
                          AND hcsu.cust_acct_site_id      = hcas.cust_acct_site_id
                          AND hcas.cust_account_id        = hca.cust_account_id
                          AND hca.party_id                = hp.party_id  )
                   END
                END  customer_cnpj_cpf
               -- 
              , CASE WHEN (mmt.source_code = '3PL_REMITTANCE_BRAZIL') THEN
                      (SELECT listagg(DECODE(hcas.global_attribute2
                                           , '2',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'/'|| hcas.global_attribute4 ||'-'|| hcas.global_attribute5
                                           , '1',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'-'|| hcas.global_attribute5 
                                           , '3',HCSU.LOCATION||' - '||hcas.global_attribute3 ),', ' ON OVERFLOW TRUNCATE)
                       WITHIN GROUP (ORDER BY hcas.global_attribute2 asc )
                         FROM apps.ra_customer_trx_all         rcta
                            , apps.hz_cust_acct_sites_all      hcas
                            , apps.hz_cust_site_uses_all       hcsu
                        WHERE rcta.interface_header_attribute1 = mp.organization_code||'_'||mmt.transaction_reference
                          AND rcta.bill_to_site_use_id         = hcsu.site_use_id
                          AND hcsu.cust_acct_site_id           = hcas.cust_acct_site_id
                          AND rcta.org_id                      = 4330
                          AND ROWNUM = 1)
                   ELSE
                     --
                     CASE WHEN (select DISTINCT RCTL.INTERFACE_LINE_CONTEXT
                             FROM apps.hz_parties                hp
                                , apps.hz_cust_accounts          hca
                                , apps.oe_order_lines_all        oola
                                , apps.oe_order_headers_all      ooha
                                , apps.ra_customer_trx_lines_all rctl
                                , apps.ra_customer_trx_all       rcta
                                , apps.hz_cust_acct_sites_all    hcas
                                , apps.hz_cust_site_uses_all     hcsu
                            WHERE ooha.header_id                 = oola.header_id
                              AND oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND rctl.inventory_item_id         = oola.inventory_item_id
                              AND rctl.line_type                 = 'LINE'
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE1 = to_char(ooha.order_number)
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE6 = to_char(oola.line_id)
                              AND RCTL.INTERFACE_LINE_CONTEXT    = 'ORDER ENTRY'
                              AND rctl.customer_trx_id           = rcta.customer_trx_id
                              AND rcta.bill_to_site_use_id       = hcsu.site_use_id
                              AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                              AND hcas.cust_account_id           = hca.cust_account_id
                              AND hca.party_id                   = hp.party_id 
                              AND ROWNUM = 1) = 'ORDER ENTRY' THEN
                     --
                     (SELECT DISTINCT DECODE(hcas.global_attribute2
                                           , '2',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'/'|| hcas.global_attribute4 ||'-'|| hcas.global_attribute5
                                           , '1',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'-'|| hcas.global_attribute5 
                                           , '3',HCSU.LOCATION||' - '||hcas.global_attribute3)
                             FROM apps.hz_parties                hp
                                , apps.hz_cust_accounts          hca
                                , apps.oe_order_lines_all        oola
                                , apps.oe_order_headers_all      ooha
                                , apps.ra_customer_trx_lines_all rctl
                                , apps.ra_customer_trx_all       rcta
                                , apps.hz_cust_acct_sites_all    hcas
                                , apps.hz_cust_site_uses_all     hcsu
                            WHERE ooha.header_id                 = oola.header_id
                              AND oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND rctl.inventory_item_id         = oola.inventory_item_id
                              AND rctl.line_type                 = 'LINE'
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE1 = to_char(ooha.order_number)
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE6 = to_char(oola.line_id)
                              AND RCTL.INTERFACE_LINE_CONTEXT    = 'ORDER ENTRY'
                              AND rctl.customer_trx_id           = rcta.customer_trx_id
                              AND rcta.bill_to_site_use_id       = hcsu.site_use_id
                              AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                              AND hcas.cust_account_id           = hca.cust_account_id
                              AND hca.party_id                   = hp.party_id
                              AND ROWNUM = 1)
                     --
                     ELSE
                     --            
                     CASE WHEN 
                          ( SELECT DISTINCT RCTL.INTERFACE_LINE_CONTEXT
                             FROM apps.hz_parties                hp
                                , apps.hz_cust_accounts          hca
                                , apps.oe_order_lines_all        oola
                                , apps.oe_order_headers_all      ooha
                                , apps.ra_customer_trx_lines_all rctl
                                , apps.ra_customer_trx_all       rcta
                                , apps.hz_cust_acct_sites_all    hcas
                                , apps.hz_cust_site_uses_all     hcsu
                            WHERE ooha.header_id                 = oola.header_id
                              AND oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND rctl.inventory_item_id         = oola.inventory_item_id
                              AND rctl.line_type                 = 'LINE'
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE1 = ooha.ORIG_SYS_DOCUMENT_REF
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE7 = oola.ORIG_SYS_LINE_REF
                              AND RCTL.INTERFACE_LINE_CONTEXT    = 'GEMS_PB_RR'
                              AND rctl.customer_trx_id           = rcta.customer_trx_id
                              AND rcta.bill_to_site_use_id       = hcsu.site_use_id
                              AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                              AND hcas.cust_account_id           = hca.cust_account_id
                              AND ROWNUM = 1 ) = 'GEMS_PB_RR' THEN
                     --
                     (SELECT DISTINCT DECODE(hcas.global_attribute2
                                           , '2',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'/'|| hcas.global_attribute4 ||'-'|| hcas.global_attribute5
                                           , '1',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'-'|| hcas.global_attribute5 
                                           , '3',HCSU.LOCATION||' - '||hcas.global_attribute3)
                             FROM apps.hz_parties                hp
                                , apps.hz_cust_accounts          hca
                                , apps.oe_order_lines_all        oola
                                , apps.oe_order_headers_all      ooha
                                , apps.ra_customer_trx_lines_all rctl
                                , apps.ra_customer_trx_all       rcta
                                , apps.hz_cust_acct_sites_all    hcas
                               , apps.hz_cust_site_uses_all     hcsu
                            WHERE ooha.header_id                 = oola.header_id
                              AND oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND rctl.inventory_item_id         = oola.inventory_item_id
                              AND rctl.line_type                 = 'LINE'
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE1 = ooha.ORIG_SYS_DOCUMENT_REF
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE7 = oola.ORIG_SYS_LINE_REF
                              AND RCTL.INTERFACE_LINE_CONTEXT    = 'GEMS_PB_RR'
                              AND rctl.customer_trx_id           = rcta.customer_trx_id
                              AND rcta.bill_to_site_use_id       = hcsu.site_use_id
                              AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                              AND hcas.cust_account_id           = hca.cust_account_id 
                              AND ROWNUM = 1 )
                     --
                     ELSE
                     --
                     (SELECT DISTINCT DECODE(hcas.global_attribute2
                                   , '2',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'/'|| hcas.global_attribute4 ||'-'|| hcas.global_attribute5
                                   , '1',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'-'|| hcas.global_attribute5 
                                   , '3',HCSU.LOCATION||' - '||hcas.global_attribute3)
                             --
                      FROM   APPS.HZ_CUST_ACCT_SITES_ALL HCAS,
                             APPS.HZ_CUST_SITE_USES_ALL  HCSU,
                             APPS.OE_ORDER_LINES_ALL     OOLA,
                             APPS.OE_ORDER_HEADERS_ALL   OOHA
                             --
                      WHERE  HCSU.SITE_USE_CODE     = 'BILL_TO'
                      AND    HCSU.CUST_ACCT_SITE_ID = HCAS.CUST_ACCT_SITE_ID
                      AND    HCSU.SITE_USE_ID       = NVL(OOLA.ATTRIBUTE1, OOHA.INVOICE_TO_ORG_ID)
                      AND    OOLA.LINE_ID           = NVL(MMT.TRX_SOURCE_LINE_ID, MMT.SOURCE_LINE_ID)
                      AND    OOHA.HEADER_ID         = OOLA.HEADER_ID
                      AND    ROWNUM = 1)
                     --
                     END
                  END
               END      bill_to_CNPJ_CPF
               --
                             --
              , CASE WHEN (mmt.source_code = '3PL_REMITTANCE_BRAZIL') THEN
                        (SELECT listagg(hp.party_name,', ' ON OVERFLOW TRUNCATE)  
                        WITHIN GROUP (ORDER BY hp.party_name asc)
                          FROM apps.hz_parties             hp,
                               apps.hz_cust_accounts       hca,
                               apps.ra_customer_trx_all    rcta,
                               apps.hz_cust_acct_sites_all hcas,
                               apps.hz_cust_site_uses_all  hcsu
                         WHERE rcta.interface_header_attribute1 = mp.organization_code||'_'||mmt.transaction_reference
                           AND rcta.bill_to_site_use_id         = hcsu.site_use_id
                           AND hcsu.cust_acct_site_id           = hcas.cust_acct_site_id
                           AND hcas.cust_account_id             = hca.cust_account_id
                           AND hca.party_id                     = hp.party_id
                           AND rcta.org_id                      = 4330)
                   ELSE
                     --
                     CASE WHEN (select DISTINCT RCTL.INTERFACE_LINE_CONTEXT
                             FROM apps.hz_parties                hp
                                , apps.hz_cust_accounts          hca
                                , apps.oe_order_lines_all        oola
                                , apps.oe_order_headers_all      ooha
                                , apps.ra_customer_trx_lines_all rctl
                                , apps.ra_customer_trx_all       rcta
                                , apps.hz_cust_acct_sites_all    hcas
                                , apps.hz_cust_site_uses_all     hcsu
                            WHERE ooha.header_id                 = oola.header_id
                              AND oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND rctl.inventory_item_id         = oola.inventory_item_id
                              AND rctl.line_type                 = 'LINE'
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE1 = to_char(ooha.order_number)
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE6 = to_char(oola.line_id)
                              AND RCTL.INTERFACE_LINE_CONTEXT    = 'ORDER ENTRY'
                              AND rctl.customer_trx_id           = rcta.customer_trx_id
                              AND rcta.bill_to_site_use_id       = hcsu.site_use_id
                              AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                              AND hcas.cust_account_id           = hca.cust_account_id
                              AND hca.party_id                   = hp.party_id 
                              AND ROWNUM = 1) = 'ORDER ENTRY' THEN
                     --
                     (SELECT listagg(hp.party_name,', ' ON OVERFLOW TRUNCATE)  
                         WITHIN GROUP (ORDER BY hp.party_name asc)
                             FROM apps.hz_parties                hp
                                , apps.hz_cust_accounts          hca
                                , apps.oe_order_lines_all        oola
                                , apps.oe_order_headers_all      ooha
                                , apps.ra_customer_trx_lines_all rctl
                                , apps.ra_customer_trx_all       rcta
                                , apps.hz_cust_acct_sites_all    hcas
                                , apps.hz_cust_site_uses_all     hcsu
                            WHERE ooha.header_id                 = oola.header_id
                              AND oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND rctl.inventory_item_id         = oola.inventory_item_id
                              AND rctl.line_type                 = 'LINE'
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE1 = to_char(ooha.order_number)
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE6 = to_char(oola.line_id)
                              AND RCTL.INTERFACE_LINE_CONTEXT    = 'ORDER ENTRY'
                              AND rctl.customer_trx_id           = rcta.customer_trx_id
                              AND rcta.bill_to_site_use_id       = hcsu.site_use_id
                              AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                              AND hcas.cust_account_id           = hca.cust_account_id
                              AND hca.party_id                   = hp.party_id
                              AND ROWNUM = 1)
                     --
                     ELSE
                     --            
                     CASE WHEN 
                          ( SELECT DISTINCT RCTL.INTERFACE_LINE_CONTEXT
                             FROM apps.hz_parties                hp
                                , apps.hz_cust_accounts          hca
                                , apps.oe_order_lines_all        oola
                                , apps.oe_order_headers_all      ooha
                                , apps.ra_customer_trx_lines_all rctl
                                , apps.ra_customer_trx_all       rcta
                                , apps.hz_cust_acct_sites_all    hcas
                                , apps.hz_cust_site_uses_all     hcsu
                            WHERE ooha.header_id                 = oola.header_id
                              AND oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND rctl.inventory_item_id         = oola.inventory_item_id
                              AND rctl.line_type                 = 'LINE'
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE1 = ooha.ORIG_SYS_DOCUMENT_REF
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE7 = oola.ORIG_SYS_LINE_REF
                              AND RCTL.INTERFACE_LINE_CONTEXT    = 'GEMS_PB_RR'
                              AND rctl.customer_trx_id           = rcta.customer_trx_id
                              AND rcta.bill_to_site_use_id       = hcsu.site_use_id
                              AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                              AND hcas.cust_account_id           = hca.cust_account_id
                              AND ROWNUM = 1 ) = 'GEMS_PB_RR' THEN
                     --
                     (SELECT listagg(hp.party_name,', ' ON OVERFLOW TRUNCATE)  
                         WITHIN GROUP (ORDER BY hp.party_name asc)
                             FROM apps.hz_parties                hp
                                , apps.hz_cust_accounts          hca
                                , apps.oe_order_lines_all        oola
                                , apps.oe_order_headers_all      ooha
                                , apps.ra_customer_trx_lines_all rctl
                                , apps.ra_customer_trx_all       rcta
                                , apps.hz_cust_acct_sites_all    hcas
                                , apps.hz_cust_site_uses_all     hcsu
                            WHERE ooha.header_id                 = oola.header_id
                              AND oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND rctl.inventory_item_id         = oola.inventory_item_id
                              AND rctl.line_type                 = 'LINE'
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE1 = ooha.ORIG_SYS_DOCUMENT_REF
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE7 = oola.ORIG_SYS_LINE_REF
                              AND RCTL.INTERFACE_LINE_CONTEXT    = 'GEMS_PB_RR'
                              AND rctl.customer_trx_id           = rcta.customer_trx_id
                              AND rcta.bill_to_site_use_id       = hcsu.site_use_id
                              AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                              AND hcas.cust_account_id           = hca.cust_account_id 
                              AND ROWNUM = 1 )
                     --
                     ELSE
                     --
                     (SELECT listagg(hp.party_name,', ' ON OVERFLOW TRUNCATE)  
                         WITHIN GROUP (ORDER BY hp.party_name asc)
                      FROM   APPS.HZ_CUST_ACCT_SITES_ALL HCAS,
                             apps.hz_parties             hp,
                             apps.hz_cust_accounts       hca,
                             APPS.HZ_CUST_SITE_USES_ALL  HCSU,
                             APPS.OE_ORDER_LINES_ALL     OOLA,
                             APPS.OE_ORDER_HEADERS_ALL   OOHA
                             --
                      WHERE  HCSU.SITE_USE_CODE     = 'BILL_TO'
                      AND    HCSU.CUST_ACCT_SITE_ID = HCAS.CUST_ACCT_SITE_ID
                      AND    HCSU.SITE_USE_ID       = NVL(OOLA.ATTRIBUTE1, OOHA.INVOICE_TO_ORG_ID)
                      AND    OOLA.LINE_ID           = NVL(MMT.TRX_SOURCE_LINE_ID, MMT.SOURCE_LINE_ID)
                      AND    OOHA.HEADER_ID         = OOLA.HEADER_ID
                      AND    hcas.cust_account_id   = hca.cust_account_id
                      AND    hca.party_id           = hp.party_id 
                      AND    ROWNUM = 1)
                     --          
                     END
                  END
               END      bill_to_Customer_name
               --
                , CASE WHEN (mmt.source_code = '3PL_REMITTANCE_BRAZIL') THEN
                      (SELECT listagg(DECODE(hcas.global_attribute2
                                           , '2',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'/'|| hcas.global_attribute4 ||'-'|| hcas.global_attribute5
                                           , '1',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'-'|| hcas.global_attribute5 
                                           , '3',HCSU.LOCATION||' - '||hcas.global_attribute3 ),', ' ON OVERFLOW TRUNCATE)
                       WITHIN GROUP (ORDER BY hcas.global_attribute2 asc )
                         FROM apps.ra_customer_trx_all         rcta
                            , apps.hz_cust_acct_sites_all      hcas
                            , apps.hz_cust_site_uses_all       hcsu
                        WHERE rcta.interface_header_attribute1 = mp.organization_code||'_'||mmt.transaction_reference
                          AND rcta.ship_to_site_use_id         = hcsu.site_use_id
                          AND hcsu.cust_acct_site_id           = hcas.cust_acct_site_id
                          AND rcta.org_id                      = 4330
                          AND ROWNUM = 1)
                   ELSE
                     --
                     CASE WHEN (select DISTINCT RCTL.INTERFACE_LINE_CONTEXT
                             FROM apps.hz_parties                hp
                                , apps.hz_cust_accounts          hca
                                , apps.oe_order_lines_all        oola
                                , apps.oe_order_headers_all      ooha
                                , apps.ra_customer_trx_lines_all rctl
                                , apps.ra_customer_trx_all       rcta
                                , apps.hz_cust_acct_sites_all    hcas
                                , apps.hz_cust_site_uses_all     hcsu
                            WHERE ooha.header_id                 = oola.header_id
                              AND oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND rctl.inventory_item_id         = oola.inventory_item_id
                              AND rctl.line_type                 = 'LINE'
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE1 = to_char(ooha.order_number)
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE6 = to_char(oola.line_id)
                              AND RCTL.INTERFACE_LINE_CONTEXT    = 'ORDER ENTRY'
                              AND rctl.customer_trx_id           = rcta.customer_trx_id
                              AND rcta.ship_to_site_use_id       = hcsu.site_use_id
                              AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                              AND hcas.cust_account_id           = hca.cust_account_id
                              AND hca.party_id                   = hp.party_id 
                              AND ROWNUM = 1) = 'ORDER ENTRY' THEN
                     --
                     (SELECT DISTINCT DECODE(hcas.global_attribute2
                                           , '2',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'/'|| hcas.global_attribute4 ||'-'|| hcas.global_attribute5
                                           , '1',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'-'|| hcas.global_attribute5 
                                           , '3',HCSU.LOCATION||' - '||hcas.global_attribute3)
                             FROM apps.hz_parties                hp
                                , apps.hz_cust_accounts          hca
                                , apps.oe_order_lines_all        oola
                                , apps.oe_order_headers_all      ooha
                                , apps.ra_customer_trx_lines_all rctl
                                , apps.ra_customer_trx_all       rcta
                                , apps.hz_cust_acct_sites_all    hcas
                                , apps.hz_cust_site_uses_all     hcsu
                            WHERE ooha.header_id                 = oola.header_id
                              AND oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND rctl.inventory_item_id         = oola.inventory_item_id
                              AND rctl.line_type                 = 'LINE'
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE1 = to_char(ooha.order_number)
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE6 = to_char(oola.line_id)
                              AND RCTL.INTERFACE_LINE_CONTEXT    = 'ORDER ENTRY'
                              AND rctl.customer_trx_id           = rcta.customer_trx_id
                              AND rcta.ship_to_site_use_id       = hcsu.site_use_id
                              AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                              AND hcas.cust_account_id           = hca.cust_account_id
                              AND hca.party_id                   = hp.party_id
                              AND ROWNUM = 1)
                     --
                     ELSE
                     --            
                     CASE WHEN 
                          ( SELECT DISTINCT RCTL.INTERFACE_LINE_CONTEXT
                             FROM apps.hz_parties                hp
                                , apps.hz_cust_accounts          hca
                                , apps.oe_order_lines_all        oola
                                , apps.oe_order_headers_all      ooha
                                , apps.ra_customer_trx_lines_all rctl
                                , apps.ra_customer_trx_all       rcta
                                , apps.hz_cust_acct_sites_all    hcas
                                , apps.hz_cust_site_uses_all     hcsu
                            WHERE ooha.header_id                 = oola.header_id
                              AND oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND rctl.inventory_item_id         = oola.inventory_item_id
                              AND rctl.line_type                 = 'LINE'
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE1 = ooha.ORIG_SYS_DOCUMENT_REF
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE7 = oola.ORIG_SYS_LINE_REF
                              AND RCTL.INTERFACE_LINE_CONTEXT    = 'GEMS_PB_RR'
                              AND rctl.customer_trx_id           = rcta.customer_trx_id
                              AND rcta.ship_to_site_use_id       = hcsu.site_use_id
                              AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                              AND hcas.cust_account_id           = hca.cust_account_id
                              AND ROWNUM = 1 ) = 'GEMS_PB_RR' THEN
                     --
                     (SELECT DISTINCT DECODE(hcas.global_attribute2
                                           , '2',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'/'|| hcas.global_attribute4 ||'-'|| hcas.global_attribute5
                                           , '1',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'-'|| hcas.global_attribute5 
                                           , '3',HCSU.LOCATION||' - '||hcas.global_attribute3)
                             FROM apps.hz_parties                hp
                                , apps.hz_cust_accounts          hca
                                , apps.oe_order_lines_all        oola
                                , apps.oe_order_headers_all      ooha
                                , apps.ra_customer_trx_lines_all rctl
                                , apps.ra_customer_trx_all       rcta
                                , apps.hz_cust_acct_sites_all    hcas
                                , apps.hz_cust_site_uses_all     hcsu
                            WHERE ooha.header_id                 = oola.header_id
                              AND oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND rctl.inventory_item_id         = oola.inventory_item_id
                              AND rctl.line_type                 = 'LINE'
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE1 = ooha.ORIG_SYS_DOCUMENT_REF
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE7 = oola.ORIG_SYS_LINE_REF
                              AND RCTL.INTERFACE_LINE_CONTEXT    = 'GEMS_PB_RR'
                              AND rctl.customer_trx_id           = rcta.customer_trx_id
                              AND rcta.ship_to_site_use_id       = hcsu.site_use_id
                              AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                              AND hcas.cust_account_id           = hca.cust_account_id 
                              AND ROWNUM = 1 )
                     --
                     ELSE
                     --
                     (SELECT listagg(DECODE(hcas.global_attribute2
                                           , '2',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'/'|| hcas.global_attribute4 ||'-'|| hcas.global_attribute5
                                           , '1',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'-'|| hcas.global_attribute5 
                                           , '3',HCSU.LOCATION||' - '||hcas.global_attribute3 ),', ' ON OVERFLOW TRUNCATE)
                      WITHIN GROUP (ORDER BY hcas.global_attribute2 asc) 
                         FROM apps.hz_parties             hp
                            , apps.hz_cust_accounts       hca
                            , apps.oe_order_lines_all     oola
                            , apps.hz_cust_acct_sites_all hcas
                            , apps.hz_cust_site_uses_all  hcsu
                        WHERE oola.line_id                = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                          AND oola.ship_to_org_id         = hcsu.site_use_id
                          AND hcsu.cust_acct_site_id      = hcas.cust_acct_site_id
                          AND hcas.cust_account_id        = hca.cust_account_id
                          AND hca.party_id                = hp.party_id  )
                     --
                     END
                  END
               END      ship_to_CNPJ_CPF
               --
              , CASE WHEN ( SELECT ottl.name
                              FROM apps.oe_transaction_types_tl    ottl
                                 , apps.oe_order_headers_all  ooha
                                 , apps.oe_order_lines_all    oola  
                             WHERE oola.line_id        = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                               AND oola.header_id      = ooha.header_id
                               AND ooha.order_type_id  = ottl.transaction_type_id  ) = 'GPO_BR_FE_SHIPMENT' THEN
                      (SELECT listagg(hzl.address1 ||' - '|| hzl.address2 || ' - ' || hzl.city || '-' || hzl.state || ' / ' || hzl.postal_code,', ' ON OVERFLOW TRUNCATE)  
                       WITHIN GROUP (ORDER BY hzl.address1 asc)
                       FROM apps.hz_parties             hp
                        , apps.hz_party_sites         hps
                        , apps.hz_cust_accounts       hca
                        , apps.oe_order_lines_all     oola
                        , apps.hz_cust_acct_sites_all hcas
                        , apps.hz_cust_site_uses_all  hcsu
                        , apps.hz_locations           hzl
                    WHERE oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                      AND oola.end_customer_site_use_id  = hcsu.site_use_id
                      AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                      AND hcas.cust_account_id           = hca.cust_account_id
                      AND hcas.party_site_id             = hps.party_site_id
                      AND hca.party_id                   = hp.party_id
                      AND hps.party_id                   = hp.party_id
                      AND hps.location_id                = hzl.location_id)
                ELSE
                   CASE WHEN (mmt.source_code = '3PL_REMITTANCE_BRAZIL') THEN
                      (SELECT listagg(hzl.address1 ||' - '|| hzl.address2 || ' - ' || hzl.city || '-' || hzl.state || ' / ' || hzl.postal_code,', ' ON OVERFLOW TRUNCATE)  
                       WITHIN GROUP (ORDER BY hzl.address1 asc)
                         FROM apps.ra_customer_trx_all     rcta
                            , apps.hz_cust_acct_sites_all  hcas
                            , apps.hz_cust_site_uses_all   hcsu
                            , apps.hz_parties              hp
                            , apps.hz_party_sites          hps
                            , apps.hz_cust_accounts        hca
                            , apps.hz_locations            hzl
                        WHERE rcta.interface_header_attribute1 = mp.organization_code||'_'||mmt.transaction_reference
                          AND rcta.ship_to_site_use_id         = hcsu.site_use_id
                          AND hcsu.cust_acct_site_id           = hcas.cust_acct_site_id
                          AND hcas.cust_account_id             = hca.cust_account_id
                          AND hcas.party_site_id               = hps.party_site_id
                          AND hca.party_id                     = hp.party_id
                          AND hps.party_id                     = hp.party_id
                          AND hps.location_id                  = hzl.location_id
                          AND rcta.org_id                      = 4330)
                   ELSE
                      (SELECT listagg(hzl.address1 ||' - '|| hzl.address2 || ' - ' || hzl.city || '-' || hzl.state || ' / ' || hzl.postal_code,', ' ON OVERFLOW TRUNCATE)  
                       WITHIN GROUP (ORDER BY hzl.address1 asc)
                          FROM apps.hz_parties             hp
                             , apps.hz_party_sites         hps
                             , apps.hz_cust_accounts       hca
                             , apps.oe_order_lines_all     oola
                             , apps.hz_cust_acct_sites_all hcas
                             , apps.hz_cust_site_uses_all  hcsu
                             , apps.hz_locations           hzl
                         WHERE oola.line_id                = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                           AND oola.ship_to_org_id         = hcsu.site_use_id
                           AND hcsu.cust_acct_site_id      = hcas.cust_acct_site_id
                           AND hcas.cust_account_id        = hca.cust_account_id
                           AND hcas.party_site_id          = hps.party_site_id
                           AND hca.party_id                = hp.party_id
                           AND hps.party_id                = hp.party_id
                           AND hps.location_id             = hzl.location_id   )
                   END
                END customer_address
                -- 
                -- alterado para BIll_to por Sinval fim
                -- 
              , CASE WHEN (mmt.source_code = '3PL_REMITTANCE_BRAZIL') THEN
                   (SELECT listagg(rcta.trx_number,', ' ON OVERFLOW TRUNCATE)  
                           WITHIN GROUP (ORDER BY rcta.trx_number asc)
                      FROM apps.ra_customer_trx_all       rcta
                     WHERE rcta.interface_header_attribute1  = mp.organization_code||'_'||mmt.transaction_reference
                       AND rcta.org_id                       = 4330
                       AND NVL(rcta.status_trx,'XX')         <> 'VD'
                       AND NVL(rcta.reason_code,'XX')        <> 'CANCELLATION')
                ELSE
                   (SELECT distinct RTRIM(REGEXP_REPLACE((listagg(rcta.trx_number,', ' ON OVERFLOW TRUNCATE)  
                    WITHIN GROUP (ORDER BY rcta.trx_number asc) ), '([^,]*)(,\1)+($|,)', '\1\3'),',')
                      FROM apps.ra_customer_trx_lines_all rctla
                         , apps.ra_customer_trx_all       rcta
                         , apps.oe_order_lines_all        oola
                         , apps.oe_order_headers_all      ooha
                     WHERE rcta.customer_trx_id              = rctla.customer_trx_id
                       AND oola.line_id                      = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                       AND oola.header_id                    = ooha.header_id
                       AND rctla.sales_order                 = to_char(ooha.order_number)
                       AND rctla.line_type                   = 'LINE'
                       AND rcta.batch_source_id              <> 6266 -- No RR invoices
                       AND DECODE(rctla.interface_line_context,'GEMS_PB_RR',rcta.interface_header_attribute11,'999')
                           = DECODE(rctla.interface_line_context,'GEMS_PB_RR',rcta.interface_header_attribute11,'999')
                       AND rcta.org_id                       = 4330
                       AND trunc(rcta.trx_date)              BETWEEN (trunc(mmt.transaction_date)-3) AND (trunc(mmt.transaction_date)+3)
                       AND NVL(rcta.status_trx,'XX')         <> 'VD'
                       AND NVL(rcta.reason_code,'XX')        <> 'CANCELLATION')
                END   invoice_number_ar
              , ( SELECT listagg(mrav.reservation_quantity,', ' ON OVERFLOW TRUNCATE)  
                  WITHIN GROUP (ORDER BY mrav.reservation_quantity asc) 
                    FROM apps.mtl_reservations_all_v  mrav 
                       , apps.oe_order_headers_all    ooha1
                   WHERE mrav.demand_source_header_id     = ooha1.header_id
                     AND mrav.demand_source_line_id       = NVL(mmt.trx_source_line_id, mmt.source_line_id) )  reservation_quantity
              , ( SELECT listagg(ooha1.order_number,', ' ON OVERFLOW TRUNCATE)  
                  WITHIN GROUP (ORDER BY ooha1.order_number asc) 
                    FROM apps.mtl_reservations_all_v  mrav 
                       , apps.oe_order_headers_all    ooha1
                   WHERE mrav.demand_source_header_id     = ooha1.header_id
                     AND mrav.demand_source_line_id       = NVL(mmt.trx_source_line_id, mmt.source_line_id) )  reservation_order_number
              , (SELECT distinct hp.party_name
                 --WITHIN GROUP (ORDER BY hp.party_name asc)
                   FROM apps.hz_parties              hp
                      , apps.hz_cust_accounts        hca
                      , apps.oe_order_lines_all      oola1
                      , apps.oe_order_headers_all    ooha1
                      , apps.mtl_reservations_all_v  mrav 
                  WHERE mrav.demand_source_header_id   = ooha1.header_id
                    AND mrav.demand_source_line_id     = oola1.line_id
                    AND oola1.line_id                  = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                    AND oola1.ship_to_org_id           = hca.cust_account_id
                    AND hca.party_id                   = hp.party_id )         reservation_customer_name
              , gcc1.concatenated_segments   material_account
              , gcc2.concatenated_segments   outside_processing_account
              , gcc3.concatenated_segments   material_overhead_account
              , gcc4.concatenated_segments   overhead_account
              , gcc5.concatenated_segments   resource_account
              , sysdate                                           report_date_and_time 
              , to_char(mmt.transaction_id)  transaction_id
              , fu.user_name ||' / '|| fu.description                                    user_name
              , DECODE( lot_control_code, 1 ,'Sem controle de Lote' , 2,'Com controle de Lote')   lot_control
              , DECODE( serial_number_control_code, 1, 'Sem controle de Serial'
                                                  , 2, 'Pre-definido'
                                                  , 5, 'No Recebimento'
                                                  , 6, 'Baixa na Ordem de Venda' )  serial_control
              , CASE
                 WHEN    nvl(mmt.lpn_id, mmt.content_lpn_id) IS NULL AND moq.subinventory_code <> 'WHGU42GNAT'
                   THEN 
                     (SELECT listagg(lpn.license_plate_number,', ' ON OVERFLOW TRUNCATE)WITHIN GROUP (ORDER BY lpn.license_plate_number asc)
                             FROM apps.MTL_MATERIAL_TRANSACTIONS   mtt,
                                  apps.wms_license_plate_numbers   lpn,
                                  apps.oe_order_lines_all          ool
                            WHERE 1 = 1
                              AND mtt.TRX_SOURCE_LINE_ID = CASE
                                                              WHEN LINE_CATEGORY_CODE = 'ORDER'
                                                                THEN ool.line_id
                                                              WHEN LINE_CATEGORY_CODE = 'RETURN'  
                                                                THEN   
                                                                to_number(NVL(SUBSTR(ool.ORIG_SYS_LINE_REF,
                                                                                     0,
                                                                                     INSTR(ool.ORIG_SYS_LINE_REF, '.') - 1),
                                                                              -1)) -- RMA FE OE Line Id
                                                                ELSE -1
                                                                  END
                              AND mtt.TRANSACTION_TYPE_ID = 52 --sales order pick FE ORDER
                              AND mtt.transaction_quantity < 0
                              AND mtt.inventory_item_id = ool.inventory_item_id
                              AND nvl(mtt.lpn_id, mtt.content_lpn_id) = nvl(lpn.lpn_id, -1)
                              AND ool.line_id = CASE
                                                  WHEN mtt.transaction_type_name = 'RMA Receipt'
                                                    THEN mmt.TRX_SOURCE_LINE_ID
                                                  WHEN mtt.transaction_type_name = 'GPO Nationalization Receipt'
                                                     THEN 
                                                      to_number(NVL(SUBSTR(RTRIM(LTRIM(translate(mmt.TRANSACTION_REFERENCE,translate(mmt.TRANSACTION_REFERENCE||'a','1234567890.',' '),' '))),
                                                         0,
                                                         INSTR(RTRIM(LTRIM(translate(mmt.TRANSACTION_REFERENCE,translate(mmt.TRANSACTION_REFERENCE||'a','1234567890.',' '),' '))), '.') - 1),
                                                  -1))
                                                  ELSE -1
                                                    END)
                WHEN moq.subinventory_code = 'WHGU42GNAT'
                  THEN (SELECT listagg(wlp.license_plate_number,', ' ON OVERFLOW TRUNCATE)  
                            WITHIN GROUP (ORDER BY wlp.license_plate_number asc)
                        FROM   gems_ont.ge_gpo_nationalization_line gnl, 
                               gems_ont.ge_gpo_nationalization_line gn2,
                               apps.wms_license_plate_numbers       wlp,
                               apps.po_line_locations_all           pll,
                               apps.po_lines_all                    pol,
                               apps.po_headers_all                  poh,
                               apps.rcv_shipment_headers            rsh,
                               apps.rcv_transactions                rt
                        Where  wlp.lpn_id(+) = gn2.lpn_id
                        AND gnl.nationalization_so_line_id = gn2.nationalization_so_line_id
                        AND pll.line_location_id = gnl.DOCUMENT_ID
                        AND pll.po_header_id = poh.po_header_id
                        AND pll.po_line_id = pol.po_line_id
                        AND gn2.record_type = 'IMPORT'
                        AND gnl.record_type = 'NATIONALIZATION'
                        AND rt.transaction_id                = mmt.rcv_transaction_id
                        AND rt.po_line_location_id           = pll.line_location_id
                        AND rt.shipment_header_id            = rsh.shipment_header_id)
                ELSE (SELECT lpn.LICENSE_PLATE_NUMBER
                           FROM   apps.wms_license_plate_numbers   lpn
                           WHERE  nvl(mmt.lpn_id, mmt.content_lpn_id) = nvl(lpn.lpn_id, -1))
                        END LPN_Value                                    
             , 'q15' query
--, mmt.transaction_type_id
--, mmt.trx_source_line_id
--, mmt.source_line_id
           FROM apps.mtl_serial_numbers              msn
              , apps.mtl_parameters                  mp
              , apps.mtl_system_items_b              msi
              , apps.mtl_secondary_inventories_fk_v  msifv
              , apps.gl_code_combinations            gcc
              , apps.gl_code_combinations_kfv        gcc1
              , apps.gl_code_combinations_kfv        gcc2
              , apps.gl_code_combinations_kfv        gcc3
              , apps.gl_code_combinations_kfv        gcc4
              , apps.gl_code_combinations_kfv        gcc5
              --, apps.mtl_item_locations_kfv          milk
              , apps.mtl_material_transactions       mmt
              , apps.mtl_transaction_types           mtt
              , apps.mtl_txn_source_types            mtst
              , apps.fnd_flex_values_vl              ffvv
              , apps.fnd_flex_value_sets             ffvs
              , apps.fnd_user                        fu
              , ( SELECT organization_id
                       , inventory_item_id
                       , subinventory_code
                       , locator_id
                       --, lot_number
                       --, transaction_uom_code
                       --, update_transaction_id
                       , SUM (primary_transaction_quantity) onhand_qty
                    FROM apps.mtl_onhand_quantities_detail
                   WHERE organization_id IN (SELECT ood.organization_id FROM apps.org_organization_definitions ood WHERE ood.set_of_books_id = 230 )
                   GROUP BY organization_id
                          , inventory_item_id
                          , subinventory_code
                          , locator_id
                       --   , revision
                          --, lot_number
                          --, transaction_uom_code
                          --, update_transaction_id 
                          ) moq
                          ,APPS.MTL_PAC_ACTUAL_COST_DETAILS MPACD 
          WHERE 1                                = 1
          AND decode(mmt.periodic_primary_quantity,null,mmt.transfer_transaction_id,MMT.TRANSACTION_ID) = MPACD.TRANSACTION_ID  
            AND mp.organization_id               = msi.organization_id
--            AND msi.segment1 = '60510302'
            AND msifv.organization_id            = msi.organization_id
            AND msifv.secondary_inventory_name   = moq.subinventory_code
            AND msifv.material_account           = gcc1.code_combination_id
            AND msifv.outside_processing_account = gcc2.code_combination_id
            AND msifv.material_overhead_account  = gcc3.code_combination_id
            AND msifv.overhead_account           = gcc4.code_combination_id
            AND msifv.resource_account           = gcc5.code_combination_id
            AND msi.cost_of_sales_account       = gcc.code_combination_id
            AND ffvs.flex_value_set_name        = 'GE_GL_AFF_ES_PRODUCT_LINE'
            AND ffvs.flex_value_set_id          = ffvv.flex_value_set_id
            AND ffvv.flex_value_meaning         = gcc.segment8
            AND 'TYPE 1'                        IN ('TYPE 1')
            AND msi.organization_id             IN (SELECT ood.organization_id FROM apps.org_organization_definitions ood WHERE ood.set_of_books_id = 230 )
            AND moq.inventory_item_id            = msn.inventory_item_id         (+) 
            AND moq.organization_id              = msn.current_organization_id   (+) 
            AND moq.subinventory_code            = msn.current_subinventory_code (+) 
            --AND moq.locator_id                   = msn.current_locator_id        (+) 
            AND msn.current_status           (+) = 3   
            AND moq.inventory_item_id           = msi.inventory_item_id
            AND moq.organization_id             = msi.organization_id
            --AND moq.locator_id                  = milk.inventory_location_id
            AND msn.last_transaction_id         = mmt.transaction_id(+)
--    AND MMT.TRANSACTION_ID = 2562828197
            AND mtt.transaction_type_id         = mmt.transaction_type_id 
            AND mtst.transaction_source_type_id = mmt.transaction_source_type_id
            AND msi.serial_number_control_code  <> '1' 
            AND msi.lot_control_code            = '1'  --Sem controle de Lote
            AND moq.locator_id                 IS NULL  ------------- Ajustado para n?conflitar com a query 11 e 12 - Sinval 17/02
            AND fu.user_id                      = mmt.created_by
    AND MMT.TRANSACTION_ID NOT IN(SELECT MMT2.TRANSACTION_ID 
                                  FROM AMARCHIVE.MTL_MATERIAL_TRANSACTIONS  MMT2
                                  WHERE MMT2.TRANSACTION_ID = MMT.TRANSACTION_ID)
------------------------------------------------------------------------------
UNION  
------------------------------------------------------------------------------  
-- Com Controle de Serial e Sem Controle de Lote e sem Locator ---- AMARCHIVE.MTL_MATERIAL_TRANSACTIONS
         SELECT DISTINCT  --'16' NUM
        /* ( SELECT ccg.cost_group 
                             FROM apps.cst_cost_groups            ccg
                                , apps.cst_cost_group_assignments ccga
                            WHERE ccga.cost_group_id     = ccg.cost_group_id
                              AND ccga.organization_id   = mp.organization_id )  cost_group*/
            ( SELECT ccg.cost_group 
                             FROM apps.cst_cost_groups            ccg
                            WHERE MPACD.cost_group_id     = ccg.cost_group_id )  cost_group  
              , ( SELECT ( SELECT cpp1.period_name 
                             FROM apps.cst_pac_item_costs   cst
                                , apps.cst_pac_periods      cpp1
                            WHERE cst.pac_period_id     = (SELECT MAX(PAC_PERIOD_ID)                   FROM APPS.CST_PAC_PERIODS                  WHERE LEGAL_ENTITY = (SELECT LEGAL_ENTITY                                          FROM APPS.ORG_ORGANIZATION_DEFINITIONS OOD                                         WHERE OOD.ORGANIZATION_ID = mp.organization_id                                         ) )
                              AND cst.pac_period_id     = cpp1.pac_period_id
                              AND cst.inventory_item_id = msi.inventory_item_id
                              AND cst.cost_group_id     = ccg.cost_group_id )  
                    FROM apps.cst_cost_groups            ccg
                       , apps.cst_cost_group_assignments ccga
                   WHERE ccga.cost_group_id     = ccg.cost_group_id
                     AND ccga.organization_id   = mp.organization_id ) period_name
              , mp.organization_code
              , mp.attribute7                organization_type
              , mp.organization_id 
              , moq.subinventory_code
              , msifv.description            subinv_description
              , NULL locators  --, milk.concatenated_segments   locators
              , DECODE( msifv.asset_inventory, 1 , 'Asset', 2, 'Non Asset')   asset_type
              , msi.segment1                 part_number
              , DECODE(msi.inventory_asset_flag, NULL, 'No', 'N', 'No', 'Y', 'Yes')                         flag_asset_inventory
              , DECODE(msi.costing_enabled_flag, NULL, 'No', 'N', 'No', 'Y', 'Yes')                         flag_de_custo
              , msi.description              descrip_eng
              , msi.attribute3               descrip_ptb
              , msi.creation_date            item_creation_date
              , (trunc(SYSDATE) - trunc(msi.creation_date))      days_from_creation
              , gcc.segment8                                     product_line
              , ffvv.description                                 desc_prod_line   
              , msi.primary_uom_code    uom
              , DECODE (msi.serial_number_control_code, 1, moq.onhand_qty, 1)    transaction_quantity
              , NVL(( SELECT cic.item_cost
                        FROM apps.cst_item_costs cic
                       WHERE cic.organization_id   = msi.organization_id
                         AND cic.inventory_item_id = msi.inventory_item_id
                         AND cic.cost_type_id      = 1 ),0)  custo_unit_inv
               /*, nvl(( SELECT ( SELECT ROUND (cst.item_cost,2) 
                                 FROM apps.cst_pac_item_costs   cst
                                WHERE cst.pac_period_id     = (SELECT MAX(PAC_PERIOD_ID)                   FROM APPS.CST_PAC_PERIODS                  WHERE LEGAL_ENTITY = (SELECT LEGAL_ENTITY                                          FROM APPS.ORG_ORGANIZATION_DEFINITIONS OOD                                         WHERE OOD.ORGANIZATION_ID = mp.organization_id                                         ) )
                                  AND cst.inventory_item_id = msi.inventory_item_id
                                  AND cst.cost_group_id     = ccg.cost_group_id )  item_cost
                        FROM apps.cst_cost_groups            ccg
                           , apps.cst_cost_group_assignments ccga
                       WHERE ccga.cost_group_id     = ccg.cost_group_id
                         AND ccga.organization_id   = mp.organization_id ) ,0) custo_unit_pac*/
                , nvl((SELECT ROUND (cst.item_cost,2) 
                       FROM apps.cst_pac_item_costs   cst
                      WHERE cst.pac_period_id     = (SELECT MAX(PAC_PERIOD_ID)                   
                                                                FROM APPS.CST_PAC_PERIODS                  
                                                                WHERE LEGAL_ENTITY = (SELECT LEGAL_ENTITY                                         
                                                                                        FROM APPS.ORG_ORGANIZATION_DEFINITIONS OOD                                        
                                                                                        WHERE OOD.ORGANIZATION_ID = mp.organization_id
                                                        ) )
                        AND cst.inventory_item_id = msi.inventory_item_id
                        AND cst.cost_group_id     = MPACD.cost_group_id) ,0)  custo_unit_pac

              , NULL  lot_number
              , NULL  lot_creation_date
              , NULL  lot_qty_days_creation
              , NULL  lot_expiration_date
              , msn.serial_number
              , msn.creation_date   serial_creation_date
              , mtt.transaction_type_name           last_transaction_type
              , mmt.transaction_source_name         last_transaction_source
              , mtst.transaction_source_type_name   last_source_type
              , mmt.source_code
              , TO_CHAR(mmt.transaction_date, 'DD-MON-RRRR')      transaction_date
        , (SELECT TO_CHAR(mmt1.transaction_date, 'DD-MON-RRRR') 
                        FROM apps.mtl_material_transactions mmt1
                        WHERE mmt1.transaction_type_id=420
                        AND mmt1.source_line_id=mmt.source_line_id) initial_consignment_date
              , (TRUNC ( SYSDATE )- TRUNC(mmt.transaction_date))  transaction_qty_of_days
              , TO_CHAR(mmt.transaction_reference)                transaction_reference
              , CASE WHEN mmt.source_code = '3PL_REMITTANCE_BRAZIL' THEN
                     (SELECT listagg(pha.segment1,', ' ON OVERFLOW TRUNCATE)  
                      WITHIN GROUP (ORDER BY pha.segment1 asc)
                        FROM apps.po_headers_all        pha,
                             apps.po_lines_all          pla
                       WHERE pla.po_line_id   = mmt.source_line_id
                         AND pla.po_header_id = pha.po_header_id)
                     WHEN mmt.source_code IN ('ORDER ENTRY','IIP') THEN
                        NULL
                     WHEN mmt.source_code = 'RCV' THEN
                        ( SELECT listagg(pha.segment1,', ' ON OVERFLOW TRUNCATE)  
                          WITHIN GROUP (ORDER BY pha.segment1 asc)
                            FROM apps.po_headers_all            pha
                               , apps.po_lines_all              pla
                               , apps.po_line_locations_all     plla
                               , apps.rcv_shipment_headers      rsh
                               , apps.rcv_transactions          rt
                           WHERE rt.transaction_id                = mmt.rcv_transaction_id
                             AND rt.po_line_location_id           = plla.line_location_id
                             AND plla.po_line_id                  = pla.po_line_id
                             AND pha.po_header_id                 = pla.po_header_id
                             AND rt.shipment_header_id            = rsh.shipment_header_id
                             AND rsh.receipt_source_code          = 'VENDOR'  )
                     ELSE
                        NULL
                END      po_number
              , CASE WHEN mmt.source_code = '3PL_REMITTANCE_BRAZIL' THEN
                     (SELECT listagg(aps.vendor_name,', ' ON OVERFLOW TRUNCATE)  
                      WITHIN GROUP (ORDER BY aps.vendor_name asc)
                        FROM apps.po_headers_all        pha
                           , apps.po_lines_all          pla
                           , apps.ap_suppliers          aps
                           , apps.ap_supplier_sites_all  apss
                       WHERE pla.po_line_id     = mmt.source_line_id
                         AND pla.po_header_id   = pha.po_header_id
                         AND pha.vendor_id      = aps.vendor_id
                         AND aps.vendor_id      = apss.vendor_id
                         AND pha.vendor_site_id = apss.vendor_site_id )
                     WHEN mmt.source_code IN ('ORDER ENTRY','IIP') THEN
                        NULL
                     WHEN mmt.source_code = 'RCV' THEN
                        ( SELECT listagg(aps.vendor_name,', ' ON OVERFLOW TRUNCATE)  
                          WITHIN GROUP (ORDER BY aps.vendor_name asc)
                            FROM apps.po_headers_all            pha
                               , apps.po_lines_all              pla
                               , apps.po_line_locations_all     plla
                               , apps.rcv_shipment_headers      rsh
                               , apps.rcv_transactions          rt
                               , apps.ap_suppliers              aps
                               , apps.ap_supplier_sites_all     apss
                           WHERE rt.transaction_id          = mmt.rcv_transaction_id
                             AND rt.po_line_location_id     = plla.line_location_id
                             AND plla.po_line_id            = pla.po_line_id
                             AND pha.po_header_id           = pla.po_header_id
                             AND rt.shipment_header_id      = rsh.shipment_header_id
                             AND rsh.receipt_source_code    = 'VENDOR'
                             AND pha.vendor_id              = aps.vendor_id
                             AND aps.vendor_id              = apss.vendor_id
                             AND pha.vendor_site_id         = apss.vendor_site_id  )
                     ELSE
                        NULL
                END     po_supplier
              , CASE WHEN mmt.source_code = '3PL_REMITTANCE_BRAZIL' THEN
                     ( SELECT listagg(cfi.invoice_num,', ' ON OVERFLOW TRUNCATE)  
                         WITHIN GROUP (ORDER BY cfi.invoice_num asc)
                         FROM apps.cll_f189_invoice_lines cfil
                            , apps.cll_f189_invoices      cfi
                            , apps.po_lines_all           pla
                            , apps.po_line_locations_all  plla
                        WHERE plla.po_line_id       = pla.po_line_id
                          AND pla.po_line_id        = mmt.source_line_id
                          AND plla.line_location_id = cfil.line_location_id
                          AND cfil.invoice_id       = cfi.invoice_id )
                     WHEN mmt.source_code IN ('ORDER ENTRY','IIP') THEN
                        NULL
                     WHEN mmt.source_code = 'RCV' THEN
                        ( SELECT listagg(cfi.invoice_num,', ' ON OVERFLOW TRUNCATE)  
                            WITHIN GROUP (ORDER BY cfi.invoice_num asc)
                            FROM apps.po_headers_all            pha
                               , apps.po_lines_all              pla
                               , apps.po_line_locations_all     plla
                               , apps.cll_f189_invoice_lines    cfil
                               , apps.cll_f189_invoices         cfi
                               , apps.rcv_shipment_headers      rsh
                               , apps.rcv_transactions          rt
                           WHERE rt.transaction_id          = mmt.rcv_transaction_id
                             AND rt.po_line_location_id     = plla.line_location_id
                             AND plla.line_location_id      = cfil.line_location_id
                             AND cfil.invoice_id            = cfi.invoice_id
                             AND plla.po_line_id            = pla.po_line_id
                             AND pha.po_header_id           = pla.po_header_id
                             AND rt.shipment_header_id      = rsh.shipment_header_id
                             AND rsh.receipt_source_code    = 'VENDOR'   )
                     ELSE
                        NULL
                END    NF_RI
             , (SELECT DECODE( mmt.source_code, '3PL_REMITTANCE_BRAZIL',NULL,to_char(ooha.order_number) )
                  FROM apps.oe_order_headers_all  ooha,
                       apps.oe_order_lines_all    oola  
                 WHERE oola.line_id        = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                   AND oola.header_id      = ooha.header_id )   order_number
               -- 
               -- alterado para BIll_to por Sinval inicio
               --
               , CASE WHEN ( SELECT ottl.name
                             FROM apps.oe_transaction_types_tl    ottl
                                , apps.oe_order_headers_all  ooha
                                , apps.oe_order_lines_all    oola  
                            WHERE oola.line_id        = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND oola.header_id      = ooha.header_id
                              AND ooha.order_type_id  = ottl.transaction_type_id  ) = 'GPO_BR_FE_SHIPMENT' THEN
                     (SELECT listagg(hp.party_name,', ' ON OVERFLOW TRUNCATE)  
                      WITHIN GROUP (ORDER BY hp.party_name asc)
                        FROM apps.hz_parties             hp
                           , apps.hz_cust_accounts       hca
                           , apps.oe_order_lines_all     oola
                           , apps.hz_cust_acct_sites_all hcas
                           , apps.hz_cust_site_uses_all  hcsu
                       WHERE oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                         AND oola.end_customer_site_use_id  = hcsu.site_use_id
                         AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                         AND hcas.cust_account_id           = hca.cust_account_id
                         AND hca.party_id                   = hp.party_id )
                  ELSE
                     CASE WHEN (mmt.source_code = '3PL_REMITTANCE_BRAZIL') THEN
                       (SELECT listagg(hp.party_name,', ' ON OVERFLOW TRUNCATE)  
                        WITHIN GROUP (ORDER BY hp.party_name asc)
                          FROM apps.hz_parties             hp,
                               apps.hz_cust_accounts       hca,
                               apps.ra_customer_trx_all    rcta,
                               apps.hz_cust_acct_sites_all hcas,
                               apps.hz_cust_site_uses_all  hcsu
                         WHERE rcta.interface_header_attribute1 = mp.organization_code||'_'||mmt.transaction_reference
                           AND rcta.ship_to_site_use_id         = hcsu.site_use_id
                           AND hcsu.cust_acct_site_id           = hcas.cust_acct_site_id
                           AND hcas.cust_account_id             = hca.cust_account_id
                           AND hca.party_id                     = hp.party_id
                           AND rcta.org_id                      = 4330)
                     ELSE
                        (SELECT listagg(hp.party_name,', ' ON OVERFLOW TRUNCATE)  
                         WITHIN GROUP (ORDER BY hp.party_name asc)
                           FROM apps.hz_parties             hp
                              , apps.hz_cust_accounts       hca
                              , apps.oe_order_lines_all     oola
                              , apps.hz_cust_acct_sites_all hcas
                              , apps.hz_cust_site_uses_all  hcsu
                          WHERE oola.line_id                = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                            AND oola.ship_to_org_id         = hcsu.site_use_id
                            AND hcsu.cust_acct_site_id      = hcas.cust_acct_site_id
                            AND hcas.cust_account_id        = hca.cust_account_id
                            AND hca.party_id                = hp.party_id )
                    END                 
               END    customer_name
             , CASE WHEN ( SELECT ottl.name
                             FROM apps.oe_transaction_types_tl    ottl
                                , apps.oe_order_headers_all  ooha
                                , apps.oe_order_lines_all    oola  
                            WHERE oola.line_id        = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND oola.header_id      = ooha.header_id
                              AND ooha.order_type_id  = ottl.transaction_type_id  ) = 'GPO_BR_FE_SHIPMENT' THEN
                     (SELECT listagg(hca.account_number,', ' ON OVERFLOW TRUNCATE)  
                      WITHIN GROUP (ORDER BY hca.account_number asc)
                        FROM apps.hz_parties             hp
                           , apps.hz_cust_accounts       hca
                           , apps.oe_order_lines_all     oola
                           , apps.hz_cust_acct_sites_all hcas
                           , apps.hz_cust_site_uses_all  hcsu
                       WHERE oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                         AND oola.end_customer_site_use_id  = hcsu.site_use_id
                         AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                         AND hcas.cust_account_id           = hca.cust_account_id
                         AND hca.party_id                   = hp.party_id )
                  ELSE
                     CASE WHEN (mmt.source_code = '3PL_REMITTANCE_BRAZIL') THEN
                        (SELECT listagg(hca.account_number,', ' ON OVERFLOW TRUNCATE)  
                         WITHIN GROUP (ORDER BY hca.account_number asc)
                           FROM apps.hz_parties             hp,
                                apps.hz_cust_accounts       hca,
                                apps.ra_customer_trx_all    rcta,
                                apps.hz_cust_acct_sites_all hcas,
                                apps.hz_cust_site_uses_all  hcsu
                          WHERE rcta.interface_header_attribute1 = mp.organization_code||'_'||mmt.transaction_reference
                            AND rcta.ship_to_site_use_id         = hcsu.site_use_id
                            AND hcsu.cust_acct_site_id           = hcas.cust_acct_site_id
                            AND hcas.cust_account_id             = hca.cust_account_id
                            AND hca.party_id                     = hp.party_id
                            AND rcta.org_id                      = 4330)
                     ELSE
                        (SELECT listagg(hca.account_number,', ' ON OVERFLOW TRUNCATE)  
                         WITHIN GROUP (ORDER BY hca.account_number asc)
                           FROM apps.hz_parties             hp
                              , apps.hz_cust_accounts       hca
                              , apps.oe_order_lines_all     oola
                              , apps.hz_cust_acct_sites_all hcas
                              , apps.hz_cust_site_uses_all  hcsu
                          WHERE oola.line_id                = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                            AND oola.ship_to_org_id         = hcsu.site_use_id
                            AND hcsu.cust_acct_site_id      = hcas.cust_acct_site_id
                            AND hcas.cust_account_id        = hca.cust_account_id
                            AND hca.party_id                = hp.party_id   )
                     END
                  END   customer_number
              --
              , CASE WHEN ( SELECT ottl.name
                             FROM apps.oe_transaction_types_tl    ottl
                                , apps.oe_order_headers_all  ooha
                                , apps.oe_order_lines_all    oola  
                            WHERE oola.line_id        = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                             AND oola.header_id      = ooha.header_id
                              AND ooha.order_type_id  = ottl.transaction_type_id  ) = 'GPO_BR_FE_SHIPMENT' THEN
                     (SELECT listagg(DECODE(hcas.global_attribute2
                                           , '2',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'/'|| hcas.global_attribute4 ||'-'|| hcas.global_attribute5
                                           , '1',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'-'|| hcas.global_attribute5 
                                           , '3',HCSU.LOCATION||' - '||hcas.global_attribute3 ),', ' ON OVERFLOW TRUNCATE)
                     WITHIN GROUP (ORDER BY hcas.global_attribute2 asc ) 
                        FROM apps.hz_parties             hp
                           , apps.hz_cust_accounts       hca
                           , apps.oe_order_lines_all     oola
                           , apps.hz_cust_acct_sites_all hcas
                           , apps.hz_cust_site_uses_all  hcsu
                       WHERE oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                         AND oola.end_customer_site_use_id  = hcsu.site_use_id
                         AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                         AND hcas.cust_account_id           = hca.cust_account_id
                         AND hca.party_id                   = hp.party_id )
                ELSE
                   CASE WHEN (mmt.source_code = '3PL_REMITTANCE_BRAZIL') THEN
                      (SELECT listagg(DECODE(hcas.global_attribute2
                                           , '2',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'/'|| hcas.global_attribute4 ||'-'|| hcas.global_attribute5
                                           , '1',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'-'|| hcas.global_attribute5 
                                           , '3',HCSU.LOCATION||' - '||hcas.global_attribute3 ),', ' ON OVERFLOW TRUNCATE)
                     WITHIN GROUP (ORDER BY hcas.global_attribute2 asc) 
                         FROM apps.ra_customer_trx_all     rcta
                            , apps.hz_cust_acct_sites_all  hcas
                            , apps.hz_cust_site_uses_all   hcsu
                        WHERE rcta.interface_header_attribute1 = mp.organization_code||'_'||mmt.transaction_reference
                          AND rcta.ship_to_site_use_id         = hcsu.site_use_id
                          AND hcsu.cust_acct_site_id           = hcas.cust_acct_site_id
                          AND rcta.org_id                      = 4330)
                   ELSE
                      (SELECT listagg(DECODE(hcas.global_attribute2
                                           , '2',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'/'|| hcas.global_attribute4 ||'-'|| hcas.global_attribute5
                                           , '1',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'-'|| hcas.global_attribute5 
                                           , '3',HCSU.LOCATION||' - '||hcas.global_attribute3 ),', ' ON OVERFLOW TRUNCATE)
                      WITHIN GROUP (ORDER BY hcas.global_attribute2 asc) 
                         FROM apps.hz_parties             hp
                            , apps.hz_cust_accounts       hca
                            , apps.oe_order_lines_all     oola
                            , apps.hz_cust_acct_sites_all hcas
                            , apps.hz_cust_site_uses_all  hcsu
                        WHERE oola.line_id                = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                          AND oola.ship_to_org_id         = hcsu.site_use_id
                          AND hcsu.cust_acct_site_id      = hcas.cust_acct_site_id
                          AND hcas.cust_account_id        = hca.cust_account_id
                          AND hca.party_id                = hp.party_id  )
                   END
                END  customer_cnpj_cpf
               -- 
              , CASE WHEN (mmt.source_code = '3PL_REMITTANCE_BRAZIL') THEN
                      (SELECT listagg(DECODE(hcas.global_attribute2
                                           , '2',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'/'|| hcas.global_attribute4 ||'-'|| hcas.global_attribute5
                                           , '1',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'-'|| hcas.global_attribute5 
                                           , '3',HCSU.LOCATION||' - '||hcas.global_attribute3 ),', ' ON OVERFLOW TRUNCATE)
                       WITHIN GROUP (ORDER BY hcas.global_attribute2 asc )
                         FROM apps.ra_customer_trx_all         rcta
                            , apps.hz_cust_acct_sites_all      hcas
                            , apps.hz_cust_site_uses_all       hcsu
                        WHERE rcta.interface_header_attribute1 = mp.organization_code||'_'||mmt.transaction_reference
                          AND rcta.bill_to_site_use_id         = hcsu.site_use_id
                          AND hcsu.cust_acct_site_id           = hcas.cust_acct_site_id
                          AND rcta.org_id                      = 4330
                          AND ROWNUM = 1)
                   ELSE
                     --
                     CASE WHEN (select DISTINCT RCTL.INTERFACE_LINE_CONTEXT
                             FROM apps.hz_parties                hp
                                , apps.hz_cust_accounts          hca
                                , apps.oe_order_lines_all        oola
                                , apps.oe_order_headers_all      ooha
                                , apps.ra_customer_trx_lines_all rctl
                                , apps.ra_customer_trx_all       rcta
                                , apps.hz_cust_acct_sites_all    hcas
                                , apps.hz_cust_site_uses_all     hcsu
                            WHERE ooha.header_id                 = oola.header_id
                              AND oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND rctl.inventory_item_id         = oola.inventory_item_id
                              AND rctl.line_type                 = 'LINE'
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE1 = to_char(ooha.order_number)
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE6 = to_char(oola.line_id)
                              AND RCTL.INTERFACE_LINE_CONTEXT    = 'ORDER ENTRY'
                              AND rctl.customer_trx_id           = rcta.customer_trx_id
                              AND rcta.bill_to_site_use_id       = hcsu.site_use_id
                              AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                              AND hcas.cust_account_id           = hca.cust_account_id
                              AND hca.party_id                   = hp.party_id 
                              AND ROWNUM = 1) = 'ORDER ENTRY' THEN
                     --
                     (SELECT DISTINCT DECODE(hcas.global_attribute2
                                           , '2',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'/'|| hcas.global_attribute4 ||'-'|| hcas.global_attribute5
                                           , '1',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'-'|| hcas.global_attribute5 
                                           , '3',HCSU.LOCATION||' - '||hcas.global_attribute3)
                             FROM apps.hz_parties                hp
                                , apps.hz_cust_accounts          hca
                                , apps.oe_order_lines_all        oola
                                , apps.oe_order_headers_all      ooha
                                , apps.ra_customer_trx_lines_all rctl
                                , apps.ra_customer_trx_all       rcta
                                , apps.hz_cust_acct_sites_all    hcas
                                , apps.hz_cust_site_uses_all     hcsu
                            WHERE ooha.header_id                 = oola.header_id
                              AND oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND rctl.inventory_item_id         = oola.inventory_item_id
                              AND rctl.line_type                 = 'LINE'
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE1 = to_char(ooha.order_number)
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE6 = to_char(oola.line_id)
                              AND RCTL.INTERFACE_LINE_CONTEXT    = 'ORDER ENTRY'
                              AND rctl.customer_trx_id           = rcta.customer_trx_id
                              AND rcta.bill_to_site_use_id       = hcsu.site_use_id
                              AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                              AND hcas.cust_account_id           = hca.cust_account_id
                              AND hca.party_id                   = hp.party_id
                              AND ROWNUM = 1)
                     --
                     ELSE
                     --            
                     CASE WHEN 
                          ( SELECT DISTINCT RCTL.INTERFACE_LINE_CONTEXT
                             FROM apps.hz_parties                hp
                                , apps.hz_cust_accounts          hca
                                , apps.oe_order_lines_all        oola
                                , apps.oe_order_headers_all      ooha
                                , apps.ra_customer_trx_lines_all rctl
                                , apps.ra_customer_trx_all       rcta
                                , apps.hz_cust_acct_sites_all    hcas
                                , apps.hz_cust_site_uses_all     hcsu
                            WHERE ooha.header_id                 = oola.header_id
                              AND oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND rctl.inventory_item_id         = oola.inventory_item_id
                              AND rctl.line_type                 = 'LINE'
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE1 = ooha.ORIG_SYS_DOCUMENT_REF
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE7 = oola.ORIG_SYS_LINE_REF
                              AND RCTL.INTERFACE_LINE_CONTEXT    = 'GEMS_PB_RR'
                              AND rctl.customer_trx_id           = rcta.customer_trx_id
                              AND rcta.bill_to_site_use_id       = hcsu.site_use_id
                              AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                              AND hcas.cust_account_id           = hca.cust_account_id
                              AND ROWNUM = 1 ) = 'GEMS_PB_RR' THEN
                     --
                     (SELECT DISTINCT DECODE(hcas.global_attribute2
                                           , '2',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'/'|| hcas.global_attribute4 ||'-'|| hcas.global_attribute5
                                           , '1',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'-'|| hcas.global_attribute5 
                                           , '3',HCSU.LOCATION||' - '||hcas.global_attribute3)
                             FROM apps.hz_parties                hp
                                , apps.hz_cust_accounts          hca
                                , apps.oe_order_lines_all        oola
                                , apps.oe_order_headers_all      ooha
                                , apps.ra_customer_trx_lines_all rctl
                                , apps.ra_customer_trx_all       rcta
                                , apps.hz_cust_acct_sites_all    hcas
                                , apps.hz_cust_site_uses_all     hcsu
                            WHERE ooha.header_id                 = oola.header_id
                              AND oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND rctl.inventory_item_id         = oola.inventory_item_id
                              AND rctl.line_type                 = 'LINE'
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE1 = ooha.ORIG_SYS_DOCUMENT_REF
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE7 = oola.ORIG_SYS_LINE_REF
                              AND RCTL.INTERFACE_LINE_CONTEXT    = 'GEMS_PB_RR'
                              AND rctl.customer_trx_id           = rcta.customer_trx_id
                              AND rcta.bill_to_site_use_id       = hcsu.site_use_id
                              AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                              AND hcas.cust_account_id           = hca.cust_account_id 
                              AND ROWNUM = 1 )
                     --
                     ELSE
                     --
                     (SELECT DISTINCT DECODE(hcas.global_attribute2
                                   , '2',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'/'|| hcas.global_attribute4 ||'-'|| hcas.global_attribute5
                                   , '1',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'-'|| hcas.global_attribute5 
                                   , '3',HCSU.LOCATION||' - '||hcas.global_attribute3)
                             --
                      FROM   APPS.HZ_CUST_ACCT_SITES_ALL HCAS,
                             APPS.HZ_CUST_SITE_USES_ALL  HCSU,
                             APPS.OE_ORDER_LINES_ALL     OOLA,
                             APPS.OE_ORDER_HEADERS_ALL   OOHA
                             --
                      WHERE  HCSU.SITE_USE_CODE     = 'BILL_TO'
                      AND    HCSU.CUST_ACCT_SITE_ID = HCAS.CUST_ACCT_SITE_ID
                      AND    HCSU.SITE_USE_ID       = NVL(OOLA.ATTRIBUTE1, OOHA.INVOICE_TO_ORG_ID)
                      AND    OOLA.LINE_ID           = NVL(MMT.TRX_SOURCE_LINE_ID, MMT.SOURCE_LINE_ID)
                      AND    OOHA.HEADER_ID         = OOLA.HEADER_ID
                      AND    ROWNUM = 1)
                     --
                     END
                  END
               END      bill_to_CNPJ_CPF
               --
                             --
              , CASE WHEN (mmt.source_code = '3PL_REMITTANCE_BRAZIL') THEN
                        (SELECT listagg(hp.party_name,', ' ON OVERFLOW TRUNCATE)  
                        WITHIN GROUP (ORDER BY hp.party_name asc)
                          FROM apps.hz_parties             hp,
                               apps.hz_cust_accounts       hca,
                               apps.ra_customer_trx_all    rcta,
                               apps.hz_cust_acct_sites_all hcas,
                               apps.hz_cust_site_uses_all  hcsu
                         WHERE rcta.interface_header_attribute1 = mp.organization_code||'_'||mmt.transaction_reference
                           AND rcta.bill_to_site_use_id         = hcsu.site_use_id
                           AND hcsu.cust_acct_site_id           = hcas.cust_acct_site_id
                           AND hcas.cust_account_id             = hca.cust_account_id
                           AND hca.party_id                     = hp.party_id
                           AND rcta.org_id                      = 4330)
                   ELSE
                     --
                     CASE WHEN (select DISTINCT RCTL.INTERFACE_LINE_CONTEXT
                             FROM apps.hz_parties                hp
                                , apps.hz_cust_accounts          hca
                                , apps.oe_order_lines_all        oola
                                , apps.oe_order_headers_all      ooha
                                , apps.ra_customer_trx_lines_all rctl
                                , apps.ra_customer_trx_all       rcta
                                , apps.hz_cust_acct_sites_all    hcas
                                , apps.hz_cust_site_uses_all     hcsu
                            WHERE ooha.header_id                 = oola.header_id
                              AND oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND rctl.inventory_item_id         = oola.inventory_item_id
                              AND rctl.line_type                 = 'LINE'
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE1 = to_char(ooha.order_number)
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE6 = to_char(oola.line_id)
                              AND RCTL.INTERFACE_LINE_CONTEXT    = 'ORDER ENTRY'
                              AND rctl.customer_trx_id           = rcta.customer_trx_id
                              AND rcta.bill_to_site_use_id       = hcsu.site_use_id
                              AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                              AND hcas.cust_account_id           = hca.cust_account_id
                              AND hca.party_id                   = hp.party_id 
                              AND ROWNUM = 1) = 'ORDER ENTRY' THEN
                     --
                     (SELECT listagg(hp.party_name,', ' ON OVERFLOW TRUNCATE)  
                         WITHIN GROUP (ORDER BY hp.party_name asc)
                             FROM apps.hz_parties                hp
                                , apps.hz_cust_accounts          hca
                                , apps.oe_order_lines_all        oola
                                , apps.oe_order_headers_all      ooha
                                , apps.ra_customer_trx_lines_all rctl
                                , apps.ra_customer_trx_all       rcta
                                , apps.hz_cust_acct_sites_all    hcas
                                , apps.hz_cust_site_uses_all     hcsu
                            WHERE ooha.header_id                 = oola.header_id
                              AND oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND rctl.inventory_item_id         = oola.inventory_item_id
                              AND rctl.line_type                 = 'LINE'
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE1 = to_char(ooha.order_number)
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE6 = to_char(oola.line_id)
                              AND RCTL.INTERFACE_LINE_CONTEXT    = 'ORDER ENTRY'
                              AND rctl.customer_trx_id           = rcta.customer_trx_id
                              AND rcta.bill_to_site_use_id       = hcsu.site_use_id
                              AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                              AND hcas.cust_account_id           = hca.cust_account_id
                              AND hca.party_id                   = hp.party_id
                              AND ROWNUM = 1)
                     --
                     ELSE
                     --            
                     CASE WHEN 
                          ( SELECT DISTINCT RCTL.INTERFACE_LINE_CONTEXT
                             FROM apps.hz_parties                hp
                                , apps.hz_cust_accounts          hca
                                , apps.oe_order_lines_all        oola
                                , apps.oe_order_headers_all      ooha
                                , apps.ra_customer_trx_lines_all rctl
                                , apps.ra_customer_trx_all       rcta
                                , apps.hz_cust_acct_sites_all    hcas
                                , apps.hz_cust_site_uses_all     hcsu
                            WHERE ooha.header_id                 = oola.header_id
                              AND oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND rctl.inventory_item_id         = oola.inventory_item_id
                              AND rctl.line_type                 = 'LINE'
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE1 = ooha.ORIG_SYS_DOCUMENT_REF
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE7 = oola.ORIG_SYS_LINE_REF
                              AND RCTL.INTERFACE_LINE_CONTEXT    = 'GEMS_PB_RR'
                              AND rctl.customer_trx_id           = rcta.customer_trx_id
                              AND rcta.bill_to_site_use_id       = hcsu.site_use_id
                              AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                              AND hcas.cust_account_id           = hca.cust_account_id
                              AND ROWNUM = 1 ) = 'GEMS_PB_RR' THEN
                     --
                     (SELECT listagg(hp.party_name,', ' ON OVERFLOW TRUNCATE)  
                         WITHIN GROUP (ORDER BY hp.party_name asc)
                             FROM apps.hz_parties                hp
                                , apps.hz_cust_accounts          hca
                                , apps.oe_order_lines_all        oola
                                , apps.oe_order_headers_all      ooha
                                , apps.ra_customer_trx_lines_all rctl
                                , apps.ra_customer_trx_all       rcta
                                , apps.hz_cust_acct_sites_all    hcas
                                , apps.hz_cust_site_uses_all     hcsu
                            WHERE ooha.header_id                 = oola.header_id
                              AND oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND rctl.inventory_item_id         = oola.inventory_item_id
                              AND rctl.line_type                 = 'LINE'
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE1 = ooha.ORIG_SYS_DOCUMENT_REF
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE7 = oola.ORIG_SYS_LINE_REF
                              AND RCTL.INTERFACE_LINE_CONTEXT    = 'GEMS_PB_RR'
                              AND rctl.customer_trx_id           = rcta.customer_trx_id
                              AND rcta.bill_to_site_use_id       = hcsu.site_use_id
                              AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                              AND hcas.cust_account_id           = hca.cust_account_id 
                              AND ROWNUM = 1 )
                     --
                     ELSE
                     --
                     (SELECT listagg(hp.party_name,', ' ON OVERFLOW TRUNCATE)  
                         WITHIN GROUP (ORDER BY hp.party_name asc)
                      FROM   APPS.HZ_CUST_ACCT_SITES_ALL HCAS,
                             apps.hz_parties             hp,
                             apps.hz_cust_accounts       hca,
                             APPS.HZ_CUST_SITE_USES_ALL  HCSU,
                             APPS.OE_ORDER_LINES_ALL     OOLA,
                             APPS.OE_ORDER_HEADERS_ALL   OOHA
                             --
                      WHERE  HCSU.SITE_USE_CODE     = 'BILL_TO'
                      AND    HCSU.CUST_ACCT_SITE_ID = HCAS.CUST_ACCT_SITE_ID
                      AND    HCSU.SITE_USE_ID       = NVL(OOLA.ATTRIBUTE1, OOHA.INVOICE_TO_ORG_ID)
                      AND    OOLA.LINE_ID           = NVL(MMT.TRX_SOURCE_LINE_ID, MMT.SOURCE_LINE_ID)
                      AND    OOHA.HEADER_ID         = OOLA.HEADER_ID
                      AND    hcas.cust_account_id   = hca.cust_account_id
                      AND    hca.party_id           = hp.party_id 
                      AND    ROWNUM = 1)
                     --          
                     END
                  END
               END      bill_to_Customer_name
               --
                , CASE WHEN (mmt.source_code = '3PL_REMITTANCE_BRAZIL') THEN
                      (SELECT listagg(DECODE(hcas.global_attribute2
                                           , '2',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'/'|| hcas.global_attribute4 ||'-'|| hcas.global_attribute5
                                           , '1',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'-'|| hcas.global_attribute5 
                                           , '3',HCSU.LOCATION||' - '||hcas.global_attribute3 ),', ' ON OVERFLOW TRUNCATE)
                       WITHIN GROUP (ORDER BY hcas.global_attribute2 asc )
                         FROM apps.ra_customer_trx_all         rcta
                            , apps.hz_cust_acct_sites_all      hcas
                            , apps.hz_cust_site_uses_all       hcsu
                        WHERE rcta.interface_header_attribute1 = mp.organization_code||'_'||mmt.transaction_reference
                          AND rcta.ship_to_site_use_id         = hcsu.site_use_id
                          AND hcsu.cust_acct_site_id           = hcas.cust_acct_site_id
                          AND rcta.org_id                      = 4330
                          AND ROWNUM = 1)
                   ELSE
                     --
                     CASE WHEN (select DISTINCT RCTL.INTERFACE_LINE_CONTEXT
                             FROM apps.hz_parties                hp
                                , apps.hz_cust_accounts          hca
                                , apps.oe_order_lines_all        oola
                                , apps.oe_order_headers_all      ooha
                                , apps.ra_customer_trx_lines_all rctl
                                , apps.ra_customer_trx_all       rcta
                                , apps.hz_cust_acct_sites_all    hcas
                                , apps.hz_cust_site_uses_all     hcsu
                            WHERE ooha.header_id                 = oola.header_id
                              AND oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND rctl.inventory_item_id         = oola.inventory_item_id
                              AND rctl.line_type                 = 'LINE'
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE1 = to_char(ooha.order_number)
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE6 = to_char(oola.line_id)
                              AND RCTL.INTERFACE_LINE_CONTEXT    = 'ORDER ENTRY'
                              AND rctl.customer_trx_id           = rcta.customer_trx_id
                              AND rcta.ship_to_site_use_id       = hcsu.site_use_id
                              AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                              AND hcas.cust_account_id           = hca.cust_account_id
                              AND hca.party_id                   = hp.party_id 
                              AND ROWNUM = 1) = 'ORDER ENTRY' THEN
                     --
                     (SELECT DISTINCT DECODE(hcas.global_attribute2
                                           , '2',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'/'|| hcas.global_attribute4 ||'-'|| hcas.global_attribute5
                                           , '1',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'-'|| hcas.global_attribute5 
                                           , '3',HCSU.LOCATION||' - '||hcas.global_attribute3)
                             FROM apps.hz_parties                hp
                                , apps.hz_cust_accounts          hca
                                , apps.oe_order_lines_all        oola
                                , apps.oe_order_headers_all      ooha
                                , apps.ra_customer_trx_lines_all rctl
                                , apps.ra_customer_trx_all       rcta
                                , apps.hz_cust_acct_sites_all    hcas
                                , apps.hz_cust_site_uses_all     hcsu
                            WHERE ooha.header_id                 = oola.header_id
                              AND oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND rctl.inventory_item_id         = oola.inventory_item_id
                              AND rctl.line_type                 = 'LINE'
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE1 = to_char(ooha.order_number)
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE6 = to_char(oola.line_id)
                              AND RCTL.INTERFACE_LINE_CONTEXT    = 'ORDER ENTRY'
                              AND rctl.customer_trx_id           = rcta.customer_trx_id
                              AND rcta.ship_to_site_use_id       = hcsu.site_use_id
                              AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                              AND hcas.cust_account_id           = hca.cust_account_id
                              AND hca.party_id                   = hp.party_id
                              AND ROWNUM = 1)
                     --
                     ELSE
                     --            
                     CASE WHEN 
                          ( SELECT DISTINCT RCTL.INTERFACE_LINE_CONTEXT
                             FROM apps.hz_parties                hp
                                , apps.hz_cust_accounts          hca
                                , apps.oe_order_lines_all        oola
                                , apps.oe_order_headers_all      ooha
                                , apps.ra_customer_trx_lines_all rctl
                                , apps.ra_customer_trx_all       rcta
                                , apps.hz_cust_acct_sites_all    hcas
                                , apps.hz_cust_site_uses_all     hcsu
                            WHERE ooha.header_id                 = oola.header_id
                              AND oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND rctl.inventory_item_id         = oola.inventory_item_id
                              AND rctl.line_type                 = 'LINE'
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE1 = ooha.ORIG_SYS_DOCUMENT_REF
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE7 = oola.ORIG_SYS_LINE_REF
                              AND RCTL.INTERFACE_LINE_CONTEXT    = 'GEMS_PB_RR'
                              AND rctl.customer_trx_id           = rcta.customer_trx_id
                              AND rcta.ship_to_site_use_id       = hcsu.site_use_id
                              AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                              AND hcas.cust_account_id           = hca.cust_account_id
                              AND ROWNUM = 1 ) = 'GEMS_PB_RR' THEN
                     --
                     (SELECT DISTINCT DECODE(hcas.global_attribute2
                                           , '2',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'/'|| hcas.global_attribute4 ||'-'|| hcas.global_attribute5
                                           , '1',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'-'|| hcas.global_attribute5 
                                           , '3',HCSU.LOCATION||' - '||hcas.global_attribute3)
                             FROM apps.hz_parties                hp
                                , apps.hz_cust_accounts          hca
                                , apps.oe_order_lines_all        oola
                                , apps.oe_order_headers_all      ooha
                                , apps.ra_customer_trx_lines_all rctl
                                , apps.ra_customer_trx_all       rcta
                                , apps.hz_cust_acct_sites_all    hcas
                                , apps.hz_cust_site_uses_all     hcsu
                            WHERE ooha.header_id                 = oola.header_id
                              AND oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND rctl.inventory_item_id         = oola.inventory_item_id
                              AND rctl.line_type                 = 'LINE'
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE1 = ooha.ORIG_SYS_DOCUMENT_REF
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE7 = oola.ORIG_SYS_LINE_REF
                              AND RCTL.INTERFACE_LINE_CONTEXT    = 'GEMS_PB_RR'
                              AND rctl.customer_trx_id           = rcta.customer_trx_id
                              AND rcta.ship_to_site_use_id       = hcsu.site_use_id
                              AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                              AND hcas.cust_account_id           = hca.cust_account_id 
                              AND ROWNUM = 1 )
                     --
                     ELSE
                     --
                     (SELECT listagg(DECODE(hcas.global_attribute2
                                           , '2',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'/'|| hcas.global_attribute4 ||'-'|| hcas.global_attribute5
                                           , '1',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'-'|| hcas.global_attribute5 
                                           , '3',HCSU.LOCATION||' - '||hcas.global_attribute3 ),', ' ON OVERFLOW TRUNCATE)
                      WITHIN GROUP (ORDER BY hcas.global_attribute2 asc) 
                         FROM apps.hz_parties             hp
                            , apps.hz_cust_accounts       hca
                            , apps.oe_order_lines_all     oola
                            , apps.hz_cust_acct_sites_all hcas
                            , apps.hz_cust_site_uses_all  hcsu
                        WHERE oola.line_id                = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                          AND oola.ship_to_org_id         = hcsu.site_use_id
                          AND hcsu.cust_acct_site_id      = hcas.cust_acct_site_id
                          AND hcas.cust_account_id        = hca.cust_account_id
                          AND hca.party_id                = hp.party_id  )
                     --
                     END
                  END
               END      ship_to_CNPJ_CPF
               --
              , CASE WHEN ( SELECT ottl.name
                              FROM apps.oe_transaction_types_tl    ottl
                                 , apps.oe_order_headers_all  ooha
                                 , apps.oe_order_lines_all    oola  
                             WHERE oola.line_id        = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                               AND oola.header_id      = ooha.header_id
                               AND ooha.order_type_id  = ottl.transaction_type_id  ) = 'GPO_BR_FE_SHIPMENT' THEN
                      (SELECT listagg(hzl.address1 ||' - '|| hzl.address2 || ' - ' || hzl.city || '-' || hzl.state || ' / ' || hzl.postal_code,', ' ON OVERFLOW TRUNCATE)  
                       WITHIN GROUP (ORDER BY hzl.address1 asc)
                       FROM apps.hz_parties             hp
                        , apps.hz_party_sites         hps
                        , apps.hz_cust_accounts       hca
                        , apps.oe_order_lines_all     oola
                        , apps.hz_cust_acct_sites_all hcas
                        , apps.hz_cust_site_uses_all  hcsu
                        , apps.hz_locations           hzl
                    WHERE oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                      AND oola.end_customer_site_use_id  = hcsu.site_use_id
                      AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                      AND hcas.cust_account_id           = hca.cust_account_id
                      AND hcas.party_site_id             = hps.party_site_id
                      AND hca.party_id                   = hp.party_id
                      AND hps.party_id                   = hp.party_id
                      AND hps.location_id                = hzl.location_id)
                ELSE
                   CASE WHEN (mmt.source_code = '3PL_REMITTANCE_BRAZIL') THEN
                      (SELECT listagg(hzl.address1 ||' - '|| hzl.address2 || ' - ' || hzl.city || '-' || hzl.state || ' / ' || hzl.postal_code,', ' ON OVERFLOW TRUNCATE)  
                       WITHIN GROUP (ORDER BY hzl.address1 asc)
                         FROM apps.ra_customer_trx_all     rcta
                            , apps.hz_cust_acct_sites_all  hcas
                            , apps.hz_cust_site_uses_all   hcsu
                            , apps.hz_parties              hp
                            , apps.hz_party_sites          hps
                            , apps.hz_cust_accounts        hca
                            , apps.hz_locations            hzl
                        WHERE rcta.interface_header_attribute1 = mp.organization_code||'_'||mmt.transaction_reference
                          AND rcta.ship_to_site_use_id         = hcsu.site_use_id
                          AND hcsu.cust_acct_site_id           = hcas.cust_acct_site_id
                          AND hcas.cust_account_id             = hca.cust_account_id
                          AND hcas.party_site_id               = hps.party_site_id
                          AND hca.party_id                     = hp.party_id
                          AND hps.party_id                     = hp.party_id
                          AND hps.location_id                  = hzl.location_id
                          AND rcta.org_id                      = 4330)
                   ELSE
                      (SELECT listagg(hzl.address1 ||' - '|| hzl.address2 || ' - ' || hzl.city || '-' || hzl.state || ' / ' || hzl.postal_code,', ' ON OVERFLOW TRUNCATE)  
                       WITHIN GROUP (ORDER BY hzl.address1 asc)
                          FROM apps.hz_parties             hp
                             , apps.hz_party_sites         hps
                             , apps.hz_cust_accounts       hca
                             , apps.oe_order_lines_all     oola
                             , apps.hz_cust_acct_sites_all hcas
                             , apps.hz_cust_site_uses_all  hcsu
                             , apps.hz_locations           hzl
                         WHERE oola.line_id                = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                           AND oola.ship_to_org_id         = hcsu.site_use_id
                           AND hcsu.cust_acct_site_id      = hcas.cust_acct_site_id
                           AND hcas.cust_account_id        = hca.cust_account_id
                           AND hcas.party_site_id          = hps.party_site_id
                           AND hca.party_id                = hp.party_id
                           AND hps.party_id                = hp.party_id
                           AND hps.location_id             = hzl.location_id   )
                   END
                END customer_address
                -- 
                -- alterado para BIll_to por Sinval fim
                -- 
              , CASE WHEN (mmt.source_code = '3PL_REMITTANCE_BRAZIL') THEN
                   (SELECT listagg(rcta.trx_number,', ' ON OVERFLOW TRUNCATE)  
                           WITHIN GROUP (ORDER BY rcta.trx_number asc)
                      FROM apps.ra_customer_trx_all       rcta
                     WHERE rcta.interface_header_attribute1  = mp.organization_code||'_'||mmt.transaction_reference
                       AND rcta.org_id                       = 4330
                       AND NVL(rcta.status_trx,'XX')         <> 'VD'
                       AND NVL(rcta.reason_code,'XX')        <> 'CANCELLATION')
                ELSE
                   (SELECT distinct RTRIM(REGEXP_REPLACE((listagg(rcta.trx_number,', ' ON OVERFLOW TRUNCATE)  
                    WITHIN GROUP (ORDER BY rcta.trx_number asc) ), '([^,]*)(,\1)+($|,)', '\1\3'),',')
                      FROM apps.ra_customer_trx_lines_all rctla
                         , apps.ra_customer_trx_all       rcta
                         , apps.oe_order_lines_all        oola
                         , apps.oe_order_headers_all      ooha
                     WHERE rcta.customer_trx_id              = rctla.customer_trx_id
                       AND oola.line_id                      = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                       AND oola.header_id                    = ooha.header_id
                       AND rctla.sales_order                 = to_char(ooha.order_number)
                       AND rctla.line_type                   = 'LINE'
                       AND rcta.batch_source_id              <> 6266 -- No RR invoices
                       AND DECODE(rctla.interface_line_context,'GEMS_PB_RR',rcta.interface_header_attribute11,'999')
                           = DECODE(rctla.interface_line_context,'GEMS_PB_RR',rcta.interface_header_attribute11,'999')
                       AND rcta.org_id                       = 4330
                       AND trunc(rcta.trx_date)              BETWEEN (trunc(mmt.transaction_date)-3) AND (trunc(mmt.transaction_date)+3)
                       AND NVL(rcta.status_trx,'XX')         <> 'VD'
                       AND NVL(rcta.reason_code,'XX')        <> 'CANCELLATION')
                END   invoice_number_ar
              , ( SELECT listagg(mrav.reservation_quantity,', ' ON OVERFLOW TRUNCATE)  
                  WITHIN GROUP (ORDER BY mrav.reservation_quantity asc) 
                    FROM apps.mtl_reservations_all_v  mrav 
                       , apps.oe_order_headers_all    ooha1
                   WHERE mrav.demand_source_header_id     = ooha1.header_id
                     AND mrav.demand_source_line_id       = NVL(mmt.trx_source_line_id, mmt.source_line_id) )  reservation_quantity
              , ( SELECT listagg(ooha1.order_number,', ' ON OVERFLOW TRUNCATE)  
                  WITHIN GROUP (ORDER BY ooha1.order_number asc) 
                    FROM apps.mtl_reservations_all_v  mrav 
                       , apps.oe_order_headers_all    ooha1
                   WHERE mrav.demand_source_header_id     = ooha1.header_id
                     AND mrav.demand_source_line_id       = NVL(mmt.trx_source_line_id, mmt.source_line_id) )  reservation_order_number
              , (SELECT distinct hp.party_name
                 --WITHIN GROUP (ORDER BY hp.party_name asc)
                   FROM apps.hz_parties              hp
                      , apps.hz_cust_accounts        hca
                      , apps.oe_order_lines_all      oola1
                      , apps.oe_order_headers_all    ooha1
                      , apps.mtl_reservations_all_v  mrav 
                  WHERE mrav.demand_source_header_id   = ooha1.header_id
                    AND mrav.demand_source_line_id     = oola1.line_id
                    AND oola1.line_id                  = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                    AND oola1.ship_to_org_id           = hca.cust_account_id
                    AND hca.party_id                   = hp.party_id )         reservation_customer_name
              , gcc1.concatenated_segments   material_account
              , gcc2.concatenated_segments   outside_processing_account
              , gcc3.concatenated_segments   material_overhead_account
              , gcc4.concatenated_segments   overhead_account
              , gcc5.concatenated_segments   resource_account
              , sysdate                                           report_date_and_time 
              , to_char(mmt.transaction_id)  transaction_id
              , fu.user_name ||' / '|| fu.description                                    user_name
              , DECODE( lot_control_code, 1 ,'Sem controle de Lote' , 2,'Com controle de Lote')   lot_control
              , DECODE( serial_number_control_code, 1, 'Sem controle de Serial'
                                                  , 2, 'Pre-definido'
                                                  , 5, 'No Recebimento'
                                                  , 6, 'Baixa na Ordem de Venda' )  serial_control
              , CASE
                 WHEN    nvl(mmt.lpn_id, mmt.content_lpn_id) IS NULL AND moq.subinventory_code <> 'WHGU42GNAT'
                   THEN 
                    (SELECT listagg(lpn.license_plate_number,', ' ON OVERFLOW TRUNCATE)WITHIN GROUP (ORDER BY lpn.license_plate_number asc)
                             FROM apps.MTL_MATERIAL_TRANSACTIONS   mtt,
                                  apps.wms_license_plate_numbers   lpn,
                                  apps.oe_order_lines_all          ool
                            WHERE 1 = 1
                              AND mtt.TRX_SOURCE_LINE_ID = CASE
                                                              WHEN LINE_CATEGORY_CODE = 'ORDER'
                                                                THEN ool.line_id
                                                              WHEN LINE_CATEGORY_CODE = 'RETURN'  
                                                                THEN   
                                                                to_number(NVL(SUBSTR(ool.ORIG_SYS_LINE_REF,
                                                                                     0,
                                                                                     INSTR(ool.ORIG_SYS_LINE_REF, '.') - 1),
                                                                              -1)) -- RMA FE OE Line Id
                                                                ELSE -1
                                                                  END
                              AND mtt.TRANSACTION_TYPE_ID = 52 --sales order pick FE ORDER
                              AND mtt.transaction_quantity < 0
                              AND mtt.inventory_item_id = ool.inventory_item_id
                              AND nvl(mtt.lpn_id, mtt.content_lpn_id) = nvl(lpn.lpn_id, -1)
                              AND ool.line_id = CASE
                                                  WHEN mtt.transaction_type_name = 'RMA Receipt'
                                                    THEN mmt.TRX_SOURCE_LINE_ID
                                                  WHEN mtt.transaction_type_name = 'GPO Nationalization Receipt'
                                                     THEN 
                                                      to_number(NVL(SUBSTR(RTRIM(LTRIM(translate(mmt.TRANSACTION_REFERENCE,translate(mmt.TRANSACTION_REFERENCE||'a','1234567890.',' '),' '))),
                                                         0,
                                                         INSTR(RTRIM(LTRIM(translate(mmt.TRANSACTION_REFERENCE,translate(mmt.TRANSACTION_REFERENCE||'a','1234567890.',' '),' '))), '.') - 1),
                                                  -1))
                                                  ELSE -1
                                                    END)
                              WHEN moq.subinventory_code = 'WHGU42GNAT'
                  THEN (SELECT listagg(wlp.license_plate_number,', ' ON OVERFLOW TRUNCATE)  
                            WITHIN GROUP (ORDER BY wlp.license_plate_number asc)
                        FROM   gems_ont.ge_gpo_nationalization_line gnl, 
                               gems_ont.ge_gpo_nationalization_line gn2,
                               apps.wms_license_plate_numbers       wlp,
                               apps.po_line_locations_all           pll,
                               apps.po_lines_all                    pol,
                               apps.po_headers_all                  poh,
                               apps.rcv_shipment_headers            rsh,
                               apps.rcv_transactions                rt
                        Where  wlp.lpn_id(+) = gn2.lpn_id
                        AND gnl.nationalization_so_line_id = gn2.nationalization_so_line_id
                        AND pll.line_location_id = gnl.DOCUMENT_ID
                        AND pll.po_header_id = poh.po_header_id
                        AND pll.po_line_id = pol.po_line_id
                        AND gn2.record_type = 'IMPORT'
                        AND gnl.record_type = 'NATIONALIZATION'
                        AND rt.transaction_id                = mmt.rcv_transaction_id
                        AND rt.po_line_location_id           = pll.line_location_id
                        AND rt.shipment_header_id            = rsh.shipment_header_id)
                ELSE (SELECT lpn.LICENSE_PLATE_NUMBER
                           FROM   apps.wms_license_plate_numbers   lpn
                           WHERE  nvl(mmt.lpn_id, mmt.content_lpn_id) = nvl(lpn.lpn_id, -1))
                        END LPN_Value                                    
             , 'q16' query
--, mmt.transaction_type_id
--, mmt.trx_source_line_id
--, mmt.source_line_id
           FROM apps.mtl_serial_numbers              msn
              , apps.mtl_parameters                  mp
              , apps.mtl_system_items_b              msi
              , apps.mtl_secondary_inventories_fk_v  msifv
              , apps.gl_code_combinations            gcc
              , apps.gl_code_combinations_kfv        gcc1
              , apps.gl_code_combinations_kfv        gcc2
              , apps.gl_code_combinations_kfv        gcc3
              , apps.gl_code_combinations_kfv        gcc4
              , apps.gl_code_combinations_kfv        gcc5
              --, apps.mtl_item_locations_kfv          milk
              , AMARCHIVE.MTL_MATERIAL_TRANSACTIONS       mmt
              , apps.mtl_transaction_types           mtt
              , apps.mtl_txn_source_types            mtst
              , apps.fnd_flex_values_vl              ffvv
              , apps.fnd_flex_value_sets             ffvs
              , apps.fnd_user                        fu
              , ( SELECT organization_id
                       , inventory_item_id
                       , subinventory_code
                       , locator_id
                       --, lot_number
                       --, transaction_uom_code
                       --, update_transaction_id
                       , SUM (primary_transaction_quantity) onhand_qty
                    FROM apps.mtl_onhand_quantities_detail
                   WHERE organization_id IN (SELECT ood.organization_id FROM apps.org_organization_definitions ood WHERE ood.set_of_books_id = 230 )
                   GROUP BY organization_id
                          , inventory_item_id
                          , subinventory_code
                          , locator_id
                      --    , revision
                          --, lot_number
                          --, transaction_uom_code
                          --, update_transaction_id 
                          ) moq
                          ,APPS.MTL_PAC_ACTUAL_COST_DETAILS MPACD 
          WHERE 1                                = 1
          AND decode(mmt.periodic_primary_quantity,null,mmt.transfer_transaction_id,MMT.TRANSACTION_ID) = MPACD.TRANSACTION_ID  
            AND mp.organization_id               = msi.organization_id
--            AND msi.segment1 = '60510302'
            AND msifv.organization_id            = msi.organization_id
            AND msifv.secondary_inventory_name   = moq.subinventory_code
            AND msifv.material_account           = gcc1.code_combination_id
            AND msifv.outside_processing_account = gcc2.code_combination_id
            AND msifv.material_overhead_account  = gcc3.code_combination_id
            AND msifv.overhead_account           = gcc4.code_combination_id
            AND msifv.resource_account           = gcc5.code_combination_id
            AND msi.cost_of_sales_account       = gcc.code_combination_id
            AND ffvs.flex_value_set_name        = 'GE_GL_AFF_ES_PRODUCT_LINE'
            AND ffvs.flex_value_set_id          = ffvv.flex_value_set_id
            AND ffvv.flex_value_meaning         = gcc.segment8
            AND 'TYPE 1'                        IN ('TYPE 1')
            AND msi.organization_id             IN (SELECT ood.organization_id FROM apps.org_organization_definitions ood WHERE ood.set_of_books_id = 230 )
            AND moq.inventory_item_id            = msn.inventory_item_id         (+) 
            AND moq.organization_id              = msn.current_organization_id   (+) 
            AND moq.subinventory_code            = msn.current_subinventory_code (+) 
            --AND moq.locator_id                   = msn.current_locator_id        (+) 
            AND msn.current_status           (+) = 3   
            AND moq.inventory_item_id           = msi.inventory_item_id
            AND moq.organization_id             = msi.organization_id
            --AND moq.locator_id                  = milk.inventory_location_id
            AND msn.last_transaction_id         = mmt.transaction_id
--    AND MMT.TRANSACTION_ID = 2562828197
            AND mtt.transaction_type_id         = mmt.transaction_type_id 
            AND mtst.transaction_source_type_id = mmt.transaction_source_type_id
            AND msi.serial_number_control_code  <> '1' 
            AND msi.lot_control_code            = '1'  --Sem controle de Lote
            AND moq.locator_id                 IS NULL ------------- Ajustado para n?conflitar com a query 11 e 12 - Sinval 17/02
            AND fu.user_id                      = mmt.created_by
    AND MMT.TRANSACTION_ID NOT IN(SELECT MMT2.TRANSACTION_ID 
                                  FROM APPS.MTL_MATERIAL_TRANSACTIONS MMT2
                                  WHERE MMT2.TRANSACTION_ID = MMT.TRANSACTION_ID)
------------------------------------------------------------------------------
UNION  
------------------------------------------------------------------------------  
-- Com Controle Lote e Sem controle Serial
          SELECT DISTINCT  --'17' NUM
            /*  ( SELECT ccg.cost_group 
                             FROM apps.cst_cost_groups            ccg
                                , apps.cst_cost_group_assignments ccga
                            WHERE ccga.cost_group_id     = ccg.cost_group_id
                              AND ccga.organization_id   = mp.organization_id )  cost_group*/
            ( SELECT ccg.cost_group 
                             FROM apps.cst_cost_groups            ccg
                            WHERE MPACD.cost_group_id     = ccg.cost_group_id )  cost_group              
              , ( SELECT ( SELECT cpp1.period_name 
                             FROM apps.cst_pac_item_costs   cst
                                , apps.cst_pac_periods      cpp1
                            WHERE cst.pac_period_id     = (SELECT MAX(PAC_PERIOD_ID)                   FROM APPS.CST_PAC_PERIODS                  WHERE LEGAL_ENTITY = (SELECT LEGAL_ENTITY                                          FROM APPS.ORG_ORGANIZATION_DEFINITIONS OOD                                         WHERE OOD.ORGANIZATION_ID = mp.organization_id                                         ) )
                              AND cst.pac_period_id     = cpp1.pac_period_id
                              AND cst.inventory_item_id = msi.inventory_item_id
                              AND cst.cost_group_id     = ccg.cost_group_id )  
                    FROM apps.cst_cost_groups            ccg
                       , apps.cst_cost_group_assignments ccga
                   WHERE ccga.cost_group_id     = ccg.cost_group_id
                     AND ccga.organization_id   = mp.organization_id ) period_name
              , mp.organization_code
              , mp.attribute7                organization_type
              , mp.organization_id 
              , moq.subinventory_code
              , msifv.description            subinv_description
              , milk.concatenated_segments   locators
              , DECODE( msifv.asset_inventory, 1 , 'Asset', 2, 'Non Asset')   asset_type
              , msi.segment1                 part_number
              , DECODE(msi.inventory_asset_flag, NULL, 'No', 'N', 'No', 'Y', 'Yes')                         flag_asset_inventory
              , DECODE(msi.costing_enabled_flag, NULL, 'No', 'N', 'No', 'Y', 'Yes')                         flag_de_custo
              , msi.description              descrip_eng
              , msi.attribute3               descrip_ptb
              , msi.creation_date            item_creation_date
              , (trunc(SYSDATE) - trunc(msi.creation_date))      days_from_creation
              , gcc.segment8                                     product_line
              , ffvv.description                                 desc_prod_line
              , msi.primary_uom_code   uom
              , DECODE (msi.serial_number_control_code, 1, moq.onhand_qty, 1 ) transaction_quantity
              , NVL(( SELECT cic.item_cost
                        FROM apps.cst_item_costs cic
                       WHERE cic.organization_id   = msi.organization_id
                         AND cic.inventory_item_id = msi.inventory_item_id
                         AND cic.cost_type_id      = 1 ),0)  custo_unit_inv
              /*, nvl(( SELECT ( SELECT ROUND (cst.item_cost,2) 
                                 FROM apps.cst_pac_item_costs   cst
                                WHERE cst.pac_period_id     = (SELECT MAX(PAC_PERIOD_ID)                   FROM APPS.CST_PAC_PERIODS                  WHERE LEGAL_ENTITY = (SELECT LEGAL_ENTITY                                          FROM APPS.ORG_ORGANIZATION_DEFINITIONS OOD                                         WHERE OOD.ORGANIZATION_ID = mp.organization_id                                         ) )
                                  AND cst.inventory_item_id = msi.inventory_item_id
                                  AND cst.cost_group_id     = ccg.cost_group_id )  item_cost
                        FROM apps.cst_cost_groups            ccg
                           , apps.cst_cost_group_assignments ccga
                       WHERE ccga.cost_group_id     = ccg.cost_group_id
                         AND ccga.organization_id   = mp.organization_id ) ,0) custo_unit_pac*/
                , nvl((SELECT ROUND (cst.item_cost,2) 
                       FROM apps.cst_pac_item_costs   cst
                      WHERE cst.pac_period_id     = (SELECT MAX(PAC_PERIOD_ID)                   
                                                                FROM APPS.CST_PAC_PERIODS                  
                                                                WHERE LEGAL_ENTITY = (SELECT LEGAL_ENTITY                                         
                                                                                        FROM APPS.ORG_ORGANIZATION_DEFINITIONS OOD                                        
                                                                                        WHERE OOD.ORGANIZATION_ID = mp.organization_id
                                                        ) )
                        AND cst.inventory_item_id = msi.inventory_item_id
                        AND cst.cost_group_id     = MPACD.cost_group_id) ,0)  custo_unit_pac
              , moq.lot_number
              , ( SELECT mln.creation_date         
                    FROM apps.mtl_lot_numbers              mln
                   WHERE mln.lot_number           = moq.lot_number 
                     AND mln.inventory_item_id    = msi.inventory_item_id
                     AND mln.organization_id      = mp.organization_id  )  lot_creation_date
              , NULL   lot_qty_days_creation
              , ( SELECT mln.expiration_date         
                    FROM apps.mtl_lot_numbers              mln
                  WHERE mln.lot_number           = moq.lot_number
                     AND mln.inventory_item_id    = msi.inventory_item_id
                     AND mln.organization_id      = mp.organization_id  )  lot_expiration_date
              , msn.serial_number 
              , msn.creation_date     serial_creation_date
              , mtt.transaction_type_name           last_transaction_type
              , mmt.transaction_source_name         last_transaction_source
              , mtst.transaction_source_type_name   last_source_type
              , mmt.source_code
              , TO_CHAR(mmt.transaction_date, 'DD-MON-RRRR')       transaction_date
        , (SELECT TO_CHAR(mmt1.transaction_date, 'DD-MON-RRRR') 
                        FROM apps.mtl_material_transactions mmt1
                        WHERE mmt1.transaction_type_id=420
                        AND mmt1.source_line_id=mmt.source_line_id) initial_consignment_date
              , (TRUNC ( SYSDATE )- TRUNC(mmt.transaction_date))   transaction_qty_of_days
              , TO_CHAR(mmt.transaction_reference)                 transaction_reference
              , CASE WHEN mmt.source_code = '3PL_REMITTANCE_BRAZIL' THEN
                     (SELECT listagg(pha.segment1,', ' ON OVERFLOW TRUNCATE)  
                      WITHIN GROUP (ORDER BY pha.segment1 asc)
                        FROM apps.po_headers_all        pha
                           , apps.po_lines_all          pla
                       WHERE pla.po_line_id   = mmt.source_line_id
                         AND pla.po_header_id = pha.po_header_id)
                     WHEN mmt.source_code IN ('ORDER ENTRY','IIP') THEN
                        NULL
                     WHEN mmt.source_code = 'RCV' THEN
                        ( SELECT listagg(pha.segment1,', ' ON OVERFLOW TRUNCATE)  
                          WITHIN GROUP (ORDER BY pha.segment1 asc)
                            FROM apps.po_headers_all            pha
                               , apps.po_lines_all              pla
                               , apps.po_line_locations_all     plla
                               , apps.rcv_shipment_headers      rsh
                               , apps.rcv_transactions          rt
                           WHERE rt.transaction_id                = mmt.rcv_transaction_id
                             AND rt.po_line_location_id           = plla.line_location_id
                             AND plla.po_line_id                  = pla.po_line_id
                             AND pha.po_header_id                 = pla.po_header_id
                             AND rt.shipment_header_id            = rsh.shipment_header_id
                             AND rsh.receipt_source_code          = 'VENDOR'  )
                     ELSE
                        NULL
                END      po_number
              , CASE WHEN mmt.source_code = '3PL_REMITTANCE_BRAZIL' THEN
                     (SELECT listagg(aps.vendor_name,', ' ON OVERFLOW TRUNCATE)  
                      WITHIN GROUP (ORDER BY aps.vendor_name asc)
                        FROM apps.po_headers_all            pha
                           , apps.po_lines_all              pla
                           , apps.ap_suppliers              aps
                           , apps.ap_supplier_sites_all     apss
                       WHERE pla.po_line_id     = mmt.source_line_id
                         AND pla.po_header_id   = pha.po_header_id
                         AND pha.vendor_id      = aps.vendor_id
                         AND aps.vendor_id      = apss.vendor_id
                         AND pha.vendor_site_id = apss.vendor_site_id )
                     WHEN mmt.source_code IN ('ORDER ENTRY','IIP') THEN
                        NULL
                     WHEN mmt.source_code = 'RCV' THEN
                        ( SELECT listagg(aps.vendor_name,', ' ON OVERFLOW TRUNCATE)  
                          WITHIN GROUP (ORDER BY aps.vendor_name asc)
                            FROM apps.po_headers_all            pha
                               , apps.po_lines_all              pla
                               , apps.po_line_locations_all     plla
                               , apps.rcv_shipment_headers      rsh
                               , apps.rcv_transactions          rt
                               , apps.ap_suppliers              aps
                               , apps.ap_supplier_sites_all     apss
                           WHERE rt.transaction_id          = mmt.rcv_transaction_id
                             AND rt.po_line_location_id     = plla.line_location_id
                             AND plla.po_line_id            = pla.po_line_id
                             AND pha.po_header_id           = pla.po_header_id
                             AND rt.shipment_header_id      = rsh.shipment_header_id
                             AND rsh.receipt_source_code    = 'VENDOR'
                             AND pha.vendor_id              = aps.vendor_id
                             AND aps.vendor_id              = apss.vendor_id
                             AND pha.vendor_site_id         = apss.vendor_site_id  )
                     ELSE
                        NULL
                END    po_supplier
                --
              , CASE WHEN mmt.source_code = '3PL_REMITTANCE_BRAZIL' THEN
                     ( SELECT listagg(cfi.invoice_num,', ' ON OVERFLOW TRUNCATE)  
                         WITHIN GROUP (ORDER BY cfi.invoice_num asc)
                         FROM apps.cll_f189_invoice_lines cfil
                            , apps.cll_f189_invoices      cfi
                            , apps.po_lines_all           pla
                            , apps.po_line_locations_all  plla
                        WHERE plla.po_line_id       = pla.po_line_id
                          AND pla.po_line_id        = mmt.source_line_id
                          AND plla.line_location_id = cfil.line_location_id
                          AND cfil.invoice_id       = cfi.invoice_id )
                     WHEN mmt.source_code IN ('ORDER ENTRY','IIP') THEN
                        NULL
                     WHEN mmt.source_code = 'RCV' THEN
                        ( SELECT listagg(cfi.invoice_num,', ' ON OVERFLOW TRUNCATE)  
                            WITHIN GROUP (ORDER BY cfi.invoice_num asc)
                            FROM apps.po_headers_all            pha
                               , apps.po_lines_all              pla
                               , apps.po_line_locations_all     plla
                               , apps.cll_f189_invoice_lines    cfil
                               , apps.cll_f189_invoices         cfi
                               , apps.rcv_shipment_headers      rsh
                               , apps.rcv_transactions          rt
                           WHERE rt.transaction_id          = mmt.rcv_transaction_id
                             AND rt.po_line_location_id     = plla.line_location_id
                             AND plla.line_location_id      = cfil.line_location_id
                             AND cfil.invoice_id            = cfi.invoice_id
                            AND plla.po_line_id            = pla.po_line_id
                             AND pha.po_header_id           = pla.po_header_id
                             AND rt.shipment_header_id      = rsh.shipment_header_id
                             AND rsh.receipt_source_code    = 'VENDOR'   )
                     ELSE
                        NULL
                END    NF_RI
              , (SELECT DECODE( mmt.source_code, '3PL_REMITTANCE_BRAZIL',NULL,to_char(ooha.order_number) )
                   FROM apps.oe_order_headers_all  ooha
                      , apps.oe_order_lines_all    oola  
                  WHERE oola.line_id        = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                    AND oola.header_id      = ooha.header_id )   order_number
               -- 
               -- alterado para BIll_to por Sinval inicio
               --
               , CASE WHEN ( SELECT ottl.name
                             FROM apps.oe_transaction_types_tl    ottl
                                , apps.oe_order_headers_all  ooha
                                , apps.oe_order_lines_all    oola  
                            WHERE oola.line_id        = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND oola.header_id      = ooha.header_id
                              AND ooha.order_type_id  = ottl.transaction_type_id  ) = 'GPO_BR_FE_SHIPMENT' THEN
                     (SELECT listagg(hp.party_name,', ' ON OVERFLOW TRUNCATE)  
                      WITHIN GROUP (ORDER BY hp.party_name asc)
                        FROM apps.hz_parties             hp
                           , apps.hz_cust_accounts       hca
                           , apps.oe_order_lines_all     oola
                           , apps.hz_cust_acct_sites_all hcas
                           , apps.hz_cust_site_uses_all  hcsu
                       WHERE oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                         AND oola.end_customer_site_use_id  = hcsu.site_use_id
                         AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                         AND hcas.cust_account_id           = hca.cust_account_id
                         AND hca.party_id                   = hp.party_id )
                  ELSE
                     CASE WHEN (mmt.source_code = '3PL_REMITTANCE_BRAZIL') THEN
                       (SELECT listagg(hp.party_name,', ' ON OVERFLOW TRUNCATE)  
                        WITHIN GROUP (ORDER BY hp.party_name asc)
                          FROM apps.hz_parties             hp,
                               apps.hz_cust_accounts       hca,
                               apps.ra_customer_trx_all    rcta,
                               apps.hz_cust_acct_sites_all hcas,
                               apps.hz_cust_site_uses_all  hcsu
                         WHERE rcta.interface_header_attribute1 = mp.organization_code||'_'||mmt.transaction_reference
                           AND rcta.ship_to_site_use_id         = hcsu.site_use_id
                           AND hcsu.cust_acct_site_id           = hcas.cust_acct_site_id
                           AND hcas.cust_account_id             = hca.cust_account_id
                           AND hca.party_id                     = hp.party_id
                           AND rcta.org_id                      = 4330)
                     ELSE
                        (SELECT listagg(hp.party_name,', ' ON OVERFLOW TRUNCATE)  
                         WITHIN GROUP (ORDER BY hp.party_name asc)
                           FROM apps.hz_parties             hp
                              , apps.hz_cust_accounts       hca
                              , apps.oe_order_lines_all     oola
                              , apps.hz_cust_acct_sites_all hcas
                              , apps.hz_cust_site_uses_all  hcsu
                          WHERE oola.line_id                = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                            AND oola.ship_to_org_id         = hcsu.site_use_id
                            AND hcsu.cust_acct_site_id      = hcas.cust_acct_site_id
                            AND hcas.cust_account_id        = hca.cust_account_id
                            AND hca.party_id                = hp.party_id )
                    END                 
               END    customer_name
             , CASE WHEN ( SELECT ottl.name
                             FROM apps.oe_transaction_types_tl    ottl
                                , apps.oe_order_headers_all  ooha
                                , apps.oe_order_lines_all    oola  
                            WHERE oola.line_id        = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND oola.header_id      = ooha.header_id
                              AND ooha.order_type_id  = ottl.transaction_type_id  ) = 'GPO_BR_FE_SHIPMENT' THEN
                     (SELECT listagg(hca.account_number,', ' ON OVERFLOW TRUNCATE)  
                      WITHIN GROUP (ORDER BY hca.account_number asc)
                        FROM apps.hz_parties             hp
                           , apps.hz_cust_accounts       hca
                           , apps.oe_order_lines_all     oola
                           , apps.hz_cust_acct_sites_all hcas
                           , apps.hz_cust_site_uses_all  hcsu
                       WHERE oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                         AND oola.end_customer_site_use_id  = hcsu.site_use_id
                         AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                         AND hcas.cust_account_id           = hca.cust_account_id
                         AND hca.party_id                   = hp.party_id )
                  ELSE
                     CASE WHEN (mmt.source_code = '3PL_REMITTANCE_BRAZIL') THEN
                        (SELECT listagg(hca.account_number,', ' ON OVERFLOW TRUNCATE)  
                         WITHIN GROUP (ORDER BY hca.account_number asc)
                           FROM apps.hz_parties             hp,
                                apps.hz_cust_accounts       hca,
                                apps.ra_customer_trx_all    rcta,
                                apps.hz_cust_acct_sites_all hcas,
                                apps.hz_cust_site_uses_all  hcsu
                          WHERE rcta.interface_header_attribute1 = mp.organization_code||'_'||mmt.transaction_reference
                            AND rcta.ship_to_site_use_id         = hcsu.site_use_id
                            AND hcsu.cust_acct_site_id           = hcas.cust_acct_site_id
                            AND hcas.cust_account_id             = hca.cust_account_id
                            AND hca.party_id                     = hp.party_id
                            AND rcta.org_id                      = 4330)
                     ELSE
                        (SELECT listagg(hca.account_number,', ' ON OVERFLOW TRUNCATE)  
                         WITHIN GROUP (ORDER BY hca.account_number asc)
                           FROM apps.hz_parties             hp
                              , apps.hz_cust_accounts       hca
                              , apps.oe_order_lines_all     oola
                              , apps.hz_cust_acct_sites_all hcas
                              , apps.hz_cust_site_uses_all  hcsu
                          WHERE oola.line_id                = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                            AND oola.ship_to_org_id         = hcsu.site_use_id
                            AND hcsu.cust_acct_site_id      = hcas.cust_acct_site_id
                            AND hcas.cust_account_id        = hca.cust_account_id
                            AND hca.party_id                = hp.party_id   )
                     END
                  END   customer_number
                --
              , CASE WHEN ( SELECT ottl.name
                             FROM apps.oe_transaction_types_tl    ottl
                                , apps.oe_order_headers_all  ooha
                                , apps.oe_order_lines_all    oola  
                            WHERE oola.line_id        = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND oola.header_id      = ooha.header_id
                              AND ooha.order_type_id  = ottl.transaction_type_id  ) = 'GPO_BR_FE_SHIPMENT' THEN
                     (SELECT listagg(DECODE(hcas.global_attribute2
                                           , '2',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'/'|| hcas.global_attribute4 ||'-'|| hcas.global_attribute5
                                           , '1',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'-'|| hcas.global_attribute5 
                                           , '3',HCSU.LOCATION||' - '||hcas.global_attribute3 ),', ' ON OVERFLOW TRUNCATE)
                     WITHIN GROUP (ORDER BY hcas.global_attribute2 asc ) 
                        FROM apps.hz_parties             hp
                           , apps.hz_cust_accounts       hca
                           , apps.oe_order_lines_all     oola
                           , apps.hz_cust_acct_sites_all hcas
                           , apps.hz_cust_site_uses_all  hcsu
                       WHERE oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                         AND oola.end_customer_site_use_id  = hcsu.site_use_id
                         AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                         AND hcas.cust_account_id           = hca.cust_account_id
                         AND hca.party_id                   = hp.party_id )
                ELSE
                   CASE WHEN (mmt.source_code = '3PL_REMITTANCE_BRAZIL') THEN
                      (SELECT listagg(DECODE(hcas.global_attribute2
                                           , '2',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'/'|| hcas.global_attribute4 ||'-'|| hcas.global_attribute5
                                           , '1',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'-'|| hcas.global_attribute5 
                                           , '3',HCSU.LOCATION||' - '||hcas.global_attribute3 ),', ' ON OVERFLOW TRUNCATE)
                     WITHIN GROUP (ORDER BY hcas.global_attribute2 asc) 
                         FROM apps.ra_customer_trx_all     rcta
                            , apps.hz_cust_acct_sites_all  hcas
                            , apps.hz_cust_site_uses_all   hcsu
                        WHERE rcta.interface_header_attribute1 = mp.organization_code||'_'||mmt.transaction_reference
                          AND rcta.ship_to_site_use_id         = hcsu.site_use_id
                          AND hcsu.cust_acct_site_id           = hcas.cust_acct_site_id
                          AND rcta.org_id                      = 4330)
                   ELSE
                      (SELECT listagg(DECODE(hcas.global_attribute2
                                           , '2',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'/'|| hcas.global_attribute4 ||'-'|| hcas.global_attribute5
                                           , '1',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'-'|| hcas.global_attribute5 
                                           , '3',HCSU.LOCATION||' - '||hcas.global_attribute3 ),', ' ON OVERFLOW TRUNCATE)
                      WITHIN GROUP (ORDER BY hcas.global_attribute2 asc) 
                         FROM apps.hz_parties             hp
                            , apps.hz_cust_accounts       hca
                            , apps.oe_order_lines_all     oola
                            , apps.hz_cust_acct_sites_all hcas
                            , apps.hz_cust_site_uses_all  hcsu
                        WHERE oola.line_id                = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                          AND oola.ship_to_org_id         = hcsu.site_use_id
                          AND hcsu.cust_acct_site_id      = hcas.cust_acct_site_id
                          AND hcas.cust_account_id        = hca.cust_account_id
                          AND hca.party_id                = hp.party_id  )
                   END
                END  customer_cnpj_cpf
               -- 
              , CASE WHEN (mmt.source_code = '3PL_REMITTANCE_BRAZIL') THEN
                      (SELECT listagg(DECODE(hcas.global_attribute2
                                           , '2',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'/'|| hcas.global_attribute4 ||'-'|| hcas.global_attribute5
                                           , '1',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'-'|| hcas.global_attribute5 
                                           , '3',HCSU.LOCATION||' - '||hcas.global_attribute3 ),', ' ON OVERFLOW TRUNCATE)
                       WITHIN GROUP (ORDER BY hcas.global_attribute2 asc )
                         FROM apps.ra_customer_trx_all         rcta
                            , apps.hz_cust_acct_sites_all      hcas
                            , apps.hz_cust_site_uses_all       hcsu
                        WHERE rcta.interface_header_attribute1 = mp.organization_code||'_'||mmt.transaction_reference
                          AND rcta.bill_to_site_use_id         = hcsu.site_use_id
                          AND hcsu.cust_acct_site_id           = hcas.cust_acct_site_id
                          AND rcta.org_id                      = 4330
                          AND ROWNUM = 1)
                   ELSE
                     --
                     CASE WHEN (select DISTINCT RCTL.INTERFACE_LINE_CONTEXT
                             FROM apps.hz_parties                hp
                                , apps.hz_cust_accounts          hca
                                , apps.oe_order_lines_all        oola
                                , apps.oe_order_headers_all      ooha
                                , apps.ra_customer_trx_lines_all rctl
                                , apps.ra_customer_trx_all       rcta
                                , apps.hz_cust_acct_sites_all    hcas
                                , apps.hz_cust_site_uses_all     hcsu
                            WHERE ooha.header_id                 = oola.header_id
                              AND oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND rctl.inventory_item_id         = oola.inventory_item_id
                              AND rctl.line_type                 = 'LINE'
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE1 = to_char(ooha.order_number)
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE6 = to_char(oola.line_id)
                              AND RCTL.INTERFACE_LINE_CONTEXT    = 'ORDER ENTRY'
                              AND rctl.customer_trx_id           = rcta.customer_trx_id
                              AND rcta.bill_to_site_use_id       = hcsu.site_use_id
                              AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                              AND hcas.cust_account_id           = hca.cust_account_id
                              AND hca.party_id                   = hp.party_id 
                              AND ROWNUM = 1) = 'ORDER ENTRY' THEN
                     --
                     (SELECT DISTINCT DECODE(hcas.global_attribute2
                                           , '2',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'/'|| hcas.global_attribute4 ||'-'|| hcas.global_attribute5
                                           , '1',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'-'|| hcas.global_attribute5 
                                           , '3',HCSU.LOCATION||' - '||hcas.global_attribute3)
                             FROM apps.hz_parties                hp
                                , apps.hz_cust_accounts          hca
                                , apps.oe_order_lines_all        oola
                                , apps.oe_order_headers_all      ooha
                                , apps.ra_customer_trx_lines_all rctl
                                , apps.ra_customer_trx_all       rcta
                                , apps.hz_cust_acct_sites_all    hcas
                                , apps.hz_cust_site_uses_all     hcsu
                            WHERE ooha.header_id                 = oola.header_id
                              AND oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND rctl.inventory_item_id         = oola.inventory_item_id
                              AND rctl.line_type                 = 'LINE'
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE1 = to_char(ooha.order_number)
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE6 = to_char(oola.line_id)
                              AND RCTL.INTERFACE_LINE_CONTEXT    = 'ORDER ENTRY'
                              AND rctl.customer_trx_id           = rcta.customer_trx_id
                              AND rcta.bill_to_site_use_id       = hcsu.site_use_id
                              AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                              AND hcas.cust_account_id           = hca.cust_account_id
                              AND hca.party_id                   = hp.party_id
                              AND ROWNUM = 1)
                     --
                     ELSE
                     --            
                     CASE WHEN 
                          ( SELECT DISTINCT RCTL.INTERFACE_LINE_CONTEXT
                             FROM apps.hz_parties                hp
                                , apps.hz_cust_accounts          hca
                                , apps.oe_order_lines_all        oola
                                , apps.oe_order_headers_all      ooha
                                , apps.ra_customer_trx_lines_all rctl
                                , apps.ra_customer_trx_all       rcta
                                , apps.hz_cust_acct_sites_all    hcas
                                , apps.hz_cust_site_uses_all     hcsu
                            WHERE ooha.header_id                 = oola.header_id
                              AND oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND rctl.inventory_item_id         = oola.inventory_item_id
                              AND rctl.line_type                 = 'LINE'
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE1 = ooha.ORIG_SYS_DOCUMENT_REF
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE7 = oola.ORIG_SYS_LINE_REF
                              AND RCTL.INTERFACE_LINE_CONTEXT    = 'GEMS_PB_RR'
                              AND rctl.customer_trx_id           = rcta.customer_trx_id
                              AND rcta.bill_to_site_use_id       = hcsu.site_use_id
                              AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                              AND hcas.cust_account_id           = hca.cust_account_id
                              AND ROWNUM = 1 ) = 'GEMS_PB_RR' THEN
                     --
                     (SELECT DISTINCT DECODE(hcas.global_attribute2
                                           , '2',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'/'|| hcas.global_attribute4 ||'-'|| hcas.global_attribute5
                                           , '1',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'-'|| hcas.global_attribute5 
                                           , '3',HCSU.LOCATION||' - '||hcas.global_attribute3)
                             FROM apps.hz_parties                hp
                                , apps.hz_cust_accounts          hca
                                , apps.oe_order_lines_all        oola
                                , apps.oe_order_headers_all      ooha
                                , apps.ra_customer_trx_lines_all rctl
                                , apps.ra_customer_trx_all       rcta
                                , apps.hz_cust_acct_sites_all    hcas
                                , apps.hz_cust_site_uses_all     hcsu
                            WHERE ooha.header_id                 = oola.header_id
                              AND oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND rctl.inventory_item_id         = oola.inventory_item_id
                              AND rctl.line_type                 = 'LINE'
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE1 = ooha.ORIG_SYS_DOCUMENT_REF
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE7 = oola.ORIG_SYS_LINE_REF
                              AND RCTL.INTERFACE_LINE_CONTEXT    = 'GEMS_PB_RR'
                              AND rctl.customer_trx_id           = rcta.customer_trx_id
                              AND rcta.bill_to_site_use_id       = hcsu.site_use_id
                              AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                              AND hcas.cust_account_id           = hca.cust_account_id 
                              AND ROWNUM = 1 )
                     --
                     ELSE
                     --
                     (SELECT DISTINCT DECODE(hcas.global_attribute2
                                   , '2',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'/'|| hcas.global_attribute4 ||'-'|| hcas.global_attribute5
                                   , '1',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'-'|| hcas.global_attribute5 
                                   , '3',HCSU.LOCATION||' - '||hcas.global_attribute3)
                             --
                      FROM   APPS.HZ_CUST_ACCT_SITES_ALL HCAS,
                             APPS.HZ_CUST_SITE_USES_ALL  HCSU,
                             APPS.OE_ORDER_LINES_ALL     OOLA,
                             APPS.OE_ORDER_HEADERS_ALL   OOHA
                             --
                      WHERE  HCSU.SITE_USE_CODE     = 'BILL_TO'
                      AND    HCSU.CUST_ACCT_SITE_ID = HCAS.CUST_ACCT_SITE_ID
                      AND    HCSU.SITE_USE_ID       = NVL(OOLA.ATTRIBUTE1, OOHA.INVOICE_TO_ORG_ID)
                      AND    OOLA.LINE_ID           = NVL(MMT.TRX_SOURCE_LINE_ID, MMT.SOURCE_LINE_ID)
                      AND    OOHA.HEADER_ID         = OOLA.HEADER_ID
                      AND    ROWNUM = 1)
                     --
                     END
                  END
               END      bill_to_CNPJ_CPF
               --
              , CASE WHEN (mmt.source_code = '3PL_REMITTANCE_BRAZIL') THEN
                        (SELECT listagg(hp.party_name,', ' ON OVERFLOW TRUNCATE)  
                        WITHIN GROUP (ORDER BY hp.party_name asc)
                          FROM apps.hz_parties             hp,
                               apps.hz_cust_accounts       hca,
                               apps.ra_customer_trx_all    rcta,
                               apps.hz_cust_acct_sites_all hcas,
                               apps.hz_cust_site_uses_all  hcsu
                         WHERE rcta.interface_header_attribute1 = mp.organization_code||'_'||mmt.transaction_reference
                           AND rcta.bill_to_site_use_id         = hcsu.site_use_id
                           AND hcsu.cust_acct_site_id           = hcas.cust_acct_site_id
                           AND hcas.cust_account_id             = hca.cust_account_id
                           AND hca.party_id                     = hp.party_id
                           AND rcta.org_id                      = 4330)
                   ELSE
                     --
                     CASE WHEN (select DISTINCT RCTL.INTERFACE_LINE_CONTEXT
                             FROM apps.hz_parties                hp
                                , apps.hz_cust_accounts          hca
                                , apps.oe_order_lines_all        oola
                                , apps.oe_order_headers_all      ooha
                                , apps.ra_customer_trx_lines_all rctl
                                , apps.ra_customer_trx_all       rcta
                                , apps.hz_cust_acct_sites_all    hcas
                                , apps.hz_cust_site_uses_all     hcsu
                            WHERE ooha.header_id                 = oola.header_id
                              AND oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND rctl.inventory_item_id         = oola.inventory_item_id
                              AND rctl.line_type                 = 'LINE'
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE1 = to_char(ooha.order_number)
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE6 = to_char(oola.line_id)
                              AND RCTL.INTERFACE_LINE_CONTEXT    = 'ORDER ENTRY'
                              AND rctl.customer_trx_id           = rcta.customer_trx_id
                              AND rcta.bill_to_site_use_id       = hcsu.site_use_id
                              AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                              AND hcas.cust_account_id           = hca.cust_account_id
                              AND hca.party_id                   = hp.party_id 
                              AND ROWNUM = 1) = 'ORDER ENTRY' THEN
                     --
                     (SELECT listagg(hp.party_name,', ' ON OVERFLOW TRUNCATE)  
                         WITHIN GROUP (ORDER BY hp.party_name asc)
                             FROM apps.hz_parties                hp
                                , apps.hz_cust_accounts          hca
                                , apps.oe_order_lines_all        oola
                                , apps.oe_order_headers_all      ooha
                                , apps.ra_customer_trx_lines_all rctl
                                , apps.ra_customer_trx_all       rcta
                                , apps.hz_cust_acct_sites_all    hcas
                                , apps.hz_cust_site_uses_all     hcsu
                            WHERE ooha.header_id                 = oola.header_id
                              AND oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND rctl.inventory_item_id         = oola.inventory_item_id
                              AND rctl.line_type                 = 'LINE'
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE1 = to_char(ooha.order_number)
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE6 = to_char(oola.line_id)
                              AND RCTL.INTERFACE_LINE_CONTEXT    = 'ORDER ENTRY'
                              AND rctl.customer_trx_id           = rcta.customer_trx_id
                              AND rcta.bill_to_site_use_id       = hcsu.site_use_id
                              AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                              AND hcas.cust_account_id           = hca.cust_account_id
                              AND hca.party_id                   = hp.party_id
                              AND ROWNUM = 1)
                     --
                     ELSE
                     --            
                     CASE WHEN 
                          ( SELECT DISTINCT RCTL.INTERFACE_LINE_CONTEXT
                             FROM apps.hz_parties                hp
                                , apps.hz_cust_accounts          hca
                                , apps.oe_order_lines_all        oola
                                , apps.oe_order_headers_all      ooha
                                , apps.ra_customer_trx_lines_all rctl
                                , apps.ra_customer_trx_all       rcta
                                , apps.hz_cust_acct_sites_all    hcas
                                , apps.hz_cust_site_uses_all     hcsu
                            WHERE ooha.header_id                 = oola.header_id
                              AND oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND rctl.inventory_item_id         = oola.inventory_item_id
                              AND rctl.line_type                 = 'LINE'
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE1 = ooha.ORIG_SYS_DOCUMENT_REF
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE7 = oola.ORIG_SYS_LINE_REF
                              AND RCTL.INTERFACE_LINE_CONTEXT    = 'GEMS_PB_RR'
                              AND rctl.customer_trx_id           = rcta.customer_trx_id
                              AND rcta.bill_to_site_use_id       = hcsu.site_use_id
                              AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                              AND hcas.cust_account_id           = hca.cust_account_id
                              AND ROWNUM = 1 ) = 'GEMS_PB_RR' THEN
                     --
                     (SELECT listagg(hp.party_name,', ' ON OVERFLOW TRUNCATE)  
                         WITHIN GROUP (ORDER BY hp.party_name asc)
                             FROM apps.hz_parties                hp
                                , apps.hz_cust_accounts          hca
                                , apps.oe_order_lines_all        oola
                                , apps.oe_order_headers_all      ooha
                                , apps.ra_customer_trx_lines_all rctl
                                , apps.ra_customer_trx_all       rcta
                                , apps.hz_cust_acct_sites_all    hcas
                                , apps.hz_cust_site_uses_all     hcsu
                            WHERE ooha.header_id                 = oola.header_id
                              AND oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND rctl.inventory_item_id         = oola.inventory_item_id
                              AND rctl.line_type                 = 'LINE'
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE1 = ooha.ORIG_SYS_DOCUMENT_REF
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE7 = oola.ORIG_SYS_LINE_REF
                              AND RCTL.INTERFACE_LINE_CONTEXT    = 'GEMS_PB_RR'
                              AND rctl.customer_trx_id           = rcta.customer_trx_id
                              AND rcta.bill_to_site_use_id       = hcsu.site_use_id
                              AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                              AND hcas.cust_account_id           = hca.cust_account_id 
                              AND ROWNUM = 1 )
                     --
                     ELSE
                     --
                     (SELECT listagg(hp.party_name,', ' ON OVERFLOW TRUNCATE)  
                         WITHIN GROUP (ORDER BY hp.party_name asc)
                      FROM   APPS.HZ_CUST_ACCT_SITES_ALL HCAS,
                             apps.hz_parties             hp,
                             apps.hz_cust_accounts       hca,
                             APPS.HZ_CUST_SITE_USES_ALL  HCSU,
                             APPS.OE_ORDER_LINES_ALL     OOLA,
                             APPS.OE_ORDER_HEADERS_ALL   OOHA
                             --
                      WHERE  HCSU.SITE_USE_CODE     = 'BILL_TO'
                      AND    HCSU.CUST_ACCT_SITE_ID = HCAS.CUST_ACCT_SITE_ID
                      AND    HCSU.SITE_USE_ID       = NVL(OOLA.ATTRIBUTE1, OOHA.INVOICE_TO_ORG_ID)
                      AND    OOLA.LINE_ID           = NVL(MMT.TRX_SOURCE_LINE_ID, MMT.SOURCE_LINE_ID)
                      AND    OOHA.HEADER_ID         = OOLA.HEADER_ID
                      AND    hcas.cust_account_id   = hca.cust_account_id
                      AND    hca.party_id           = hp.party_id 
                      AND    ROWNUM = 1)
                     --          
                     END
                  END
               END      bill_to_Customer_name
               --
               , CASE WHEN (mmt.source_code = '3PL_REMITTANCE_BRAZIL') THEN
                      (SELECT listagg(DECODE(hcas.global_attribute2
                                           , '2',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'/'|| hcas.global_attribute4 ||'-'|| hcas.global_attribute5
                                           , '1',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'-'|| hcas.global_attribute5 
                                           , '3',HCSU.LOCATION||' - '||hcas.global_attribute3 ),', ' ON OVERFLOW TRUNCATE)
                       WITHIN GROUP (ORDER BY hcas.global_attribute2 asc )
                         FROM apps.ra_customer_trx_all         rcta
                            , apps.hz_cust_acct_sites_all      hcas
                            , apps.hz_cust_site_uses_all       hcsu
                        WHERE rcta.interface_header_attribute1 = mp.organization_code||'_'||mmt.transaction_reference
                          AND rcta.ship_to_site_use_id         = hcsu.site_use_id
                          AND hcsu.cust_acct_site_id           = hcas.cust_acct_site_id
                          AND rcta.org_id                      = 4330
                          AND ROWNUM = 1)
                   ELSE
                     --
                     CASE WHEN (select DISTINCT RCTL.INTERFACE_LINE_CONTEXT
                             FROM apps.hz_parties                hp
                                , apps.hz_cust_accounts          hca
                                , apps.oe_order_lines_all        oola
                                , apps.oe_order_headers_all      ooha
                                , apps.ra_customer_trx_lines_all rctl
                                , apps.ra_customer_trx_all       rcta
                                , apps.hz_cust_acct_sites_all    hcas
                                , apps.hz_cust_site_uses_all     hcsu
                            WHERE ooha.header_id                 = oola.header_id
                              AND oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND rctl.inventory_item_id         = oola.inventory_item_id
                              AND rctl.line_type                 = 'LINE'
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE1 = to_char(ooha.order_number)
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE6 = to_char(oola.line_id)
                              AND RCTL.INTERFACE_LINE_CONTEXT    = 'ORDER ENTRY'
                              AND rctl.customer_trx_id           = rcta.customer_trx_id
                              AND rcta.ship_to_site_use_id       = hcsu.site_use_id
                              AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                              AND hcas.cust_account_id           = hca.cust_account_id
                              AND hca.party_id                   = hp.party_id 
                              AND ROWNUM = 1) = 'ORDER ENTRY' THEN
                     --
                     (SELECT DISTINCT DECODE(hcas.global_attribute2
                                           , '2',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'/'|| hcas.global_attribute4 ||'-'|| hcas.global_attribute5
                                           , '1',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'-'|| hcas.global_attribute5 
                                           , '3',HCSU.LOCATION||' - '||hcas.global_attribute3)
                             FROM apps.hz_parties                hp
                                , apps.hz_cust_accounts          hca
                                , apps.oe_order_lines_all        oola
                                , apps.oe_order_headers_all      ooha
                                , apps.ra_customer_trx_lines_all rctl
                                , apps.ra_customer_trx_all       rcta
                                , apps.hz_cust_acct_sites_all    hcas
                                , apps.hz_cust_site_uses_all     hcsu
                            WHERE ooha.header_id                 = oola.header_id
                              AND oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND rctl.inventory_item_id         = oola.inventory_item_id
                              AND rctl.line_type                 = 'LINE'
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE1 = to_char(ooha.order_number)
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE6 = to_char(oola.line_id)
                              AND RCTL.INTERFACE_LINE_CONTEXT    = 'ORDER ENTRY'
                              AND rctl.customer_trx_id           = rcta.customer_trx_id
                              AND rcta.ship_to_site_use_id       = hcsu.site_use_id
                              AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                              AND hcas.cust_account_id           = hca.cust_account_id
                              AND hca.party_id                   = hp.party_id
                              AND ROWNUM = 1)
                     --
                     ELSE
                     --            
                     CASE WHEN 
                          ( SELECT DISTINCT RCTL.INTERFACE_LINE_CONTEXT
                             FROM apps.hz_parties                hp
                                , apps.hz_cust_accounts          hca
                                , apps.oe_order_lines_all        oola
                                , apps.oe_order_headers_all      ooha
                                , apps.ra_customer_trx_lines_all rctl
                                , apps.ra_customer_trx_all       rcta
                                , apps.hz_cust_acct_sites_all    hcas
                                , apps.hz_cust_site_uses_all     hcsu
                            WHERE ooha.header_id                 = oola.header_id
                              AND oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND rctl.inventory_item_id         = oola.inventory_item_id
                              AND rctl.line_type                 = 'LINE'
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE1 = ooha.ORIG_SYS_DOCUMENT_REF
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE7 = oola.ORIG_SYS_LINE_REF
                              AND RCTL.INTERFACE_LINE_CONTEXT    = 'GEMS_PB_RR'
                              AND rctl.customer_trx_id           = rcta.customer_trx_id
                              AND rcta.ship_to_site_use_id       = hcsu.site_use_id
                              AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                              AND hcas.cust_account_id           = hca.cust_account_id
                              AND ROWNUM = 1 ) = 'GEMS_PB_RR' THEN
                     --
                     (SELECT DISTINCT DECODE(hcas.global_attribute2
                                           , '2',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'/'|| hcas.global_attribute4 ||'-'|| hcas.global_attribute5
                                           , '1',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'-'|| hcas.global_attribute5 
                                           , '3',HCSU.LOCATION||' - '||hcas.global_attribute3)
                             FROM apps.hz_parties                hp
                                , apps.hz_cust_accounts          hca
                                , apps.oe_order_lines_all        oola
                                , apps.oe_order_headers_all      ooha
                                , apps.ra_customer_trx_lines_all rctl
                                , apps.ra_customer_trx_all       rcta
                                , apps.hz_cust_acct_sites_all    hcas
                                , apps.hz_cust_site_uses_all     hcsu
                            WHERE ooha.header_id                 = oola.header_id
                              AND oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND rctl.inventory_item_id         = oola.inventory_item_id
                              AND rctl.line_type                 = 'LINE'
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE1 = ooha.ORIG_SYS_DOCUMENT_REF
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE7 = oola.ORIG_SYS_LINE_REF
                              AND RCTL.INTERFACE_LINE_CONTEXT    = 'GEMS_PB_RR'
                              AND rctl.customer_trx_id           = rcta.customer_trx_id
                              AND rcta.ship_to_site_use_id       = hcsu.site_use_id
                              AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                              AND hcas.cust_account_id           = hca.cust_account_id 
                              AND ROWNUM = 1 )
                     --
                     ELSE
                     --
                     (SELECT listagg(DECODE(hcas.global_attribute2
                                           , '2',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'/'|| hcas.global_attribute4 ||'-'|| hcas.global_attribute5
                                           , '1',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'-'|| hcas.global_attribute5 
                                           , '3',HCSU.LOCATION||' - '||hcas.global_attribute3 ),', ' ON OVERFLOW TRUNCATE)
                      WITHIN GROUP (ORDER BY hcas.global_attribute2 asc) 
                         FROM apps.hz_parties             hp
                            , apps.hz_cust_accounts       hca
                            , apps.oe_order_lines_all     oola
                            , apps.hz_cust_acct_sites_all hcas
                            , apps.hz_cust_site_uses_all  hcsu
                        WHERE oola.line_id                = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                          AND oola.ship_to_org_id         = hcsu.site_use_id
                          AND hcsu.cust_acct_site_id      = hcas.cust_acct_site_id
                          AND hcas.cust_account_id        = hca.cust_account_id
                          AND hca.party_id                = hp.party_id  )
                     --
                     END
                  END
               END      ship_to_CNPJ_CPF
               --
              , CASE WHEN ( SELECT ottl.name
                              FROM apps.oe_transaction_types_tl    ottl
                                 , apps.oe_order_headers_all  ooha
                                 , apps.oe_order_lines_all    oola  
                             WHERE oola.line_id        = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                               AND oola.header_id      = ooha.header_id
                               AND ooha.order_type_id  = ottl.transaction_type_id  ) = 'GPO_BR_FE_SHIPMENT' THEN
                      (SELECT listagg(hzl.address1 ||' - '|| hzl.address2 || ' - ' || hzl.city || '-' || hzl.state || ' / ' || hzl.postal_code,', ' ON OVERFLOW TRUNCATE)  
                       WITHIN GROUP (ORDER BY hzl.address1 asc)
                       FROM apps.hz_parties             hp
                        , apps.hz_party_sites         hps
                        , apps.hz_cust_accounts       hca
                        , apps.oe_order_lines_all     oola
                        , apps.hz_cust_acct_sites_all hcas
                        , apps.hz_cust_site_uses_all  hcsu
                        , apps.hz_locations           hzl
                    WHERE oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                      AND oola.end_customer_site_use_id  = hcsu.site_use_id
                      AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                      AND hcas.cust_account_id           = hca.cust_account_id
                      AND hcas.party_site_id             = hps.party_site_id
                      AND hca.party_id                   = hp.party_id
                      AND hps.party_id                   = hp.party_id
                      AND hps.location_id                = hzl.location_id)
                ELSE
                   CASE WHEN (mmt.source_code = '3PL_REMITTANCE_BRAZIL') THEN
                      (SELECT listagg(hzl.address1 ||' - '|| hzl.address2 || ' - ' || hzl.city || '-' || hzl.state || ' / ' || hzl.postal_code,', ' ON OVERFLOW TRUNCATE)  
                       WITHIN GROUP (ORDER BY hzl.address1 asc)
                         FROM apps.ra_customer_trx_all     rcta
                            , apps.hz_cust_acct_sites_all  hcas
                            , apps.hz_cust_site_uses_all   hcsu
                            , apps.hz_parties              hp
                            , apps.hz_party_sites          hps
                            , apps.hz_cust_accounts        hca
                            , apps.hz_locations            hzl
                        WHERE rcta.interface_header_attribute1 = mp.organization_code||'_'||mmt.transaction_reference
                          AND rcta.ship_to_site_use_id         = hcsu.site_use_id
                          AND hcsu.cust_acct_site_id           = hcas.cust_acct_site_id
                          AND hcas.cust_account_id             = hca.cust_account_id
                         AND hcas.party_site_id               = hps.party_site_id
                          AND hca.party_id                     = hp.party_id
                          AND hps.party_id                     = hp.party_id
                          AND hps.location_id                  = hzl.location_id
                          AND rcta.org_id                      = 4330)
                   ELSE
                      (SELECT listagg(hzl.address1 ||' - '|| hzl.address2 || ' - ' || hzl.city || '-' || hzl.state || ' / ' || hzl.postal_code,', ' ON OVERFLOW TRUNCATE)  
                       WITHIN GROUP (ORDER BY hzl.address1 asc)
                          FROM apps.hz_parties             hp
                             , apps.hz_party_sites         hps
                             , apps.hz_cust_accounts       hca
                             , apps.oe_order_lines_all     oola
                             , apps.hz_cust_acct_sites_all hcas
                             , apps.hz_cust_site_uses_all  hcsu
                             , apps.hz_locations           hzl
                         WHERE oola.line_id                = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                           AND oola.ship_to_org_id         = hcsu.site_use_id
                           AND hcsu.cust_acct_site_id      = hcas.cust_acct_site_id
                           AND hcas.cust_account_id        = hca.cust_account_id
                           AND hcas.party_site_id          = hps.party_site_id
                           AND hca.party_id                = hp.party_id
                           AND hps.party_id                = hp.party_id
                           AND hps.location_id             = hzl.location_id   )
                   END
                END customer_address
                -- 
                -- alterado para BIll_to por Sinval fim
                --
                , CASE WHEN (mmt.source_code = '3PL_REMITTANCE_BRAZIL') THEN
                    (SELECT distinct RTRIM(REGEXP_REPLACE((listagg(rcta.trx_number,', ' ON OVERFLOW TRUNCATE)  
                     WITHIN GROUP (ORDER BY rcta.trx_number asc) ), '([^,]*)(,\1)+($|,)', '\1\3'),',')
                       FROM apps.ra_customer_trx_all       rcta
                      WHERE rcta.interface_header_attribute1  = mp.organization_code||'_'||mmt.transaction_reference
                        AND rcta.org_id                       = 4330
                        AND trunc(rcta.trx_date)              BETWEEN (trunc(mmt.transaction_date)-3) AND (trunc(mmt.transaction_date)+3)
                        AND NVL(rcta.status_trx,'XX')         <> 'VD'
                        AND NVL(rcta.reason_code,'XX')        <> 'CANCELLATION')
                ELSE
                    (SELECT distinct RTRIM(REGEXP_REPLACE((listagg(rcta.trx_number,', ' ON OVERFLOW TRUNCATE)  
                     WITHIN GROUP (ORDER BY rcta.trx_number asc) ), '([^,]*)(,\1)+($|,)', '\1\3'),',')
                       FROM apps.ra_customer_trx_lines_all rctla
                          , apps.ra_customer_trx_all       rcta
                          , apps.oe_order_lines_all        oola
                          , apps.oe_order_headers_all      ooha
                      WHERE rcta.customer_trx_id              = rctla.customer_trx_id
                        AND oola.line_id                      = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                        AND oola.header_id                    = ooha.header_id
                        AND rctla.sales_order                 = to_char(ooha.order_number)
                        AND rctla.line_type                   = 'LINE'
                        AND rcta.batch_source_id              <> 6266 -- No RR invoices
                        AND DECODE(rctla.interface_line_context,'GEMS_PB_RR',rcta.interface_header_attribute11,'999')
                            = DECODE(rctla.interface_line_context,'GEMS_PB_RR',rcta.interface_header_attribute11,'999')
                        AND rcta.org_id                       = 4330
                        AND trunc(rcta.trx_date)              BETWEEN (trunc(mmt.transaction_date)-3) AND (trunc(mmt.transaction_date)+3)
                        AND NVL(rcta.status_trx,'XX')         <> 'VD'
                        AND NVL(rcta.reason_code,'XX')        <> 'CANCELLATION')   
                END   invoice_number_ar
              , ( SELECT listagg(mrav.reservation_quantity,', ' ON OVERFLOW TRUNCATE)  
                  WITHIN GROUP (ORDER BY mrav.reservation_quantity asc)
                    FROM apps.mtl_reservations_all_v  mrav 
                       , apps.oe_order_headers_all    ooha1
                   WHERE mrav.demand_source_header_id     = ooha1.header_id
                     AND mrav.demand_source_line_id       = NVL(mmt.trx_source_line_id, mmt.source_line_id) )  reservation_quantity
              , ( SELECT listagg(ooha1.order_number,', ' ON OVERFLOW TRUNCATE)  
                  WITHIN GROUP (ORDER BY ooha1.order_number asc) 
                    FROM apps.mtl_reservations_all_v  mrav 
                       , apps.oe_order_headers_all    ooha1
                   WHERE mrav.demand_source_header_id     = ooha1.header_id
                     AND mrav.demand_source_line_id       = NVL(mmt.trx_source_line_id, mmt.source_line_id) )  reservation_order_number
              , (SELECT distinct hp.party_name
                 --WITHIN GROUP (ORDER BY hp.party_name asc)
                   FROM apps.hz_parties              hp
                      , apps.hz_cust_accounts        hca
                      , apps.oe_order_lines_all      oola1
                      , apps.oe_order_headers_all    ooha1
                      , apps.mtl_reservations_all_v  mrav 
                  WHERE mrav.demand_source_header_id   = ooha1.header_id
                    AND mrav.demand_source_line_id     = oola1.line_id
                    AND oola1.line_id                  = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                    AND oola1.ship_to_org_id           = hca.cust_account_id
                    AND hca.party_id                   = hp.party_id )         reservation_customer_name 
              , gcc1.concatenated_segments   material_account
              , gcc2.concatenated_segments   outside_processing_account
              , gcc3.concatenated_segments   material_overhead_account
              , gcc4.concatenated_segments   overhead_account
              , gcc5.concatenated_segments   resource_account
              , sysdate                                           report_date_and_time 
              , to_char(msn.last_transaction_id)                  transaction_id
              , fu.user_name ||' / '|| fu.description             user_name
              , DECODE( lot_control_code, 1 ,'Sem controle de Lote' , 2,'Com controle de Lote')   lot_control
              , DECODE( serial_number_control_code, 1, 'Sem controle de Serial'
                                                  , 2, 'Pre-definido'
                                                  , 5, 'No Recebimento'
                                                  , 6, 'Baixa na Ordem de Venda' )  serial_control
              , CASE
                 WHEN    nvl(mmt.lpn_id, mmt.content_lpn_id) IS NULL AND moq.subinventory_code <> 'WHGU42GNAT'
                   THEN
                    (SELECT listagg(lpn.license_plate_number,', ' ON OVERFLOW TRUNCATE)WITHIN GROUP (ORDER BY lpn.license_plate_number asc)
                             FROM apps.MTL_MATERIAL_TRANSACTIONS   mtt,
                                  apps.wms_license_plate_numbers   lpn,
                                  apps.oe_order_lines_all          ool
                            WHERE 1 = 1
                              AND mtt.TRX_SOURCE_LINE_ID = CASE
                                                              WHEN LINE_CATEGORY_CODE = 'ORDER'
                                                                THEN ool.line_id
                                                              WHEN LINE_CATEGORY_CODE = 'RETURN'  
                                                                THEN   
                                                                to_number(NVL(SUBSTR(ool.ORIG_SYS_LINE_REF,
                                                                                     0,
                                                                                     INSTR(ool.ORIG_SYS_LINE_REF, '.') - 1),
                                                                              -1)) -- RMA FE OE Line Id
                                                                ELSE -1
                                                                  END
                              AND mtt.TRANSACTION_TYPE_ID = 52 --sales order pick FE ORDER
                              AND mtt.transaction_quantity < 0
                              AND mtt.inventory_item_id = ool.inventory_item_id
                              AND nvl(mtt.lpn_id, mtt.content_lpn_id) = nvl(lpn.lpn_id, -1)
                              AND ool.line_id = CASE
                                                  WHEN mtt.transaction_type_name = 'RMA Receipt'
                                                    THEN mmt.TRX_SOURCE_LINE_ID
                                                  WHEN mtt.transaction_type_name = 'GPO Nationalization Receipt'
                                                     THEN 
                                                      to_number(NVL(SUBSTR(RTRIM(LTRIM(translate(mmt.TRANSACTION_REFERENCE,translate(mmt.TRANSACTION_REFERENCE||'a','1234567890.',' '),' '))),
                                                         0,
                                                         INSTR(RTRIM(LTRIM(translate(mmt.TRANSACTION_REFERENCE,translate(mmt.TRANSACTION_REFERENCE||'a','1234567890.',' '),' '))), '.') - 1),
                                                  -1))
                                                  ELSE -1
                                                    END)
                              WHEN moq.subinventory_code = 'WHGU42GNAT'
                  THEN (SELECT listagg(wlp.license_plate_number,', ' ON OVERFLOW TRUNCATE)  
                            WITHIN GROUP (ORDER BY wlp.license_plate_number asc)
                        FROM   gems_ont.ge_gpo_nationalization_line gnl, 
                               gems_ont.ge_gpo_nationalization_line gn2,
                               apps.wms_license_plate_numbers       wlp,
                               apps.po_line_locations_all           pll,
                               apps.po_lines_all                    pol,
                               apps.po_headers_all                  poh,
                               apps.rcv_shipment_headers            rsh,
                               apps.rcv_transactions                rt
                        Where  wlp.lpn_id(+) = gn2.lpn_id
                        AND gnl.nationalization_so_line_id = gn2.nationalization_so_line_id
                        AND pll.line_location_id = gnl.DOCUMENT_ID
                        AND pll.po_header_id = poh.po_header_id
                        AND pll.po_line_id = pol.po_line_id
                        AND gn2.record_type = 'IMPORT'
                        AND gnl.record_type = 'NATIONALIZATION'
                        AND rt.transaction_id                = mmt.rcv_transaction_id
                        AND rt.po_line_location_id           = pll.line_location_id
                        AND rt.shipment_header_id            = rsh.shipment_header_id)
                ELSE (SELECT lpn.LICENSE_PLATE_NUMBER
                           FROM   apps.wms_license_plate_numbers   lpn
                           WHERE  nvl(mmt.lpn_id, mmt.content_lpn_id) = nvl(lpn.lpn_id, -1))
                        END LPN_Value                                    
              , 'q17' query 
--, mmt.transaction_type_id
--, mmt.trx_source_line_id
--, mmt.source_line_id
           FROM apps.mtl_serial_numbers              msn  
              , apps.mtl_parameters                  mp
              , apps.mtl_system_items_b              msi
              , apps.mtl_item_locations_kfv          milk
              , apps.gl_code_combinations            gcc
              , apps.gl_code_combinations_kfv        gcc1
              , apps.gl_code_combinations_kfv        gcc2
              , apps.gl_code_combinations_kfv        gcc3
              , apps.gl_code_combinations_kfv        gcc4
              , apps.gl_code_combinations_kfv        gcc5
              , apps.mtl_material_transactions       mmt
              , apps.mtl_transaction_types           mtt
              , apps.mtl_txn_source_types            mtst
              , apps.fnd_flex_values_vl              ffvv
              , apps.mtl_secondary_inventories_fk_v  msifv
              , apps.fnd_flex_value_sets             ffvs
              , apps.fnd_user                        fu
              , ( SELECT organization_id
                       , inventory_item_id
                       , subinventory_code
                       , locator_id
                       , lot_number
                       --, update_transaction_id
                       --, transaction_uom_code
                       , SUM (primary_transaction_quantity)  onhand_qty
                    FROM apps.mtl_onhand_quantities_detail
                   WHERE organization_id IN ( SELECT ood.ORGANIZATION_id FROM apps.org_organization_definitions ood WHERE ood.SET_OF_BOOKS_ID = 230 )
                GROUP BY organization_id
                       , inventory_item_id
                       , subinventory_code
                       , locator_id
                 --      , revision
                       , lot_number
                       --, update_transaction_id
                       --, transaction_uom_code
                       ) moq
                       ,APPS.MTL_PAC_ACTUAL_COST_DETAILS MPACD 
          WHERE 1                                = 1
          AND decode(mmt.periodic_primary_quantity,null,mmt.transfer_transaction_id,MMT.TRANSACTION_ID) = MPACD.TRANSACTION_ID  
            AND mp.organization_id               = msi.organization_id
--            AND msi.segment1 = '60510302'
           AND msifv.organization_id            = msi.organization_id
            AND msifv.secondary_inventory_name   = moq.subinventory_code
            AND msifv.material_account           = gcc1.code_combination_id
            AND msifv.outside_processing_account = gcc2.code_combination_id
            AND msifv.material_overhead_account  = gcc3.code_combination_id
            AND msifv.overhead_account           = gcc4.code_combination_id
            AND msifv.resource_account           = gcc5.code_combination_id
            AND msi.cost_of_sales_account        = gcc.code_combination_id
            AND ffvs.flex_value_set_name         = 'GE_GL_AFF_ES_PRODUCT_LINE'
            AND ffvs.flex_value_set_id           = ffvv.flex_value_set_id
            AND ffvv.flex_value_meaning          = gcc.segment8
            AND 'TYPE 1'                        IN ('TYPE 1')
            AND msi.organization_id             IN ( SELECT ood.organization_id FROM apps.org_organization_definitions ood WHERE ood.SET_OF_BOOKS_ID = 230 )
            AND moq.inventory_item_id            = msn.inventory_item_id         (+) --mmt.inventory_item_id (+)   
            AND moq.organization_id              = msn.current_organization_id   (+) --mmt.organization_id   (+)   
            AND moq.subinventory_code            = msn.current_subinventory_code (+) --mmt.subinventory_code (+)   
            AND moq.locator_id                   = msn.current_locator_id        (+) --mmt.locator_id        (+)   
            AND msn.current_status           (+) = 3                 
            AND moq.lot_number                   = msn.lot_number (+)
            AND moq.inventory_item_id            = msi.inventory_item_id
            AND moq.locator_id                   = milk.inventory_location_id
            AND moq.organization_id              = mp.organization_id
            AND msn.last_transaction_id          = mmt.transaction_id  (+)
--    AND MMT.TRANSACTION_ID = 2562828197
            AND mtt.transaction_type_id        (+) = mmt.transaction_type_id 
            AND mtst.transaction_source_type_id(+) = mmt.transaction_source_type_id
            AND fu.user_id                     (+) = mmt.created_by
            AND MMT.TRANSACTION_ID NOT IN(SELECT MMT2.TRANSACTION_ID 
                                            FROM AMARCHIVE.MTL_MATERIAL_TRANSACTIONS  MMT2
                                           WHERE MMT2.TRANSACTION_ID = MMT.TRANSACTION_ID)
            AND msn.serial_number IS NULL ------------ NOVA QUERY PARA TRAZER ITENS NA CONDI?O SERIAL NUMBER NULO - Sinval 17/02/22
            AND moq.locator_id                  IS NOT NULL
            AND msi.serial_number_control_code  = '5'  
            AND msi.lot_control_code            = '2'  --Com controle de Lote
------------------------------------------------------------------------------
UNION
------------------------------------------------------------------------------
-- Com Controle Lote e Sem controle Serial ---- AMARCHIVE.MTL_MATERIAL_TRANSACTIONS
         SELECT DISTINCT  --'18' NUM
         /*( SELECT ccg.cost_group 
                             FROM apps.cst_cost_groups            ccg
                                , apps.cst_cost_group_assignments ccga
                            WHERE ccga.cost_group_id     = ccg.cost_group_id
                              AND ccga.organization_id   = mp.organization_id ) */
                ( SELECT ccg.cost_group 
                             FROM apps.cst_cost_groups            ccg
                            WHERE MPACD.cost_group_id     = ccg.cost_group_id )  cost_group
              , ( SELECT ( SELECT cpp1.period_name 
                             FROM apps.cst_pac_item_costs   cst
                                , apps.cst_pac_periods      cpp1
                            WHERE cst.pac_period_id     = (SELECT MAX(PAC_PERIOD_ID)                   FROM APPS.CST_PAC_PERIODS                  WHERE LEGAL_ENTITY = (SELECT LEGAL_ENTITY                                          FROM APPS.ORG_ORGANIZATION_DEFINITIONS OOD                                         WHERE OOD.ORGANIZATION_ID = mp.organization_id                                         ) )
                              AND cst.pac_period_id     = cpp1.pac_period_id
                              AND cst.inventory_item_id = msi.inventory_item_id
                              AND cst.cost_group_id     = ccg.cost_group_id )  
                    FROM apps.cst_cost_groups            ccg
                       , apps.cst_cost_group_assignments ccga
                   WHERE ccga.cost_group_id     = ccg.cost_group_id
                     AND ccga.organization_id   = mp.organization_id ) period_name
              , mp.organization_code
              , mp.attribute7                organization_type
              , mp.organization_id 
              , moq.subinventory_code
              , msifv.description            subinv_description
              , milk.concatenated_segments   locators
              , DECODE( msifv.asset_inventory, 1 , 'Asset', 2, 'Non Asset')   asset_type
              , msi.segment1                 part_number
              ,DECODE(msi.inventory_asset_flag, NULL, 'No', 'N', 'No', 'Y', 'Yes')                         flag_asset_inventory
              ,DECODE(msi.costing_enabled_flag, NULL, 'No', 'N', 'No', 'Y', 'Yes')                         flag_de_custo
              , msi.description              descrip_eng
              , msi.attribute3               descrip_ptb
              , msi.creation_date            item_creation_date
              , (trunc(SYSDATE) - trunc(msi.creation_date))      days_from_creation
             , gcc.segment8                                     product_line
              , ffvv.description                                 desc_prod_line
              , msi.primary_uom_code   uom
              , DECODE (msi.serial_number_control_code, 1, moq.onhand_qty, 1 ) transaction_quantity
              , NVL(( SELECT cic.item_cost
                        FROM apps.cst_item_costs cic
                       WHERE cic.organization_id   = msi.organization_id
                         AND cic.inventory_item_id = msi.inventory_item_id
                         AND cic.cost_type_id      = 1 ),0)  custo_unit_inv
             /* , nvl(( SELECT ( SELECT ROUND (cst.item_cost,2) 
                                 FROM apps.cst_pac_item_costs   cst
                                WHERE cst.pac_period_id     = (SELECT MAX(PAC_PERIOD_ID)                   
                                                                FROM APPS.CST_PAC_PERIODS                  
                                                                WHERE LEGAL_ENTITY = (SELECT LEGAL_ENTITY                                         
                                                                                        FROM APPS.ORG_ORGANIZATION_DEFINITIONS OOD                                        
                                                                                        WHERE OOD.ORGANIZATION_ID = mp.organization_id
                                                                                    ) )
                                  AND cst.inventory_item_id = msi.inventory_item_id
                                  AND cst.cost_group_id     = ccg.cost_group_id )  item_cost
                        FROM apps.cst_cost_groups            ccg
                           , apps.cst_cost_group_assignments ccga
                       WHERE ccga.cost_group_id     = ccg.cost_group_id
                         AND ccga.organization_id   = mp.organization_id ) ,0) */
                , nvl((SELECT ROUND (cst.item_cost,2) 
                       FROM apps.cst_pac_item_costs   cst
                      WHERE cst.pac_period_id     = (SELECT MAX(PAC_PERIOD_ID)                   
                                                                FROM APPS.CST_PAC_PERIODS                  
                                                                WHERE LEGAL_ENTITY = (SELECT LEGAL_ENTITY                                         
                                                                                        FROM APPS.ORG_ORGANIZATION_DEFINITIONS OOD                                        
                                                                                        WHERE OOD.ORGANIZATION_ID = mp.organization_id
                                                    ) )
                        AND cst.inventory_item_id = msi.inventory_item_id
                        AND cst.cost_group_id     = MPACD.cost_group_id) ,0)  custo_unit_pac
              , moq.lot_number
              , ( SELECT mln.creation_date         
                    FROM apps.mtl_lot_numbers              mln
                   WHERE mln.lot_number           = moq.lot_number 
                     AND mln.inventory_item_id    = msi.inventory_item_id
                     AND mln.organization_id      = mp.organization_id  )  lot_creation_date
              , NULL   lot_qty_days_creation
              , ( SELECT mln.expiration_date         
                    FROM apps.mtl_lot_numbers              mln
                  WHERE mln.lot_number           = moq.lot_number
                     AND mln.inventory_item_id    = msi.inventory_item_id
                     AND mln.organization_id      = mp.organization_id  )  lot_expiration_date
              , msn.serial_number 
              , msn.creation_date     serial_creation_date
              , mtt.transaction_type_name           last_transaction_type
              , mmt.transaction_source_name         last_transaction_source
              , mtst.transaction_source_type_name   last_source_type
              , mmt.source_code
              , TO_CHAR(mmt.transaction_date, 'DD-MON-RRRR')       transaction_date
        , (SELECT TO_CHAR(mmt1.transaction_date, 'DD-MON-RRRR') 
                        FROM apps.mtl_material_transactions mmt1
                        WHERE mmt1.transaction_type_id=420
                        AND mmt1.source_line_id=mmt.source_line_id) initial_consignment_date        
              , (TRUNC ( SYSDATE )- TRUNC(mmt.transaction_date))   transaction_qty_of_days
              , TO_CHAR(mmt.transaction_reference)                 transaction_reference
              , CASE WHEN mmt.source_code = '3PL_REMITTANCE_BRAZIL' THEN
                     (SELECT listagg(pha.segment1,', ' ON OVERFLOW TRUNCATE)  
                      WITHIN GROUP (ORDER BY pha.segment1 asc)
                        FROM apps.po_headers_all        pha
                           , apps.po_lines_all          pla
                       WHERE pla.po_line_id   = mmt.source_line_id
                         AND pla.po_header_id = pha.po_header_id)
                     WHEN mmt.source_code IN ('ORDER ENTRY','IIP') THEN
                        NULL
                     WHEN mmt.source_code = 'RCV' THEN
                        ( SELECT listagg(pha.segment1,', ' ON OVERFLOW TRUNCATE)  
                          WITHIN GROUP (ORDER BY pha.segment1 asc)
                            FROM apps.po_headers_all            pha
                               , apps.po_lines_all              pla
                               , apps.po_line_locations_all     plla
                               , apps.rcv_shipment_headers      rsh
                               , apps.rcv_transactions          rt
                           WHERE rt.transaction_id                = mmt.rcv_transaction_id
                             AND rt.po_line_location_id           = plla.line_location_id
                             AND plla.po_line_id                  = pla.po_line_id
                             AND pha.po_header_id                 = pla.po_header_id
                             AND rt.shipment_header_id            = rsh.shipment_header_id
                             AND rsh.receipt_source_code          = 'VENDOR'  )
                     ELSE
                        NULL
                END      po_number
              , CASE WHEN mmt.source_code = '3PL_REMITTANCE_BRAZIL' THEN
                     (SELECT listagg(aps.vendor_name,', ' ON OVERFLOW TRUNCATE)  
                      WITHIN GROUP (ORDER BY aps.vendor_name asc)
                        FROM apps.po_headers_all            pha
                           , apps.po_lines_all              pla
                           , apps.ap_suppliers              aps
                           , apps.ap_supplier_sites_all     apss
                       WHERE pla.po_line_id     = mmt.source_line_id
                         AND pla.po_header_id   = pha.po_header_id
                         AND pha.vendor_id      = aps.vendor_id
                         AND aps.vendor_id      = apss.vendor_id
                         AND pha.vendor_site_id = apss.vendor_site_id )
                     WHEN mmt.source_code IN ('ORDER ENTRY','IIP') THEN
                        NULL
                     WHEN mmt.source_code = 'RCV' THEN
                        ( SELECT listagg(aps.vendor_name,', ' ON OVERFLOW TRUNCATE)  
                          WITHIN GROUP (ORDER BY aps.vendor_name asc)
                            FROM apps.po_headers_all            pha
                               , apps.po_lines_all              pla
                               , apps.po_line_locations_all     plla
                               , apps.rcv_shipment_headers      rsh
                               , apps.rcv_transactions          rt
                               , apps.ap_suppliers              aps
                               , apps.ap_supplier_sites_all     apss
                           WHERE rt.transaction_id          = mmt.rcv_transaction_id
                             AND rt.po_line_location_id     = plla.line_location_id
                             AND plla.po_line_id            = pla.po_line_id
                             AND pha.po_header_id           = pla.po_header_id
                             AND rt.shipment_header_id      = rsh.shipment_header_id
                             AND rsh.receipt_source_code    = 'VENDOR'
                             AND pha.vendor_id              = aps.vendor_id
                             AND aps.vendor_id              = apss.vendor_id
                             AND pha.vendor_site_id         = apss.vendor_site_id  )
                     ELSE
                        NULL
                END    po_supplier
              , CASE WHEN mmt.source_code = '3PL_REMITTANCE_BRAZIL' THEN
                     ( SELECT listagg(cfi.invoice_num,', ' ON OVERFLOW TRUNCATE)  
                         WITHIN GROUP (ORDER BY cfi.invoice_num asc)
                         FROM apps.cll_f189_invoice_lines cfil
                            , apps.cll_f189_invoices      cfi
                            , apps.po_lines_all           pla
                            , apps.po_line_locations_all  plla
                        WHERE plla.po_line_id       = pla.po_line_id
                          AND pla.po_line_id        = mmt.source_line_id
                          AND plla.line_location_id = cfil.line_location_id
                          AND cfil.invoice_id       = cfi.invoice_id )
                     WHEN mmt.source_code IN ('ORDER ENTRY','IIP') THEN
                        NULL
                     WHEN mmt.source_code = 'RCV' THEN
                        ( SELECT listagg(cfi.invoice_num,', ' ON OVERFLOW TRUNCATE)  
                            WITHIN GROUP (ORDER BY cfi.invoice_num asc)
                            FROM apps.po_headers_all            pha
                               , apps.po_lines_all              pla
                               , apps.po_line_locations_all     plla
                               , apps.cll_f189_invoice_lines    cfil
                               , apps.cll_f189_invoices         cfi
                               , apps.rcv_shipment_headers      rsh
                               , apps.rcv_transactions          rt
                           WHERE rt.transaction_id          = mmt.rcv_transaction_id
                             AND rt.po_line_location_id     = plla.line_location_id
                             AND plla.line_location_id      = cfil.line_location_id
                             AND cfil.invoice_id            = cfi.invoice_id
                            AND plla.po_line_id            = pla.po_line_id
                             AND pha.po_header_id           = pla.po_header_id
                             AND rt.shipment_header_id      = rsh.shipment_header_id
                             AND rsh.receipt_source_code    = 'VENDOR'   )
                     ELSE
                        NULL
                END    NF_RI
              , (SELECT DECODE( mmt.source_code, '3PL_REMITTANCE_BRAZIL',NULL,to_char(ooha.order_number) )
                   FROM apps.oe_order_headers_all  ooha
                      , apps.oe_order_lines_all    oola  
                  WHERE oola.line_id        = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                    AND oola.header_id      = ooha.header_id )   order_number
               -- 
               -- alterado para BIll_to por Sinval inicio
               --
               , CASE WHEN ( SELECT ottl.name
                             FROM apps.oe_transaction_types_tl    ottl
                                , apps.oe_order_headers_all  ooha
                                , apps.oe_order_lines_all    oola  
                            WHERE oola.line_id        = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND oola.header_id      = ooha.header_id
                              AND ooha.order_type_id  = ottl.transaction_type_id  ) = 'GPO_BR_FE_SHIPMENT' THEN
                     (SELECT listagg(hp.party_name,', ' ON OVERFLOW TRUNCATE)  
                      WITHIN GROUP (ORDER BY hp.party_name asc)
                        FROM apps.hz_parties             hp
                           , apps.hz_cust_accounts       hca
                           , apps.oe_order_lines_all     oola
                           , apps.hz_cust_acct_sites_all hcas
                           , apps.hz_cust_site_uses_all  hcsu
                       WHERE oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                         AND oola.end_customer_site_use_id  = hcsu.site_use_id
                         AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                         AND hcas.cust_account_id           = hca.cust_account_id
                         AND hca.party_id                   = hp.party_id )
                  ELSE
                     CASE WHEN (mmt.source_code = '3PL_REMITTANCE_BRAZIL') THEN
                       (SELECT listagg(hp.party_name,', ' ON OVERFLOW TRUNCATE)  
                        WITHIN GROUP (ORDER BY hp.party_name asc)
                          FROM apps.hz_parties             hp,
                               apps.hz_cust_accounts       hca,
                               apps.ra_customer_trx_all    rcta,
                               apps.hz_cust_acct_sites_all hcas,
                               apps.hz_cust_site_uses_all  hcsu
                         WHERE rcta.interface_header_attribute1 = mp.organization_code||'_'||mmt.transaction_reference
                           AND rcta.ship_to_site_use_id         = hcsu.site_use_id
                           AND hcsu.cust_acct_site_id           = hcas.cust_acct_site_id
                           AND hcas.cust_account_id             = hca.cust_account_id
                           AND hca.party_id                     = hp.party_id
                           AND rcta.org_id                      = 4330)
                     ELSE
                        (SELECT listagg(hp.party_name,', ' ON OVERFLOW TRUNCATE)  
                         WITHIN GROUP (ORDER BY hp.party_name asc)
                           FROM apps.hz_parties             hp
                              , apps.hz_cust_accounts       hca
                              , apps.oe_order_lines_all     oola
                              , apps.hz_cust_acct_sites_all hcas
                              , apps.hz_cust_site_uses_all  hcsu
                          WHERE oola.line_id                = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                            AND oola.ship_to_org_id         = hcsu.site_use_id
                            AND hcsu.cust_acct_site_id      = hcas.cust_acct_site_id
                            AND hcas.cust_account_id        = hca.cust_account_id
                            AND hca.party_id                = hp.party_id )
                    END                 
               END    customer_name
             , CASE WHEN ( SELECT ottl.name
                             FROM apps.oe_transaction_types_tl    ottl
                                , apps.oe_order_headers_all  ooha
                                , apps.oe_order_lines_all    oola  
                            WHERE oola.line_id        = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND oola.header_id      = ooha.header_id
                              AND ooha.order_type_id  = ottl.transaction_type_id  ) = 'GPO_BR_FE_SHIPMENT' THEN
                     (SELECT listagg(hca.account_number,', ' ON OVERFLOW TRUNCATE)  
                      WITHIN GROUP (ORDER BY hca.account_number asc)
                        FROM apps.hz_parties             hp
                           , apps.hz_cust_accounts       hca
                           , apps.oe_order_lines_all     oola
                           , apps.hz_cust_acct_sites_all hcas
                           , apps.hz_cust_site_uses_all  hcsu
                       WHERE oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                         AND oola.end_customer_site_use_id  = hcsu.site_use_id
                         AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                         AND hcas.cust_account_id           = hca.cust_account_id
                         AND hca.party_id                   = hp.party_id )
                  ELSE
                     CASE WHEN (mmt.source_code = '3PL_REMITTANCE_BRAZIL') THEN
                        (SELECT listagg(hca.account_number,', ' ON OVERFLOW TRUNCATE)  
                         WITHIN GROUP (ORDER BY hca.account_number asc)
                           FROM apps.hz_parties             hp,
                                apps.hz_cust_accounts       hca,
                                apps.ra_customer_trx_all    rcta,
                                apps.hz_cust_acct_sites_all hcas,
                                apps.hz_cust_site_uses_all  hcsu
                          WHERE rcta.interface_header_attribute1 = mp.organization_code||'_'||mmt.transaction_reference
                            AND rcta.ship_to_site_use_id         = hcsu.site_use_id
                            AND hcsu.cust_acct_site_id           = hcas.cust_acct_site_id
                            AND hcas.cust_account_id             = hca.cust_account_id
                            AND hca.party_id                     = hp.party_id
                            AND rcta.org_id                      = 4330)
                     ELSE
                        (SELECT listagg(hca.account_number,', ' ON OVERFLOW TRUNCATE)  
                         WITHIN GROUP (ORDER BY hca.account_number asc)
                           FROM apps.hz_parties             hp
                              , apps.hz_cust_accounts       hca
                              , apps.oe_order_lines_all     oola
                              , apps.hz_cust_acct_sites_all hcas
                              , apps.hz_cust_site_uses_all  hcsu
                          WHERE oola.line_id                = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                            AND oola.ship_to_org_id         = hcsu.site_use_id
                            AND hcsu.cust_acct_site_id      = hcas.cust_acct_site_id
                            AND hcas.cust_account_id        = hca.cust_account_id
                            AND hca.party_id                = hp.party_id   )
                     END
                  END   customer_number
              --
              , CASE WHEN ( SELECT ottl.name
                             FROM apps.oe_transaction_types_tl    ottl
                                , apps.oe_order_headers_all  ooha
                                , apps.oe_order_lines_all    oola  
                            WHERE oola.line_id        = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                             AND oola.header_id      = ooha.header_id
                              AND ooha.order_type_id  = ottl.transaction_type_id  ) = 'GPO_BR_FE_SHIPMENT' THEN
                     (SELECT listagg(DECODE(hcas.global_attribute2
                                           , '2',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'/'|| hcas.global_attribute4 ||'-'|| hcas.global_attribute5
                                           , '1',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'-'|| hcas.global_attribute5 
                                           , '3',HCSU.LOCATION||' - '||hcas.global_attribute3 ),', ' ON OVERFLOW TRUNCATE)
                     WITHIN GROUP (ORDER BY hcas.global_attribute2 asc ) 
                        FROM apps.hz_parties             hp
                           , apps.hz_cust_accounts       hca
                           , apps.oe_order_lines_all     oola
                           , apps.hz_cust_acct_sites_all hcas
                           , apps.hz_cust_site_uses_all  hcsu
                       WHERE oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                         AND oola.end_customer_site_use_id  = hcsu.site_use_id
                         AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                         AND hcas.cust_account_id           = hca.cust_account_id
                         AND hca.party_id                   = hp.party_id )
                ELSE
                   CASE WHEN (mmt.source_code = '3PL_REMITTANCE_BRAZIL') THEN
                      (SELECT listagg(DECODE(hcas.global_attribute2
                                           , '2',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'/'|| hcas.global_attribute4 ||'-'|| hcas.global_attribute5
                                           , '1',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'-'|| hcas.global_attribute5 
                                           , '3',HCSU.LOCATION||' - '||hcas.global_attribute3 ),', ' ON OVERFLOW TRUNCATE)
                     WITHIN GROUP (ORDER BY hcas.global_attribute2 asc) 
                         FROM apps.ra_customer_trx_all     rcta
                            , apps.hz_cust_acct_sites_all  hcas
                            , apps.hz_cust_site_uses_all   hcsu
                        WHERE rcta.interface_header_attribute1 = mp.organization_code||'_'||mmt.transaction_reference
                          AND rcta.ship_to_site_use_id         = hcsu.site_use_id
                          AND hcsu.cust_acct_site_id           = hcas.cust_acct_site_id
                          AND rcta.org_id                      = 4330)
                   ELSE
                      (SELECT listagg(DECODE(hcas.global_attribute2
                                           , '2',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'/'|| hcas.global_attribute4 ||'-'|| hcas.global_attribute5
                                           , '1',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'-'|| hcas.global_attribute5 
                                           , '3',HCSU.LOCATION||' - '||hcas.global_attribute3 ),', ' ON OVERFLOW TRUNCATE)
                      WITHIN GROUP (ORDER BY hcas.global_attribute2 asc) 
                         FROM apps.hz_parties             hp
                            , apps.hz_cust_accounts       hca
                            , apps.oe_order_lines_all     oola
                            , apps.hz_cust_acct_sites_all hcas
                            , apps.hz_cust_site_uses_all  hcsu
                        WHERE oola.line_id                = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                          AND oola.ship_to_org_id         = hcsu.site_use_id
                          AND hcsu.cust_acct_site_id      = hcas.cust_acct_site_id
                          AND hcas.cust_account_id        = hca.cust_account_id
                          AND hca.party_id                = hp.party_id  )
                   END
                END  customer_cnpj_cpf
               -- 
              , CASE WHEN (mmt.source_code = '3PL_REMITTANCE_BRAZIL') THEN
                      (SELECT listagg(DECODE(hcas.global_attribute2
                                           , '2',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'/'|| hcas.global_attribute4 ||'-'|| hcas.global_attribute5
                                           , '1',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'-'|| hcas.global_attribute5 
                                           , '3',HCSU.LOCATION||' - '||hcas.global_attribute3 ),', ' ON OVERFLOW TRUNCATE)
                       WITHIN GROUP (ORDER BY hcas.global_attribute2 asc )
                         FROM apps.ra_customer_trx_all         rcta
                            , apps.hz_cust_acct_sites_all      hcas
                            , apps.hz_cust_site_uses_all       hcsu
                        WHERE rcta.interface_header_attribute1 = mp.organization_code||'_'||mmt.transaction_reference
                          AND rcta.bill_to_site_use_id         = hcsu.site_use_id
                          AND hcsu.cust_acct_site_id           = hcas.cust_acct_site_id
                          AND rcta.org_id                      = 4330
                          AND ROWNUM = 1)
                   ELSE
                     --
                     CASE WHEN (select DISTINCT RCTL.INTERFACE_LINE_CONTEXT
                             FROM apps.hz_parties                hp
                                , apps.hz_cust_accounts          hca
                                , apps.oe_order_lines_all        oola
                                , apps.oe_order_headers_all      ooha
                                , apps.ra_customer_trx_lines_all rctl
                                , apps.ra_customer_trx_all       rcta
                                , apps.hz_cust_acct_sites_all    hcas
                                , apps.hz_cust_site_uses_all     hcsu
                            WHERE ooha.header_id                 = oola.header_id
                              AND oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND rctl.inventory_item_id         = oola.inventory_item_id
                              AND rctl.line_type                 = 'LINE'
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE1 = to_char(ooha.order_number)
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE6 = to_char(oola.line_id)
                              AND RCTL.INTERFACE_LINE_CONTEXT    = 'ORDER ENTRY'
                              AND rctl.customer_trx_id           = rcta.customer_trx_id
                              AND rcta.bill_to_site_use_id       = hcsu.site_use_id
                              AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                              AND hcas.cust_account_id           = hca.cust_account_id
                              AND hca.party_id                   = hp.party_id 
                              AND ROWNUM = 1) = 'ORDER ENTRY' THEN
                     --
                     (SELECT DISTINCT DECODE(hcas.global_attribute2
                                           , '2',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'/'|| hcas.global_attribute4 ||'-'|| hcas.global_attribute5
                                           , '1',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'-'|| hcas.global_attribute5 
                                           , '3',HCSU.LOCATION||' - '||hcas.global_attribute3)
                             FROM apps.hz_parties                hp
                                , apps.hz_cust_accounts          hca
                                , apps.oe_order_lines_all        oola
                                , apps.oe_order_headers_all      ooha
                                , apps.ra_customer_trx_lines_all rctl
                                , apps.ra_customer_trx_all       rcta
                                , apps.hz_cust_acct_sites_all    hcas
                                , apps.hz_cust_site_uses_all     hcsu
                            WHERE ooha.header_id                 = oola.header_id
                              AND oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND rctl.inventory_item_id         = oola.inventory_item_id
                              AND rctl.line_type                 = 'LINE'
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE1 = to_char(ooha.order_number)
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE6 = to_char(oola.line_id)
                              AND RCTL.INTERFACE_LINE_CONTEXT    = 'ORDER ENTRY'
                              AND rctl.customer_trx_id           = rcta.customer_trx_id
                              AND rcta.bill_to_site_use_id       = hcsu.site_use_id
                              AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                              AND hcas.cust_account_id           = hca.cust_account_id
                              AND hca.party_id                   = hp.party_id
                              AND ROWNUM = 1)
                     --
                     ELSE
                     --            
                     CASE WHEN 
                          ( SELECT DISTINCT RCTL.INTERFACE_LINE_CONTEXT
                             FROM apps.hz_parties                hp
                                , apps.hz_cust_accounts          hca
                                , apps.oe_order_lines_all        oola
                                , apps.oe_order_headers_all      ooha
                                , apps.ra_customer_trx_lines_all rctl
                                , apps.ra_customer_trx_all       rcta
                                , apps.hz_cust_acct_sites_all    hcas
                                , apps.hz_cust_site_uses_all     hcsu
                            WHERE ooha.header_id                 = oola.header_id
                              AND oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND rctl.inventory_item_id         = oola.inventory_item_id
                              AND rctl.line_type                 = 'LINE'
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE1 = ooha.ORIG_SYS_DOCUMENT_REF
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE7 = oola.ORIG_SYS_LINE_REF
                              AND RCTL.INTERFACE_LINE_CONTEXT    = 'GEMS_PB_RR'
                              AND rctl.customer_trx_id           = rcta.customer_trx_id
                              AND rcta.bill_to_site_use_id       = hcsu.site_use_id
                              AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                              AND hcas.cust_account_id           = hca.cust_account_id
                              AND ROWNUM = 1 ) = 'GEMS_PB_RR' THEN
                     --
                     (SELECT DISTINCT DECODE(hcas.global_attribute2
                                           , '2',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'/'|| hcas.global_attribute4 ||'-'|| hcas.global_attribute5
                                           , '1',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'-'|| hcas.global_attribute5 
                                           , '3',HCSU.LOCATION||' - '||hcas.global_attribute3)
                             FROM apps.hz_parties                hp
                                , apps.hz_cust_accounts          hca
                                , apps.oe_order_lines_all        oola
                                , apps.oe_order_headers_all      ooha
                                , apps.ra_customer_trx_lines_all rctl
                                , apps.ra_customer_trx_all       rcta
                                , apps.hz_cust_acct_sites_all    hcas
                                , apps.hz_cust_site_uses_all     hcsu
                            WHERE ooha.header_id                 = oola.header_id
                              AND oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND rctl.inventory_item_id         = oola.inventory_item_id
                              AND rctl.line_type                 = 'LINE'
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE1 = ooha.ORIG_SYS_DOCUMENT_REF
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE7 = oola.ORIG_SYS_LINE_REF
                              AND RCTL.INTERFACE_LINE_CONTEXT    = 'GEMS_PB_RR'
                              AND rctl.customer_trx_id           = rcta.customer_trx_id
                              AND rcta.bill_to_site_use_id       = hcsu.site_use_id
                              AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                              AND hcas.cust_account_id           = hca.cust_account_id 
                              AND ROWNUM = 1 )
                     --
                     ELSE
                     --
                    (SELECT DISTINCT DECODE(hcas.global_attribute2
                                   , '2',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'/'|| hcas.global_attribute4 ||'-'|| hcas.global_attribute5
                                   , '1',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'-'|| hcas.global_attribute5 
                                   , '3',HCSU.LOCATION||' - '||hcas.global_attribute3)
                             --
                      FROM   APPS.HZ_CUST_ACCT_SITES_ALL HCAS,
                             APPS.HZ_CUST_SITE_USES_ALL  HCSU,
                             APPS.OE_ORDER_LINES_ALL     OOLA,
                             APPS.OE_ORDER_HEADERS_ALL   OOHA
                             --
                      WHERE  HCSU.SITE_USE_CODE     = 'BILL_TO'
                      AND    HCSU.CUST_ACCT_SITE_ID = HCAS.CUST_ACCT_SITE_ID
                      AND    HCSU.SITE_USE_ID       = NVL(OOLA.ATTRIBUTE1, OOHA.INVOICE_TO_ORG_ID)
                      AND    OOLA.LINE_ID           = NVL(MMT.TRX_SOURCE_LINE_ID, MMT.SOURCE_LINE_ID)
                      AND    OOHA.HEADER_ID         = OOLA.HEADER_ID
                      AND    ROWNUM = 1)
                     --
                     END
                  END
               END      bill_to_CNPJ_CPF
               --
                             --
              , CASE WHEN (mmt.source_code = '3PL_REMITTANCE_BRAZIL') THEN
                        (SELECT listagg(hp.party_name,', ' ON OVERFLOW TRUNCATE)  
                        WITHIN GROUP (ORDER BY hp.party_name asc)
                          FROM apps.hz_parties             hp,
                               apps.hz_cust_accounts       hca,
                               apps.ra_customer_trx_all    rcta,
                               apps.hz_cust_acct_sites_all hcas,
                               apps.hz_cust_site_uses_all  hcsu
                         WHERE rcta.interface_header_attribute1 = mp.organization_code||'_'||mmt.transaction_reference
                           AND rcta.bill_to_site_use_id         = hcsu.site_use_id
                           AND hcsu.cust_acct_site_id           = hcas.cust_acct_site_id
                           AND hcas.cust_account_id             = hca.cust_account_id
                           AND hca.party_id                     = hp.party_id
                           AND rcta.org_id                      = 4330)
                   ELSE
                     --
                     CASE WHEN (select DISTINCT RCTL.INTERFACE_LINE_CONTEXT
                             FROM apps.hz_parties                hp
                                , apps.hz_cust_accounts          hca
                                , apps.oe_order_lines_all        oola
                                , apps.oe_order_headers_all      ooha
                                , apps.ra_customer_trx_lines_all rctl
                                , apps.ra_customer_trx_all       rcta
                                , apps.hz_cust_acct_sites_all    hcas
                                , apps.hz_cust_site_uses_all     hcsu
                            WHERE ooha.header_id                 = oola.header_id
                              AND oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND rctl.inventory_item_id         = oola.inventory_item_id
                              AND rctl.line_type                 = 'LINE'
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE1 = to_char(ooha.order_number)
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE6 = to_char(oola.line_id)
                              AND RCTL.INTERFACE_LINE_CONTEXT    = 'ORDER ENTRY'
                              AND rctl.customer_trx_id           = rcta.customer_trx_id
                              AND rcta.bill_to_site_use_id       = hcsu.site_use_id
                              AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                              AND hcas.cust_account_id           = hca.cust_account_id
                              AND hca.party_id                   = hp.party_id 
                              AND ROWNUM = 1) = 'ORDER ENTRY' THEN
                     --
                     (SELECT listagg(hp.party_name,', ' ON OVERFLOW TRUNCATE)  
                         WITHIN GROUP (ORDER BY hp.party_name asc)
                             FROM apps.hz_parties                hp
                                , apps.hz_cust_accounts          hca
                                , apps.oe_order_lines_all        oola
                                , apps.oe_order_headers_all      ooha
                                , apps.ra_customer_trx_lines_all rctl
                                , apps.ra_customer_trx_all       rcta
                                , apps.hz_cust_acct_sites_all    hcas
                                , apps.hz_cust_site_uses_all     hcsu
                            WHERE ooha.header_id                 = oola.header_id
                              AND oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND rctl.inventory_item_id         = oola.inventory_item_id
                              AND rctl.line_type                 = 'LINE'
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE1 = to_char(ooha.order_number)
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE6 = to_char(oola.line_id)
                              AND RCTL.INTERFACE_LINE_CONTEXT    = 'ORDER ENTRY'
                              AND rctl.customer_trx_id           = rcta.customer_trx_id
                              AND rcta.bill_to_site_use_id       = hcsu.site_use_id
                              AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                              AND hcas.cust_account_id           = hca.cust_account_id
                              AND hca.party_id                   = hp.party_id
                              AND ROWNUM = 1)
                     --
                     ELSE
                     --            
                     CASE WHEN 
                          ( SELECT DISTINCT RCTL.INTERFACE_LINE_CONTEXT
                             FROM apps.hz_parties                hp
                                , apps.hz_cust_accounts          hca
                                , apps.oe_order_lines_all        oola
                                , apps.oe_order_headers_all      ooha
                                , apps.ra_customer_trx_lines_all rctl
                                , apps.ra_customer_trx_all       rcta
                                , apps.hz_cust_acct_sites_all    hcas
                                , apps.hz_cust_site_uses_all     hcsu
                            WHERE ooha.header_id                 = oola.header_id
                              AND oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND rctl.inventory_item_id         = oola.inventory_item_id
                              AND rctl.line_type                 = 'LINE'
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE1 = ooha.ORIG_SYS_DOCUMENT_REF
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE7 = oola.ORIG_SYS_LINE_REF
                              AND RCTL.INTERFACE_LINE_CONTEXT    = 'GEMS_PB_RR'
                              AND rctl.customer_trx_id           = rcta.customer_trx_id
                              AND rcta.bill_to_site_use_id       = hcsu.site_use_id
                              AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                              AND hcas.cust_account_id           = hca.cust_account_id
                              AND ROWNUM = 1 ) = 'GEMS_PB_RR' THEN
                     --
                     (SELECT listagg(hp.party_name,', ' ON OVERFLOW TRUNCATE)  
                         WITHIN GROUP (ORDER BY hp.party_name asc)
                             FROM apps.hz_parties                hp
                                , apps.hz_cust_accounts          hca
                                , apps.oe_order_lines_all        oola
                                , apps.oe_order_headers_all      ooha
                                , apps.ra_customer_trx_lines_all rctl
                                , apps.ra_customer_trx_all       rcta
                                , apps.hz_cust_acct_sites_all    hcas
                                , apps.hz_cust_site_uses_all     hcsu
                            WHERE ooha.header_id                 = oola.header_id
                              AND oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND rctl.inventory_item_id         = oola.inventory_item_id
                              AND rctl.line_type                 = 'LINE'
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE1 = ooha.ORIG_SYS_DOCUMENT_REF
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE7 = oola.ORIG_SYS_LINE_REF
                              AND RCTL.INTERFACE_LINE_CONTEXT    = 'GEMS_PB_RR'
                              AND rctl.customer_trx_id           = rcta.customer_trx_id
                              AND rcta.bill_to_site_use_id       = hcsu.site_use_id
                              AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                              AND hcas.cust_account_id           = hca.cust_account_id 
                              AND ROWNUM = 1 )
                     --
                     ELSE
                     --
                     (SELECT listagg(hp.party_name,', ' ON OVERFLOW TRUNCATE)  
                         WITHIN GROUP (ORDER BY hp.party_name asc)
                      FROM   APPS.HZ_CUST_ACCT_SITES_ALL HCAS,
                             apps.hz_parties             hp,
                             apps.hz_cust_accounts       hca,
                             APPS.HZ_CUST_SITE_USES_ALL  HCSU,
                             APPS.OE_ORDER_LINES_ALL     OOLA,
                             APPS.OE_ORDER_HEADERS_ALL   OOHA
                             --
                      WHERE  HCSU.SITE_USE_CODE     = 'BILL_TO'
                      AND    HCSU.CUST_ACCT_SITE_ID = HCAS.CUST_ACCT_SITE_ID
                      AND    HCSU.SITE_USE_ID       = NVL(OOLA.ATTRIBUTE1, OOHA.INVOICE_TO_ORG_ID)
                      AND    OOLA.LINE_ID           = NVL(MMT.TRX_SOURCE_LINE_ID, MMT.SOURCE_LINE_ID)
                      AND    OOHA.HEADER_ID         = OOLA.HEADER_ID
                      AND    hcas.cust_account_id   = hca.cust_account_id
                      AND    hca.party_id           = hp.party_id 
                      AND    ROWNUM = 1)
                     --          
                     END
                  END
               END      bill_to_Customer_name
               --
                , CASE WHEN (mmt.source_code = '3PL_REMITTANCE_BRAZIL') THEN
                      (SELECT listagg(DECODE(hcas.global_attribute2
                                           , '2',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'/'|| hcas.global_attribute4 ||'-'|| hcas.global_attribute5
                                           , '1',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'-'|| hcas.global_attribute5 
                                           , '3',HCSU.LOCATION||' - '||hcas.global_attribute3 ),', ' ON OVERFLOW TRUNCATE)
                       WITHIN GROUP (ORDER BY hcas.global_attribute2 asc )
                         FROM apps.ra_customer_trx_all         rcta
                            , apps.hz_cust_acct_sites_all      hcas
                            , apps.hz_cust_site_uses_all       hcsu
                        WHERE rcta.interface_header_attribute1 = mp.organization_code||'_'||mmt.transaction_reference
                          AND rcta.ship_to_site_use_id         = hcsu.site_use_id
                          AND hcsu.cust_acct_site_id           = hcas.cust_acct_site_id
                          AND rcta.org_id                      = 4330
                          AND ROWNUM = 1)
                   ELSE
                     --
                     CASE WHEN (select DISTINCT RCTL.INTERFACE_LINE_CONTEXT
                             FROM apps.hz_parties                hp
                                , apps.hz_cust_accounts          hca
                                , apps.oe_order_lines_all        oola
                                , apps.oe_order_headers_all      ooha
                                , apps.ra_customer_trx_lines_all rctl
                                , apps.ra_customer_trx_all       rcta
                                , apps.hz_cust_acct_sites_all    hcas
                                , apps.hz_cust_site_uses_all     hcsu
                            WHERE ooha.header_id                 = oola.header_id
                              AND oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND rctl.inventory_item_id         = oola.inventory_item_id
                              AND rctl.line_type                 = 'LINE'
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE1 = to_char(ooha.order_number)
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE6 = to_char(oola.line_id)
                              AND RCTL.INTERFACE_LINE_CONTEXT    = 'ORDER ENTRY'
                              AND rctl.customer_trx_id           = rcta.customer_trx_id
                              AND rcta.ship_to_site_use_id       = hcsu.site_use_id
                              AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                              AND hcas.cust_account_id           = hca.cust_account_id
                              AND hca.party_id                   = hp.party_id 
                              AND ROWNUM = 1) = 'ORDER ENTRY' THEN
                     --
                     (SELECT DISTINCT DECODE(hcas.global_attribute2
                                           , '2',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'/'|| hcas.global_attribute4 ||'-'|| hcas.global_attribute5
                                           , '1',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'-'|| hcas.global_attribute5 
                                           , '3',HCSU.LOCATION||' - '||hcas.global_attribute3)
                             FROM apps.hz_parties                hp
                                , apps.hz_cust_accounts          hca
                                , apps.oe_order_lines_all        oola
                                , apps.oe_order_headers_all      ooha
                                , apps.ra_customer_trx_lines_all rctl
                                , apps.ra_customer_trx_all       rcta
                                , apps.hz_cust_acct_sites_all    hcas
                                , apps.hz_cust_site_uses_all     hcsu
                            WHERE ooha.header_id                 = oola.header_id
                              AND oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND rctl.inventory_item_id         = oola.inventory_item_id
                              AND rctl.line_type                 = 'LINE'
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE1 = to_char(ooha.order_number)
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE6 = to_char(oola.line_id)
                              AND RCTL.INTERFACE_LINE_CONTEXT    = 'ORDER ENTRY'
                              AND rctl.customer_trx_id           = rcta.customer_trx_id
                              AND rcta.ship_to_site_use_id       = hcsu.site_use_id
                              AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                              AND hcas.cust_account_id           = hca.cust_account_id
                              AND hca.party_id                   = hp.party_id
                              AND ROWNUM = 1)
                     --
                     ELSE
                     --            
                     CASE WHEN 
                          ( SELECT DISTINCT RCTL.INTERFACE_LINE_CONTEXT
                             FROM apps.hz_parties                hp
                                , apps.hz_cust_accounts          hca
                                , apps.oe_order_lines_all        oola
                                , apps.oe_order_headers_all      ooha
                                , apps.ra_customer_trx_lines_all rctl
                                , apps.ra_customer_trx_all       rcta
                                , apps.hz_cust_acct_sites_all    hcas
                                , apps.hz_cust_site_uses_all     hcsu
                            WHERE ooha.header_id                 = oola.header_id
                              AND oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND rctl.inventory_item_id         = oola.inventory_item_id
                              AND rctl.line_type                 = 'LINE'
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE1 = ooha.ORIG_SYS_DOCUMENT_REF
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE7 = oola.ORIG_SYS_LINE_REF
                              AND RCTL.INTERFACE_LINE_CONTEXT    = 'GEMS_PB_RR'
                              AND rctl.customer_trx_id           = rcta.customer_trx_id
                              AND rcta.ship_to_site_use_id       = hcsu.site_use_id
                              AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                              AND hcas.cust_account_id           = hca.cust_account_id
                              AND ROWNUM = 1 ) = 'GEMS_PB_RR' THEN
                     --
                     (SELECT DISTINCT DECODE(hcas.global_attribute2
                                           , '2',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'/'|| hcas.global_attribute4 ||'-'|| hcas.global_attribute5
                                           , '1',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'-'|| hcas.global_attribute5 
                                           , '3',HCSU.LOCATION||' - '||hcas.global_attribute3)
                             FROM apps.hz_parties                hp
                                , apps.hz_cust_accounts          hca
                                , apps.oe_order_lines_all        oola
                                , apps.oe_order_headers_all      ooha
                                , apps.ra_customer_trx_lines_all rctl
                                , apps.ra_customer_trx_all       rcta
                                , apps.hz_cust_acct_sites_all    hcas
                                , apps.hz_cust_site_uses_all     hcsu
                            WHERE ooha.header_id                 = oola.header_id
                              AND oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                              AND rctl.inventory_item_id         = oola.inventory_item_id
                              AND rctl.line_type                 = 'LINE'
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE1 = ooha.ORIG_SYS_DOCUMENT_REF
                              AND RCTL.INTERFACE_LINE_ATTRIBUTE7 = oola.ORIG_SYS_LINE_REF
                              AND RCTL.INTERFACE_LINE_CONTEXT    = 'GEMS_PB_RR'
                              AND rctl.customer_trx_id           = rcta.customer_trx_id
                              AND rcta.ship_to_site_use_id       = hcsu.site_use_id
                              AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                              AND hcas.cust_account_id           = hca.cust_account_id 
                              AND ROWNUM = 1 )
                     --
                     ELSE
                     --
                     (SELECT listagg(DECODE(hcas.global_attribute2
                                           , '2',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'/'|| hcas.global_attribute4 ||'-'|| hcas.global_attribute5
                                           , '1',HCSU.LOCATION||' - '||hcas.global_attribute3 ||'-'|| hcas.global_attribute5 
                                           , '3',HCSU.LOCATION||' - '||hcas.global_attribute3 ),', ' ON OVERFLOW TRUNCATE)
                      WITHIN GROUP (ORDER BY hcas.global_attribute2 asc) 
                         FROM apps.hz_parties             hp
                            , apps.hz_cust_accounts       hca
                            , apps.oe_order_lines_all     oola
                            , apps.hz_cust_acct_sites_all hcas
                            , apps.hz_cust_site_uses_all  hcsu
                        WHERE oola.line_id                = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                          AND oola.ship_to_org_id         = hcsu.site_use_id
                          AND hcsu.cust_acct_site_id      = hcas.cust_acct_site_id
                          AND hcas.cust_account_id        = hca.cust_account_id
                          AND hca.party_id                = hp.party_id  )
                     --
                     END
                  END
               END      ship_to_CNPJ_CPF
               --
              , CASE WHEN ( SELECT ottl.name
                              FROM apps.oe_transaction_types_tl    ottl
                                 , apps.oe_order_headers_all  ooha
                                 , apps.oe_order_lines_all    oola  
                             WHERE oola.line_id        = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                               AND oola.header_id      = ooha.header_id
                               AND ooha.order_type_id  = ottl.transaction_type_id  ) = 'GPO_BR_FE_SHIPMENT' THEN
                      (SELECT listagg(hzl.address1 ||' - '|| hzl.address2 || ' - ' || hzl.city || '-' || hzl.state || ' / ' || hzl.postal_code,', ' ON OVERFLOW TRUNCATE)  
                       WITHIN GROUP (ORDER BY hzl.address1 asc)
                       FROM apps.hz_parties             hp
                        , apps.hz_party_sites         hps
                        , apps.hz_cust_accounts       hca
                        , apps.oe_order_lines_all     oola
                        , apps.hz_cust_acct_sites_all hcas
                        , apps.hz_cust_site_uses_all  hcsu
                        , apps.hz_locations           hzl
                    WHERE oola.line_id                   = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                      AND oola.end_customer_site_use_id  = hcsu.site_use_id
                      AND hcsu.cust_acct_site_id         = hcas.cust_acct_site_id
                      AND hcas.cust_account_id           = hca.cust_account_id
                      AND hcas.party_site_id             = hps.party_site_id
                      AND hca.party_id                   = hp.party_id
                      AND hps.party_id                   = hp.party_id
                      AND hps.location_id                = hzl.location_id)
                ELSE
                   CASE WHEN (mmt.source_code = '3PL_REMITTANCE_BRAZIL') THEN
                      (SELECT listagg(hzl.address1 ||' - '|| hzl.address2 || ' - ' || hzl.city || '-' || hzl.state || ' / ' || hzl.postal_code,', ' ON OVERFLOW TRUNCATE)  
                       WITHIN GROUP (ORDER BY hzl.address1 asc)
                         FROM apps.ra_customer_trx_all     rcta
                            , apps.hz_cust_acct_sites_all  hcas
                            , apps.hz_cust_site_uses_all   hcsu
                            , apps.hz_parties              hp
                            , apps.hz_party_sites          hps
                            , apps.hz_cust_accounts        hca
                            , apps.hz_locations            hzl
                        WHERE rcta.interface_header_attribute1 = mp.organization_code||'_'||mmt.transaction_reference
                          AND rcta.ship_to_site_use_id         = hcsu.site_use_id
                          AND hcsu.cust_acct_site_id           = hcas.cust_acct_site_id
                          AND hcas.cust_account_id             = hca.cust_account_id
                          AND hcas.party_site_id               = hps.party_site_id
                          AND hca.party_id                     = hp.party_id
                          AND hps.party_id                     = hp.party_id
                          AND hps.location_id                  = hzl.location_id
                          AND rcta.org_id                      = 4330)
                   ELSE
                      (SELECT listagg(hzl.address1 ||' - '|| hzl.address2 || ' - ' || hzl.city || '-' || hzl.state || ' / ' || hzl.postal_code,', ' ON OVERFLOW TRUNCATE)  
                       WITHIN GROUP (ORDER BY hzl.address1 asc)
                          FROM apps.hz_parties             hp
                             , apps.hz_party_sites         hps
                             , apps.hz_cust_accounts       hca
                             , apps.oe_order_lines_all     oola
                             , apps.hz_cust_acct_sites_all hcas
                             , apps.hz_cust_site_uses_all  hcsu
                             , apps.hz_locations           hzl
                         WHERE oola.line_id                = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                           AND oola.ship_to_org_id         = hcsu.site_use_id
                           AND hcsu.cust_acct_site_id      = hcas.cust_acct_site_id
                           AND hcas.cust_account_id        = hca.cust_account_id
                           AND hcas.party_site_id          = hps.party_site_id
                           AND hca.party_id                = hp.party_id
                           AND hps.party_id                = hp.party_id
                           AND hps.location_id             = hzl.location_id   )
                   END
                END customer_address
                -- 
                -- alterado para BIll_to por Sinval fim
                --
              , CASE WHEN (mmt.source_code = '3PL_REMITTANCE_BRAZIL') THEN
                    (SELECT distinct RTRIM(REGEXP_REPLACE((listagg(rcta.trx_number,', ' ON OVERFLOW TRUNCATE)  
                     WITHIN GROUP (ORDER BY rcta.trx_number asc) ), '([^,]*)(,\1)+($|,)', '\1\3'),',')
                       FROM apps.ra_customer_trx_all       rcta
                      WHERE rcta.interface_header_attribute1  = mp.organization_code||'_'||mmt.transaction_reference
                        AND rcta.org_id                       = 4330
                        AND trunc(rcta.trx_date)              BETWEEN (trunc(mmt.transaction_date)-3) AND (trunc(mmt.transaction_date)+3)
                        AND NVL(rcta.status_trx,'XX')         <> 'VD'
                        AND NVL(rcta.reason_code,'XX')        <> 'CANCELLATION')
                ELSE
                    (SELECT distinct RTRIM(REGEXP_REPLACE((listagg(rcta.trx_number,', ' ON OVERFLOW TRUNCATE)  
                     WITHIN GROUP (ORDER BY rcta.trx_number asc) ), '([^,]*)(,\1)+($|,)', '\1\3'),',')
                       FROM apps.ra_customer_trx_lines_all rctla
                          , apps.ra_customer_trx_all       rcta
                          , apps.oe_order_lines_all        oola
                          , apps.oe_order_headers_all      ooha
                      WHERE rcta.customer_trx_id              = rctla.customer_trx_id
                        AND oola.line_id                      = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                        AND oola.header_id                    = ooha.header_id
                        AND rctla.sales_order                 = to_char(ooha.order_number)
                        AND rctla.line_type                   = 'LINE'
                        AND rcta.batch_source_id              <> 6266 -- No RR invoices
                        AND DECODE(rctla.interface_line_context,'GEMS_PB_RR',rcta.interface_header_attribute11,'999')
                            = DECODE(rctla.interface_line_context,'GEMS_PB_RR',rcta.interface_header_attribute11,'999')
                        AND rcta.org_id                       = 4330
                        AND trunc(rcta.trx_date)              BETWEEN (trunc(mmt.transaction_date)-3) AND (trunc(mmt.transaction_date)+3)
                        AND NVL(rcta.status_trx,'XX')         <> 'VD'
                        AND NVL(rcta.reason_code,'XX')        <> 'CANCELLATION')   
                END   invoice_number_ar
              , ( SELECT listagg(mrav.reservation_quantity,', ' ON OVERFLOW TRUNCATE)  
                  WITHIN GROUP (ORDER BY mrav.reservation_quantity asc)
                    FROM apps.mtl_reservations_all_v  mrav 
                       , apps.oe_order_headers_all    ooha1
                   WHERE mrav.demand_source_header_id     = ooha1.header_id
                     AND mrav.demand_source_line_id       = NVL(mmt.trx_source_line_id, mmt.source_line_id) )  reservation_quantity
              , ( SELECT listagg(ooha1.order_number,', ' ON OVERFLOW TRUNCATE)  
                  WITHIN GROUP (ORDER BY ooha1.order_number asc) 
                    FROM apps.mtl_reservations_all_v  mrav 
                       , apps.oe_order_headers_all    ooha1
                   WHERE mrav.demand_source_header_id     = ooha1.header_id
                     AND mrav.demand_source_line_id       = NVL(mmt.trx_source_line_id, mmt.source_line_id) )  reservation_order_number
              , (SELECT distinct hp.party_name
                 --WITHIN GROUP (ORDER BY hp.party_name asc)
                   FROM apps.hz_parties              hp
                      , apps.hz_cust_accounts        hca
                      , apps.oe_order_lines_all      oola1
                      , apps.oe_order_headers_all    ooha1
                      , apps.mtl_reservations_all_v  mrav 
                  WHERE mrav.demand_source_header_id   = ooha1.header_id
                    AND mrav.demand_source_line_id     = oola1.line_id
                    AND oola1.line_id                  = NVL(mmt.trx_source_line_id, mmt.source_line_id)
                    AND oola1.ship_to_org_id           = hca.cust_account_id
                    AND hca.party_id                   = hp.party_id )         reservation_customer_name 
              , gcc1.concatenated_segments   material_account
              , gcc2.concatenated_segments   outside_processing_account
              , gcc3.concatenated_segments   material_overhead_account
              , gcc4.concatenated_segments   overhead_account
              , gcc5.concatenated_segments   resource_account
              , sysdate                                           report_date_and_time 
              , to_char(msn.last_transaction_id)                  transaction_id
              , fu.user_name ||' / '|| fu.description             user_name
              , DECODE( lot_control_code, 1 ,'Sem controle de Lote' , 2,'Com controle de Lote')   lot_control
              , DECODE( serial_number_control_code, 1, 'Sem controle de Serial'
                                                  , 2, 'Pre-definido'
                                                  , 5, 'No Recebimento'
                                                  , 6, 'Baixa na Ordem de Venda' )  serial_control
              , CASE
                 WHEN    nvl(mmt.lpn_id, mmt.content_lpn_id) IS NULL AND moq.subinventory_code <> 'WHGU42GNAT'
                   THEN
                    (SELECT listagg(lpn.license_plate_number,', ' ON OVERFLOW TRUNCATE)WITHIN GROUP (ORDER BY lpn.license_plate_number asc)
                             FROM apps.MTL_MATERIAL_TRANSACTIONS   mtt,
                                  apps.wms_license_plate_numbers   lpn,
                                  apps.oe_order_lines_all          ool
                            WHERE 1 = 1
                              AND mtt.TRX_SOURCE_LINE_ID = CASE
                                                              WHEN LINE_CATEGORY_CODE = 'ORDER'
                                                                THEN ool.line_id
                                                              WHEN LINE_CATEGORY_CODE = 'RETURN'  
                                                                THEN   
                                                                to_number(NVL(SUBSTR(ool.ORIG_SYS_LINE_REF,
                                                                                     0,
                                                                                     INSTR(ool.ORIG_SYS_LINE_REF, '.') - 1),
                                                                              -1)) -- RMA FE OE Line Id
                                                                ELSE -1
                                                                  END
                              AND mtt.TRANSACTION_TYPE_ID = 52 --sales order pick FE ORDER
                              AND mtt.transaction_quantity < 0
                              AND mtt.inventory_item_id = ool.inventory_item_id
                              AND nvl(mtt.lpn_id, mtt.content_lpn_id) = nvl(lpn.lpn_id, -1)
                              AND ool.line_id = CASE
                                                  WHEN mtt.transaction_type_name = 'RMA Receipt'
                                                    THEN mmt.TRX_SOURCE_LINE_ID
                                                  WHEN mtt.transaction_type_name = 'GPO Nationalization Receipt'
                                                     THEN 
                                                      to_number(NVL(SUBSTR(RTRIM(LTRIM(translate(mmt.TRANSACTION_REFERENCE,translate(mmt.TRANSACTION_REFERENCE||'a','1234567890.',' '),' '))),
                                                         0,
                                                         INSTR(RTRIM(LTRIM(translate(mmt.TRANSACTION_REFERENCE,translate(mmt.TRANSACTION_REFERENCE||'a','1234567890.',' '),' '))), '.') - 1),
                                                  -1))
                                                  ELSE -1
                                                    END)
                              WHEN moq.subinventory_code = 'WHGU42GNAT'
                  THEN (SELECT listagg(wlp.license_plate_number,', ' ON OVERFLOW TRUNCATE)  
                            WITHIN GROUP (ORDER BY wlp.license_plate_number asc)
                        FROM   gems_ont.ge_gpo_nationalization_line gnl, 
                               gems_ont.ge_gpo_nationalization_line gn2,
                               apps.wms_license_plate_numbers       wlp,
                               apps.po_line_locations_all           pll,
                               apps.po_lines_all                    pol,
                               apps.po_headers_all                  poh,
                               apps.rcv_shipment_headers            rsh,
                               apps.rcv_transactions                rt
                        Where  wlp.lpn_id(+) = gn2.lpn_id
                        AND gnl.nationalization_so_line_id = gn2.nationalization_so_line_id
                        AND pll.line_location_id = gnl.DOCUMENT_ID
                        AND pll.po_header_id = poh.po_header_id
                        AND pll.po_line_id = pol.po_line_id
                        AND gn2.record_type = 'IMPORT'
                        AND gnl.record_type = 'NATIONALIZATION'
                        AND rt.transaction_id                = mmt.rcv_transaction_id
                        AND rt.po_line_location_id           = pll.line_location_id
                        AND rt.shipment_header_id            = rsh.shipment_header_id)
                ELSE (SELECT lpn.LICENSE_PLATE_NUMBER
                           FROM   apps.wms_license_plate_numbers   lpn
                           WHERE  nvl(mmt.lpn_id, mmt.content_lpn_id) = nvl(lpn.lpn_id, -1))
                        END LPN_Value                                    
              , 'q18' query
--, mmt.transaction_type_id
--, mmt.trx_source_line_id
--, mmt.source_line_id
           FROM apps.mtl_serial_numbers              msn  
              , apps.mtl_parameters                  mp
              , apps.mtl_system_items_b              msi
              , apps.mtl_item_locations_kfv          milk
              , apps.gl_code_combinations            gcc
              , apps.gl_code_combinations_kfv        gcc1
              , apps.gl_code_combinations_kfv        gcc2
              , apps.gl_code_combinations_kfv        gcc3
              , apps.gl_code_combinations_kfv        gcc4
              , apps.gl_code_combinations_kfv        gcc5
              , AMARCHIVE.MTL_MATERIAL_TRANSACTIONS  mmt 
              , apps.mtl_transaction_types           mtt
              , apps.mtl_txn_source_types            mtst
              , apps.mtl_secondary_inventories_fk_v  msifv
              , apps.fnd_flex_values_vl              ffvv
              , apps.fnd_flex_value_sets             ffvs
              , apps.fnd_user                        fu
              , ( SELECT organization_id
                       , inventory_item_id
                       , subinventory_code
                       , locator_id
                       , lot_number
                       --, update_transaction_id
                       --, transaction_uom_code
                       , SUM (primary_transaction_quantity)  onhand_qty
                    FROM apps.mtl_onhand_quantities_detail
                   WHERE organization_id IN ( SELECT ood.ORGANIZATION_id FROM apps.org_organization_definitions ood WHERE ood.SET_OF_BOOKS_ID = 230 )
                GROUP BY organization_id
                       , inventory_item_id
                       , subinventory_code
                       , locator_id
                     --  , revision
                       , lot_number
                       --, update_transaction_id
                       --, transaction_uom_code
                       ) moq
                , APPS.MTL_PAC_ACTUAL_COST_DETAILS          MPACD
          WHERE 1                                = 1
          AND decode(mmt.periodic_primary_quantity,null,mmt.transfer_transaction_id,MMT.TRANSACTION_ID) = MPACD.TRANSACTION_ID  
            AND mp.organization_id               = msi.organization_id
            AND msifv.organization_id            = msi.organization_id
--            AND msi.segment1 = '60510302'
            AND msifv.secondary_inventory_name   = moq.subinventory_code
            AND msifv.material_account           = gcc1.code_combination_id
            AND msifv.outside_processing_account = gcc2.code_combination_id
            AND msifv.material_overhead_account  = gcc3.code_combination_id
            AND msifv.overhead_account           = gcc4.code_combination_id
            AND msifv.resource_account           = gcc5.code_combination_id
            AND msi.cost_of_sales_account        = gcc.code_combination_id
            AND ffvs.flex_value_set_name         = 'GE_GL_AFF_ES_PRODUCT_LINE'
            AND ffvs.flex_value_set_id           = ffvv.flex_value_set_id
            AND ffvv.flex_value_meaning          = gcc.segment8
            AND 'TYPE 1'                        IN ('TYPE 1')
            AND msi.organization_id             IN ( SELECT ood.organization_id FROM apps.org_organization_definitions ood WHERE ood.SET_OF_BOOKS_ID = 230 )
            AND moq.inventory_item_id            = msn.inventory_item_id         (+) --mmt.inventory_item_id (+)   
            AND moq.organization_id              = msn.current_organization_id   (+) --mmt.organization_id   (+)   
            AND moq.subinventory_code            = msn.current_subinventory_code (+) --mmt.subinventory_code (+)   
            AND moq.locator_id                   = msn.current_locator_id        (+) --mmt.locator_id        (+)   
            AND msn.current_status           (+) = 3                 
            AND moq.lot_number                   = msn.lot_number (+)
            AND moq.inventory_item_id            = msi.inventory_item_id
            AND moq.locator_id                   = milk.inventory_location_id
            AND moq.organization_id              = mp.organization_id
            AND msn.last_transaction_id          = mmt.transaction_id  (+)
--    AND MMT.TRANSACTION_ID = 2562828197
            AND mtt.transaction_type_id          = mmt.transaction_type_id 
            AND mtst.transaction_source_type_id  = mmt.transaction_source_type_id
            AND fu.user_id                       = mmt.created_by
    AND MMT.TRANSACTION_ID NOT IN(SELECT MMT2.TRANSACTION_ID 
                                  FROM APPS.MTL_MATERIAL_TRANSACTIONS MMT2
                                  WHERE MMT2.TRANSACTION_ID = MMT.TRANSACTION_ID)
    AND msn.serial_number IS NULL ------------ NOVA QUERY PARA TRAZER ITENS NA CONDI?O SERIAL NUMBER NULO - Sinval 17/02/22
    AND moq.locator_id                  IS NOT NULL
    AND msi.serial_number_control_code  = '5' 
    AND msi.lot_control_code            = '2'  --Com controle de Lote                      
) q1
--where --q1.transaction_date between trunc(to_date ('01/MAR/2021','DD/MON/YYYY')) 
 --                                       and trunc(to_date ('31/MAR/2021','DD/MON/YYYY')) +.99999 
--  q1.transaction_id in ( 7686866920, 7688671014, 7688671018, 7698488828, 7709198531, 7710661171, 7713382757, 7713382724, 7713382750 )
-- IN (  '8002717', 'H4000SR', 'H45041DL', 'H48062AC', 'H40402LY')
WHERE 1=1 --q1.subinventory_code =  'WHG0880LG'
AND  Q1.ORGANIZATION_CODE   = 'SBZ'
AND  Q1.PART_NUMBER       = '0211-1454-100'
AND  Q1.SUBINVENTORY_CODE = 'ALTS2276'
--AND  q1.source_code = 'RCV'
--AND  q1.transaction_id  = 8803951315 --IN (8837022454,8837649422,8843464970,8837651238,8837649870)
--AND  Q1.transaction_date between SYSDATE-30   and SYSDATE+1
ORDER BY q1.transaction_date ASC
;     

